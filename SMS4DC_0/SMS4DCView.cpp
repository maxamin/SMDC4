// SMS4DCView.cpp : implementation of the CSMS4DCView class
//

#include "stdafx.h"
#include "SMS4DC.h"
#include "SMS4DCDoc.h"
#include "SMS4DCView.h"

#include "MainFrm.h"
#include "UTM.h"
#include "VectorDLG.h"
#include "CoordinatesDLG.h"
//#include "DataBaseDLG.h"
#include "DataBaseLDLG.h"
//#include "NormalizeDLG.h"
#include "GridStepDLG.h"
#include "CircleRadiusDLG.h"
#include "P370DLG.h"
#include "P1546DLG.h"
#include "LoSDLG.h"
#include "SymbolDLG.h"
#include "OverlayDLG.h"
//#include "FileDlg.h"
#include "PowerCalculatorDLG.h"
#include "KFactor.h"
#include "HATADLG.h"
#include "P452DLG.h"
#include "HorizonDistanceDLG.h"
#include "InterModDLG.h"
#include "P530DLG.h"
#include "CountrySelectionDLG.h"
#include "AddFreqDLG.h"
#include "Int_ParametersDLG.h"
#include "ProfileDoc.h"
#include "ProfileView.h"
#include "Pro_Free_AreaDoc.h"
#include "Pro_P370_AreaDoc.h"
#include "Pro_P1546_AreaDoc.h"
#include "Pro_LoS_AreaDoc.h"
#include "EffectiveHeigthDoc.h"
#include "Pro_Free_NetFDoc.h"
#include "Pro_Free_NetBDoc.h"
#include "Pro_P370_NetFDoc.h"
#include "Pro_P370_NetBDoc.h"
#include "Pro_P1546_NetFDoc.h"
#include "Pro_P1546_NetBDoc.h"
#include "AntennaFormDoc.h"
#include "Pro_Free_LineDoc.h"
#include "ProfilePolygonDoc.h"
#include "Pro_Free_PolygonDoc.h"
#include "Pro_P370_LineDoc.h"
#include "Pro_P1546_LineDoc.h"
#include "Pro_LoS_LineDoc.h"
#include "Allocations_DrawDoc.h"
#include "Pro_P370_PolygonDoc.h"
#include "Pro_P1546_PolygonDoc.h"
#include "Pro_LoS_PolygonDoc.h"
#include "Ant3DDoc.h"
#include "Contour_DEMDoc.h"
#include "AddStationRecSet.h"
#include "AddStationDLG.h"
#include "Pro_P370_LinkDoc.h"
#include "Pro_P1546_LinkDoc.h"
#include "MainMapDoc.h"
#include "Pro_HATA_AreaDoc.h"
#include "Pro_HATA_NetFDoc.h"
#include "Pro_HATA_NetBDoc.h"
#include "Pro_P452_LinkDoc.h"
#include "Pro_P526_LinkDoc.h"
#include "Pro_Smooth_LinkDoc.h"
#include "Pro_P530_LinkDoc.h"
#include "GE84_Functions.h"
#include "GE84BC2BCDLG.h"
#include "P370_Functions.h"
#include "P1546_Functions.h"
#include "GE84_EUDLG.h"
#include "GE84_F_D_rngeDLG.h"
#include "SmoothDLG.h"
#include "GE84_EUIDLG.h"
#include "ST61_Functions.h"
#include "FolderDLG.h"
#include "Code2NameCTY.h"
#include "Fassign1DLG.h"
#include "Fassign2DLG.h"
#include "Int_BC2BC_FreeDoc.h"
#include "Int_BT2BT_FreeDoc.h"
#include "GE89_Functions.h"
#include "GE89_EUDLG.h"
#include "GE89_rangeDLG.h"
#include "GE89_FXDLG.h"
#include "P452_Functions.h"
#include "Int_FX2FXDLG.h"
#include "Int_FX2FXparDLG.h"
#include "Int_FX2FXIDLG.h"
#include "GE89_FXM2BTDLG.h"
#include "BorderMLDLG.h"
#include "BorderRadiusDLG.h"
#include "BorderRep1DLG.h"
#include "NFDmobile_Functions.h"
#include "FXM_F_D_rngDLG.h"
#include "Int_FX2FXvparDLG.h"
#include "TxRxFiltersSet.h"
#include "AP7ESDLG.h"
#include "AP7_ESantPattern.h"
#include "IntES2ESparDLG.h"
#include "Int_ES2ESoutDLG.h"
#include "AddESStationDLG.h"

#include "P154606_Functions.h"
#include "GE06repDLG1.h"
#include "GE06cvaDLG.h"
#include "GE06srvDLG.h"
#include "GE06intDLG1.h"

#include "FileDLG_ChangedType.h"
#include "HorizonElevationDLG.h"
#include "HorizonElevationDataDLG.h"

#include <io.h>

#include "Pro_P1812_AreaDoc.h"
#include "Pro_P1812_NetFDoc.h"
#include "Pro_P1812_NetBDoc.h"


extern "C" {
#include "C:\\Br_soft\\IDWM\\include\\idwm32.h"
}

#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif
/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView

IMPLEMENT_DYNCREATE(CSMS4DCView, CScrollView)

BEGIN_MESSAGE_MAP(CSMS4DCView, CScrollView)
	//{{AFX_MSG_MAP(CSMS4DCView)
	ON_COMMAND(ID_Topo_0, OnTopo_0)
	ON_COMMAND(ID_Jet, OnJet)
	ON_COMMAND(ID_Gray, OnGray)
	ON_COMMAND(ID_Pink, OnPink)
	ON_COMMAND(ID_Copper, OnCopper)
	ON_COMMAND(ID_WEST, OnWest)
	ON_COMMAND(ID_NORTH, OnNorth)
	ON_COMMAND(ID_SOUTH, OnSouth)
	ON_COMMAND(ID_EAST, OnEast)
	ON_UPDATE_COMMAND_UI(ID_Topo_0, OnUpdateTopo_0)
	ON_UPDATE_COMMAND_UI(ID_Jet, OnUpdateJet)
	ON_UPDATE_COMMAND_UI(ID_Gray, OnUpdateGray)
	ON_UPDATE_COMMAND_UI(ID_Pink, OnUpdatePink)
	ON_UPDATE_COMMAND_UI(ID_Copper, OnUpdateCopper)
	ON_WM_MOUSEMOVE()
	ON_WM_HSCROLL()
	ON_WM_VSCROLL()
	ON_COMMAND(ID_GlobeDEM, OnGlobeDEM)
	ON_UPDATE_COMMAND_UI(ID_GlobeDEM, OnUpdateGlobeDEM)
	ON_COMMAND(ID_Topo_1, OnTopo1)
	ON_UPDATE_COMMAND_UI(ID_Topo_1, OnUpdateTopo1)
	ON_COMMAND(ID_Globe, OnGlobe)
	ON_UPDATE_COMMAND_UI(ID_Globe, OnUpdateGlobe)
	ON_WM_LBUTTONDOWN()
	ON_WM_LBUTTONUP()
	ON_COMMAND(ID_Draw_Line, OnDrawLine)
	ON_UPDATE_COMMAND_UI(ID_Draw_Line, OnUpdateDrawLine)
	ON_COMMAND(ID_Draw_Box, OnDrawBox)
	ON_UPDATE_COMMAND_UI(ID_Draw_Box, OnUpdateDrawBox)
	ON_COMMAND(ID_Draw_Profile, OnDrawProfile)
	ON_COMMAND(ID_CALCULATION_Distance_Line, OnCALCULATIONDistanceLine)
	ON_COMMAND(ID_CALCULATION_Azimuth, OnCALCULATIONAzimuth)
	ON_COMMAND(ID_CALCULATION_Elevation, OnCALCULATIONElevation)
	ON_COMMAND(ID_Refresh, OnRefresh)
	ON_UPDATE_COMMAND_UI(ID_Draw_Profile, OnUpdateDrawProfile)
	ON_COMMAND(ID_ProFreeLine, OnProFreeLine)
	ON_COMMAND(ID_DrawVector, OnDrawVector)
	ON_COMMAND(ID_ProFreeArea, OnProFreeArea)
	ON_UPDATE_COMMAND_UI(ID_ProFreeLine, OnUpdateProFreeLine)
	ON_COMMAND(ID_Draw_Polygon, OnDrawPolygon)
	ON_UPDATE_COMMAND_UI(ID_Draw_Polygon, OnUpdateDrawPolygon)
	ON_COMMAND(ID_Arrow, OnArrow)
	ON_WM_LBUTTONDBLCLK()
	ON_COMMAND(ID_PROFILE_POLYGON, OnProfilePolygon)
	ON_UPDATE_COMMAND_UI(ID_PROFILE_POLYGON, OnUpdateProfilePolygon)
	ON_COMMAND(ID_CALCULATION_EFFECTIVEHEIGTH, OnCalculationEffectiveheigth)
	ON_COMMAND(ID_PROPAGATIONMODELS_FREESPACE_POLYGON, OnPropagationmodelsFreespacePolygon)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_FREESPACE_POLYGON, OnUpdatePropagationmodelsFreespacePolygon)
	ON_COMMAND(ID_TOOLS_NORMALIZE, OnToolsNormalize)
	ON_COMMAND(ID_TOOLS_GRID, OnToolsGrid)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_GRID, OnUpdateToolsGrid)
	ON_COMMAND(ID_TOOLS_GRIDSTEP, OnToolsGridstep)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_GRIDSTEP, OnUpdateToolsGridstep)
	ON_COMMAND(ID_DATABASE_DISPLAYSELECTEDSTATIONS, OnDatabaseDisplayselectedstations)
	ON_COMMAND(ID_DATABASE_STATIONSINDESKTOP, OnDatabaseStationsindesktop)
	ON_COMMAND(ID_DATABASE_REMOVESTATIONSFROMDISPLAY, OnDatabaseRemovestationsfromdisplay)
	ON_COMMAND(ID_VECTORS_CIRCLE, OnVectorsCircle)
	ON_UPDATE_COMMAND_UI(ID_ProFreeArea, OnUpdateProFreeArea)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_AREA, OnPropagationmodelsP370Area)
	ON_COMMAND(ID_DATABASE_SEARCHSTATION, OnDatabaseSearchstation)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P370_AREA, OnUpdatePropagationmodelsP370Area)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_AREA, OnPropagationmodelsP1546Area)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P1546_AREA, OnUpdatePropagationmodelsP1546Area)
	ON_COMMAND(ID_overlay, OnOverlay)
	ON_COMMAND(ID_SHOW_LEGEND, OnShowLegend)
	ON_UPDATE_COMMAND_UI(ID_SHOW_LEGEND, OnUpdateShowLegend)
	ON_COMMAND(ID_TOOLS_SYMBOLATTRIBUTE, OnToolsSymbolattribute)
	ON_COMMAND(ID_TOOLS_LIGHTEN, OnToolsLighten)
	ON_COMMAND(ID_TOOLS_DARKEN, OnToolsDarken)
	ON_COMMAND(ID_PROPAGATIONMODELS_LINEOFSIGHT_AREA, OnPropagationmodelsLineofsightArea)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_LINEOFSIGHT_AREA, OnUpdatePropagationmodelsLineofsightArea)
	ON_UPDATE_COMMAND_UI(ID_overlay, OnUpdateoverlay)
	ON_COMMAND(ID_PROPAGATIONMODELS_FREESPACE_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnFreespaceNetworkprocessorMaximumfieldstrength)
	ON_COMMAND(ID_PROPAGATIONMODELS_FREESPACE_NETWORKPROCESSOR_BESTSERVER, OnFreespaceNetworkprocessorBestserver)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnP370NetworkprocessorMaximumfieldstrength)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_NETWORKPROCESSOR_BESTSERVER, OnP370NetworkprocessorBestserver)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_FREESPACE_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnUpdateFreespaceNetworkprocessorMaximumfieldstrength)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_FREESPACE_NETWORKPROCESSOR_BESTSERVER, OnUpdateFreespaceNetworkprocessorBestserver)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P370_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnUpdateP370NetworkprocessorMaximumfieldstrength)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P370_NETWORKPROCESSOR_BESTSERVER, OnUpdateP370NetworkprocessorBestserver)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnP1546NetworkprocessorMaximumfieldstrength)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P1546_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnUpdateP1546NetworkprocessorMaximumfieldstrength)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_NETWORKPROCESSOR_BESTSERVER, OnP1546NetworkprocessorBestserver)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P1546_NETWORKPROCESSOR_BESTSERVER, OnUpdateP1546NetworkprocessorBestserver)
	ON_COMMAND(ID_CALCULATION_POWERCALCULATOR, OnCalculationPowercalculator)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_LINE, OnPropagationmodelsP370Line)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P370_LINE, OnUpdatePropagationmodelsP370Line)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_LINE, OnPropagationmodelsP1546Line)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P1546_LINE, OnUpdatePropagationmodelsP1546Line)
	ON_COMMAND(ID_PROPAGATIONMODELS_LINEOFSIGHT_LINE, OnPropagationmodelsLineofsightLine)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_LINEOFSIGHT_LINE, OnUpdatePropagationmodelsLineofsightLine)
	ON_COMMAND(ID_LineDataBase, OnLineDataBase)
	ON_COMMAND(ID_AreaDataBase, OnAreaDataBase)
	ON_COMMAND(ID_CALCULATION_Distance_Polygon, OnCALCULATIONDistancePolygon)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_Distance_Polygon, OnUpdateCALCULATIONDistancePolygon)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_Distance_Line, OnUpdateCALCULATIONDistanceLine)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_Azimuth, OnUpdateCALCULATIONAzimuth)
	ON_COMMAND(ID_FREQUENCYALLOCATIONS_DRAWCHART, OnFrequencyallocationsDrawchart)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_POLYGON, OnPropagationmodelsP370Polygon)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P370_POLYGON, OnUpdatePropagationmodelsP370Polygon)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_POLYGON, OnPropagationmodelsP1546Polygon)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P1546_POLYGON, OnUpdatePropagationmodelsP1546Polygon)
	ON_COMMAND(ID_PROPAGATIONMODELS_LINEOFSIGHT_POLYGON, OnPropagationmodelsLineofsightPolygon)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_LINEOFSIGHT_POLYGON, OnUpdatePropagationmodelsLineofsightPolygon)
	ON_COMMAND(ID_TOOLS_AREA3DVIEW, OnToolsArea3dview)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_AREA3DVIEW, OnUpdateToolsArea3dview)
	ON_COMMAND(ID_TOOLS_ANTENNAEDITOR, OnToolsAntennaeditor)
	ON_COMMAND(ID_CALCULATION_AREAKM2, OnCalculationAreakm2)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_AREAKM2, OnUpdateCalculationAreakm2)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_Elevation, OnUpdateCALCULATIONElevation)
	ON_COMMAND(ID_TOOLS_2DVIEWCONTOUR, OnTools2dviewcontour)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_2DVIEWCONTOUR, OnUpdateTools2dviewcontour)
	ON_COMMAND(ID_AddStation, OnAddStation)
	ON_UPDATE_COMMAND_UI(ID_AddStation, OnUpdateAddStation)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_SEARCHSTATION, OnUpdateDatabaseSearchstation)
	ON_COMMAND(ID_PROFILE_FRESNELZONE, OnProfileFresnelzone)
	ON_UPDATE_COMMAND_UI(ID_PROFILE_FRESNELZONE, OnUpdateProfileFresnelzone)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_LINK, OnPropagationmodelsP370Link)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_LINK, OnPropagationmodelsP1546Link)
	ON_COMMAND(ID_PROPAGATIONMODELS_HATA_AREA, OnPropagationmodelsHataArea)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_HATA_AREA, OnUpdatePropagationmodelsHataArea)
	ON_COMMAND(ID_PROPAGATIONMODELS_OKUMURAHATA_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnOkumurahataNetworkprocessorMaximumfieldstrength)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_OKUMURAHATA_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnUpdateOkumurahataNetworkprocessorMaximumfieldstrength)
	ON_COMMAND(ID_PROPAGATIONMODELS_OKUMURAHATA_NETWORKPROCESSOR_BESTSERVER, OnOkumurahataNetworkprocessorBestserver)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_OKUMURAHATA_NETWORKPROCESSOR_BESTSERVER, OnUpdateOkumurahataNetworkprocessorBestserver)
	ON_COMMAND(ID_PROPAGATIONMODELS_P452_LINK, OnPropagationmodelsP452Link)
	ON_COMMAND(ID_PROPAGATIONMODELS_P526_LINK, OnPropagationmodelsP526Link)
	ON_COMMAND(ID_CALCULATION_HORIZONDISTANCE, OnCalculationHorizondistance)
	ON_COMMAND(ID_CALCULATION_INTERMODULATION, OnCalculationIntermodulation)
	ON_COMMAND(ID_COORDINATION_GE84BC2BC, OnCoordinationGe84bc2bc)
	ON_COMMAND(ID_COORDINATION_GE84BC2BT, OnCoordinationGe84bc2bt)
	ON_COMMAND(ID_COORDINATION_GE84BC2FX, OnCoordinationGe84bc2fx)
	ON_COMMAND(ID_COORDINATION_GE84BC2LM, OnCoordinationGe84bc2lm)
	ON_COMMAND(ID_COORDINATION_GE84EU, OnCoordinationGe84eu)
	ON_COMMAND(ID_PROPAGATIONMODELS_SMOOTHEARTH_LINK, OnPropagationmodelsSmoothearthLink)
	ON_COMMAND(ID_COORDINATION_GE84EUI, OnCoordinationGe84eui)
	ON_COMMAND(ID_PROPAGATIONMODELS_P370_CONTOUR, OnPropagationmodelsP370Contour)
	ON_COMMAND(ID_VECTORS_REMOVEVECTORSFROMDISPLAY, OnVectorsRemovefromdisplay)
	ON_COMMAND(ID_COORDINATION_ST61BC2BC, OnCoordinationSt61bc2bc)
	ON_COMMAND(ID_PROPAGATIONMODELS_P1546_CONTOUR, OnPropagationmodelsP1546Contour)
	ON_COMMAND(ID_PROPAGATIONMODELS_P530_LINK, OnPropagationmodelsP530Link)
	ON_WM_RBUTTONDOWN()
	ON_WM_RBUTTONUP()
	ON_COMMAND(ID_MoveStationFlag, OnMoveStationFlag)
	ON_UPDATE_COMMAND_UI(ID_MoveStationFlag, OnUpdateMoveStationFlag)
	ON_COMMAND(ID_FREQUENCYALLOCATIONS_FREQUENCYPLAN, OnFrequencyallocationsFrequencyplan)
	ON_COMMAND(ID_DATABASE_AUDITTRAIL, OnDatabaseAudittrail)
	ON_COMMAND(ID_FREQUENCYALLOCATIONS_FPLAN, OnFrequencyallocationsFplan)
	ON_COMMAND(ID_DATABASE_BACKUP, OnDatabaseBackup)
	ON_COMMAND(ID_CALCULATION_UNDERTEST_IFIC, OnCalculationUndertestIfic)
	ON_COMMAND(ID_DATABASE_SEARCHFREQUENCY, OnDatabaseSearchfrequency)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_SEARCHFREQUENCY, OnUpdateDatabaseSearchfrequency)
	ON_COMMAND(ID_DATABASE_LIST, OnDatabaseList)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_LIST, OnUpdateDatabaseList)
	ON_COMMAND(ID_PROPAGATIONMODELS_P618, OnPropagationmodelsP618)
	ON_COMMAND(ID_FREQUENCYALLOCATIONS_FREQUENCYASSIGNMENT, OnFrequencyallocationsFrequencyassignment)
	ON_COMMAND(ID_VECTORS_COUNTRYBORDER, OnVectorsCountryborder)
	ON_COMMAND(ID_HELP_MANUAL, OnHelpManual)
	ON_COMMAND(ID_INTERFERENCE_BC2BC, OnInterferenceBc2bc)
	ON_COMMAND(ID_INTERFERENCE_BT2BT, OnInterferenceBt2bt)
	ON_COMMAND(ID_COORDINATION_GE89_BT2BT, OnCoordinationGe89Bt2bt)
	ON_COMMAND(ID_COORDINATION_GE89_EU, OnCoordinationGe89Eu)
	ON_COMMAND(ID_COORDINATION_GE89_EUI, OnCoordinationGe89Eui)
	ON_COMMAND(ID_COORDINATION_GE89_FX, OnCoordinationGe89Fx)
	ON_COMMAND(ID_COORDINATION_GE89_LM, OnCoordinationGe89Lm)
	ON_COMMAND(ID_DATABASE_LINKS, OnDatabaseLinks)
	ON_COMMAND(ID_INTERFERENCE_FX2FX, OnInterferenceFx2fx)
	ON_COMMAND(ID_INTERFERENCE_FX2FXI, OnInterferenceFx2fxi)
	ON_COMMAND(ID_COORDINATION_GE89_FXLM2BT, OnCoordinationGe89Fxlm2bt)
	ON_COMMAND(ID_INTERFERENCE_BT2FX, OnInterferenceBt2fx)
	ON_COMMAND(ID_INTERFERENCE_FXLM2BT, OnInterferenceFxlm2bt)
	ON_COMMAND(ID_INTERFERENCE_BT2LM, OnInterferenceBt2lm)
	ON_COMMAND(ID_COORDINATION_BORDER, OnCoordinationBorder)
	ON_COMMAND(ID_DATABASE_LICENSING, OnDatabaseLicensing)
	ON_COMMAND(ID_INTERFERENCE_FXM_TO, OnInterferenceFxmTo)
	ON_COMMAND(ID_INTERFERENCE_FXM_TO2, OnInterferenceFxmTo2)
	ON_COMMAND(ID_INTERFERENCE_FXM_FROM, OnInterferenceFxmFrom)
	ON_COMMAND(ID_INTERFERENCE_FXM_FROM2, OnInterferenceFxmFrom2)
	ON_COMMAND(ID_INTERFERENCE_FX2FXV_TO, OnInterferenceFx2fxvTo)
	ON_COMMAND(ID_INTERFERENCE_FX2FXV_FROM, OnInterferenceFx2fxvFrom)
	ON_COMMAND(ID_DATABASE_USERS, OnDatabaseUsers)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_USERS, OnUpdateDatabaseUsers)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_AUDITTRAIL, OnUpdateDatabaseAudittrail)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_BACKUP, OnUpdateDatabaseBackup)
	ON_UPDATE_COMMAND_UI(ID_CALCULATION_UNDERTEST_IFIC, OnUpdateCalculationUndertestIfic)
	ON_UPDATE_COMMAND_UI(ID_FREQUENCYALLOCATIONS_FREQUENCYPLAN, OnUpdateFrequencyallocationsFrequencyplan)
	ON_UPDATE_COMMAND_UI(ID_FREQUENCYALLOCATIONS_FREQUENCYASSIGNMENT, OnUpdateFrequencyallocationsFrequencyassignment)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_ANTENNAEDITOR, OnUpdateToolsAntennaeditor)
	ON_COMMAND(ID_TOOLS_MAPLAYERS_USERMAP1, OnToolsMaplayersUsermap1)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_MAPLAYERS_USERMAP1, OnUpdateToolsMaplayersUsermap1)
	ON_COMMAND(ID_TOOLS_MAPLAYERS_USERMAP2, OnToolsMaplayersUsermap2)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_MAPLAYERS_USERMAP2, OnUpdateToolsMaplayersUsermap2)
	ON_COMMAND(ID_COORDINATION_AGREEMENTS, OnCoordinationAgreements)
	ON_COMMAND(ID_INTERFERENCE_ES_TO, OnInterferenceEsTo)
	ON_COMMAND(ID_INTERFERENCE_ES_FROM, OnInterferenceEsFrom)
	ON_COMMAND(ID_INTERFERENCE_ES2FX, OnInterferenceEs2fx)
	ON_COMMAND(ID_INTERFERENCE_FX2ES, OnInterferenceFx2es)
	ON_WM_MOUSEWHEEL()
	ON_COMMAND(ID_DATABASE_DISPLAYEARTHSTATION, OnDatabaseDisplayearthstation)
	ON_COMMAND(ID_AddESStation, OnAddESStation)
	ON_UPDATE_COMMAND_UI(ID_AddESStation, OnUpdateAddESStation)
	ON_COMMAND(ID_MoveESStationFlag, OnMoveESStationFlag)
	ON_UPDATE_COMMAND_UI(ID_MoveESStationFlag, OnUpdateMoveESStationFlag)
	ON_COMMAND(ID_DATABASE_ESDESKTOP, OnDatabaseEsdesktop)
	ON_COMMAND(ID_DATABASE_REMOVEES, OnDatabaseRemovees)
	ON_COMMAND(ID_DATABASE_IMPORTSRS, OnDatabaseImportsrs)
	ON_COMMAND(ID_DATABASE_SEARCHESFRQ, OnDatabaseSearchesfrq)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_SEARCHESFRQ, OnUpdateDatabaseSearchesfrq)
	ON_COMMAND(ID_DATABASE_LISTES, OnDatabaseListes)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_LISTES, OnUpdateDatabaseListes)
	ON_COMMAND(ID_DATABASE_SEARCHESLOC, OnDatabaseSearchesloc)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_SEARCHESLOC, OnUpdateDatabaseSearchesloc)
	ON_WM_SIZE()
	ON_COMMAND(ID_COORDINATION_GE06_BCBT2BCBT, OnCoordinationGe06Bcbt2bcbt)
	ON_COMMAND(ID_COORDINATION_GE06_BCBT2FXLM, OnCoordinationGe06Bcbt2fxlm)
	ON_COMMAND(ID_DATABASE_GEOTYPE, OnDatabaseGeotype)
	ON_COMMAND(ID_DATABASE_SHOWALLOT, OnDatabaseShowallot)
	ON_COMMAND(ID_DATABASE_DEFINEALLOT, OnDatabaseDefineallot)
	ON_UPDATE_COMMAND_UI(ID_DATABASE_DEFINEALLOT, OnUpdateDatabaseDefineallot)
	ON_COMMAND(ID_COORDINATION_GE06_FXLM2BCBT_TXFXLM, OnCoordinationGe06Fxlm2bcbtTxfxlm)
	ON_COMMAND(ID_COORDINATION_GE06_FXLM2BCBT_RXFXLM, OnCoordinationGe06Fxlm2bcbtRxfxlm)
	ON_COMMAND(ID_DATABASE_SHOWSRV, OnDatabaseShowsrv)
	ON_COMMAND(ID_COORDINATION_GE06_COVERAGEAREA, OnCoordinationGe06Coveragearea)
	ON_COMMAND(ID_COORDINATION_GE06_SERVICEAREA, OnCoordinationGe06Servicearea)
	ON_COMMAND(ID_DATABASE_DISPLAYGE06LINKED, OnDatabaseDisplayge06linked)
	ON_COMMAND(ID_DATABASE_CONVERTED, OnDatabaseConverted)
	ON_COMMAND(ID_COORDINATION_GE06_INTTO_BCBT2DBCBT, OnCoordinationGe06InttoBcbt2dbcbt)
	ON_COMMAND(ID_COORDINATION_GE06_INTTO_BCBT2ABT, OnCoordinationGe06InttoBcbt2Abt)
	ON_COMMAND(ID_COORDINATION_GE06_INTTO_FXM2DBCBT, OnCoordinationGe06InttoFxm2dbcbt)
	ON_COMMAND(ID_COORDINATION_GE06_INTTO_FXM2ABT, OnCoordinationGe06InttoFxm2Abt)
	ON_COMMAND(ID_COORDINATION_GE06_INTTO_BCBT2FXM, OnCoordinationGe06InttoBcbt2fxm)
	ON_COMMAND(ID_DATABASE_SHOWSRVBCBT, OnDatabaseShowsrvbcbt)
	ON_COMMAND(ID_COORDINATION_GE06_INTFROM_BCBT2DBCBT, OnCoordinationGe06IntfromBcbt2dbcbt)
	ON_COMMAND(ID_COORDINATION_GE06_INTFROM_BCBT2ABT, OnCoordinationGe06IntfromBcbt2abt)
	ON_COMMAND(ID_COORDINATION_GE06_INTFROM_FXM2DBCBT, OnCoordinationGe06IntfromFxm2dbcbt)
	ON_COMMAND(ID_COORDINATION_GE06_INTFROM_FXM2ABT, OnCoordinationGe06IntfromFxm2abt)
	ON_COMMAND(ID_COORDINATION_GE06_INTFROM_BCBT2FXM, OnCoordinationGe06IntfromBcbt2fxm)
	ON_COMMAND(ID_TOOLS_GOOGLE_SELECTEDSTATIONS, OnToolsGoogleSelectedstations)
	ON_COMMAND(ID_TOOLS_GOOGLE_LINKS, OnToolsGoogleLinks)
	ON_COMMAND(ID_TOOLS_GOOGLE_SELECTEDEARTHSTATIONS, OnToolsGoogleSelectedearthstations)
	ON_COMMAND(ID_TOOLS_GOOGLE_RECEIVINGAREA, OnToolsGoogleReceivingarea)
	ON_COMMAND(ID_TOOLS_GOOGLE_SERVICEAREAFXM, OnToolsGoogleServiceareafxm)
	ON_COMMAND(ID_TOOLS_GOOGLE_SERVICEAREAGE06BCBT, OnToolsGoogleServiceareage06bcbt)
	ON_COMMAND(ID_TOOLS_GOOGLE_ALLOTMENTAREA, OnToolsGoogleAllotmentarea)
	ON_COMMAND(ID_TOOLS_GOOGLE_GE06PLANENTRY, OnToolsGoogleGe06planentry)
	ON_COMMAND(ID_TOOLS_GOOGLE_CONVERTEDASSIGNMENTS, OnToolsGoogleConvertedassignments)
	ON_COMMAND(ID_TOOLS_GOOGLE_VECTORS, OnToolsGoogleVectors)
	ON_COMMAND(ID_FILE_SAVE, OnFileSave)
	ON_COMMAND(ID_VECTORS_VECTORHANDLING, OnVectorsVectorhandling)
	ON_UPDATE_COMMAND_UI(ID_VECTORS_VECTORHANDLING, OnUpdateVectorsVectorhandling)
	ON_COMMAND(ID_CALCULATION_EARTHSTATIONHORIZONELEVATION, OnCalculationEarthstationhorizonelevation)
	ON_COMMAND(ID_CALCULATION_EARTHSTATION_AZIMUTHTOGSOSATELLITES, OnCalculationEarthstationAzimuthtogsosatellites)
	ON_COMMAND(ID_CALCULATION_EARTHSTATION_ELEVATIONTOGSOSATELLITES, OnCalculationEarthstationElevationtogsosatellites)
	ON_COMMAND(ID_MONITORING_ARGUS_RESPONDTOORDER, OnMonitoringArgusRespondtoorder)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_ARGUS_RESPONDTOORDER, OnUpdateMonitoringArgusRespondtoorder)
	ON_WM_TIMER()
	ON_COMMAND(ID_MONITORING_ARGUS_GSPORDER, OnMonitoringArgusGsporder)
	ON_COMMAND(ID_MONITORING_ARGUS_ORMORDER, OnMonitoringArgusOrmorder)
	ON_COMMAND(ID_MONITORING_ARGUS_STOPORDER, OnMonitoringArgusStoporder)
	ON_COMMAND(ID_MONITORING_ARGUS_DRAWOUTPUT, OnMonitoringArgusDrawoutput)
	ON_COMMAND(ID_MONITORING_ARGUS_ORDERSTATUS, OnMonitoringArgusOrderstatus)
	ON_COMMAND(ID_MONITORING_THALES_VIEW_CHECKLIST, OnMonitoringThalesViewChecklist)
	ON_COMMAND(ID_MONITORING_THALES_VIEW_OCCUPANCYRATE, OnMonitoringThalesViewOccupancyrate)
	ON_COMMAND(ID_MONITORING_THALES_VIEW_REQUESTS, OnMonitoringThalesViewRequests)
	ON_COMMAND(ID_MONITORING_THALES_VIEW_RESULTS, OnMonitoringThalesViewResults)
	ON_COMMAND(ID_MONITORING_THALES_CHECKLISTGENERATION_MISSIONCREATION, OnMonitoringThalesChecklistgenerationMissioncreation)
	ON_COMMAND(ID_MONITORING_THALES_CHECKLISTGENERATION_REQUESTS, OnMonitoringThalesChecklistgenerationRequests)
	ON_COMMAND(ID_MONITORING_THALES_DRAWOUTPUT, OnMonitoringThalesDrawoutput)
	ON_COMMAND(ID_MONITORING_THALES_ATR, OnMonitoringThalesAtr)
	ON_COMMAND(ID_MONITORING_THALES_CHECKLISTGENERATION_REQUESTSAUTOMATIC, OnMonitoringThalesChecklistgenerationRequestsautomatic)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_THALES_CHECKLISTGENERATION_REQUESTSAUTOMATIC, OnUpdateMonitoringThalesChecklistgenerationRequestsautomatic)
	ON_COMMAND(ID_TOOLS_CONVERTANTENNAFILE, OnToolsConvertantennafile)
	ON_COMMAND(ID_MONITORING_OTHERS_RESPONDTOM2SORDER, OnMonitoringOthersRespondtom2sorder)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_OTHERS_RESPONDTOM2SORDER, OnUpdateMonitoringOthersRespondtom2sorder)
	ON_COMMAND(ID_MONITORING_OTHERS_S2MORDER, OnMonitoringOthersS2morder)
	ON_COMMAND(ID_MONITORING_OTHERS_ORDERSTATUS, OnMonitoringOthersOrderstatus)
	ON_COMMAND(ID_MONITORING_OTHERS_STOPORDER, OnMonitoringOthersStoporder)
	ON_COMMAND(ID_MONITORING_OTHERS_DRAWOUTPUT, OnMonitoringOthersDrawoutput)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_AREA, OnPropagationmodelsP18123Area)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P18123_AREA, OnUpdatePropagationmodelsP18123Area)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_FIELDSTRENGTHCONTOUR, OnPropagationmodelsP18123Fieldstrengthcontour)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_LINE, OnPropagationmodelsP18123Line)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P18123_LINE, OnUpdatePropagationmodelsP18123Line)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_POLYLINE, OnPropagationmodelsP18123Polyline)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P18123_POLYLINE, OnUpdatePropagationmodelsP18123Polyline)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_LINK, OnPropagationmodelsP18123Link)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnPropagationmodelsP18123NetworkprocessorMaximumfieldstrength)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P18123_NETWORKPROCESSOR_MAXIMUMFIELDSTRENGTH, OnUpdatePropagationmodelsP18123NetworkprocessorMaximumFS)
	ON_COMMAND(ID_PROPAGATIONMODELS_P18123_NETWORKPROCESSOR_BESTSERVER, OnPropagationmodelsP18123NetworkprocessorBestserver)
	ON_UPDATE_COMMAND_UI(ID_PROPAGATIONMODELS_P18123_NETWORKPROCESSOR_BESTSERVER, OnUpdatePropagationmodelsP18123NetworkprocessorBestserver)
	ON_COMMAND(ID_INTERFERENCE_INTERMODULATION, OnInterferenceIntermodulation)
	ON_COMMAND(ID_COORDINATION_HCM, OnCoordinationHcm)
	ON_COMMAND(ID_PROPAGATIONMODELS_P526V14_LINK, OnPropagationmodelsP526v14Link)
	ON_WM_ERASEBKGND()
	ON_COMMAND(ID_TOOLS_COLORMAP_3D, OnToolsColormap3d)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_COLORMAP_3D, OnUpdateToolsColormap3d)
	ON_COMMAND(ID_TOOLS_COLORMAP_NEGATIVE, OnToolsColormapNegative)
	ON_UPDATE_COMMAND_UI(ID_TOOLS_COLORMAP_NEGATIVE, OnUpdateToolsColormapNegative)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_P18123, OnMonitoringNetworkplanningCoveragezonesP18123)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_P18123, OnMonitoringNetworkplanningLocationzoneaoaP18123)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_P18123, OnMonitoringNetworkplanningLocationzonetdoaP18123)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RX_BS_P18123, OnMonitoringNetworkplanningRxBsP18123)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RX_MFS_P18123, OnMonitoringNetworkplanningRxMfsP18123)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RX_BS_P18123, OnUpdateMonitoringNetworkplanningRxBsP18123)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RX_MFS_P18123, OnUpdateMonitoringNetworkplanningRxMfsP18123)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_P18123, OnUpdateMonitoringNetworkplanningCoveragezonesP18123)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_P18123, OnUpdateMonitoringNetworkplanningLocationzoneaoaP18123)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_P18123, OnUpdateMonitoringNetworkplanningLocationzonetdoaP18123)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RX_BS_P15465, OnMonitoringNetworkplanningRxBsP15465)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RX_BS_P15465, OnUpdateMonitoringNetworkplanningRxBsP15465)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_P15465, OnMonitoringNetworkplanningCoveragezonesP15465)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_P15465, OnUpdateMonitoringNetworkplanningCoveragezonesP15465)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_P15465, OnMonitoringNetworkplanningLocationzoneaoaP15465)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_P15465, OnUpdateMonitoringNetworkplanningLocationzoneaoaP15465)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_P15465, OnMonitoringNetworkplanningLocationzonetdoaP15465)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_P15465, OnUpdateMonitoringNetworkplanningLocationzonetdoaP15465)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RX_MFS_P15465, OnMonitoringNetworkplanningRxMfsP15465)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RX_MFS_P15465, OnUpdateMonitoringNetworkplanningRxMfsP15465)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_FREESPACE, OnMonitoringNetworkplanningCoveragezonesFreespace)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_COVERAGEZONES_FREESPACE, OnUpdateMonitoringNetworkplanningCoveragezonesFreespace)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_FREESPACE, OnMonitoringNetworkplanningLocationzoneaoaFreespace)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONEAOA_FREESPACE, OnUpdateMonitoringNetworkplanningLocationzoneaoaFreespace)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_FREESPACE, OnMonitoringNetworkplanningLocationzonetdoaFreespace)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_LOCATIONZONETDOA_FREESPACE, OnUpdateMonitoringNetworkplanningLocationzonetdoaFreespace)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RXCOVERAGEAREA_MAXIMUMFIELDSTRENGTH_FREESPACE, OnMonitoringNetworkplanningRxMFSFreespace)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RXCOVERAGEAREA_MAXIMUMFIELDSTRENGTH_FREESPACE, OnUpdateMonitoringNetworkplanningRxMFSFreespace)
	ON_COMMAND(ID_MONITORING_NETWORKPLANNING_RXCOVERAGEAREA_BESTSERVER_FREESPACE, OnMonitoringNetworkplanningRxBSFreespace)
	ON_UPDATE_COMMAND_UI(ID_MONITORING_NETWORKPLANNING_RXCOVERAGEAREA_BESTSERVER_FREESPACE, OnUpdateMonitoringNetworkplanningRxBSFreespace)
	//}}AFX_MSG_MAP
	// Standard printing commands
	ON_COMMAND(ID_FILE_PRINT, CScrollView::OnFilePrint)
	ON_COMMAND(ID_FILE_PRINT_DIRECT, CScrollView::OnFilePrint)
	ON_COMMAND(ID_FILE_PRINT_PREVIEW, OnFilePrintPreview)
END_MESSAGE_MAP()

/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView construction/destruction

CSMS4DCView::CSMS4DCView():	m_Color(RGB(0,100,200))
{
	pi = 4.0*atan(1.0);
	D2R = pi/180.0;
	R2D = 180.0/pi;

//	m_PolyPoint = new CPoint[100];	m_Point_STcr = new CPoint[73];
	VScrollpos = HScrollpos = m_PolyPointNum0 = m_PolyPointNum = m_POLYnum = m_MenuBarGrid = Num_ST = m_colorRate = Num_Link = Num_EST = 0;
	m_stLinePoint = m_enLinePoint = m_stBoxPoint = m_enBoxPoint = CPoint(0,0);
	m_bLPressed = m_DrawVector = m_bLPressedP = false;
	m_bToolBarDraw = _T("");

//	for (int i=0;i<73;i++)		m_Point_STcr[i] = CPoint(0,0);
	m_GridStep = 1.0;

	m_pLegendDLGModeless = NULL; 	m_LegendFlag = FALSE;
	m_SymbolColor = m_SymbolTextColor = RGB(0,0,80);	m_SymbolSize = 4;

	long UNR = 72 ;	WDBUNIT(&UNR) ;
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ShowControlBar(&(((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndToolBar), TRUE, FALSE);
	m_IndexMoveST = m_IndexMoveEST = -999;
	m_AppPath = ((CSMS4DCApp *)AfxGetApp())->m_AppPath ;
	m_pToolTip = new CToolTipCtrl;		m_pToolTip->Create(this,TTS_ALWAYSTIP);
	m_pToolTip->SetMaxTipWidth(300);	m_pToolTip->SetDelayTime(TTDT_AUTOPOP,20000);
	m_pToolTipES = new CToolTipCtrl;	m_pToolTipES->Create(this,TTS_ALWAYSTIP);
	m_pToolTipES->SetMaxTipWidth(300);	m_pToolTipES->SetDelayTime(TTDT_AUTOPOP,20000);

	m_GoogleFlag = TRUE;
//	m_CircleDraw = FALSE;

	m_pDocOverlay = NULL;
	m_OverlayFlag = FALSE;
	m_OverlayFactor = 50;

	m_pDocVectors = NULL;

	m_CoplLat = -999;
	m_CoplLon = -999;

	Function_Queries();

//	m_ArgusPathIN  = _T("C:\\ARGUS\\OUTBOX");
//	m_ArgusPathOUT = _T("C:\\ARGUS\\INBOX");
	m_nTimerID = 0;
	m_ArgusOrder = FALSE;
	m_GSPflag = FALSE;

	m_ThalesOrder = FALSE;

	m_OthersOrder = FALSE;
	m_nTimerOthersID = 0;
}



CSMS4DCView::~CSMS4DCView()
{
	if(m_LegendFlag)
	{
		m_pLegendDLGModeless = NULL;
		delete m_pLegendDLGModeless;
	}
	delete m_pToolTip;		delete m_pToolTipES;
	if (Num_ST>0)
	{
		ID_ST = NULL;		Lat_ST = NULL;		Lon_ST = NULL;		Name_ST = NULL;
		delete [] ID_ST;	delete [] Lat_ST;	delete [] Lon_ST;	delete [] Name_ST;	delete [] m_STinfo;
	}
	if (Num_Link>0)
	{
		delete [] HopID;	delete [] Lat_TxLink;	delete [] Lon_TxLink;	delete [] Lat_RxLink;	delete [] Lon_RxLink;
	}
	if (Num_EST>0)
	{
		ID_EST = NULL;		Lat_EST = NULL;		Lon_EST = NULL;		Name_EST = NULL;
		delete [] ID_EST;	delete [] Lat_EST;	delete [] Lon_EST;	delete [] Name_EST;	delete [] m_ESTinfo;
	}
//	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ShowControlBar(&(((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndToolBar), FALSE, FALSE);
//	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ShowControlBar(&(((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_ToolBarIDWMMap), TRUE, FALSE);//970710

	m_pDocOverlay = NULL;

	if(m_pDocVectors)
	{
		m_pDocVectors->OnCmdMsg(ID_FILE_CLOSE,0,0,0);
		m_pDocVectors = NULL;
	}
	((CSMS4DCApp *)AfxGetApp())->m_pView = NULL;

	if(m_nTimerID!=0)
	{
		::KillTimer( this->m_hWnd, m_nTimerID);
		m_thisList.RemoveKey(m_nTimerID);   
		m_nTimerID = 0;
	}	

	if(m_nTimerOthersID!=0)
	{
		::KillTimer( this->m_hWnd, m_nTimerOthersID);
		m_thisListOthers.RemoveKey(m_nTimerOthersID);   
		m_nTimerOthersID = 0;
	}

	Del_hBitmap();
}

BOOL CSMS4DCView::PreCreateWindow(CREATESTRUCT& cs)
{
	return CScrollView::PreCreateWindow(cs);
}
/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView drawing

void CSMS4DCView::OnDraw(CDC* pDC)
{
	if (m_hBitmap)
	{
		HDC hMemDC = CreateCompatibleDC(pDC->GetSafeHdc()); 
		if (hMemDC)
		{
			HBITMAP hOldBitmap = (HBITMAP)SelectObject(hMemDC, m_hBitmap);
			CSize IMsize;		::GetBitmapDimensionEx(m_hBitmap, &IMsize);
	
			///////////////////////////////////////
			int x1,y1,x2,y2;
			if (pDC->IsPrinting())
			{
				int offset = max(abs(m_rcPrintRect.right - m_rcPrintRect.left),
								 abs(m_rcPrintRect.top - m_rcPrintRect.bottom))/10;		//	int offset = 800;

				x1 = m_rcPrintRect.left+offset;			y1 = m_rcPrintRect.top+offset;
				x2 = m_rcPrintRect.right-offset;		y2 = m_rcPrintRect.bottom-offset;
			}
			else
			{
				x1 = 0;		y1 = 0;		x2 = 1200-1;	y2 = 1200-1;
			}
			m_x1 = x1;	m_y1 = y1;	m_x2 = x2;		m_y2 = y2;
			///////////////////////////////////////
//CDC MemDC;
//MemDC.Attach(hMemDC); 
//OnDraw_Objects(&MemDC);	//97/10/18
//MemDC.Detach();	MemDC.DeleteDC(); 

			::StretchBlt(pDC->GetSafeHdc(), x1,y1,x2-x1,y2-y1, 
						hMemDC, 0, 0, IMsize.cx,IMsize.cy, SRCCOPY );


			// select old bitmap back into memory DC and get handle to bitmap
			SelectObject(hMemDC, hOldBitmap); 

			DeleteDC(hMemDC); 
			hMemDC = NULL;
		}
	}

	OnDraw_Objects( pDC);	//97/10/18

	int i;
/////////////////// Station ////////////////////////
	if (Num_ST>0)
	{
		int scale = 1;
		if (pDC->IsPrinting())		scale = 5;

		CPoint Point1;
		for ( i=0;i<Num_ST;i++)
		{
			DrawSymboleStation(pDC, Lat_ST[i], Lon_ST[i], m_SymbolColor, scale*m_SymbolSize);
			LatLon2Point(Lat_ST[i], Lon_ST[i],&Point1);
			TextDraw(pDC,Point1.x+scale*4, Point1.y-scale*5,Name_ST[i],m_SymbolTextColor,0,scale*12);
		}
	}
/////////////////// Link ////////////////////////
	if (Num_Link>0)
	{
		for ( i=0;i<Num_Link;i++)		DrawSymboleLink(pDC,Lat_TxLink[i],Lon_TxLink[i],Lat_RxLink[i],Lon_RxLink[i]) ;
	}
/////////////////// Earth Station ////////////////////////
	if (Num_EST>0)
	{
		int scale = 1;
		if (pDC->IsPrinting())		scale = 5;
		CPoint Point1;
		for (i=0;i<Num_EST;i++)
		{
			DrawSymboleEarthStation(pDC, Lat_EST[i], Lon_EST[i], m_SymbolColor, scale*m_SymbolSize);
			LatLon2Point(Lat_EST[i], Lon_EST[i],&Point1);
			TextDraw(pDC,Point1.x+scale*4, Point1.y-scale*5, Name_EST[i] ,m_SymbolTextColor,0,scale*12);
		}
	}
	if(m_CoplLat!=-999)
		DrawSymboleCopl(pDC, m_CoplLat, m_CoplLon, m_SymbolColor, m_SymbolSize);
}


void CSMS4DCView::OnDraw1(CDC* pDC)
{
	CSMS4DCDoc* pDoc = (CSMS4DCDoc*)GetDocument();
	ASSERT_VALID(pDoc);
////////////////////////////////////////
	BYTE *temp2 , *Display=(BYTE *)malloc(pDoc->Width * pDoc->Height * sizeof(BYTE)); 
	_int16 *temp = (_int16 *)pDoc->buf;	temp2 = Display;

	_int16 m_MinValue1 = (_int16)max((double)pDoc->bufMin,m_MinValue);
	_int16 m_MaxValue1 = (_int16)min((double)pDoc->bufMax,m_MaxValue);
	for (int i=0;i<pDoc->Width;i++)
		for (int j=0;j<pDoc->Height;j++)
		{
			if((*temp)!=pDoc->m_NoData)
			{
				if(m_MaxValue1 == m_MinValue1)	*temp2 = 0;
				else							*temp2 = ( min(max((*temp),m_MinValue1),m_MaxValue1) - m_MinValue1) * 255 / (m_MaxValue1- m_MinValue1);
			}
			else								*temp2 = 255;

			if     ((*temp)<=m_MinValue1)		*temp2 = 0;
			else if((*temp)>=m_MaxValue1)		*temp2 = 254;
			temp2++;	temp++;
		}
	BITMAPFILEHEADER * pbmfh ;
	BITMAPINFO       * pbmi ;
	BYTE             * pBits ;
    int              cxDib, cyDib ;
		
	// Load the entire DIB into memory
	pbmfh = (struct tagBITMAPFILEHEADER *)malloc (1078) ;

//	CString BMP_HEADER =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Texts\\BMP_HEADER");
//	FILE *fp=fopen(BMP_HEADER,"rb");
//	fread(pbmfh,1078,1,fp);
//	fclose(fp);
              
	// Get pointers to the info structure & the bits
	pbmfh->bfType='BM';
	pbmfh->bfReserved1=0;
	pbmfh->bfReserved2=0;
	pbmfh->bfSize=pDoc->Width * pDoc->Height+1078;
	pbmfh->bfOffBits=1078;

	pbmi  = (BITMAPINFO *) (pbmfh + 1) ;
	pbmi->bmiHeader.biSize=40;
	pbmi->bmiHeader.biWidth=pDoc->Width ;
	pbmi->bmiHeader.biHeight=pDoc->Height ;
	pbmi->bmiHeader.biPlanes=1;
	pbmi->bmiHeader.biBitCount=8;
	pbmi->bmiHeader.biCompression=0;
	pbmi->bmiHeader.biSizeImage=pDoc->Width * pDoc->Height ;
	pbmi->bmiHeader.biXPelsPerMeter=0;
	pbmi->bmiHeader.biYPelsPerMeter=0;
	pbmi->bmiHeader.biClrUsed=256;
	pbmi->bmiHeader.biClrImportant=256;
	for( i=0;i<256;i++)
	{
		pbmi->bmiColors[i].rgbBlue  =   max(0,min(255,m_colorRate + GetBValue(pDoc->RGBt[i]) ));
		pbmi->bmiColors[i].rgbGreen =   max(0,min(255,m_colorRate + GetGValue(pDoc->RGBt[i]) ));
		pbmi->bmiColors[i].rgbRed   =   max(0,min(255,m_colorRate + GetRValue(pDoc->RGBt[i]) ));
		pbmi->bmiColors[i].rgbReserved=0;
	}
	pbmi->bmiColors[255].rgbBlue = 255;	pbmi->bmiColors[255].rgbGreen = 0;	pbmi->bmiColors[255].rgbRed = 0;
	
	pBits = (BYTE *) Display; 
	// Get the DIB width and height
	if (pbmi->bmiHeader.biSize == sizeof (BITMAPCOREHEADER))
	{
		cxDib = ((BITMAPCOREHEADER *) pbmi)->bcWidth ;		cyDib = ((BITMAPCOREHEADER *) pbmi)->bcHeight ;
	}
	else
	{
		cxDib = pbmi->bmiHeader.biWidth ;					cyDib = abs (pbmi->bmiHeader.biHeight) ;
	}

	if (pbmfh)
	{
		CDC MemDC;		BITMAP bm;		CBitmap m_bitmap;

		m_bitmap.CreateCompatibleBitmap(pDC, pDoc->Width , pDoc->Height);
		m_bitmap.GetObject (sizeof (BITMAP), &bm);
		MemDC.CreateCompatibleDC(pDC);	MemDC.SetMapMode(pDC->GetMapMode());	MemDC.SelectObject(m_bitmap);
		SetDIBitsToDevice (MemDC.m_hDC,	//pDC->m_hDC, //MemDC.m_hDC, 
						  0,0,			// xDst,  yDst
						  cxDib,cyDib,  // cxSrc, cySrc
						  0,0,          // xSrc,  ySrc
						  0,            // first scan line
						  cyDib,        // number of scan lines
						  pBits, 
						  pbmi, DIB_RGB_COLORS) ;
			///////////////////////////////////////
			int x1,y1,x2,y2;
			if (pDC->IsPrinting())
			{
				int offset = max(abs(m_rcPrintRect.right - m_rcPrintRect.left),
						         abs(m_rcPrintRect.top - m_rcPrintRect.bottom))/10;		//		int offset = 800;

				x1 = m_rcPrintRect.left+offset;			y1 = m_rcPrintRect.top+offset;
				x2 = m_rcPrintRect.right-offset;		y2 = m_rcPrintRect.bottom-offset;
			}
			else
			{
				x1 = 0;		y1 = 0;		x2 = 1200-1;	y2 = 1200-1;
			}
			m_x1 = x1;	m_y1 = y1;	m_x2 = x2;	m_y2 = y2;
			///////////////////////////////////////
OnDraw_Objects(&MemDC);	//97/10/18

			pDC->StretchBlt(x1,y1,x2-x1,y2-y1,&MemDC ,0,0,pDoc->Width , pDoc->Height,SRCCOPY);

			DeleteDC(MemDC.m_hDC);		MemDC.Detach();		DeleteObject(m_bitmap); 
	}
	free (pbmfh) ;	free(Display);
}

void CSMS4DCView::OnInitialUpdate()
{
	CScrollView::OnInitialUpdate();
	CSMS4DCDoc* pDoc = (CSMS4DCDoc*)GetDocument();

	CString Title_En  = "Main Desktop";
	CString Title_Num = pDoc->GetTitle();		Title_Num.Replace(Title_En,"");
	GetParent()->SetWindowText(_Z(Title_En) + Title_Num); 

	m_MinValue=pDoc->bufMin;	m_MaxValue=pDoc->bufMax;

	CSize totalSize(1200,1200) , pageSize(50,50) , lineSize(10,10);
	SetScrollSizes(MM_TEXT, totalSize,pageSize,lineSize);

	m_ColorMapNegative = FALSE;		//97/12/26
	m_3D = FALSE;					//97/12/12
	m_hBitmap = Draw_hBitmap(pDoc);

	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ChangeMenuLang(IDR_SMS4DCTYPE);
}
/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView printing

BOOL CSMS4DCView::OnPreparePrinting(CPrintInfo* pInfo)
{
	return DoPreparePrinting(pInfo);
}
void CSMS4DCView::OnBeginPrinting(CDC* /*pDC*/, CPrintInfo* /*pInfo*/)
{
}
void CSMS4DCView::OnEndPrinting(CDC* /*pDC*/, CPrintInfo* /*pInfo*/)
{
}
void CSMS4DCView::OnEndPrintPreview(CDC* pDC, CPrintInfo* pInfo, POINT point, CPreviewView* pView) 
{
	CScrollView::OnEndPrintPreview(pDC, pInfo, point, pView);
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ToolbarSet();
}
void CSMS4DCView::OnFilePrintPreview() 
{
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->ToolbarCheck();
	CScrollView::OnFilePrintPreview();
}
/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView diagnostics

#ifdef _DEBUG
void CSMS4DCView::AssertValid() const
{
	CScrollView::AssertValid();
}

void CSMS4DCView::Dump(CDumpContext& dc) const
{
	CScrollView::Dump(dc);
}

CSMS4DCDoc* CSMS4DCView::GetDocument() // non-debug version is inline
{
	ASSERT(m_pDocument->IsKindOf(RUNTIME_CLASS(CSMS4DCDoc)));
	return (CSMS4DCDoc*)m_pDocument;
}
#endif //_DEBUG

/////////////////////////////////////////////////////////////////////////////
// CSMS4DCView message handlers

void CSMS4DCView::OnTopo1()	{	ColorMap_Function(_T("Topo_1"));	}
void CSMS4DCView::OnUpdateTopo1(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Topo_1") ? 1 : 0);
}
void CSMS4DCView::OnGlobe()	{	ColorMap_Function(_T("Globe"));		}
void CSMS4DCView::OnUpdateGlobe(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Globe") ? 1 : 0);	
}
void CSMS4DCView::OnTopo_0() {	ColorMap_Function(_T("Topo_0"));}
void CSMS4DCView::OnUpdateTopo_0(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Topo_0") ? 1 : 0);
}
void CSMS4DCView::OnJet() {	ColorMap_Function(_T("Jet"));}
void CSMS4DCView::OnUpdateJet(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Jet") ? 1 : 0);	
}
void CSMS4DCView::OnGray() {	ColorMap_Function(_T("Gray"));}
void CSMS4DCView::OnUpdateGray(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Gray") ? 1 : 0);	
}
void CSMS4DCView::OnPink() {	ColorMap_Function(_T("Pink"));}
void CSMS4DCView::OnUpdatePink(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Pink") ? 1 : 0);
}
void CSMS4DCView::OnCopper() {	ColorMap_Function(_T("Copper"));}
void CSMS4DCView::OnUpdateCopper(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	pCmdUI->SetCheck(pDoc->colormaptype == _T("Copper") ? 1 : 0);	
}
void CSMS4DCView::OnGlobeDEM() 
{
	CString TileInfo = m_AppPath + _T("Texts\\globe.txt");
	MapLayerChange(TileInfo,46,25);
}
void CSMS4DCView::OnUpdateGlobeDEM(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	CString TileInfo = m_AppPath + _T("Texts\\globe.txt");
	pCmdUI->SetCheck(pDoc->TileInfo == TileInfo ? 1 : 0);	
}
void CSMS4DCView::MapLayerChange(CString TileInfo,int Tx0,int Ty0) 
{
	CFileFind x1;
	BOOL i = x1.FindFile(TileInfo), flag = TRUE;
	x1.Close();
	if(i)
	{
		char FilesPath[500] , FilesPrefix[50] , dum[20];
		FILE *fid;
		fid = fopen(TileInfo,"rt");

//------------97/12/12-----------------------------------------
//		fscanf( fid, "%s %s", dum,FilesPath);

char dum1[2000];
fgets( dum1, 2000, fid );
CString sdum1 = dum1;
int isdum1 = sdum1.Find(' ',0);
sdum1.Delete(0,isdum1);		sdum1.TrimLeft();	sdum1.TrimRight();
int nsdum = sdum1.GetLength();
memcpy(FilesPath, sdum1,   nsdum*sizeof(char));
FilesPath[nsdum] = '\0';
//-----------------------------------------------------

		int fscanflag1 = fscanf( fid, "%s %s", dum,FilesPrefix);
		fclose(fid);

		if(fscanflag1==-1)
		{
			MessageBox(_Z("Map Description File is damaged.")+"\n\n"+TileInfo, _Z("Error!!!"), MB_ICONERROR | MB_OK);	return;
		}
		CString Fname,Er;

		CString mFindIndexFile = ((CSMS4DCApp *)AfxGetApp())->FindIndexFile(FilesPath,FilesPrefix);
		Fname.Format(mFindIndexFile,1,1);	int i11 = x1.FindFile(Fname);	if(!i11){	Er+="\n"+Fname;	}
		Fname.Format(mFindIndexFile,1,2);	int i12 = x1.FindFile(Fname);	if(!i12){	Er+="\n"+Fname;	}
		Fname.Format(mFindIndexFile,2,1);	int i21 = x1.FindFile(Fname);	if(!i21){	Er+="\n"+Fname;	}
		Fname.Format(mFindIndexFile,2,2);	int i22 = x1.FindFile(Fname);	if(!i22){	Er+="\n"+Fname;	}
/*
		Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,1,1);	int i11 = x1.FindFile(Fname);	if(!i11)	{	Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,1,1);	Er+="\n"+Fname;	}
		Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,1,2);	int i12 = x1.FindFile(Fname);	if(!i12)	{	Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,1,2);	Er+="\n"+Fname;	}
		Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,2,1);	int i21 = x1.FindFile(Fname);	if(!i21)	{	Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,2,1);	Er+="\n"+Fname;	}
		Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,2,2);	int i22 = x1.FindFile(Fname);	if(!i22)	{	Fname.Format("%s%s_%02d_%02d",FilesPath,FilesPrefix,2,2);	Er+="\n"+Fname;	}
*/
		if(!Er.IsEmpty())
		{
			MessageBox(_Z("Missing Tile(s) :")+"\n\n"+Er, _Z("Error!!!"), MB_ICONERROR | MB_OK);	flag = FALSE;
		}
	}
	else
	{
		MessageBox(_Z("Map Description File not found.")+"\n\n"+TileInfo, _Z("Error!!!"), MB_ICONERROR | MB_OK);	flag=FALSE;
	}
	if(!flag)		return;

	CSMS4DCDoc* pDoc = GetDocument();
	if ( pDoc->TileInfo != TileInfo )
	{
		/////////////////////////////////////////////////
		double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
		Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);		Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);
		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);	Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);

		double *latp;	latp=new double[m_PolyPointNum+1];
		double *lonp;	lonp=new double[m_PolyPointNum+1];
		double lat1,lon1;
		for (int k=0;k<m_PolyPointNum+1;k++)
		{
			Point2LatLon(m_PolyPoint[k],&lat1,&lon1);		latp[k]=lat1;	lonp[k]=lon1;
		}
/*
		double *latcr;	latcr=new double[73];
		double *loncr;	loncr=new double[73];
		for ( k=0;k<73;k++)
		{
			Point2LatLon(m_Point_STcr[k],&lat1,&lon1);		latcr[k]=lat1;	loncr[k]=lon1;
		}
*/
		/////////////////////////////////////////////////
		pDoc->TileInfo = TileInfo;
		pDoc->TileX = Tx0;     pDoc->TileY = Ty0;
/*
		int Npx,Npy,Nod;
		char FilesPath[100] , FilesPrefix[20];
		pDoc->m_tile.getTileInfo(pDoc->TileInfo,
								&pDoc->TileX,&pDoc->TileY,
								&Npx,&Npy,&Nod,FilesPath,FilesPrefix);
		pDoc->Width=2*Npx;  	pDoc->Height=2*Npy;
		pDoc->bufMax=-32768;   	pDoc->bufMin=32767;
		pDoc->m_tile.getTileBuf(pDoc->TileX,pDoc->TileY, Npx,Npy,Nod, FilesPath,FilesPrefix, pDoc->buf, &pDoc->bufMin,&pDoc->bufMax);
		pDoc->m_Lower_left_x=pDoc->m_tile.m_Lower_left_x;
		pDoc->m_Lower_left_y=pDoc->m_tile.m_Lower_left_y;
		pDoc->m_Resolution_x=pDoc->m_tile.m_Resolution_x;
		pDoc->m_Resolution_y=pDoc->m_tile.m_Resolution_y;
		pDoc->m_NoData=pDoc->m_tile.m_NoData;
		pDoc->m_MachineFormat[0]=pDoc->m_tile.m_MachineFormat[0];
*/
		pDoc->PreGetData();
		//pDoc->GetData();
		/////////////////////////////////////////////////////////////////////
		double stenlat=(stBoxlat+enBoxlat)/2.0,stenlon=(stBoxlon+enBoxlon)/2.0;
		CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
		if (pDoc->TileInfo != globeTileInfo)
		{
			CUtm m_utm;
			m_utm.phi=stenlat;
			m_utm.lambda=stenlon;
			m_utm.philambda2UTM();
			stenlat=m_utm.y;
			stenlon=m_utm.x;
		}
		double ix=(stenlon - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
		double jy=(stenlat - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);
		pDoc->TileX = ( ( (ix-(int)ix) < 0.5 ) ? (int) ix : 1+(int) ix);
		pDoc->TileY = ( ( (jy-(int)jy) < 0.5 ) ? (int) jy : 1+(int) jy);
/*
		pDoc->m_tile.getTileInfo(pDoc->TileInfo,&pDoc->TileX,&pDoc->TileY,&Npx,&Npy,&Nod,FilesPath,FilesPrefix);
		pDoc->Width=2*Npx;  	pDoc->Height=2*Npy;
		pDoc->bufMax=-32768;   	pDoc->bufMin=32767;
		pDoc->m_tile.getTileBuf(pDoc->TileX,pDoc->TileY,Npx,Npy,Nod,FilesPath,FilesPrefix,pDoc->buf,&pDoc->bufMin,&pDoc->bufMax);
*/
		pDoc->PreGetData();
		pDoc->GetData();

		LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);		LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
		LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);	LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);

		for ( k=0;k<m_PolyPointNum+1;k++)	LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
		delete [] latp;		delete [] lonp;
//		for ( k=0;k<73;k++)		LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//		delete [] latcr;		delete [] loncr;
		/////////////////////////////////////////////////////////////////////
		m_MinValue = pDoc->bufMin;	m_MaxValue = pDoc->bufMax;
		InvalidateLegend();	//97/12/26	
		UpDate_hBitmap(pDoc);
		Invalidate();
	}
}

void CSMS4DCView::OnMouseMove(UINT nFlags, CPoint point) 
{
	if( (m_bToolBarDraw == _T("line")		)||	(m_bToolBarDraw == _T("box")			)||
		(m_bToolBarDraw == _T("addstation")	)||	(m_bToolBarDraw == _T("addESstation")	)||
		(m_bToolBarDraw == _T("polygon")) )
		SetCursor(AfxGetApp()->LoadCursor(IDC_CURSOR2));		//98/01/17
//		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_CROSS));

	/////////////////////////Draw Polygon////////////////////////////////////
	if( (m_PolyPointNum0>0) && (m_bLPressedP) && (m_bToolBarDraw == _T("polygon")))
	{
		CClientDC dc(this);
		CPen pen;		pen.CreatePen(PS_DOT,1,m_Color);		dc.SelectObject(&pen);

		int mROP2 = dc.SetROP2(R2_NOTXORPEN);	//98/01/17
		dc.MoveTo(m_PolyPoint[m_PolyPointNum0-1].x-HScrollpos , m_PolyPoint[m_PolyPointNum0-1].y-VScrollpos);
		dc.LineTo(m_PolyPoint[m_PolyPointNum0].x-HScrollpos , m_PolyPoint[m_PolyPointNum0].y-VScrollpos);
		
		dc.MoveTo(m_PolyPoint[m_PolyPointNum0-1].x-HScrollpos , m_PolyPoint[m_PolyPointNum0-1].y-VScrollpos);
		dc.LineTo(point.x,point.y);
		m_PolyPoint[m_PolyPointNum0].x=point.x+HScrollpos;
		m_PolyPoint[m_PolyPointNum0].y=point.y+VScrollpos;
		dc.SetROP2(mROP2);	//98/01/17
	}
	/////////////////////////Draw Line////////////////////////////////////
	if(m_bLPressed && (m_bToolBarDraw == _T("line")))
	{
		CClientDC dc(this);
		CPen pen;		pen.CreatePen(PS_DOT,1,m_Color);		dc.SelectObject(&pen);

		int mROP2 = dc.SetROP2(R2_NOTXORPEN);	//98/01/17
		dc.MoveTo(m_stLinePoint.x-HScrollpos,m_stLinePoint.y-VScrollpos);
		dc.LineTo(m_enLinePoint.x-HScrollpos,m_enLinePoint.y-VScrollpos);

		dc.MoveTo(m_stLinePoint.x-HScrollpos,m_stLinePoint.y-VScrollpos);
		dc.LineTo(point.x,point.y);
		m_enLinePoint.x=point.x+HScrollpos;
		m_enLinePoint.y=point.y+VScrollpos;
		OnCALCULATIONDistanceLine();
//		Invalidate(false);		//971020
		dc.SetROP2(mROP2);	//98/01/17
	}
	/////////////////////////Draw Box///////////////////////////////////////////////
	if(m_bLPressed && (m_bToolBarDraw == _T("box")))
	{
		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_SIZENWSE));
		CClientDC dc(this);
		CPen pen;		pen.CreatePen(PS_DOT,1,m_Color);		dc.SelectObject(&pen);

		int mROP2 = dc.SetROP2(R2_NOTXORPEN);	//98/01/17
		dc.MoveTo(m_stBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);
		dc.LineTo(m_stBoxPoint.x-HScrollpos,m_enBoxPoint.y-VScrollpos);

		dc.MoveTo(m_stBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);
		dc.LineTo(m_stBoxPoint.x-HScrollpos,point.y);

//		dc.SetROP2(R2_XORPEN);	//98/01/17
		dc.MoveTo(m_stBoxPoint.x-HScrollpos,m_enBoxPoint.y-VScrollpos);
		dc.LineTo(m_enBoxPoint.x-HScrollpos,m_enBoxPoint.y-VScrollpos);

		dc.MoveTo(m_stBoxPoint.x-HScrollpos,point.y);
		dc.LineTo(point.x,point.y);

//		dc.SetROP2(R2_XORPEN);	//98/01/17
		dc.MoveTo(m_enBoxPoint.x-HScrollpos,m_enBoxPoint.y-VScrollpos);
		dc.LineTo(m_enBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);

		dc.MoveTo(point.x,point.y);
		dc.LineTo(point.x,m_stBoxPoint.y-VScrollpos);

//		dc.SetROP2(R2_XORPEN);	//98/01/17
		dc.MoveTo(m_enBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);
		dc.LineTo(m_stBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);

		dc.MoveTo(point.x,m_stBoxPoint.y-VScrollpos);
		dc.LineTo(m_stBoxPoint.x-HScrollpos,m_stBoxPoint.y-VScrollpos);

		m_enBoxPoint.x = point.x+HScrollpos;
		m_enBoxPoint.y = point.y+VScrollpos;
//		Invalidate(false);		//971020
		dc.SetROP2(mROP2);	//98/01/17
	}
	///////////////////// StatusBAR/////////////////////////////////////
	CSMS4DCDoc* pDoc = (CSMS4DCDoc*)GetDocument();

	CString string;
	double xps=point.x+HScrollpos;
	double yps=1200.0-1.0-(point.y+VScrollpos);
	double xpm = xps + 600.0*(pDoc->TileX-1);
	double ypm = yps + 600.0*(pDoc->TileY-1);
	double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
	double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
	yUTM=yUTM-pDoc->m_Resolution_y/2.0;
	xUTM=xUTM-pDoc->m_Resolution_x/2.0;

	double z = RoundBUF_Hg(xps, yps);
	string.Format("Alt(m) : %0.0f",z );   ((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(3, string);

	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo == globeTileInfo)
	{
//		string.Format("Lat :%0.12f  , Lon: %0.12f ",yUTM,xUTM);
		char   xU,yU;		int    xUTMD,xUTMM,yUTMD,yUTMM;		double xUTMS,yUTMS;

xUTM = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(xUTM);

		DEG2DMS("LON",xUTM,&xUTMD,&xUTMM,&xUTMS,&xU);
		DEG2DMS("LAT",yUTM,&yUTMD,&yUTMM,&yUTMS,&yU);

		string.Format("Lat(%c) : %02d  %02d ' %0.3f ''",yU,yUTMD,yUTMM,yUTMS );
		((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(1, string);

		string.Format("Lon(%c) : %03d  %02d ' %0.3f ''",xU,xUTMD,xUTMM,xUTMS );
		((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(2, string);
	}
	else
	{
		string.Format("Y_UTM :%0.0f , X_UTM: %0.0f ",yUTM,xUTM  );
		CUtm m_utm;
		m_utm.x = xUTM;
		m_utm.y = yUTM;
		m_utm.UTM2philambda();

m_utm.lambda = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(m_utm.lambda);

		char   lambdaU,phiU;		int    lambdaD,lambdaM,phiD,phiM;		double lambdaS,phiS;
		DEG2DMS("LON",m_utm.lambda,&lambdaD,&lambdaM,&lambdaS,&lambdaU);
		DEG2DMS("LAT",m_utm.phi,&phiD,&phiM,&phiS,&phiU);

		string.Format("Lat(%c) : %02d  %02d ' %0.3f ''",phiU,phiD,phiM,phiS );
		((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(1, string);

		string.Format("Lon(%c) : %03d  %02d ' %0.3f ''",lambdaU,lambdaD,lambdaM,lambdaS );
		((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(2, string);

		xUTM = m_utm.lambda;	yUTM = m_utm.phi;
	}
	////////////////// Country Code ////////////////////////////////////////
//	double pi=4.0*atan(1.0);
	float RLON = (float)(xUTM*pi/180.0) , RLAT = (float)(yUTM*pi/180.0) ;
	CString cty1("");	GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

	CCode2NameCTY xx;
	CString m_name = xx.Code2Name_idwm(cty1);

	if (cty1[0]!=' ')		string.Format(_Z("Country/Region: %s(Code: %s)"),m_name,cty1);
	else					string.Format(_Z("Country/Region: Sea(Code: ---)"));
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, string);
	////////////////// Move Station ////////////////////////////////////////
	if((m_bRPressed)&&(m_bToolBarDraw == _T("movestation"))&&(m_IndexMoveST!=-999))
	{
		SetCursor(AfxGetApp()->LoadCursor(IDC_handno));
		Lat_ST[m_IndexMoveST] = yUTM;	Lon_ST[m_IndexMoveST] = xUTM;
		if(m_IndexMoveLinkTxN>0)
		for(int jj=0;jj<m_IndexMoveLinkTxN;jj++)
		{
			Lat_TxLink[m_IndexMoveLinkTx[jj]] = yUTM;		Lon_TxLink[m_IndexMoveLinkTx[jj]] = xUTM;
		}
		if(m_IndexMoveLinkRxN>0)
		for(int jj=0;jj<m_IndexMoveLinkRxN;jj++)
		{
			Lat_RxLink[m_IndexMoveLinkRx[jj]] = yUTM;		Lon_RxLink[m_IndexMoveLinkRx[jj]] = xUTM;
		}
		InvalidateRect(NULL,false);
	}
	//////////////////////////ToolTip ////////////////////////////////
	if(Num_ST>0)
	{
		long stIDfound[150], kkk=0;
		CPoint PointStFind;
		for (int i=0;i<Num_ST;i++)
		{
			LatLon2Point(Lat_ST[i],Lon_ST[i],&PointStFind);
			if(((point.x+HScrollpos)>=(PointStFind.x-m_SymbolSize))&&((point.x+HScrollpos)<=(PointStFind.x+m_SymbolSize))&&
					   ((point.y+VScrollpos)>=(PointStFind.y-m_SymbolSize))&&((point.y+VScrollpos)<=(PointStFind.y+m_SymbolSize)))
			{
				stIDfound[kkk] = i;		kkk++;
			}
		}
		if(kkk >0)
		{
			CString str=_T("") , str0=_T("") , RLATx,RLONx,frq,hagl,power,sttp, emission;
			for(long jj=0;jj<kkk;jj++)
			{
				hagl = GetFld(m_STinfo[stIDfound[jj]],1);
				frq = GetFld(m_STinfo[stIDfound[jj]],2);
				power = GetFld(m_STinfo[stIDfound[jj]],3);
				sttp = GetFld(m_STinfo[stIDfound[jj]],4);
				emission = GetFld(m_STinfo[stIDfound[jj]],5);

				Rad2Str(Lon_ST[stIDfound[jj]]*pi/180.0,Lat_ST[stIDfound[jj]]*pi/180.0, &RLONx,&RLATx);
				str0.Format(_Z("\r----------------------------\nStation Name : %s\nLocation : %s  %s\nTx Frequency : %s MHz\nHeight_AGL : %s m\nPower : %s W(eirp)\nClass of Station : %s\nEmission : %s"),Name_ST[stIDfound[jj]],RLATx,RLONx,frq,hagl,power,sttp, emission);
				str=str+str0;
			}
			str.Delete(0,30);
			m_pToolTip->AddTool(this,str);
			m_pToolTip->Activate(TRUE);
		}
		else
			m_pToolTip->Activate(FALSE);
	}
	if(Num_EST>0)
	{
		long stESIDfound[150] , kkk=0;
		CPoint PointStFind;
		for (int i=0;i<Num_EST;i++)
		{
			LatLon2Point(Lat_EST[i],Lon_EST[i],&PointStFind);
			if(((point.x+HScrollpos)>=(PointStFind.x-m_SymbolSize))&&((point.x+HScrollpos)<=(PointStFind.x+m_SymbolSize))&&
					   ((point.y+VScrollpos)>=(PointStFind.y-m_SymbolSize))&&((point.y+VScrollpos)<=(PointStFind.y+m_SymbolSize)))
			{
				stESIDfound[kkk] = i;	kkk++;
			}
		}
		if(kkk >0)
		{
			CString str=_T("") , str0=_T("") , RLATx,RLONx,SAT_name;
			for(long jj=0;jj<kkk;jj++)
			{
				SAT_name = GetFld(m_ESTinfo[stESIDfound[jj]],1);

				Rad2Str(Lon_EST[stESIDfound[jj]]*pi/180.0,Lat_EST[stESIDfound[jj]]*pi/180.0, &RLONx,&RLATx);

				str0.Format(_Z("\r----------------------------\nES Name : %s\nNotice ID : %ld\nLocation : %s  %s\nSAT Name : %s"),Name_EST[stESIDfound[jj]],ID_EST[stESIDfound[jj]],RLATx,RLONx,SAT_name);
				str=str+str0;
			}
			str.Delete(0,30);
			m_pToolTipES->AddTool(this,str);
			m_pToolTipES->Activate(TRUE);
		}
		else
			m_pToolTipES->Activate(FALSE);
	}
	//////////////////////////////////////////////////////////
	////////////////// Move Earth Station ////////////////////////////////////////
	if((m_bRPressed)&&(m_bToolBarDraw == _T("moveESstation"))&&(m_IndexMoveEST!=-999))
	{
		SetCursor(AfxGetApp()->LoadCursor(IDC_handno));
		Lat_EST[m_IndexMoveEST] = yUTM;		Lon_EST[m_IndexMoveEST] = xUTM;
		InvalidateRect(NULL,false);
	}
	CScrollView::OnMouseMove(nFlags, point);
}

void CSMS4DCView::OnRButtonDown(UINT nFlags, CPoint point) 
{
	m_bRPressed=true;
	m_IndexMoveST = -999;
	m_IndexMoveLinkTxN = 0;		m_IndexMoveLinkRxN = 0;
	if((Num_ST>0)&&(m_bToolBarDraw == _T("movestation")))
	{
		CPoint PointStFind;
		for (int i=0;i<Num_ST;i++)
		{
			LatLon2Point(Lat_ST[i],Lon_ST[i],&PointStFind);
			if(((point.x+HScrollpos)>=(PointStFind.x-m_SymbolSize))&&((point.x+HScrollpos)<=(PointStFind.x+m_SymbolSize))&&
					   ((point.y+VScrollpos)>=(PointStFind.y-m_SymbolSize))&&((point.y+VScrollpos)<=(PointStFind.y+m_SymbolSize)))
			{
				SetCursor(AfxGetApp()->LoadCursor(IDC_handno));
				m_IndexMoveST = i;
			}
		}
		if(m_IndexMoveST!=-999)
		{
			oldLat = Lat_ST[m_IndexMoveST];	oldLon = Lon_ST[m_IndexMoveST];
			for(int j=0;j<Num_Link;j++)
			{
				if((Lat_TxLink[j]==oldLat)&&(Lon_TxLink[j]==oldLon))
				{
					m_IndexMoveLinkTx[m_IndexMoveLinkTxN] = j;		m_IndexMoveLinkTxN++;
				}
				if((Lat_RxLink[j]==oldLat)&&(Lon_RxLink[j]==oldLon))
				{
					m_IndexMoveLinkRx[m_IndexMoveLinkRxN] = j;		m_IndexMoveLinkRxN++;
				}
			}
		}
	}
	m_IndexMoveEST = -999;
	if((Num_EST>0)&&(m_bToolBarDraw == _T("moveESstation")))
	{
		CPoint PointStFind;
		for (int i=0;i<Num_EST;i++)
		{
			LatLon2Point(Lat_EST[i],Lon_EST[i],&PointStFind);
			if(((point.x+HScrollpos)>=(PointStFind.x-m_SymbolSize))&&((point.x+HScrollpos)<=(PointStFind.x+m_SymbolSize))&&
					   ((point.y+VScrollpos)>=(PointStFind.y-m_SymbolSize))&&((point.y+VScrollpos)<=(PointStFind.y+m_SymbolSize)))
			{
				SetCursor(AfxGetApp()->LoadCursor(IDC_handno));		m_IndexMoveEST = i;
			}
		}
		if(m_IndexMoveEST!=-999)
		{
			oldLat = Lat_EST[m_IndexMoveEST];	oldLon = Lon_EST[m_IndexMoveEST];
		}
	}
	CScrollView::OnRButtonDown(nFlags, point);
}

void CSMS4DCView::OnRButtonUp(UINT nFlags, CPoint point) 
{
	if((m_bToolBarDraw == _T("movestation"))&&(m_IndexMoveST!=-999))
	{
			int yy = MessageBox(_Z("Site location is going to be changed.\rThe old location will be lost if you choose 'Yes' button.\r\rDo you want to save the new location?"), _Z("Warning!!!"), MB_ICONQUESTION | MB_YESNO);
			if(yy==6)
			{
				if((m_bRPressed)&&(m_bToolBarDraw == _T("movestation"))&&(m_IndexMoveST!=-999))
				{
					m_bRPressed = false;

					CDatabase m_mydb;
					CString  SQL,STTP,SQL2 , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
					m_mydb.Open(_T(m_DB),false,false, _T("ODBC;"), false);
					CRecordset RS;
					RS.m_pDatabase=&m_mydb;
		//			SQL.Format(_T("Select STTP from sttable where idst=%ld"),ID_ST[m_IndexMoveST]);
					SQL.Format(_T("Select STTP from %s where idst=%ld"), m_qSTtable , ID_ST[m_IndexMoveST]);
					RS.Open(CRecordset::snapshot,SQL);
					RS.GetFieldValue(_T("STTP"),STTP);
					RS.Close();
//					if(STTP==_T("FX") || STTP==_T("FB"))					//1400/04/20
					if(STTP==_T("FX") || STTP==_T("FB") || STTP==_T("__"))
					{
						SQL.Format(_T("Update Station,equipment,frequency set geolat=%lf, geolon=%lf where "),Lat_ST[m_IndexMoveST],Lon_ST[m_IndexMoveST]);
						SQL2=SQL;
						SQL.Format(_T("station.stid=equipment.stid and equipment.eqid=frequency.eqid and frequency.freqid=%ld"),ID_ST[m_IndexMoveST]);
						SQL2+=SQL;
					}
					if(STTP==_T("BC") || STTP==_T("BT"))
					{
						SQL.Format(_T("Update BCStation,equipment,frequency set geolat=%lf, geolon=%lf where "),Lat_ST[m_IndexMoveST],Lon_ST[m_IndexMoveST]);
						SQL2=SQL;
						SQL.Format(_T("BCstation.stid=equipment.bcid and equipment.eqid=frequency.eqid and frequency.freqid=%ld"),ID_ST[m_IndexMoveST]);
						SQL2+=SQL;
					}
					if(STTP==_T("ML"))
					{
						SQL.Format(_T("Update Mobiles,equipment,frequency set geolat=%lf, geolon=%lf where "),Lat_ST[m_IndexMoveST],Lon_ST[m_IndexMoveST]);
						SQL2=SQL;
						SQL.Format(_T("Mobiles.Mobid=equipment.Mobid and equipment.eqid=frequency.eqid and frequency.freqid=%ld"),ID_ST[m_IndexMoveST]);
						SQL2+=SQL;
					}
					m_mydb.ExecuteSQL(SQL2);
					m_mydb.Close();
				}
			}
			else
			{
				Lat_ST[m_IndexMoveST] = oldLat;			Lon_ST[m_IndexMoveST] = oldLon;

				if(m_IndexMoveLinkTxN>0)
				for(int jj=0;jj<m_IndexMoveLinkTxN;jj++)
				{
					Lat_TxLink[m_IndexMoveLinkTx[jj]] = oldLat;		Lon_TxLink[m_IndexMoveLinkTx[jj]] = oldLon;
				}
				if(m_IndexMoveLinkRxN>0)
				for(int jj=0;jj<m_IndexMoveLinkRxN;jj++)
				{
					Lat_RxLink[m_IndexMoveLinkRx[jj]] = oldLat;		Lon_RxLink[m_IndexMoveLinkRx[jj]] = oldLon;
				}
				InvalidateRect(NULL,false);
			}
			m_bRPressed = false;
	}
	if((m_bToolBarDraw == _T("moveESstation"))&&(m_IndexMoveEST!=-999))
	{
			int yy = MessageBox(_Z("Site location is going to be changed.\rThe old location will be lost if you choose 'Yes' button.\r\rDo you want to save the new location?"), _Z("Warning!!!"), MB_ICONQUESTION | MB_YESNO);
			if(yy==6)
			{
				if((m_bRPressed)&&(m_bToolBarDraw == _T("moveESstation"))&&(m_IndexMoveEST!=-999))
				{
					m_bRPressed = false;

					char   xU,yU;
					int    xUTMD,xUTMM,yUTMD,yUTMM;
					double xUTMS,yUTMS;
					DEG2DMS("LON",Lon_EST[m_IndexMoveEST],&xUTMD,&xUTMM,&xUTMS,&xU);
					DEG2DMS("LAT",Lat_EST[m_IndexMoveEST],&yUTMD,&yUTMM,&yUTMS,&yU);

					CString m_DB, SQL,SQL2;
					CDatabase m_mydb;

					m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
					m_mydb.Open(_T(m_DB),false,false, _T("ODBC;"), false);
					SQL.Format(_T("Update e_stn SET lat_deg=%d,lat_ns='%c',lat_min=%d,lat_sec=%d, long_deg=%d,long_ew='%c',long_min=%d,long_sec=%d, lat_dec=%lf, long_dec=%lf where "),  yUTMD,yU,yUTMM,(int)yUTMS,  xUTMD,xU,xUTMM,(int)xUTMS,  Lat_EST[m_IndexMoveEST],Lon_EST[m_IndexMoveEST]);
					SQL2=SQL;
					SQL.Format(_T("ntc_id=%ld"),ID_EST[m_IndexMoveEST]);
					SQL2+=SQL;
					
					m_mydb.ExecuteSQL(SQL2);
					m_mydb.Close();
				}
			}
			else
			{
				Lat_EST[m_IndexMoveEST] = oldLat;		Lon_EST[m_IndexMoveEST] = oldLon;
				InvalidateRect(NULL,false);
			}
			m_bRPressed = false;
	}
	CScrollView::OnRButtonUp(nFlags, point);
}

void CSMS4DCView::OnHScroll(UINT nSBCode, UINT nPos, CScrollBar* pScrollBar) 
{
	HScrollpos = GetScrollPos(SB_HORZ);	
	CScrollView::OnHScroll(nSBCode, nPos, pScrollBar);
}
void CSMS4DCView::OnVScroll(UINT nSBCode, UINT nPos, CScrollBar* pScrollBar) 
{
	VScrollpos = GetScrollPos(SB_VERT);	
	CScrollView::OnVScroll(nSBCode, nPos, pScrollBar);
}

void CSMS4DCView::DEG2DMS(CString type,double x,int *xD,int *xM,double *xS,char *xU) 
{
	if (x < 0)
	{
		x=-x;
		if (type=="LON")	xU[0] = 'W';
		else				xU[0] = 'S';
	}
	else
	{
		if (type=="LON")	xU[0] = 'E';
		else				xU[0] = 'N';
	}
	*xD = (int)x;
	double xM0 = 60*(x-(*xD));
	*xM = (int)xM0;
	*xS = 60*(xM0-(*xM));
	if (*xS>=59.999)
	{
		*xM = *xM+1;	*xS = 0.0;
		if (*xM>=60)	{*xD = *xD+1;	*xM = 0;}
	}
}

void CSMS4DCView::OnLButtonDblClk(UINT nFlags, CPoint point) 
{
	m_bToolBarDraw = _T("arrow");
	m_PolyPoint[m_PolyPointNum0] = m_PolyPoint[0];
	m_PolyPointNum = m_PolyPointNum0;
	m_bLPressedP = false;	m_PolyPointNum0 = 0;
	InvalidateRect(NULL,false);
	CScrollView::OnLButtonDblClk(nFlags, point);
}

void CSMS4DCView::OnLButtonDown(UINT nFlags, CPoint point) 
{
	if (m_bToolBarDraw == _T("addESstation"))
	{
		double Lat1,Lon1;CPoint point1;
		point1.x = point.x + HScrollpos;		point1.y = point.y + VScrollpos;
		Point2LatLon(point1,&Lat1,&Lon1);

		CString strLat,strLon;
		strLat.Format("%0.6f",Lat1);		strLon.Format("%0.6f",Lon1);
		Lat1 = atof(strLat);				Lon1 = atof(strLon);
		OnAddESStationFUC(Lat1,Lon1);
		m_bToolBarDraw=_T("arrow");
		InvalidateRect(NULL,false);
	}
	if (m_bToolBarDraw == _T("addstation"))
	{
		double Lat1,Lon1;CPoint point1;
		point1.x = point.x + HScrollpos;		point1.y = point.y + VScrollpos;
		Point2LatLon(point1,&Lat1,&Lon1);

		CString strLat,strLon;
		strLat.Format("%0.6f",Lat1);		strLon.Format("%0.6f",Lon1);
		Lat1 = atof(strLat);				Lon1 = atof(strLon);
		OnAddStationFUC(Lat1,Lon1);
		m_bToolBarDraw = _T("arrow");
		InvalidateRect(NULL,false);
	}
	if (m_bToolBarDraw == _T("polygon"))
	{
		m_PolyPoint[m_PolyPointNum0].x = point.x + HScrollpos;
		m_PolyPoint[m_PolyPointNum0].y = point.y + VScrollpos;
		m_PolyPointNum0 = m_PolyPointNum0 + 1;
		m_PolyPoint[m_PolyPointNum0].x = point.x + HScrollpos;
		m_PolyPoint[m_PolyPointNum0].y = point.y + VScrollpos;
		m_PolyPointNum = m_PolyPointNum0;
		InvalidateRect(NULL,false);
		m_bLPressedP = false;
	}
	if (m_bToolBarDraw == _T("line"))
	{
		InvalidateRect(NULL,false);
		m_stLinePoint.x = point.x + HScrollpos;		m_stLinePoint.y = point.y + VScrollpos;
		m_enLinePoint.x = point.x + HScrollpos;		m_enLinePoint.y = point.y + VScrollpos;
		m_bLPressed = true;
		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_CROSS));
	}
	if (m_bToolBarDraw == _T("box"))
	{
		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_SIZENWSE));
		InvalidateRect(NULL,false);
		m_stBoxPoint.x = point.x + HScrollpos;		m_stBoxPoint.y = point.y + VScrollpos;
		m_enBoxPoint.x = point.x + HScrollpos;		m_enBoxPoint.y = point.y + VScrollpos;
		m_bLPressed = true;
	}
	CScrollView::OnLButtonDown(nFlags, point);
}
void CSMS4DCView::OnLButtonUp(UINT nFlags, CPoint point) 
{
	m_bLPressed = false;	m_bLPressedP = true;
	SetBoxCorner();
	InvalidateRect(NULL,false);//97/10/29
	CScrollView::OnLButtonUp(nFlags, point);
}

void CSMS4DCView::OnArrow()		{	m_bToolBarDraw=_T("arrow");}
void CSMS4DCView::OnDrawLine()	{	m_bToolBarDraw=_T("line");}
void CSMS4DCView::OnUpdateDrawLine(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck( m_bToolBarDraw == _T("line") ? 1 : 0 );
}
void CSMS4DCView::OnDrawPolygon() {	m_bToolBarDraw=_T("polygon");}
void CSMS4DCView::OnUpdateDrawPolygon(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck( m_bToolBarDraw == _T("polygon") ? 1 : 0 );
}
void CSMS4DCView::OnDrawBox() {	m_bToolBarDraw=_T("box");	}
void CSMS4DCView::OnUpdateDrawBox(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck( m_bToolBarDraw == _T("box") ? 1 : 0 );	
}
void CSMS4DCView::OnDrawProfile() 
{
	((CSMS4DCApp *)AfxGetApp())->m_pView = this;

	m_bToolBarDraw = _T("profile");
	DrawProfile(false) ;
}
void CSMS4DCView::OnUpdateDrawProfile(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );
}

void CSMS4DCView::OnProfileFresnelzone() 
{
	((CSMS4DCApp *)AfxGetApp())->m_pView = this;

	m_bToolBarDraw = _T("profile");
	DrawProfile(true) ;
}
void CSMS4DCView::OnUpdateProfileFresnelzone(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );
}

void CSMS4DCView::DrawProfile(BOOL m_DrawFresnel) 
{
	if (m_stLinePoint != m_enLinePoint)
	{
		int x1 = m_stLinePoint.x , 		y1 = m_stLinePoint.y, x2 = m_enLinePoint.x, y2 = m_enLinePoint.y;
		int xabs = abs(x1 - x2),		yabs = abs(y1 - y2);
		int Np =((xabs>=yabs) ? xabs+1 : yabs+1),				m_scalfactor=16;
		Np = (Np-1) * m_scalfactor + 1;
		double Lat1,Lon1,Lat2,Lon2,lati, loni, hi, di, Hmin = 999999;
		Point2LatLon(m_stLinePoint,&Lat1,&Lon1);			Point2LatLon(m_enLinePoint,&Lat2,&Lon2);
		double Dist = Distance_km(Lat1,Lon1, Lat2,Lon2),	Az = Azimuth_Deg(Lat1,Lon1, Lat2,Lon2);
		((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Profile");
		CProfileDoc *pDocProfile=(CProfileDoc *) DocUtil::GetLastDocument("Profile");	
		pDocProfile->Np=Np;
		pDocProfile->m_di=new double[Np];
		pDocProfile->m_hi=new double[Np];
		pDocProfile->m_lati=new double[Np];
		pDocProfile->m_loni=new double[Np];
		for(int i=0;i<Np;i++)
		{
			di = double(i)*Dist/((double)(Np-1));
			reckon(Lat1,Lon1,  di , Az , &lati, &loni) ;
			hi = LatLon2Hg(lati,loni);
			pDocProfile->m_lati[i] = lati;	pDocProfile->m_loni[i] = loni;
			pDocProfile->m_di[i] = di;		pDocProfile->m_hi[i] = hi;
			Hmin = min(Hmin,hi);
		}
		pDocProfile->Hmin = Hmin;	pDocProfile->Dmin = 0;	pDocProfile->Dmax = di;
		pDocProfile->m_DrawFresnel = m_DrawFresnel;			pDocProfile->m_ReadyDoc=1;
		pDocProfile->UpdateAllViews(NULL);
	}
}

double CSMS4DCView::Distance_km(double lat1,double lon1,double lat2,double lon2) 
{
/*
	double pi=4.0*atan(1.0);
	float	lat10 = (float)(lat1*pi/180.0),	lon10 = (float)(lon1*pi/180.0),	lat20 = (float)(lat2*pi/180.0),	lon20 = (float)(lon2*pi/180.0),	rng;
	GEODSTR( &lon10, &lat10, &lon20, &lat20, &rng);
//	if(rng<56.0)	rng = GEODST3( &lon10, &lat10, &lon20, &lat20);
	return (rng);
*/
	double temp1,temp2,temp3,rng;
//	double pi = 4.0*atan(1.0);
	double R = 6371.0;
//	double R = 6373.398513241601;

	lat1 = lat1*pi/180.0;	lat2 = lat2*pi/180.0;	lon1 = lon1*pi/180.0;	lon2 = lon2*pi/180.0;
	temp1 = sin(lat1)*sin(lat2);
	temp2 = cos(lat1)*cos(lat2)*cos(lon2-lon1);
	temp3 = temp1+temp2;
	temp3 = min(1.0,max(-1.0,temp3));
	rng = acos(temp3);

	rng=R*rng;    //km
	return (rng);
}


void CSMS4DCView::OnCALCULATIONDistanceLine() 
{
	double Lat1,Lon1,Lat2,Lon2;
	Point2LatLon(m_stLinePoint,&Lat1,&Lon1);			Point2LatLon(m_enLinePoint,&Lat2,&Lon2);
	double rng = Distance_km(Lat1, Lon1, Lat2, Lon2);
	CString str;	str.Format("Dist(km) : %0.3f", rng  );
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(4, str);
}
void CSMS4DCView::OnUpdateCALCULATIONDistanceLine(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

void CSMS4DCView::OnCALCULATIONAzimuth() 
{
	double Lat1,Lon1,Lat2,Lon2;
	Point2LatLon(m_stLinePoint,&Lat1,&Lon1);			Point2LatLon(m_enLinePoint,&Lat2,&Lon2);
	double az = Azimuth_Deg(Lat1, Lon1, Lat2, Lon2);
	CString str;	str.Format(_Z("Azimuth") + " : %0.3f ", az  );
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(4, str);
}
void CSMS4DCView::OnUpdateCALCULATIONAzimuth(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

double CSMS4DCView::Azimuth_Deg(double lat1,double lon1,double lat2,double lon2) 
{
//	double pi = 4.0*atan(1.0);
	float lat10 = (float)(lat1*pi/180.0), lon10 = (float)(lon1*pi/180.0), lat20 = (float)(lat2*pi/180.0), lon20 = (float)(lon2*pi/180.0),	RDIST, RAZIM;
	GEOPPDA( &lon10 ,&lat10, &lon20,&lat20, &RDIST, &RAZIM);
	return RAZIM;
}

void CSMS4DCView::OnProFreeLine() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CLoSDLG Linedlg;
		Linedlg.m_title = _Z("Free Space Model Parameters");
		if (Linedlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			long x1=m_stLinePoint.x, y1=m_stLinePoint.y, x2=m_enLinePoint.x, y2=m_enLinePoint.y;
			long xabs=abs(x1-x2),	 yabs=abs(y1-y2);
			int Np =((xabs>=yabs) ? xabs+1 : yabs+1),			m_scalfactor = 16;
			Np = (Np-1) * m_scalfactor + 1;

			double Lat1,Lon1,Lat2,Lon2,lati, loni, hi, di;
			Point2LatLon(m_stLinePoint,&Lat1,&Lon1);			Point2LatLon(m_enLinePoint,&Lat2,&Lon2);
			double Dist = Distance_km(Lat1,Lon1, Lat2,Lon2),	Az = Azimuth_Deg(Lat1,Lon1, Lat2,Lon2);
			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Line Calculation (Free Space)");
			CPro_Free_LineDoc *pDocLine=(CPro_Free_LineDoc *) DocUtil::GetLastDocument("Line Calculation (Free Space)");	
			pDocLine->Np = Np;
			pDocLine->m_di=new double[Np];
			pDocLine->m_hi=new double[Np];
			pDocLine->m_lati=new double[Np];
			pDocLine->m_loni=new double[Np];
			for (int i=0;i<Np;i++)
			{
				di = double(i)*Dist/((double)(Np-1));
				reckon(Lat1,Lon1,  di , Az , &lati, &loni) ;
				hi = LatLon2Hg(lati,loni);
				pDocLine->m_lati[i] = lati;			pDocLine->m_loni[i] = loni;
				pDocLine->m_di[i] = di;				pDocLine->m_hi[i] = hi;
			}
			pDocLine->Dmin = 0;
			pDocLine->Dmax = di;
			pDocLine->Linek=Linedlg.m_kfactor;
			pDocLine->LineRxH=Linedlg.m_RxH;
			pDocLine->LineName_ST = GetFld(m_Sel,2);
			pDocLine->Linelat_ST  = atof(GetFld(m_Sel,3));
			pDocLine->Linelon_ST  = atof(GetFld(m_Sel,4));
			pDocLine->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocLine->LinePtGt_ST  = atof(GetFld(m_Sel,7));
			pDocLine->LineAZ_ST = atof(GetFld(m_Sel,8));
			pDocLine->LineEL_ST = atof(GetFld(m_Sel,9));
			pDocLine->LineANT_ST = GetFld(m_Sel,14);
			pDocLine->LineHasl_ST = LatLon2Hg(atof(GetFld(m_Sel,3)),atof(GetFld(m_Sel,4)));
			pDocLine->m_ReadyDoc=1;
			pDocLine->GetData();
			pDocLine->UpdateAllViews(NULL);
		}
	}
}
void CSMS4DCView::OnUpdateProFreeLine(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

void CSMS4DCView::OnProFreeArea() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		double Lat1, Lon1,Lat2, Lon2,Latst, Lonst;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);	Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
		CString Namest=GetFld(m_Sel,2);
		Latst=atof(GetFld(m_Sel,3));	Lonst=atof(GetFld(m_Sel,4));

//		if( (Latst>=min(Lat1,Lat2)) && (Latst<=max(Lat1,Lat2)) && (Lonst>=min(Lon1,Lon2)) && (Lonst<=max(Lon1,Lon2)) )
		if(PointInArea(Latst,Lonst, Lat1, Lon1, Lat2, Lon2))
		{
			CLoSDLG freedlg;
			freedlg.m_title = _Z("Free Space Model Parameters");
			if (freedlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);
			//	xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;		((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area Calculation (Free Space)");
				CPro_Free_AreaDoc *pDocFree=(CPro_Free_AreaDoc *) DocUtil::GetLastDocument("Area Calculation (Free Space)");	

				pDocFree->Freek=freedlg.m_kfactor;
				pDocFree->FreeRxH=freedlg.m_RxH;
				pDocFree->FreeName_ST = Namest;
				pDocFree->Freelat_ST  = Latst;
				pDocFree->Freelon_ST  = Lonst;
				pDocFree->FreeHagl_ST = atof(GetFld(m_Sel,5));
				pDocFree->FreePtGt_ST = atof(GetFld(m_Sel,7));
				pDocFree->FreeAZ_ST = atof(GetFld(m_Sel,8));
				pDocFree->FreeEL_ST = atof(GetFld(m_Sel,9));
				pDocFree->FreeANT_ST = GetFld(m_Sel,14);
				pDocFree->bufAreaW = xN;
				pDocFree->bufAreaH = yN;
				pDocFree->bufAreaFree = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*	//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocFree->TileInfo=pDoc->TileInfo;
				pDocFree->Freelat0 = yUTM;
				pDocFree->Freelon0 = xUTM;
*/
pDocFree->Freelat0   = min(Lat1, Lat2);	pDocFree->Freelon0   = min(Lon1, Lon2);
pDocFree->Freelatmax = max(Lat1, Lat2);	pDocFree->Freelonmax = max(Lon1, Lon2);

				pDocFree->m_Resolution_x = pDoc->m_Resolution_x;
				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocFree->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocFree->TileX = pDoc->TileX;
				pDocFree->m_ReadyDoc=1;
				pDocFree->GetData();
				pDocFree->UpdateAllViews(NULL);
			}//freedlg
		}
		else
		{
			CString nst;
			nst.Format(_Z("The selected station '' %s ''  is not inside the selected area."),Namest);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
	///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdateProFreeArea(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

long CSMS4DCView::Round(double x) 
{
	long y;
	long x1 = (int) x;
	if(x>=0)	{long x2 = x1+1;		y = ( (x > ((double)x1)+0.45) ? x2 : x1);}
	else		{long x2 = x1-1;		y = ( (x > ((double)x2)+0.45) ? x1 : x2);}
	return y;
}

void CSMS4DCView::OnCalculationEffectiveheigth() 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

	CDataBaseLDLG xx;
	if (xx.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		if (m_Sel!="")
		{
			long ID1  = atol(GetFld(m_Sel,1));
			CString Name_ST1 = GetFld(m_Sel,2);
			double Lat_ST1  = atof(GetFld(m_Sel,3)), Lon_ST1  = atof(GetFld(m_Sel,4)), Hagl_ST = atof(GetFld(m_Sel,5));
			OnDatabaseStationsindesktop(ID1,Name_ST1,Lat_ST1,Lon_ST1);

			double latC =0.0   ,   lonC =0.0;
			CPoint stPoint_Heff,enPoint_Heff;

			reckon(Lat_ST1,Lon_ST1, sqrt(2.0)*22.0,  45.0, &latC, &lonC);	LatLon2Point(latC,lonC, &enPoint_Heff);
			reckon(Lat_ST1,Lon_ST1, sqrt(2.0)*22.0, 225.0, &latC, &lonC);	LatLon2Point(latC,lonC, &stPoint_Heff);

			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
			{
				CUtm m_utm;
				m_utm.phi=latC;
				m_utm.lambda=lonC;
				m_utm.philambda2UTM();
				latC=m_utm.y;
				lonC=m_utm.x;
			}
			int yst=1200-1-stPoint_Heff.y;		int yen=1200-1-enPoint_Heff.y;
			int xst=stPoint_Heff.x;				int xen=enPoint_Heff.x;
			int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
			int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
			xN=4*(xN/4);		//xNmin=4*(xNmin/4);
			xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

			((CSMS4DCApp *)AfxGetApp())->xN = xN;		((CSMS4DCApp *)AfxGetApp())->yN = yN;
			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Effective Height");
			CEffectiveHeigthDoc *pDocHeff=(CEffectiveHeigthDoc *) DocUtil::GetLastDocument("Effective Height");	

			pDocHeff->TileInfo = pDoc->TileInfo;
			pDocHeff->bufAreaHeff_lat0 = latC;
			pDocHeff->bufAreaHeff_lon0 = lonC;
			pDocHeff->bufAreaHeff_lat_ST = Lat_ST1;
			pDocHeff->bufAreaHeff_lon_ST = Lon_ST1;
			pDocHeff->bufAreaHeff_Hagl_ST = Hagl_ST;
			pDocHeff->m_Resolution_x = pDoc->m_Resolution_x;
			pDocHeff->bufAreaHeff_Name_ST = Name_ST1;
			pDocHeff->m_W_Heff=xN;
			pDocHeff->m_H_Heff=yN;
			pDocHeff->m_ID_ST = atol(GetFld(m_Sel,1));
			pDocHeff->m_ID_Ant = atol(GetFld(m_Sel,20));

			int i;
			
	//		if (pDoc->TileInfo == globeTileInfo)		//98/01/31
			{
				pDocHeff->m_bflag = 1;
				pDocHeff->bufAreaHeff=new _int16[xN*yN];
				for ( i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocHeff->bufAreaHeff[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
			}

			double Hg = LatLon2Hg(Lat_ST1, Lon_ST1);
			pDocHeff->m_Hasl = Hg;
			for( i=0;i<360/5+1;i++)
			{
				double lat3km  , lon3km,lat15km , lon15km;
				reckon(Lat_ST1, Lon_ST1,  3.0 , i*5 , &lat3km  , &lon3km) ;
				reckon(Lat_ST1, Lon_ST1, 15.0 , i*5 , &lat15km , &lon15km) ;
				pDocHeff->m_Heff[i] = Hagl_ST + Hg - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km,120);
			}
			pDocHeff->m_ReadyDoc=1;
			pDocHeff->GetData();
		}
	}
}

void CSMS4DCView::reckon(double lat_deg,double lon_deg,double rng_km,double az_deg,double *latC_deg,double *lonC_deg) 
{
/*
	double pi=4.0*atan(1.0);
	float  lat_rad = (float)(lat_deg*pi/180.0),lon_rad = (float)(lon_deg*pi/180.0),RLON, RLAT,	 rng_km1 = (float)rng_km, az_deg1 = (float)az_deg;
	GEOPDAP( &lon_rad, &lat_rad, &rng_km1, &az_deg1, &RLON, &RLAT);
	*latC_deg = RLAT*180.0/pi;
	*lonC_deg = RLON*180.0/pi;

*/
//	double pi=4.0*atan(1.0);
	double R = 6371.0;
//	double R = 6373.398513241601;

	double rng_rad = rng_km/R;
	double az_rad  = az_deg*pi/180.0;
	double lat_rad = lat_deg*pi/180.0;
	double lon_rad = lon_deg*pi/180.0;

	double temp1  = sin(lat_rad)*cos(rng_rad);          
	double temp2  = cos(lat_rad)*sin(rng_rad)*cos(az_rad);
	double newlat = asin(temp1+temp2);

	temp1  = sin(rng_rad)*sin(az_rad);            
	temp2  = cos(lat_rad)*cos(rng_rad);
	double temp3  = sin(lat_rad)*sin(rng_rad)*cos(az_rad);
	double newlon = lon_rad + atan2(temp1,temp2-temp3);

	*latC_deg=newlat*180.0/pi;
	*lonC_deg=newlon*180.0/pi;
}

void CSMS4DCView::LatLon2Point(double lat_deg,double lon_deg,CPoint *PointSt) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument();
	double x_en,y_en;

	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo == globeTileInfo)
	{
lon_deg = ((CSMS4DCApp *)AfxGetApp())->ChangeLon(lon_deg,pDoc->TileX);
		y_en = lat_deg + pDoc->m_Resolution_y/2.0;
		x_en = lon_deg + pDoc->m_Resolution_x/2.0;
	}
	else
	{
		CUtm m_utm;
		m_utm.phi = lat_deg;
		m_utm.lambda = lon_deg;
		m_utm.philambda2UTM();
		double yUTM = m_utm.y;
		double xUTM = m_utm.x;
		y_en = yUTM + pDoc->m_Resolution_y/2.0;
		x_en = xUTM + pDoc->m_Resolution_x/2.0;
	}
	double ypm= 1.0+(y_en - pDoc->m_Lower_left_y)/ pDoc->m_Resolution_y;
	double xpm= 1.0+(x_en - pDoc->m_Lower_left_x)/ pDoc->m_Resolution_x;
	double yps = ypm - 600.0*(pDoc->TileY-1);
	double xps = xpm - 600.0*(pDoc->TileX-1);

	(*PointSt).x = Round(xps);
	(*PointSt).y = Round(1200.0-1.0-yps);
	(*PointSt).x = m_x1+(m_x2-m_x1)*((*PointSt).x)/(1200.0-1.0);
	(*PointSt).y = m_y1+(m_y2-m_y1)*((*PointSt).y)/(1200.0-1.0);
}
/*
void CSMS4DCView::OnToolsNormalize() 
{
	CSMS4DCDoc* pDoc = (CSMS4DCDoc*)GetDocument();
	CNormalizeDLG xx;
	xx.m_MinValue2 = pDoc->bufMin;
	xx.m_MaxValue2 = pDoc->bufMax;
	xx.m_MinValue = m_MinValue;
	xx.m_MaxValue = m_MaxValue;
	if (xx.DoModal()==IDOK)
	{
		m_MinValue = xx.m_MinValue;
		m_MaxValue = xx.m_MaxValue;
	//	if(m_pLegendDLGModeless)
		InvalidateLegend();	//97/12/26	
		Invalidate();
	}
}
*/
void CSMS4DCView::OnToolsGrid() 
{
	m_MenuBarGrid=(m_MenuBarGrid ? 0 : 1 );
	InvalidateRect(NULL,false);
}
void CSMS4DCView::OnUpdateToolsGrid(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck( m_MenuBarGrid );
}

void CSMS4DCView::OnToolsGridstep() 
{
	CGridStepDLG xx;	xx.m_GridStep = m_GridStep;
	if (xx.DoModal()==IDOK)
	{
		m_GridStep=xx.m_GridStep;	InvalidateRect(NULL,false);
	}
}
void CSMS4DCView::OnUpdateToolsGridstep(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable( m_MenuBarGrid );
}

CString CSMS4DCView::GetFld(CString Src,int N)
{
	CString Fld = _T("");
	int place = 0,Cnt = 0;
	while( place <= Src.GetLength())
	{
		Fld = _T("");
		for(int j = place ; j<=Src.GetLength();j++)
		{
			if(Src.Mid(j, 1) == _T(",")) break;
			Fld = Fld + Src.Mid(j, 1);
		}
		Cnt++;
		place = j + 1;
		if(Cnt==N) break;
	}
	return Fld;
}

void CSMS4DCView::DrawSymboleStation(CDC* pDC,double lats,double lons,COLORREF color1,int len1) 
{
	CPen penStation(PS_SOLID,1,color1);	CPen *Oldpen=pDC->SelectObject(&penStation);
	CBrush brushStation(color1);		CBrush *Oldbrush=pDC->SelectObject(&brushStation);

	CPoint points;
	LatLon2Point(lats,lons,&points);
	pDC->MoveTo(points.x-len1,points.y);	pDC->LineTo(points.x+len1,points.y);
	pDC->MoveTo(points.x,points.y-3*len1);	pDC->LineTo(points.x,points.y+3*len1);

	pDC->MoveTo(points.x-len1,points.y-len1);
	pDC->LineTo(points.x+len1,points.y-len1);	pDC->LineTo(points.x+len1,points.y+len1);
	pDC->LineTo(points.x-len1,points.y+len1);	pDC->LineTo(points.x-len1,points.y-len1);

	CPoint pointsBT[5];
	pointsBT[0]=CPoint(points.x-len1,points.y+len1);
	pointsBT[1]=CPoint(points.x+len1,points.y+len1);
	pointsBT[2]=CPoint(points.x+3*len1,points.y+3*len1);
	pointsBT[3]=CPoint(points.x-3*len1,points.y+3*len1);
	pointsBT[4]=pointsBT[0];
	pDC->Polygon(pointsBT,5);
	if(!pDC->IsPrinting())
	{
		pDC->SelectObject(&Oldpen);		pDC->SelectObject(&Oldbrush);
	}
}

void CSMS4DCView::OnDatabaseDisplayselectedstations() 
{
	CDataBaseLDLG dbdlg;
	if ((dbdlg.DoModal()) == IDOK)
	{
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			double lat1,lon1;			CString name1 , m_Sel;			long ID;
			for (int i=0;i<Nrow;i++)
			{
				m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				if (m_Sel.GetLength()>0)
				{
					ID = atol(GetFld(m_Sel,1)); name1 = GetFld(m_Sel,2); lat1 = atof(GetFld(m_Sel,3)); lon1 = atof(GetFld(m_Sel,4));
					AddStation_disp(ID,lat1,lon1,name1) ;
				}
			}
			InvalidateRect(NULL,false);
		}
	}
}

void CSMS4DCView::TextDraw(CDC* pDC,int x, int y,CString str,COLORREF FontColor,int Escapement,
							int nHeight,int nWidth,int FontWeight,CString FontName) 
{
/*
	pDC->SetBkMode(TRANSPARENT);
	CFont font;
	VERIFY(font.CreateFont(
	   nHeight,                   // nHeight
	   nWidth,                    // nWidth
	   Escapement,                // nEscapement
	   0,                         // nOrientation
	   FontWeight,                // nWeight
	   FALSE,                     // bItalic
	   FALSE,                     // bUnderline
	   0,                         // cStrikeOut
	   DEFAULT_CHARSET,           // nCharSet
	   OUT_DEFAULT_PRECIS,        // nOutPrecision
	   CLIP_DEFAULT_PRECIS,       // nClipPrecision
	   DEFAULT_QUALITY,           // nQuality
	   DEFAULT_PITCH | FF_SWISS,  // nPitchAndFamily
	   FontName));                // lpszFacename
	CFont* def_font = pDC->SelectObject(&font);
	pDC->SetTextColor(FontColor);
	pDC->TextOut(x,y, _T(str));
	pDC->SelectObject(def_font);
	font.DeleteObject(); 
*/
	pDC->SetBkMode(TRANSPARENT);
	CFont font;	LOGFONT lf;
	memset(&lf, 0, sizeof(LOGFONT));		// zero out structure
	lf.lfHeight  = nHeight;					// request a 12-pixel-height font
	lf.lfWidth   = nWidth;
	lf.lfWeight  = FontWeight;
	lf.lfCharSet = DEFAULT_CHARSET;			//971211
	strcpy(lf.lfFaceName, _T(FontName));	// request a face name "Arial"
	lf.lfEscapement = Escapement;
	VERIFY(font.CreateFontIndirect(&lf));  // create the font
	CFont* def_font = pDC->SelectObject(&font);
	pDC->SetTextColor(FontColor);
	pDC->TextOut(x,y, _T(str));
	pDC->SelectObject(def_font);
	font.DeleteObject(); 
}

void CSMS4DCView::OnDatabaseStationsindesktop() 
{
	CDataBaseLDLG dbdlg;
	if ((dbdlg.DoModal()) == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;	//950909
		if(Nrow<=0)		return;							//950909

		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
		/////////////////////////////////////////////////
		double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
		Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);		Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);
		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);	Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);
		double *latp;	latp=new double[m_PolyPointNum+1];
		double *lonp;	lonp=new double[m_PolyPointNum+1];
		double lat01,lon01;
		for (int k=0;k<m_PolyPointNum+1;k++)
		{
			Point2LatLon(m_PolyPoint[k],&lat01,&lon01);
			latp[k]=lat01;	lonp[k]=lon01;
		}
/*
		double *latcr;	latcr=new double[73];
		double *loncr;	loncr=new double[73];
		for ( k=0;k<73;k++)
		{
			Point2LatLon(m_Point_STcr[k],&lat01,&lon01);	latcr[k]=lat01;	loncr[k]=lon01;
		}
*/
		/////////////////////////////////////////////////
		CString m_Sel,name1;
		int Tx=1000,Ty=1000;
		double lat1,lon1,ix,jy;
//		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;		//950909
		long ID1;
		for (int i=0;i<Nrow;i++)
		{
			m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
			ID1  = atol(GetFld(m_Sel,1)); name1 = GetFld(m_Sel,2); lat1  = atof(GetFld(m_Sel,3)); lon1  = atof(GetFld(m_Sel,4));
			AddStation_disp(ID1,lat1,lon1,name1);
			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
			{
				CUtm m_utm;
				m_utm.phi = lat1;
				m_utm.lambda = lon1;
				m_utm.philambda2UTM();
				lat1 = m_utm.y;
				lon1 = m_utm.x;
			}
			ix = (lon1 - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
			jy = (lat1 - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);

	//		Tx = min(Tx, 1+(int) ix);			Ty = min(Ty, 1+(int) jy);
			Tx = ((ix-(int)ix)>=0.5) ? ((int)ix+1) : ((int)ix);
			Ty = ((jy-(int)jy)>=0.5) ? ((int)jy+1) : ((int)jy);
		}
	//	if ( !(( Tx==pDoc->TileX || Tx==1+pDoc->TileX )	&& ( Ty==pDoc->TileY || Ty==1+pDoc->TileY )) )
		if ( !(( Tx==pDoc->TileX) && (Ty==pDoc->TileY )) )
		{
			pDoc->TileX=Tx;			pDoc->TileY=Ty;			pDoc->GetData();
		}
		///////////////////////////////////////////////////////
		LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);		LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
		LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);	LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);

		for ( k=0;k<m_PolyPointNum+1;k++)		LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
		delete [] latp;		delete [] lonp;
//		for ( k=0;k<73;k++)		LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//		delete [] latcr;		delete [] loncr;
		///////////////////////////////////////////////////////
		UpDate_hBitmap(pDoc);
		InvalidateRect(NULL,false);
	}	
}

int CSMS4DCView::OnDatabaseStationsindesktop1() 
{
	CDataBaseLDLG dbdlg;
	dbdlg.m_Title = _T("Select Two Stations");
	int xxDLG = dbdlg.DoModal();
	if (xxDLG == IDOK)
	{
		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
		/////////////////////////////////////////////////
		double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
		Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);		Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);
		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);	Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);
		double *latp;	latp=new double[m_PolyPointNum+1];
		double *lonp;	lonp=new double[m_PolyPointNum+1];
		double lat01,lon01;
		for (int k=0;k<m_PolyPointNum+1;k++)
		{
			Point2LatLon(m_PolyPoint[k],&lat01,&lon01);
			latp[k]=lat01;	lonp[k]=lon01;
		}
/*
		double *latcr;	latcr=new double[73];
		double *loncr;	loncr=new double[73];
		for ( k=0;k<73;k++)
		{
			Point2LatLon(m_Point_STcr[k],&lat01,&lon01);
			latcr[k]=lat01;	loncr[k]=lon01;
		}
*/
		/////////////////////////////////////////////////
		CString m_Sel,name1;
		int Nrow,Tx=1000,Ty=1000;
		double lat1,lon1,ix,jy;
		Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		long ID1;
		for (int i=0;i<Nrow;i++)
		{
			m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
			ID1  = atol(GetFld(m_Sel,1)); name1 = GetFld(m_Sel,2); lat1  = atof(GetFld(m_Sel,3)); lon1  = atof(GetFld(m_Sel,4));
			AddStation_disp(ID1,lat1,lon1,name1);
			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
			{
				CUtm m_utm;
				m_utm.phi = lat1;
				m_utm.lambda = lon1;
				m_utm.philambda2UTM();
				lat1 = m_utm.y;
				lon1 = m_utm.x;
			}
			ix = (lon1 - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
			jy = (lat1 - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);
	//		Tx = min(Tx, 1+(int) ix);			Ty = min(Ty, 1+(int) jy);
			Tx = ((ix-(int)ix)>=0.5) ? ((int)ix+1) : ((int)ix);
			Ty = ((jy-(int)jy)>=0.5) ? ((int)jy+1) : ((int)jy);
		}
	//	if ( !(( Tx==pDoc->TileX || Tx==1+pDoc->TileX )	&& ( Ty==pDoc->TileY || Ty==1+pDoc->TileY )) )
		if ( !(( Tx==pDoc->TileX) && (Ty==pDoc->TileY )) )
		{
			pDoc->TileX=Tx;			pDoc->TileY=Ty;			pDoc->GetData();
		}
		///////////////////////////////////////////////////////
		LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);		LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
		LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);	LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);

		for ( k=0;k<m_PolyPointNum+1;k++)	LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
		delete [] latp;		delete [] lonp;
//		for ( k=0;k<73;k++)	LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//		delete [] latcr;		delete [] loncr;
		///////////////////////////////////////////////////////
		UpDate_hBitmap(pDoc);
		InvalidateRect(NULL,false);
	}	
	return xxDLG;
}

void CSMS4DCView::OnDatabaseStationsindesktop(long ID,CString name1,double lat1,double lon1) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	/////////////////////////////////////////////////
	double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
	Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);		Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);
	double stLinelat,stLinelon,enLinelat,enLinelon;
	Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);	Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);
	double *latp;	latp=new double[m_PolyPointNum+1];
	double *lonp;	lonp=new double[m_PolyPointNum+1];
	double lat01,lon01;
	for (int k=0;k<m_PolyPointNum+1;k++)
	{
		Point2LatLon(m_PolyPoint[k],&lat01,&lon01);
		latp[k]=lat01;	lonp[k]=lon01;
	}
/*
	double *latcr;	latcr=new double[73];
	double *loncr;	loncr=new double[73];
	for ( k=0;k<73;k++)
	{
		Point2LatLon(m_Point_STcr[k],&lat01,&lon01);		latcr[k]=lat01;	loncr[k]=lon01;
	}
*/
	/////////////////////////////////////////////////
	int Tx=1000,Ty=1000;
	double ix,jy;
	AddStation_disp(ID,lat1,lon1,name1);
	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo != globeTileInfo)
	{
		CUtm m_utm;
		m_utm.phi = lat1;
		m_utm.lambda = lon1;
		m_utm.philambda2UTM();
		lat1 = m_utm.y;
		lon1 = m_utm.x;
	}
	ix = (lon1 - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
	jy = (lat1 - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);

//	Tx = min(Tx, 1+(int) ix);	Ty = min(Ty, 1+(int) jy);
	Tx = ((ix-(int)ix)>=0.5) ? ((int)ix+1) : ((int)ix);
	Ty = ((jy-(int)jy)>=0.5) ? ((int)jy+1) : ((int)jy);

//	if ( !(( Tx==pDoc->TileX || Tx==1+pDoc->TileX ) && ( Ty==pDoc->TileY || Ty==1+pDoc->TileY )) )
	if ( !(( Tx==pDoc->TileX) && (Ty==pDoc->TileY )) )
	{
		pDoc->TileX=Tx;		pDoc->TileY=Ty;		pDoc->GetData();
	}
	///////////////////////////////////////////////////////
	LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);		LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
	LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);	LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);
	for ( k=0;k<m_PolyPointNum+1;k++)	LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
	delete [] latp;	delete [] lonp;
//	for ( k=0;k<73;k++)		LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//	delete [] latcr;	delete [] loncr;
	///////////////////////////////////////////////////////
	UpDate_hBitmap(pDoc);
	InvalidateRect(NULL,false);
}

void CSMS4DCView::OnDatabaseStationsindesktop2(double lat1,double lon1) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

	int Tx = 1000,Ty = 1000;
	double ix,jy;
	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo != globeTileInfo)
	{
		CUtm m_utm;
		m_utm.phi = lat1;
		m_utm.lambda = lon1;
		m_utm.philambda2UTM();
		lat1 = m_utm.y;
		lon1 = m_utm.x;
	}
	ix = (lon1 - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
	jy = (lat1 - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);
//	Tx = min(Tx, 1+(int) ix);	Ty = min(Ty, 1+(int) jy);
	Tx = ((ix-(int)ix)>=0.5) ? ((int)ix+1) : ((int)ix);
	Ty = ((jy-(int)jy)>=0.5) ? ((int)jy+1) : ((int)jy);

//	if ( !(( Tx==pDoc->TileX || Tx==1+pDoc->TileX )	&& ( Ty==pDoc->TileY || Ty==1+pDoc->TileY )) )
	if ( !(( Tx==pDoc->TileX) && (Ty==pDoc->TileY )) )
	{
		/////////////////////////////////////////////////
		double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
		Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);			Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);
		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);		Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);
		double *latp;	latp=new double[m_PolyPointNum+1];
		double *lonp;	lonp=new double[m_PolyPointNum+1];
		double lat01,lon01;
		for (int k=0;k<m_PolyPointNum+1;k++)
		{
			Point2LatLon(m_PolyPoint[k],&lat01,&lon01);
			latp[k]=lat01;	lonp[k]=lon01;
		}
/*
		double *latcr;	latcr=new double[73];
		double *loncr;	loncr=new double[73];
		for ( k=0;k<73;k++)
		{
			Point2LatLon(m_Point_STcr[k],&lat01,&lon01);		latcr[k]=lat01;	loncr[k]=lon01;
		}
*/
		/////////////////////////////////////////////////
		pDoc->TileX = Tx;		pDoc->TileY = Ty;		pDoc->GetData();
		///////////////////////////////////////////////////////
		LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);			LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
		LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);		LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);
		for ( k=0;k<m_PolyPointNum+1;k++)		LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
		delete [] latp;		delete [] lonp;
//		for ( k=0;k<73;k++)		LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//		delete [] latcr;		delete [] loncr;
		///////////////////////////////////////////////////////
		UpDate_hBitmap(pDoc);
		InvalidateRect(NULL,false);
	}
}

void CSMS4DCView::OnDatabaseRemovestationsfromdisplay() 
{
	if (Num_ST>0)
	{
		delete [] ID_ST;	delete [] Lat_ST;	delete [] Lon_ST;	delete [] Name_ST;	delete [] m_STinfo;
		Num_ST = 0;
	}
	if (Num_Link>0)
	{
		delete [] HopID;	delete [] Lat_TxLink;	delete [] Lon_TxLink;	delete [] Lat_RxLink;	delete [] Lon_RxLink;
		Num_Link = 0;
	}
	m_bToolBarDraw = _T("");
	UpDate_hBitmap();
	InvalidateRect(NULL,false);
}

void CSMS4DCView::OnVectorsCircle() 
{
	CDataBaseLDLG dbdlg;
	if ((dbdlg.DoModal()) == IDOK)
	{
		CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		if (m_Sel!=_T(""))
		{
			double lat1,lon1;			CString name1;
			long ID1  = atol(GetFld(m_Sel,1));
			name1 = GetFld(m_Sel,2);	lat1  = atof(GetFld(m_Sel,3));	lon1 = atof(GetFld(m_Sel,4));
			OnDatabaseStationsindesktop2(lat1,lon1);
			AddStation_disp(ID1,lat1,lon1,name1) ;

			CCircleRadiusDLG crDLG;
			if (crDLG.DoModal()==IDOK)
			{
				CString sFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\") + _T("Circle.txt");
				FILE *fptemp = fopen(sFile,"wt");

				double latC,lonC;
				for (int i=0;i<73;i++)
				{
					reckon(lat1,lon1, crDLG.m_CircleRadius , i*5 , &latC , &lonC) ;
					fprintf(fptemp,"%0.14lf  %0.14lf\n",lonC, latC);
				}
				fclose(fptemp);
				OnDrawVectorCircle(sFile);
	//			if(m_CircleDraw)	m_POLYnum--;
////				m_CircleDraw = TRUE;
			//	InvalidateRect(NULL,false);
////				InvalidateVectorHandling();
				UpDate_hBitmap();
			}
		}
	}
}

void CSMS4DCView::DrawVector(CDC *pDC,CString Vector_filepath,int nWidth,COLORREF crColor, int nStyle,int nMode,COLORREF flColor,int alpha) 
{
	if (!Vector_filepath.IsEmpty())
	{
		FILE *fp;
		if ( (fp = fopen(Vector_filepath,"rt")) != NULL )
		{
			CString bf;
			char bfLon[200], bfLat[200];

			CPoint *pp;		pp = new CPoint[200000];
			DWORD *Nk;		Nk = new DWORD[100000];

			long n = 0, k = 0, k1 = 0;
			while( !feof( fp ) )
			{
				fscanf( fp, "%s %s", bfLon,bfLat);
				bf = bfLon;

				Nk[k1] = k;
				if (bf==_T("NaN"))
				{
					if(n>0)	k1++;
					k = 0;
				}
				else
				{
					LatLon2Point(atof(bfLat),atof(bfLon),&pp[n]);
					n++;	k++;
				}
			}
			fclose(fp);
			if (Nk[k1-1]==0)	k1--;
			if (bf==_T("NaN"))	k1--;

			CPen pen(nStyle, nWidth, crColor);	CPen* pOldPen = pDC->SelectObject(&pen);
			CBrush brush(flColor);				CBrush* pOldBrush = pDC->SelectObject(&brush);
			if (nMode==2)
			{
				pp[n] = pp[0];
				pDC->Polyline(pp,n+1);

				int len = 4;
				if (pDC->IsPrinting())	len = 24;
				for (long j=0;j<n;j++)
					pDC->Ellipse(pp[j].x-len, pp[j].y-len, pp[j].x+len, pp[j].y+len);
			}
			else	pDC->PolyPolyline(pp,Nk,k1+1);
			if (nMode==1)
			{
				int NewRed,NewGreen,NewBlue;	COLORREF OldCol;	CRgn rgn;
				rgn.CreatePolyPolygonRgn(pp,(int*)Nk,k1+1,WINDING );

				CRect rect;		rgn.GetRgnBox(&rect);
				if (pDC->IsPrinting())		pDC->FillRgn(&rgn,&CBrush(flColor));
				else
				{
					for(int i=rect.left;i<rect.right;i++)
						for(int j=rect.top;j<rect.bottom;j++)
						{
							if (rgn.PtInRegion(i,j))
							{
								OldCol=pDC->GetPixel(i,j);
								NewRed    =(alpha*(GetRValue(OldCol)-GetRValue(flColor)))/100+GetRValue(flColor);
								NewGreen  =(alpha*(GetGValue(OldCol)-GetGValue(flColor)))/100+GetGValue(flColor);
								NewBlue   =(alpha*(GetBValue(OldCol)-GetBValue(flColor)))/100+GetBValue(flColor);
								pDC->SetPixel(i,j,RGB(NewRed,NewGreen,NewBlue));
							}
						}
				}

			}
			pDC->SelectObject(pOldPen);			pDC->SelectObject(pOldBrush);
			delete [] pp;						delete [] Nk;
		}//if fp
	}//if (!Vector_filepath.IsEmpty())
}
/*
void CSMS4DCView::DrawVector(CDC *pDC,CString Vector_filepath,int nWidth,COLORREF crColor, int nStyle,int nMode,COLORREF flColor,int alpha) 
{
	if (!Vector_filepath.IsEmpty())
	{
		FILE *fp;
		int k = 0 , k1 = 0;
		if ( (fp = fopen(Vector_filepath,"rt")) != NULL )
		{
			CPoint *pp;		pp = new CPoint[200000];
			DWORD *Nk;		Nk = new DWORD[100000];
			CString dataLon,dataLat;
			char bfLon[200], bfLat[200];

			int n=0; k=0; k1=0;
			Nk[0] = 0;
			while( !feof( fp ) )
			{
				fscanf( fp, "%s %s", bfLon,bfLat);
				dataLon = bfLon;  dataLat = bfLat;
				if (dataLon==_T("NaN"))
				{
					k1++;	k = 0;
				}
				else
				{
					LatLon2Point(atof(dataLat),atof(dataLon),&pp[n]);
					n++;	k++;
				}
				Nk[k1] = k;
			}
			fclose(fp);

			if(Nk[k1]==0)	k1--;
			if(Nk[0]==0)
			{
				for(int j=0; j<k1; j++)		Nk[j] = Nk[j+1];
				k1--;
			}
			if(Nk[k1]==0)	k1--;

			CPen pen(nStyle, nWidth, crColor);	CPen* pOldPen = pDC->SelectObject(&pen);
			CBrush brush(flColor);				CBrush* pOldBrush = pDC->SelectObject(&brush);
	//		pDC->PolyPolyline(pp,Nk,k1+1);

			if (nMode==2)
			{
				pp[n] = pp[0];
				pDC->Polyline(pp,n+1);

				int len = 4;
				if (pDC->IsPrinting())	len = 24;
				for (long j=0;j<n;j++)
					pDC->Ellipse(pp[j].x-len, pp[j].y-len, pp[j].x+len, pp[j].y+len);
			}
			else	pDC->PolyPolyline(pp,Nk,k1+1);

			if (nMode==1)
			{
				int NewRed,NewGreen,NewBlue;	COLORREF OldCol;	CRgn rgn;
		//		rgn.CreatePolygonRgn( pp, n ,WINDING );
				rgn.CreatePolyPolygonRgn(pp,(int*)Nk,k1+1,WINDING);

				CRect rect;		rgn.GetRgnBox(&rect);
				for(int i=rect.left;i<rect.right;i++)
					for(int j=rect.top;j<rect.bottom;j++)
					{
						if (rgn.PtInRegion(i,j))
						{
							OldCol=pDC->GetPixel(i,j);
							NewRed    =(alpha*(GetRValue(OldCol)-GetRValue(flColor)))/100+GetRValue(flColor);
							NewGreen  =(alpha*(GetGValue(OldCol)-GetGValue(flColor)))/100+GetGValue(flColor);
							NewBlue   =(alpha*(GetBValue(OldCol)-GetBValue(flColor)))/100+GetBValue(flColor);
							pDC->SetPixel(i,j,RGB(NewRed,NewGreen,NewBlue));
						}
					}
			}
			pDC->SelectObject(pOldPen);			pDC->SelectObject(pOldBrush);
			delete [] pp;
			delete [] Nk;
		}//if fp
	}//if (!Vector_filepath.IsEmpty())
}
*/
/*		//Old Function
void CSMS4DCView::DrawVector(CDC *pDC,CString Vector_filepath,int nWidth,COLORREF crColor, int nStyle,int nMode,COLORREF flColor,int alpha) 
{
	if (!Vector_filepath.IsEmpty())
	{
		FILE *fp;
		int k = 0 , k1 = 0;
		if ( (fp=fopen(Vector_filepath,"rt")) != NULL )
		{
			double *data;	data = new double[200000];
			int *Nk;		Nk = new int[200000];
			CString data1;	char bf[200];
			int i=0;k=i;k1=i;
			while( !feof( fp ) )
			{
				fscanf( fp, "%s", bf);
				data1 = bf;		Nk[k1] = k;
				if (data1=="NaN")	k1++;
				else				{data[i] = atof(data1);	i++;	k=i;}
			}
			fclose(fp);
			DWORD *Mk;	Mk=new DWORD[k1/2+1];
			Mk[0]=(Nk[0]+1)/2;
			for (int j=0;j<k1/2;j++)	Mk[j+1]=(Nk[2*j+2]-Nk[2*j])/2;

			CPoint *pp;		pp = new CPoint[k/2];
			for ( i=0;i<k/2;i++)	LatLon2Point(data[2*i+1],data[2*i],&pp[i]);

			CPen pen(nStyle, nWidth, crColor);	CPen* pOldPen = pDC->SelectObject(&pen);
			CBrush brush(flColor);				CBrush* pOldBrush = pDC->SelectObject(&brush);
			pDC->PolyPolyline(pp,Mk,k1/2+1);
			if (nMode==2)
			{
				int len=4;
				if (pDC->IsPrinting())	len=24;
				for ( i=0;i<k/2;i++)	pDC->Ellipse(pp[i].x-len, pp[i].y-len, pp[i].x+len, pp[i].y+len);
			}
			if (nMode==1)
			{
				int NewRed,NewGreen,NewBlue;	COLORREF OldCol;	CRgn rgn;
		//		rgn.CreatePolygonRgn( pp, k/2 ,WINDING );
				rgn.CreatePolyPolygonRgn(pp,(int*)Mk,k1/2+1,WINDING);

				CRect rect;		rgn.GetRgnBox(&rect);
				for(int i=rect.left;i<rect.right;i++)
					for(int j=rect.top;j<rect.bottom;j++)
					{
						if (rgn.PtInRegion(i,j))
						{
							OldCol=pDC->GetPixel(i,j);
							NewRed    =(alpha*(GetRValue(OldCol)-GetRValue(flColor)))/100+GetRValue(flColor);
							NewGreen  =(alpha*(GetGValue(OldCol)-GetGValue(flColor)))/100+GetGValue(flColor);
							NewBlue   =(alpha*(GetBValue(OldCol)-GetBValue(flColor)))/100+GetBValue(flColor);
							pDC->SetPixel(i,j,RGB(NewRed,NewGreen,NewBlue));
						}
					}
			}
			pDC->SelectObject(pOldPen);			pDC->SelectObject(pOldBrush);
			delete [] data;	delete [] Nk;	delete [] Mk;	delete [] pp;
		}
	}
}
*/

void CSMS4DCView::OnDrawVector() 
{
	CString sFile, sPath;
	if(((CSMS4DCApp *)AfxGetApp())->VectorFileName( &sFile, &sPath))
	{
		if(!strCompare(sPath))
		{
			CVectorDLG Vdlg;
			Vdlg.m_TitleName = sFile;
			if (Vdlg.DoModal()== IDOK)
			{
				COLORREF crColor = RGB(Vdlg.m_LineColorRed,Vdlg.m_LineColorGreen,Vdlg.m_LineColorBlue);
				COLORREF flColor = RGB(Vdlg.m_FillColorRed,Vdlg.m_FillColorGreen,Vdlg.m_FillColorBlue);
				m_POLY[m_POLYnum].PathNameVec = sPath;
				m_POLY[m_POLYnum].FileNameVec = sFile;
				m_POLY[m_POLYnum].nWidthVec = Vdlg.m_LineWidth;
				m_POLY[m_POLYnum].crColorVec = crColor;
				m_POLY[m_POLYnum].nStyleVec = Vdlg.m_LineStyle0;
				m_POLY[m_POLYnum].nModeVec = Vdlg.m_FillMode;
				m_POLY[m_POLYnum].flColorVec = flColor;
				m_POLY[m_POLYnum].alphaVec = Vdlg.m_FillTransparancy;
				m_POLYnum = m_POLYnum+1;

				VectorDesktop(sPath);
UpDate_hBitmap();
				InvalidateVectorHandling();
			}
		}
		else
		{
			CString str;
			str.Format(_T("The vector ''%s''\t\nwas already loaded."),sPath);
			MessageBox(str,_T("Information!!!"),MB_ICONINFORMATION);
		}
	}
}


void CSMS4DCView::Vector2OnePoint(CString Vector_filepath,double *CRlat,double *CRlon) 
{
	if (!Vector_filepath.IsEmpty())
	{
		FILE *fp;
		if ( (fp = fopen(Vector_filepath,"rt")) != NULL )
		{
			CString dataLon,dataLat;
			char bfLon[200], bfLat[200];
			int n = 0;
			double lat, lon;
			while( !feof( fp ) )
			{
				fscanf( fp, "%s %s", bfLon,bfLat);
				dataLon = bfLon;  dataLat = bfLat;
				if (dataLon!=_T("NaN"))
				{
					lat = atof(dataLat);
					lon = atof(dataLon);
					n++;
					break;
				}
			}
			fclose(fp);

			*CRlat = lat;	*CRlon = lon;
	
		}//if fp
	}//if (!Vector_filepath.IsEmpty())
}

void CSMS4DCView::OnDrawVector(CString sPath,int mode) 
{
	CString sFile = sPath;
	int b = sFile.ReverseFind('\\');
	sFile.Delete(0,b+1);

	CVectorDLG Vdlg;
	Vdlg.m_TitleName = sFile;
	if (Vdlg.DoModal()== IDOK)
	{
	//	if(!strCompare(sPath))
		{
			COLORREF crColor = RGB(Vdlg.m_LineColorRed,Vdlg.m_LineColorGreen,Vdlg.m_LineColorBlue);
			COLORREF flColor = RGB(Vdlg.m_FillColorRed,Vdlg.m_FillColorGreen,Vdlg.m_FillColorBlue);
			m_POLY[m_POLYnum].PathNameVec = sPath;
			m_POLY[m_POLYnum].FileNameVec = sFile;
			m_POLY[m_POLYnum].nWidthVec = Vdlg.m_LineWidth;
			m_POLY[m_POLYnum].crColorVec = crColor;
			m_POLY[m_POLYnum].nStyleVec = Vdlg.m_LineStyle0;
			m_POLY[m_POLYnum].nModeVec = Vdlg.m_FillMode;
			if(mode==2)
				m_POLY[m_POLYnum].nModeVec = mode;
			m_POLY[m_POLYnum].flColorVec = flColor;
			m_POLY[m_POLYnum].alphaVec = Vdlg.m_FillTransparancy;
			m_POLYnum = m_POLYnum+1;

UpDate_hBitmap();
			InvalidateRect(NULL,FALSE);
			InvalidateVectorHandling();
		}
	}
}
void CSMS4DCView::OnVectorsRemovefromdisplay() 
{
	m_bToolBarDraw = _T("");
//	for (int i=0;i<73;i++)		m_Point_STcr[i] = CPoint(0,0);
//	m_stLinePoint = m_enLinePoint = m_stBoxPoint = m_enBoxPoint = CPoint(0,0);

//	for (int i=0;i<73;i++)		m_Point_STcr[i] = CPoint(-1,-1);
//	m_CircleDraw = FALSE;

	m_stLinePoint = m_enLinePoint = m_stBoxPoint = m_enBoxPoint = CPoint(-1,-1);

	m_PolyPointNum = 0;		m_POLYnum = 0;
	InvalidateVectorHandling();
UpDate_hBitmap();
	InvalidateRect(NULL,FALSE);
}

void CSMS4DCView::OnDatabaseSearchstation() 
{
	OnDatabaseRemovestationsfromdisplay();

	double Lon01,Lat01,Lon02,Lat02;
	Point2LatLon(m_stBoxPoint,&Lat01,&Lon01);	Point2LatLon(m_enBoxPoint,&Lat02,&Lon02);
//	double Lat1=min(Lat01,Lat02),	Lat2=max(Lat01,Lat02),  Lon1=min(Lon01,Lon02),	Lon2=max(Lon01,Lon02);

	CDBVariant Fld;	CDatabase m_mydb;	CRecordset m_rs;
	CString  Filter , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CString	m_Tbl;	m_Tbl.Format(  _T("select * from %s ") , m_qSTtable );
	if (m_mydb.Open(_T(m_DB),FALSE,TRUE, "ODBC;", FALSE))
	{
		m_rs.m_pDatabase=&m_mydb;
//		Filter.Format("(stlat_deg>%lf and stlat_deg<%lf and stlon_deg>%lf and stlon_deg<%lf)",Lat1,Lat2,Lon1,Lon2);
if(Lon01<=Lon02)	Filter.Format("(stlat_deg>%lf and stlat_deg<%lf and stlon_deg>%lf and stlon_deg<%lf)",Lat01,Lat02,Lon01,Lon02);
else				Filter.Format("( (stlat_deg>%lf and stlat_deg<%lf) and ((stlon_deg>%lf and stlon_deg<180) or (stlon_deg>-180 and stlon_deg<%lf)) )",Lat01,Lat02,Lon01,Lon02);

		if(m_Tbl.Find(" where ")==-1)	Filter = m_Tbl + _T(" where ") + Filter;
		else							Filter = m_Tbl + _T(" and ")   + Filter;
		m_rs.Open( CRecordset::snapshot, Filter);
		int k = 0;
		while(!m_rs.IsEOF())	{	m_rs.MoveNext();	k = k+1;	}
		if (k>0)
		{
			m_rs.MoveFirst();
			double lat1,lon1;		CString name1;		long ID1;
			for (int j=0;j<k;j++)
			{
				m_rs.GetFieldValue((short)0, Fld);		ID1   = Fld.m_lVal;
				m_rs.GetFieldValue((short)1, Fld);		name1 = *Fld.m_pstring;
				m_rs.GetFieldValue((short)2, Fld);		lat1  = Fld.m_dblVal;
				m_rs.GetFieldValue((short)3, Fld);		lon1  = Fld.m_dblVal;
				AddStation_disp(ID1,lat1,lon1,name1) ;
				m_rs.MoveNext();
			}
		}
		m_rs.Close();		m_mydb.Close();
		InvalidateRect(NULL,false);
	}
}
void CSMS4DCView::OnUpdateDatabaseSearchstation(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::Point2LatLon(CPoint point1,double *Lat1,double *Lon1) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	double xpm,ypm,xUTM,yUTM;
	double yen=1200.0-1.0-point1.y,		 xen=point1.x;
	xpm = xen + 600.0*(pDoc->TileX-1.0);
	ypm = yen + 600.0*(pDoc->TileY-1.0);
	xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
	yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
	*Lat1=yUTM-pDoc->m_Resolution_y/2.0;
	*Lon1=xUTM-pDoc->m_Resolution_x/2.0;
	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo != globeTileInfo)
	{
		CUtm m_utm;
		m_utm.y = *Lat1;		m_utm.x = *Lon1;
		m_utm.UTM2philambda();
		*Lat1=m_utm.phi;		*Lon1=m_utm.lambda;
	}
*Lon1 = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(*Lon1);
}
void CSMS4DCView::YX2LatLon(double y1,double x1,double *Lat1,double *Lon1) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	double xpm,ypm,xUTM,yUTM;
	xpm = x1 + 600.0*(pDoc->TileX-1);
	ypm = y1 + 600.0*(pDoc->TileY-1);
	xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
	yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
	*Lat1=yUTM-pDoc->m_Resolution_y/2.0;
	*Lon1=xUTM-pDoc->m_Resolution_x/2.0;
	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo != globeTileInfo)
	{
		CUtm m_utm;
		m_utm.y = *Lat1;		m_utm.x = *Lon1;
		m_utm.UTM2philambda();
		*Lat1=m_utm.phi;		*Lon1=m_utm.lambda;
	}
*Lon1 = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(*Lon1);
}

void CSMS4DCView::OnPropagationmodelsP1546Area() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int SelNUM	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(SelNUM==1)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			double Lat1, Lon1,Lat2, Lon2,Latst, Lonst;
			Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);	Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);

			CString Namest = GetFld(m_Sel,2);
			Latst = atof(GetFld(m_Sel,3));	Lonst = atof(GetFld(m_Sel,4));

//			if( (Latst>=min(Lat1,Lat2)) && (Latst<=max(Lat1,Lat2)) && (Lonst>=min(Lon1,Lon2)) && (Lonst<=max(Lon1,Lon2)) )
			if(PointInArea(Latst,Lonst, Lat1, Lon1, Lat2, Lon2))
			{
				CP1546DLG p1546dlg;
				if (p1546dlg.DoModal()==IDOK)
				{
					int yst = 1200-1-m_stBoxPoint.y;		int yen = 1200-1-m_enBoxPoint.y;
					int xst = m_stBoxPoint.x;				int xen = m_enBoxPoint.x;

					int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
					int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
					xN=4*(xN/4);//		xNmin=4*(xNmin/4);

					xN = max(0,min(xN,1200));	yN = max(0,min(yN,1200));

					((CSMS4DCApp *)AfxGetApp())->xN = xN;
					((CSMS4DCApp *)AfxGetApp())->yN = yN;

					((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area Calculation (P1546)");
					CPro_P1546_AreaDoc *pDocP1546 = (CPro_P1546_AreaDoc *)	DocUtil::GetLastDocument("Area Calculation (P1546)");	

					pDocP1546->P1546time        = p1546dlg.m_time;
					pDocP1546->P1546location    = p1546dlg.m_location;
					pDocP1546->P1546k           = p1546dlg.m_k;
					pDocP1546->P1546RxH         = p1546dlg.m_RxH;
					pDocP1546->P1546syst        = p1546dlg.m_syst;
					pDocP1546->P1546environment = p1546dlg.m_env;
					pDocP1546->P1546Clangle     = p1546dlg.m_Clangle;
					pDocP1546->P1546landsea     = p1546dlg.m_landsea;
					pDocP1546->P1546Name_ST     = Namest;
					pDocP1546->P1546lat_ST      = Latst;
					pDocP1546->P1546lon_ST      = Lonst;
					pDocP1546->P1546Hagl_ST     = atof(GetFld(m_Sel,5));
					pDocP1546->P1546fMHz_ST     = atof(GetFld(m_Sel,6));
					pDocP1546->P1546PtGt_ST     = atof(GetFld(m_Sel,7));
					pDocP1546->P1546AZ_ST       = atof(GetFld(m_Sel,8));
					pDocP1546->P1546EL_ST       = atof(GetFld(m_Sel,9));
					pDocP1546->P1546ANT_ST      = GetFld(m_Sel,14);
					pDocP1546->bufAreaW         = xN;
					pDocP1546->bufAreaH         = yN;
					pDocP1546->bufAreaP1546     = new _int16[xN*yN];

					CSMS4DCDoc* pDoc = GetDocument();
					for (int i=0;i<xN;i++)
						for (int j=0;j<yN;j++)
							pDocP1546->bufAreaP1546[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];
/*
					double xpm = xNmin + 600.0*(pDoc->TileX-1);
					double ypm = yNmin + 600.0*(pDoc->TileY-1);
					double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					yUTM = yUTM-pDoc->m_Resolution_y/2.0;
					xUTM = xUTM-pDoc->m_Resolution_x/2.0;
					pDocP1546->P1546lat0 = yUTM;
					pDocP1546->P1546lon0 = xUTM;

//	97/12/21
double xpmax = xN + xNmin + 600.0*(pDoc->TileX-1);
double ypmax = yN + yNmin + 600.0*(pDoc->TileY-1);
double xUTMmax = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpmax-1.0)-pDoc->m_Resolution_x/2.0;
double yUTMmax = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypmax-1.0)-pDoc->m_Resolution_y/2.0;;
pDocP1546->P1546latmax = yUTMmax;
pDocP1546->P1546lonmax = xUTMmax;
*/
pDocP1546->P1546lat0   = min(Lat1, Lat2);	pDocP1546->P1546lon0   = min(Lon1, Lon2);
pDocP1546->P1546latmax = max(Lat1, Lat2);	pDocP1546->P1546lonmax = max(Lon1, Lon2);


					pDocP1546->TileInfo       = pDoc->TileInfo;
					pDocP1546->m_Resolution_x = pDoc->m_Resolution_x;

					double lat1234[4],lon1234[4];
					YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
					YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
					YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
					YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
					pDocP1546->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocP1546->TileX = pDoc->TileX;
					pDocP1546->m_ReadyDoc = 1;
					pDocP1546->GetData();
					pDocP1546->UpdateAllViews(NULL);
				}//p1546dlg
			}
			else
			{
				CString nst;
				nst.Format(_Z("The selected station '' %s ''  is not inside the selected area.") , Namest);
				MessageBox(nst,_Z("!!!  Warning  !!!"));
			}
		}
		else
			MessageBox("\n\t"+_Z("No Station Selected.")+"\t\n",_Z("!!!  Warning  !!!"));
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsP1546Area(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP370Area() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int SelNUM	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(SelNUM==1)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			double Lat1, Lon1,Lat2, Lon2,Latst, Lonst;
			Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;
			Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;

			CString Namest=GetFld(m_Sel,2);
			Latst=atof(GetFld(m_Sel,3));
			Lonst=atof(GetFld(m_Sel,4));

//			if( (Latst>=min(Lat1,Lat2)) && (Latst<=max(Lat1,Lat2)) && (Lonst>=min(Lon1,Lon2)) && (Lonst<=max(Lon1,Lon2)) )
			if(PointInArea(Latst,Lonst, Lat1, Lon1, Lat2, Lon2))
			{
				CP370DLG p370dlg;
				if (p370dlg.DoModal()==IDOK)
				{
					int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
					int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;

					int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
					int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
					xN=4*(xN/4);//		xNmin=4*(xNmin/4);

					xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

					((CSMS4DCApp *)AfxGetApp())->xN = xN;
					((CSMS4DCApp *)AfxGetApp())->yN = yN;

					((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area Calculation (P370)");
					CPro_P370_AreaDoc *pDocP370=(CPro_P370_AreaDoc *)	DocUtil::GetLastDocument("Area Calculation (P370)");	

					pDocP370->P370time=p370dlg.m_time;
					pDocP370->P370location=p370dlg.m_location;
					pDocP370->P370k=p370dlg.m_k;
					pDocP370->P370RxH=p370dlg.m_RxH;
					pDocP370->P370syst=p370dlg.m_syst;
					pDocP370->P370environment=p370dlg.m_env;
					pDocP370->P370Clangle=p370dlg.m_Clangle;
					pDocP370->P370landsea=p370dlg.m_landsea;
					pDocP370->P370Name_ST = Namest;
					pDocP370->P370lat_ST  = Latst;
					pDocP370->P370lon_ST  = Lonst;
					pDocP370->P370Hagl_ST = atof(GetFld(m_Sel,5));
					pDocP370->P370fMHz_ST = atof(GetFld(m_Sel,6));
					pDocP370->P370PtGt_ST = atof(GetFld(m_Sel,7));
					pDocP370->P370AZ_ST = atof(GetFld(m_Sel,8));
					pDocP370->P370EL_ST = atof(GetFld(m_Sel,9));
					pDocP370->P370ANT_ST = GetFld(m_Sel,14);
					pDocP370->bufAreaW = xN;
					pDocP370->bufAreaH = yN;
					pDocP370->bufAreaP370 = new _int16[xN*yN];

					CSMS4DCDoc* pDoc = GetDocument();
					for (int i=0;i<xN;i++)
						for (int j=0;j<yN;j++)
							pDocP370->bufAreaP370[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*	//97/12/21
					double xpm = xNmin + 600.0*(pDoc->TileX-1);
					double ypm = yNmin + 600.0*(pDoc->TileY-1);
					double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					yUTM=yUTM-pDoc->m_Resolution_y/2.0;
					xUTM=xUTM-pDoc->m_Resolution_x/2.0;
					pDocP370->P370lat0 = yUTM;
					pDocP370->P370lon0 = xUTM;
*/
pDocP370->P370lat0   = min(Lat1, Lat2);	pDocP370->P370lon0   = min(Lon1, Lon2);
pDocP370->P370latmax = max(Lat1, Lat2);	pDocP370->P370lonmax = max(Lon1, Lon2);

					pDocP370->TileInfo=pDoc->TileInfo;
					pDocP370->m_Resolution_x = pDoc->m_Resolution_x;

					double lat1234[4],lon1234[4];
					YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
					YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
					YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
					YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
					pDocP370->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocP370->TileX = pDoc->TileX;					
					pDocP370->m_ReadyDoc=1;
					pDocP370->GetData();
					pDocP370->UpdateAllViews(NULL);
				}//p370dlg

			}
			else
			{
				CString nst;
				nst.Format(_Z("The selected station '' %s ''  is not inside the selected area"),Namest);
				MessageBox(nst,_Z("!!!  Warning  !!!"));
			}
		}
		else
			MessageBox("\n\t"+_Z("No Station Selected.")+"\t\n",_Z("!!!  Warning  !!!"));

	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsP370Area(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnUpdateoverlay(CCmdUI* pCmdUI) 
{
//	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );
	pCmdUI->SetCheck(m_OverlayFlag);	
}
/*
void CSMS4DCView::OnOverlay1() 
{
	int yst=1200-1-m_stBoxPoint.y;	int yen=1200-1-m_enBoxPoint.y;
	int xst=m_stBoxPoint.x;			int xen=m_enBoxPoint.x;
	int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
	int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);

	COverlayDLG Overlaydlg;
	Overlaydlg.DoModal();
	if(Overlaydlg.m_SelectedDoc!=NULL)
	{
		CDocument *pD=(CDocument *) Overlaydlg.m_SelectedDoc;

		int W,H,m_ReadyDoc;
		double ErMin,ErMax,*Er,m_MinValue,m_MaxValue,m_NoData;
		COLORREF RGBt[256];

		int m_level=255;
		BOOL m_bThreshold = false;
		double m_Threshold = 60.0;
		if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_AreaDoc)))
		{
			CPro_P370_AreaDoc *pDocP=(CPro_P370_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_AreaDoc)))
		{
			CPro_Free_AreaDoc *pDocP=(CPro_Free_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_AreaDoc)))
		{
			CPro_P1546_AreaDoc *pDocP=(CPro_P1546_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_LoS_AreaDoc)))
		{
			CPro_LoS_AreaDoc *pDocP=(CPro_LoS_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_NetFDoc)))
		{
			CPro_Free_NetFDoc *pDocP=(CPro_Free_NetFDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_NetBDoc)))
		{
			CPro_Free_NetBDoc *pDocP=(CPro_Free_NetBDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_NetFDoc)))
		{
			CPro_P370_NetFDoc *pDocP=(CPro_P370_NetFDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_NetBDoc)))
		{
			CPro_P370_NetBDoc *pDocP=(CPro_P370_NetBDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_NetFDoc)))
		{
			CPro_P1546_NetFDoc *pDocP=(CPro_P1546_NetFDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_NetBDoc)))
		{
			CPro_P1546_NetBDoc *pDocP=(CPro_P1546_NetBDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_AreaDoc)))
		{
			CPro_HATA_AreaDoc *pDocP=(CPro_HATA_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_NetFDoc)))
		{
			CPro_HATA_NetFDoc *pDocP=(CPro_HATA_NetFDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_NetBDoc)))
		{
			CPro_HATA_NetBDoc *pDocP=(CPro_HATA_NetBDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CInt_BC2BC_FreeDoc)))
		{
			CInt_BC2BC_FreeDoc *pDocP=(CInt_BC2BC_FreeDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CInt_BT2BT_FreeDoc)))
		{
			CInt_BT2BT_FreeDoc *pDocP=(CInt_BT2BT_FreeDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_AreaDoc)))
		{
			CPro_P1812_AreaDoc *pDocP=(CPro_P1812_AreaDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_NetFDoc)))
		{
			CPro_P1812_NetFDoc *pDocP=(CPro_P1812_NetFDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_NetBDoc)))
		{
			CPro_P1812_NetBDoc *pDocP=(CPro_P1812_NetBDoc *) Overlaydlg.m_SelectedDoc;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
		}
		else return;

		if(m_ReadyDoc ==1)
		{
		////////////////////////////////////////
			BYTE *temp2 , *Display=(BYTE *)malloc(W * H * sizeof(BYTE)); 
			double *temp = (double *)Er;		temp2 = Display;

			double m_MinValue1 = max(ErMin,m_MinValue);
			double m_MaxValue1 = min(ErMax,m_MaxValue);
			for (int i=0;i<W;i++)
				for (int j=0;j<H;j++)
					{
						if((*temp)!=m_NoData)
						{
							if (m_MaxValue1 == m_MinValue1)	*temp2 = 0;
							else
							{
								if (m_bThreshold)			*temp2 = ( min(max((*temp),m_MinValue1),m_MaxValue1) >= m_Threshold ? 159 : 0);
								else						*temp2 = Contour( min(max((*temp),m_MinValue1),m_MaxValue1) ,m_MinValue1,m_MaxValue1,m_level);
							}
						}
						else								*temp2 = 255;

						if     ((*temp)<=m_MinValue1)		*temp2 = 0;
						else if((*temp)>=m_MaxValue1)		*temp2 = 254;
						temp2++;	temp++;
					}
			BITMAPFILEHEADER * pbmfh ;
			BITMAPINFO       * pbmi ;
			BYTE             * pBits ;
			int              cxDib, cyDib ;
				
			// Load the entire DIB into memory
			pbmfh = (struct tagBITMAPFILEHEADER *)malloc (361078) ;

			CString BMP_HEADER =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Texts\\BMP_HEADER");
			FILE *fp=fopen(BMP_HEADER,"rb");
			fread(pbmfh,1078,1,fp);
			fclose(fp);
              
			// Get pointers to the info structure & the bits
			pbmfh->bfType=19778;
			pbmfh->bfReserved1=0;
			pbmfh->bfReserved2=0;
			pbmfh->bfSize=W * H+1078;
			pbmfh->bfOffBits=1078;

			pbmi  = (BITMAPINFO *) (pbmfh + 1) ;
			pbmi->bmiHeader.biSize=40;
			pbmi->bmiHeader.biWidth=W ;
			pbmi->bmiHeader.biHeight=H ;
			pbmi->bmiHeader.biPlanes=1;
			pbmi->bmiHeader.biBitCount=8;
			pbmi->bmiHeader.biCompression=0;
			pbmi->bmiHeader.biSizeImage=W * H ;
			pbmi->bmiHeader.biXPelsPerMeter=0;
			pbmi->bmiHeader.biYPelsPerMeter=0;
			pbmi->bmiHeader.biClrUsed=256;
			pbmi->bmiHeader.biClrImportant=256;
			for( i=0;i<256;i++)
			{
				pbmi->bmiColors[i].rgbBlue =  GetBValue(RGBt[i]);
				pbmi->bmiColors[i].rgbGreen = GetGValue(RGBt[i]);
				pbmi->bmiColors[i].rgbRed =   GetRValue(RGBt[i]);
				pbmi->bmiColors[i].rgbReserved=0;
			}
			pbmi->bmiColors[255].rgbBlue=255;
			pbmi->bmiColors[255].rgbGreen=0;
			pbmi->bmiColors[255].rgbRed=0;
			pbmi->bmiColors[255].rgbReserved=0;	
			
			pBits = (BYTE *) Display; 
			// Get the DIB width and height
			if (pbmi->bmiHeader.biSize == sizeof (BITMAPCOREHEADER))
			{
				cxDib = ((BITMAPCOREHEADER *) pbmi)->bcWidth ;
				cyDib = ((BITMAPCOREHEADER *) pbmi)->bcHeight ;
			}
			else
			{
				cxDib =      pbmi->bmiHeader.biWidth ;
				cyDib = abs (pbmi->bmiHeader.biHeight) ;
			}

			if (pbmfh)
			{
				CDC *dc=this->GetDC();
				CDC MemDC;				BITMAP bm;				CBitmap m_bitmap;
				m_bitmap.CreateCompatibleBitmap(dc, W , H);
				m_bitmap.GetObject (sizeof (BITMAP), &bm);
				MemDC.CreateCompatibleDC(dc);
				MemDC.SetMapMode(dc->GetMapMode());
				MemDC.SelectObject(m_bitmap);

				SetDIBitsToDevice (MemDC.m_hDC,    //pDC->m_hDC, 
								  0,         // xDst
								  0,         // yDst
								  cxDib,     // cxSrc
								  cyDib,     // cySrc
								  0,         // xSrc
								  0,         // ySrc
								  0,         // first scan line
								  cyDib,     // number of scan lines
								  pBits, 
								  pbmi, 
								  DIB_RGB_COLORS) ;
				int NewRed,NewGreen,NewBlue;
				COLORREF OldCol,MaskCol;
				double alpha=1.0-(Overlaydlg.m_OverlayFactor)/100.0;
				for(int i1=0;i1<W;i1++)
					for(int j1=0;j1<H;j1++)
					{
						OldCol=dc->GetPixel(i1+xNmin-HScrollpos,j1+(1200-1-yNmin-H-VScrollpos));
						MaskCol=MemDC.GetPixel(i1,j1);
						NewRed=(int)(alpha*((double)GetRValue(OldCol))+(1.0-alpha)*((double)GetRValue(MaskCol)));
						NewGreen=(int)(alpha*((double)GetGValue(OldCol))+(1.0-alpha)*((double)GetGValue(MaskCol)));
						NewBlue=(int)(alpha*((double)GetBValue(OldCol))+(1.0-alpha)*((double)GetBValue(MaskCol)));
						dc->SetPixel(i1+xNmin-HScrollpos,j1+(1200-1-yNmin-H-VScrollpos),RGB(NewRed,NewGreen,NewBlue));
					}
				DeleteDC(dc->m_hDC);
				dc->Detach();
				DeleteDC(MemDC.m_hDC);
				MemDC.Detach();
			}
			free (pbmfh) ;	free(Display);
		////////////////////////////////////////
		}
	}
}
*/
void CSMS4DCView::OnOverlay() 
{
	m_OverlayFlag = !m_OverlayFlag;
	m_pDocOverlay = NULL;

	if(m_OverlayFlag)
	{
		m_OverlayFlag = FALSE;
		COverlayDLG Overlaydlg;
		Overlaydlg.m_OverlayFactor = m_OverlayFactor;
		if(Overlaydlg.DoModal()==IDOK)
		{
			if(Overlaydlg.m_SelectedDoc!=NULL)
			{
				m_pDocOverlay = (CDocument *) Overlaydlg.m_SelectedDoc;
				m_OverlayFactor = Overlaydlg.m_OverlayFactor;
				m_OverlayFlag = TRUE;
			}
		}
	}
	UpDate_hBitmap();
	InvalidateRect(NULL,FALSE);
}

void CSMS4DCView::OverlayFunction(CDocument *pD, double OverlayFactor, CDC *dc) 
{
	if(DocUtil::IsOpenDocument(pD))
	{
		CPoint pointmax,	 point0;	//97/12/21
		int W,H,m_ReadyDoc , xNmin ,  yNmin;
		double ErMin,ErMax,*Er,m_MinValue,m_MaxValue,m_NoData;
		COLORREF RGBt[256];

		int m_level = 255;
		BOOL m_bThreshold = false;
		double m_Threshold = 60.0;
		if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_AreaDoc)))
		{
			CPro_P370_AreaDoc *pDocP=(CPro_P370_AreaDoc *) pD;

			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P370lat0,pDocP->P370lon0 , &point0);

			LatLon2Point(pDocP->P370latmax,pDocP->P370lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_AreaDoc)))
		{
			CPro_Free_AreaDoc *pDocP=(CPro_Free_AreaDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];		//98/01/19
//			memcpy(RGBt, pDocP->RGBt,   256*sizeof(COLORREF));

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->Freelat0,pDocP->Freelon0 , &point0);

			LatLon2Point(pDocP->Freelatmax,pDocP->Freelonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_AreaDoc)))
		{
			CPro_P1546_AreaDoc *pDocP=(CPro_P1546_AreaDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P1546lat0,pDocP->P1546lon0 , &point0);

			LatLon2Point(pDocP->P1546latmax,pDocP->P1546lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_LoS_AreaDoc)))
		{
			CPro_LoS_AreaDoc *pDocP=(CPro_LoS_AreaDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->LoSlat0,pDocP->LoSlon0 , &point0);
			
			LatLon2Point(pDocP->LoSlatmax,pDocP->LoSlonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_NetFDoc)))
		{
			CPro_Free_NetFDoc *pDocP=(CPro_Free_NetFDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->Freelat0,pDocP->Freelon0 , &point0);
			
			LatLon2Point(pDocP->Freelatmax,pDocP->Freelonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_Free_NetBDoc)))
		{
			CPro_Free_NetBDoc *pDocP=(CPro_Free_NetBDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->Freelat0,pDocP->Freelon0 , &point0);

			LatLon2Point(pDocP->Freelatmax,pDocP->Freelonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_NetFDoc)))
		{
			CPro_P370_NetFDoc *pDocP=(CPro_P370_NetFDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P370lat0,pDocP->P370lon0 , &point0);

			LatLon2Point(pDocP->P370latmax,pDocP->P370lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P370_NetBDoc)))
		{
			CPro_P370_NetBDoc *pDocP=(CPro_P370_NetBDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->P370lat0,pDocP->P370lon0 , &point0);

			LatLon2Point(pDocP->P370latmax,pDocP->P370lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_NetFDoc)))
		{
			CPro_P1546_NetFDoc *pDocP=(CPro_P1546_NetFDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P1546lat0,pDocP->P1546lon0 , &point0);

			LatLon2Point(pDocP->P1546latmax,pDocP->P1546lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1546_NetBDoc)))
		{
			CPro_P1546_NetBDoc *pDocP=(CPro_P1546_NetBDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->P1546lat0,pDocP->P1546lon0 , &point0);

			LatLon2Point(pDocP->P1546latmax,pDocP->P1546lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_AreaDoc)))
		{
			CPro_HATA_AreaDoc *pDocP=(CPro_HATA_AreaDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->HATAlat0,pDocP->HATAlon0 , &point0);

			LatLon2Point(pDocP->HATAlatmax,pDocP->HATAlonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_NetFDoc)))
		{
			CPro_HATA_NetFDoc *pDocP=(CPro_HATA_NetFDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->HATAlat0,pDocP->HATAlon0 , &point0);

			LatLon2Point(pDocP->HATAlatmax,pDocP->HATAlonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_HATA_NetBDoc)))
		{
			CPro_HATA_NetBDoc *pDocP=(CPro_HATA_NetBDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->HATAlat0,pDocP->HATAlon0 , &point0);

			LatLon2Point(pDocP->HATAlatmax,pDocP->HATAlonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CInt_BC2BC_FreeDoc)))
		{
			CInt_BC2BC_FreeDoc *pDocP=(CInt_BC2BC_FreeDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->Freelat0,pDocP->Freelon0 , &point0);

			LatLon2Point(pDocP->Freelatmax,pDocP->Freelonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CInt_BT2BT_FreeDoc)))
		{
			CInt_BT2BT_FreeDoc *pDocP=(CInt_BT2BT_FreeDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->Freelat0,pDocP->Freelon0 , &point0);

			LatLon2Point(pDocP->Freelatmax,pDocP->Freelonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_AreaDoc)))
		{
			CPro_P1812_AreaDoc *pDocP=(CPro_P1812_AreaDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P1812lat0,pDocP->P1812lon0 , &point0);

			LatLon2Point(pDocP->P1812latmax,pDocP->P1812lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_NetFDoc)))
		{
			CPro_P1812_NetFDoc *pDocP=(CPro_P1812_NetFDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];

			m_level = pDocP->m_level;
			m_bThreshold = pDocP->m_bThreshold;
			m_Threshold = pDocP->m_Threshold;
			LatLon2Point(pDocP->P1812lat0,pDocP->P1812lon0 , &point0);

			LatLon2Point(pDocP->P1812latmax,pDocP->P1812lonmax , &pointmax);			//97/12/21
		}
		else if(pD->IsKindOf(RUNTIME_CLASS(CPro_P1812_NetBDoc)))
		{
			CPro_P1812_NetBDoc *pDocP=(CPro_P1812_NetBDoc *) pD;
			W=pDocP->bufAreaW;				H=pDocP->bufAreaH;
			ErMin=pDocP->ErMin;				ErMax=pDocP->ErMax;
			m_MinValue=pDocP->m_MinValue;	m_MaxValue=pDocP->m_MaxValue;
			Er=pDocP->Er;
			m_NoData=pDocP->m_NoData;
			m_ReadyDoc=pDocP->m_ReadyDoc;
			for (int i=0;i<256;i++)		RGBt[i]=pDocP->RGBt[i];
			LatLon2Point(pDocP->P1812lat0,pDocP->P1812lon0 , &point0);

			LatLon2Point(pDocP->P1812latmax,pDocP->P1812lonmax , &pointmax);			//97/12/21
		}
		else return;

		if(m_ReadyDoc ==1)
		{
		////////////////////////////////////////
			BYTE *temp2 , *Display=(BYTE *)malloc(W * H * sizeof(BYTE)); 
			double *temp = (double *)Er;		temp2 = Display;

			double MinValue1 = max(ErMin, m_MinValue);
			double MaxValue1 = min(ErMax, m_MaxValue);
			if (m_bThreshold)
			{
				MinValue1 = ErMin;
				MaxValue1 = ErMax;
			}

			for (int i=0;i<W;i++)
				for (int j=0;j<H;j++)
					{
				//		if((*temp)!=m_NoData)									//98/01/19
				//		{
							if(MaxValue1==MinValue1)*temp2 = 0;
							else
							{
								if (m_bThreshold)	*temp2 = ( min(max((*temp),MinValue1),MaxValue1) >= m_Threshold ? 159 : 0);
								else				*temp2 = Contour( min(max((*temp),MinValue1),MaxValue1) ,MinValue1,MaxValue1,m_level);
							}
				//		}
				//		else						*temp2 = 255;

						if     ((*temp)<=MinValue1)	*temp2 = 0;
				//		else if((*temp)>=MaxValue1)	*temp2 = 254;		//98/01/19
						temp2++;	temp++;
					}
			BITMAPFILEHEADER * pbmfh ;
			BITMAPINFO       * pbmi ;
			BYTE             * pBits ;
			int              cxDib, cyDib ;
				
			// Load the entire DIB into memory
			pbmfh = (struct tagBITMAPFILEHEADER *)malloc (1078) ;
//			pbmfh = (struct tagBITMAPFILEHEADER *)malloc (361078) ;	//971220

//			CString BMP_HEADER =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Texts\\BMP_HEADER");		//97/12/20
//			FILE *fp=fopen(BMP_HEADER,"rb");
//			fread(pbmfh,1078,1,fp);
//			fclose(fp);
              
			// Get pointers to the info structure & the bits
//			pbmfh->bfType      = 19778;				//971220
//			pbmfh->bfOffBits   = 1078;
//			pbmfh->bfSize      = W*H + pbmfh->bfOffBits;

			pbmfh->bfType      = 'BM';	//16973
			pbmfh->bfOffBits   = sizeof(BITMAPFILEHEADER)+sizeof(BITMAPINFOHEADER) + 8; //offset to bitmap pixel data + 8 is for the two colour bytes
			pbmfh->bfSize      = W*H + pbmfh->bfOffBits;
			pbmfh->bfReserved1 = 0;
			pbmfh->bfReserved2 = 0;

			pbmi  = (BITMAPINFO *) (pbmfh + 1) ;
			pbmi->bmiHeader.biSize			= sizeof(BITMAPINFOHEADER);		//40	//97/12/20
			pbmi->bmiHeader.biWidth         = W ;
			pbmi->bmiHeader.biHeight        = H ;
			pbmi->bmiHeader.biPlanes        = 1;
			pbmi->bmiHeader.biBitCount      = 8;
			pbmi->bmiHeader.biCompression   = BI_RGB;			//0
			pbmi->bmiHeader.biSizeImage     = W * H;
			pbmi->bmiHeader.biXPelsPerMeter = 0;
			pbmi->bmiHeader.biYPelsPerMeter = 0;
			pbmi->bmiHeader.biClrUsed       = 256;
			pbmi->bmiHeader.biClrImportant  = 256;
			for( i=0;i<256;i++)
			{
				pbmi->bmiColors[i].rgbBlue =  GetBValue(RGBt[i]);
				pbmi->bmiColors[i].rgbGreen = GetGValue(RGBt[i]);
				pbmi->bmiColors[i].rgbRed =   GetRValue(RGBt[i]);
				pbmi->bmiColors[i].rgbReserved=0;
			}
/*	//98/01/19
			pbmi->bmiColors[255].rgbBlue     = 255;
			pbmi->bmiColors[255].rgbGreen    = 0;
			pbmi->bmiColors[255].rgbRed      = 0;
			pbmi->bmiColors[255].rgbReserved = 0;	
*/
			pbmi->bmiColors[0].rgbBlue  = 127;
			pbmi->bmiColors[0].rgbGreen = 127;
			pbmi->bmiColors[0].rgbRed   = 127;

			pBits = (BYTE *) Display; 
			// Get the DIB width and height
			if (pbmi->bmiHeader.biSize == sizeof (BITMAPCOREHEADER))
			{
				cxDib = ((BITMAPCOREHEADER *) pbmi)->bcWidth ;
				cyDib = ((BITMAPCOREHEADER *) pbmi)->bcHeight ;
			}
			else
			{
				cxDib =      pbmi->bmiHeader.biWidth ;
				cyDib = abs (pbmi->bmiHeader.biHeight) ;
			}

			if (pbmfh)
			{
	//			CDC *dc=this->GetDC();
				CDC MemDC;				
				BITMAP bm;				CBitmap mbitmap;
				mbitmap.CreateCompatibleBitmap(dc, W , H);
				mbitmap.GetObject (sizeof (BITMAP), &bm);
				MemDC.CreateCompatibleDC(dc);
				MemDC.SetMapMode(dc->GetMapMode());
				MemDC.SelectObject(mbitmap);

				SetDIBitsToDevice (MemDC.m_hDC,    //pDC->m_hDC, 
								  0,         // xDst
								  0,         // yDst
								  cxDib,     // cxSrc
								  cyDib,     // cySrc
								  0,         // xSrc
								  0,         // ySrc
								  0,         // first scan line
								  cyDib,     // number of scan lines
								  pBits, 
								  pbmi, 
								  DIB_RGB_COLORS) ;

				xNmin = point0.x;	yNmin = point0.y;
		int		xNmax = pointmax.x,	yNmax = pointmax.y;		//97/12/21
				///////////////////////////////////////

//				int NewRed,NewGreen,NewBlue;
//				COLORREF OldCol,MaskCol;
//				double alpha=1.0-(OverlayFactor)/100.0;

				if (dc->IsPrinting())
				{
					int x1,y1,x2,y2 , offset = 800;
					x1 = m_rcPrintRect.left+offset;			y1 = m_rcPrintRect.top+offset;
					x2 = m_rcPrintRect.right-offset;		y2 = m_rcPrintRect.bottom-offset;

					int W1 = W*(x2-x1)/(1200-1);
					int H1 = H*(y2-y1)/(1200-1);
					dc->StretchBlt(xNmin, yNmin-H1, W1, H1, &MemDC , 0, 0, W, H, SRCCOPY);
				}
				else
				{
					/*		//97/12/20
					for(int i1=0;i1<W;i1++)
						for(int j1=0;j1<H;j1++)
						{
							OldCol   = dc->GetPixel(i1+xNmin, j1+(yNmin-H));
							MaskCol  = MemDC.GetPixel(i1,j1);
							NewRed   = (int)(alpha*((double)GetRValue(OldCol))+(1.0-alpha)*((double)GetRValue(MaskCol)));
							NewGreen = (int)(alpha*((double)GetGValue(OldCol))+(1.0-alpha)*((double)GetGValue(MaskCol)));
							NewBlue  = (int)(alpha*((double)GetBValue(OldCol))+(1.0-alpha)*((double)GetBValue(MaskCol)));
							dc->SetPixel(i1+xNmin, j1+(yNmin-H), RGB(NewRed,NewGreen,NewBlue));
						}
					*/
					int W2 =  xNmax-xNmin,	 H2 = -yNmax+yNmin;					//97/12/21
					
					BYTE Alpha = (BYTE)(255.0*(OverlayFactor)/100.0);			//98/01/11
			//		if (m_bThreshold)
						TransparentBlt_AlphaBlend(dc, xNmin+1, yNmin-H2, W2, H2,&MemDC, 0, 0, W, H, RGB(127,127,127), Alpha,2);
			//		else
			//			TransparentBlt_AlphaBlend(dc, xNmin+1, yNmin-H2, W2, H2,&MemDC, 0, 0, W, H, RGBt[0], Alpha,0);

				}
				DeleteDC(MemDC.m_hDC);		MemDC.Detach();
				mbitmap.DeleteObject();
			}
			free (pbmfh);		free(Display);
		////////////////////////////////////////
		}
	}
	else
	{
		m_OverlayFlag = FALSE;
		UpDate_hBitmap();
		InvalidateRect(NULL,FALSE);
	}
}

void CSMS4DCView::OnToolsSymbolattribute() 
{
	CSymbolDLG symdlg;
	symdlg.m_symbolcolorR = GetRValue(m_SymbolColor);
	symdlg.m_symbolcolorG = GetGValue(m_SymbolColor);
	symdlg.m_symbolcolorB = GetBValue(m_SymbolColor);
	symdlg.m_symbolTcolorR = GetRValue(m_SymbolTextColor);
	symdlg.m_symbolTcolorG = GetGValue(m_SymbolTextColor);
	symdlg.m_symbolTcolorB = GetBValue(m_SymbolTextColor);
	symdlg.m_symbolsize = m_SymbolSize;
	if (symdlg.DoModal()== IDOK)
	{
		m_SymbolColor=RGB(symdlg.m_symbolcolorR,symdlg.m_symbolcolorG,symdlg.m_symbolcolorB);
		m_SymbolTextColor=RGB(symdlg.m_symbolTcolorR,symdlg.m_symbolTcolorG,symdlg.m_symbolTcolorB);
		m_SymbolSize=symdlg.m_symbolsize;
	}
	InvalidateRect(NULL,false);
}

void CSMS4DCView::OnPropagationmodelsLineofsightArea() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		double Lat1, Lon1,Lat2, Lon2,Latst, Lonst;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);	Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);

		CString Namest = GetFld(m_Sel,2);
		Latst = atof(GetFld(m_Sel,3));	Lonst = atof(GetFld(m_Sel,4));
//		if( (Latst>=min(Lat1,Lat2)) && (Latst<=max(Lat1,Lat2)) && (Lonst>=min(Lon1,Lon2)) && (Lonst<=max(Lon1,Lon2)) )
		if(PointInArea(Latst,Lonst, Lat1, Lon1, Lat2, Lon2))
		{
			CLoSDLG pLoSdlg;
			if (pLoSdlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;

				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area Calculation (Line of Sight)");
				CPro_LoS_AreaDoc *pDocLoS=(CPro_LoS_AreaDoc *) DocUtil::GetLastDocument("Area Calculation (Line of Sight)");	

				pDocLoS->LoSk=pLoSdlg.m_kfactor;
				pDocLoS->LoSRxH=pLoSdlg.m_RxH;
				pDocLoS->LoSName_ST = Namest;
				pDocLoS->LoSlat_ST  = Latst;
				pDocLoS->LoSlon_ST  = Lonst;
				pDocLoS->LoSHagl_ST = atof(GetFld(m_Sel,5));
				pDocLoS->LoSPtGt_ST = atof(GetFld(m_Sel,7));
				pDocLoS->bufAreaW = xN;
				pDocLoS->bufAreaH = yN;
				pDocLoS->bufAreaLoS = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocLoS->bufAreaLoS[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLoS->LoSlat0 = yUTM;
				pDocLoS->LoSlon0 = xUTM;
*/
pDocLoS->LoSlat0   = min(Lat1, Lat2);	pDocLoS->LoSlon0   = min(Lon1, Lon2);
pDocLoS->LoSlatmax = max(Lat1, Lat2);	pDocLoS->LoSlonmax = max(Lon1, Lon2);

				pDocLoS->TileInfo=pDoc->TileInfo;
				pDocLoS->m_Resolution_x = pDoc->m_Resolution_x;
pDocLoS->TileX = pDoc->TileX;
				pDocLoS->m_ReadyDoc=1;
				pDocLoS->GetData();
				pDocLoS->UpdateAllViews(NULL);
			}
		}
		else
		{
			CString nst;
			nst.Format(_Z("The selected station '' %s ''  is not into the selected area."),Namest);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}

	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
	
}
void CSMS4DCView::OnUpdatePropagationmodelsLineofsightArea(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnFreespaceNPMFS() 
{
	CDataBaseLDLG datadlg;
		
if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetF > 0)			//990428
{
	datadlg.m_Title = _Z("Select Monitoring Stations");
	if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetF == 2)	//Monitoring  AoA
		datadlg.m_Title = datadlg.m_Title + " > 1";
}

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);		Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);		Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CLoSDLG freedlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetF > 0)	//990428
{
	freedlg.m_Monitoring = true;
	freedlg.m_Fd = 10;	//	Tx W
	freedlg.m_RxH = 20;	//	Tx m
}
			freedlg.m_title = _T("Free Space Model Parameters");
			if (freedlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;

				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Maximum Field Strength (Free Space)");
				CPro_Free_NetFDoc *pDocFree=(CPro_Free_NetFDoc *) DocUtil::GetLastDocument("Maximum Field Strength (Free Space)");	

				pDocFree->Freek=freedlg.m_kfactor;
				pDocFree->FreeRxH=freedlg.m_RxH;
				pDocFree->Nrow = Nrow;
				pDocFree->Freelat_ST=new double[Nrow];
				pDocFree->Freelon_ST=new double[Nrow];
				pDocFree->FreePtGt_ST=new double[Nrow];
				pDocFree->FreeHagl_ST=new double[Nrow];
				pDocFree->FreeAZ_ST=new double[Nrow];
				pDocFree->FreeEL_ST=new double[Nrow];
				pDocFree->FreeANT_ST=new CString[Nrow];
				pDocFree->FreeName_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocFree->FreeName_ST[i1] = Namest[i1];
					pDocFree->Freelat_ST[i1]  = Latst[i1];
					pDocFree->Freelon_ST[i1]  = Lonst[i1];
					pDocFree->FreePtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocFree->FreeHagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocFree->FreeAZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocFree->FreeEL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocFree->FreeANT_ST[i1] = GetFld(m_Sel[i1],14);
				}

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetF > 0)	//990428
	pDocFree->FreePtGt_ST[0] = freedlg.m_Fd;

				pDocFree->bufAreaW = xN;	pDocFree->bufAreaH = yN;
				pDocFree->bufAreaFree = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocFree->Freelat0 = yUTM;
				pDocFree->Freelon0 = xUTM;
*/
pDocFree->Freelat0   = min(Lat1, Lat2);	pDocFree->Freelon0   = min(Lon1, Lon2);
pDocFree->Freelatmax = max(Lat1, Lat2);	pDocFree->Freelonmax = max(Lon1, Lon2);

				pDocFree->TileInfo=pDoc->TileInfo;
				pDocFree->m_Resolution_x = pDoc->m_Resolution_x;

				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocFree->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocFree->TileX = pDoc->TileX;	
				pDocFree->m_ReadyDoc=1;
				pDocFree->GetData();
				pDocFree->UpdateAllViews(NULL);
			}//freedlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}	
}

void CSMS4DCView::OnFreespaceNPBS()							//98/12/17
{
	CDataBaseLDLG datadlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetB > 0)		//990428
{
	datadlg.m_Title = _Z("Select Monitoring Stations");
	if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetB == 3)	//Monitoring  TDoA
			datadlg.m_Title = datadlg.m_Title + " > 2";
}

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];

			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);		Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);		Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CLoSDLG freedlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetB > 0)	//990428
{
	freedlg.m_Monitoring = true;
	freedlg.m_Fd = 10;	//	Tx W
	freedlg.m_RxH = 20;	//	Tx m
}
			freedlg.m_title = "Free Space Model Parameters";
			if (freedlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Best Server (Free Space)");
				CPro_Free_NetBDoc *pDocFree=(CPro_Free_NetBDoc *) DocUtil::GetLastDocument("Best Server (Free Space)");	

				pDocFree->Freek=freedlg.m_kfactor;
				pDocFree->FreeRxH=freedlg.m_RxH;
				pDocFree->Nrow = Nrow;
				pDocFree->Freelat_ST=new double[Nrow];
				pDocFree->Freelon_ST=new double[Nrow];
				pDocFree->FreePtGt_ST=new double[Nrow];
				pDocFree->FreeName_ST=new CString[Nrow];
				pDocFree->FreeHagl_ST=new double[Nrow];
				pDocFree->FreeAZ_ST=new double[Nrow];
				pDocFree->FreeEL_ST=new double[Nrow];
				pDocFree->FreeANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocFree->FreeName_ST[i1] = Namest[i1];
					pDocFree->Freelat_ST[i1]  = Latst[i1];
					pDocFree->Freelon_ST[i1]  = Lonst[i1];
					pDocFree->FreePtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocFree->FreeHagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocFree->FreeAZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocFree->FreeEL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocFree->FreeANT_ST[i1] = GetFld(m_Sel[i1],14);
				}

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagFreeNetB > 0)	//990428
	pDocFree->FreePtGt_ST[0] = freedlg.m_Fd;

				pDocFree->bufAreaW = xN;				pDocFree->bufAreaH = yN;
				pDocFree->bufAreaFree = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocFree->Freelat0 = yUTM;
				pDocFree->Freelon0 = xUTM;
*/
pDocFree->Freelat0   = min(Lat1, Lat2);	pDocFree->Freelon0   = min(Lon1, Lon2);
pDocFree->Freelatmax = max(Lat1, Lat2);	pDocFree->Freelonmax = max(Lon1, Lon2);

				pDocFree->TileInfo=pDoc->TileInfo;
				pDocFree->m_Resolution_x = pDoc->m_Resolution_x;
pDocFree->TileX = pDoc->TileX;	
				pDocFree->m_ReadyDoc=1;
				pDocFree->GetData();
				pDocFree->UpdateAllViews(NULL);
			}//freedlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}	
}

void CSMS4DCView::OnP370NetworkprocessorMaximumfieldstrength() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);			Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);			Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
//		if( (Latst_min>=min(Lat1,Lat2)) && 	(Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CP370DLG p370dlg;
			if (p370dlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Maximum Field Strength (P370)");
				CPro_P370_NetFDoc *pDocP370=(CPro_P370_NetFDoc *)	DocUtil::GetLastDocument("Maximum Field Strength (P370)");	

				pDocP370->P370time=p370dlg.m_time;
				pDocP370->P370location=p370dlg.m_location;
				pDocP370->P370k=p370dlg.m_k;
				pDocP370->P370RxH=p370dlg.m_RxH;
				pDocP370->P370syst=p370dlg.m_syst;
				pDocP370->P370environment=p370dlg.m_env;
				pDocP370->P370Clangle=p370dlg.m_Clangle;
				pDocP370->P370landsea=p370dlg.m_landsea;
				pDocP370->Nrow = Nrow;
				pDocP370->P370lat_ST=new double[Nrow];
				pDocP370->P370lon_ST=new double[Nrow];
				pDocP370->P370Hagl_ST=new double[Nrow];
				pDocP370->P370fMHz_ST=new double[Nrow];
				pDocP370->P370PtGt_ST=new double[Nrow];
				pDocP370->P370Name_ST=new CString[Nrow];
				pDocP370->P370AZ_ST=new double[Nrow];
				pDocP370->P370EL_ST=new double[Nrow];
				pDocP370->P370ANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocP370->P370Name_ST[i1] = Namest[i1];
					pDocP370->P370lat_ST[i1]  = Latst[i1];
					pDocP370->P370lon_ST[i1]  = Lonst[i1];
					pDocP370->P370Hagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocP370->P370fMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocP370->P370PtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocP370->P370AZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocP370->P370EL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocP370->P370ANT_ST[i1] = GetFld(m_Sel[i1],14);
				}
				pDocP370->bufAreaW = xN;				pDocP370->bufAreaH = yN;
				pDocP370->bufAreaP370 = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocP370->bufAreaP370[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocP370->P370lat0 = yUTM;
				pDocP370->P370lon0 = xUTM;
*/
pDocP370->P370lat0   = min(Lat1, Lat2);	pDocP370->P370lon0   = min(Lon1, Lon2);
pDocP370->P370latmax = max(Lat1, Lat2);	pDocP370->P370lonmax = max(Lon1, Lon2);

				pDocP370->TileInfo=pDoc->TileInfo;
				pDocP370->m_Resolution_x = pDoc->m_Resolution_x;

				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocP370->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocP370->TileX = pDoc->TileX;
				pDocP370->m_ReadyDoc=1;
				pDocP370->GetData();
				pDocP370->UpdateAllViews(NULL);
			}//p370dlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdateP370NetworkprocessorMaximumfieldstrength(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnP370NetworkprocessorBestserver() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);			Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);			Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CP370DLG p370dlg;
			if (p370dlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;

				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Best Server (P370)");
				CPro_P370_NetBDoc *pDocP370=(CPro_P370_NetBDoc *)	DocUtil::GetLastDocument("Best Server (P370)");	

				pDocP370->P370time=p370dlg.m_time;
				pDocP370->P370location=p370dlg.m_location;
				pDocP370->P370k=p370dlg.m_k;
				pDocP370->P370RxH=p370dlg.m_RxH;
				pDocP370->P370syst=p370dlg.m_syst;
				pDocP370->P370environment=p370dlg.m_env;
				pDocP370->P370Clangle=p370dlg.m_Clangle;
				pDocP370->P370landsea=p370dlg.m_landsea;
				pDocP370->Nrow = Nrow;
				pDocP370->P370lat_ST=new double[Nrow];
				pDocP370->P370lon_ST=new double[Nrow];
				pDocP370->P370Hagl_ST=new double[Nrow];
				pDocP370->P370fMHz_ST=new double[Nrow];
				pDocP370->P370PtGt_ST=new double[Nrow];
				pDocP370->P370Name_ST=new CString[Nrow];
				pDocP370->P370AZ_ST=new double[Nrow];
				pDocP370->P370EL_ST=new double[Nrow];
				pDocP370->P370ANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocP370->P370Name_ST[i1] = Namest[i1];
					pDocP370->P370lat_ST[i1]  = Latst[i1];
					pDocP370->P370lon_ST[i1]  = Lonst[i1];
					pDocP370->P370Hagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocP370->P370fMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocP370->P370PtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocP370->P370AZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocP370->P370EL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocP370->P370ANT_ST[i1] = GetFld(m_Sel[i1],14);
				}
				pDocP370->bufAreaW = xN;				pDocP370->bufAreaH = yN;
				pDocP370->bufAreaP370 = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocP370->bufAreaP370[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//9712/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocP370->P370lat0 = yUTM;
				pDocP370->P370lon0 = xUTM;
*/
pDocP370->P370lat0   = min(Lat1, Lat2);	pDocP370->P370lon0   = min(Lon1, Lon2);
pDocP370->P370latmax = max(Lat1, Lat2);	pDocP370->P370lonmax = max(Lon1, Lon2);

				pDocP370->TileInfo=pDoc->TileInfo;
				pDocP370->m_Resolution_x = pDoc->m_Resolution_x;
pDocP370->TileX = pDoc->TileX;
				pDocP370->m_ReadyDoc=1;
				pDocP370->GetData();
				pDocP370->UpdateAllViews(NULL);
			}//p370dlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdateP370NetworkprocessorBestserver(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP1546NPMFS() 
{
	CDataBaseLDLG datadlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF > 0)		//990428
{
	datadlg.m_Title = _Z("Select Monitoring Stations");
	if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF == 2)	//Monitoring  AoA
		datadlg.m_Title = datadlg.m_Title + " > 1";
}

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);		Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);		Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CP1546DLG p1546dlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF > 0)	//990428
{
	p1546dlg.m_Monitoring = true;
	p1546dlg.m_Cvalue = 10;	//	Tx W
	p1546dlg.m_RxH = 20;	//	Tx m
}
			if (p1546dlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Maximum Field Strength (P1546)");
				CPro_P1546_NetFDoc *pDocP1546=(CPro_P1546_NetFDoc *)	DocUtil::GetLastDocument("Maximum Field Strength (P1546)");	

CString Title_En  = "Maximum Field Strength";			//Maximum Field Strength
CString Title_Num = pDocP1546->GetTitle();		Title_Num.Replace(Title_En,"");

//Monitoring	98/12/17
	if     (((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF == 1)	Title_En  = "Monitoring Rx Coverage(MFS)";	//Monitoring Rx Coverage
	else if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF == 2)	Title_En  = "Location Zone AoA";			//Monitoring  AoA

pDocP1546->SetTitle(_T(Title_En) + Title_Num);		//pDocP1546->SetTitle(_Z(Title_En) + Title_Num);

				pDocP1546->P1546time=p1546dlg.m_time;
				pDocP1546->P1546location=p1546dlg.m_location;
				pDocP1546->P1546k=p1546dlg.m_k;
				pDocP1546->P1546RxH=p1546dlg.m_RxH;
				pDocP1546->P1546syst=p1546dlg.m_syst;
				pDocP1546->P1546environment=p1546dlg.m_env;
				pDocP1546->P1546Clangle=p1546dlg.m_Clangle;
				pDocP1546->P1546landsea=p1546dlg.m_landsea;
				pDocP1546->Nrow = Nrow;
				pDocP1546->P1546lat_ST=new double[Nrow];
				pDocP1546->P1546lon_ST=new double[Nrow];
				pDocP1546->P1546Hagl_ST=new double[Nrow];
				pDocP1546->P1546fMHz_ST=new double[Nrow];
				pDocP1546->P1546PtGt_ST=new double[Nrow];
				pDocP1546->P1546Name_ST=new CString[Nrow];
				pDocP1546->P1546AZ_ST=new double[Nrow];
				pDocP1546->P1546EL_ST=new double[Nrow];
				pDocP1546->P1546ANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocP1546->P1546Name_ST[i1] = Namest[i1];
					pDocP1546->P1546lat_ST[i1]  = Latst[i1];
					pDocP1546->P1546lon_ST[i1]  = Lonst[i1];
					pDocP1546->P1546Hagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocP1546->P1546fMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocP1546->P1546PtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocP1546->P1546AZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocP1546->P1546EL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocP1546->P1546ANT_ST[i1] = GetFld(m_Sel[i1],14);
				}

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetF > 0)	//990428
	pDocP1546->P1546PtGt_ST[0] = p1546dlg.m_Cvalue;

				pDocP1546->bufAreaW = xN;				pDocP1546->bufAreaH = yN;
				pDocP1546->bufAreaP1546 = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocP1546->bufAreaP1546[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocP1546->P1546lat0 = yUTM;
				pDocP1546->P1546lon0 = xUTM;
*/
pDocP1546->P1546lat0   = min(Lat1, Lat2);	pDocP1546->P1546lon0   = min(Lon1, Lon2);
pDocP1546->P1546latmax = max(Lat1, Lat2);	pDocP1546->P1546lonmax = max(Lon1, Lon2);

				pDocP1546->TileInfo=pDoc->TileInfo;
				pDocP1546->m_Resolution_x = pDoc->m_Resolution_x;

				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocP1546->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocP1546->TileX = pDoc->TileX;				
				pDocP1546->m_ReadyDoc=1;
				pDocP1546->GetData();
				pDocP1546->UpdateAllViews(NULL);
			}//p1546dlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}

void CSMS4DCView::OnPropagationmodelsP1546NPBS() 						//98/12/17
{
	CDataBaseLDLG datadlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB > 0)		//990428
{
	datadlg.m_Title = _Z("Select Monitoring Stations");
	if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB == 3)	//Monitoring  TDoA
		datadlg.m_Title = datadlg.m_Title + " > 2";
}

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
	//		Latst_min=min(Latst_min,Latst[i1]);			Latst_max=max(Latst_max,Latst[i1]);
	//		Lonst_min=min(Lonst_min,Lonst[i1]);			Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)		
		{
			CP1546DLG p1546dlg;

if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB > 0)	//990428
{
	p1546dlg.m_Monitoring = true;
	p1546dlg.m_Cvalue = 10;	//	Tx W
	p1546dlg.m_RxH = 20;	//	Tx m
}

			if (p1546dlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));
				((CSMS4DCApp *)AfxGetApp())->xN = xN;
				((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Best Server (P1546)");
				CPro_P1546_NetBDoc *pDocP1546=(CPro_P1546_NetBDoc *)	DocUtil::GetLastDocument("Best Server (P1546)");	

CString Title_En  = "Best Server";			//Best Server
CString Title_Num = pDocP1546->GetTitle();		Title_Num.Replace(Title_En,"");

//Monitoring	98/12/17
	if     (((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB == 1)	Title_En  = "Monitoring Rx Coverage(BS)";	//Monitoring Rx Coverage
	else if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB == 2)	Title_En  = "Coverage Zones";				//Monitoring coverage zones
	else if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB == 3)	Title_En  = "Location Zone TDoA";			//Monitoring  TDoA

pDocP1546->SetTitle(_T(Title_En) + Title_Num);		//pDocP1546->SetTitle(_Z(Title_En) + Title_Num);

				pDocP1546->P1546time=p1546dlg.m_time;
				pDocP1546->P1546location=p1546dlg.m_location;
				pDocP1546->P1546k=p1546dlg.m_k;
				pDocP1546->P1546RxH=p1546dlg.m_RxH;
				pDocP1546->P1546syst=p1546dlg.m_syst;
				pDocP1546->P1546environment=p1546dlg.m_env;
				pDocP1546->P1546Clangle=p1546dlg.m_Clangle;
				pDocP1546->P1546landsea=p1546dlg.m_landsea;
				pDocP1546->Nrow = Nrow;
				pDocP1546->P1546lat_ST=new double[Nrow];
				pDocP1546->P1546lon_ST=new double[Nrow];
				pDocP1546->P1546Hagl_ST=new double[Nrow];
				pDocP1546->P1546fMHz_ST=new double[Nrow];
				pDocP1546->P1546PtGt_ST=new double[Nrow];
				pDocP1546->P1546Name_ST=new CString[Nrow];
				pDocP1546->P1546AZ_ST=new double[Nrow];
				pDocP1546->P1546EL_ST=new double[Nrow];
				pDocP1546->P1546ANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocP1546->P1546Name_ST[i1] = Namest[i1];
					pDocP1546->P1546lat_ST[i1]  = Latst[i1];
					pDocP1546->P1546lon_ST[i1]  = Lonst[i1];
					pDocP1546->P1546Hagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocP1546->P1546fMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocP1546->P1546PtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocP1546->P1546AZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocP1546->P1546EL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocP1546->P1546ANT_ST[i1] = GetFld(m_Sel[i1],14);
				}
					
if(((CSMS4DCApp *)AfxGetApp())->m_modeFlagP1546NetB > 0)	//990428
	pDocP1546->P1546PtGt_ST[0] = p1546dlg.m_Cvalue;

				pDocP1546->bufAreaW = xN;
				pDocP1546->bufAreaH = yN;
				pDocP1546->bufAreaP1546 = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocP1546->bufAreaP1546[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocP1546->P1546lat0 = yUTM;
				pDocP1546->P1546lon0 = xUTM;
*/
pDocP1546->P1546lat0   = min(Lat1, Lat2);	pDocP1546->P1546lon0   = min(Lon1, Lon2);
pDocP1546->P1546latmax = max(Lat1, Lat2);	pDocP1546->P1546lonmax = max(Lon1, Lon2);

				pDocP1546->TileInfo=pDoc->TileInfo;
				pDocP1546->m_Resolution_x = pDoc->m_Resolution_x;
pDocP1546->TileX = pDoc->TileX;
				pDocP1546->m_ReadyDoc=1;
				pDocP1546->GetData();
				pDocP1546->UpdateAllViews(NULL);
			}//p1546dlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}	
}

void CSMS4DCView::OnCalculationPowercalculator() {	CPowerCalculatorDLG xx;	xx.DoModal();}

void CSMS4DCView::DrawProfilePolygon() 
{
	if (m_PolyPointNum>1)
	{
		CPoint m_st,m_en;
		long x1,y1,x2,y2,xmin,xmax,xabs,ymin,ymax,yabs;
		int Ni=0,Np0=0,Np=0,i,i1,j1,k, *Npt;
		double xps,yps,xpm,ypm;
		
		int m_NPoint=m_PolyPointNum;
		Npt = new int[m_NPoint];
		int m_scalfactor=16;

		((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Profile Polygon");
		CProfilePolygonDoc *pDocPolygon=(CProfilePolygonDoc *)	DocUtil::GetLastDocument("Profile Polygon");	

		pDocPolygon->m_PolyPointNum=m_PolyPointNum;
		pDocPolygon->Npt=new int[m_NPoint];

		for ( k=0;k<m_NPoint-1;k++)
		{
			m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
			if (m_st != m_en)
			{
				x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
				xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
				ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
				Npt[k]=m_scalfactor*((xabs>=yabs) ? xabs+1 : yabs+1);
				Np=Np+Npt[k];
				pDocPolygon->Npt[k]=Npt[k];
			}
		}
		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

		pDocPolygon->Np=Np;
		pDocPolygon->m_di=new double[Np];
		pDocPolygon->m_hi=new double[Np];
		pDocPolygon->m_lati=new double[Np];
		pDocPolygon->m_loni=new double[Np];

		int k1,k2 , tt,n1 = 0;
		double r0 = 0.0;
		for ( k=0;k<m_NPoint-1;k++)
		{	
			tt=Npt[k];

			double *X;		X=new double[tt];
			double *Y;		Y=new double[tt];
			double *hi;			hi= new double[tt];
			double *rng;		rng=new double[tt];
			double *x_en;		x_en=new double[tt];
			double *y_en;		y_en=new double[tt];
			m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
			if (m_st != m_en)
			{
				x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
				xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
				ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
				if (xabs>=yabs)
				{
					for (i=0;i<Npt[k];i++)
					{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
					}
				}
				else
				{
					for (i=0;i<Npt[k];i++)
					{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
						X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
					}
				}
				
			}
			double *hi1;		hi1=new double[tt];

			for ( i=0;i<tt;i++)
			{
				xps=X[i];
				yps=1200.0-1.0-(Y[i]);
				xpm = xps + 600.0*((double)(pDoc->TileX-1));
				ypm = yps + 600.0*((double)(pDoc->TileY-1));

				x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
				x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

				i1=Round(xps);		j1=Round(yps);
				hi1[i] = pDoc->buf[j1][i1];
				rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);

				pDocPolygon->m_di[n1+i]=r0+rng[i];
				pDocPolygon->m_lati[n1+i]=y_en[i];
				pDocPolygon->m_loni[n1+i]=x_en[i];
			}
			r0=r0+rng[tt-1];

			for ( i=0;i<tt;i++)
			{
				k1=m_scalfactor*(i/m_scalfactor);
				k2=m_scalfactor+k1;
				k2=min(k2,tt-1);
				hi[i]=hi1[k1]+(hi1[k2]-hi1[k1]) * ((double)(i-k1))/((double)(k2-k1));	
				pDocPolygon->m_hi[n1+i]=hi[i];
			}
			n1=n1+Npt[k];

			delete [] X;	delete [] Y;	delete [] hi1;		delete [] hi;		delete [] rng;
			delete [] x_en;	delete [] y_en;
		}
		pDocPolygon->Dmin = pDocPolygon->m_di[0];
		pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
		pDocPolygon->m_ReadyDoc=1;
		pDocPolygon->UpdateAllViews(NULL);
	}
}

void CSMS4DCView::OnPropagationmodelsFreespacePolygon() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CLoSDLG Linedlg;
		Linedlg.m_title = _Z("Free Space Model Parameters");
		if (Linedlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			CPoint m_st,m_en;
			long x1,y1,x2,y2,xmin,xmax,xabs,ymin,ymax,yabs;
			int Ni=0,Np0=0,Np=0,i,k, *Npt;
			double xps,yps,xpm,ypm;
			
			int m_NPoint=m_PolyPointNum;
			Npt = new int[m_NPoint];

			int m_scalfactor=16;

			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Polygon Calculation (Free Space)");
			CPro_Free_PolygonDoc *pDocPolygon=(CPro_Free_PolygonDoc *)	DocUtil::GetLastDocument("Polygon Calculation (Free Space)");	

			pDocPolygon->m_PolyPointNum=m_PolyPointNum;
			pDocPolygon->Npt=new int[m_NPoint];

			for ( k=0;k<m_NPoint-1;k++)
			{
				m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					Npt[k] = ((xabs>=yabs) ? xabs+1 : yabs+1);
					Npt[k] = (Npt[k]-1) * m_scalfactor + 1;
					Np=Np+Npt[k];
					pDocPolygon->Npt[k]=Npt[k];
				}
			}

			CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

			pDocPolygon->Np=Np;
			pDocPolygon->m_di=new double[Np];
			pDocPolygon->m_hi=new double[Np];
			pDocPolygon->m_lati=new double[Np];
			pDocPolygon->m_loni=new double[Np];

			int tt,n1 = 0;
			double r0 = 0.0;
			for ( k=0;k<m_NPoint-1;k++)
			{	
				tt=Npt[k];

				double *X;			X=new double[tt];
				double *Y;			Y=new double[tt];
				double *hi;			hi= new double[tt];
				double *rng;		rng=new double[tt];
				double *x_en;		x_en=new double[tt];
				double *y_en;		y_en=new double[tt];
				m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					if (xabs>=yabs)
					{
						for (i=0;i<Npt[k];i++)
						{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
							Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
						}
					}
					else
					{
						for (i=0;i<Npt[k];i++)
						{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
							X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
						}
					}
				}
				double *hi1;		hi1=new double[tt];
				for ( i=0;i<tt;i++)
				{
					xps=X[i];
					yps=1200.0-1.0-(Y[i]);

					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocPolygon->m_di[n1+i]=r0+rng[i];
					pDocPolygon->m_lati[n1+i]=y_en[i];
					pDocPolygon->m_loni[n1+i]=x_en[i];
					pDocPolygon->m_hi[n1+i]=hi1[i];
				}
				r0=r0+rng[tt-1];
				n1=n1+Npt[k];
				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;	delete [] y_en;
			}
			delete [] Npt;
			pDocPolygon->Dmin = pDocPolygon->m_di[0];
			pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
			pDocPolygon->Linek=Linedlg.m_kfactor;
			pDocPolygon->LineRxH=Linedlg.m_RxH;
			pDocPolygon->LineName_ST = GetFld(m_Sel,2);
			pDocPolygon->Linelat_ST  = atof(GetFld(m_Sel,3));
			pDocPolygon->Linelon_ST  = atof(GetFld(m_Sel,4));
			pDocPolygon->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocPolygon->LinePtGt_ST  = atof(GetFld(m_Sel,7));
			pDocPolygon->LineAZ_ST = atof(GetFld(m_Sel,8));
			pDocPolygon->LineEL_ST = atof(GetFld(m_Sel,9));
			pDocPolygon->LineANT_ST = GetFld(m_Sel,14);

			CPoint m_Point_ST;
			LatLon2Point(atof(GetFld(m_Sel,3)),atof(GetFld(m_Sel,4)), &m_Point_ST) ;
			pDocPolygon->LineHasl_ST = Point2Hg(m_Point_ST);
			pDocPolygon->m_ReadyDoc=1;
			pDocPolygon->GetData();
			pDocPolygon->UpdateAllViews(NULL);
		}
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsFreespacePolygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

double CSMS4DCView::RoundBUF_Hg(double xps,double yps) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	int i1 = int(xps);				int j1 = int(yps);
	i1 = max(min(i1,1200-1),0);		j1 = max(min(j1,1200-1),0);
	int i2 = i1+1;					int j2 = j1+1;
	double h11, h12, h21, h22, hx1, hx2, hy;

	if     ((i1 == (1200-1))&&(j1 == (1200-1)))		hy = pDoc->buf[j1][i1];
	else if((i1 == (1200-1))&&(j1 < (1200-1)))
	{
		h11 = pDoc->buf[j1][i1]; h12 = pDoc->buf[j2][i1];	hy  = h11 +(yps-j1)*(h12-h11)/(j2-j1);
	}
	else if((i1 < (1200-1))&&(j1 == (1200-1)))
	{
		h11 = pDoc->buf[j1][i1]; h21 = pDoc->buf[j1][i2];	hy  = h11 +(xps-i1)*(h21-h11)/(i2-i1);
	}
	else
	{
		h11 = pDoc->buf[j1][i1]; h12 = pDoc->buf[j2][i1]; h21 = pDoc->buf[j1][i2]; h22 = pDoc->buf[j2][i2];

		//y = y1 +(x-x1)*(y2-y1)/(x2-x1)
		hx1 = h11 +(xps-i1)*(h21-h11)/(i2-i1); hx2 = h12 +(xps-i1)*(h22-h12)/(i2-i1);
		hy  = hx1 +(yps-j1)*(hx2-hx1)/(j2-j1);
	}
	return hy;
}

void CSMS4DCView::OnProfilePolygon() 
{
	if (m_PolyPointNum>1)
	{
		((CSMS4DCApp *)AfxGetApp())->m_pView = this;

		CPoint m_st,m_en;
		long x1,y1,x2,y2,xmin,xmax,xabs,ymin,ymax,yabs;
		int Ni=0,Np0=0,Np=0,i,k, *Npt;

		double xps,yps,xpm,ypm;
		
		int m_NPoint=m_PolyPointNum;
		Npt = new int[m_NPoint];
		int m_scalfactor=16;

		((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Profile Polygon");
		CProfilePolygonDoc *pDocPolygon=(CProfilePolygonDoc *)	DocUtil::GetLastDocument("Profile Polygon");	

		pDocPolygon->m_PolyPointNum=m_PolyPointNum;
		pDocPolygon->Npt=new int[m_NPoint];

		for ( k=0;k<m_NPoint-1;k++)
		{
			m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
			if (m_st != m_en)
			{
				x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
				xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
				ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
				Npt[k] = ((xabs>=yabs) ? xabs+1 : yabs+1);
				Npt[k] = (Npt[k]-1)*m_scalfactor +1;
				Np=Np+Npt[k];
				pDocPolygon->Npt[k]=Npt[k];
			}
		}
		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

		pDocPolygon->Np=Np;
		pDocPolygon->m_di=new double[Np];
		pDocPolygon->m_hi=new double[Np];
		pDocPolygon->m_lati=new double[Np];
		pDocPolygon->m_loni=new double[Np];

		int tt,n1=0;
		double r0=0.0;
		for ( k=0;k<m_NPoint-1;k++)
		{	
			tt=Npt[k];

			double *X;		X=new double[tt];
			double *Y;		Y=new double[tt];
			double *hi;			hi= new double[tt];
			double *rng;		rng=new double[tt];
			double *x_en;		x_en=new double[tt];
			double *y_en;		y_en=new double[tt];
			m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
			if (m_st != m_en)
			{
				x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
				xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
				ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
				if (xabs>=yabs)
				{
					for (i=0;i<Npt[k];i++)
					{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
					}
				}
				else
				{
					for (i=0;i<Npt[k];i++)
					{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
						X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
					}
				}
				
			}
			double *hi1;		hi1=new double[tt];

			for ( i=0;i<tt;i++)
			{
				xps=X[i];				yps=1200.0-1.0-(Y[i]);
				xpm = xps + 600.0*((double)(pDoc->TileX-1));
				ypm = yps + 600.0*((double)(pDoc->TileY-1));

				x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
				x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

				CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
				if (pDoc->TileInfo != globeTileInfo)
				{
					CUtm m_utm;
					m_utm.y = y_en[i];
					m_utm.x = x_en[i];
					m_utm.UTM2philambda();
					y_en[i]=m_utm.phi;
					x_en[i]=m_utm.lambda;
				}
				hi1[i] = RoundBUF_Hg(xps, yps);
				rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
				pDocPolygon->m_di[n1+i]=r0+rng[i];
				pDocPolygon->m_lati[n1+i]=y_en[i];
				pDocPolygon->m_loni[n1+i]=x_en[i];
				pDocPolygon->m_hi[n1+i]=hi1[i];
			}
			r0=r0+rng[tt-1];
			n1=n1+Npt[k];

			delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;	delete [] y_en;
		}
		pDocPolygon->Dmin = pDocPolygon->m_di[0];
		pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
		pDocPolygon->m_ReadyDoc=1;
		pDocPolygon->UpdateAllViews(NULL);
	}
}
void CSMS4DCView::OnUpdateProfilePolygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP370Line() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int SelNUM	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(SelNUM==1)
		{
			CP370DLG p370dlg;
			if (p370dlg.DoModal()==IDOK)
			{
				CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

				double Latst=atof(GetFld(m_Sel,3));		double Lonst=atof(GetFld(m_Sel,4));

				CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);
				long x1=m_stLinePoint.x;
				long y1=1200-1-m_stLinePoint.y;
				long x2=m_enLinePoint.x;
				long y2=1200-1-m_enLinePoint.y;
				long x3=pointst.x;
				long y3=1200-1-pointst.y;

				int xNmin = min(min(x1 , x2) ,x3)-20;
				int yNmin = min(min(y1 , y2) ,y3)-20;
				int xNmax = max(max(x1 , x2) ,x3)+20;
				int yNmax = max(max(y1 , y2) ,y3)+20;
				int xN  = abs(xNmax - xNmin);  
				int yN  = abs(yNmax - yNmin);

				//xN=4*(xN/4);//		xNmin=4*(xNmin/4);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Line Calculation (P370)");
				CPro_P370_LineDoc *pDocLine=(CPro_P370_LineDoc *) DocUtil::GetLastDocument("Line Calculation (P370)");	

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				pDocLine->bufAreaW = xN;
				pDocLine->bufAreaH = yN;
				pDocLine->bufAreaP370 = new _int16[xN*yN];
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocLine->bufAreaP370[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

				pDocLine->m_NoData = (_int16)(pDoc->m_NoData);
				x1=m_stLinePoint.x;				y1=m_stLinePoint.y;
				x2=m_enLinePoint.x;				y2=m_enLinePoint.y;

				long xmin=min(x1 , x2);		long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);		long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor = 16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi1;		hi1=new double[Np];
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLine->Np=Np;
				pDocLine->m_di=new double[Np];
				pDocLine->m_hi=new double[Np];
				pDocLine->m_lati=new double[Np];
				pDocLine->m_loni=new double[Np];
				for ( i=0;i<Np;i++)
				{
					xps=X[i];
					yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));
					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLine->m_di[i]=rng[i];
					pDocLine->m_lati[i]=y_en[i];
					pDocLine->m_loni[i]=x_en[i];
					pDocLine->m_hi[i]=hi1[i];
				}
				pDocLine->Dmin=rng[0];
				pDocLine->Dmax=rng[Np-1];
				pDocLine->Linetime=p370dlg.m_time;
				pDocLine->Linelocation=p370dlg.m_location;
				pDocLine->Linek=p370dlg.m_k;
				pDocLine->LineRxH=p370dlg.m_RxH;
				pDocLine->Linesyst=p370dlg.m_syst;
				pDocLine->Lineenvironment=p370dlg.m_env;
				pDocLine->LineClangle=p370dlg.m_Clangle;
				pDocLine->Linelandsea=p370dlg.m_landsea;
				pDocLine->LineName_ST = GetFld(m_Sel,2);
				pDocLine->Linelat_ST  = atof(GetFld(m_Sel,3));
				pDocLine->Linelon_ST  = atof(GetFld(m_Sel,4));
				pDocLine->LineHagl_ST = atof(GetFld(m_Sel,5));
				pDocLine->LinePtGt_ST  = atof(GetFld(m_Sel,7));
				pDocLine->LineAZ_ST = atof(GetFld(m_Sel,8));
				pDocLine->LineEL_ST = atof(GetFld(m_Sel,9));
				pDocLine->LineANT_ST = GetFld(m_Sel,14);
				pDocLine->LinefMHz_ST = atof(GetFld(m_Sel,6));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel,3)),atof(GetFld(m_Sel,4)), &m_Point_ST) ;
				pDocLine->LineHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLine->Linelat0 = yUTM;
				pDocLine->Linelon0 = xUTM;
				pDocLine->m_Resolution_x = pDoc->m_Resolution_x;
				pDocLine->TileInfo=pDoc->TileInfo;
pDocLine->TileX = pDoc->TileX;
				pDocLine->m_ReadyDoc=1;
				pDocLine->GetData();
				pDocLine->UpdateAllViews(NULL);
				delete [] X; delete [] Y; delete [] hi1; delete [] hi; delete [] rng; delete [] x_en; delete [] y_en;
			}
		}
		else
			MessageBox("\n\t" + _Z("No Station Selected.") + "\t\n",_Z("!!!  Warning  !!!"));

	}//datadlg
}
void CSMS4DCView::OnUpdatePropagationmodelsP370Line(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP1546Line() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int SelNUM	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(SelNUM==1)
		{
			CP1546DLG p1546dlg;
			if (p1546dlg.DoModal()==IDOK)
			{
				CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

				double Latst=atof(GetFld(m_Sel,3));		double Lonst=atof(GetFld(m_Sel,4));

				CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);
				long x1=m_stLinePoint.x;
				long y1=1200-1-m_stLinePoint.y;
				long x2=m_enLinePoint.x;
				long y2=1200-1-m_enLinePoint.y;
				long x3=pointst.x;
				long y3=1200-1-pointst.y;

				int xNmin = min(min(x1 , x2) ,x3)-20;
				int yNmin = min(min(y1 , y2) ,y3)-20;
				int xNmax = max(max(x1 , x2) ,x3)+20;
				int yNmax = max(max(y1 , y2) ,y3)+20;
				int xN  = abs(xNmax - xNmin);  
				int yN  = abs(yNmax - yNmin);

				//xN=4*(xN/4);//		xNmin=4*(xNmin/4);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Line Calculation (P1546)");
				CPro_P1546_LineDoc *pDocLine=(CPro_P1546_LineDoc *) DocUtil::GetLastDocument("Line Calculation (P1546)");	

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				pDocLine->bufAreaW = xN;
				pDocLine->bufAreaH = yN;
				pDocLine->bufAreaP1546 = new _int16[xN*yN];
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocLine->bufAreaP1546[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

				pDocLine->m_NoData = (_int16)(pDoc->m_NoData);
				x1=m_stLinePoint.x;				y1=m_stLinePoint.y;
				x2=m_enLinePoint.x;				y2=m_enLinePoint.y;

				long xmin=min(x1 , x2);				long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);				long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor = 16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi1;		hi1=new double[Np];
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLine->Np=Np;
				pDocLine->m_di=new double[Np];
				pDocLine->m_hi=new double[Np];
				pDocLine->m_lati=new double[Np];
				pDocLine->m_loni=new double[Np];
				for ( i=0;i<Np;i++)
				{
					xps=X[i];
					yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));
					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLine->m_di[i]=rng[i];
					pDocLine->m_lati[i]=y_en[i];
					pDocLine->m_loni[i]=x_en[i];
					pDocLine->m_hi[i]=hi1[i];
				}
				pDocLine->Dmin=rng[0];
				pDocLine->Dmax=rng[Np-1];
				pDocLine->Linetime=p1546dlg.m_time;
				pDocLine->Linelocation=p1546dlg.m_location;
				pDocLine->Linek=p1546dlg.m_k;
				pDocLine->LineRxH=p1546dlg.m_RxH;
				pDocLine->Linesyst=p1546dlg.m_syst;
				pDocLine->Lineenvironment=p1546dlg.m_env;
				pDocLine->LineClangle=p1546dlg.m_Clangle;
				pDocLine->Linelandsea=p1546dlg.m_landsea;
				pDocLine->LineName_ST = GetFld(m_Sel,2);
				pDocLine->Linelat_ST  = atof(GetFld(m_Sel,3));
				pDocLine->Linelon_ST  = atof(GetFld(m_Sel,4));
				pDocLine->LineHagl_ST = atof(GetFld(m_Sel,5));
				pDocLine->LinePtGt_ST  = atof(GetFld(m_Sel,7));
				pDocLine->LineAZ_ST = atof(GetFld(m_Sel,8));
				pDocLine->LineEL_ST = atof(GetFld(m_Sel,9));
				pDocLine->LineANT_ST = GetFld(m_Sel,14);
				pDocLine->LinefMHz_ST = atof(GetFld(m_Sel,6));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel,3)),atof(GetFld(m_Sel,4)), &m_Point_ST) ;
				pDocLine->LineHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLine->Linelat0 = yUTM;
				pDocLine->Linelon0 = xUTM;
				pDocLine->m_Resolution_x = pDoc->m_Resolution_x;
				pDocLine->TileInfo=pDoc->TileInfo;
pDocLine->TileX = pDoc->TileX;
				pDocLine->m_ReadyDoc=1;
				pDocLine->GetData();
				pDocLine->UpdateAllViews(NULL);

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;		delete [] y_en;
			}
		}
		else
			MessageBox("\n\t"+_Z("No Station Selected.")+"\t\n",_Z("!!!  Warning  !!!"));
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsP1546Line(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsLineofsightLine() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CLoSDLG Linedlg;
		Linedlg.m_title = _Z("Line of Sight Model Parameters");
		if (Linedlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			double Latst=atof(GetFld(m_Sel,3));		double Lonst=atof(GetFld(m_Sel,4));

			CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);
			long x1=m_stLinePoint.x;
			long y1=1200-1-m_stLinePoint.y;
			long x2=m_enLinePoint.x;
			long y2=1200-1-m_enLinePoint.y;
			long x3=pointst.x;
			long y3=1200-1-pointst.y;

			int xNmin = min(min(x1 , x2) ,x3)-20;
			int yNmin = min(min(y1 , y2) ,y3)-20;
			int xNmax = max(max(x1 , x2) ,x3)+20;
			int yNmax = max(max(y1 , y2) ,y3)+20;
			int xN  = abs(xNmax - xNmin);  
			int yN  = abs(yNmax - yNmin);

			//xN=4*(xN/4);//		xNmin=4*(xNmin/4);
			xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Line Calculation (Line of Sight)");
			CPro_LoS_LineDoc *pDocLine=(CPro_LoS_LineDoc *) DocUtil::GetLastDocument("Line Calculation (Line of Sight)");	

			CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

			pDocLine->bufAreaW = xN;
			pDocLine->bufAreaH = yN;
			pDocLine->bufAreaLoS = new _int16[xN*yN];
			for (int i=0;i<xN;i++)
				for (int j=0;j<yN;j++)
					pDocLine->bufAreaLoS[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

			x1=m_stLinePoint.x;			y1=m_stLinePoint.y;
			x2=m_enLinePoint.x;			y2=m_enLinePoint.y;

			long xmin=min(x1 , x2);			long xmax=max(x1 , x2);
			long xabs=xmax-xmin;
			long ymin=min(y1 , y2);			long ymax=max(y1 , y2);
			long yabs=ymax-ymin;

			int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
			int m_scalfactor = 16;
			Np = (Np-1) * m_scalfactor + 1;

			double *X;		X=new double[Np];
			double *Y;		Y=new double[Np];
			if (xabs>=yabs)
			{
				for (int i=0;i<Np;i++)
				{
					X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
					Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
				}
			}
			else
			{
				for (int i=0;i<Np;i++)
				{
					Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
					X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
				}
			}
			double *hi;			hi= new double[Np];
			double *rng;		rng=new double[Np];
			double *x_en;		x_en=new double[Np];
			double *y_en;		y_en=new double[Np];

			double xps,yps,xpm,ypm;
			pDocLine->Np=Np;
			pDocLine->m_di=new double[Np];
			pDocLine->m_hi=new double[Np];
			pDocLine->m_lati=new double[Np];
			pDocLine->m_loni=new double[Np];

			double *hi1;		hi1=new double[Np];
			double Hmin=32767;
			for ( i=0;i<Np;i++)
			{
				xps=X[i];
				yps=1200.0-1.0-(Y[i]);
				xpm = xps + 600.0*((double)(pDoc->TileX-1));
				ypm = yps + 600.0*((double)(pDoc->TileY-1));
				x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
				x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

				CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
				if (pDoc->TileInfo != globeTileInfo)
				{
					CUtm m_utm;
					m_utm.y = y_en[i];
					m_utm.x = x_en[i];
					m_utm.UTM2philambda();
					y_en[i]=m_utm.phi;
					x_en[i]=m_utm.lambda;
				}
				hi1[i] = RoundBUF_Hg(xps, yps);
				rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
				pDocLine->m_di[i]=rng[i];
				pDocLine->m_lati[i]=y_en[i];
				pDocLine->m_loni[i]=x_en[i];
				pDocLine->m_hi[i]=hi1[i];
				Hmin=min(Hmin,hi1[i]);
			}
			pDocLine->Dmin=rng[0];
			pDocLine->Dmax=rng[Np-1];
			pDocLine->Hmin=Hmin;
			pDocLine->Linek=Linedlg.m_kfactor;
			pDocLine->LineRxH=Linedlg.m_RxH;
			pDocLine->LineName_ST = GetFld(m_Sel,2);
			pDocLine->Linelat_ST  = Latst;
			pDocLine->Linelon_ST  = Lonst;
			pDocLine->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocLine->LineHasl_ST = Point2Hg(pointst);

			xpm = xNmin + 600.0*(pDoc->TileX-1);
			ypm = yNmin + 600.0*(pDoc->TileY-1);
			double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
			double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
			yUTM=yUTM-pDoc->m_Resolution_y/2.0;
			xUTM=xUTM-pDoc->m_Resolution_x/2.0;
			pDocLine->Linelat0 = yUTM;
			pDocLine->Linelon0 = xUTM;
			pDocLine->m_Resolution_x = pDoc->m_Resolution_x;
			pDocLine->TileInfo=pDoc->TileInfo;
pDocLine->TileX = pDoc->TileX;
			pDocLine->m_ReadyDoc=1;
			pDocLine->GetData();
			pDocLine->UpdateAllViews(NULL);

			delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;		delete [] y_en;
		}
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsLineofsightLine(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

double CSMS4DCView::Point2Hg(CPoint point1) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	int i1=point1.x   ,   j1=(1200 -1)-point1.y;
	_int16 Hg=pDoc->buf[j1][i1];
	return (double)Hg;
}

void CSMS4DCView::OnLineDataBase() 
{
	m_bToolBarDraw = _T("");
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==2)
		{
			CString name1,Sel[2];
			CPoint pointst[2];
			double lat1[2],lon1[2];long ID1;
			for (int i=0;i<2;i++)
			{
				Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				ID1  = atol(GetFld(Sel[i],1));	name1 = GetFld(Sel[i],2);	lat1[i]  = atof(GetFld(Sel[i],3));	lon1[i]  = atof(GetFld(Sel[i],4));
				AddStation_disp(ID1,lat1[i],lon1[i],name1) ;
				LatLon2Point(lat1[i],lon1[i],&pointst[i]);
			}
			m_stLinePoint = pointst[0];		m_enLinePoint = pointst[1];

			OnDatabaseStationsindesktop2(min(lat1[0],lat1[1]),min(lon1[0],lon1[1]));
			InvalidateRect(NULL,false);
		}
	}
}

void CSMS4DCView::OnAreaDataBase() 
{
	m_bToolBarDraw = _T("");
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CCircleRadiusDLG crDLG;
		crDLG.m_title = _Z("Box Width");
		crDLG.m_lable = _Z("Enter Box Width (km) :");
		crDLG.m_CircleRadius = 100;
		if (crDLG.DoModal()==IDOK)
		{
			CString Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			if (Sel!=_T(""))
			{
				double lat1,lon1;
				CString name1;long ID1;
				ID1  = atol(GetFld(Sel,1));			name1 = GetFld(Sel,2);
				lat1  = atof(GetFld(Sel,3));		lon1  = atof(GetFld(Sel,4));
				AddStation_disp(ID1,lat1,lon1,name1) ;

				double latC1 , lonC1 , latC2 , lonC2;
				reckon(lat1,lon1, sqrt(2.0)*crDLG.m_CircleRadius/2.0 , 45.0 , &latC1 , &lonC1) ;
				LatLon2Point(latC1,lonC1, &m_stBoxPoint) ;
				reckon(lat1,lon1, sqrt(2.0)*crDLG.m_CircleRadius/2.0 , 225.0 , &latC2 , &lonC2) ;
				LatLon2Point(latC2,lonC2, &m_enBoxPoint) ;
				OnDatabaseStationsindesktop2(latC2 , lonC2);
SetBoxCorner();
				InvalidateRect(NULL,false);
			}
		}
	}	
}

void CSMS4DCView::OnCALCULATIONDistancePolygon() 
{
	double lat1,lon1,lat2,lon2 , rng=0.0;
	for (int k=0;k<m_PolyPointNum-1;k++)
	{	
		Point2LatLon(m_PolyPoint[k]  ,&lat1,&lon1);
		Point2LatLon(m_PolyPoint[k+1],&lat2,&lon2);
		rng = rng + Distance_km( lat1,lon1,lat2,lon2);
	}
	Point2LatLon(m_PolyPoint[m_PolyPointNum-1]  ,&lat1,&lon1);
	Point2LatLon(m_PolyPoint[0],&lat2,&lon2);
	rng = rng + Distance_km( lat1,lon1,lat2,lon2);

	CString string;
	string.Format("Dist(km) : %0.3f", rng  );
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(4, string);
}
void CSMS4DCView::OnUpdateCALCULATIONDistancePolygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

void CSMS4DCView::OnFrequencyallocationsDrawchart() 
{
	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Frequency Allocations 2D Chart");
	CAllocations_DrawDoc *pDocAllocationDraw=(CAllocations_DrawDoc *) DocUtil::GetLastDocument("Frequency Allocations 2D Chart");	

	pDocAllocationDraw->m_ReadyDoc=1;
	pDocAllocationDraw->GetData();
	pDocAllocationDraw->UpdateAllViews(NULL);
}

void CSMS4DCView::OnPropagationmodelsP370Polygon() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CP370DLG p370dlg;
		if (p370dlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			double Latst=atof(GetFld(m_Sel,3));
			double Lonst=atof(GetFld(m_Sel,4));

			CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);

			long x1,y1,x2,y2;
			int xNmin=32767,yNmin=32767,xNmax=-32767,yNmax=-32767;
			for (int k1=0;k1<m_PolyPointNum;k1++)
			{
				x1=m_PolyPoint[k1].x;
				y1=1200-1-m_PolyPoint[k1].y;
				xNmin=min(x1 , xNmin);		xNmax=max(x1 , xNmax);
				yNmin=min(y1 , yNmin);		yNmax=max(y1 , yNmax);
			}
			x2=pointst.x;
			y2=1200-1-pointst.y;
			xNmin=min(x2 , xNmin);		xNmax=max(x2 , xNmax);
			yNmin=min(y2 , yNmin);		yNmax=max(y2 , yNmax);
			xNmin=xNmin-20;			yNmin=yNmin-20;
			xNmax=xNmax+20;			yNmax=yNmax+20;

			int xN  = abs(xNmax - xNmin);  	int yN  = abs(yNmax - yNmin);

			xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Polygon Calculation (P370)");
			CPro_P370_PolygonDoc *pDocPolygon=(CPro_P370_PolygonDoc *)	DocUtil::GetLastDocument("Polygon Calculation (P370)");	

			CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

			pDocPolygon->bufAreaW = xN;		pDocPolygon->bufAreaH = yN;
			pDocPolygon->bufAreaP370 = new _int16[xN*yN];
			for (int i=0;i<xN;i++)
				for (int j=0;j<yN;j++)
					pDocPolygon->bufAreaP370[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

			pDocPolygon->m_NoData = (_int16)(pDoc->m_NoData);

			CPoint m_st,m_en;
			long xmin,xmax,xabs,ymin,ymax,yabs;
			int Np=0,k, *Npt;
			double xps,yps,xpm,ypm;
			
			int m_NPoint=m_PolyPointNum;
			Npt = new int[m_NPoint];

			int m_scalfactor=16;

			pDocPolygon->m_PolyPointNum=m_PolyPointNum;
			pDocPolygon->Npt=new int[m_NPoint];

			for ( k=0;k<m_NPoint-1;k++)
			{
				m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					Npt[k] = ((xabs>=yabs) ? xabs+1 : yabs+1);
					Npt[k] = (Npt[k]-1) * m_scalfactor + 1;
					Np=Np+Npt[k];
					pDocPolygon->Npt[k]=Npt[k];
				}
			}
			pDocPolygon->Np=Np;
			pDocPolygon->m_di=new double[Np];
			pDocPolygon->m_hi=new double[Np];
			pDocPolygon->m_lati=new double[Np];
			pDocPolygon->m_loni=new double[Np];

			int tt,n1=0;
			double r0=0.0;

			for ( k=0;k<m_NPoint-1;k++)
			{	
				tt=Npt[k];

				double *X;		X=new double[tt];
				double *Y;		Y=new double[tt];
				double *hi;			hi= new double[tt];
				double *rng;		rng=new double[tt];
				double *x_en;		x_en=new double[tt];
				double *y_en;		y_en=new double[tt];
				m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					if (xabs>=yabs)
					{
						for (i=0;i<Npt[k];i++)
						{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
							Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
						}
					}
					else
					{
						for (i=0;i<Npt[k];i++)
						{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
							X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
						}
					}
				}
				double *hi1;		hi1=new double[tt];
				for ( i=0;i<tt;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocPolygon->m_di[n1+i]=r0+rng[i];
					pDocPolygon->m_lati[n1+i]=y_en[i];
					pDocPolygon->m_loni[n1+i]=x_en[i];
					pDocPolygon->m_hi[n1+i]=hi1[i];
				}
				r0=r0+rng[tt-1];
				n1=n1+Npt[k];

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;	delete [] y_en;
			}
			delete [] Npt;
			pDocPolygon->Dmin = pDocPolygon->m_di[0];
			pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
			pDocPolygon->Linetime=p370dlg.m_time;
			pDocPolygon->Linelocation=p370dlg.m_location;
			pDocPolygon->Linek=p370dlg.m_k;
			pDocPolygon->LineRxH=p370dlg.m_RxH;
			pDocPolygon->Linesyst=p370dlg.m_syst;
			pDocPolygon->Lineenvironment=p370dlg.m_env;
			pDocPolygon->LineClangle=p370dlg.m_Clangle;
			pDocPolygon->Linelandsea=p370dlg.m_landsea;
			pDocPolygon->LineName_ST = GetFld(m_Sel,2);
			pDocPolygon->Linelat_ST  = Latst;
			pDocPolygon->Linelon_ST  = Lonst;
			pDocPolygon->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocPolygon->LinePtGt_ST  = atof(GetFld(m_Sel,7));
			pDocPolygon->LineAZ_ST = atof(GetFld(m_Sel,8));
			pDocPolygon->LineEL_ST = atof(GetFld(m_Sel,9));
			pDocPolygon->LineANT_ST = GetFld(m_Sel,14);
			pDocPolygon->LinefMHz_ST = atof(GetFld(m_Sel,6));
			pDocPolygon->LineHasl_ST = Point2Hg(pointst);

			xpm = xNmin + 600.0*(pDoc->TileX-1);
			ypm = yNmin + 600.0*(pDoc->TileY-1);
			double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
			double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
			yUTM=yUTM-pDoc->m_Resolution_y/2.0;
			xUTM=xUTM-pDoc->m_Resolution_x/2.0;
			pDocPolygon->Linelat0 = yUTM;
			pDocPolygon->Linelon0 = xUTM;
			pDocPolygon->m_Resolution_x = pDoc->m_Resolution_x;
			pDocPolygon->TileInfo=pDoc->TileInfo;
pDocPolygon->TileX = pDoc->TileX;
			pDocPolygon->m_ReadyDoc=1;
			pDocPolygon->GetData();
			pDocPolygon->UpdateAllViews(NULL);
		}
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsP370Polygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP1546Polygon() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CP1546DLG p1546dlg;
		if (p1546dlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			double Latst=atof(GetFld(m_Sel,3));		double Lonst=atof(GetFld(m_Sel,4));
			CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);

			long x1,y1,x2,y2;
			int xNmin=32767,yNmin=32767,xNmax=-32767,yNmax=-32767;
			for (int k1=0;k1<m_PolyPointNum;k1++)
			{
				x1=m_PolyPoint[k1].x;
				y1=1200-1-m_PolyPoint[k1].y;
				xNmin=min(x1 , xNmin);		xNmax=max(x1 , xNmax);
				yNmin=min(y1 , yNmin);		yNmax=max(y1 , yNmax);
			}
			x2=pointst.x;				y2=1200-1-pointst.y;
			xNmin=min(x2 , xNmin);		xNmax=max(x2 , xNmax);
			yNmin=min(y2 , yNmin);		yNmax=max(y2 , yNmax);
			xNmin=xNmin-20;				yNmin=yNmin-20;
			xNmax=xNmax+20;				yNmax=yNmax+20;

			int xN  = abs(xNmax - xNmin);  	int yN  = abs(yNmax - yNmin);
			xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Polygon Calculation (P1546)");
			CPro_P1546_PolygonDoc *pDocPolygon=(CPro_P1546_PolygonDoc *)	DocUtil::GetLastDocument("Polygon Calculation (P1546)");	

			CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

			pDocPolygon->bufAreaW = xN;		pDocPolygon->bufAreaH = yN;
			pDocPolygon->bufAreaP1546 = new _int16[xN*yN];
			for (int i=0;i<xN;i++)
				for (int j=0;j<yN;j++)
					pDocPolygon->bufAreaP1546[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

			pDocPolygon->m_NoData = (_int16)(pDoc->m_NoData);

			CPoint m_st,m_en;
			long xmin,xmax,xabs,ymin,ymax,yabs;
			int Np=0,k, *Npt;
			double xps,yps,xpm,ypm;
			
			int m_NPoint=m_PolyPointNum;
			Npt = new int[m_NPoint];

			int m_scalfactor=16;

			pDocPolygon->m_PolyPointNum=m_PolyPointNum;
			pDocPolygon->Npt=new int[m_NPoint];
			for ( k=0;k<m_NPoint-1;k++)
			{
				m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					Npt[k] = ((xabs>=yabs) ? xabs+1 : yabs+1);
					Npt[k] = (Npt[k]-1) * m_scalfactor + 1;
					Np=Np+Npt[k];
					pDocPolygon->Npt[k]=Npt[k];
				}
			}
			pDocPolygon->Np=Np;
			pDocPolygon->m_di=new double[Np];
			pDocPolygon->m_hi=new double[Np];
			pDocPolygon->m_lati=new double[Np];
			pDocPolygon->m_loni=new double[Np];

			int tt,n1=0;
			double r0=0.0;
			for ( k=0;k<m_NPoint-1;k++)
			{	
				tt=Npt[k];

				double *X;		X=new double[tt];
				double *Y;		Y=new double[tt];
				double *hi;			hi= new double[tt];
				double *rng;		rng=new double[tt];
				double *x_en;		x_en=new double[tt];
				double *y_en;		y_en=new double[tt];
				m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					if (xabs>=yabs)
					{
						for (i=0;i<Npt[k];i++)
						{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
							Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
						}
					}
					else
					{
						for (i=0;i<Npt[k];i++)
						{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
							X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
						}
					}
				}
				double *hi1;		hi1=new double[tt];
				for ( i=0;i<tt;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}

					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocPolygon->m_di[n1+i]=r0+rng[i];
					pDocPolygon->m_lati[n1+i]=y_en[i];
					pDocPolygon->m_loni[n1+i]=x_en[i];
					pDocPolygon->m_hi[n1+i]=hi1[i];
				}
				r0=r0+rng[tt-1];
				n1=n1+Npt[k];

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; 	delete [] x_en;	delete [] y_en;
			}
			delete [] Npt;
			pDocPolygon->Dmin = pDocPolygon->m_di[0];
			pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
			pDocPolygon->Linetime=p1546dlg.m_time;
			pDocPolygon->Linelocation=p1546dlg.m_location;
			pDocPolygon->Linek=p1546dlg.m_k;
			pDocPolygon->LineRxH=p1546dlg.m_RxH;
			pDocPolygon->Linesyst=p1546dlg.m_syst;
			pDocPolygon->Lineenvironment=p1546dlg.m_env;
			pDocPolygon->LineClangle=p1546dlg.m_Clangle;
			pDocPolygon->Linelandsea=p1546dlg.m_landsea;
			pDocPolygon->LineName_ST = GetFld(m_Sel,2);
			pDocPolygon->Linelat_ST  = Latst;
			pDocPolygon->Linelon_ST  = Lonst;
			pDocPolygon->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocPolygon->LinePtGt_ST  = atof(GetFld(m_Sel,7));
			pDocPolygon->LineAZ_ST = atof(GetFld(m_Sel,8));
			pDocPolygon->LineEL_ST = atof(GetFld(m_Sel,9));
			pDocPolygon->LineANT_ST = GetFld(m_Sel,14);
			pDocPolygon->LinefMHz_ST = atof(GetFld(m_Sel,6));
			pDocPolygon->LineHasl_ST = Point2Hg(pointst);

			xpm = xNmin + 600.0*(pDoc->TileX-1);
			ypm = yNmin + 600.0*(pDoc->TileY-1);
			double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
			double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
			yUTM=yUTM-pDoc->m_Resolution_y/2.0;
			xUTM=xUTM-pDoc->m_Resolution_x/2.0;
			pDocPolygon->Linelat0 = yUTM;
			pDocPolygon->Linelon0 = xUTM;
			pDocPolygon->m_Resolution_x = pDoc->m_Resolution_x;
			pDocPolygon->TileInfo=pDoc->TileInfo;
pDocPolygon->TileX = pDoc->TileX;
			pDocPolygon->m_ReadyDoc=1;
			pDocPolygon->GetData();
			pDocPolygon->UpdateAllViews(NULL);
		}
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsP1546Polygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsLineofsightPolygon() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CLoSDLG Linedlg;
		Linedlg.m_title = _Z("Line of Sight Model Parameters");
		if (Linedlg.DoModal()==IDOK)
		{
			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

			double Latst=atof(GetFld(m_Sel,3));		double Lonst=atof(GetFld(m_Sel,4));
			CPoint pointst;		LatLon2Point(Latst,Lonst,&pointst);

			long x1,y1,x2,y2;
			int xNmin=32767,yNmin=32767,xNmax=-32767,yNmax=-32767;
			for (int k1=0;k1<m_PolyPointNum;k1++)
			{
				x1=m_PolyPoint[k1].x;
				y1=1200-1-m_PolyPoint[k1].y;
				xNmin=min(x1 , xNmin);		xNmax=max(x1 , xNmax);
				yNmin=min(y1 , yNmin);		yNmax=max(y1 , yNmax);
			}
			x2=pointst.x;				y2=1200-1-pointst.y;
			xNmin=min(x2 , xNmin);		xNmax=max(x2 , xNmax);
			yNmin=min(y2 , yNmin);		yNmax=max(y2 , yNmax);
			xNmin=xNmin-20;				yNmin=yNmin-20;
			xNmax=xNmax+20;				yNmax=yNmax+20;

			int xN  = abs(xNmax - xNmin);  		int yN  = abs(yNmax - yNmin);
			xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

			((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Polygon Calculation (Line of Sight)");
			CPro_LoS_PolygonDoc *pDocPolygon=(CPro_LoS_PolygonDoc *)	DocUtil::GetLastDocument("Polygon Calculation (Line of Sight)");	

			CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

			pDocPolygon->bufAreaW = xN;		pDocPolygon->bufAreaH = yN;
			pDocPolygon->bufAreaLoS = new _int16[xN*yN];
			for (int i=0;i<xN;i++)
				for (int j=0;j<yN;j++)
					pDocPolygon->bufAreaLoS[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

			CPoint m_st,m_en;
			long xmin,xmax,xabs,ymin,ymax,yabs;
			int Np=0,k, *Npt;
			double xps,yps,xpm,ypm;
			
			int m_NPoint=m_PolyPointNum;
			Npt = new int[m_NPoint];

			int m_scalfactor=16;

			pDocPolygon->m_PolyPointNum=m_PolyPointNum;
			pDocPolygon->Npt=new int[m_NPoint];
			for ( k=0;k<m_NPoint-1;k++)
			{
				m_st=m_PolyPoint[k];	m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					Npt[k] = ((xabs>=yabs) ? xabs+1 : yabs+1);
					Npt[k] = (Npt[k]-1) * m_scalfactor + 1;
					Np=Np+Npt[k];
					pDocPolygon->Npt[k]=Npt[k];
				}
			}
			pDocPolygon->Np=Np;
			pDocPolygon->m_di=new double[Np];
			pDocPolygon->m_hi=new double[Np];
			pDocPolygon->m_lati=new double[Np];
			pDocPolygon->m_loni=new double[Np];

			int tt,n1=0;
			double r0=0.0;

			double Hmin=32767;
			for ( k=0;k<m_NPoint-1;k++)
			{	
				tt=Npt[k];

				double *X;			X=new double[tt];
				double *Y;			Y=new double[tt];
				double *hi;			hi= new double[tt];
				double *rng;		rng=new double[tt];
				double *x_en;		x_en=new double[tt];
				double *y_en;		y_en=new double[tt];
				m_st=m_PolyPoint[k];		m_en=m_PolyPoint[k+1];
				if (m_st != m_en)
				{
					x1=m_st.x;	y1=m_st.y;	x2=m_en.x;	y2=m_en.y;
					xmin=min(x1 , x2);		xmax=max(x1 , x2);		xabs=xmax-xmin;
					ymin=min(y1 , y2);		ymax=max(y1 , y2);		yabs=ymax-ymin;
					if (xabs>=yabs)
					{
						for (i=0;i<Npt[k];i++)
						{	X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
							Y[i]=y1+(X[i]-x1)*((double)(y2-y1))/((double)(x2-x1));	
						}
					}
					else
					{
						for (i=0;i<Npt[k];i++)
						{	Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor : y1-(double)i/(double)m_scalfactor);
							X[i]=x1+(Y[i]-y1)*((double)(x2-x1))/((double)(y2-y1));
						}
					}
				}
				double *hi1;		hi1=new double[tt];
				for ( i=0;i<tt;i++)
				{
					xps=X[i];		yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}

					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocPolygon->m_di[n1+i]=r0+rng[i];
					pDocPolygon->m_lati[n1+i]=y_en[i];
					pDocPolygon->m_loni[n1+i]=x_en[i];
					pDocPolygon->m_hi[n1+i]=hi1[i];
					Hmin=min(Hmin,hi1[i]);
				}
				r0=r0+rng[tt-1];
				n1=n1+Npt[k];

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; 	delete [] x_en;		delete [] y_en;
			}
			delete [] Npt;
			pDocPolygon->Dmin = pDocPolygon->m_di[0];
			pDocPolygon->Dmax = pDocPolygon->m_di[Np-1];
			pDocPolygon->Hmin=Hmin;
			pDocPolygon->Linek=Linedlg.m_kfactor;
			pDocPolygon->LineRxH=Linedlg.m_RxH;
			pDocPolygon->LineName_ST = GetFld(m_Sel,2);
			pDocPolygon->Linelat_ST  = Latst;
			pDocPolygon->Linelon_ST  = Lonst;
			pDocPolygon->LineHagl_ST = atof(GetFld(m_Sel,5));
			pDocPolygon->LineHasl_ST = Point2Hg(pointst);

			xpm = xNmin + 600.0*(pDoc->TileX-1);
			ypm = yNmin + 600.0*(pDoc->TileY-1);
			double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
			double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
			yUTM=yUTM-pDoc->m_Resolution_y/2.0;
			xUTM=xUTM-pDoc->m_Resolution_x/2.0;
			pDocPolygon->Linelat0 = yUTM;
			pDocPolygon->Linelon0 = xUTM;
			pDocPolygon->m_Resolution_x = pDoc->m_Resolution_x;
			pDocPolygon->TileInfo=pDoc->TileInfo;
pDocPolygon->TileX = pDoc->TileX;
			pDocPolygon->m_ReadyDoc=1;
			pDocPolygon->GetData();
			pDocPolygon->UpdateAllViews(NULL);
		}
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsLineofsightPolygon(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

double CSMS4DCView::Interp1D(double *D0,double *E0,double d,int num,int type0)
{
	int type , m;
	if (num == 2)								type = 1;
	else if ( (num == 3) && (type0 >= 2) )		type = 2;
	else										type = type0;
	//---------------------------------------------
	if ( d <= D0[0] )						m = 0;
	else if ( d >= D0[num - (type+1)] )		m = num - (type+1);
	else
	{
		int n = 0;
		while( D0[n] <= d )
			n++;
		m = n - 1;
	}
	//---------------------------------------------
	double x0,y0,x1,y1,b0,b1,y_linear;
	x0 = D0[m];		y0 = E0[m];
	x1 = D0[m+1];	y1 = E0[m+1];
	b0 = y0;		b1 = fdd1(x1,x0,y1,y0);
	y_linear = b0 + b1 * ( d - x0 );
	if ( type == 1 )	//Linear Interpolation
		return y_linear;
	double x2,y2,b2,y_quadratic;
	x2 = D0[m+2];	y2 = E0[m+2];
	b2 = fdd2(x2,x1,x0,y2,y1,y0);
	y_quadratic = y_linear + b2 * ( d - x0 ) * ( d - x1 );
	if ( type == 2 )	//Quadratic Interpolation
		return y_quadratic;
	double x3,y3,b3,y_cubic;
	x3 = D0[m+3];	y3 = E0[m+3];
	b3 = fdd3(x3,x2,x1,x0,y3,y2,y1,y0);
	y_cubic = y_quadratic + b3 * ( d - x0 ) * ( d - x1 ) * ( d - x2 );
	if ( type == 3 )	//Cubic Interpolation
		return y_cubic;
	return y_linear;
}

double CSMS4DCView::fdd1(double x1,double x0,double y1,double y0)
{
    return ((y1-y0)/(x1-x0));
}
double CSMS4DCView::fdd2(double x2,double x1,double x0,double y2,double y1,double y0)
{
    return (( fdd1(x2,x1,y2,y1)-fdd1(x1,x0,y1,y0) )/(x2-x0));
}
double CSMS4DCView::fdd3(double x3,double x2,double x1,double x0,double y3,double y2,double y1,double y0)
{
    return ((fdd2(x3,x2,x1,y3,y2,y1) - fdd2(x2,x1,x0,y2,y1,y0))/(x3-x0));
}

void CSMS4DCView::OnToolsArea3dview() 
{
	int yst=1200-1-m_stBoxPoint.y;	int yen=1200-1-m_enBoxPoint.y;
	int xst=m_stBoxPoint.x;			int xen=m_enBoxPoint.x;

	int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
	int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
//	xN=4*(xN/4);
	xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

	CSMS4DCDoc* pDoc = GetDocument();
	CString FileInfo =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Temp\\Area3D.tmp");
	FILE *fid  = fopen( FileInfo, "wt" );
	if(fid)
	{
		fprintf( fid, "%d\n", xN );		fprintf( fid, "%d\n", yN );

		for (int i=0;i<xN;i++)
			for (int j=0;j<yN;j++)
				fprintf( fid, "%d\n", pDoc->buf[(yNmin+j)][(xNmin+i)] );

		fclose( fid );
		((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area 3D View");

		///////////////////Close Legend//////////////////////////////
		if(m_LegendFlag)
		{	
			m_pLegendDLGModeless->PostNcDestroy();
			m_LegendFlag=false;
		}
	}
	else
		MessageBox(_Z("\nPath   '' ") + FileInfo + _Z(" ''   Not Found.\n\nCreate the   '' ") +((CSMS4DCApp *)AfxGetApp())->m_AppPath+ "Temp ''   "+_Z("folder."),_Z("Warning!!!"));
}
void CSMS4DCView::OnUpdateToolsArea3dview(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnToolsAntennaeditor() 
{
	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Antenna");
}

void CSMS4DCView::OnCalculationAreakm2() 
{
	double *lat;	lat=new double[m_PolyPointNum];
	double *lon;	lon=new double[m_PolyPointNum];

	double lat1,lon1;
	for (int k=0;k<m_PolyPointNum;k++)
	{
		Point2LatLon(m_PolyPoint[k],&lat1,&lon1);
		lat[k] = lat1;		lon[k] = lon1;
	}
	double Area = Area_km2(lat,lon,m_PolyPointNum);
	CString str;
	str.Format(_Z("Area(km^2)") + " : %0.9f",Area );
   ((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(5, str);
	delete [] lat;	delete [] lon;
}
void CSMS4DCView::OnUpdateCalculationAreakm2(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_PolyPointNum>1 ? 1 : 0 );	
}

double CSMS4DCView::Area_km2(double * lat0,double * lon0,int num0) 
{
	double /*pi=4.0*atan(1.0)	,*/	R = 6371.0;
	int i,k,num=num0+1;

	double *lat;	lat=new double[num];
	double *lon;	lon=new double[num];
	for (k=0;k<num-1;k++)
	{
		lat[k]=lat0[k];		lon[k]=lon0[k];
	}
	lat[num-1]=lat0[0];		lon[num-1]=lon0[0];

	double *colat;	colat=new double[num];
	double *az;		az=new double[num];
	double *daz;		daz=new double[num-1];
	double *deltas;		deltas=new double[num-1];
	double *colats;		colats=new double[num-1];
	double *integrants;	integrants=new double[num-1];

	double sum=0.0;
	for ( i=0;i<num;i++)
	{
		colat[i] = Distance_km(0.0,0.0,lat[i],lon[i])/R ;
		az[i] = (pi/180.0)*Azimuth_Deg(0.0,0.0,lat[i],lon[i]) ;
	}
	for ( i=0;i<num-1;i++)
	{
		daz[i] = az[i+1] - az[i];
		daz[i] = pi * ((fabs(daz[i])/pi) - 2.0 * ceil(((fabs(daz[i])/pi)-1.0)/2.0)) * SignFunction(daz[i]);
		deltas[i] = (colat[i+1] - colat[i])/2.0;
	
		colats[i] = colat[i] + deltas[i];
		integrants[i] = (1.0-cos(colats[i])) * daz[i];
		sum = sum + integrants[i];	
	}
	sum = R*R*fabs(sum);
	delete [] colat;	delete [] az;	delete [] daz;	delete [] deltas;	delete [] colats; delete [] integrants;	delete [] lat;	delete [] lon;
	return sum;
}

int CSMS4DCView::SignFunction(double x) 
{
	if(x>0.0)			return 1;
	else if (x<0.0)		return -1;
	else				return 0;
}

void CSMS4DCView::OnCALCULATIONElevation() 
{
	double k=4.0/3.0;
	CKFactor kdlg;
	if (kdlg.DoModal()==IDOK)
	{
		k = atof_kfactor(kdlg.m_kfactorEdit);
		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);	Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);
		double dist = Distance_km(stLinelat,stLinelon,enLinelat,enLinelon);
		double re = k*(6371000.0);
		double h1 = Point2Hg(m_stLinePoint);
		double h2 = Point2Hg(m_enLinePoint);
		double elevp = atan(((re+h2)*cos(1000.0*dist/re)-(re+h1))/((re+h2)*sin(1000.0*dist/re)));
//		double pi = 4.0*atan(1.0);
		elevp = elevp * (180.0/pi);
		CString str;
		str.Format(_Z("Elevation") + " : %0.3f ", elevp  );
	   ((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(4, str);
	}
}
void CSMS4DCView::OnUpdateCALCULATIONElevation(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stLinePoint != m_enLinePoint ? 1 : 0 );	
}

void CSMS4DCView::OnTools2dviewcontour() 
{
	int yst=1200-1-m_stBoxPoint.y;	int yen=1200-1-m_enBoxPoint.y;
	int xst=m_stBoxPoint.x;			int xen=m_enBoxPoint.x;
	int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
	int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
	xN=4*(xN/4);
	xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Contour_DEM");
	CContour_DEMDoc *pDocFree=(CContour_DEMDoc *) DocUtil::GetLastDocument("Contour_DEM");	

	pDocFree->bufAreaW = xN;	pDocFree->bufAreaH = yN;
	pDocFree->bufAreaFree = new _int16[xN*yN];
	CSMS4DCDoc* pDoc = GetDocument();

	for (int i=0;i<xN;i++)
		for (int j=0;j<yN;j++)
			pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];

	double xpm = xNmin + 600.0*(pDoc->TileX-1);
	double ypm = yNmin + 600.0*(pDoc->TileY-1);
	double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
	double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
	yUTM=yUTM-pDoc->m_Resolution_y/2.0;
	xUTM=xUTM-pDoc->m_Resolution_x/2.0;

	pDocFree->TileInfo=pDoc->TileInfo;
	pDocFree->Freelat0 = yUTM;
	pDocFree->Freelon0 = xUTM;
	pDocFree->m_Resolution_x = pDoc->m_Resolution_x;
	pDocFree->m_Resolution_y = pDoc->m_Resolution_y;
	pDocFree->m_ReadyDoc=1;
	pDocFree->GetData();
	pDocFree->UpdateAllViews(NULL);
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdateTools2dviewcontour(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

int CSMS4DCView::Contour(double y,double MinV,double MaxV,int nL) 
{
//	if (nL>=255)	return int(( y - MinV) * 255.0 / (MaxV- MinV));		//98/01/19
	if (nL>=255)	return int(1.0 + (y - MinV)*(255.0-1.0)/(MaxV- MinV));

	double StepV = ((MaxV-MinV)/nL);
	double a1, a2, b1 /*,b2*/;											//98/01/19
	int c = 0;
	for (int i=0;i<nL;i++)
	{
		a1 = MinV + i*StepV;		a2 = a1 + StepV;
		if ( (y>=a1) && (y<a2))
		{
			b1 = 1.0 + (255.0-1.0)*(a1-MinV)/(MaxV-MinV);				//98/01/19
		/*
			b1=255.0*(a1-MinV)/(MaxV-MinV);
			b2=255.0*(a2-MinV)/(MaxV-MinV);
		//	c=int((b1+b2)/2.0);
		*/
			c = int(b1);
		}
	}
	return c;
}

void CSMS4DCView::OnAddStation() 
{
	m_bToolBarDraw=_T("addstation");
}
void CSMS4DCView::OnUpdateAddStation(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_bToolBarDraw == _T("addstation"));
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);
}

void CSMS4DCView::OnAddStationFUC(double lat1,double lon1) 
{
	CAddStationDLG stationdlg;

	CString NameStr;
	NameStr.Format("Station%d%d",int(lat1),int(lon1));
	stationdlg.m_IDst = -1;
	stationdlg.m_STname = NameStr;
	stationdlg.m_STlat_deg = lat1;
	stationdlg.m_STlon_deg = lon1;
	stationdlg.m_STh_asl = (int)(LatLon2Hg(lat1, lon1));

stationdlg.m_Lang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;	//97/12/24

	if(stationdlg.DoModal()==IDOK)
	{
		stationdlg.m_IDst = AddSt(	stationdlg.m_STname,
				stationdlg.m_STlat_deg,
				stationdlg.m_STlon_deg,
				stationdlg.m_STh_agl,
				stationdlg.m_TXfreq,
				stationdlg.m_Power_eirp, 
				stationdlg.m_Azimuth,
				stationdlg.m_Elevation,
				stationdlg.m_ANTgain,
				stationdlg.m_BWh,
				stationdlg.m_BWv,
				stationdlg.m_Polarization,
				stationdlg.m_InserLoss,
				stationdlg.m_RxSens,
				stationdlg.m_STTP,
				stationdlg.m_Emission.Mid(4),
				Emission2NBW(stationdlg.m_Emission),
				stationdlg.m_STh_asl,
				m_AppPath + _T("Antenna\\ant_") + stationdlg.m_Antenna + _T(".ant")
																					);
		AddStation_disp(stationdlg.m_IDst,stationdlg.m_STlat_deg,stationdlg.m_STlon_deg,stationdlg.m_STname) ;
	}
}

long CSMS4DCView::AddSt(CString STname, double STlat_deg, double STlon_deg, long Sth_agl,
       double txfreq, double power_eirp, double Azimuth, double Elevation,
       double AntGain, double BWh, double BWv, CString Polarization, double InsertionLoss, 
       double RxSensitivity, CString STTP, CString Emission, double BandWidth, long HeightASL, 
	   CString AntPath)
{
	double Pwr2Ant = power_eirp*pow(10.0,-AntGain/10.0);

	////////////////// Country Code ////////////////////////////////////////
//	double pi=4.0*atan(1.0);
	float RLON = (float)(STlon_deg*pi/180.0) ;
	float RLAT = (float)(STlat_deg*pi/180.0) ;

	CString Country("");
	GEOPLC(&RLON, &RLAT, (BYTE*)Country.GetBufferSetLength(3)) ;

	long  ITURegion= 0;
	GEORGN(&RLON, &RLAT,&ITURegion) ;


	CString LastStID, LastEqID, LastEqCatID, LastAntID, LastAntCatID, LastFreqID, SQL1, AntName;
	double FreqFrom, FreqTo;
	CDatabase DB1;
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB1.Open(_T(m_DB),false,false,_T("ODBC;"),false);

	CRecordset rs;
	rs.m_pDatabase=&DB1;
	Polarization.MakeUpper();
	Polarization.TrimRight();
	STTP.MakeUpper();
//	if(!STTP.Left(2).CompareNoCase(_T("FX")) || !STTP.Left(2).CompareNoCase(_T("FB")))		//1400/04/20
	if(!STTP.Left(2).CompareNoCase(_T("FX")) || !STTP.Left(2).CompareNoCase(_T("FB")) || !STTP.Left(2).CompareNoCase(_T("__")))
	{
// Fixed Station
		rs.Open(CRecordset::snapshot, _T("select max(StID)+1 from Station"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,%ld,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, HeightASL, STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO Station (StID, LicID, SiteName, GeoLat, GeoLon, HeightASL, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf "), LastEqCatID, RxSensitivity);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, StID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else if(!STTP.Left(2).CompareNoCase(_T("ML")))
	{
// Mobile Station
		rs.Open(CRecordset::snapshot, _T("select max(MobID)+1 from Mobiles"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO Mobiles (MobID, LicID, MobName, GeoLat, GeoLon, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf "), LastEqCatID, RxSensitivity);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, MobID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else if(!STTP.Left(2).CompareNoCase(_T("BC")) || !STTP.Left (2).CompareNoCase(_T("BT")))
	{
// BC Station
		rs.Open(CRecordset::snapshot, _T("select max(StID)+1 from BCStation"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,%ld,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, HeightASL, 
			STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO BCStation (StID, LicID, SiteName, GeoLat, GeoLon, HeightASL, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		double erp_h=0.0, erp_v=0.0, erp;
		if	   (Polarization==_T("H"))		erp = erp_h = 10.0*log10(power_eirp) - 2.15;
		else if(Polarization==_T("V"))		erp = erp_v = 10.0*log10(power_eirp) - 2.15;
		else
		{
			erp_v = erp_h = 10.0*log10(power_eirp) - 2.15;
			erp = 10.0*log10(pow(10.0,erp_h/10.0)+pow(10.0,erp_v/10.0));
		}
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf, %lf, %lf, %lf, 10 "), LastEqCatID, RxSensitivity, erp, erp_h, erp_v);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity, erp_dbw, erp_h_dbw, erp_v_dbw, PwrRatio) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, BCID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else return -1;
//AntCat    
	rs.Open(CRecordset::snapshot, _T("select max(AntCatID)+1 from AntCat"));
	rs.GetFieldValue ((short)0,LastAntCatID);
	rs.Close();
	if(LastAntCatID.IsEmpty())
		LastAntCatID=_T("1");
	AntName=AssignAntenna(&DB1,atol(LastAntCatID),AntPath,&FreqFrom,&FreqTo,Polarization,Azimuth);
	SQL1.Format(_T("SELECT %s, '%s', 'C','I','%s','%s',%lf,%lf,%lf,%lf,%lf,%lf,0 "), LastAntCatID, AntName, Polarization,
	(BWh==360?_T("N"):_T("D")), AntGain, BWh, BWv, InsertionLoss,FreqFrom,FreqTo); 
	SQL1=_T("INSERT INTO AntCat (AntCatID, AntName, ClassofAnt,GainType, Pol, AntDir, gain, beamwidthH, beamwidthV, insloss, FreqFrom, FreqTo,Lib) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
//Antenna
	rs.Open(CRecordset::snapshot, _T("select max(AntID)+1 from Antenna")); 
	rs.GetFieldValue((short)0,LastAntID);
	rs.Close();
	if(LastAntID.IsEmpty())
		LastAntID=_T("1");
	SQL1.Format(_T("SELECT %s, %s,%s,%lf,%lf,%ld "), LastAntID, LastAntCatID, LastEqID, Azimuth, Elevation, Sth_agl);
	SQL1=_T("INSERT INTO Antenna (AntID, AntCatID, EqID,Azimuth,Elevation,AntHeightAGL) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
//Frequency
	rs.Open(CRecordset::snapshot, _T("select max(FreqID)+1 from Frequency"));
	rs.GetFieldValue((short)0,LastFreqID);
	rs.Close();
	if(LastFreqID.IsEmpty())
		LastFreqID=_T("1");
	SQL1.Format(_T("SELECT %s, %s, %lf,'%s',%lf,'%s','CP', %lf"), LastFreqID, LastEqID, txfreq*1000000., Emission,	BandWidth,BWCode((double)BandWidth)+Emission, txfreq*1000000.); 
	SQL1=_T("INSERT INTO Frequency ( FreqID, EqID, Frequency, emissioncl, bandwidth, EmDes,NatServ,RespFreq ) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
	DB1.Close();
	return atol(LastFreqID);
}

/*
long CSMS4DCView::AddSt(CString STname, double STlat_deg, double STlon_deg, long Sth_agl,
       double txfreq, double power_eirp, double Azimuth, double Elevation,
       double AntGain, double BWh, double BWv, CString Polarization, double InsertionLoss, 
       double RxSensitivity, CString STTP, CString Emission, double BandWidth, long HeightASL, 
	   CString AntPath)
{
	double Pwr2Ant = power_eirp*pow(10.0,-AntGain/10.0);

	////////////////// Country Code ////////////////////////////////////////
	double pi=4.0*atan(1.0);
	float RLON = (float)(STlon_deg*pi/180.0) ;
	float RLAT = (float)(STlat_deg*pi/180.0) ;

	CString Country("");
	GEOPLC(&RLON, &RLAT, (BYTE*)Country.GetBufferSetLength(3)) ;

	long  ITURegion= 0;
	GEORGN(&RLON, &RLAT,&ITURegion) ;

	CString LastStID, LastEqID, LastEqCatID, LastAntID, LastAntCatID, LastFreqID, SQL1, AntName;
	double FreqFrom, FreqTo;
	CDatabase DB1;
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB1.Open(_T(m_DB),false,false,_T("ODBC;"),false);

	CRecordset rs;
	rs.m_pDatabase=&DB1;
	STTP.MakeUpper();
	if(!STTP.Left(2).CompareNoCase(_T("FX")) || !STTP.Left(2).CompareNoCase(_T("FB")))
	{
// Fixed Station
		rs.Open(CRecordset::snapshot, _T("select max(StID)+1 from Station"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,%ld,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, HeightASL, STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO Station (StID, LicID, SiteName, GeoLat, GeoLon, HeightASL, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf "), LastEqCatID, RxSensitivity);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, StID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else if(!STTP.Left(2).CompareNoCase(_T("ML")))
	{
// Mobile Station
		rs.Open(CRecordset::snapshot, _T("select max(MobID)+1 from Mobiles"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO Mobiles (MobID, LicID, MobName, GeoLat, GeoLon, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf "), LastEqCatID, RxSensitivity);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, MobID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else if(!STTP.Left(2).CompareNoCase(_T("BC")) || !STTP.Left (2).CompareNoCase(_T("BT")))
	{
// BC Station
		rs.Open(CRecordset::snapshot, _T("select max(StID)+1 from BCStation"));
		rs.GetFieldValue((short)0,LastStID);
		rs.Close();
		if(LastStID.IsEmpty())
			LastStID=_T("1");
		SQL1.Format(_T("SELECT %s, -1, '%s',%lf,%lf,%ld,'%s','%s',%ld "), LastStID, STname, STlat_deg, STlon_deg, HeightASL, 
			STTP.Left(2),Country,ITURegion);
		SQL1=_T("INSERT INTO BCStation (StID, LicID, SiteName, GeoLat, GeoLon, HeightASL, ClassStation,Country,ITURegion) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	//EqCat
		double erp_h=0.0, erp_v=0.0, erp;
		if(Polarization==_T("H"))
			erp=erp_h=10.0*log10(power_eirp);
		else if(Polarization==_T("V"))
			erp=erp_v=10.0*log10(power_eirp);
		else
		{
			erp_v=erp_h=10.0*log10(power_eirp);
			erp=10.0*log10(pow(10.0,erp_h/10.0)+pow(10.0,erp_v/10.0));
		}
		rs.Open(CRecordset::snapshot, _T("select max(EqCatID)+1 from EqCat")); 
		rs.GetFieldValue((short)0,LastEqCatID);
		rs.Close();
		if(LastEqCatID.IsEmpty())
			LastEqCatID=_T("1");
		SQL1.Format(_T("SELECT %s,'I',%lf, %lf, %lf, %lf "), LastEqCatID, RxSensitivity, erp, erp_h, erp_v);
		SQL1=_T("INSERT INTO EqCat (EqCatID, radpowertype, sensitivity, erp_dbw, erp_h_dbw, erp_v_dbw) ")+SQL1; 
		DB1.ExecuteSQL(SQL1);
	//Equipment
		rs.Open(CRecordset::snapshot, _T("select max(EqID)+1 from Equipment"));
		rs.GetFieldValue((short)0,LastEqID);
		rs.Close();
		if(LastEqID.IsEmpty())
			LastEqID=_T("1");
		SQL1.Format(_T("SELECT %s, %s,%s, %lf,%lf"), LastEqID, LastEqCatID, LastStID, power_eirp,Pwr2Ant); 
		SQL1=_T("INSERT INTO Equipment (EqID, EqCatID, BCID, radpwr,Pwr2Ant) ")+SQL1;
		DB1.ExecuteSQL(SQL1);
	}
	else return -1;
//AntCat    
	rs.Open(CRecordset::snapshot, _T("select max(AntCatID)+1 from AntCat"));
	rs.GetFieldValue ((short)0,LastAntCatID);
	rs.Close();
	if(LastAntCatID.IsEmpty())
		LastAntCatID=_T("1");
	AntName=AssignAntenna(&DB1,atol(LastAntCatID),AntPath,&FreqFrom,&FreqTo,Polarization,Azimuth);
	SQL1.Format(_T("SELECT %s, '%s', 'C','I','%s','%s',%lf,%lf,%lf,%lf,%lf,%lf,0 "), LastAntCatID, AntName, Polarization,
	(BWh==360?_T("N"):_T("D")), AntGain, BWh, BWv, InsertionLoss,FreqFrom,FreqTo); 
	SQL1=_T("INSERT INTO AntCat (AntCatID, AntName, ClassofAnt,GainType, Pol, AntDir, gain, beamwidthH, beamwidthV, insloss, FreqFrom, FreqTo,Lib) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
//Antenna
	rs.Open(CRecordset::snapshot, _T("select max(AntID)+1 from Antenna")); 
	rs.GetFieldValue((short)0,LastAntID);
	rs.Close();
	if(LastAntID.IsEmpty())
		LastAntID=_T("1");
	SQL1.Format(_T("SELECT %s, %s,%s,%lf,%lf,%ld "), LastAntID, LastAntCatID, LastEqID, Azimuth, Elevation, Sth_agl);
	SQL1=_T("INSERT INTO Antenna (AntID, AntCatID, EqID,Azimuth,Elevation,AntHeightAGL) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
//Frequency
	rs.Open(CRecordset::snapshot, _T("select max(FreqID)+1 from Frequency"));
	rs.GetFieldValue((short)0,LastFreqID);
	rs.Close();
	if(LastFreqID.IsEmpty())
		LastFreqID=_T("1");
	SQL1.Format(_T("SELECT %s, %s, %lf,'%s',%lf,'%s','CP', %lf"), LastFreqID, LastEqID, txfreq*1000000., Emission,	BandWidth,BWCode((double)BandWidth)+Emission, txfreq*1000000.); 
	SQL1=_T("INSERT INTO Frequency ( FreqID, EqID, Frequency, emissioncl, bandwidth, EmDes,NatServ,RespFreq ) ")+SQL1;
	DB1.ExecuteSQL(SQL1);
	DB1.Close();
	return atol(LastFreqID);
}
*/

CString CSMS4DCView::AssignAntenna(CDatabase *DB,long AntID, CString AntPath, double *FreqFrom, double *FreqTo, CString Pol, double Azimuth)
{
	CString AntName;
	FILE *fp=fopen(AntPath,"rt");
	if(fp!=NULL)
	{
		double AttnH[360],AttnV[360];
		char buf[150];
		int i,j;
		CString Sbuf;
		fgets(buf,100,fp);
		Sbuf=buf;
		Sbuf=Sbuf.Left(Sbuf.GetLength()-1);
		AntName=Sbuf.Mid(5);	AntName.TrimRight();
		fgets(buf,100,fp);
		fgets(buf,100,fp);
		fgets(buf,100,fp);
		fgets(buf,100,fp);
		Sbuf=buf;
		Sbuf=Sbuf.Left(Sbuf.GetLength()-2);
		*FreqFrom=atof(Sbuf.Mid(7));
		fgets(buf,100,fp);
		Sbuf=buf;
		Sbuf=Sbuf.Left(Sbuf.GetLength()-2);
		*FreqTo=atof(Sbuf.Mid(7));
		fgets(buf,100,fp);
		fgets(buf,100,fp);
		Sbuf=buf;
		fgets(buf,100,fp);
		j=0;
		double Patt[2][360]={0.0},Patt2[2][360]={0.0};
		for(i=0;i<360;i++)
		{
			fgets(buf,100,fp);
			Sbuf=buf;
			AttnH[i]=atof(Sbuf.Mid(4,5));
			AttnV[i]=atof(Sbuf.Mid(10,5));
			Patt[0][i]=Patt[1][i]=i;
		}
		fclose(fp);
		Pol.TrimRight();
		CRecordset AntPatt;
		CString SQL;
		AntPatt.m_pDatabase=DB;
		SQL.Format(_T("select * from AntDiag where AntID=%ld"),AntID);
		AntPatt.Open(CRecordset::dynaset,SQL);
		if(AntPatt.GetRecordCount()>0)
		{
			SQL.Format(_T("Delete * from AntDiag where AntID=%ld"),AntID);
			DB->ExecuteSQL(SQL);
		}
		AntPatt.Close();
		if(Pol!=_T("V"))
		{
			if(Azimuth>=0)
			{
				i=359;
				while(Patt[0][i]>359-Azimuth && i>=0)
					i--;
				if(i==-1) i=359;
				for(int j=i;j>=0;j--)
					Patt[0][j]+=Azimuth;
				for(j=i+1;j<360;j++)
					Patt[0][j]-=360-Azimuth;
			}
			else
			{
				i=0;
				while(Patt[0][i]<-Azimuth && i<360)
					i++;
				if(i==360) i=0;
				for(int j=i;j<360;j++)
					Patt[0][j]+=Azimuth;
				for(j=0;j<i;j++)
					Patt[0][j]+=360+Azimuth;
			}
			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[0][j]]=AttnH[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "H", Patt2[1][i]);
				DB->ExecuteSQL(SQL);
			}
			if(Pol==_T("H"))
			{
				Azimuth=-90;
			}
			else
				Azimuth=-Azimuth-90;
			i=0;
			while(Patt[1][i]<-Azimuth && i<360)
				i++;
			if(i==360) i=0;
			for(int j=i;j<360;j++)
				Patt[1][j]+=Azimuth;
			for(j=0;j<i;j++)
				Patt[1][j]+=360+Azimuth;

			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[1][j]]=AttnV[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "V", Patt2[1][359-i]);
				DB->ExecuteSQL(SQL);
			}
		}
		else
		{
			if(Azimuth>=0)
			{
				i=359;
				while(Patt[0][i]>359-Azimuth && i>=0)
					i--;
				if(i==-1) i=359;
				for(int j=i;j>=0;j--)
					Patt[0][j]+=Azimuth;
				for(j=i+1;j<360;j++)
					Patt[0][j]-=360-Azimuth;
			}
			else
			{
				i=0;
				while(Patt[0][i]<-Azimuth && i<360)
					i++;
				if(i==360) i=0;
				for(int j=i;j<360;j++)
					Patt[0][j]+=Azimuth;
				for(j=0;j<i;j++)
					Patt[0][j]+=360+Azimuth;
			}
			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[0][j]]=AttnH[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "V", Patt2[1][i]);
				DB->ExecuteSQL(SQL);
			}
			i=0;
			while(Patt[1][i]<90 && i<360)
				i++;
			if(i==360) i=0;
			for(int j=i;j<360;j++)
				Patt[1][j]+=-90;
			for(j=0;j<i;j++)
				Patt[1][j]+=360-90;

			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[1][j]]=AttnV[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "H", Patt2[1][359-i]);
				DB->ExecuteSQL(SQL);
			}
		}
		return AntName;
	}
	return _T("");
}


/*
CString CSMS4DCView::AssignAntenna(CDatabase *DB,long AntID, CString AntPath, double *FreqFrom, double *FreqTo, CString Pol, double Azimuth)
{
	CString AntName;
	FILE *fp=fopen(AntPath,"rt");
	if(fp!=NULL)
	{
		double AttnH[360],AttnV[360];		char buf[150];		int i,j;		CString Sbuf;
		fgets(buf,100,fp);
		Sbuf=buf;		Sbuf=Sbuf.Left(Sbuf.GetLength()-1);
		AntName=Sbuf.Mid(5);	AntName.TrimRight();
		fgets(buf,100,fp);		fgets(buf,100,fp);		fgets(buf,100,fp);		fgets(buf,100,fp);
		Sbuf=buf;		Sbuf=Sbuf.Left(Sbuf.GetLength()-2);
		*FreqFrom=atof(Sbuf.Mid(7));
		fgets(buf,100,fp);
		Sbuf=buf;		Sbuf=Sbuf.Left(Sbuf.GetLength()-2);
		*FreqTo=atof(Sbuf.Mid(7));
		fgets(buf,100,fp);		fgets(buf,100,fp);
		Sbuf=buf;
		fgets(buf,100,fp);
		j=0;
		double Patt[360]={0.0},Patt2[2][360]={0.0};
		for(i=0;i<360;i++)
		{
			fgets(buf,100,fp);
			Sbuf=buf;
			AttnH[i]=atof(Sbuf.Mid(4,5));
			AttnV[i]=atof(Sbuf.Mid(10,5));
			Patt[i]=i;
		}
		fclose(fp);
		Pol.TrimRight();
		CRecordset AntPatt;
		CString SQL;
		AntPatt.m_pDatabase=DB;
		SQL.Format(_T("select * from AntDiag where AntID=%ld"),AntID);
		AntPatt.Open(CRecordset::dynaset,SQL);
		if(AntPatt.GetRecordCount()>0)
		{
			SQL.Format(_T("Delete * from AntDiag where AntID=%ld"),AntID);
			DB->ExecuteSQL(SQL);
		}
		AntPatt.Close();
		if(Pol!=_T("V"))
		{
			if(Azimuth>=0)
			{
				i=359;
				while(Patt[i]>359-Azimuth && i>=0)			i--;
				if(i==-1) i=359;
				for(int j=i;j>=0;j--)			Patt[j]+=Azimuth;
				for(j=i+1;j<360;j++)			Patt[j]-=360-Azimuth;
			}
			else
			{
				i=0;
				while(Patt[i]<-Azimuth && i<360)			i++;
				if(i==360) i=0;
				for(int j=i;j<360;j++)			Patt[j]+=Azimuth;
				for(j=0;j<i;j++)				Patt[j]+=360+Azimuth;
			}
			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[j]]=AttnH[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "H", Patt2[1][i]);
				DB->ExecuteSQL(SQL);
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "V", AttnV[i]);
				DB->ExecuteSQL(SQL);
			}
		}
		if(Pol!=_T("H"))
		{
			if(Azimuth>=0)
			{
				i=359;
				while(Patt[i]>359-Azimuth && i>=0)			i--;
				if(i==-1) i=359;
				for(int j=i;j>=0;j--)			Patt[j]+=Azimuth;
				for(j=i+1;j<360;j++)			Patt[j]-=360-Azimuth;
			}
			else
			{
				i=0;
				while(Patt[i]<-Azimuth && i<360)			i++;
				if(i==360) i=0;
				for(int j=i;j<360;j++)			Patt[j]+=Azimuth;
				for(j=0;j<i;j++)				Patt[j]+=360+Azimuth;
			}
			for(j=0;j<360;j++)
			{
				Patt2[0][j]=(double)j;
				Patt2[1][(int)Patt[j]]=AttnH[j];
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "V", Patt2[1][i]);
				DB->ExecuteSQL(SQL);
			}
			for(i=0;i<360;i++)
			{
				SQL.Format(_T("INSERT INTO AntDiag ( AntID, Azm, Polar, Attn ) SELECT %ld, %lf, '%s', %lf"),
					AntID, (double)i, "H", AttnV[i]);
				DB->ExecuteSQL(SQL);
			}
		}
		return AntName;
	}
	return _T("");
}
*/

void CSMS4DCView::AddStation_disp(long ID,double lat1,double lon1,CString name1) 
{
	BeginWaitCursor();
	if (Num_ST==0)
	{
		Num_ST = 1;
		ID_ST = new long[Num_ST];
		Lat_ST = new double[Num_ST];
		Lon_ST = new double[Num_ST];
		Name_ST = new CString[Num_ST];
		m_STinfo = new CString[Num_ST];

		ID_ST[Num_ST-1] = ID;
		Lat_ST[Num_ST-1] = lat1;
		Lon_ST[Num_ST-1] = lon1;
		Name_ST[Num_ST-1] = name1;
		if(ID!=-999999)		m_STinfo[Num_ST-1] = IDst2Information(ID) ;
	}
	else
	{
		if(DispStationQ(ID,name1)==FALSE )
		{
			Num_ST = Num_ST + 1;
			long *ID_ST0 = new long[Num_ST];
			double *Lat_ST0 = new double[Num_ST];
			double *Lon_ST0 = new double[Num_ST];
			CString *Name_ST0 = new CString[Num_ST];
			CString *m_STinfo0 = new CString[Num_ST];

			for (int i=0;i<Num_ST-1;i++)
			{
				ID_ST0[i] = ID_ST[i];
				Lat_ST0[i] = Lat_ST[i];
				Lon_ST0[i] = Lon_ST[i];
				Name_ST0[i] = Name_ST[i];
				m_STinfo0[i] = m_STinfo[i];
			}
			ID_ST0[Num_ST-1] = ID;
			Lat_ST0[Num_ST-1] = lat1;
			Lon_ST0[Num_ST-1] = lon1;
			Name_ST0[Num_ST-1] = name1;
			if(ID!=-999999)		m_STinfo0[Num_ST-1] = IDst2Information(ID) ;

			delete [] ID_ST;	delete [] Lat_ST;		delete [] Lon_ST;		delete [] Name_ST;		delete [] m_STinfo;
			ID_ST = new long[Num_ST];
			Lat_ST = new double[Num_ST];
			Lon_ST = new double[Num_ST];
			Name_ST = new CString[Num_ST];
			m_STinfo = new CString[Num_ST];

			for ( i=0;i<Num_ST;i++)
			{
				ID_ST[i] = ID_ST0[i];
				Lat_ST[i] = Lat_ST0[i];
				Lon_ST[i] = Lon_ST0[i];
				Name_ST[i] = Name_ST0[i];

				m_STinfo[i] = m_STinfo0[i];
			}
			delete [] ID_ST0;	delete [] Lat_ST0;	delete [] Lon_ST0;	delete [] Name_ST0;		delete [] m_STinfo0;
		}
	}
	InvalidateRect(NULL,false);
	EndWaitCursor();
}

double CSMS4DCView::atof_kfactor(CString k1) 
{
	double k2 = 1.0;
	k1.Remove(' ');
	int n = k1.Find('/');
	if (n != -1)
	{
		int m = k1.GetLength();
		CString ss1 = k1.Left(n);
		CString ss2 = k1.Right(m-n-1);
		k2 = atof(ss1)/atof(ss2);
	}
	else
		k2 = atof(k1);

	return k2;
}

void CSMS4DCView::OnPropagationmodelsP370Link() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		CP370DLG p370dlg;
		p370dlg.m_RxShow=FALSE;
		if (p370dlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==2)
			{
				CString name1[2],m_Sel[2];
				CPoint pointst[2];
				double lat1[2],lon1[2];
				for (int i=0;i<2;i++)
				{
					m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					name1[i] = GetFld(m_Sel[i],2);
					lat1[i]  = atof(GetFld(m_Sel[i],3));
					lon1[i]  = atof(GetFld(m_Sel[i],4));
					LatLon2Point(lat1[i],lon1[i],&pointst[i]);
				}
				long x1=pointst[0].x;		long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;		long y2=1200-1-pointst[1].y;

				int xNmin = (min(x1 , x2) )-20;				int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;				int yNmax = (max(y1 , y2) )+20;
				int xN  = abs(xNmax - xNmin);  				int yN  = abs(yNmax - yNmin);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (P370)");
				CPro_P370_LinkDoc *pDocLinkP370=(CPro_P370_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (P370)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				pDocLinkP370->bufAreaW = xN;		pDocLinkP370->bufAreaH = yN;
				pDocLinkP370->bufAreaP370 = new _int16[xN*yN];
				for ( i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocLinkP370->bufAreaP370[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

				pDocLinkP370->m_NoData = (_int16)(pDoc->m_NoData);

				x1=pointst[0].x;		y1=pointst[0].y;
				x2=pointst[1].x;		y2=pointst[1].y;

				long xmin=min(x1 , x2);			long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);			long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLinkP370->Np=Np;
				pDocLinkP370->m_di=new double[Np];
				pDocLinkP370->m_hi=new double[Np];
				pDocLinkP370->m_lati=new double[Np];
				pDocLinkP370->m_loni=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP370->m_di[i]=rng[i];
					pDocLinkP370->m_lati[i]=y_en[i];
					pDocLinkP370->m_loni[i]=x_en[i];
					pDocLinkP370->m_hi[i]=hi1[i];
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP370->Hmin=Hmin;
				pDocLinkP370->Dmin=rng[0];
				pDocLinkP370->Dmax=rng[Np-1];
				pDocLinkP370->m_DrawFresnel = true;
				pDocLinkP370->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP370->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP370->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP370->LinkName_Rx = name1[1];
				pDocLinkP370->Linklat_Rx  = lat1[1];
				pDocLinkP370->Linklon_Rx  = lon1[1];
				pDocLinkP370->Linktime=p370dlg.m_time;
				pDocLinkP370->Linklocation=p370dlg.m_location;
				pDocLinkP370->Linkk=p370dlg.m_k;
				pDocLinkP370->Linksyst=p370dlg.m_syst;
				pDocLinkP370->Linkenvironment=p370dlg.m_env;
				pDocLinkP370->LinkClangle=p370dlg.m_Clangle;
				pDocLinkP370->Linklandsea=p370dlg.m_landsea;
				pDocLinkP370->LinkName_ST = name1[0];
				pDocLinkP370->Linklat_ST  = lat1[0];
				pDocLinkP370->Linklon_ST  = lon1[0];
				pDocLinkP370->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP370->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP370->LinkAZ_ST = atof(GetFld(m_Sel[0],8));
				pDocLinkP370->LinkEL_ST = atof(GetFld(m_Sel[0],9));
				pDocLinkP370->LinkANT_ST = GetFld(m_Sel[0],14);
				pDocLinkP370->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP370->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP370->Linklat0 = yUTM;
				pDocLinkP370->Linklon0 = xUTM;
				pDocLinkP370->m_Resolution_x = pDoc->m_Resolution_x;
				pDocLinkP370->TileInfo=pDoc->TileInfo;
				
				int Ierror = pDocLinkP370->GetData();
				pDocLinkP370->m_ReadyDoc=1;
				pDocLinkP370->UpdateAllViews(NULL);
				if(Ierror==1)pDocLinkP370->MissingAntena() ; 

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; 	delete [] x_en;		delete [] y_en;
			}
		}//p370dlg
	}//datadlg
}

void CSMS4DCView::OnPropagationmodelsP1546Link() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		CP1546DLG p1546dlg;
		p1546dlg.m_RxShow=FALSE;
		if (p1546dlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==2)
			{
				CString name1[2],m_Sel[2];
				CPoint pointst[2];
				double lat1[2],lon1[2];
				for (int i=0;i<2;i++)
				{
					m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					name1[i] = GetFld(m_Sel[i],2);
					lat1[i]  = atof(GetFld(m_Sel[i],3));
					lon1[i]  = atof(GetFld(m_Sel[i],4));
					LatLon2Point(lat1[i],lon1[i],&pointst[i]);
				}
				long x1=pointst[0].x;			long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;			long y2=1200-1-pointst[1].y;

				int xNmin = (min(x1 , x2) )-20;			int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;			int yNmax = (max(y1 , y2) )+20;
				int xN  = abs(xNmax - xNmin);  			int yN  = abs(yNmax - yNmin);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (P1546)");
				CPro_P1546_LinkDoc *pDocLinkP1546=(CPro_P1546_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (P1546)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				pDocLinkP1546->bufAreaW = xN;		pDocLinkP1546->bufAreaH = yN;
				pDocLinkP1546->bufAreaP1546 = new _int16[xN*yN];
				for ( i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocLinkP1546->bufAreaP1546[i+xN*j] = pDoc->buf[(yNmin+j)][(xNmin+i)];

				pDocLinkP1546->m_NoData = (_int16)(pDoc->m_NoData);

				x1=pointst[0].x;		y1=pointst[0].y;
				x2=pointst[1].x;		y2=pointst[1].y;

				long xmin=min(x1 , x2);			long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);			long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLinkP1546->Np=Np;
				pDocLinkP1546->m_di=new double[Np];
				pDocLinkP1546->m_hi=new double[Np];
				pDocLinkP1546->m_lati=new double[Np];
				pDocLinkP1546->m_loni=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP1546->m_di[i]=rng[i];
					pDocLinkP1546->m_lati[i]=y_en[i];
					pDocLinkP1546->m_loni[i]=x_en[i];
					pDocLinkP1546->m_hi[i]=hi1[i];
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP1546->Hmin=Hmin;
				pDocLinkP1546->Dmin=rng[0];
				pDocLinkP1546->Dmax=rng[Np-1];
				pDocLinkP1546->m_DrawFresnel = true;
				pDocLinkP1546->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP1546->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP1546->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP1546->LinkName_Rx = name1[1];
				pDocLinkP1546->Linklat_Rx  = lat1[1];
				pDocLinkP1546->Linklon_Rx  = lon1[1];
				pDocLinkP1546->Linktime=p1546dlg.m_time;
				pDocLinkP1546->Linklocation=p1546dlg.m_location;
				pDocLinkP1546->Linkk=p1546dlg.m_k;
				pDocLinkP1546->Linksyst=p1546dlg.m_syst;
				pDocLinkP1546->Linkenvironment=p1546dlg.m_env;
				pDocLinkP1546->LinkClangle=p1546dlg.m_Clangle;
				pDocLinkP1546->Linklandsea=p1546dlg.m_landsea;
				pDocLinkP1546->LinkName_ST = name1[0];
				pDocLinkP1546->Linklat_ST  = lat1[0];
				pDocLinkP1546->Linklon_ST  = lon1[0];
				pDocLinkP1546->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP1546->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP1546->LinkAZ_ST = atof(GetFld(m_Sel[0],8));
				pDocLinkP1546->LinkEL_ST = atof(GetFld(m_Sel[0],9));
				pDocLinkP1546->LinkANT_ST = GetFld(m_Sel[0],14);
				pDocLinkP1546->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP1546->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP1546->Linklat0 = yUTM;
				pDocLinkP1546->Linklon0 = xUTM;
				pDocLinkP1546->m_Resolution_x = pDoc->m_Resolution_x;
				pDocLinkP1546->TileInfo=pDoc->TileInfo;
			
				int Ierror = pDocLinkP1546->GetData();
				pDocLinkP1546->m_ReadyDoc = 1;
				pDocLinkP1546->UpdateAllViews(NULL);
				if(Ierror==1)	pDocLinkP1546->MissingAntena();

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; 	delete [] x_en;	delete [] y_en;
			}
		}//p1546dlg
	}//datadlg	
}

void CSMS4DCView::OnPropagationmodelsHataArea() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

		double Lat1, Lon1,Lat2, Lon2,Latst, Lonst,Frqst;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;

		CString Namest=GetFld(m_Sel,2);
		Latst=atof(GetFld(m_Sel,3));	Lonst=atof(GetFld(m_Sel,4));
		Frqst=atof(GetFld(m_Sel,6));

//		if( (Latst>=min(Lat1,Lat2)) && (Latst<=max(Lat1,Lat2)) && (Lonst>=min(Lon1,Lon2)) && (Lonst<=max(Lon1,Lon2)) )
		if(PointInArea(Latst,Lonst, Lat1, Lon1, Lat2, Lon2))
		{
			CHATADLG HATAdlg;
			HATAdlg.m_FRQ = Frqst;
			if (HATAdlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->xN = xN;		((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Area Calculation (HATA)");
				CPro_HATA_AreaDoc *pDocHATA=(CPro_HATA_AreaDoc *)	DocUtil::GetLastDocument("Area Calculation (HATA)");	

				pDocHATA->HATAk=HATAdlg.m_kfactor;
				pDocHATA->HATARxH=HATAdlg.m_Rx;
				pDocHATA->HATAenvironment=HATAdlg.m_ENV;
				pDocHATA->m_HATAa1 = HATAdlg.m_a10;
				pDocHATA->m_HATAa2 = HATAdlg.m_a20;
				pDocHATA->m_HATAa3 = HATAdlg.m_a30;
				pDocHATA->m_HATAb1 = HATAdlg.m_b10;
				pDocHATA->m_HATAb2 = HATAdlg.m_b20;
				pDocHATA->HATAName_ST = Namest;
				pDocHATA->HATAlat_ST  = Latst;
				pDocHATA->HATAlon_ST  = Lonst;
				pDocHATA->HATAHagl_ST = atof(GetFld(m_Sel,5));
				pDocHATA->HATAfMHz_ST = Frqst;
				pDocHATA->HATAPtGt_ST = atof(GetFld(m_Sel,7));
				pDocHATA->HATAAZ_ST = atof(GetFld(m_Sel,8));
				pDocHATA->HATAEL_ST = atof(GetFld(m_Sel,9));
				pDocHATA->HATAANT_ST = GetFld(m_Sel,14);
				pDocHATA->bufAreaW = xN;
				pDocHATA->bufAreaH = yN;
				pDocHATA->bufAreaHATA = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocHATA->bufAreaHATA[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocHATA->HATAlat0 = yUTM;
				pDocHATA->HATAlon0 = xUTM;
*/
pDocHATA->HATAlat0   = min(Lat1, Lat2);	pDocHATA->HATAlon0   = min(Lon1, Lon2);
pDocHATA->HATAlatmax = max(Lat1, Lat2);	pDocHATA->HATAlonmax = max(Lon1, Lon2);

				pDocHATA->TileInfo=pDoc->TileInfo;
				pDocHATA->m_Resolution_x = pDoc->m_Resolution_x;

				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocHATA->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocHATA->TileX = pDoc->TileX;
				pDocHATA->m_ReadyDoc=1;
				pDocHATA->GetData();
				pDocHATA->UpdateAllViews(NULL);
			}//HATAdlg
		}
		else
		{
			CString nst;
			nst.Format(_Z("The selected station '' %s ''  is not inside the selected area."),Namest);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdatePropagationmodelsHataArea(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnOkumurahataNetworkprocessorMaximumfieldstrength() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);			Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);			Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
		double Frqst=atof(GetFld(m_Sel[0],6));

//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CHATADLG HATAdlg;
			HATAdlg.m_FRQ = Frqst;
			if (HATAdlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->xN = xN;		((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Maximum Field Strength (HATA)");
				CPro_HATA_NetFDoc *pDocHATA=(CPro_HATA_NetFDoc *)	DocUtil::GetLastDocument("Maximum Field Strength (HATA)");	

				pDocHATA->HATAk=HATAdlg.m_kfactor;
				pDocHATA->HATARxH=HATAdlg.m_Rx;
				pDocHATA->HATAenvironment=HATAdlg.m_ENV;
				pDocHATA->m_HATAa1 = HATAdlg.m_a10;
				pDocHATA->m_HATAa2 = HATAdlg.m_a20;
				pDocHATA->m_HATAa3 = HATAdlg.m_a30;
				pDocHATA->m_HATAb1 = HATAdlg.m_b10;
				pDocHATA->m_HATAb2 = HATAdlg.m_b20;
				pDocHATA->Nrow = Nrow;
				pDocHATA->HATAlat_ST=new double[Nrow];
				pDocHATA->HATAlon_ST=new double[Nrow];
				pDocHATA->HATAHagl_ST=new double[Nrow];
				pDocHATA->HATAfMHz_ST=new double[Nrow];
				pDocHATA->HATAPtGt_ST=new double[Nrow];
				pDocHATA->HATAName_ST=new CString[Nrow];
				pDocHATA->HATAAZ_ST=new double[Nrow];
				pDocHATA->HATAEL_ST=new double[Nrow];
				pDocHATA->HATAANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocHATA->HATAName_ST[i1] = Namest[i1];
					pDocHATA->HATAlat_ST[i1]  = Latst[i1];
					pDocHATA->HATAlon_ST[i1]  = Lonst[i1];
					pDocHATA->HATAHagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocHATA->HATAfMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocHATA->HATAPtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocHATA->HATAAZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocHATA->HATAEL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocHATA->HATAANT_ST[i1] = GetFld(m_Sel[i1],14);
				}
				pDocHATA->bufAreaW = xN;
				pDocHATA->bufAreaH = yN;
				pDocHATA->bufAreaHATA = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocHATA->bufAreaHATA[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocHATA->HATAlat0 = yUTM;
				pDocHATA->HATAlon0 = xUTM;
*/
pDocHATA->HATAlat0   = min(Lat1, Lat2);	pDocHATA->HATAlon0   = min(Lon1, Lon2);
pDocHATA->HATAlatmax = max(Lat1, Lat2);	pDocHATA->HATAlonmax = max(Lon1, Lon2);

				pDocHATA->TileInfo=pDoc->TileInfo;
				pDocHATA->m_Resolution_x = pDoc->m_Resolution_x;

				double lat1234[4],lon1234[4];
				YX2LatLon(yNmin,xNmin,&lat1234[0],&lon1234[0]);
				YX2LatLon(yNmin,xNmin+(xN-1),&lat1234[1],&lon1234[1]);
				YX2LatLon(yNmin+(yN-1),xNmin+(xN-1),&lat1234[2],&lon1234[2]);
				YX2LatLon(yNmin+(yN-1),xNmin,&lat1234[3],&lon1234[3]);
				pDocHATA->m_AreaTotal = Area_km2(lat1234,lon1234,4);
pDocHATA->TileX = pDoc->TileX;
				pDocHATA->m_ReadyDoc=1;
				pDocHATA->GetData();
				pDocHATA->UpdateAllViews(NULL);
			}//HATAdlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}	
}
void CSMS4DCView::OnUpdateOkumurahataNetworkprocessorMaximumfieldstrength(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnOkumurahataNetworkprocessorBestserver() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
		CString *m_Sel;			m_Sel=new CString[Nrow];
		CString *Namest;		Namest=new CString[Nrow];
		double *Latst;			Latst=new double[Nrow];
		double *Lonst;			Lonst=new double[Nrow];
//		double Latst_min=200.0,Lonst_min=200.0,Latst_max=-200.0,Lonst_max=-200.0;
		double Lat1, Lon1,Lat2, Lon2;
		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
int uflag = 1;
		for (int i1=0;i1<Nrow;i1++)
		{
			m_Sel[i1]	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i1];
			Namest[i1] = GetFld(m_Sel[i1],2);
			Latst[i1] = atof(GetFld(m_Sel[i1],3));
			Lonst[i1] = atof(GetFld(m_Sel[i1],4));
//			Latst_min=min(Latst_min,Latst[i1]);			Latst_max=max(Latst_max,Latst[i1]);
//			Lonst_min=min(Lonst_min,Lonst[i1]);			Lonst_max=max(Lonst_max,Lonst[i1]);
uflag = uflag*PointInArea(Latst[i1],Lonst[i1], Lat1, Lon1, Lat2, Lon2);
		}
		double Frqst=atof(GetFld(m_Sel[0],6));

//		double Lat1, Lon1,Lat2, Lon2;
//		Point2LatLon(m_stBoxPoint, &Lat1, &Lon1) ;		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2) ;
//		if( (Latst_min>=min(Lat1,Lat2)) && (Latst_max<=max(Lat1,Lat2)) && (Lonst_min>=min(Lon1,Lon2)) && (Lonst_max<=max(Lon1,Lon2)) )
		if(uflag)
		{
			CHATADLG HATAdlg;
			HATAdlg.m_FRQ = Frqst;
			if (HATAdlg.DoModal()==IDOK)
			{
				int yst=1200-1-m_stBoxPoint.y;		int yen=1200-1-m_enBoxPoint.y;
				int xst=m_stBoxPoint.x;				int xen=m_enBoxPoint.x;
				int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
				int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
				xN=4*(xN/4);//		xNmin=4*(xNmin/4);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->xN = xN;		((CSMS4DCApp *)AfxGetApp())->yN = yN;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Best Server (HATA)");
				CPro_HATA_NetBDoc *pDocHATA=(CPro_HATA_NetBDoc *)	DocUtil::GetLastDocument("Best Server (HATA)");	

				pDocHATA->HATAk=HATAdlg.m_kfactor;
				pDocHATA->HATARxH=HATAdlg.m_Rx;
				pDocHATA->HATAenvironment=HATAdlg.m_ENV;
				pDocHATA->m_HATAa1 = HATAdlg.m_a10;
				pDocHATA->m_HATAa2 = HATAdlg.m_a20;
				pDocHATA->m_HATAa3 = HATAdlg.m_a30;
				pDocHATA->m_HATAb1 = HATAdlg.m_b10;
				pDocHATA->m_HATAb2 = HATAdlg.m_b20;
				pDocHATA->Nrow = Nrow;
				pDocHATA->HATAlat_ST=new double[Nrow];
				pDocHATA->HATAlon_ST=new double[Nrow];
				pDocHATA->HATAHagl_ST=new double[Nrow];
				pDocHATA->HATAfMHz_ST=new double[Nrow];
				pDocHATA->HATAPtGt_ST=new double[Nrow];
				pDocHATA->HATAName_ST=new CString[Nrow];
				pDocHATA->HATAAZ_ST=new double[Nrow];
				pDocHATA->HATAEL_ST=new double[Nrow];
				pDocHATA->HATAANT_ST=new CString[Nrow];
				for (int i1=0;i1<Nrow;i1++)
				{
					pDocHATA->HATAName_ST[i1] = Namest[i1];
					pDocHATA->HATAlat_ST[i1]  = Latst[i1];
					pDocHATA->HATAlon_ST[i1]  = Lonst[i1];
					pDocHATA->HATAHagl_ST[i1] = atof(GetFld(m_Sel[i1],5));
					pDocHATA->HATAfMHz_ST[i1] = atof(GetFld(m_Sel[i1],6));
					pDocHATA->HATAPtGt_ST[i1] = atof(GetFld(m_Sel[i1],7));
					pDocHATA->HATAAZ_ST[i1] = atof(GetFld(m_Sel[i1],8));
					pDocHATA->HATAEL_ST[i1] = atof(GetFld(m_Sel[i1],9));
					pDocHATA->HATAANT_ST[i1] = GetFld(m_Sel[i1],14);
				}
				pDocHATA->bufAreaW = xN;
				pDocHATA->bufAreaH = yN;
				pDocHATA->bufAreaHATA = new _int16[xN*yN];

				CSMS4DCDoc* pDoc = GetDocument();
				for (int i=0;i<xN;i++)
					for (int j=0;j<yN;j++)
						pDocHATA->bufAreaHATA[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];
/*		//97/12/21
				double xpm = xNmin + 600.0*(pDoc->TileX-1);
				double ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocHATA->HATAlat0 = yUTM;
				pDocHATA->HATAlon0 = xUTM;
*/
pDocHATA->HATAlat0   = min(Lat1, Lat2);	pDocHATA->HATAlon0   = min(Lon1, Lon2);
pDocHATA->HATAlatmax = max(Lat1, Lat2);	pDocHATA->HATAlonmax = max(Lon1, Lon2);

				pDocHATA->TileInfo=pDoc->TileInfo;
				pDocHATA->m_Resolution_x = pDoc->m_Resolution_x;
pDocHATA->TileX = pDoc->TileX;
				pDocHATA->m_ReadyDoc=1;
				pDocHATA->GetData();
				pDocHATA->UpdateAllViews(NULL);
			}//HATAdlg
		}
		else
		{
			CString NamestOut;
			for(int t1=0;t1<Nrow;t1++)
			{
//				if((Latst[t1]<min(Lat1,Lat2))||(Latst[t1]>max(Lat1,Lat2))||(Lonst[t1]<min(Lon1,Lon2))||(Lonst[t1]>max(Lon1,Lon2)))
				if(!PointInArea(Latst[t1],Lonst[t1], Lat1, Lon1, Lat2, Lon2))
					NamestOut = NamestOut +_T(",")+ Namest[t1];
			}
			NamestOut.Delete(0);
			CString nst;
			nst.Format(_Z("The selected station(s) '' %s ''  is(are) not inside the selected area."),NamestOut);
			MessageBox(nst,_Z("!!!  Warning  !!!"));
		}
	}//datadlg
///////////////////Close Legend//////////////////////////////
	if(m_LegendFlag)
	{	
		m_pLegendDLGModeless->PostNcDestroy();
		m_LegendFlag=false;
	}
}
void CSMS4DCView::OnUpdateOkumurahataNetworkprocessorBestserver(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnPropagationmodelsP452Link() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		CP452DLG p452dlg;
		if (p452dlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==2)
			{
				CString name1[2],m_Sel[2];
				CPoint pointst[2];
				double lat1[2],lon1[2];
				for (int i=0;i<2;i++)
				{
					m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					name1[i] = GetFld(m_Sel[i],2);
					lat1[i]  = atof(GetFld(m_Sel[i],3));
					lon1[i]  = atof(GetFld(m_Sel[i],4));
					LatLon2Point(lat1[i],lon1[i],&pointst[i]);
				}
				long x1=pointst[0].x;				long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;				long y2=1200-1-pointst[1].y;

				int xNmin = (min(x1 , x2) )-20;		int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;		int yNmax = (max(y1 , y2) )+20;
				int xN  = abs(xNmax - xNmin);  		int yN  = abs(yNmax - yNmin);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (P452)");
				CPro_P452_LinkDoc *pDocLinkP452=(CPro_P452_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (P452)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				x1=pointst[0].x;		y1=pointst[0].y;
				x2=pointst[1].x;		y2=pointst[1].y;

				long xmin=min(x1 , x2);		long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);		long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;

				pDocLinkP452->Np=Np;
				pDocLinkP452->m_di=new double[Np];
				pDocLinkP452->m_hi=new double[Np];
				pDocLinkP452->m_lati=new double[Np];
				pDocLinkP452->m_loni=new double[Np];
				pDocLinkP452->m_hikm=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP452->m_di[i]=rng[i];
					pDocLinkP452->m_lati[i]=y_en[i];
					pDocLinkP452->m_loni[i]=x_en[i];
					pDocLinkP452->m_hi[i]=hi1[i];
					pDocLinkP452->m_hikm[i]=hi1[i]/1000.0;
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP452->Hmin=Hmin;
				pDocLinkP452->Dmin=rng[0];
				pDocLinkP452->Dmax=rng[Np-1];
				pDocLinkP452->m_DrawFresnel = true;
				pDocLinkP452->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP452->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP452->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP452->LinkName_Rx = name1[1];
				pDocLinkP452->Linklat_Rx  = lat1[1];
				pDocLinkP452->Linklon_Rx  = lon1[1];
				pDocLinkP452->Linktime=p452dlg.m_time;
		//		pDocLinkP452->Linkbeta=p452dlg.m_beta_e;	pDocLinkP452->LinkdN=p452dlg.m_dN;	pDocLinkP452->LinkN0=p452dlg.m_N0;
				///////////////////////////////////////////////////////P452.15
				pDocLinkP452->m_Pressure   = p452dlg.m_Pressure;
				pDocLinkP452->m_TempC      = p452dlg.m_TempC;
				pDocLinkP452->m_ha_Clutter = p452dlg.m_ha_Clutter;
				pDocLinkP452->m_dk_Clutter = p452dlg.m_dk_Clutter;
				pDocLinkP452->m_flagAvWo   = p452dlg.m_flagAvWo;
				pDocLinkP452->m_PolarizationTx = GetFld(m_Sel[0],13);

				pDocLinkP452->LinkName_ST = name1[0];
				pDocLinkP452->Linklat_ST  = lat1[0];
				pDocLinkP452->Linklon_ST  = lon1[0];
				pDocLinkP452->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP452->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP452->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));
				pDocLinkP452->LinkfMHz_Rx = atof(GetFld(m_Sel[1],21));
	//			pDocLinkP452->LinkfMHz_Rx = atof(GetFld(m_Sel[1],6));
				pDocLinkP452->ID_Tx = atol(GetFld(m_Sel[0],1));
				pDocLinkP452->ID_Rx = atol(GetFld(m_Sel[1],1));
				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP452->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP452->Linklat0 = yUTM;
				pDocLinkP452->Linklon0 = xUTM;
				pDocLinkP452->m_ReadyDoc=1;
				int status = pDocLinkP452->GetData();
								
				if(status>0)		MessageBox(pDocLinkP452->m_tit, _Z("ERROR!!!"), MB_ICONERROR);

				pDocLinkP452->UpdateAllViews(NULL);

				delete [] X;	delete [] Y;	delete [] hi1;		delete [] hi;	delete [] rng; delete [] x_en;		delete [] y_en;
			}
		}//p452dlg
	}//datadlg		
}

void CSMS4DCView::OnPropagationmodelsP526Link() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		CKFactor P526dlg;
		if (P526dlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==2)
			{
				CString name1[2],m_Sel[2];
				CPoint pointst[2];
				double lat1[2],lon1[2];
				for (int i=0;i<2;i++)
				{
					m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					name1[i] = GetFld(m_Sel[i],2);
					lat1[i]  = atof(GetFld(m_Sel[i],3));
					lon1[i]  = atof(GetFld(m_Sel[i],4));
					LatLon2Point(lat1[i],lon1[i],&pointst[i]);
				}
				long x1=pointst[0].x;				long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;				long y2=1200-1-pointst[1].y;
				int xNmin = (min(x1 , x2) )-20;		int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;		int yNmax = (max(y1 , y2) )+20;
				int xN  = abs(xNmax - xNmin);  		int yN  = abs(yNmax - yNmin);

				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (P526)");
				CPro_P526_LinkDoc *pDocLinkP526=(CPro_P526_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (P526)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				x1=pointst[0].x;		y1=pointst[0].y;
				x2=pointst[1].x;		y2=pointst[1].y;
				long xmin=min(x1 , x2);		long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);		long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLinkP526->Np=Np;
				pDocLinkP526->m_di=new double[Np];
				pDocLinkP526->m_hi=new double[Np];
				pDocLinkP526->m_hikm=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP526->m_di[i]=rng[i];
					pDocLinkP526->m_hi[i]=hi1[i];
					pDocLinkP526->m_hikm[i]=hi1[i]/1000.0;
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP526->Hmin=Hmin;
				pDocLinkP526->Dmin=rng[0];
				pDocLinkP526->Dmax=rng[Np-1];
				pDocLinkP526->m_DrawFresnel = true;
				pDocLinkP526->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP526->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP526->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP526->LinkName_Rx = name1[1];
				pDocLinkP526->Linklat_Rx  = lat1[1];
				pDocLinkP526->Linklon_Rx  = lon1[1];
				pDocLinkP526->m_kfactor=P526dlg.m_kfactorEdit;
				pDocLinkP526->LinkName_ST = name1[0];
				pDocLinkP526->Linklat_ST  = lat1[0];
				pDocLinkP526->Linklon_ST  = lon1[0];
				pDocLinkP526->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP526->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP526->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP526->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP526->Linklat0 = yUTM;
				pDocLinkP526->Linklon0 = xUTM;
				pDocLinkP526->m_ReadyDoc=1;
				pDocLinkP526->GetData();
				pDocLinkP526->UpdateAllViews(NULL);

				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;		delete [] y_en;
			}
		}//P526dlg
	}//datadlg			
}

void CSMS4DCView::OnCalculationHorizondistance() {	CHorizonDistanceDLG dlg;	dlg.DoModal();}
void CSMS4DCView::OnCalculationIntermodulation() {	CInterModDLG dlg;			dlg.DoModal();}

void CSMS4DCView::OnCoordinationGe84bc2bc() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CString CDataBaseSTR;
//		CDataBaseSTR.Format(_T("select * from GE84BC2BC where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),CTYdlg.m_code,_T("BC"));
		CDataBaseSTR.Format(_T("select * from %s where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),m_qGE84BC2BC,CTYdlg.m_code,_T("BC"));
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Heff1 = TRUE;
		datadlg.m_Title = _Z("Wanted Station");

		if (datadlg.DoModal()==IDOK)
		{
			BeginWaitCursor();
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
			{
				CString name1,m_Sel, fmtv_terra_polar, ant_dir;
				double lat0,lon0,Hagl_ST, /*pi = 4.0*atan(1.0),*/
						erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw, Power, eff_hgtmax;
				double	attnH,attnV, h10[37], attH0[37], attV0[37], Hg;
				long  AntID , terrakey;
				int az0[37];

				m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				terrakey = atol(GetFld(m_Sel,1));
				AntID = atol(GetFld(m_Sel,30));
				name1 = GetFld(m_Sel,4);				name1.TrimRight();
				lat0 = atof(GetFld(m_Sel,5));
				lon0  = atof(GetFld(m_Sel,6));
				Hagl_ST = atof(GetFld(m_Sel,7));
				fmtv_terra_polar = GetFld(m_Sel,8);		fmtv_terra_polar.TrimRight();
				erp_dbw = atof(GetFld(m_Sel,9));
				erp_h_dbw = atof(GetFld(m_Sel,10));
				erp_v_dbw = atof(GetFld(m_Sel,11));
				ant_dir = GetFld(m_Sel,12);				ant_dir.TrimRight();
				eff_hgtmax = atof(GetFld(m_Sel,20));
				if(datadlg.m_Heff1)
				{
					OnDatabaseStationsindesktop2(lat0, lon0);
					Hg = LatLon2Hg(lat0,lon0) ;
				}
				else
				{
					Hg = atof(GetFld(m_Sel,13));
					GE84Heff(AntID,eff_hgtmax,h10) ;
				//	GE84Heff(terrakey,eff_hgtmax,h10) ;
				}
				for(int i=0;i<36;i++)		az0[i] = 10*i;
				if(ant_dir==_T("D"))
					GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
				else
					for(int i=0;i<36;i++)
					{
						attH0[i] = 0;		attV0[i] = 0;
					}
				az0[36] = 360;			h10[36] = h10[0];
				attH0[36] = attH0[0];	attV0[36] = attV0[0];

				float RLON = (float)(lon0*pi/180.0),
					  RLAT = (float)(lat0*pi/180.0),
					  RANGE = 1500.0,
					  RDIST,	RAZIM, 	  RLONb,	RLATb,
					  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

				long IVAL = 1, IRANGE = 1500;
				GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

				CString cty1("");
				GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

				long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
				unsigned char CTYCOD[1500];
				short KMCTY[1000];
				GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
									 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
				if(IREST==-1)
				{
					cty1 = CTYdlg.m_code;
					GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
										 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
				}
				char temp[4];
				if(NOCTY>0)
				{
					CString m_CTY, Affected, REGION, str = "",	str1 = "";
					int k = 0;
					double DM = 0.0, h1;
					CPoint m_Point_STcr3,m_Point_STcr15;
					double Dland ,DseaW ,DseaC ,Dsuper; 
					double DcordL,DcordC,DcordW,DcordS;
					CGE84_Functions GE84x;
					CString RLONbs,RLATbs;
					double lat3km,lon3km,lat15km,lon15km;

					for(int i=0;i<NOCTY ;i++)
					{
						temp[0]=CTYCOD[3*i];
						temp[1]=CTYCOD[3*i+1];
						temp[2]=CTYCOD[3*i+2];
						temp[3]=0;
						m_CTY = temp;

						if(GE84x.CTRY_Check(m_CTY))
						{
							GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
							if(RDIST<=RANGE)
							{
								GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
								/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
								if(cty1!=m_CTY)
								{
									if(datadlg.m_Heff1)
									{
										reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
										reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
										double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
										h1 = Hg + Hagl_ST - hv1 ;
									}
									else
										h1 = Interp2(az0,h10,RAZIM,37) ;
									/////////////////////////////////////////////////////////////////////////////////////
									SuperRefract50(lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi, &Dland,&DseaW,&DseaC,&Dsuper) ;

									attnH = Interp2(az0,attH0,RAZIM,37) ;
									attnV = Interp2(az0,attV0,RAZIM,37) ;
									if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
									else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
									else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));
									Power = pow(10.0,erpdbw/10.0);

									double h11 = h1;
									h1 = min(1800.0,max(10.0,h1));
									DcordL = GE84x.GE84_1(1,Power, h1);
									DcordC = GE84x.GE84_1(2,Power, h1);
									DcordW = GE84x.GE84_1(3,Power, h1);
									DcordS = GE84x.GE84_1(4,Power, h1);

									DM = (Dland*DcordL + DseaC*DcordC + DseaW*DcordW + Dsuper*DcordS)/RDIST;
									if(RDIST<=DM)	Affected = _T("+++");
									else			Affected = _T("---");
									
									if(Affected != _T("---"))
									{
										k++;
										GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
										Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
										str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%s,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,DM,h11,"87.5 - 108",REGION);
										str1 = str1 + _T(",") + str;
									}

								}	//end if(RDIST!=0)
							}	//end if(RDIST<RANGE)

						}	//if(GE84x.CTRY_Check(m_CTY))

					}	//end for

					CString assignIDX = GetFld(m_Sel,2);

					str1.Delete(0);
					CGE84BC2BCDLG dlgList;
			//		dlgList.m_title = _T("GE84 BC to BC - Coordination Distance     (AssignID = ")+assignIDX+_T(")");
					dlgList.m_title = _Z("GE84 BC to BC - Coordination Distance");
					dlgList.m_nROWS = k+1+0;
					Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
			//		str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s"," ",cty1,RLONbs,RLATbs,"Name:",name1," "," "," "," ");
					str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
					str1 = str + _T(",") + str1;
					dlgList.m_data = str1;
					dlgList.DoModal();

				}	//end if(NOCTY>0)
			}	//end if (Nrow==1)

		}	//end datadlg

		Set_STtable_Default();
		EndWaitCursor();
	}	//end CTYdlg
}

void CSMS4DCView::GE84Heff(long terrakey,double eff_hgtmax,double * Heff) 
{
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase m_mydb;
	if (m_mydb.Open(_T(m_DB),FALSE,FALSE, _T("ODBC;"), FALSE))
	{
		int i , m_NUM = 36; 

		CRecordset m_rs;
		CString	ss , m_Tbl ;
//		m_Tbl.Format("select * from fmtv_ant_hgt WHERE (terrakey=%ld) order by azm;",terrakey);
		m_Tbl.Format("select * from anthgt WHERE (AntID=%ld) order by azm;",terrakey);
		m_rs.m_pDatabase = &m_mydb;
		m_rs.Open( CRecordset::snapshot, m_Tbl);

		long RecCount=m_rs.GetRecordCount();
		if(RecCount>0)
		{
			m_rs.MoveFirst();
			for (i=0;i<m_NUM;i++)
			{
				m_rs.GetFieldValue((short)2,ss);	Heff[i] = atof(ss);
				m_rs.MoveNext();
			}
		}
		else
		{
			for (i=0;i<m_NUM;i++)	Heff[i] = eff_hgtmax;
		}
		m_rs.Close();	m_mydb.Close();
	}
}

void CSMS4DCView::GE84pattern(long terrakey,double * attnH,double * attnV,CString pol) 
{
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase m_mydb;
	if (m_mydb.Open(_T(m_DB),FALSE,FALSE, "ODBC;", FALSE))
	{
		int kH, kV, i; 
		CString ss;
		int azmH[361], azmV[361];
		double attnH0[361] , attnV0[361];

		if((pol==_T("H"))||(pol==_T("M"))||(pol==_T("U")))
		{
			CRecordset m_rs;
			CString	m_Tbl ;
//			m_Tbl.Format("select * from fmtv_ant_diag WHERE (terrakey=%ld AND polar=\'%s\') order by azm;",terrakey,"H");
			m_Tbl.Format("select * from antdiag WHERE (AntID=%ld AND polar=\'%s\') order by azm;",terrakey,_T("H"));
			m_rs.m_pDatabase = &m_mydb;
			m_rs.Open( CRecordset::snapshot, m_Tbl);
			kH=0;
			if(m_rs.GetRecordCount()==1)
			{
				while(!m_rs.IsEOF())
				{
					m_rs.MoveNext();			kH++;
				}
				m_rs.MoveFirst();
				for (i=0;i<kH;i++)
				{
					m_rs.GetFieldValue((short)1,ss);	azmH[i] = atof(ss);
					m_rs.GetFieldValue((short)3,ss);	attnH0[i] = atof(ss);
					if(pol=="H")
					{
						attnV0[i] = 0.0;	azmV[i] = azmH[i];
					}
					m_rs.MoveNext();
				}
				m_rs.Close();
			}
			else
			{
				CString str1;
				str1.Format(_Z("\nThe Antenna Pattern is not found!!!      \n Antenna ID : ''  %ld  '' \n Polarization : ''  %s  ''\n Please assign a valid antenna.\n"),terrakey,pol);
				MessageBox(str1,_Z("Error!!!"), MB_ICONERROR);
				exit(1);
			}
		}
		if((pol==_T("V"))||(pol==_T("M"))||(pol==_T("U")))
		{
			CRecordset m_rs1;
			CString	m_Tbl1 ;
	//		m_Tbl1.Format("select * from fmtv_ant_diag WHERE (terrakey=%ld AND polar=\'%s\') order by azm;",terrakey,"V");
			m_Tbl1.Format("select * from antdiag WHERE (AntID=%ld AND polar=\'%s\') order by azm;",terrakey,_T("V"));
			m_rs1.m_pDatabase = &m_mydb;
			m_rs1.Open( CRecordset::snapshot, m_Tbl1);
			kV = 0;
			if(m_rs1.GetRecordCount()==1)
			{
				while(!m_rs1.IsEOF())
				{
					m_rs1.MoveNext();		kV++;
				}
				m_rs1.MoveFirst();
				for (i=0;i<kV;i++)
				{
					m_rs1.GetFieldValue((short)1,ss);	azmV[i] = atof(ss);
					m_rs1.GetFieldValue((short)3,ss);	attnV0[i] = atof(ss);
					if(pol==_T("V"))
					{
						attnH0[i]=0.0;		azmH[i] = azmV[i];
					}
					m_rs1.MoveNext();
				}
				m_rs1.Close();
			}
			else
			{
				CString str1;
				str1.Format(_Z("\nThe Antenna Pattern is not found!!!      \n Antenna ID : ''  %ld  '' \n Polarization : ''  %s  ''\n Please assign a valid antenna.\n"),terrakey,pol);
				MessageBox(str1,_Z("Error!!!"), MB_ICONERROR);
				exit(1);
			}
		}
		m_mydb.Close();

		if(pol=="H")	kV = kH;
		if(pol=="V")	kH = kV;
		azmH[kH] = 360;				azmV[kV] = 360;
		attnH0[kH] = attnH0[0];		attnV0[kV] = attnV0[0];

		int m_NUM = 36; 
		for (i=0;i<m_NUM;i++)
		{
			attnH[i] = Interp2(azmH,attnH0,i*360/m_NUM,kH+1) ;
			attnV[i] = Interp2(azmV,attnV0,i*360/m_NUM,kV+1) ;
		}
	}	
}

int CSMS4DCView::WarmColdSea(double RLON_deg,double RLAT_deg) 
{
	int nFlag = 0;  //"Cold Sea"

	if ((((RLON_deg>=2.0 && RLON_deg<=42.0)&&(RLAT_deg>=30.0 && RLAT_deg<=48.0))||
		((RLON_deg>=-5.6 && RLON_deg<=2.0)&&(RLAT_deg>=30.0 && RLAT_deg<=42.0)))||(RLAT_deg<=30.0))
		nFlag = 1;  // "Warm Sea"

	return nFlag;
}

void CSMS4DCView::WarmColdCross(double RLON_deg1,double RLAT_deg1,double RLON_deg2,double RLAT_deg2,
						  double *RLON_degcross,double *RLAT_degcross) 
{
	double lon1,lon2,lat1,lat2,lon1p,lon2p,lat1p,lat2p;
	lon1=min(RLON_deg1,RLON_deg2);	lon2=max(RLON_deg1,RLON_deg2);
	lat1=min(RLAT_deg1,RLAT_deg2);	lat2=max(RLAT_deg1,RLAT_deg2);
	lon1p = lon1;	lon2p = lon2;	lat1p = lat1;	lat2p = lat2;
	if ((lat1<30.0)&&(lat2>30.0))
	{
		lon1p = max((lon1-1.0),-180.0);		lon2p = min((lon2+1.0), 180.0);
		lat1p = 30.0;						lat2p = 30.0;
	}
	else if ((lon1<-5.6)&&(lon2>-5.6))
	{
		lon1p = -5.6;					lon2p = -5.6;
		lat1p = max((lat1-1.0),-90.0);	lat2p = min((lat2+1.0), 90.0);
	}
//	double pi = 4.0*atan(1.0);
	float RLON1 = (float)(RLON_deg1*pi/180.0),  RLAT1 = (float)(RLAT_deg1*pi/180.0),
		  RLON2 = (float)(RLON_deg2*pi/180.0),  RLAT2 = (float)(RLAT_deg2*pi/180.0);

	float RLON10 = (float)(lon1p*pi/180.0),		RLAT10 = (float)(lat1p*pi/180.0),
		  RLON20 = (float)(lon2p*pi/180.0),		RLAT20 = (float)(lat2p*pi/180.0);

	float CRDLN1[2][2] = {RLON1, RLAT1, RLON2, RLAT2};
	float CRDLN2[2][2] = {RLON10, RLAT10, RLON20, RLAT20};
	float CROSVEK[1][2];

	long NRPNT1 = 2, NRPNT2 = 2, C180=0, IEND=0, MAXCROS=100, CROSS, IREST;
	GEOC2L( (float *)CRDLN1, &NRPNT1, (float *)CRDLN2, &NRPNT2,
						&C180, &IEND, (float *)CROSVEK,  &MAXCROS, &CROSS, &IREST);
	if(CROSS>0)
	{
		*RLON_degcross = CROSVEK[0][0]*180.0/pi;
		*RLAT_degcross = CROSVEK[0][1]*180.0/pi;
	}
}

void CSMS4DCView::WarmSuperCross(double RLON_deg1,double RLAT_deg1,double RLON_deg2,double RLAT_deg2,
						  double *RLON_degcross,double *RLAT_degcross) 
{
//	double pi = 4.0*atan(1.0);
	float RLON1 = (float)(RLON_deg1*pi/180.0),	  RLAT1 = (float)(RLAT_deg1*pi/180.0),
		  RLON2 = (float)(RLON_deg2*pi/180.0),	  RLAT2 = (float)(RLAT_deg2*pi/180.0);

	float RLON10 = (float)(61.5953*pi/180.0),	  RLAT10 = (float)(25.2186*pi/180.0),
		  RLON20 = (float)(59.681*pi/180.0),	  RLAT20 = (float)(22.0*pi/180.0);

	float CRDLN1[2][2] = {RLON1, RLAT1, RLON2, RLAT2};
	float CRDLN2[2][2] = {RLON10, RLAT10, RLON20, RLAT20};
	float CROSVEK[1][2];

	long NRPNT1 = 2, NRPNT2 = 2, C180=0, IEND=0, MAXCROS=100, CROSS, IREST;
	GEOC2L( (float *)CRDLN1, &NRPNT1, (float *)CRDLN2, &NRPNT2,
						&C180, &IEND, (float *)CROSVEK,  &MAXCROS, &CROSS, &IREST);
	if(CROSS>0)
	{
		*RLON_degcross = CROSVEK[0][0]*180.0/pi;
		*RLAT_degcross = CROSVEK[0][1]*180.0/pi;
	}
}
void CSMS4DCView::Rad2Str(float lonRAD,float latRAD,CString *lonSTR,CString *latSTR) 
{
	unsigned char COORD[15];
	CRADDG4( &lonRAD, &latRAD, COORD );
	CString COORD1 = COORD;
	COORD1 = COORD1.Left(15);
	*lonSTR = COORD1.Left(8);
	*latSTR = COORD1.Right(7);
}

double CSMS4DCView::Interp2(int *D0,double *E0,double d,int num) 
{
	double Eb = InterpT(D0,E0,d,num,0) ;
	return Eb;
/*
	double d1,d2,E1,E2,Eb;
	if (d<D0[0])
	{
		d1=D0[0];	d2=D0[1];	E1=E0[0];	E2=E0[1];
	}
	else if (d>D0[num-1])
	{
		d1=D0[num-2];	d2=D0[num-1];	E1=E0[num-2];	E2=E0[num-1];
	}
	else
	{
		/////////////////////////////////////////////
		int n1=0;
		while(d>=D0[n1])
		{
			n1++;
			if (n1==num)	break;
		}
		if (n1==0)	n1=1;
		d1=D0[n1-1];E1=E0[n1-1];
		///////////////////////////////////////////////
		int n2=num-1;
		while(d<=D0[n2])
			n2--;
		d2=D0[n2+1];E2=E0[n2+1];
		////////////////////////////////////////////////
	}
	Eb=((d1==d2) ? E1 : E1+(E2-E1)*(d-d1)/(d2-d1));
	return Eb;  */
}

double CSMS4DCView::LatLon2Hg(double lat_deg,double lon_deg) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument();
	double x_en,y_en;

	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo == globeTileInfo)
	{
lon_deg = ((CSMS4DCApp *)AfxGetApp())->ChangeLon(lon_deg,pDoc->TileX);
		y_en = lat_deg + pDoc->m_Resolution_y/2.0;
		x_en = lon_deg + pDoc->m_Resolution_x/2.0;
	}
	else
	{
		CUtm m_utm;
		m_utm.phi = lat_deg;
		m_utm.lambda = lon_deg;
		m_utm.philambda2UTM();
		double yUTM = m_utm.y;
		double xUTM = m_utm.x;
		y_en = yUTM + pDoc->m_Resolution_y/2.0;
		x_en = xUTM + pDoc->m_Resolution_x/2.0;
	}
	double ypm= 1.0+(y_en - pDoc->m_Lower_left_y)/ pDoc->m_Resolution_y;
	double xpm= 1.0+(x_en - pDoc->m_Lower_left_x)/ pDoc->m_Resolution_x;
	double yps = ypm - 600.0*(pDoc->TileY-1.0);
	double xps = xpm - 600.0*(pDoc->TileX-1.0);
	double z = RoundBUF_Hg(xps, yps);
	return z;
}

double CSMS4DCView::Points2HgAvr1(double lat1, double lon1, double lat2,  double lon2, long n) 
{
	double az = Azimuth_Deg( lat1, lon1, lat2, lon2) ;
	double dist = Distance_km( lat1, lon1, lat2, lon2) ;
	if(dist<0.0001)	return LatLon2Hg(lat1, lon1); 

	double latkm  , lonkm , d = 0.0 , Hv =0.0,  step = dist/n;
	long k = 0;
	while(d<dist+0.0000001)
	{
		reckon( lat1, lon1,  d , az , &latkm  , &lonkm) ;
		Hv = Hv + LatLon2Hg_n(latkm, lonkm);	//98/01/10
		d = d + step;							//98/01/10
//		d = d + dist/n;
		k++;
	}
//	double n2 = (double)(k-1);
	Hv = Hv/k;
	return Hv;
}

void CSMS4DCView::OnCoordinationGe84bc2bt() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CString CDataBaseSTR;
///		CDataBaseSTR.Format("select * from GE84BC2BC where ctry=\'%s\'",CTYdlg.m_code);
//		CDataBaseSTR.Format(_T("select * from GE84BC2BC where ((ctry=\'%s\') AND (stn_cls=\'%s\'))") ,CTYdlg.m_code,_T("BC"));
		CDataBaseSTR.Format(_T("select * from %s where ((ctry=\'%s\') AND (stn_cls=\'%s\'))") ,m_qGE84BC2BC,CTYdlg.m_code,_T("BC"));

		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Heff1 = TRUE;
		datadlg.m_Title = _Z("Wanted Station");
		if (datadlg.DoModal()==IDOK)
		{
			BeginWaitCursor();
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
			{
				CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				double freq_assgn = atof(GetFld(m_Sel,14));
				if((freq_assgn>=87.6)&&(freq_assgn<=99.9))
				{
					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0,Hagl_ST, /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw, Power, eff_hgtmax;

					double attnH,attnV, h10[37], attH0[37], attV0[37], Hg;
					long AntID ,terrakey;
					int az0[37];

					terrakey = atol(GetFld(m_Sel,1));
					name1 = GetFld(m_Sel,4);			name1.TrimRight();
					lat0 = atof(GetFld(m_Sel,5));
					lon0  = atof(GetFld(m_Sel,6));
					Hagl_ST = atof(GetFld(m_Sel,7));
					fmtv_terra_polar = GetFld(m_Sel,8);	fmtv_terra_polar.TrimRight();
					erp_dbw = atof(GetFld(m_Sel,9));
					erp_h_dbw = atof(GetFld(m_Sel,10));
					erp_v_dbw = atof(GetFld(m_Sel,11));
					ant_dir = GetFld(m_Sel,12);			ant_dir.TrimRight();
					eff_hgtmax = atof(GetFld(m_Sel,20));
					AntID = atol(GetFld(m_Sel,30));
					if(datadlg.m_Heff1)
					{
						OnDatabaseStationsindesktop2(lat0, lon0);
						Hg = LatLon2Hg(lat0,lon0) ;
					}
					else
					{
						Hg = atof(GetFld(m_Sel,13));
					//	GE84Heff(terrakey,eff_hgtmax,h10) ;
						GE84Heff(AntID,eff_hgtmax,h10) ;
					}
					for(int i=0;i<36;i++)		az0[i] = 10*i;
					if(ant_dir==_T("D"))
						GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
					else
						for(int i=0;i<36;i++)
						{
							attH0[i] = 0;		attV0[i] = 0;
						}
					az0[36] = 360;				h10[36] = h10[0];
					attH0[36] = attH0[0];		attV0[36] = attV0[0];
				
					float RLON = (float)(lon0*pi/180.0),
						  RLAT = (float)(lat0*pi/180.0),
						  RANGE = 1500.0,
						  RDIST,	RAZIM, 	  RLONb,	RLATb,
						  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

					long IVAL = 1, IRANGE = 1500;
					GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

					CString cty1("");
			//		GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;
					cty1 = CTYdlg.m_code;

					long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
					unsigned char CTYCOD[1500];
					short KMCTY[1000];
					GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
										 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					if(IREST==-1)
					{
						cty1 = CTYdlg.m_code;
						GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
											 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					}
					char temp[4];

					if(NOCTY>0)
					{
						CString m_CTY, Affected, REGION, str = "",	str1 = "";
						int k = 0;
						double DM = 0.0, h1;
						CPoint m_Point_STcr3,m_Point_STcr15;
						double lat3km,lon3km,lat15km,lon15km;
						double Dland ,Dsea ,DseaW ,DseaC , DcordL,DcordC,DcordW; 
						CGE84_Functions GE84x;
						CString RLONbs,RLATbs;
						CST61_Functions ST61x;
						for(int i=0;i<NOCTY ;i++)
						{
							temp[0]=CTYCOD[3*i];
							temp[1]=CTYCOD[3*i+1];
							temp[2]=CTYCOD[3*i+2];
							temp[3]=0;
							m_CTY=temp;

							GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
							if(RDIST<=RANGE)
							{
								GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
								/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
								if(cty1!=m_CTY)
								{
									if(datadlg.m_Heff1)
									{
										reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
										reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
										double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
										h1 = Hg + Hagl_ST - hv1 ;
									}
									else
										h1 = Interp2(az0,h10,RAZIM,37) ;
							
									/////////////////////////////////////////////////////////////////////////////////////
									CoastalArea(lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi,
															  &Dland ,&Dsea ,&DseaW) ;
									DseaC = Dsea - DseaW;
							
									attnH = Interp2(az0,attH0,RAZIM,37) ;
									attnV = Interp2(az0,attV0,RAZIM,37) ;
									if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
									else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
									else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));
							
									Power = pow(10.0,erpdbw/10.0);
									double h11 = h1;
									h1 = min(1800.0,max(10.0,h1));
									DcordL = GE84x.GE84_BT1(1,Power, h1, freq_assgn);
									DcordC = GE84x.GE84_BT1(2,Power, h1, freq_assgn);
									DcordW = GE84x.GE84_BT1(3,Power, h1, freq_assgn);

									DM = (Dland*DcordL + DseaC*DcordC + DseaW*DcordW)/RDIST;
									if(RDIST<=DM)	Affected = _T("+++");
									else			Affected = _T("---");

									BOOL member = ST61x.CTRY_Check(m_CTY);
									if((member)&&(Affected != _T("---")))
									{
										k++;
										GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
										Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
										str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%s,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,DM,h11,"87.5 - 100",REGION);
										str1=str1+","+str;
									}

								}	//end if(RDIST!=0)
							}	//end if(RDIST<RANGE)
						}	//end for
						CString assignIDX = GetFld(m_Sel,2);

						str1.Delete(0);
						CGE84BC2BCDLG dlgList;
						dlgList.m_title = _Z("GE84 BC to BT ST61 - Coordination Distance");
						dlgList.m_nROWS = k+1+0;
						Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
						str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
						str1=str+","+str1;
						dlgList.m_data = str1;
						dlgList.DoModal();

					}	//end if(NOCTY>0)

				}	//end if freq_assgn

			}	//end if (Nrow==1)
		}	//end datadlg

		Set_STtable_Default();
		EndWaitCursor();
	}	//end CTYdlg	
}

void CSMS4DCView::CoastalArea(double lat01,double lon01,double lat02,double lon02,
							  double *Dland1 ,double *Dsea1 ,double *DseaW1 ) 
{
	double Dland = 0.0,Dsea = 0.0,DseaW = 0.0;
	*Dland1 = Dland ,*Dsea1 =Dsea ,*DseaW1 =DseaW; 
	float pi = (float)(4.0*atan(1.0));

	float RLON1 = (float)(lon01*pi/180.f), RLAT1 = (float)(lat01*pi/180.f),
		  RLON2 = (float)(lon02*pi/180.f), RLAT2 = (float)(lat02*pi/180.f); 

	float RDIST, RAZIM;
	GEOPPDA( &RLON1, &RLAT1, &RLON2, &RLAT2, &RDIST, &RAZIM);

	long int N=4, IER;
	GEOGCMS ( &N, &IER );

	long IVAL = 2 , IRANGE = 0,  NRPNT = 2;
	float  ARRAY[2][2]={RLON1, RLAT1, RLON2, RLAT2},  WND[2][2];
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOGCM( &IVAL, (float *)WND, &IRANGE);

	float RIDIST[200], CROSVEK[200][2], CNDVEK[200];
	long  MAXCROS=200, CROSS, IREST;
	GEOGCC3( &RLON1, &RLAT1, &RDIST, &RAZIM, &MAXCROS, (float *)CROSVEK, RIDIST, 
                     (float *)CNDVEK, &CROSS, &IREST);
	int i;
	float PointVEK[200][2];
	PointVEK[0][0] = RLON1;
	PointVEK[0][1] = RLAT1;
	for (i=1;i<=CROSS;i++)
	{
		PointVEK[i][0] = CROSVEK[i-1][0];	PointVEK[i][1] = CROSVEK[i-1][1];
	}
	PointVEK[i][0] = RLON2;					PointVEK[i][1] = RLAT2;
	
	float dst2p0,dst2p, latCross1,lonCross1, loni0,lati0,loni1,lati1;
	int flag10,flag20;
	double latCross,lonCross;

	for(i=0;i<CROSS;i++)
	{
		loni0 = PointVEK[i][0];		lati0 = PointVEK[i][1];
		loni1 = PointVEK[i+1][0];	lati1 = PointVEK[i+1][1];

		GEODSTR( &loni0, &lati0, &loni1, &lati1, &dst2p);

		if((CNDVEK[i]==3) || (CNDVEK[i]==4))
			Dland = Dland + dst2p;

		if(CNDVEK[i]==1)
		{
			Dsea = Dsea + dst2p;
			flag10 = WarmColdSea(loni0*180.0/pi, lati0*180.0/pi);
			flag20 = WarmColdSea(loni1*180.0/pi, lati1*180.0/pi);
			if (flag10!=flag20)
			{
				WarmColdCross(loni0*180.0/pi, lati0*180.0/pi, loni1*180.0/pi, lati1*180.0/pi,
																		&lonCross, &latCross);
				lonCross1 = (float)(lonCross*pi/180.0);
				latCross1 = (float)(latCross*pi/180.0);
				if(flag10)		GEODSTR( &loni0, &lati0, &lonCross1,&latCross1, &dst2p0);
				else			GEODSTR( &loni1, &lati1, &lonCross1,&latCross1, &dst2p0);
				DseaW = DseaW + dst2p0;
			}
			else
			{
				if(flag10)		DseaW = DseaW + dst2p;
			}
		}
	}
	*Dland1 = Dland ,*Dsea1 =Dsea ,*DseaW1 =DseaW; 
}

void CSMS4DCView::OnCoordinationGe84bc2fx() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CString CDataBaseSTR;
//		CDataBaseSTR.Format(_T("select * from GE84BC2BC where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),CTYdlg.m_code,"BC");
		CDataBaseSTR.Format(_T("select * from %s where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),m_qGE84BC2BC,CTYdlg.m_code,"BC");
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Heff1 = TRUE;
		datadlg.m_Title = _Z("Wanted Station");
		if (datadlg.DoModal()==IDOK)
		{
			BeginWaitCursor();
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
			{
				CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				double freq_assgn = atof(GetFld(m_Sel,14));
			//	if((freq_assgn>=87.6)&&(freq_assgn<=99.9))
				{
					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0, Hg,Hagl_ST, h10[37], attH0[37], attV0[37], /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw, Power,attnH,attnV, eff_hgtmax;
					long AntID , terrakey;
					int az0[37];

					terrakey = atol(GetFld(m_Sel,1));
					name1 = GetFld(m_Sel,4);			name1.TrimRight();
					lat0 = atof(GetFld(m_Sel,5));
					lon0  = atof(GetFld(m_Sel,6));
					Hagl_ST = atof(GetFld(m_Sel,7));
					fmtv_terra_polar = GetFld(m_Sel,8);	fmtv_terra_polar.TrimRight();
					erp_dbw = atof(GetFld(m_Sel,9));
					erp_h_dbw = atof(GetFld(m_Sel,10));
					erp_v_dbw = atof(GetFld(m_Sel,11));
					ant_dir = GetFld(m_Sel,12);			ant_dir.TrimRight();
					eff_hgtmax = atof(GetFld(m_Sel,20));
					AntID = atol(GetFld(m_Sel,30));
					if(datadlg.m_Heff1)
					{
						OnDatabaseStationsindesktop2(lat0, lon0);
						Hg = LatLon2Hg(lat0,lon0) ;
					}
					else
					{
						Hg = atof(GetFld(m_Sel,13));
						GE84Heff(AntID,eff_hgtmax,h10) ;
					//	GE84Heff(terrakey,eff_hgtmax,h10) ;
					}

					for(int i=0;i<36;i++)		az0[i] = 10*i;

					if(ant_dir==_T("D"))
						GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
					else
						for(int i=0;i<36;i++)
						{
							attH0[i] = 0;	attV0[i] = 0;
						}

					az0[36] = 360;			h10[36] = h10[0];
					attH0[36] = attH0[0];	attV0[36] = attV0[0];

					float RLON = (float)(lon0*pi/180.0),
						  RLAT = (float)(lat0*pi/180.0),
						  RANGE = 1500.0,
						  RDIST,	RAZIM, 	  RLONb,	RLATb,
						  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

					long IVAL = 1, IRANGE = 1500;
					GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

					CString cty1("");
					GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

					long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
					unsigned char CTYCOD[1500];
					short KMCTY[1000];
					GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
										 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					if(IREST==-1)
					{
						cty1 = CTYdlg.m_code;
						GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
											 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					}
					char temp[4];

					if(NOCTY>0)
					{
						CString m_CTY, Affected, REGION, str = "",	str1 = "";
						int k = 0;
						CPoint m_Point_STcr3,m_Point_STcr15;
						double lat3km,lon3km,lat15km,lon15km,h1;
						double Dland ,Dsea ,DseaW ,DseaC; 
						double ELand,ESeaC,ESeaW,Efs;
						double EM = -999.999, ttca = -999.999;

						CP370_Functions CP370;
						CGE84_Functions GE84x;
						CString RLONbs,RLATbs;
						for(int i=0;i<NOCTY ;i++)
						{
							temp[0]=CTYCOD[3*i];
							temp[1]=CTYCOD[3*i+1];
							temp[2]=CTYCOD[3*i+2];
							temp[3]=0;
							m_CTY = temp;

							if(GE84x.CTRY_Check(m_CTY))
							{
								GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
								if(RDIST<=RANGE)
								{
									GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
									/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
									if(cty1!=m_CTY)
									{
										if(datadlg.m_Heff1)
										{
											reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
											reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
											double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
											h1 = Hg + Hagl_ST - hv1 ;
										}
										else
											h1 = Interp2(az0,h10,RAZIM,37) ;
										/////////////////////////////////////////////////////////////////////////////////////
										CoastalArea(lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi,
																  &Dland ,&Dsea ,&DseaW) ;
										DseaC = Dsea - DseaW;

										attnH = Interp2(az0,attH0,RAZIM,37) ;
										attnV = Interp2(az0,attV0,RAZIM,37) ;
										if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
										else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
										else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));
										Power = pow(10.0,erpdbw/10.0);

										double h11 = h1;
										h1 = max(10.0,h1);

										ELand = CP370.P370_7(freq_assgn,10.0,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ELand = ELand + erpdbw - 30.0;
										ESeaC = CP370.P370_7(freq_assgn,10.0,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ESeaC = ESeaC + erpdbw - 30.0;
										ESeaW = CP370.P370_7(freq_assgn,10.0,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ESeaW = ESeaW + erpdbw - 30.0;
										EM = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW)/RDIST;
										
										GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
										Affected = _T("---");
										if((EM>0)&&(REGION==_T("3"))&&((freq_assgn>=87.5)&&(freq_assgn<=100)))	Affected = _T("+++");

										if(Affected != _T("---"))
										{
											k++;
											Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
											str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%s,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,EM,h11,"87.5 - 100",REGION);
											str1 = str1 + _T(",") + str;
										}

									}	//end if(RDIST!=0)
								}	//end if(RDIST<RANGE)

							}	//if(GE84x.CTRY_Check(m_CTY))

						}	//end for
						CString assignIDX = GetFld(m_Sel,2);

						str1.Delete(0);
						CGE84BC2BCDLG dlgList;
						dlgList.m_title = _Z("GE84 BC to FX - Field Strength");
						dlgList.m_nROWS = k+1+0;
						Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
						str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
						str1=str+","+str1;
						dlgList.m_data = str1;
						dlgList.m_DorE = _T("E(dBuV/m)");
						dlgList.DoModal();

					}	//end if(NOCTY>0)

				}	//end if freq_assgn

			}	//end if (Nrow==1)
		}	//end datadlg
		Set_STtable_Default();
		EndWaitCursor();
	}	//end CTYdlg	
}

void CSMS4DCView::OnCoordinationGe84bc2lm() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CString CDataBaseSTR;
//		CDataBaseSTR.Format(_T("select * from GE84BC2BC where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),CTYdlg.m_code,"BC");
		CDataBaseSTR.Format(_T("select * from %s where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),m_qGE84BC2BC,CTYdlg.m_code,"BC");
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Heff1 = TRUE;
		datadlg.m_Title = _Z("Wanted Station");
		if (datadlg.DoModal()==IDOK)
		{
			BeginWaitCursor();
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
			{
				CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				double freq_assgn = atof(GetFld(m_Sel,14));
			//	if((freq_assgn>=87.6)&&(freq_assgn<=99.9))
				{
					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0, Hg,Hagl_ST, h10[37], attH0[37], attV0[37], /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw, Power,attnH,attnV, eff_hgtmax;
					long AntID , terrakey;
					int az0[37];

					terrakey = atol(GetFld(m_Sel,1));
					name1 = GetFld(m_Sel,4);			name1.TrimRight();
					lat0 = atof(GetFld(m_Sel,5));
					lon0  = atof(GetFld(m_Sel,6));
					Hagl_ST = atof(GetFld(m_Sel,7));
					fmtv_terra_polar = GetFld(m_Sel,8);	fmtv_terra_polar.TrimRight();
					erp_dbw = atof(GetFld(m_Sel,9));
					erp_h_dbw = atof(GetFld(m_Sel,10));
					erp_v_dbw = atof(GetFld(m_Sel,11));
					ant_dir = GetFld(m_Sel,12);			ant_dir.TrimRight();
					eff_hgtmax = atof(GetFld(m_Sel,20));
					AntID = atol(GetFld(m_Sel,30));

					if(datadlg.m_Heff1)
					{
						OnDatabaseStationsindesktop2(lat0, lon0);
						Hg = LatLon2Hg(lat0,lon0) ;
					}
					else
					{
						Hg = atof(GetFld(m_Sel,13));
					//	GE84Heff(terrakey,eff_hgtmax,h10) ;
						GE84Heff(AntID,eff_hgtmax,h10) ;
					}

					for(int i=0;i<36;i++)	az0[i] = 10*i;

					if(ant_dir==_T("D"))
						GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
					else
						for(int i=0;i<36;i++)
						{
							attH0[i] = 0;	attV0[i] = 0;
						}

					az0[36] = 360;			h10[36] = h10[0];
					attH0[36] = attH0[0];	attV0[36] = attV0[0];

					float RLON = (float)(lon0*pi/180.0),
						  RLAT = (float)(lat0*pi/180.0),
						  RANGE = 1500.0,
						  RDIST,	RAZIM, 	  RLONb,	RLATb,
						  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

					long IVAL = 1, IRANGE = 1500;
					GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

					CString cty1("");
					GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

					long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
					unsigned char CTYCOD[1500];
					short KMCTY[1000];
					GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
										 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					if(IREST==-1)
					{
						cty1 = CTYdlg.m_code;
						GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
											 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					}
					char temp[4];

					if(NOCTY>0)
					{
						CString m_CTY, Affected, REGION, str = "",	str1 = "";
						int k = 0;
						CPoint m_Point_STcr3,m_Point_STcr15;
						double lat3km,lon3km,lat15km,lon15km,h1;
						double Dland ,Dsea ,DseaW ,DseaC; 
						double ELand,ESeaC,ESeaW,Efs;
						double EM = -999.999, ttca = -999.999;

						CP370_Functions CP370;
						CGE84_Functions GE84x;

						CString RLONbs,RLATbs;
						for(int i=0;i<NOCTY ;i++)
						{
							temp[0]=CTYCOD[3*i];
							temp[1]=CTYCOD[3*i+1];
							temp[2]=CTYCOD[3*i+2];
							temp[3]=0;
							m_CTY = temp;

							if(GE84x.CTRY_Check(m_CTY))
							{
								GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
								if(RDIST<=RANGE)
								{
									GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
									/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
									if(cty1!=m_CTY)
									{
										if(datadlg.m_Heff1)
										{
											reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
											reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
											double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
											h1 = Hg + Hagl_ST - hv1 ;
										}
										else
											h1 = Interp2(az0,h10,RAZIM,37) ;
										/////////////////////////////////////////////////////////////////////////////////////
										CoastalArea(lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi,
																  &Dland ,&Dsea ,&DseaW) ;
										DseaC = Dsea - DseaW;

										attnH = Interp2(az0,attH0,RAZIM,37) ;
										attnV = Interp2(az0,attV0,RAZIM,37) ;
										if(fmtv_terra_polar == _T("H"))											erpdbw = erp_h_dbw - attnH;
										else if((fmtv_terra_polar == _T("V"))||(fmtv_terra_polar == _T("M")))	erpdbw = erp_v_dbw - attnV;

										Power = pow(10.0,erpdbw/10.0);
										double h11 = h1;
										h1 = max(10.0,h1);

										ELand = CP370.P370_7(freq_assgn,10.0,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ELand = ELand + erpdbw - 30.0;
										ESeaC = CP370.P370_7(freq_assgn,10.0,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ESeaC = ESeaC + erpdbw - 30.0;
										ESeaW = CP370.P370_7(freq_assgn,10.0,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
										ESeaW = ESeaW + erpdbw - 30.0;
										EM = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW)/RDIST;

										GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
										Affected = _T("---");


										if((m_CTY==_T("MCO"))&&((freq_assgn>=87.5)&&(freq_assgn<=88)))
										{
											if(((EM>14)&&(fmtv_terra_polar == _T("H")))||((EM>6)&&((fmtv_terra_polar == _T("V"))||(fmtv_terra_polar == _T("M")))))
												Affected = _T("+++");
										}
										else if ((REGION==_T("3"))&&((freq_assgn>=87.5)&&(freq_assgn<=100)))
										{
											if(((EM>18)&&(fmtv_terra_polar == _T("H")))||((EM>0)&&((fmtv_terra_polar == _T("V"))||(fmtv_terra_polar == _T("M")))))
												Affected = _T("+++");
										}

										if(Affected != _T("---"))
										{
											k++;
											Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
											str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%s,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,EM,h11,"87.5 - 100",REGION);
											str1=str1+","+str;
										}

									}	//end if(RDIST!=0)
								}	//end if(RDIST<RANGE)

							}//	if(GE84x.CTRY_Check(m_CTY))

						}	//end for

						CString assignIDX = GetFld(m_Sel,2);
						str1.Delete(0);
						CGE84BC2BCDLG dlgList;
						dlgList.m_title = _Z("GE84 BC to LM - Field Strength");
						dlgList.m_nROWS = k+1+0;
						Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
						str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
						str1=str+","+str1;
						dlgList.m_data = str1;
						dlgList.m_DorE = _T("E(dBuV/m)");
						dlgList.DoModal();
					}	//end if(NOCTY>0)

				}	//end if freq_assgn

			}	//end if (Nrow==1)
		}	//end datadlg
		Set_STtable_Default();
		EndWaitCursor();
	}	//end CTYdlg	
}

CString CSMS4DCView::OnCoordinationGe84euQx() 
{
	CString SelX = _T(" ");
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		CString CDataBaseSTR;
//		CDataBaseSTR.Format(_T("select * from GE84BC2BC where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),CTYdlg.m_code,"BC");
		CDataBaseSTR.Format(_T("select * from %s where ((ctry=\'%s\') AND (stn_cls=\'%s\'))"),m_qGE84BC2BC,CTYdlg.m_code,"BC");
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Title = _T("Wanted Station");

		if (datadlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)	SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		}
		Set_STtable_Default();
	}
	return SelX;
}

BOOL CSMS4DCView::OnCoordinationGe84euQy(long terrakeyX,double latX, double lonX, double frqX, double Drange, double Frange, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double rng_km = Drange;
	double dumy,  lonmin , lonmax , latmin , latmax ;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
	double fmin = frqX - Frange/1000.0;
	double fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
///	CDataBaseSTR.Format("select * from GE84BC2BC where (((assgn_id)<>\'%s\') AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_Y)>=%f And (freq_Y)<=%f))",assignIDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
//	CDataBaseSTR.Format(_T("select * from GE84BC2BC where (((terrakey)<>%ld) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_Y)>=%f And (freq_Y)<=%f))"),terrakeyX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	CDataBaseSTR.Format(_T("select * from %s where (((terrakey)<>%ld) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_Y)>=%f And (freq_Y)<=%f))"),m_qGE84BC2BC,terrakeyX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = TRUE;
	datadlg.m_Title = _T("Selected Stations");

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnCoordinationGe84eu() 
{
	BeginWaitCursor();
	CString m_SelX = OnCoordinationGe84euQx();
	if(m_SelX!=" ")
	{
		CString assignIDX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		double freq_assgnX = atof(GetFld(m_SelX,14));

		long terrakeyX = atol(GetFld(m_SelX,1));

		CGE84_F_D_rngeDLG F_D_rngeDLG;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = F_D_rngeDLG.m_Emin,  tp = F_D_rngeDLG.m_T;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL hef_flag;
	//		BOOL YOK = OnCoordinationGe84euQy(assignIDX,latX,lonX,freq_assgnX,Drange,Frange,&hef_flag);
			BOOL YOK = OnCoordinationGe84euQy(terrakeyX,latX,lonX,freq_assgnX,Drange,Frange,&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					int Xsys  = atol(GetFld(m_SelX,16));
					CString ctyX = GetFld(m_SelX,3);
					CString fmtv_terra_polarX = GetFld(m_SelX,8);	fmtv_terra_polarX.TrimRight();

					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0, Hg,Hagl_ST, h10[37], attH0[37], attV0[37], /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw,attnH,attnV;
					long AntID ,terrakey;
					int az0[37], Ysys, k = 0;

					CString *m_Sel; m_Sel = new CString[Nrow];
					double *Esi; Esi = new double[Nrow];

					CPoint m_Point_STcr3,m_Point_STcr15;
					double lat3km,lon3km,lat15km,lon15km,h1, ttca = -999.999;
					double Dland ,DseaW ,DseaC, Dsuper; 
					double ELand,ESeaC,ESeaW,Efs, ESuper, RDIST, RAZIM, h11,eff_hgtmax;
					double Et = -999.999, E50 = Et, freq_assgnY;
					double PR, Bi = 0.0, Eu, sigma_n = 8.3, L_Xi,  Delta, D, absDelta;
					double a1 = 0.196854, a2 = 0.115194, a3 = 0.000344, a4 = 0.019527;
					double Esi_max = Et, Xi,  L, Eu_out = Et, Es0;
					CString Ymod, Yst_cls, assignIDY,ctyY, strX,strY="",strY1="";

					CP370_Functions CP370;
					CGE84_Functions GE84x;

					int progress_num=0;
					CString progress_str, progress_char = "I";

					for(int Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+ _Z(" complete") +" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
						terrakey = atol(GetFld(m_Sel[Yi],1));
						name1 = GetFld(m_Sel[Yi],4);			name1.TrimRight();
						lat0 = atof(GetFld(m_Sel[Yi],5));
						lon0  = atof(GetFld(m_Sel[Yi],6));
						Hagl_ST = atof(GetFld(m_Sel[Yi],7));
						fmtv_terra_polar = GetFld(m_Sel[Yi],8);	fmtv_terra_polar.TrimRight();
						erp_dbw = atof(GetFld(m_Sel[Yi],9));
						erp_h_dbw = atof(GetFld(m_Sel[Yi],10));
						erp_v_dbw = atof(GetFld(m_Sel[Yi],11));
						ant_dir = GetFld(m_Sel[Yi],12);			ant_dir.TrimRight();
						AntID = atol(GetFld(m_Sel[Yi],30));
						Ysys  = atol(GetFld(m_Sel[Yi],16));
						Ymod = GetFld(m_Sel[Yi],15);
						Ymod = Ymod.Left(1);
						Yst_cls = GetFld(m_Sel[Yi],17);
						assignIDY = GetFld(m_Sel[Yi],2);
						ctyY = GetFld(m_Sel[Yi],3);
						freq_assgnY = atof(GetFld(m_Sel[Yi],18));
						eff_hgtmax = atof(GetFld(m_Sel[Yi],20));

						if(hef_flag)
						{
							OnDatabaseStationsindesktop2(lat0, lon0);
						//	OnDatabaseStationsindesktop(-999,name1, lat0, lon0);
							Hg = LatLon2Hg(lat0,lon0) ;
						}
						else
						{
							Hg = atof(GetFld(m_Sel[Yi],13));
						//	GE84Heff(terrakey,eff_hgtmax,h10) ;
							GE84Heff(AntID,eff_hgtmax,h10) ;
						}

						for(int i=0;i<36;i++)		az0[i] = 10*i;

						if(ant_dir==_T("D"))
							GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
						else
							for(int i=0;i<36;i++)
							{
								attH0[i] = 0;		attV0[i] = 0;
							}

						az0[36] = 360;				h10[36] = h10[0];
						attH0[36] = attH0[0];		attV0[36] = attV0[0];

						RAZIM = Azimuth_Deg(lat0,lon0,latX,lonX);
						RDIST = Distance_km(lat0,lon0,latX,lonX);
						if(hef_flag)
						{
							reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
							reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
							double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
							h1 = Hg + Hagl_ST - hv1 ;
						}
						else
							h1 = Interp2(az0,h10,RAZIM,37) ;
						/////////////////////////////////////////////////////////////////////////////////////
						SuperRefract50(lat0,lon0,latX,lonX,
												 &Dland ,&DseaW ,&DseaC ,&Dsuper) ;

						attnH = Interp2(az0,attH0,RAZIM,37) ;
						attnV = Interp2(az0,attV0,RAZIM,37) ;
						if(fmtv_terra_polar == _T("H"))											erpdbw = erp_h_dbw - attnH;
						else if((fmtv_terra_polar == _T("V"))||(fmtv_terra_polar == _T("M")))	erpdbw = erp_v_dbw - attnV;

						h11 = h1;
						h1 = max(10.0,h1);

						tp = F_D_rngeDLG.m_T;
						ELand = CP370.P370_7(freq_assgnY,tp,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ELand = ELand + erpdbw - 30.0;
						ESeaC = CP370.P370_7(freq_assgnY,tp,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESeaC = ESeaC + erpdbw - 30.0;
						ESeaW = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESeaW = ESeaW + erpdbw - 30.0;
						if(tp==1.0)		ESuper = (RDIST<=400.0) ? (106.9 - 20.0*log10(RDIST)) : (78.9 - 0.06*RDIST);
						else			ESuper = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESuper = ESuper + erpdbw - 30.0;
						Et = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW + Dsuper*ESuper)/RDIST;

						tp = 50.0;
						ELand = CP370.P370_7(freq_assgnY,tp,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ELand = ELand + erpdbw - 30.0;
						ESeaC = CP370.P370_7(freq_assgnY,tp,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESeaC = ESeaC + erpdbw - 30.0;
						ESeaW = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESeaW = ESeaW + erpdbw - 30.0;
						ESuper = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
						ESuper = ESuper + erpdbw - 30.0;
						E50 = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW + Dsuper*ESuper)/RDIST;

						PR = GE84x.GE84_ProtectionR(Yst_cls,freq_assgnX,freq_assgnY,Xsys,Ysys,E50,Et,Ymod) ;
						Es0 = Et + PR + Bi;
						if (Es0>=Emin)
						{
							Esi[k] = Es0;
							Esi_max = max(Esi_max,Esi[k]);
							k++;
							strY1.Format("%s,%s,%s,%f,%s,%0.6f",assignIDY,name1,ctyY,freq_assgnY,fmtv_terra_polar,Es0);
							strY = strY+","+strY1;
						}
					}// end for Yi

					if(k>0)
					{
						Eu = 6.0 + Esi_max;
						Delta = 1, absDelta = 1, D = 0;
						while(absDelta>0.0001)
						{
							Eu = Eu + D;
							L = 1.0;
							for(int j=0;j<k;j++)
							{
								Xi = (Eu - Esi[j])/(sqrt(2.0)*sigma_n);
								L_Xi = 1.0 - 0.5*pow(1.0+a1*Xi+a2*Xi*Xi+a3*Xi*Xi*Xi+a4*Xi*Xi*Xi*Xi,-4.0);
								L = L*L_Xi;
							}
							Delta = 0.5-L;
							absDelta = fabs(Delta);

							if(absDelta<=0.0001)	Eu_out = Eu;
							else					D = Delta/0.05;
						}
					}
					delete [] Esi;		delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;

					strX.Format("%s,%s,%s,%f,%s,%0.6f",assignIDX,nameX,ctyX,freq_assgnX,fmtv_terra_polarX,Eu_out);
					strY.Delete(0);
					CGE84_EUDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();

				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if F_D_rngeDLG
	}// end if m_SelX
	EndWaitCursor();
}

void CSMS4DCView::OnPropagationmodelsSmoothearthLink() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		CSmoothDLG smoothdlg;
		if (smoothdlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==2)
			{
				CString name1[2],m_Sel[2];
				CPoint pointst[2];
				double lat1[2],lon1[2];
				for (int i=0;i<2;i++)
				{
					m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					name1[i] = GetFld(m_Sel[i],2);
					lat1[i]  = atof(GetFld(m_Sel[i],3));
					lon1[i]  = atof(GetFld(m_Sel[i],4));
					LatLon2Point(lat1[i],lon1[i],&pointst[i]);
				}
				long x1=pointst[0].x;		long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;		long y2=1200-1-pointst[1].y;

				int xNmin = (min(x1 , x2) )-20;			int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;			int yNmax = (max(y1 , y2) )+20;
				int xN  = abs(xNmax - xNmin);  			int yN  = abs(yNmax - yNmin);
				xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (Smooth Earth)");
				CPro_Smooth_LinkDoc *pDocLinkP526=(CPro_Smooth_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (Smooth Earth)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				x1=pointst[0].x;	y1=pointst[0].y;
				x2=pointst[1].x;	y2=pointst[1].y;
				long xmin=min(x1 , x2);			long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);			long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;
				pDocLinkP526->Np=Np;
				pDocLinkP526->m_di=new double[Np];
				pDocLinkP526->m_hi=new double[Np];
				pDocLinkP526->m_hikm=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));
					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP526->m_di[i]=rng[i];
					pDocLinkP526->m_hi[i]=hi1[i];
					pDocLinkP526->m_hikm[i]=hi1[i]/1000.0;
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP526->Hmin=Hmin;
				pDocLinkP526->Dmin=rng[0];
				pDocLinkP526->Dmax=rng[Np-1];
				pDocLinkP526->m_DrawFresnel = true;
				pDocLinkP526->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP526->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP526->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP526->LinkName_Rx = name1[1];
				pDocLinkP526->Linklat_Rx  = lat1[1];
				pDocLinkP526->Linklon_Rx  = lon1[1];
				pDocLinkP526->m_kfactor = smoothdlg.m_kfactor;
				pDocLinkP526->m_Type = smoothdlg.m_Type;
				pDocLinkP526->LinkName_ST = name1[0];
				pDocLinkP526->Linklat_ST  = lat1[0];
				pDocLinkP526->Linklon_ST  = lon1[0];
				pDocLinkP526->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP526->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP526->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));
				pDocLinkP526->m_Pol = GetFld(m_Sel[0],13);

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP526->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP526->Linklat0 = yUTM;
				pDocLinkP526->Linklon0 = xUTM;
				pDocLinkP526->m_ReadyDoc=1;
				pDocLinkP526->GetData();
				pDocLinkP526->UpdateAllViews(NULL);
				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; delete [] x_en;		delete [] y_en;
			}
		}//P526dlg
	}//datadlg		
}

void CSMS4DCView::OnCoordinationGe84eui() 
{
	BeginWaitCursor();
	CString m_SelX = OnCoordinationGe84euQx();
	if(m_SelX!=_T(" "))
	{
		BeginWaitCursor();
		CGE84_F_D_rngeDLG F_D_rngeDLG;
		F_D_rngeDLG.m_F = 800;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double latX = atof(GetFld(m_SelX,5));
			double lonX  = atof(GetFld(m_SelX,6));
			double freq_assgnX = atof(GetFld(m_SelX,14));
			CString assignIDX = GetFld(m_SelX,2);
			CString ctyX = GetFld(m_SelX,3);
			CString nameX = GetFld(m_SelX,4);				nameX.TrimRight();
			CString fmtv_terra_polarX = GetFld(m_SelX,8);	fmtv_terra_polarX.TrimRight();
			long terrakeyX = atol(GetFld(m_SelX,1));

			double freq_assgnX0 = freq_assgnX;
			double Emin = F_D_rngeDLG.m_Emin,  tp = F_D_rngeDLG.m_T;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL hef_flag;
	//		BOOL YOK = OnCoordinationGe84euQy(assignIDX,latX,lonX,freq_assgnX,Drange,Frange,&hef_flag);
			BOOL YOK = OnCoordinationGe84euQy(terrakeyX,latX,lonX,freq_assgnX,Drange,Frange,&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					BeginWaitCursor();
					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0, Hg,Hagl_ST, h10[37], attH0[37], attV0[37], /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw,attnH,attnV;
					long AntID ,terrakey;
					int az0[37], Ysys, k = 0, Xsys;

					CPoint m_Point_STcr3,m_Point_STcr15;
					double lat3km,lon3km,lat15km,lon15km,h1;
					double Dland ,DseaW ,DseaC, Dsuper; 
					double ELand,ESeaC,ESeaW,Efs, ESuper, RDIST, RAZIM, h11,eff_hgtmax;
					double Et = -999.999999, E50 = Et, freq_assgnY;
					double PR, Bi = 0.0, Eu, sigma_n = 8.3, L_Xi,  Delta, D, absDelta;
					double a1 = 0.196854, a2 = 0.115194, a3 = 0.000344, a4 = 0.019527;
					double Esi_max = Et, Xi,  L, Eu_out = Et, Es0;
					CString Ymod, Yst_cls, assignIDY,ctyY, strX,strY="",strY1="";

					CP370_Functions CP370;
					CGE84_Functions GE84x;

					CString m_SelXy ,assignIDXy, ctyXy, nameXy;
					double Exy = -999.999999, Eu_ref = Exy, DEu = Exy, ttca = -999.999;
				
					int progress_num=0;
					CString progress_str, progress_char = "I";

					for(int Yii=0;Yii<Nrow;Yii++)
					{
						m_SelXy = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yii];
						((CSMS4DCApp *)AfxGetApp())->m_Sel[Yii] = m_SelX;
						m_SelX = m_SelXy;

						latX = atof(GetFld(m_SelX,5));
						lonX  = atof(GetFld(m_SelX,6));
						freq_assgnX = atof(GetFld(m_SelX,14));
						Xsys  = atol(GetFld(m_SelX,16));
						assignIDXy = GetFld(m_SelX,2);
						ctyXy = GetFld(m_SelX,3);
						nameXy = GetFld(m_SelX,4);			nameXy.TrimRight();

						if(hef_flag)	OnDatabaseStationsindesktop2(latX, lonX);

						CString *m_Sel; m_Sel = new CString[Nrow];
						double *Esi; Esi = new double[Nrow];

						k=0;
						Et = -999.999, E50 = Et, Esi_max = Et;
						for(int Yi = 0;Yi<Nrow;Yi++)
						{
							progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow*Nrow),progress_char);
							progress_char = str_rep("|",(int)(progress_num*50.0/(Nrow*Nrow)) );
							((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

							m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
							terrakey = atol(GetFld(m_Sel[Yi],1));
							name1 = GetFld(m_Sel[Yi],4);			name1.TrimRight();
							lat0 = atof(GetFld(m_Sel[Yi],5));
							lon0  = atof(GetFld(m_Sel[Yi],6));
							Hagl_ST = atof(GetFld(m_Sel[Yi],7));
							fmtv_terra_polar = GetFld(m_Sel[Yi],8);	fmtv_terra_polar.TrimRight();
							erp_dbw = atof(GetFld(m_Sel[Yi],9));
							erp_h_dbw = atof(GetFld(m_Sel[Yi],10));
							erp_v_dbw = atof(GetFld(m_Sel[Yi],11));
							ant_dir = GetFld(m_Sel[Yi],12);			ant_dir.TrimRight();
							AntID = atol(GetFld(m_Sel[Yi],30));
							Ysys  = atol(GetFld(m_Sel[Yi],16));
							Ymod = GetFld(m_Sel[Yi],15);
							Ymod = Ymod.Left(1);
							Yst_cls = GetFld(m_Sel[Yi],17);
							assignIDY = GetFld(m_Sel[Yi],2);
							ctyY = GetFld(m_Sel[Yi],3);
							freq_assgnY = atof(GetFld(m_Sel[Yi],18));
							Eu_ref = atof(GetFld(m_Sel[Yi],19));
							eff_hgtmax = atof(GetFld(m_Sel[Yi],20));

							if(hef_flag)
							{
								OnDatabaseStationsindesktop2(lat0, lon0);
							//	OnDatabaseStationsindesktop(-999,name1, lat0, lon0);
								Hg = LatLon2Hg(lat0,lon0) ;
							}
							else
							{
								Hg = atof(GetFld(m_Sel[Yi],13));
							//	GE84Heff(terrakey,eff_hgtmax,h10) ;
								GE84Heff(AntID,eff_hgtmax,h10) ;
							}

							for(int i=0;i<36;i++)			az0[i] = 10*i;

							if(ant_dir==_T("D"))
								GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
							else
								for(int i=0;i<36;i++)
								{
									attH0[i] = 0;		attV0[i] = 0;
								}

							az0[36] = 360;				h10[36] = h10[0];
							attH0[36] = attH0[0];		attV0[36] = attV0[0];

							RAZIM = Azimuth_Deg(lat0,lon0,latX,lonX);
							RDIST = Distance_km(lat0,lon0,latX,lonX);
							if(hef_flag)
							{
								reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
								reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
								double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
								h1 = Hg + Hagl_ST - hv1 ;
							}
							else
								h1 = Interp2(az0,h10,RAZIM,37) ;
							/////////////////////////////////////////////////////////////////////////////////////
							SuperRefract50(lat0,lon0,latX,lonX, &Dland ,&DseaW ,&DseaC ,&Dsuper) ;

							attnH = Interp2(az0,attH0,RAZIM,37) ;
							attnV = Interp2(az0,attV0,RAZIM,37) ;
							if(fmtv_terra_polar == _T("H"))											erpdbw = erp_h_dbw - attnH;
							else if((fmtv_terra_polar == _T("V"))||(fmtv_terra_polar == _T("M")))	erpdbw = erp_v_dbw - attnV;

							h11 = h1;
							h1 = max(10.0,h1);
				
							tp = F_D_rngeDLG.m_T;
							ELand = CP370.P370_7(freq_assgnY,tp,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ELand = ELand + erpdbw - 30.0;
							ESeaC = CP370.P370_7(freq_assgnY,tp,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESeaC = ESeaC + erpdbw - 30.0;
							ESeaW = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESeaW = ESeaW + erpdbw - 30.0;
							if(tp==1.0)		ESuper = (RDIST<=400.0) ? (106.9 - 20.0*log10(RDIST)) : (78.9 - 0.06*RDIST);
							else			ESuper = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESuper = ESuper + erpdbw - 30.0;
							Et = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW + Dsuper*ESuper)/RDIST;

							tp = 50.0;
							ELand = CP370.P370_7(freq_assgnY,tp,1,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ELand = ELand + erpdbw - 30.0;
							ESeaC = CP370.P370_7(freq_assgnY,tp,2,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESeaC = ESeaC + erpdbw - 30.0;
							ESeaW = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESeaW = ESeaW + erpdbw - 30.0;
							ESuper = CP370.P370_7(freq_assgnY,tp,3,h1,RDIST,-50,10.0,1,50.0,1,ttca,&Efs);
							ESuper = ESuper + erpdbw - 30.0;
							E50 = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW + Dsuper*ESuper)/RDIST;

							PR = GE84x.GE84_ProtectionR(Yst_cls,freq_assgnX,freq_assgnY,Xsys,Ysys,E50,Et,Ymod) ;
							Es0 = Et + PR + Bi;

							if (Yi==0)	Exy = Es0;
							if (Es0>=Emin)
							{
								Esi[k] = Es0;
								Esi_max = max(Esi_max,Esi[k]);
								k++;
							}
						}// end for Yi

						if(k>0)
						{
							Eu = 6.0 + Esi_max;
							Delta = 1, absDelta = 1, D = 0;
							while(absDelta>0.0001)
							{
								Eu = Eu + D;
								L = 1.0;
								for(int j=0;j<k;j++)
								{
									Xi = (Eu - Esi[j])/(sqrt(2.0)*sigma_n);
									L_Xi = 1.0 - 0.5*pow(1.0+a1*Xi+a2*Xi*Xi+a3*Xi*Xi*Xi+a4*Xi*Xi*Xi*Xi,-4.0);
									L = L*L_Xi;
								}
								Delta = 0.5-L;
								absDelta = fabs(Delta);
								if(absDelta<=0.0001)	Eu_out = Eu;
								else					D = Delta/0.05;
							}
						}
						DEu = (Eu_out==-999.999999) ? Eu_out : Eu_out-Eu_ref;
						strY1.Format("%s,%s,%s,%0.6f,%0.6f,%0.6f,%0.6f",assignIDXy,nameXy,ctyXy,Exy,Eu_out,Eu_ref,DEu);
						strY = strY+","+strY1;
						Esi = NULL;		m_Sel = NULL;
						delete [] Esi;	delete [] m_Sel;

					} // end for Yii

					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;

					strX.Format("%s,%s,%s,%f",assignIDX,nameX,ctyX,freq_assgnX0);
					strY.Delete(0);
					CGE84_EUIDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();
				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if F_D_rngeDLG
	}// end if m_SelX	
	EndWaitCursor();
}

CString CSMS4DCView::str_rep(CString str,int num)
{
	CString str1 = str;
	for(int i=0;i<num;i++)	str1 = str1+str;
	return str1;
}

void CSMS4DCView::SuperRefract50(double RLAT_deg1,double RLON_deg1,double RLAT_deg2,double RLON_deg2,double *dLand,double *dWarm,double *dCold,double *dSuper) 
{
	double SRlon50[520]={
	59.6619388648, 59.6594646128, 59.6576089241, 59.6205558777, 59.5847206116, 59.5713882446, 59.5324935913,
	59.4980583191, 59.4822196960, 59.4711112976, 59.4475066667, 59.3828067894, 59.2787582707, 59.2147651399,
	59.1973061361, 59.2282595950, 59.2419581662, 59.2211052605, 59.1863906503, 59.1407003832, 59.0361986684,
	59.0298374172, 59.0083394545, 59.0045639396, 58.8999548157, 58.8587631486, 58.8538675782, 58.8395678767,
	58.8282400823, 58.7234560371, 58.7034968586, 58.6671150942, 58.6558562020, 58.6016094368, 58.5681303466,
	58.5538688798, 58.5499709990, 58.3204965407, 58.2684771370, 58.2608703409, 58.1090569742, 57.9845429305,
	57.9755816521, 57.9427182001, 57.8716886635, 57.7197765833, 57.6461938260, 57.5277627539, 57.5107773540,
	57.4274525182, 57.3533239379, 57.3324065493, 57.3205421389, 57.2270961944, 57.1866051815, 57.1331707799,
	57.0947693385, 57.0384067726, 56.9028490328, 56.8960997783, 56.8096802246, 56.7638133941, 56.7314808595,
	56.6727159465, 56.6582736576, 56.5986330709, 56.5814443758, 56.4757294717, 56.4511820495, 56.4174170386,
	56.3950823280, 56.3624514360, 56.3514858796, 56.3257458075, 56.2197822513, 56.1870600216, 56.1661735453,
	56.1342301698, 56.1125662815, 56.0472676458, 56.0446039673, 56.0119426798, 56.0098228572, 55.9972141386,
	55.9939416237, 55.9285021205, 55.9247410813, 55.8956658295, 55.8844671413, 55.8783287260, 55.8603858480,
	55.8730101171, 55.8723161831, 55.8018848122, 55.8003300203, 55.7258245346, 55.6121589378, 55.5498149499,
	55.5007137235, 55.4854907839, 55.4120657659, 55.4097200335, 55.2962953324, 55.2217668156, 55.2020194238,
	55.1767142814, 55.1627615408, 55.0726082769, 55.0564930043, 55.0451764408, 55.0405006129, 54.9664673756,
	54.8868988808, 54.8491168873, 54.8100496660, 54.7863916031, 54.6736131582, 54.5332180496, 54.4759704987,
	54.4670885107, 54.4027823294, 54.2625252539, 54.2177803487, 54.1638850123, 54.1157436969, 54.0646887519,
	53.9909679443, 53.9602191554, 53.8063710641, 53.7670362942, 53.7052625460, 53.7041872530, 53.6072070724,
	53.4549115142, 53.3961195118, 53.3844666333, 53.3241465777, 53.2794553992, 53.2238694655, 53.0715121150,
	53.0482344506, 53.0031725132, 53.0019172184, 52.9806687955, 52.8960868017, 52.8694086194, 52.7885853814,
	52.7190968718, 52.6704687584, 52.6444916720, 52.5043546618, 52.4999093002, 52.4109792277, 52.3468198784,
	52.3129028915, 52.1591654579, 52.1501011159, 52.0530493579, 51.9008614224, 51.8892291878, 51.8802703459,
	51.7280457396, 51.7005043154, 51.6316264050, 51.4959722724, 51.3903831652, 51.3489186276, 51.2919012229,
	51.1393240395, 51.0033806971, 50.8975630999, 50.8324480501, 50.8186811343, 50.7712949806, 50.6182020256,
	50.4817958791, 50.3756126888, 50.3414577148, 50.3297954186, 50.2644059092, 50.2615777029, 50.2439619772,
	50.2249388949, 50.1811955379, 50.1556365694, 50.1295549945, 50.0639872845, 50.0560670981, 50.0414110815,
	50.0372803945, 49.9573290795, 49.9490464999, 49.8887409230, 49.8826221523, 49.8187660537, 49.8020885908,
	49.7546027862, 49.6887212752, 49.6758962906, 49.6690991285, 49.6672174899, 49.6553864567, 49.5814394252,
	49.5153552649, 49.5068108236, 49.4963833884, 49.4782564817, 49.5101163107, 49.5586448486, 49.5207093684,
	49.5074774442, 49.4406049798, 49.4128387781, 49.3546195463, 49.2625591716, 49.1939206986, 49.0547111628,
	48.9463143931, 48.9255820538, 48.9013589096, 48.8502843850, 48.8228349041, 48.8103957863, 48.7790005115,
	48.7404972801, 48.6007623486, 48.5978269623, 48.5431799555, 48.4343389196, 48.3673098903, 48.3623446893,
	48.3002214088, 48.2842975349, 48.2027446809, 48.1354058213, 48.1283254795, 48.1108409403, 48.1083551841,
	48.0948244592, 48.0917442865, 48.0490857969, 47.9815553203, 47.9718362033, 47.9693803640, 47.9017147183,
	47.8973636033, 47.8696437925, 47.8674213042, 47.8539508969, 47.8184747410, 47.8119878119, 47.7975912567,
	47.7438900395, 47.6759595621, 47.6705026517, 47.6551526536, 47.5314593486, 47.3893432940, 47.2786527498,
	47.2104541938, 47.1916887821, 47.2244299542, 47.3055993013, 47.3394560126, 47.3730688993, 47.4224689189,
	47.4461037647, 47.4751469148, 47.4445406375, 47.4256379087, 47.4585697079, 47.5402448341, 47.6626179975,
	47.8134482035, 47.8199285325, 47.8312217884, 47.8752800288, 47.9342354037, 48.0652732849, 48.1594370738,
	48.1769409180, 48.3397141403, 48.3627709583, 48.3763465187, 48.4582951951, 48.4684753983, 48.4747206127,
	48.5567992930, 48.6797898967, 48.8313892519, 48.9630546570, 48.9911931266, 49.0719413757, 49.2355210573,
	49.3044649079, 49.3299069209, 49.3766130588, 49.3870932572, 49.5340409818, 49.6496524633, 49.7107364897,
	49.7282249570, 49.7402166670, 49.8284548115, 49.9597206116, 50.0623064255, 50.0624961853, 50.2255471601,
	50.3721083880, 50.4874194439, 50.5184242933, 50.5498438790, 50.6223376333, 50.6394924720, 50.6634654227,
	50.6977018285, 50.7239406320, 50.7432441985, 50.7497953192, 50.8644603246, 50.8800584865, 50.9338629556,
	50.9367963147, 50.9606888896, 50.9658242997, 51.0802565870, 51.1522698600, 51.1690873544, 51.1911245159,
	51.2036223189, 51.3176534509, 51.3894205049, 51.4031868003, 51.4048283136, 51.4143330855, 51.4613526552,
	51.5329053923, 51.5401067963, 51.5633273861, 51.5857144271, 51.5809322981, 51.5919137822, 51.5936184548,
	51.6243224448, 51.6376875502, 51.6945822266, 51.7657981003, 51.7740985386, 51.8100809016, 51.8427772522,
	51.9364696236, 51.9505577087, 52.1098546140, 52.1294604832, 52.2134306726, 52.3566084660, 52.4204154825,
	52.4386446172, 52.4579014078, 52.4779264371, 52.4908727619, 52.5784585242, 52.7214108168, 52.7378350866,
	52.8098848534, 52.9223421230, 52.9416922725, 52.9525497317, 53.0648625583, 53.1355752923, 53.1361411277,
	53.1732469527, 53.2050727981, 53.2614341570, 53.2741838961, 53.3134505691, 53.3749173363, 53.4125691889,
	53.4679960298, 53.5133573021, 53.5902770879, 53.6091356880, 53.7512043856, 53.8630241892, 53.8932081117,
	53.9086092994, 54.0355529785, 54.1932601062, 54.2226915962, 54.2372207642, 54.3298342927, 54.3338890076,
	54.4915295094, 54.6332547122, 54.6914251501, 54.7296143083, 54.7523985344, 54.7530046799, 54.8328012387,
	54.9656453292, 55.0075915675, 55.1538380050, 55.2239455677, 55.2623376226, 55.2717845684, 55.3906956134,
	55.5372121508, 55.6644439697, 55.7082369910, 55.7340274950, 55.7804159330, 55.8135767809, 55.8694373998,
	56.0161795019, 56.0975919759, 56.1194913454, 56.1960870717, 56.2272475456, 56.3547210693, 56.5130862162,
	56.5537401276, 56.6099905658, 56.6165530552, 56.6369674812, 56.6649971008, 56.8232872029, 56.8714218564,
	56.9190821893, 56.9702899684, 56.9943226359, 57.1365565049, 57.2485046322, 57.2587869947, 57.2687136768,
	57.3805376143, 57.4509504949, 57.4592460266, 57.4769751958, 57.4791831642, 57.5196572444, 57.5280973395,
	57.5481613996, 57.5603666231, 57.5677744135, 57.5897991179, 57.5801108121, 57.5877082271, 57.5873887928,
	57.6057956033, 57.6105257519, 57.6229348897, 57.6928733918, 57.7110007214, 57.7613047114, 57.7647209167,
	57.9210408222, 58.0014558869, 58.0523705793, 58.0668404090, 58.1415081153, 58.2819787705, 58.2831222362,
	58.3291664124, 58.3688787982, 58.4283332825, 58.4535524616, 58.5286064148, 58.6847397682, 58.7113241490,
	58.7322235107, 58.8155833925, 58.8308296204, 58.9869061320, 59.0737021650, 59.0843503698, 59.2079535714,
	59.2622365598, 59.3877754211, 59.3941701632, 59.4913825989, 59.6473586601, 59.7419491717, 59.7775001526,
	59.9333937309, 59.9687036225, 59.9891711042, 60.0711097717, 60.1585418986, 60.2416687012, 60.2515318309,
	60.2923014122, 60.2924907830, 60.3872628210, 60.5127792358, 60.6687138391, 60.8089145770, 60.8102373535,
	60.8988086352, 61.0091385780, 61.0105793864, 61.1617351622, 61.1888753564, 61.2605935245, 61.2841201040,
	61.3033541251, 61.3048496283, 61.4491455175, 61.5744400024, 61.6799713889, 61.6861076355, 61.6674957275,
	61.6636085510, 61.6597251892, 61.6566619873, 61.6527786255, 61.6491622925, 61.6436119080, 61.6266670227,
	61.6029717135, 59.6619388648  };
	double SRlat50[520]={
	22.0000000000, 21.9947868325, 21.9479197203, 21.9144439697, 21.8788871765, 21.8355560303, 21.8022232056,
	21.7658329010, 21.7222213745, 21.6716670990, 21.6606161111, 21.6857158115, 21.7898753270, 21.9189592587,
	22.0601266772, 22.1992962399, 22.2213937721, 22.2320969626, 22.2667105109, 22.2901520426, 22.3943048018,
	22.4070784979, 22.4284929314, 22.4304279751, 22.5345791579, 22.6172056321, 22.6220765857, 22.6507411747,
	22.6565372215, 22.7606858566, 22.8006525096, 22.8367928774, 22.8593246272, 22.9131802692, 22.9801402289,
	22.9942901351, 23.0020811748, 23.1736567155, 23.1828418417, 23.1819525229, 23.2087552559, 23.2721661188,
	23.2711191608, 23.2769172605, 23.2686186269, 23.2954209933, 23.3328692612, 23.3537550947, 23.3623955340,
	23.3770875907, 23.4147898464, 23.4184768791, 23.4245092568, 23.4409777746, 23.4615615568, 23.4709764255,
	23.4904934153, 23.5004219476, 23.5693014703, 23.5759627916, 23.6198569447, 23.6651081656, 23.6815225685,
	23.7394705210, 23.7467987518, 23.8055797942, 23.8142969640, 23.9184324177, 23.9671369327, 24.0003757423,
	24.0446603700, 24.0767631000, 24.0984916829, 24.1115149129, 24.2156469448, 24.2804129028, 24.3009242193,
	24.3641039985, 24.3853641865, 24.5144256678, 24.5354703974, 24.5999787393, 24.6167131562, 24.6415979633,
	24.6448026867, 24.7738618735, 24.8035035503, 24.8608034342, 24.9489899233, 24.9610768936, 25.1022364193,
	25.1578263651, 25.1632808205, 25.1027849865, 25.0949684639, 24.9699359853, 24.8721382267, 24.8453159538,
	24.8030277244, 24.7774394780, 24.7141636453, 24.7102184722, 24.6124176815, 24.5802847773, 24.5632506373,
	24.5523359712, 24.5288338973, 24.4509831834, 24.3694353250, 24.3503286998, 24.3266587272, 24.2016187632,
	24.1327257761, 24.0688437046, 24.0349819672, 23.9949566533, 23.8971475772, 23.8362675297, 23.8296076052,
	23.8257541257, 23.7699270217, 23.7090458399, 23.7038352175, 23.6804356938, 23.6748282991, 23.6526571493,
	23.6440684486, 23.6307131671, 23.6127863235, 23.6197078370, 23.6125097580, 23.6126989715, 23.6013975453,
	23.6281984993, 23.6580420641, 23.6600921764, 23.6530657105, 23.6609272879, 23.6544523529, 23.6812530811,
	23.6930642029, 23.7009890548, 23.7008428846, 23.7045792752, 23.6947298325, 23.6994212339, 23.6900091448,
	23.7022292630, 23.6811109334, 23.6585391774, 23.5976570042, 23.5971388839, 23.5584916214, 23.5510113771,
	23.5362691671, 23.5183420521, 23.5199382250, 23.5086202965, 23.5354216450, 23.5413305978, 23.5402860973,
	23.5670873113, 23.5810743710, 23.5931988021, 23.6620774220, 23.7662146221, 23.8485861703, 23.8419542533,
	23.8687541819, 23.9376301129, 24.0417641486, 24.1708286541, 24.2799458967, 24.2744531691, 24.3012512444,
	24.3701229317, 24.4742519731, 24.5417085710, 24.5531378784, 24.6821978769, 24.7045070854, 24.7217469558,
	24.7592397538, 24.8020213668, 24.8523615852, 24.8778536754, 25.0069107926, 25.0691927706, 25.0980178460,
	25.1304718572, 25.2084000408, 25.2246565318, 25.2833988467, 25.2954005704, 25.3575622534, 25.3902533813,
	25.4364481292, 25.5655002533, 25.6658060629, 25.6791074767, 25.6938075449, 25.7169421608, 25.7886613250,
	25.9177102764, 25.9843048186, 26.0046517794, 26.1458085009, 26.2849966806, 26.3608986844, 26.4346367987,
	26.5372295035, 26.5703684867, 26.5970883835, 26.6259249200, 26.7144718860, 26.7262416605, 26.7950889902,
	26.8991893596, 26.9392696222, 26.9625192628, 27.0611996473, 27.0875159002, 27.1115213198, 27.1416042970,
	27.1481815052, 27.2170244924, 27.2198326501, 27.2467481710, 27.3508430659, 27.4798777064, 27.5179591825,
	27.6373712866, 27.7592977911, 27.8369405415, 27.9659706454, 28.0199927216, 28.0534670523, 28.0724150917,
	28.0852667239, 28.0911545325, 28.1316540772, 28.2606814104, 28.3345998728, 28.3369268283, 28.4659522224,
	28.4989700520, 28.5517816382, 28.5686307165, 28.5813639705, 28.6488466096, 28.6549741444, 28.6823391413,
	28.7330264071, 28.8620480379, 28.9032753944, 28.9324040261, 28.9531753679, 29.0219993944, 29.1260723229,
	29.2550901905, 29.3962378102, 29.5354417071, 29.6587665591, 29.6852320797, 29.7362640433, 29.7748505282,
	29.8107079347, 29.8333771331, 29.8908998820, 30.0320456496, 30.1712527311, 30.2945845788, 30.3896458018,
	30.4468509877, 30.4475671714, 30.4518501354, 30.4567190553, 30.4790717439, 30.4935488950, 30.4805045362,
	30.4824385892, 30.4598873483, 30.4495856100, 30.5067928403, 30.6301284159, 30.6380099451, 30.6642883497,
	30.7876256839, 30.8826932431, 30.9399031288, 30.9543814908, 30.9505017642, 30.9593806516, 30.9368274765,
	30.9061721777, 30.9026631869, 30.8818884361, 30.8804426658, 30.8150659075, 30.7134716686, 30.6063379085,
	30.6129596379, 30.6142826962, 30.6476809213, 30.6621585141, 30.6479717038, 30.6479926358, 30.6254407257,
	30.5600666650, 30.4584757244, 30.4039599591, 30.3762559987, 30.2486875304, 30.1421770105, 30.1209853554,
	30.0605889755, 30.0373751951, 30.0032942537, 30.0003557047, 29.8987719439, 29.8711962073, 29.8234947534,
	29.8183051715, 29.7971080785, 29.7947998889, 29.6932187447, 29.5656571801, 29.4606182170, 29.4410002981,
	29.4353632803, 29.3337866861, 29.2062287174, 29.1199834967, 29.1170634524, 29.0574717134, 29.0154606391,
	28.8879058344, 28.8426687593, 28.8012409919, 28.6605109382, 28.6372637806, 28.6176386857, 28.6069064580,
	28.5793607933, 28.5554397687, 28.5043620163, 28.3768122520, 28.3244515141, 28.2920823459, 28.2957721006,
	28.2825148499, 28.2841048490, 28.2615622877, 28.2526154478, 28.2407303064, 28.1753808178, 28.1178709744,
	28.1095457817, 28.0921790966, 28.0893408148, 28.0834236489, 28.0710074503, 28.0056596679, 27.9908335742,
	27.9578831553, 27.8563249371, 27.8214670552, 27.8164952678, 27.7149387816, 27.5873967093, 27.5838047160,
	27.5667752815, 27.5379334468, 27.5120542027, 27.5004942989, 27.4948988174, 27.4666546249, 27.4612876479,
	27.4358112267, 27.4293434946, 27.3939780384, 27.3912882194, 27.3259472169, 27.2243967056, 27.1697232426,
	27.1757468260, 27.1902156125, 27.1676772366, 27.1541142969, 27.1557708036, 27.1425311351, 27.1429934751,
	27.1204552779, 27.0551169536, 27.0021640987, 26.9966981403, 27.0149618729, 27.0151991583, 27.0791281674,
	27.1311029817, 27.1646832255, 27.2218587733, 27.2298462513, 27.2605445102, 27.2752121152, 27.3702358459,
	27.4274132296, 27.4418826352, 27.4356379536, 27.4457007666, 27.4827337976, 27.4956617380, 27.5402339789,
	27.5974128861, 27.6066574699, 27.6151893314, 27.6238855772, 27.6360232490, 27.6504931699, 27.6279530431,
	27.6092945473, 27.6012865037, 27.5982738705, 27.5953671335, 27.5985503446, 27.5760104161, 27.5539083259,
	27.5471199166, 27.5236006837, 27.5201768125, 27.4548345308, 27.3532824548, 27.3346781743, 27.3301128091,
	27.2285622474, 27.1010248599, 27.0481646153, 27.0160287851, 27.0019501518, 26.9285322600, 26.8746798868,
	26.8382568212, 26.7603274735, 26.7468694322, 26.6061462764, 26.5580633184, 26.5094855674, 26.5078987388,
	26.4743818277, 26.4440975263, 26.4327509902, 26.3052211826, 26.1890170292, 26.1817662096, 26.1821589719,
	26.1596243808, 26.1222454049, 26.1149029438, 26.1081744811, 26.0974049925, 26.0320766704, 26.0310267211,
	26.0363269101, 26.0305950955, 26.0374388944, 26.0337989641, 26.0424380552, 26.0199039835, 26.0075324662,
	26.0099387418, 25.9979044949, 25.9996600400, 25.9771261271, 25.9367196758, 25.9351817789, 25.8776203354,
	25.8990832833, 25.9135489713, 25.9126250534, 25.9238257657, 25.9012921340, 25.8572294017, 25.8613276731,
	25.8387942728, 25.8223375052, 25.8193781250, 25.8288264524, 25.8161853065, 25.8257708799, 25.8243448089,
	25.8404725078, 25.8404943394, 25.8779727993, 25.8924384366, 25.8699049212, 25.8045787995, 25.8033619292,
	25.7620779174, 25.6605461134, 25.6579023217, 25.6360171596, 25.6233469292, 25.6129612143, 25.6019759077,
	25.6095974381, 25.6108104291, 25.6679723105, 25.6824374448, 25.6636258333, 25.6572208405, 25.6116657257,
	25.5591659546, 25.5063896179, 25.4536094666, 25.4008331299, 25.3480548859, 25.2983322144, 25.2458324432,
	25.1987644232, 22.0000000000  };

//	double pi = 4.0*atan(1.0);
	float CRDLN1[520][2];
	for(int i=0;i<520;i++)
	{
		CRDLN1[i][0] = (float)(SRlon50[i]*pi/180.0);
		CRDLN1[i][1] = (float)(SRlat50[i]*pi/180.0);
	}
	float RLON1 = (float)(RLON_deg1*pi/180.0),	  RLAT1 = (float)(RLAT_deg1*pi/180.0),
		  RLON2 = (float)(RLON_deg2*pi/180.0),	  RLAT2 = (float)(RLAT_deg2*pi/180.0);

	float CROSVEK[100];
/////////////////////////////////////////////////////////////////////////////////
	float RLON3,RLAT3,RDIST3, RAZIM3,RDIST32;
	GEOPPDA( &RLON1 ,&RLAT1, &RLON2,&RLAT2, &RDIST3, &RAZIM3);
	float CRDLN2[10][2];
	long NRPNT2 = 10;
	for( i=0;i<NRPNT2;i++)
	{
		RDIST32=i*RDIST3/(NRPNT2-1);
		GEOPDAP( &RLON1 ,&RLAT1, &RDIST32, &RAZIM3, &RLON3, &RLAT3);
		CRDLN2[i][0] = RLON3;	CRDLN2[i][1] = RLAT3;
	}

/////////////////////////////////////////////////////////////////////////////////
	long NRPNT1 = 520, C180=0, IEND=0, MAXCROS=100, CROSS, IREST;
	GEOC2L( (float *)CRDLN1, &NRPNT1, (float *)CRDLN2, &NRPNT2,
						&C180, &IEND, (float *)CROSVEK,  &MAXCROS, &CROSS, &IREST);

	///////////////////////Sort Long///////////////////////////////////
	float z1;
	for(int j=0;j<CROSS;j++)
	{
		for(i = j+1;i<CROSS;i++)
		{
			if(CROSVEK[2*i]<CROSVEK[2*j])
			{
				z1 = CROSVEK[2*i];		CROSVEK[2*i] = CROSVEK[2*j];		CROSVEK[2*j] = z1;
				z1 = CROSVEK[2*i+1];	CROSVEK[2*i+1] = CROSVEK[2*j+1];	CROSVEK[2*j+1] = z1;
			}
		}
	}
	double *CROSVEK0;	CROSVEK0 = new double[2*CROSS+4];
	if(RLON1<RLON2)
	{
		CROSVEK0[0] = RLON1;			CROSVEK0[1] = RLAT1;
		CROSVEK0[2+2*CROSS  ] = RLON2;	CROSVEK0[2+2*CROSS+1] = RLAT2;
	}
	else
	{
		CROSVEK0[0] = RLON2;			CROSVEK0[1] = RLAT2;
		CROSVEK0[2+2*CROSS  ] = RLON1;	CROSVEK0[2+2*CROSS+1] = RLAT1;
	}
	if (CROSS>0)
		for(int i=0;i<2*CROSS;i++)
			CROSVEK0[i+2]=CROSVEK[i];

	*dSuper = 0.0; *dLand = 0.0; *dWarm = 0.0; *dCold = 0.0;

	float POINT1[1][2], rng,  lat1,lon1,lat2,lon2;
	double Dland1, Dsea1, DseaW1;
	long LineS;
	for( i=0;i<CROSS+1;i++)
	{
		lon1 = (float)CROSVEK0[2*i];		lat1 = (float)CROSVEK0[2*i+1];
		lon2 = (float)CROSVEK0[2*i+2];		lat2 = (float)CROSVEK0[2*i+3];
		POINT1[0][0] = (lon1+lon2)/2.f;		POINT1[0][1] = (lat1+lat2)/2.f;
		LineS = -GEOPIA2( (float *)POINT1, (float *)CRDLN1, &NRPNT1);
		if (LineS==1)
		{
			GEODSTR( &lon1, &lat1, &lon2, &lat2, &rng);
			*dSuper = *dSuper + rng;
		}
		else
		{
			CoastalArea(CROSVEK0[2*i+1]*180.0/pi, CROSVEK0[2*i  ]*180.0/pi, 
						CROSVEK0[2*i+3]*180.0/pi, CROSVEK0[2*i+2]*180.0/pi, 
										  &Dland1 ,&Dsea1 ,&DseaW1 ) ;
			*dLand = *dLand + Dland1;
			*dWarm = *dWarm + DseaW1;
			*dCold = *dCold + (Dsea1-DseaW1);
		}
	}
	delete [] CROSVEK0;
}

void CSMS4DCView::SuperRefract100(double RLAT_deg1,double RLON_deg1,double RLAT_deg2,double RLON_deg2,double *dLand,double *dWarm,double *dCold,double *dSuper) 
{
	double SRlon100[354]={
	59.6619388648, 59.6594646128, 59.6576089241, 59.6205558777, 59.5847206116, 59.5713882446, 59.5324935913,
	59.4980583191, 59.4822196960, 59.4711112976, 59.4569396973, 59.4305534363, 59.4016647339, 59.3738861084,
	59.3494453430, 59.3227729797, 59.2744445801, 59.2283325195, 59.1816635132, 59.1397171021, 59.1186855997,
	59.1219688900, 59.0851416835, 58.8769827733, 58.7483863432, 58.7147173172, 58.6327425110, 58.6281929219,
	58.4961001662, 58.4546315009, 58.4497627397, 58.4408560943, 58.3189522939, 58.2988709908, 58.2623909792,
	58.2510764968, 58.1966631780, 58.1629588703, 58.1486856880, 58.1454021916, 57.9427792650, 57.8735027479,
	57.8562632697, 57.5533951709, 57.4797442170, 57.3613112522, 57.3443131673, 57.2609729173, 57.1867698892,
	57.1658770123, 57.1540056749, 57.0605394611, 57.0200099931, 56.9665777340, 56.9281400866, 56.8717780240,
	56.6012205927, 56.5944756741, 56.5079394399, 56.4619415797, 56.4296026096, 56.3706615195, 56.3562493762,
	56.2964301777, 56.2792685306, 56.0677690536, 56.0430582484, 56.0092033884, 55.9880728752, 55.8108978526,
	55.7779444752, 55.7570212290, 55.7248518581, 55.7031474380, 55.6263574320, 55.5751011781, 55.5203803250,
	55.5105080435, 55.5057443930, 55.3570907588, 55.2773247120, 55.2393452812, 55.2001872798, 55.1764014439,
	54.9509091270, 54.7023201688, 54.6798159673, 54.3999735692, 54.3552396931, 54.3013044436, 54.2531727372,
	54.2020801830, 54.1283587453, 54.0975884983, 53.7909071742, 53.7515708703, 53.6897986873, 53.6887259183,
	53.5917444684, 53.2881271482, 53.2825159773, 53.2639848148, 53.2084008642, 52.9400522543, 52.8806136355,
	52.8539354611, 52.8281579117, 52.6416907827, 52.6372734205, 52.5482760668, 52.4841184766, 52.4501774805,
	52.1437122064, 52.1346497326, 52.0375971984, 51.7341901594, 51.7304625833, 51.5613359398, 51.5337700225,
	51.4648847760, 51.1941374209, 51.0713250686, 50.9722436565, 50.7009264356, 50.4892211086, 50.4428603652,
	50.1783500935, 49.9659119419, 49.9315083753, 49.9198433368, 49.8341832121, 49.8334690511, 49.8143222565,
	49.7704433649, 49.7447031810, 49.7185568780, 49.5866975032, 49.5818105316, 49.5452470240, 49.5369278668,
	49.4764102208, 49.4702730196, 49.4061884837, 49.3894035104, 49.3417615447, 49.2092526944, 49.2010819367,
	49.1674072162, 49.0344790520, 49.0256575547, 49.0151556333, 48.9777371388, 49.0095226137, 49.0009310849,
	48.7452524177, 48.5283775677, 48.5074854048, 48.4831924455, 48.4439267453, 48.2901756300, 48.2872482323,
	48.2325128297, 48.0147475988, 47.8798653213, 47.8747406144, 47.8120844246, 47.8056085507, 47.7813286227,
	47.6458058727, 47.6428711497, 47.6265408280, 47.4906220353, 47.4809972451, 47.4098407414, 47.4053904495,
	47.3938621594, 47.3873954834, 47.3728986031, 47.3189876066, 47.2712695648, 47.0736415216, 46.8521697669,
	46.7148704872, 46.6759625534, 46.7401237159, 46.9017202922, 46.9199272231, 46.9066303459, 46.9711295530,
	47.1337132792, 47.3786058691, 47.6812789088, 47.6877626631, 47.6990454788, 47.7431197569, 47.8020208652,
	48.0648274665, 48.1481519096, 48.3942829059, 48.6985196041, 48.9630546570, 48.9911940024, 49.0719413757,
	49.4005686800, 49.4694254857, 49.4948936164, 49.5415405243, 49.5520403812, 49.8468165063, 49.9241160523,
	49.9597206116, 50.0622997192, 50.0624961853, 50.3900432850, 50.6840352418, 50.9146118351, 50.9453519573,
	50.9766690871, 51.1207304763, 51.1312029316, 51.1492682957, 51.1652329910, 51.2891827822, 51.3046691658,
	51.3582584784, 51.3586927444, 51.5040892244, 51.6472212236, 51.6509887073, 51.7399520842, 51.8826078904,
	51.8959475238, 51.8975830401, 51.8977930321, 52.0245570966, 52.0315430632, 52.0545652700, 52.0753110210,
	52.1134454796, 52.1450477793, 52.2704331468, 52.2900203619, 52.3739767150, 52.6611028753, 52.6972198501,
	52.7387411376, 53.0254096141, 53.0417975596, 53.1137449071, 53.3386201931, 53.3525137031, 53.4805878820,
	53.5215792971, 53.5342558860, 53.5719240165, 53.6272913297, 53.6726643137, 53.7494996395, 53.7683858381,
	54.0532608047, 54.1180297629, 54.3521783725, 54.3665768758, 54.6503781747, 54.7066546781, 54.7324937743,
	54.9787511059, 55.1150721821, 55.4089734454, 55.5434674506, 55.5933750422, 55.8877351099, 55.9691421654,
	55.9910253419, 56.0676198098, 56.0987561884, 56.3547210693, 56.6726917906, 56.6972256265, 56.9828144006,
	57.0308974750, 57.0785658840, 57.1297176690, 57.1537658177, 57.4389760644, 57.6628341703, 57.6681925435,
	57.7943917901, 57.9344296642, 57.9424937775, 57.9600840209, 57.9622376647, 58.0023865308, 58.0105933634,
	58.0305008954, 58.0423659226, 58.0497211753, 58.0925753986, 58.0907214599, 58.0954263373, 58.1588423253,
	58.2097766947, 58.2242344981, 58.2988897880, 58.3887322807, 58.4283332825, 58.4535531733, 58.5286064148,
	58.8275740014, 58.8308296204, 59.1441203894, 59.2308265196, 59.2415064916, 59.2686606583, 59.3877754211,
	59.3941724858, 59.4913825989, 59.8044679032, 59.8702490539, 60.0328520028, 60.0711097717, 60.1459554928,
	60.1658983752, 60.1661196516, 60.2608181262, 60.5127792358, 60.8257797388, 61.1068622935, 61.1082050201,
	61.1966461752, 61.2499194826, 61.3229330570, 61.5744400024, 61.8124947222, 61.8060546334, 61.7977752686,
	61.7899971008, 61.7830543518, 61.7774963379, 61.7397193909, 61.6863899231, 61.6850013733, 61.7038879395,
	61.6861076355, 61.6674957275, 61.6636085510, 61.6597251892, 61.6566619873, 61.6527786255, 61.6491622925,
	61.6436119080, 61.6266670227, 61.6029717135, 59.6619388648  };
	double SRlat100[354]={
	22.0000000000, 21.9947868325, 21.9479197203, 21.9144439697, 21.8788871765, 21.8355560303, 21.8022232056,
	21.7658329010, 21.7222213745, 21.6716670990, 21.6269435883, 21.5891666412, 21.5491657257, 21.5113887787,
	21.4691658020, 21.4300003052, 21.4102764130, 21.3869438171, 21.3647212982, 21.3363876343, 21.3195069325,
	21.3185908330, 21.3314540481, 21.5393321936, 21.7971576289, 22.0622188996, 22.1437167947, 22.1527955025,
	22.2839806821, 22.3666394726, 22.3714715693, 22.3892126620, 22.5100704622, 22.5500259037, 22.5861717759,
	22.6086702303, 22.6625534332, 22.7295319370, 22.7436572032, 22.7501780053, 22.7859469153, 22.8211959601,
	22.8191819186, 22.8726115525, 22.9100612608, 22.9309449125, 22.9395841091, 22.9542771119, 22.9919836065,
	22.9956658737, 23.0016963850, 23.0181664828, 23.0387514008, 23.0481647518, 23.0676826592, 23.0776098988,
	23.2149621809, 23.2216016142, 23.2655155453, 23.3107757154, 23.3271785932, 23.3851457220, 23.3924520472,
	23.4512518728, 23.4599474344, 23.6677295121, 23.7164288431, 23.7496665851, 23.7912810514, 23.9649213266,
	24.0297006053, 24.0501920653, 24.1133838300, 24.1346255522, 24.2853578458, 24.2412634960, 24.2176874429,
	24.2011133005, 24.1774526466, 23.9277940163, 23.8588849388, 23.7950282320, 23.7611634926, 23.7211463335,
	23.5260187571, 23.4182964425, 23.3988026843, 23.2774150547, 23.2722060018, 23.2488051566, 23.2431991878,
	23.2210268527, 23.2124385478, 23.1990830607, 23.1633495776, 23.1702705160, 23.1630730121, 23.1632617585,
	23.1519608006, 23.2053848210, 23.2082305541, 23.2114899524, 23.2050156024, 23.2522142340, 23.2452930776,
	23.2499839027, 23.2469822003, 23.1660271840, 23.1655123551, 23.1268621401, 23.1193825076, 23.1046398780,
	23.0689053166, 23.0705009665, 23.0591835620, 23.1126091502, 23.1145009877, 23.1442744127, 23.1582613249,
	23.1703855704, 23.3077342592, 23.4285360895, 23.4459374273, 23.5832754140, 23.7910518308, 23.8823226228,
	24.0157500287, 24.2235065080, 24.2909858498, 24.3023863431, 24.4702854384, 24.4709824209, 24.5084560679,
	24.5512506307, 24.6015931892, 24.6270770740, 24.8847948499, 24.9220606740, 24.9575977896, 24.9738097771,
	25.0325907567, 25.0445426071, 25.1067483826, 25.1394143575, 25.1856281019, 25.4433258240, 25.5052486837,
	25.5378137122, 25.7954986908, 25.8620889882, 25.8824309881, 26.1646114430, 26.3060560001, 26.3142945579,
	26.4406116578, 26.6482536928, 26.6883333559, 26.7115785237, 26.7868601935, 26.8625285519, 26.8653203496,
	26.8922509145, 27.0998711011, 27.3574985884, 27.3954856503, 27.5149750204, 27.5628869088, 27.5859291830,
	27.8435384420, 27.8651647521, 27.8806186653, 28.1382167907, 28.2088872546, 28.3434649190, 28.3760585544,
	28.3978073959, 28.4038956973, 28.4312242300, 28.4819415053, 28.5718237627, 28.6674222416, 28.8749547714,
	29.1325148558, 29.4146576695, 29.6932995998, 29.9404822544, 29.9547528057, 30.0503877685, 30.3290421871,
	30.5762527545, 30.7670147427, 30.8819027150, 30.8826193309, 30.8869018230, 30.8917728804, 30.9141232154,
	30.9431604400, 31.0692565787, 31.2600440110, 31.3749509234, 31.4040422938, 31.4001619846, 31.4090414546,
	31.3637273211, 31.3330764647, 31.3295634541, 31.3087918619, 31.3073432077, 31.1760514536, 31.1078921155,
	31.1118193171, 31.0976317654, 31.0976534388, 31.0523444104, 30.9210635222, 30.7172352458, 30.6627289743,
	30.6350223461, 30.3793836696, 30.3122052922, 30.2961695541, 30.2677497631, 30.1575777039, 30.1299738579,
	30.0823066918, 30.0815320912, 29.9520413535, 29.6964301699, 29.6721411160, 29.5926385899, 29.3370417279,
	29.2508190671, 29.2478863471, 29.2465281755, 29.0187540532, 28.9734978143, 28.9320987585, 28.7976230577,
	28.7632807320, 28.7062398702, 28.6884943357, 28.6795470475, 28.6676625985, 28.5364806498, 28.5038284272,
	28.4979417275, 28.3667666463, 28.3519283758, 28.3189921412, 28.1152951151, 28.0900776424, 27.9739201042,
	27.8994294426, 27.8935988542, 27.8882290036, 27.8627552867, 27.8562852190, 27.8209244148, 27.8182303827,
	27.6870825881, 27.6280882235, 27.5946219724, 27.5879803496, 27.5474005557, 27.5214311244, 27.5421666834,
	27.6385104002, 27.7477122144, 27.8624881998, 27.8777845061, 27.9177044639, 28.0324865836, 28.0417311672,
	28.0502628956, 28.0589595776, 28.0710966568, 28.1001539729, 28.0548924720, 28.0436214488, 28.0029504461,
	27.9808505426, 27.9740602808, 27.9505439188, 27.9471174881, 27.8159645457, 27.6122921518, 27.6025252791,
	27.4875816858, 27.2320668105, 27.1791976436, 27.1470797928, 27.1329526215, 27.0595925769, 27.0057286238,
	26.9693267276, 26.8914084732, 26.8779490306, 26.5963612611, 26.5873501271, 26.5787100149, 26.5492056645,
	26.5418596523, 26.5351306410, 26.5243618981, 26.4825409475, 26.4870996973, 26.4834593123, 26.4920988581,
	26.4489459476, 26.4493208430, 26.4040843860, 26.3636831426, 26.3621405090, 26.3494834795, 26.3632097743,
	26.3622854320, 26.3734865687, 26.3282512446, 26.2975809409, 26.2740754901, 26.2784872553, 26.2676648454,
	26.2755591710, 26.2755846823, 26.3130591900, 26.3420992396, 26.2968643840, 26.1657764628, 26.1645378299,
	26.1232772970, 26.0741171370, 26.1030602250, 26.1320982478, 26.0842855556, 26.0824483602, 25.9766654968,
	25.9269447327, 25.8763885498, 25.8313884735, 25.8016662598, 25.7950000763, 25.7480545044, 25.7019443512,
	25.6572208405, 25.6116657257, 25.5591659546, 25.5063896179, 25.4536094666, 25.4008331299, 25.3480548859,
	25.2983322144, 25.2458324432, 25.1987644232, 22.0000000000  };

//	double pi = 4.0*atan(1.0);
	float CRDLN1[354][2];
	for(int i=0;i<354;i++)
	{
		CRDLN1[i][0] = (float)(SRlon100[i]*pi/180.0);
		CRDLN1[i][1] = (float)(SRlat100[i]*pi/180.0);
	}
	float RLON1 = (float)(RLON_deg1*pi/180.0),  RLAT1 = (float)(RLAT_deg1*pi/180.0),
		  RLON2 = (float)(RLON_deg2*pi/180.0),  RLAT2 = (float)(RLAT_deg2*pi/180.0);

	float CROSVEK[100];
/////////////////////////////////////////////////////////////////////////////////
	float RLON3,RLAT3,RDIST3, RAZIM3,RDIST32;
	GEOPPDA( &RLON1 ,&RLAT1, &RLON2,&RLAT2, &RDIST3, &RAZIM3);
	float CRDLN2[10][2];
	long NRPNT2 = 10;
	for( i=0;i<NRPNT2;i++)
	{
		RDIST32=i*RDIST3/(NRPNT2-1);
		GEOPDAP( &RLON1 ,&RLAT1, &RDIST32, &RAZIM3, &RLON3, &RLAT3);
		CRDLN2[i][0] = RLON3;		CRDLN2[i][1] = RLAT3;
	}
/////////////////////////////////////////////////////////////////////////////////
	long NRPNT1 = 354, C180=0, IEND=0, MAXCROS=100, CROSS, IREST;
	GEOC2L( (float *)CRDLN1, &NRPNT1, (float *)CRDLN2, &NRPNT2,
						&C180, &IEND, (float *)CROSVEK,  &MAXCROS, &CROSS, &IREST);

	///////////////////////Sort Long///////////////////////////////////
	float z1;
	for(int j=0;j<CROSS;j++)
	{
		for(i = j+1;i<CROSS;i++)
		{
			if(CROSVEK[2*i]<CROSVEK[2*j])
			{
				z1 = CROSVEK[2*i];		CROSVEK[2*i] = CROSVEK[2*j];			CROSVEK[2*j] = z1;
				z1 = CROSVEK[2*i+1];	CROSVEK[2*i+1] = CROSVEK[2*j+1];		CROSVEK[2*j+1] = z1;
			}
		}
	}
	double *CROSVEK0;	CROSVEK0 = new double[2*CROSS+4];
	if(RLON1<RLON2)
	{
		CROSVEK0[0] = RLON1;				CROSVEK0[1] = RLAT1;
		CROSVEK0[2+2*CROSS  ] = RLON2;		CROSVEK0[2+2*CROSS+1] = RLAT2;
	}
	else
	{
		CROSVEK0[0] = RLON2;				CROSVEK0[1] = RLAT2;
		CROSVEK0[2+2*CROSS  ] = RLON1;		CROSVEK0[2+2*CROSS+1] = RLAT1;
	}
	if (CROSS>0)
		for(int i=0;i<2*CROSS;i++)
			CROSVEK0[i+2]=CROSVEK[i];

	*dSuper = 0.0; *dLand = 0.0; *dWarm = 0.0; *dCold = 0.0;

	float POINT1[1][2], rng,  lat1,lon1,lat2,lon2;
	double Dland1, Dsea1, DseaW1;
	long LineS;
	for( i=0;i<CROSS+1;i++)
	{
		lon1 = (float)CROSVEK0[2*i];		lat1 = (float)CROSVEK0[2*i+1];
		lon2 = (float)CROSVEK0[2*i+2];		lat2 = (float)CROSVEK0[2*i+3];
		POINT1[0][0] = (lon1+lon2)/2.f;		POINT1[0][1] = (lat1+lat2)/2.f;
		LineS = -GEOPIA2( (float *)POINT1, (float *)CRDLN1, &NRPNT1);
		if (LineS==1)
		{
			GEODSTR( &lon1, &lat1, &lon2, &lat2, &rng);
			*dSuper = *dSuper + rng;
		}
		else
		{
			CoastalArea(CROSVEK0[2*i+1]*180.0/pi, CROSVEK0[2*i  ]*180.0/pi, 
						CROSVEK0[2*i+3]*180.0/pi, CROSVEK0[2*i+2]*180.0/pi, 
										  &Dland1 ,&Dsea1 ,&DseaW1 ) ;
			*dLand = *dLand + Dland1;
			*dWarm = *dWarm + DseaW1;
			*dCold = *dCold + (Dsea1-DseaW1);
		}
	}
	delete [] CROSVEK0;
}

void CSMS4DCView::OnPropagationmodelsP370Contour() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];

		long ID1 = atol(GetFld(m_Sel,1));
		CString Namest = GetFld(m_Sel,2);
		double Latst = atof(GetFld(m_Sel,3));
		double Lonst = atof(GetFld(m_Sel,4));
		OnDatabaseStationsindesktop(ID1,Namest, Latst, Lonst);

		CP370DLG p370dlg;
		p370dlg.m_CvShow = TRUE;
		if (p370dlg.DoModal()==IDOK)
		{
			BOOL DHflag = p370dlg.m_DHflag;
			double Delta_H = p370dlg.m_DH;
			double E1 = p370dlg.m_Cvalue;
			double t = p370dlg.m_time;
			double Lp = p370dlg.m_location;
			double h2 = p370dlg.m_RxH;
			double Hagl_ST = atof(GetFld(m_Sel,5));
			double f = atof(GetFld(m_Sel,6));
			double P370k = p370dlg.m_k;
			int syst = p370dlg.m_syst;
			int ENV = 1 + p370dlg.m_env;
			double PtGt_ST = atof(GetFld(m_Sel,7));
			double P370landsea = p370dlg.m_landsea;
			double AZ0 = atof(GetFld(m_Sel,8));
			double EL0 = atof(GetFld(m_Sel,9));
			CString P370ANT_ST = GetFld(m_Sel,14);

			CP370_Functions CP370;
			int k,  p = LandWarmColdSea(Lonst, Latst);

			double Hg = LatLon2Hg(Latst,Lonst) ;
			double /*pi = 4.0*atan(1.0), */r = 6371.0, Ghv = 1.0 ,elevp = 0.0;
			double h1, tetamax15 = 0.0, ttca = -999.999;
			double lat3km , lon3km,lat15km ,lon15km, lat015km , lon015km;
			double tetai, mds ,ds, hi, dk, az, E, Hv, Hmin, Hmax, fp,tp,f1,t1;
			double dkL,dkC,dkW,Dland,DSea,DseaC,DseaW,ELand,ESeaC,ESeaW,Efs,Eb;

AZ0 = (pi/180.0)*AZ0;	//931024
EL0 = (pi/180.0)*EL0;	//931024

			CString antfile;
			antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,P370ANT_ST);
			int f0[360];	double rH[360]  ,  rV[360];
			ReadAntennaData(antfile,f0,rH,rV) ;

			CString Fname;
			Fname.Format("%sP370%d%d%d%d%d%d%d%d%d.txt",Namest,(int)Lonst,(int)Latst,abs(E1),(int)t,(int)Lp,(int)h2,(int)P370k,syst,ENV);
	//		char strFilter[] = { "text Files (*.txt)|*.txt|prf Files (*.prf)|*.prf|All Files (*.*)|*.*||"};
	//		CFileDialog FileDLG(FALSE, ".txt", Fname, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, strFilter);
		
			CString strFilter = _Z("SMS4DC Vectors")+" (*.txt)|*.txt|"+_Z("Google Files")+" (*.kml)|*.kml||";
			CFileDLG_ChangedType FileDLG(FALSE, NULL, Fname, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT , strFilter);
			if (((CSMS4DCApp *)AfxGetApp())->IsWin2000())	FileDLG.m_ofn.lStructSize = 88;		//76
			if (FileDLG.DoModal() == IDOK)
			{
				PeekAndPump();
				FILE *fid=fopen(FileDLG.GetPathName(),"wt");
				if(fid)
				{
					CString extFile = FileDLG.GetFileExt();		extFile.MakeUpper();
					CString nameFile = FileDLG.GetFileName();
					nameFile.Delete(nameFile.GetLength()-4,4);
					CString str1,str2,str0;
					if(extFile==_T("KML"))
					{
						CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
						str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:P1546Contour:%s</name>\n<open>1</open>"),nameFile);
						fprintf(fid,_T("%s\n"),str1);

						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),Namest,gifFile ,Lonst,Latst);
						fprintf(fid,_T("%s \n"),str2);

						str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
						fprintf(fid,_T("%s \n"),str2);
					}

CSMS4DCDoc* pDoc = GetDocument();													//97/12/28
double disttest1 = Distance_km(Latst,Lonst, Latst+0, Lonst+pDoc->m_Resolution_x); 
double disttest2 = Distance_km(Latst,Lonst, Latst+pDoc->m_Resolution_y, Lonst+0);	
double StepRes   = min(disttest1, disttest2);

					int progress_num = 0;
					CString progress_str, progress_char = "|";
					int num = 180;
					for(int i=0;i<=num;i++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(num+1),progress_char);
						progress_char = str_rep("|",(int)(progress_num*50.0/(num+1)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						az = i*360.0/num;

						fp=az*pi/180.0;		tp = (pi/2.0) - elevp;
						f1 = (180.0/pi)*atan2(sin(tp)*sin(fp-AZ0),(cos(EL0)*sin(tp)*cos(fp-AZ0)+cos(tp)*sin(EL0)));
						t1 = (180.0/pi)*acos(cos(tp)*cos(EL0)-sin(EL0)*sin(tp)*cos(fp-AZ0));
						if (f1<0.0)
							f1=f1+359.4;
						Ghv = Interp2(f0,rH,f1,360) * Interp2(f0,rV,t1,360);
						E = E1 - 10.0*log10(PtGt_ST*Ghv/1650.0);
						/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
						reckon( Latst,Lonst,  3.0 , az , &lat3km  , &lon3km) ;
						reckon( Latst,Lonst, 15.0 , az , &lat15km , &lon15km) ;
						h1 = Hg + Hagl_ST - Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km);
						///////////////////////////////// tetamax15 /////////////////////////////////////////////
						if (h1<0.0)
						{
							tetai = -pi/2.0;
							mds = 15.0;
							ds = 0.0;
							while( ds<= mds )  //ds=0->15
							{
								ds = ds + 0.1*StepRes;		//97/12/28
						//		ds = ds + 0.1;
								reckon( Latst,Lonst, ds , az , &lat015km , &lon015km) ;
								hi = LatLon2Hg_n(lat015km , lon015km) ;		//98/01/10
								tetai = max(tetai   ,(((hi-Hg-Hagl_ST)/(ds*1000.0))-(ds/(2.0*P370k*r))));
							}
							tetamax15 = -(180.0/pi)*tetai;
						}
						/////////////////////////////// Delta_H ////////////////////////////////////////
						if(DHflag)
						{
							reckon( Latst,Lonst,  10.0 , az , &lat3km  , &lon3km) ;
							ds = 0.0;	k = 0;
							Hv, Hmin = 99999999.0, Hmax = -99999999.0;
							while(ds<=40.0)
							{
								reckon( lat3km, lon3km,  ds , az , &lat15km , &lon15km) ;
								Hv = LatLon2Hg_n(lat15km ,lon15km); 	//98/01/10
								Hmin = min(Hmin,Hv);	Hmax = max(Hmax,Hv);
								ds = ds+40.0/12000.0;
								k++;
							}
							Delta_H = 0.8*(Hmax-Hmin);
						}
						//////////////////////////////////////////////////////////////////////////////
						if (P370landsea==1)
						{
							dkL = CP370.P370_7I(f,t,1,h1,  E,tetamax15,h2,ENV,Lp,syst,Delta_H);
							dkC = CP370.P370_7I(f,t,2,h1,  E,tetamax15,h2,ENV,Lp,syst,Delta_H);
							dkW = CP370.P370_7I(f,t,3,h1,  E,tetamax15,h2,ENV,Lp,syst,Delta_H);
							dk = max(dkL,max(dkW,dkC));
							reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;
							DSea = D_Sea_kmIDWM(Latst,Lonst,  lat3km , lon3km, &DseaW);
							Dland = dk - DSea;	DseaC = DSea - DseaW;

							if(dk==Dland)		dk = dkL;
							else if(dk==DseaC)	dk = dkC;
							else if(dk==DseaW)	dk = dkW;
							else
							{
								ELand = CP370.P370_7(f,t,1,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs) - CP370.Delta_H_cr(f,dk,Delta_H);
								ESeaC = CP370.P370_7(f,t,2,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs);
								ESeaW = CP370.P370_7(f,t,3,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs);
								Eb = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW)/dk;
								while(Eb<E)
								{
									dk=dk-0.1*StepRes;		//97/12/28
							//		dk=dk-0.1;
									reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;
									DSea = D_Sea_kmIDWM(Latst,Lonst,  lat3km , lon3km, &DseaW);
									Dland = dk - DSea;	DseaC = DSea - DseaW;
									ELand = CP370.P370_7(f,t,1,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs) - CP370.Delta_H_cr(f,dk,Delta_H);
									ESeaC = CP370.P370_7(f,t,2,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs);
									ESeaW = CP370.P370_7(f,t,3,h1,dk,tetamax15,h2,ENV,Lp,syst,ttca,&Efs);
									Eb = (Dland*ELand + DseaC*ESeaC + DseaW*ESeaW)/dk;
								}
							}
						}
						else	dk = CP370.P370_7I(f,t,p,h1,  E,tetamax15,h2,ENV,Lp,syst,Delta_H);
						reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;

lon3km = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lon3km);

						if(extFile==_T("TXT"))	fprintf(fid," %0.14f  %0.14f\n",lon3km,lat3km);
						else if(extFile==_T("KML"))
						{
							str2.Format(_T("%lf,%lf,%lf "),lon3km,lat3km,0.0);
							fprintf(fid,_T("%s \n"),str2);
							if(i==0)	str0 = str2;
						}

					}	// end for
					if(extFile==_T("KML"))
					{
						fprintf(fid,_T("%s \n"),str0);
						str2.Format(_T("</coordinates></LineString></Placemark>"));
						fprintf(fid,_T("%s \n"),str2);
						fprintf(fid,_T("</Folder>\n</kml>"));
					}
					fclose(fid);

					if		(extFile==_T("TXT"))	OnDrawVector(FileDLG.GetPathName()) ;
					else if	((extFile==_T("KML"))&&(FileDLG.m_ShowFlag))	ShellExecute(m_hWnd, "open", FileDLG.GetPathName(), NULL, NULL, SW_SHOWNORMAL);

				}	// end if fid
			}	// end if FileDLG
		}	//end if p370dlg
		OnDatabaseStationsindesktop(ID1,Namest, Latst, Lonst);		//98/01/10
	}	//end if datadlg
}



int CSMS4DCView::LandWarmColdSea(double RLON_deg,double RLAT_deg) 
{
	int WCSea = WarmColdSea(RLON_deg, RLAT_deg);

//	double pi=4.0*atan(1.0);
	float RLON = (float)(RLON_deg*pi/180.0);
	float RLAT = (float)(RLAT_deg*pi/180.0);

	long int N=4, IER;	GEOGCMS ( &N, &IER );

	float RLON1 = (float)(RLON-pi/90.0), RLAT1 = (float)(RLAT-pi/90.0),
		  RLON2 = (float)(RLON+pi/90.0), RLAT2 = (float)(RLAT+pi/90.0);

	long IVAL = 2 , IRANGE = 0,  NRPNT = 2;
	float  ARRAY[2][2]={RLON1, RLAT1, RLON2, RLAT2},  WND[2][2],  GC;
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOGCM( &IVAL, (float *)WND, &IRANGE);
	GEOGCP( &RLON, &RLAT, &GC);

	int p=1;
	if		((GC==1)&&(WCSea==0)) p=2;	//LandSea = "Coastal Zone : Cold Sea";
	else if ((GC==1)&&(WCSea==1)) p=3;	//LandSea = "Coastal Zone : Warm Sea";
	else if (GC==3)				  p=1;	//LandSea = "Coastal Zone : Coastal Land";
	else if (GC==4)			 	  p=1;	//LandSea = "Coastal Zone : Land";
	return p;
}

void CSMS4DCView::ReadAntennaData(CString antfile,int *f0,double *rH,double *rV) 
{
	FILE *fid;
	if( (fid  = fopen(antfile,"rt")) != NULL )
	{
		char Name [20],	 Gain_dBi [20],	 BeamWidth_H [20],	BeamWidth_V [20], Frq_Lo [20], Frq_Hi [20],
			 Frq_unit [20],	 Polarization [20],	 dum[20];
		char Ang[20],PatH[20],PatV[20];

		fscanf( fid, "%s %s", dum,Name);
		fscanf( fid, "%s %s", dum,Gain_dBi);
		fscanf( fid, "%s %s", dum,BeamWidth_H);
		fscanf( fid, "%s %s", dum,BeamWidth_V);
		fscanf( fid, "%s %s", dum,Frq_Lo);
		fscanf( fid, "%s %s", dum,Frq_Hi);
		fscanf( fid, "%s %s", dum,Frq_unit);
		fscanf( fid, "%s %s", dum,Polarization);
		fscanf( fid, "%s", dum);

//		double pi=4.0*atan(1.0);
		double rH1,rV1;
		for (int i=0;i<360;i++)
		{
			fscanf( fid, "%s %s %s", Ang,PatH,PatV);
			f0[i] = atoi(Ang);
			rH1 = atof(PatH);		rV1 = atof(PatV);
			rH1 = pow( 10.0 , (-rH1/10.0) );
			rV1 = pow( 10.0 , (-rV1/10.0) );
			rH[i]=rH1;		rV[i]=rV1;
		}
		fclose(fid);
	}
	else
	{
		CString str;
		str.Format(_Z("The Antenna name  [%s]  was not found!  \r\rThe Isotropic Antenna will be select."),antfile);
		MessageBox(str, _Z("Warning!!!"), MB_ICONWARNING | MB_OK);
		for (int i=0;i<360;i++)
		{
			f0[i] = i;		rH[i]=1.0;		rV[i]=1.0;
		}
	}
}

double CSMS4DCView::D_Sea_kmIDWM(double lat1_deg,double lon1_deg,double lat2_deg,double lon2_deg,
									   double *D_SeaW_km)  
{
//	double pi = 4.0*atan(1.0);

	float RLON1 = (float)(lon1_deg*pi/180.f), RLAT1 = (float)(lat1_deg*pi/180.f),
		  RLON2 = (float)(lon2_deg*pi/180.f), RLAT2 = (float)(lat2_deg*pi/180.f); 

	float RDIST, RAZIM;
	GEOPPDA( &RLON1, &RLAT1, &RLON2, &RLAT2, &RDIST, &RAZIM);

	long int N=4, IER;
	GEOGCMS ( &N, &IER );

	long IVAL = 2 , IRANGE = 0,  NRPNT = 2;
	float  ARRAY[2][2]={RLON1, RLAT1, RLON2, RLAT2},  WND[2][2];
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOGCM( &IVAL, (float *)WND, &IRANGE);

	float RIDIST[200], CROSVEK[200][2], CNDVEK[200];
	long  MAXCROS=200, CROSS, IREST;
	GEOGCC3( &RLON1, &RLAT1, &RDIST, &RAZIM, &MAXCROS, (float *)CROSVEK, RIDIST, 
                     (float *)CNDVEK, &CROSS, &IREST);
	int i;
	float PointVEK[200][2];
	PointVEK[0][0] = RLON1;
	PointVEK[0][1] = RLAT1;
	for (i=1;i<=CROSS;i++)
	{
		PointVEK[i][0] = CROSVEK[i-1][0];
		PointVEK[i][1] = CROSVEK[i-1][1];
	}
	PointVEK[i][0] = RLON2;
	PointVEK[i][1] = RLAT2;

	double latCross,lonCross, Dsea = 0, DseaWarm = 0, DseaCold = 0;
	float dst2p, latCross1,lonCross1, loni0,lati0,loni1,lati1;
	int flag1, flag2, LandSea = 1;

//		if(CNDVEK[i]==1) //"S";  //"Sea";
//		if(CNDVEK[i]==3) //"CL"; //"Coastal Land";
//		if(CNDVEK[i]==4) //"L";   //"Inland Land";

	for(i=0;i<CROSS;i++)
	{
		if(CNDVEK[i]==1)  //"Sea";
		{
			loni0 = PointVEK[i][0];			lati0 = PointVEK[i][1];
			loni1 = PointVEK[i+1][0];		lati1 = PointVEK[i+1][1];

			GEODSTR( &loni0, &lati0, &loni1, &lati1, &dst2p);
			Dsea = Dsea + dst2p;

			flag1 = WarmColdSea(loni0*180.0/pi, lati0*180.0/pi);
			flag2 = WarmColdSea(loni1*180.0/pi, lati1*180.0/pi);
			if (flag1!=flag2)
			{
				WarmColdCross(loni0*180.0/pi, lati0*180.0/pi, loni1*180.0/pi, lati1*180.0/pi,
																		&lonCross, &latCross);
				lonCross1 = lonCross*pi/180.0;
				latCross1 = latCross*pi/180.0;
				if(flag1)		GEODSTR( &loni0, &lati0, &lonCross1,&latCross1, &dst2p);
				else			GEODSTR( &loni1, &lati1, &lonCross1,&latCross1, &dst2p);
				DseaWarm = DseaWarm + dst2p;
			}
			else
			{
				if(flag1)	DseaWarm = Dsea;
				else		DseaWarm = 0.0;
			}
		}
		*D_SeaW_km = DseaWarm;
	}
	return Dsea;
}

void CSMS4DCView::OnCoordinationSt61bc2bc() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CST61_Functions ST61x;
		BOOL member = ST61x.CTRY_Check(CTYdlg.m_code);
		if(!member)
		{
			CString str;	str.Format(_Z("Country [ %s ] is not Member of ST61.") , CTYdlg.m_code);
			MessageBox(str);
//			MessageBox("Country [ "+CTYdlg.m_code+" ] is not Member of ST61.");
		}
		else
		{
			CString CDataBaseSTR;
///			CDataBaseSTR.Format("select * from GE84BC2BC where ((ctry=\'%s\') AND (fragment=\'%s\'))",CTYdlg.m_code,_T("ST61"));
//			CDataBaseSTR.Format(_T("SELECT * FROM GE84BC2BC WHERE (((ctry)=\'%s\') AND ((Fragment)='ST61') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=87.5 And (freq_assgn)<=100) Or ((freq_assgn)>=162 And (freq_assgn)<=170)));"),CTYdlg.m_code);
			CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((ctry)=\'%s\') AND ((Fragment)='ST61') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=87.5 And (freq_assgn)<=100) Or ((freq_assgn)>=162 And (freq_assgn)<=170)));"),m_qGE84BC2BC,CTYdlg.m_code);

			((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
			CDataBaseLDLG datadlg;
			datadlg.m_Heff1 = TRUE;
			if (datadlg.DoModal()==IDOK)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow==1)
				{
					CString m_Sel, BandSTR, DMstr;
					double freq_assgn, eff_hgtmax, h1, erp_dbw, Power;
					int Band = 0;

					m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
					freq_assgn = atof(GetFld(m_Sel,14));
					eff_hgtmax = atof(GetFld(m_Sel,20));
			//		h1 = eff_hgtmax;
			//		erp_dbw = atof(GetFld(m_Sel,9));
			//		Power = pow(10.0,erp_dbw/10.0);
					DMstr = _Z("Procedure given in Section 2.1 of Article  4 shall be applied");

					if     ((freq_assgn>=41.0) && (freq_assgn<=68.0))		{Band = 1;	BandSTR = "I";}
					else if((freq_assgn>=87.5) && (freq_assgn<=100.0))		{Band = 2;	BandSTR = "II";}
					else if((freq_assgn>=162.0) && (freq_assgn<=230.0))		{Band = 3;	BandSTR = "III";}
					else if((freq_assgn>=470.0) && (freq_assgn<582.0))		{Band = 4;	BandSTR = "IV";}
					else if((freq_assgn>=582.0) && (freq_assgn<=960.0))		{Band = 5;	BandSTR = "V";}

					if(Band==0)
					{
						BandSTR.Format(_Z("The Frequency [ %0.3f (MHz) ] is Out of Frequency Band in ST61"),freq_assgn);
						MessageBox(BandSTR);
					}
/*
					else if(h1>1200)
						MessageBox(DMstr);
					else if((Band==1 || Band==2 || Band==3)&&(Power>300000.))
					{
						BandSTR.Format(_Z("The ERP [ %0.3f (kW) ] is greater than 300 kW"),Power/1000.);
						MessageBox(BandSTR);
					}
					else if((Band==4 || Band==5)&&(Power>1000000.))
					{
						BandSTR.Format(_Z("The ERP [ %0.3f (kW) ] is greater than 1 000 kW"),Power/1000.);
						MessageBox(BandSTR);
					}
*/
					else
					{
						double lat0,lon0/*, pi = 4.0*atan(1.0)*/;
						long AntID , terrakey;	CString name1;

						terrakey = atol(GetFld(m_Sel,1));
						name1 = GetFld(m_Sel,4);		name1.TrimRight();
						lat0 = atof(GetFld(m_Sel,5));
						lon0  = atof(GetFld(m_Sel,6));

						double Hagl_ST,erp_h_dbw,erp_v_dbw,lat3km,lon3km,lat15km,lon15km,erpdbw;
						CString fmtv_terra_polar,ant_dir;
						double	attnH,attnV, h10[37], attH0[37], attV0[37], Hg;
						int  az0[37];

						Hagl_ST = atof(GetFld(m_Sel,7));
						fmtv_terra_polar = GetFld(m_Sel,8);	fmtv_terra_polar.TrimRight();
						erp_dbw = atof(GetFld(m_Sel,9));
						erp_h_dbw = atof(GetFld(m_Sel,10));
						erp_v_dbw = atof(GetFld(m_Sel,11));
						ant_dir = GetFld(m_Sel,12);			ant_dir.TrimRight();
						AntID = atol(GetFld(m_Sel,30));

						OnDatabaseStationsindesktop2(lat0, lon0);

						if(datadlg.m_Heff1)
							Hg = LatLon2Hg(lat0,lon0) ;
						else
						{
							Hg = atof(GetFld(m_Sel,13));
						//	GE84Heff(terrakey,eff_hgtmax,h10) ;
							GE84Heff(AntID,eff_hgtmax,h10) ;
						}
						for(int i=0;i<36;i++)
							az0[i] = 10*i;
						if(ant_dir=="D")
							GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
						else
							for(int i=0;i<36;i++)
							{
								attH0[i] = 0;		attV0[i] = 0;
							}
						az0[36] = 360;				h10[36] = h10[0];
						attH0[36] = attH0[0];		attV0[36] = attV0[0];

						float RLON = (float)(lon0*pi/180.0),
							  RLAT = (float)(lat0*pi/180.0),
							  RANGE = 1500.0,
							  RDIST,	RAZIM, 	  RLONb,	RLATb,
							  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

						long IVAL = 1, IRANGE = 1500;
						GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

						CString cty1("");
						GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

						long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
						unsigned char CTYCOD[1500];
						short KMCTY[1000];
						GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
											 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
						if(IREST==-1)
						{
							cty1 = CTYdlg.m_code;
							GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
												 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
						}
						char temp[4];

						if(NOCTY>0)
						{
							CString m_CTY, Affected, REGION, str = _T(""),	str1 = _T("");
							int k = 0, p=1;
							double DM = 0.0;
							CPoint m_Point_STcr3,m_Point_STcr15;
							double Dland ,DseaW ,DseaC, Dsea, dmax,dmaxL,per=100; 
							CString RLONbs,RLATbs;
							BOOL member2;

							for(int i=0;i<NOCTY ;i++)
							{
								temp[0]=CTYCOD[3*i];
								temp[1]=CTYCOD[3*i+1];
								temp[2]=CTYCOD[3*i+2];
								temp[3]=0;
								m_CTY = temp;
								member2 = ST61x.CTRY_Check(m_CTY);

								GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
								if((RDIST<=RANGE)&&(member2))
								{
									GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
									/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
									if(cty1!=m_CTY)
									{
								//		k++;
										if(datadlg.m_Heff1)
										{
											reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
											reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
											double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
											h1 = Hg + Hagl_ST - hv1 ;
										}
										else
											h1 = Interp2(az0,h10,RAZIM,37) ;
										
										attnH = Interp2(az0,attH0,RAZIM,37) ;
										attnV = Interp2(az0,attV0,RAZIM,37) ;
										if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
										else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
										else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));
										Power = pow(10.0,erpdbw/10.0);

										Dsea = D_Sea_kmIDWM(lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi, &DseaW);
										Dland = RDIST - Dsea;	DseaC = Dsea - DseaW;

										if ((Dland==RDIST)||(DseaC==RDIST)||(DseaW==RDIST))	//Not Mixed Path
										{
											if     (Dland==RDIST)		p = 1;
											else if(DseaC==RDIST)		p = 2;
											else if(DseaW==RDIST)		p = 3;
											dmax = ST61x.ST61(freq_assgn,Power,p,h1,100.0);
											Affected = (RDIST<dmax) ? _T("+++") : _T("---") ;
										}
										else												//Mixed Path
										{
											if(Band==1 || Band==2 || Band==3)
											{
												if((Dland+DseaC == RDIST)&&(DseaW==0))
												{
													dmaxL = ST61x.ST61(freq_assgn,Power,1,h1);
													dmax  = ST61x.ST61(freq_assgn,Power,2,h1);
													Affected = ((Dland>=dmaxL)||(RDIST>=dmax)) ? _T("---") : _T("+++") ;
												}
												else if((Dland+DseaW == RDIST)&&(DseaC==0))
												{
													dmaxL = ST61x.ST61(freq_assgn,Power,1,h1);
													dmax  = ST61x.ST61(freq_assgn,Power,3,h1);
													Affected = ((Dland>=dmaxL)||(RDIST>=dmax)) ? _T("---") : _T("+++") ;
												}
												else if((DseaC+DseaW == RDIST)&&(Dland==0))
												{
													dmax = ST61x.ST61(freq_assgn,Power,3,h1);
													Affected = (RDIST<dmax) ? "+++" : "---" ;
												}
												else
												{
													dmaxL = ST61x.ST61(freq_assgn,Power,1,h1);
													dmax  = ST61x.ST61(freq_assgn,Power,3,h1);
													Affected = ((Dland>=dmaxL)||(RDIST>=dmax)) ? _T("---") : _T("+++") ;
												}
											}
											else if(Band==4 || Band==5)
											{
												if((Dland+DseaC == RDIST)&&(DseaW==0))
												{
													per = DseaC*100.0/RDIST;	p = 2;
												}
												else if((Dland+DseaW == RDIST)&&(DseaC==0))
												{
													per = DseaW*100.0/RDIST;	p = 3;
												}
												else
												{
													per = (DseaC+DseaW)*100.0/RDIST;	p = 3;
												}
												dmax = ST61x.ST61(freq_assgn,Power,p,h1,per);
												Affected = (RDIST<dmax) ? _T("+++") : _T("---") ;
											}
										}
										DM = dmax;
										if(DM<0)
											Affected = DMstr;
						
										if(Affected != _T("---"))
										{
											k++;
											GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
											Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
											str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%s,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,DM,h1,BandSTR,REGION);
											str1=str1+","+str;
										}

									}	//end if
								}	//end if(RDIST<RANGE)
							}	//end for

							CString assignIDX = GetFld(m_Sel,2);

							str1.Delete(0);
							CGE84BC2BCDLG dlgList;
							dlgList.m_title = _Z("ST61 [BC or BT] to [BC or BT] - Coordination Distance");
							dlgList.m_nROWS = k+1+0;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
							str1=str+","+str1;
							dlgList.m_data = str1;
							dlgList.DoModal();

						}	//end if(NOCTY>0)

					}	//end if(Band==0)

				}	//end if (Nrow==1)
			}	//end datadlg

			Set_STtable_Default();

		}	//end if member
	}	//end CTYdlg	
	EndWaitCursor();
}
/*
void CSMS4DCView::OnPropagationmodelsP1546Contour() 
{
	CDataBaseLDLG datadlg;
	if (datadlg.DoModal()==IDOK)
	{
		CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		long ID1 = atol(GetFld(m_Sel,1));

		CString Namest = GetFld(m_Sel,2);
		double Latst = atof(GetFld(m_Sel,3));
		double Lonst = atof(GetFld(m_Sel,4));
		OnDatabaseStationsindesktop(ID1,Namest, Latst, Lonst);

		CP1546DLG p1546dlg;
		p1546dlg.m_CvShow = TRUE;
		if (p1546dlg.DoModal()==IDOK)
		{
			double E1 = p1546dlg.m_Cvalue;

			double t = p1546dlg.m_time;
			double Lp = p1546dlg.m_location;
			double P1546k = p1546dlg.m_k;
			double h2 = p1546dlg.m_RxH;
			int syst = p1546dlg.m_syst;
			int ENV = p1546dlg.m_env;
//			double P1546Clangle = p1546dlg.m_Clangle;
			double P1546landsea = p1546dlg.m_landsea;

			double Hagl_ST = atof(GetFld(m_Sel,5));
			double f = atof(GetFld(m_Sel,6));
			double PtGt_ST = atof(GetFld(m_Sel,7));
			double AZ0 = atof(GetFld(m_Sel,8));
			double EL0 = atof(GetFld(m_Sel,9));
			CString P1546ANT_ST = GetFld(m_Sel,14);

			int p = LandWarmColdSea(Lonst, Latst);

			double Hg = LatLon2Hg(Latst,Lonst) ;
			double pi = 4.0*atan(1.0), r = 6371.0, Ghv = 1.0 ,elevp = 0.0;
			double h1, tetamax15 = 0.0, ttca = -999.999;
			double lat3km , lon3km,lat15km ,lon15km, lat015km , lon015km;
			double tetai, mds ,ds, hi, dk, az, E, fp,tp,f1,t1;
			double dkL,dkC,dkW,Dland,DSea,DseaC,DseaW,ELand,Efs,Eb;
			double ESea, delta,E_sea_total,Emix,E_Land_total,deltaE,alpha = 0.3,beta=0.0001,XX;

			CP1546_Functions CP1546;

			CString antfile;
			antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,P1546ANT_ST);
			int f0[360];	double rH[360]  ,  rV[360];
			ReadAntennaData(antfile,f0,rH,rV) ;

			CString Fname;
			Fname.Format("%sP1546%d%d%d%d%d%d%d%d%d.txt",Namest,(int)Lonst,(int)Latst,abs(E1),(int)t,(int)Lp,(int)h2,(int)(P1546k),syst,ENV);
//			char strFilter[] = { "text Files (*.txt)|*.txt|prf Files (*.prf)|*.prf|All Files (*.*)|*.*||"};
//			CFileDialog FileDLG(FALSE, NULL, Fname, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT, strFilter);

//			char strFilter[] = { "SMS4DC Vectors (*.txt)|*.txt|Google Files (*.kml)|*.kml||"};
			CString strFilter = _Z("SMS4DC Vectors")+" (*.txt)|*.txt|"+_Z("Google Files")+" (*.kml)|*.kml||";
			CFileDLG_ChangedType FileDLG(FALSE, NULL, Fname, OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT , strFilter);
			if (((CSMS4DCApp *)AfxGetApp())->IsWin2000())	FileDLG.m_ofn.lStructSize = 88;		//76
			if (FileDLG.DoModal() == IDOK)
			{
				PeekAndPump();

				FILE *fid=fopen(FileDLG.GetPathName(),"wt");
				if(fid)
				{
					CString extFile = FileDLG.GetFileExt();		extFile.MakeUpper();
					CString nameFile = FileDLG.GetFileName();
					nameFile.Delete(nameFile.GetLength()-4,4);
					CString str1,str2,str0;
					if(extFile==_T("KML"))
					{
						CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
						str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:P1546Contour:%s</name>\n<open>1</open>"),nameFile);
						fprintf(fid,_T("%s\n"),str1);

						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),Namest,gifFile ,Lonst,Latst);
						fprintf(fid,_T("%s \n"),str2);

						str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
						fprintf(fid,_T("%s \n"),str2);
					}

					int progress_num = 0;
					CString progress_str, progress_char = "|";
					int num = 180;
					for(int i=0;i<=num;i++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(num+1),progress_char);
						progress_char = str_rep("|",(int)(progress_num*50.0/(num+1)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						az = i*360.0/num;

						fp=az*pi/180.0;		tp = (pi/2.0) - elevp;
						f1 = (180.0/pi)*atan2(sin(tp)*sin(fp-AZ0),(cos(EL0)*sin(tp)*cos(fp-AZ0)+cos(tp)*sin(EL0)));
						t1 = (180.0/pi)*acos(cos(tp)*cos(EL0)-sin(EL0)*sin(tp)*cos(fp-AZ0));
						if (f1<0.0)
							f1=f1+359.4;
						Ghv = Interp2(f0,rH,f1,360) * Interp2(f0,rV,t1,360);

						E = E1 - 10.0*log10(PtGt_ST*Ghv/1650.0);
						/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
						reckon( Latst,Lonst,  3.0 , az , &lat3km  , &lon3km) ;
						reckon( Latst,Lonst, 15.0 , az , &lat15km , &lon15km) ;
						h1 = Hg + Hagl_ST - Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km);
						///////////////////////////////// tetamax15 /////////////////////////////////////////////
						if (h1<0.0)
						{
							tetai = -pi/2.0;
							mds = 15.0;
							ds = 0.0;
							while( ds<= mds )  //ds=0->15
							{
								ds = ds + 0.1;
								reckon( Latst,Lonst, ds , az , &lat015km , &lon015km) ;
								hi = LatLon2Hg(lat015km , lon015km) ;
								tetai = max(tetai   ,(((hi-Hg-Hagl_ST)/(ds*1000.0))-(ds/(2.0*P1546k*r))));
							}
							tetamax15 = (180.0/pi)*tetai;
						}
						//////////////////////////////////////////////////////////////////////////////
						if (P1546landsea==1)
						{
							dkL = CP1546.P1546_8I(f,t,1,h1,E,h2,ENV,tetamax15,syst,Lp);
							dkC = CP1546.P1546_8I(f,t,2,h1,E,h2,ENV,tetamax15,syst,Lp);
							dkW = CP1546.P1546_8I(f,t,3,h1,E,h2,ENV,tetamax15,syst,Lp);
							dk = max(dkL,max(dkW,dkC));
							reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;
							DSea = D_Sea_kmIDWM(Latst,Lonst,  lat3km , lon3km, &DseaW);
							Dland = dk - DSea;	DseaC = DSea - DseaW;

							if(dk==Dland)			dk = dkL;
							else if(dk==DseaC)		dk = dkC;
							else if(dk==DseaW)		dk = dkW;
							else
							{
								if (Dland<1.0)
								{
									ELand = CP1546.P1546_8(f,t,1,h1,1.0,h2,ENV,tetamax15,syst,Lp,&Efs);
									ESea = CP1546.P1546_8(f,t,3,h1,1.0,h2,ENV,tetamax15,syst,Lp,&Efs);
									delta = Dland * (ELand - ESea);
								}
								else if (Dland>=1.0)
								{
									ELand = CP1546.P1546_8(f,t,1,h1,Dland,h2,ENV,tetamax15,syst,Lp,&Efs);
									ESea = CP1546.P1546_8(f,t,3,h1,Dland,h2,ENV,tetamax15,syst,Lp,&Efs);
									delta = ELand - ESea;
								}
								E_sea_total = CP1546.P1546_8(f,t,3,h1,dk,h2,ENV,tetamax15,syst,Lp,&Efs);
								Emix = E_sea_total + delta;
								E_Land_total = CP1546.P1546_8(f,t,1,h1,dk,h2,ENV,tetamax15,syst,Lp,&Efs);
								deltaE = Emix - E_Land_total;
								XX = alpha + (1.0 - alpha) * exp(-(beta * pow( Dland , (2.42-0.0003527*h1) ) ));
								Eb = E_Land_total + deltaE * XX;

								while(Eb<E)
								{
									dk = dk-0.1;
									reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;
									DSea = D_Sea_kmIDWM(Latst,Lonst,  lat3km , lon3km, &DseaW);
									Dland = dk - DSea;	DseaC = DSea - DseaW;

									if (Dland<1.0)
									{
										ELand = CP1546.P1546_8(f,t,1,h1,1.0,h2,ENV,tetamax15,syst,Lp,&Efs);
										ESea = CP1546.P1546_8(f,t,3,h1,1.0,h2,ENV,tetamax15,syst,Lp,&Efs);
										delta = Dland * (ELand - ESea);
									}
									else if (Dland>=1.0)
									{
										ELand = CP1546.P1546_8(f,t,1,h1,Dland,h2,ENV,tetamax15,syst,Lp,&Efs);
										ESea = CP1546.P1546_8(f,t,3,h1,Dland,h2,ENV,tetamax15,syst,Lp,&Efs);
										delta = ELand - ESea;
									}
									E_sea_total = CP1546.P1546_8(f,t,3,h1,dk,h2,ENV,tetamax15,syst,Lp,&Efs);
									Emix = E_sea_total + delta;
									E_Land_total = CP1546.P1546_8(f,t,1,h1,dk,h2,ENV,tetamax15,syst,Lp,&Efs);
									deltaE = Emix - E_Land_total;
									XX = alpha + (1.0 - alpha) * exp(-(beta * pow( Dland , (2.42-0.0003527*h1) ) ));
									Eb = E_Land_total + deltaE * XX;
								}
							}
						}
						else	dk = CP1546.P1546_8I(f,t,p,h1,E,h2,ENV,tetamax15,syst,Lp);
						reckon( Latst,Lonst,  dk , az , &lat3km  , &lon3km) ;
lon3km = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lon3km);
						if(extFile==_T("TXT"))	fprintf(fid," %0.14f  %0.14f\n",lon3km,lat3km);
						else if(extFile==_T("KML"))
						{
							str2.Format(_T("%lf,%lf,%lf "),lon3km,lat3km,0.0);
							fprintf(fid,_T("%s \n"),str2);
							if(i==0)	str0 = str2;
						}

					}	//end for

					if(extFile==_T("KML"))
					{
						fprintf(fid,_T("%s \n"),str0);
						str2.Format(_T("</coordinates></LineString></Placemark>"));
						fprintf(fid,_T("%s \n"),str2);
						fprintf(fid,_T("</Folder>\n</kml>"));
					}
					fclose(fid);

					if		(extFile==_T("TXT"))	OnDrawVector(FileDLG.GetPathName()) ;
					else if	((extFile==_T("KML"))&&(FileDLG.m_ShowFlag))	ShellExecute(m_hWnd, "open", FileDLG.GetPathName(), NULL, NULL, SW_SHOWNORMAL);

				}	// end if fid
			}	// end if FileDLG
			
		}	//p1546dlg
	}	//	end if datadlg
}
*/
void CSMS4DCView::OnPropagationmodelsP530Link() 
{
	int datadlg = OnDatabaseStationsindesktop1() ;
	if (datadlg==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==2)
		{
			CString name1[2],m_Sel[2];	CPoint pointst[2];	double lat1[2],lon1[2];
			for (int i=0;i<2;i++)
			{
				m_Sel[i] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				name1[i] = GetFld(m_Sel[i],2);
				lat1[i]  = atof(GetFld(m_Sel[i],3));	lon1[i]  = atof(GetFld(m_Sel[i],4));
				LatLon2Point(lat1[i],lon1[i],&pointst[i]);
			}
			double dist = Distance_km( lat1[0], lon1[0], lat1[1], lon1[1]);
			double LongM, LatM;
			PathMean(lon1[0], lat1[0], lon1[1], lat1[1], &LongM, &LatM);

			CP530DLG p530dlg;
			p530dlg.m_dist = dist;
			//P.530-15
			p530dlg.m_LatM = LatM;
			p530dlg.m_h1 = LatLon2Hg(lat1[0], lon1[0]) + atof(GetFld(m_Sel[0],5));
			p530dlg.m_h2 = LatLon2Hg(lat1[1], lon1[1]) + atof(GetFld(m_Sel[1],5));
			if (p530dlg.DoModal()==IDOK)
			{
				long x1=pointst[0].x;			long y1=1200-1-pointst[0].y;
				long x2=pointst[1].x;			long y2=1200-1-pointst[1].y;

				int xNmin = (min(x1 , x2) )-20;		int yNmin = (min(y1 , y2) )-20;
				int xNmax = (max(x1 , x2) )+20;		int yNmax = (max(y1 , y2) )+20;

				((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Link Calculation (P530)");
				CPro_P530_LinkDoc *pDocLinkP530 = (CPro_P530_LinkDoc *) DocUtil::GetLastDocument("Link Calculation (P530)");

				CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;

				x1=pointst[0].x;	y1=pointst[0].y;
				x2=pointst[1].x;	y2=pointst[1].y;
				long xmin=min(x1 , x2);		long xmax=max(x1 , x2);
				long xabs=xmax-xmin;
				long ymin=min(y1 , y2);		long ymax=max(y1 , y2);
				long yabs=ymax-ymin;

				int Np =((xabs>=yabs) ? xabs+1 : yabs+1);
				int m_scalfactor=16;
				Np = (Np-1) * m_scalfactor + 1;

				double *X;		X=new double[Np];
				double *Y;		Y=new double[Np];
				if (xabs>=yabs)
				{
					for (int i=0;i<Np;i++)
					{
						X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
						Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
					}
				}
				else
				{
					for (int i=0;i<Np;i++)
					{
						Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
						X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
					}
				}
				double *hi;			hi= new double[Np];
				double *rng;		rng=new double[Np];
				double *x_en;		x_en=new double[Np];
				double *y_en;		y_en=new double[Np];

				double xps,yps,xpm,ypm;

				pDocLinkP530->Np=Np;
				pDocLinkP530->m_di=new double[Np];
				pDocLinkP530->m_hi=new double[Np];
				pDocLinkP530->m_lati=new double[Np];
				pDocLinkP530->m_loni=new double[Np];
				double *hi1;		hi1=new double[Np];

				double Hmin=32767.0;
				for ( i=0;i<Np;i++)
				{
					xps=X[i];			yps=1200.0-1.0-(Y[i]);
					xpm = xps + 600.0*((double)(pDoc->TileX-1));
					ypm = yps + 600.0*((double)(pDoc->TileY-1));

					x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
					y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
					y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
					x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					if (pDoc->TileInfo != globeTileInfo)
					{
						CUtm m_utm;
						m_utm.y = y_en[i];
						m_utm.x = x_en[i];
						m_utm.UTM2philambda();
						y_en[i]=m_utm.phi;
						x_en[i]=m_utm.lambda;
					}
					hi1[i] = RoundBUF_Hg(xps, yps);
					rng[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
					pDocLinkP530->m_di[i]=rng[i];
					pDocLinkP530->m_lati[i]=y_en[i];
					pDocLinkP530->m_loni[i]=x_en[i];
					pDocLinkP530->m_hi[i]=hi1[i];
					Hmin=min(Hmin,hi1[i]);
				}
				pDocLinkP530->Hmin=Hmin;
				pDocLinkP530->Dmin=rng[0];
				pDocLinkP530->Dmax=rng[Np-1];
				pDocLinkP530->m_DrawFresnel = true;
				pDocLinkP530->m_Gt = atof(GetFld(m_Sel[0],10));
				pDocLinkP530->m_Gr = atof(GetFld(m_Sel[1],10));
				pDocLinkP530->LinkRxH = atof(GetFld(m_Sel[1],5));
				pDocLinkP530->LinkName_Rx = name1[1];
				pDocLinkP530->Linklat_Rx  = lat1[1];
				pDocLinkP530->Linklon_Rx  = lon1[1];
				pDocLinkP530->Linkk = atof_kfactor(p530dlg.m_k);
				pDocLinkP530->Linkatomi = p530dlg.m_atomi;
				pDocLinkP530->Linkfzn = p530dlg.m_fzn;
				pDocLinkP530->Linkanav = atof(p530dlg.m_anav);
				pDocLinkP530->LinkPol = GetFld(m_Sel[0],13);
				pDocLinkP530->LinkTxInsertionLoss = atof(GetFld(m_Sel[0],15));
				pDocLinkP530->LinkRxInsertionLoss = atof(GetFld(m_Sel[1],15));
				pDocLinkP530->LinkRxThreshold = atof(GetFld(m_Sel[1],16));
				pDocLinkP530->LinkName_ST = name1[0];
				pDocLinkP530->Linklat_ST  = lat1[0];
				pDocLinkP530->Linklon_ST  = lon1[0];
				pDocLinkP530->LinkHagl_ST = atof(GetFld(m_Sel[0],5));
				pDocLinkP530->LinkPtGt_ST  = atof(GetFld(m_Sel[0],7));
				pDocLinkP530->LinkfMHz_ST = atof(GetFld(m_Sel[0],6));
				pDocLinkP530->LinkfMHz_Rx = atof(GetFld(m_Sel[1],21));
		//		pDocLinkP530->LinkfMHz_Rx = atof(GetFld(m_Sel[1],6));
				pDocLinkP530->ID_Tx = atol(GetFld(m_Sel[0],1));
				pDocLinkP530->ID_Rx = atol(GetFld(m_Sel[1],1));

				CPoint m_Point_ST;
				LatLon2Point(atof(GetFld(m_Sel[0],3)),atof(GetFld(m_Sel[0],4)), &m_Point_ST) ;
				pDocLinkP530->LinkHasl_ST = Point2Hg(m_Point_ST);

				xpm = xNmin + 600.0*(pDoc->TileX-1);
				ypm = yNmin + 600.0*(pDoc->TileY-1);
				double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
				double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
				yUTM=yUTM-pDoc->m_Resolution_y/2.0;
				xUTM=xUTM-pDoc->m_Resolution_x/2.0;
				pDocLinkP530->Linklat0 = yUTM;
				pDocLinkP530->Linklon0 = xUTM;

				//-------------------------------------------------------------
				double LongM,LatM,LongM55R,LongM55L,LatM55U,LatM55D,dum;
				PathMean(lon1[0], lat1[0], lon1[1], lat1[0], &LongM, &LatM);

				reckon(LatM,LongM,55.0,90.0,&dum,&LongM55R);
				reckon(LatM,LongM,55.0,270.0,&dum,&LongM55L);
				reckon(LatM,LongM,55.0,0.0,&LatM55U,&dum);
				reckon(LatM,LongM,55.0,180.0,&LatM55D,&dum);
				LatLon2Point(LatM55D,LongM55L,&pointst[0]);
				LatLon2Point(LatM55U,LongM55R,&pointst[1]);

				x1 = pointst[0].x;		y1 = 1200-1-pointst[0].y;
				x2 = pointst[1].x;		y2 = 1200-1-pointst[1].y;
				int xN1    = abs(x1 - x2)  ,  yN1    = abs(y1 - y2) ;
				int xNmin1 = min(x1 , x2)  ,  yNmin1 = min(y1 , y2);
				xN1 = max(0,min(xN1,1200));	yN1 = max(0,min(yN1,1200));
				double SUMh = 0, SUMh2 = 0, hi0;

				for (int i=0;i<xN1;i++)
					for (int j=0;j<yN1;j++)
					{
						hi0 = (double)(pDoc->buf[(yNmin1+j)][(xNmin1+i)]);
						SUMh =  SUMh  + hi0;	SUMh2 = SUMh2 + hi0*hi0;
					}
				double m_h = SUMh/(xN1*yN1);  
				double Sa = sqrt((SUMh2+m_h*m_h*(xN1*yN1)-2.0*m_h*SUMh)/(xN1*yN1-1));
				pDocLinkP530->m_Sa = Sa;
				//-------------------------------------------------------------
								//P.530-15
				pDocLinkP530->m_flag_WorstMonth = p530dlg.m_flag_WorstMonth;
				pDocLinkP530->m_iClimate = p530dlg.m_iClimate;
				pDocLinkP530->m_RADIO1_rain = p530dlg.m_RADIO1_rain;
				pDocLinkP530->m_CHECK_Q = p530dlg.m_CHECK_Q;

				pDocLinkP530->m_ReadyDoc=1;
				int status = pDocLinkP530->GetData();

				if(status>0)		MessageBox(pDocLinkP530->m_tit, _Z("ERROR!!!"), MB_ICONERROR);
				
				pDocLinkP530->UpdateAllViews(NULL);
				delete [] X;	delete [] Y;	delete [] hi1;	delete [] hi;	delete [] rng; 	delete [] x_en;		delete [] y_en;
			}//p530dlg
		}
	}//datadlg			
}

void CSMS4DCView::PathMean(double LeftLong, double LeftLat, double RightLong, double RightLat, double *LongM, double *LatM)
{
//	double pi=4.0*atan(1.0);
	float	lat10 = (float)(LeftLat*pi/180.0),		lon10 = (float)(LeftLong*pi/180.0),
			lat20 = (float)(RightLat*pi/180.0),		lon20 = (float)(RightLong*pi/180.0),	RDIST, RAZIM, RLON, RLAT;
	GEOPPDA( &lon10 ,&lat10, &lon20,&lat20, &RDIST, &RAZIM);

	float rng_km1 = RDIST/2.f;
	GEOPDAP( &lon10 ,&lat10, &rng_km1, &RAZIM, &RLON, &RLAT);
	*LongM = RLON*180.0/pi;
	*LatM  = RLAT*180.0/pi;
}

///////////////////ToolBar Move Station///////////////////////////
void CSMS4DCView::OnMoveStationFlag() 
{
	if(m_bToolBarDraw == _T("movestation"))		m_bToolBarDraw = _T("");
	else										m_bToolBarDraw = _T("movestation");
}
void CSMS4DCView::OnUpdateMoveStationFlag(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_bToolBarDraw == _T("movestation"));
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable((level!=6)&&(Num_ST>0));
}

BOOL CSMS4DCView::DispStationQ(long ID, CString name1) 
{
	BOOL Q = FALSE;
	if(Num_ST>0)
	{
		for (int i=0;i<Num_ST;i++)
		{
			if((ID_ST[i] == ID) && (Name_ST[i] == name1))	Q = TRUE;
		}
	}
	return Q;
}

void CSMS4DCView::OnPrint(CDC* pDC, CPrintInfo* pInfo) 
{
	if(pInfo)
	{
		pDC->SetStretchBltMode(COLORONCOLOR);
		m_rcPrintRect=pInfo->m_rectDraw;
		int x1,y1,x2,y2;
		int margin = max(abs(m_rcPrintRect.right - m_rcPrintRect.left),
						 abs(m_rcPrintRect.top - m_rcPrintRect.bottom));
		int offset = margin/80;				//		int offset = 100;

		x1=m_rcPrintRect.left+offset;		y1=m_rcPrintRect.top+offset;
		x2=m_rcPrintRect.right-x1;			y2=m_rcPrintRect.bottom-y1;
		pDC->Rectangle(x1,y1,x2,y2);

		int offset1 = margin/10 - offset;	//		int offset1 = 700;
		int len = 80*offset/100;			//		int len = 80;
		int L1 = offset/20;					//		int L1 = 5;

		pDC->MoveTo(CPoint(x1+offset1    ,y1+offset1	   ));
		pDC->LineTo(CPoint(x1+offset1-len,y1+offset1	   ));
		pDC->MoveTo(CPoint(x1+offset1    ,y2-offset1-L1	   ));
		pDC->LineTo(CPoint(x1+offset1-len,y2-offset1-L1	   ));
		pDC->MoveTo(CPoint(x1+offset1    ,y2-offset1-L1    ));
		pDC->LineTo(CPoint(x1+offset1    ,y2-offset1-L1+len));
		pDC->MoveTo(CPoint(x2-offset1-L1 ,y2-offset1-L1    ));
		pDC->LineTo(CPoint(x2-offset1-L1 ,y2-offset1-L1+len));

		double Lat,Lon/*, pi = 4.0*atan(1.0)*/;
		float RLON,RLAT;
		CString RLONbs,RLATbs;

		Point2LatLon(CPoint(0,0),&Lat, &Lon);
		RLON = (float)(Lon*pi/180.0);
		RLAT = (float)(Lat*pi/180.0);
		Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

//		TextDraw(pDC,x1+10+300, y1+offset1+50,RLATbs,RGB(0,0,0),0,7*12);
//		TextDraw(pDC,x1+offset1, y2-offset1+100,RLONbs,RGB(0,0,0),0,7*12);
		TextDraw(pDC,x1+5*offset/2,  y1+offset1+offset/2,RLATbs,RGB(0,0,0),0,3*len/2);
		TextDraw(pDC,x1+offset1,     y2-offset1+offset,  RLONbs,RGB(0,0,0),0,3*len/2);

		Point2LatLon(CPoint(1200-1,1200-1),&Lat, &Lon);
		RLON = (float)(Lon*pi/180.0);
		RLAT = (float)(Lat*pi/180.0);
		Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

//		TextDraw(pDC,x1+10+300, y2-offset1-100,RLATbs,RGB(0,0,0),0,7*12);
//		TextDraw(pDC,x2-offset1-300, y2-offset1+100,RLONbs,RGB(0,0,0),0,7*12);
		TextDraw(pDC,x1+5*offset/2,       y2-offset1-17*offset/10,RLATbs,RGB(0,0,0),0,3*len/2);
		TextDraw(pDC,x2-offset1-5*offset, y2-offset1+offset,      RLONbs,RGB(0,0,0),0,3*len/2);

		if(m_LegendFlag)	LegendLOC(pDC);
	}
	CScrollView::OnPrint(pDC, pInfo);
}

extern "C" int WINAPI FPLAN(HWND hWndParent,CString DBSTR,CString AppPath,CString mLang);	//FplanDLL.lib
void CSMS4DCView::OnFrequencyallocationsFrequencyplan() 
{
	FPLAN(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_AppPath,((CSMS4DCApp *)AfxGetApp())->m_Lang);
}

//extern "C" int WINAPI IFICImport(HWND hWndParent,CString DBSTR);	//IFIC.lib
extern "C" int WINAPI IFICImport(HWND hWndParent,CString DBSTR, CString Lang);
void CSMS4DCView::OnCalculationUndertestIfic() 
{
//	IFICImport(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR);
	IFICImport(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_Lang);
}

void CSMS4DCView::OnDatabaseLicensing() 
{
	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Administrative data");	
}

//extern "C" int WINAPI Audit(HWND hWndParent,CString DBSTR);	//Lic.lib
extern "C" int WINAPI Audit(HWND hWndParent,CString DBSTR, CString mLang);
void CSMS4DCView::OnDatabaseAudittrail() 
{
//	Audit(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR);
	Audit(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR, ((CSMS4DCApp *)AfxGetApp())->m_Lang);
}

/*
void CSMS4DCView::OnDcw() 
{
	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Main Map");
}
*/

void CSMS4DCView::OnFrequencyallocationsFplan() 
{
	//Query FrequencyPlan
//	CString str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.Type, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	CString str1, mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	if     (mLang==_T("En"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeEn, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	else if(mLang==_T("Fr"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeFr, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	else if(mLang==_T("Es"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeEs, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	else if(mLang==_T("Ch"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeCh, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	else if(mLang==_T("Ar"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeAr, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	else if(mLang==_T("Ru"))	str1 = _T(" [ SELECT DISTINCT Fplan_IRegular.ID, Fplan_Reqular.ChannelNum AS Channels, Fplan_IRegular.ChannelNo AS No, Fplan_Reqular.PlanID, Fplan_Reqular.Region, Fplan_Reqular.Srv, IIf(Priority=1,\'Primary\',\'Secondary\') AS SrvPriority, Fplan_Type.TypeRu, Fplan_IRegular.Fn, Fplan_IRegular.FnP, Fplan_IRegular.BandWidth, Fplan_Reqular.Comment ");
	
	CString str2 = _T(" FROM (Fplan_Type INNER JOIN Fplan_Reqular ON Fplan_Type.ID = Fplan_Reqular.PlanType) INNER JOIN Fplan_IRegular ON Fplan_Reqular.ID = Fplan_IRegular.AssignmentID ]. as FrequencyPlan ");
	CString qFrequencyPlan = str1+str2;
	CString str;
	str.Format( _T("select * from %s ;") ,  qFrequencyPlan);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = str;
//	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from FrequencyPlan");

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _T("Frequency Table Selection");
	datadlg.DoModal();
	Set_STtable_Default();
}

void CSMS4DCView::OnDatabaseBackup() 
{
	int start , stop;
	CString DBpath1 , DBpath2;
	CDatabase DB;
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB.Open(_T(m_DB),false,false,_T("ODBC;"),false);

	CString STRc = DB.GetConnect();
	DB.Close();
	start = STRc.Find("DBQ",0);
	stop = STRc.Find(";DriverId=",0);
	DBpath1 = STRc.Mid(start+4,stop-start-4);

	CFolderDLG oFolderDlg;
	if(oFolderDlg.DoModal()==IDOK)
	{
		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_WAIT));

		CTime tt = CTime::GetCurrentTime();
		CString DBpathDes;

		DBpathDes.Format("%sSMS_NEW%02d%02d%02d%02d%02d%02d.mdb", oFolderDlg.m_Path,tt.GetYear(),tt.GetMonth(),tt.GetDay(),tt.GetHour(),tt.GetMinute(),tt.GetSecond());
		BOOL s = CopyFile(DBpath1,DBpathDes,true);
		if(s==0)
			MessageBox(_Z("The DataBase [SMS_NEW.mdb] can not be copied!!!"),_Z("Error!!!"),MB_ICONERROR | MB_OK);

		SetCursor(AfxGetApp()->LoadStandardCursor(IDC_ARROW));
	}
	//GetLastError()
}

void CSMS4DCView::OnDatabaseSearchfrequency() 
{
	CAddFreqDLG frqDLG;
	frqDLG.m_Flag = TRUE;
	frqDLG.m_Flo   = _Z("Lower Frequency(MHz)");
	frqDLG.m_Fhi   = _Z("Upper Frequency(MHz)");
	frqDLG.m_title = _Z("Frequency Range");
	if(frqDLG.DoModal()==IDOK)
	{
		double Flo = frqDLG.m_Freq,		Fhi = frqDLG.m_BW;
		OnDatabaseRemovestationsfromdisplay();

		double Lon01,Lat01,Lon02,Lat02;
		Point2LatLon(m_stBoxPoint,&Lat01,&Lon01);		Point2LatLon(m_enBoxPoint,&Lat02,&Lon02);
//		double Lat1=min(Lat01,Lat02),		Lat2=max(Lat01,Lat02),		Lon1=min(Lon01,Lon02),		Lon2=max(Lon01,Lon02);

		CDBVariant Fld;		CDatabase m_mydb;		CRecordset m_rs;
		CString  Filter , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
		CString	m_Tbl;	m_Tbl.Format(  _T("select * from %s ") , m_qSTtable );
		if (m_mydb.Open(_T(m_DB),FALSE,TRUE, "ODBC;", FALSE))
		{
			m_rs.m_pDatabase=&m_mydb;
//			Filter.Format("(stlat_deg>%lf and stlat_deg<%lf and stlon_deg>%lf and stlon_deg<%lf and TXfreq>=%lf and TXfreq<=%lf)",Lat1,Lat2,Lon1,Lon2,Flo,Fhi);
if(Lon01<=Lon02)	Filter.Format("( (TXfreq>=%lf and TXfreq<=%lf and stlat_deg>%lf and stlat_deg<%lf) and (stlon_deg>%lf and stlon_deg<%lf) )",Flo,Fhi,Lat01,Lat02,Lon01,Lon02);
else				Filter.Format("( (TXfreq>=%lf and TXfreq<=%lf and stlat_deg>%lf and stlat_deg<%lf) and ((stlon_deg>%lf and stlon_deg<180) or (stlon_deg>-180 and stlon_deg<%lf)) )",Flo,Fhi,Lat01,Lat02,Lon01,Lon02);

			if(m_Tbl.Find(" where ")==-1)	Filter = m_Tbl+" where "+Filter;
			else							Filter = m_Tbl+" and "+Filter;
			m_rs.Open( CRecordset::snapshot, Filter);
			int k = 0;
			while(!m_rs.IsEOF())	{	m_rs.MoveNext();	k = k+1;	}
			if (k>0)
			{
				m_rs.MoveFirst();
				double lat1,lon1;		CString name1;	long ID1;
				for (int j=0;j<k;j++)
				{
					m_rs.GetFieldValue((short)0, Fld);		ID1  = Fld.m_lVal;
					m_rs.GetFieldValue((short)1, Fld);		name1 = *Fld.m_pstring;
					m_rs.GetFieldValue((short)2, Fld);		lat1  = Fld.m_dblVal;
					m_rs.GetFieldValue((short)3, Fld);		lon1  = Fld.m_dblVal;
					AddStation_disp(ID1,lat1,lon1,name1) ;
					m_rs.MoveNext();
				}
			}
			m_rs.Close();	m_mydb.Close();
			InvalidateRect(NULL,false);
		}
	}
}
void CSMS4DCView::OnUpdateDatabaseSearchfrequency(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnDatabaseList() 
{
	BeginWaitCursor();

	CString CDataBaseSTR , str1 , str2;
	str1.Format("(((STtable.IDst)=%ld))",ID_ST[0]);
	for (int i=1;i<Num_ST;i++)
	{
		str2.Format(" OR (((STtable.IDst)=%ld))",ID_ST[i]);
		str1 = str1 + str2;
	}
//	CDataBaseSTR = _T("SELECT * FROM STtable WHERE ") + str1 + ";";
	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE %s;") , m_qSTtable, str1);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("List of Queried Station(s)");
	datadlg.m_ReportFlag = TRUE;
	datadlg.DoModal();

	Set_STtable_Default();
	EndWaitCursor();
}
void CSMS4DCView::OnUpdateDatabaseList(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable((Num_ST>0) ? 1 : 0 );	
}

void CSMS4DCView::LegendLOC(CDC* pDC) 
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
	int x1,y1,x2,y2,w=10,h=1,pscale=12;

	if (pDC->IsPrinting())
	{
		int offset1 = 100;
		pscale=8;
		x1=0+offset1;
		int offset = 1300;
		y1=m_rcPrintRect.top+offset;
	}
	else
	{
		pscale=1;
		x1=m_x1;y1=m_y1;
	}

	x2=x1+85*pscale;
	y2=y1+293*pscale;
	w=10*pscale;
	h=1*pscale;
	CSize sz(w, h);

//	CBrush brush01(RGB(212,208,200));
//	pDC->SelectObject(&brush01);
	pDC->Rectangle(x1,y1,x2,y2);
	pDC->MoveTo(x1,y1+17*pscale);	pDC->LineTo(x2,y1+17*pscale);

	COLORREF RGBt[256];
	CTile m_tile;
	CString label;
	double y;

//	pDoc->m_level = min(255,pDoc->m_level);
	int m_level = 255;
	int tt=int(255.0/m_level);

	m_tile.ColorMap(pDoc->colormaptype);
	long R,G,B;

	for (int i=0;i<256;i++)
	{
		RGBt[i]=m_tile.RGBt[ tt*(i/tt) ];

		B =   max(0,min(255,m_colorRate + GetBValue(RGBt[i]) ));
		G =   max(0,min(255,m_colorRate + GetGValue(RGBt[i]) ));
		R =   max(0,min(255,m_colorRate + GetRValue(RGBt[i]) ));
		RGBt[i] = RGB(R,G,B);

		CPoint pt(x1+5*pscale, y1+(30+255-i)*pscale);
		CRect rect3(pt, sz);
		CBrush brush3(RGBt[i]);
		pDC->SelectObject(&brush3);
		pDC->FillRect(&rect3,&brush3);
	}

	pDC->SetBkMode(TRANSPARENT);
	CFont font;
	LOGFONT lf;
	memset(&lf, 0, sizeof(LOGFONT));      
	lf.lfHeight = 12*pscale;               
	lf.lfWidth =0;
	lf.lfWeight = FW_BOLD;
	strcpy(lf.lfFaceName, "Arial");       
	lf.lfEscapement=0;
	VERIFY(font.CreateFontIndirect(&lf));  
	CFont* def_font = pDC->SelectObject(&font);
	pDC->SetTextColor(RGB(0,0,0));

	pDC->TextOut(x1+5*pscale,y1+5*pscale,"Altitude (m)");
	pDC->SetTextAlign(TA_RIGHT);

	for ( i=0;i<256;i=i+17)
	{
		y=m_MinValue + ((double)i)*(m_MaxValue - m_MinValue)/255.0;
		label.Format("%0.2f",y);
		pDC->TextOut(x1+w+(5+55)*pscale,y1+(22+(255-i))*pscale,label);
		CPen pen;
		pen.CreatePen(PS_SOLID ,1,RGBt[i]);
		pDC->SelectObject(&pen);
		pDC->MoveTo(x1+5*pscale+w,y1+(30+(255-i))*pscale);
		pDC->LineTo(x1+w+(5+10)*pscale,y1+(30+(255-i))*pscale);
	}

	pDC->SelectObject(def_font);
	font.DeleteObject(); 
}

extern "C" int WINAPI P618(HWND hWndParent,CString DBSTR,CString PathFile0,CString mLang);	//P618DLL.lib
void CSMS4DCView::OnPropagationmodelsP618() 
{
	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	P618(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_AppPath, mLang);
}
/*
CString CSMS4DCView::VectorCountry(CString cty) 
{
	unsigned char CTYVEK[4]={""}, BCILR;
	strcpy((char *)CTYVEK,cty);

	float CRDARR[2*15000], DENS=0;
	long LINE, NRCRD, NOMORE=0, NRCTY=1, ITYPE=2, MAXCRD=30000;

	float RLONLL, RLATLL, RLONUR, RLATUR;
	GEOCWI(&NRCTY, (unsigned char *)CTYVEK, &RLONLL, &RLATLL, &RLONUR, &RLATUR);
	GEODWD( &RLONLL, &RLATLL, &RLONUR, &RLATUR, &DENS, &NRCTY, (unsigned char *)CTYVEK);	

	CString FileName =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Texts\\") + cty + _T(".txt");
	FILE *fp=fopen(FileName,"wt");
	int j=0;

	while(!NOMORE)
	{
		GEOLIW( &ITYPE, (float *)CRDARR, &MAXCRD, &LINE, &NRCRD, &BCILR, &NOMORE);
		if(NOMORE)	break;

		if(j>0)
		fprintf(fp,"%s\n","NaN  NaN");
		for(long p=0;p<NRCRD;p++)
		{
			fprintf(fp," %0.10f  %0.10f\n",CRDARR[2*p],CRDARR[2*p+1]);
		}//end for
		j++;
	}//end while
	fclose(fp);
	return FileName;
}
*/

CString CSMS4DCView::VectorCountry(CString cty) 
{
	CString FileName =  ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Texts\\") + cty + _T(".txt");
	unsigned char CTYVEK[4]={""}, BCILR;
	strcpy((char *)CTYVEK,cty);

	long NRCRD, NOMORE=0, NRCTY=1, ITYPE=2, MAXCRD=15000;
	float *CRDARR;	CRDARR = new float[2*MAXCRD];
	float RLONLL, RLATLL, RLONUR, RLATUR, DENS=0;
	GEOCWI(&NRCTY, CTYVEK, &RLONLL, &RLATLL, &RLONUR, &RLATUR);
	GEODCW(&RLONLL, &RLATLL, &RLONUR, &RLATUR, &DENS, CTYVEK);
		
	FILE *fp=fopen(FileName,_T("wt"));
	if(cty!=_T("RUS"))
	{
		int j = 0;
		while(!NOMORE)
		{
			GEOCIW(&ITYPE, CRDARR, &MAXCRD, &NRCRD, &BCILR, &NOMORE);
			if(NOMORE)	break;

			if(j>0)	fprintf(fp,"%s\n","NaN  NaN");
			for(long p=0;p<NRCRD;p++)
				fprintf(fp," %0.10f  %0.10f\n",CRDARR[2*p],CRDARR[2*p+1]);
			j++;
		}//end while
	}
	else
	{
		int i = 0,		i1 = 0;
		float *lat;		lat		= new float[MAXCRD];
		float *lon;		lon		= new float[MAXCRD];
		float *lat1;	lat1	= new float[MAXCRD];
		float *lon1;	lon1	= new float[MAXCRD];
		while(!NOMORE)
		{
			GEOCIW(&ITYPE, (float *)CRDARR, &MAXCRD, &NRCRD, &BCILR, &NOMORE);
			if(NOMORE)	break;
			for(long p=0;p<NRCRD;p++)
			{
				if(CRDARR[2*p]<19)
				{
					lat1[i1] = CRDARR[2*p+1];	lon1[i1] = CRDARR[2*p];		i1++;
				}
				else
				{
					lat[i]  = CRDARR[2*p+1];	lon[i]  = CRDARR[2*p];		i++;
				}
			}//end for
			if(i1>0)
			{
				for( p=0;p<i1;p++)		fprintf(fp," %0.10f  %0.10f\n",lon1[p],lat1[p]);
				fprintf(fp,"%s\n","NaN  NaN");
			}
			if(i>0)
			{
				for( p=0;p<i;p++)		fprintf(fp," %0.10f  %0.10f\n",lon[p],lat[p]);
				fprintf(fp,"%s\n","NaN  NaN");
			}
			i = 0;		i1 = 0;
		}//end while
		fseek(fp,-10L,SEEK_END);
		fprintf(fp,"        ");
		delete [] lat;		delete [] lon;
		delete [] lat1;		delete [] lon1;
	}	
	fclose(fp);
	delete [] CRDARR;
	return FileName;
}

void CSMS4DCView::OnVectorsCountryborder() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		CString pathfile = VectorCountry(CTYdlg.m_code);
		if(!strCompare(pathfile))
		{
			OnDrawVector(pathfile);
			InvalidateVectorHandling(); 
		}
		VectorDesktop(pathfile);
	}
}

void CSMS4DCView::OnFrequencyallocationsFrequencyassignment() 
{
	CAddFreqDLG frqDLG;
	frqDLG.m_Flag = TRUE;
	frqDLG.m_Flo   = _Z("Lower Frequency(MHz)");
	frqDLG.m_Fhi   = _Z("Upper Frequency(MHz)");
	frqDLG.m_title = _Z("Frequency Condition");
	frqDLG.m_Freq = 100;
	frqDLG.m_BW = 200;
	if(frqDLG.DoModal()==IDOK)
	{
		double Flo = frqDLG.m_Freq;
		double Fhi = frqDLG.m_BW;
		CString ctryLocal = ((CSMS4DCApp *)AfxGetApp())->m_ctryLocal;

		CString SQL0;
//		SQL0.Format(_T("SELECT * FROM STtable WHERE (((ctry)=\'%s\') AND ((TXfreq)>=%f And (TXfreq)<=%f));"),ctryLocal,Flo,Fhi);
		SQL0.Format(_T("SELECT * FROM %s WHERE (((ctry)=\'%s\') AND ((TXfreq)>=%f And (TXfreq)<=%f));"),m_qSTtable,ctryLocal,Flo,Fhi);
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = SQL0;

		((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
		CDataBaseLDLG datadlg;
		if (datadlg.DoModal()==IDOK)
		{
			int Nrow	=	((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==0)
			{
				Set_STtable_Default();
				return;
			}

			CString m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			CFassign1DLG xx;
			if(xx.DoModal()==IDOK)
			{
				CFassign2DLG yy;
				long IDst = atol(GetFld(m_Sel,1));
				CString name = GetFld(m_Sel,2);
				double lat = atof(GetFld(m_Sel,3));
				double lon = atof(GetFld(m_Sel,4));

				yy.m_STID = IDst;	yy.m_STname = name;
				yy.m_STLat = lat;	yy.m_STLon = lon;
				yy.m_STfrq = atof(GetFld(m_Sel,6));
				yy.m_STptgt = atof(GetFld(m_Sel,7));
				yy.m_STh_agl = atof(GetFld(m_Sel,5));
				yy.m_STh_asl = atof(GetFld(m_Sel,24));
				yy.m_STaz0 = atof(GetFld(m_Sel,8));
				yy.m_STel0 = atof(GetFld(m_Sel,9));
				yy.m_STant = GetFld(m_Sel,14);
				yy.m_SRV0 = atol(GetFld(m_Sel,17));
				yy.m_STemission = GetFld(m_Sel,19);
		
				yy.m_Fmin = xx.m_Fmin;	yy.m_Fmax = xx.m_Fmax;
				yy.m_Df = xx.m_CSR;		yy.m_Imax = xx.m_Imax;
				yy.m_Rkm = xx.m_Rkm;

				if(yy.DoModal()==IDOK)
				{
					CString newFRQ = yy.m_SChannel;
					CString newFRQR = yy.m_SChannelR;
					if(!(newFRQ.IsEmpty()))
					{
						CString SQL;
						CDatabase DB;
						CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
						DB.Open(_T(m_DB),false,false,_T("ODBC;"),false);
				//		SQL.Format(_T("Update frequency set frequency=%lf where freqid=%ld"), atof(newFRQ)*1000000.,IDst);
						SQL.Format(_T("Update frequency set frequency=%lf , RespFreq=%lf where freqid=%ld"), atof(newFRQ)*1000000., atof(newFRQR)*1000000.,IDst);
						DB.ExecuteSQL(SQL);
						DB.Close();
						AddStation_disp(IDst,lat,lon,name) ;
					}	// if newFRQ
				}	// if yy IDOK

				yy.Del();
			}	// if xx IDOK
		}	// if DataBase IDOK
		Set_STtable_Default();
	}
}

void CSMS4DCView::OnHelpManual() 
{
	((CSMS4DCApp *)AfxGetApp())->FindHelpFile();
}

CString CSMS4DCView::OnInterferenceQx(CString stn_cls) 
{
	CString CDataBaseSTR , SelX = _T(" ");

///	CDataBaseSTR.Format("select * from XBCBTIRN where ((stn_cls=\'%s\'))",stn_cls);
//	CDataBaseSTR.Format(_T("SELECT * FROM XBCBTIRN WHERE ((((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)='') AND ((stn_cls)=\'%s\'));"),stn_cls);
	
	CString str1 = _T(" [SELECT AntCat.AntCatID AS terrakey, BCstation.StID AS Assgn_ID, BCstation.Country AS ctry, BCstation.SiteName AS site_name, BCstation.GeoLat AS lat_dec, BCstation.GeoLon AS long_dec, Antenna.AntHeightAGL AS hgt_agl, AntCat.Pol AS polar, EqCat.ERP_dbw, EqCat.ERP_h_dbw, EqCat.ERP_v_dbw, AntCat.AntDir AS ant_dir, BCstation.HeightASL AS site_alt, Frequency/1000000 AS freq_assgn, Frequency.EmissionCl AS emi_cls, IIf(stn_cls=\'BC\',TranSys,TVsys) AS tran_sys, BCstation.ClassStation AS stn_cls, IIf(classstation=\'BC\',frequency/1000000,freqvcarr) AS freq_y, EqCat.EU_Ref, AntCat.MaxEffHght AS eff_hgtmax, Provisions.Fragment, EqCat.FreqStabl AS freq_stabl, EqCat.OsetV12 AS oset_v_12, EqCat.OsetV AS oset_v_khz, Frequency.FreqSCarr AS freq_scarr, EqCat.OsetS12 AS oset_s_12, EqCat.PwrRatio AS pwr_ratio, Frequency.TVChan AS tv_chan, EqCat.ColorSys AS color, Antenna.AntID, Frequency.FreqID, BCstation.NoticeType ");
	CString str2 = _T(" FROM BCstation, AntCat, Antenna, Equipment, EqCat, Frequency, Provisions ");
	CString str3 = _T(" WHERE (((BCstation.StID)=equipment.bcid) AND ((Equipment.EqCatID)=eqcat.eqcatid) AND ((Equipment.EqID)=frequency.eqid And (Equipment.EqID)=antenna.eqid) AND ((Antenna.AntCatID)=antcat.antcatid) AND ((BCstation.Provision)=provisions.provision)) ");
	CString str4 = _T(" ]. as XBCBTIRN  ");
	CString tbl = str1+str2+str3+str4;
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE ((((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)='') AND ((stn_cls)=\'%s\'));"),tbl,stn_cls);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("Wanted Station");

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)	SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

BOOL CSMS4DCView::OnInterferenceQy(long assignIDX,double latX, double lonX, double frqX, double Drange, double Frange,CString stn_cls, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);

	LatLon2Point(latmin, lonmin,&m_stBoxPoint);	LatLon2Point(latmax, lonmax,&m_enBoxPoint);

//	OnDatabaseStationsindesktop2(latmin, lonmin);
	OnDatabaseStationsindesktop2(latX, lonX);

	double fmin = frqX - Frange/1000.0,		 fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
///	if	   (stn_cls==_T("BC"))	CDataBaseSTR.Format("select * from XBCBTIRN where (((assgn_id)<>%ld) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_Y)>=%f And (freq_Y)<=%f And (stn_cls=\'%s\') ))",assignIDX,latmin,latmax,lonmin,lonmax,fmin,fmax,stn_cls);
///	else if(stn_cls==_T("BT"))	CDataBaseSTR.Format("select * from XBCBTIRN where (((assgn_id)<>%ld) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_Y)=%f Or (freq_Y)=%f Or (freq_Y)=%f) AND ((stn_cls)=\'%s\'));",assignIDX,latmin,latmax,lonmin,lonmax,frqX,fmin,fmax,stn_cls);

//	if	   (stn_cls==_T("BC"))	CDataBaseSTR.Format(_T("SELECT * FROM XBCBTIRN WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((freq_y)>=%lf And (freq_y)<=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"),assignIDX,latmin,latmax,lonmin,lonmax,fmin,fmax,stn_cls);
//	else if(stn_cls==_T("BT"))	CDataBaseSTR.Format(_T("SELECT * FROM XBCBTIRN WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((freq_y)=%lf Or (freq_y)=%lf Or (freq_y)=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"),assignIDX,latmin,latmax,lonmin,lonmax,frqX,fmin,fmax,stn_cls);

	CString str1 = _T(" [SELECT AntCat.AntCatID AS terrakey, BCstation.StID AS Assgn_ID, BCstation.Country AS ctry, BCstation.SiteName AS site_name, BCstation.GeoLat AS lat_dec, BCstation.GeoLon AS long_dec, Antenna.AntHeightAGL AS hgt_agl, AntCat.Pol AS polar, EqCat.ERP_dbw, EqCat.ERP_h_dbw, EqCat.ERP_v_dbw, AntCat.AntDir AS ant_dir, BCstation.HeightASL AS site_alt, Frequency/1000000 AS freq_assgn, Frequency.EmissionCl AS emi_cls, IIf(stn_cls=\'BC\',TranSys,TVsys) AS tran_sys, BCstation.ClassStation AS stn_cls, IIf(classstation=\'BC\',frequency/1000000,freqvcarr) AS freq_y, EqCat.EU_Ref, AntCat.MaxEffHght AS eff_hgtmax, Provisions.Fragment, EqCat.FreqStabl AS freq_stabl, EqCat.OsetV12 AS oset_v_12, EqCat.OsetV AS oset_v_khz, Frequency.FreqSCarr AS freq_scarr, EqCat.OsetS12 AS oset_s_12, EqCat.PwrRatio AS pwr_ratio, Frequency.TVChan AS tv_chan, EqCat.ColorSys AS color, Antenna.AntID, Frequency.FreqID, BCstation.NoticeType ");
	CString str2 = _T(" FROM BCstation, AntCat, Antenna, Equipment, EqCat, Frequency, Provisions ");
	CString str3 = _T(" WHERE (((BCstation.StID)=equipment.bcid) AND ((Equipment.EqCatID)=eqcat.eqcatid) AND ((Equipment.EqID)=frequency.eqid And (Equipment.EqID)=antenna.eqid) AND ((Antenna.AntCatID)=antcat.antcatid) AND ((BCstation.Provision)=provisions.provision)) ");
	CString str4 = _T(" ]. as XBCBTIRN  ");
	CString tbl = str1+str2+str3+str4;
if(lonmin<=lonmax)
{
	if	   (stn_cls==_T("BC"))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((freq_y)>=%lf And (freq_y)<=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"), tbl, assignIDX,latmin,latmax,lonmin,lonmax,fmin,fmax,stn_cls);
	else if(stn_cls==_T("BT"))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((freq_y)=%lf Or (freq_y)=%lf Or (freq_y)=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"), tbl, assignIDX,latmin,latmax,lonmin,lonmax,frqX,fmin,fmax,stn_cls);
}
else
{
	if	   (stn_cls==_T("BC"))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ( (long_dec>=%lf And long_dec<=180) or (long_dec>=-180 And long_dec<=%lf) ) AND ((freq_y)>=%lf And (freq_y)<=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"), tbl, assignIDX,latmin,latmax,lonmin,lonmax,fmin,fmax,stn_cls);
	else if(stn_cls==_T("BT"))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ( (long_dec>=%lf And long_dec<=180) or (long_dec>=-180 And long_dec<=%lf) ) AND ((freq_y)=%lf Or (freq_y)=%lf Or (freq_y)=%lf) AND ((stn_cls)=\'%s\') AND (((NoticeType)<>'T1' And (NoticeType)<>'T2' And (NoticeType)<>'T0' And (NoticeType)<>'DT1' And (NoticeType)<>'GT1' And (NoticeType)<>'DT2' And (NoticeType)<>'GT2' And (NoticeType)<>'DS1' And (NoticeType)<>'DS2' And (NoticeType)<>'GS1' And (NoticeType)<>'GS2') Or (NoticeType) Is Null Or (NoticeType)=''));"), tbl, assignIDX,latmin,latmax,lonmin,lonmax,frqX,fmin,fmax,stn_cls);
}
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _Z("Interferer Stations");
	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnInterferenceBc2bc() 
{
	BeginWaitCursor();
	OnDatabaseRemovestationsfromdisplay();
	CString m_SelX = OnInterferenceQx(_T("BC"));
	if(m_SelX!=" ")
	{
	//	CString assignIDX = GetFld(m_SelX,2);
		long assignIDX = atol(GetFld(m_SelX,2));
		CString nameX = GetFld(m_SelX,4);	nameX.TrimRight();

		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		double freq_assgnX = atof(GetFld(m_SelX,18));
				
	//	AddStation_disp(atol(assignIDX),latX, lonX,nameX);
		long IDstX = atol(GetFld(m_SelX,31));
		AddStation_disp(IDstX,latX, lonX,nameX);

		CInt_ParametersDLG Int_ParametersDLG;
		Int_ParametersDLG.m_EDIT_PolDisc = 12;
		Int_ParametersDLG.m_F = 400;

//97/12/21						
CSMS4DCDoc* pDoc = GetDocument();
double mD = 150.0;
if	(pDoc->m_Resolution_x < 0.008333)	mD = 150.0*(pDoc->m_Resolution_x)/0.0083333333334;
CString msD;		msD.Format("%0.3f" , mD);
Int_ParametersDLG.m_D = atof(msD);

		if(Int_ParametersDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = Int_ParametersDLG.m_Emin,  tp = Int_ParametersDLG.m_T;
			double Frange = Int_ParametersDLG.m_F,   Drange = Int_ParametersDLG.m_D;
			BOOL hef_flag;
			BOOL YOK = OnInterferenceQy(assignIDX,latX,lonX,freq_assgnX,Drange,Frange,_T("BC"),&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
	//				CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString name1;
					long terrakey;
					double lat0,lon0;
					CString *m_Sel; m_Sel = new CString[Nrow];

					long IDstY;
					for(int Yi = 0;Yi<Nrow;Yi++)
					{
						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
						terrakey = atol(GetFld(m_Sel[Yi],1));
						name1 = GetFld(m_Sel[Yi],4);
						name1.TrimRight();
						lat0 = atof(GetFld(m_Sel[Yi],5));
						lon0  = atof(GetFld(m_Sel[Yi],6));

					//	AddStation_disp(terrakey,lat0, lon0,name1);
						IDstY = atol(GetFld(m_Sel[Yi],31));
						AddStation_disp(IDstY,lat0, lon0,name1);
					}
//	97/12/21
double Lat1, Lon1,Lat2, Lon2;
Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);

			//		CLoSDLG freedlg;
			//		freedlg.m_title = "Free Space Model Parameters";
			//		if (freedlg.DoModal()==IDOK)
					{
						int yst=1200-1-m_stBoxPoint.y;
						int yen=1200-1-m_enBoxPoint.y;
						int xst=m_stBoxPoint.x;
						int xen=m_enBoxPoint.x;

						int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
						int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
						xN=4*(xN/4);//		xNmin=4*(xNmin/4);

						xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

						((CSMS4DCApp *)AfxGetApp())->xN = xN;
						((CSMS4DCApp *)AfxGetApp())->yN = yN;

						((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("InterferenceBC2BC (Free Space)");
						CInt_BC2BC_FreeDoc *pDocFree=(CInt_BC2BC_FreeDoc *) DocUtil::GetLastDocument("InterferenceBC2BC (Free Space)");	

				//		pDocFree->Freek=freedlg.m_kfactor;
				//		pDocFree->FreeRxH=freedlg.m_RxH;

						pDocFree->bufAreaW = xN;	pDocFree->bufAreaH = yN;
						pDocFree->bufAreaFree = new _int16[xN*yN];

				//		CSMS4DCDoc* pDoc = GetDocument();		//9712/21
						for (int i=0;i<xN;i++)
							for (int j=0;j<yN;j++)
								pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];

						pDocFree->m_SelX = m_SelX;
						pDocFree->m_Fmin = Emin;
						pDocFree->Freelat_ST = latX;
						pDocFree->Freelon_ST = lonX;
						pDocFree->FreeName_ST = nameX;
						pDocFree->P_Location = Int_ParametersDLG.m_L;
						pDocFree->methodSUM = Int_ParametersDLG.m_method;
						pDocFree->m_AntDisc = Int_ParametersDLG.m_AntDisc;
						pDocFree->m_PolDisc = Int_ParametersDLG.m_PolDisc;
						pDocFree->m_EDIT_PolDisc = Int_ParametersDLG.m_EDIT_PolDisc;
/*	//97/12/21
						double xpm = xNmin + 600.0*(pDoc->TileX-1);
						double ypm = yNmin + 600.0*(pDoc->TileY-1);
						double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
						double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
						yUTM=yUTM-pDoc->m_Resolution_y/2.0;
						xUTM=xUTM-pDoc->m_Resolution_x/2.0;
						pDocFree->Freelat0 = yUTM;
						pDocFree->Freelon0 = xUTM;
*/
pDocFree->Freelat0   = min(Lat1, Lat2);	pDocFree->Freelon0   = min(Lon1, Lon2);
pDocFree->Freelatmax = max(Lat1, Lat2);	pDocFree->Freelonmax = max(Lon1, Lon2);

						pDocFree->TileInfo=pDoc->TileInfo;
						pDocFree->m_Resolution_x = pDoc->m_Resolution_x;
						pDocFree->m_ReadyDoc=1;
						pDocFree->GetData();
						pDocFree->UpdateAllViews(NULL);
					}
					delete [] m_Sel;
				}
			}
		}
	}
	EndWaitCursor();
}

void CSMS4DCView::OnInterferenceBt2bt() 
{
	BeginWaitCursor();
	OnDatabaseRemovestationsfromdisplay();
	CString m_SelX = OnInterferenceQx(_T("BT"));
	if(m_SelX!=" ")
	{
	//	CString assignIDX = GetFld(m_SelX,2);
		long assignIDX = atol(GetFld(m_SelX,2));
		CString nameX = GetFld(m_SelX,4);	nameX.TrimRight();

		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
//		double freq_assgnX = atof(GetFld(m_SelX,14));
		double freq_assgnX = atof(GetFld(m_SelX,18));
				
	//	AddStation_disp(atol(assignIDX),latX, lonX,nameX);
		long IDstX = atol(GetFld(m_SelX,31));
		AddStation_disp(IDstX,latX, lonX,nameX);

		CInt_ParametersDLG Int_ParametersDLG;
		Int_ParametersDLG.m_EDIT_PolDisc = 16;
		Int_ParametersDLG.m_F = 8000;

//97/12/21						
CSMS4DCDoc* pDoc = GetDocument();
double mD = 150.0;
if	(pDoc->m_Resolution_x < 0.008333)	mD = 150.0*(pDoc->m_Resolution_x)/0.0083333333334;
CString msD;		msD.Format("%0.3f" , mD);
Int_ParametersDLG.m_D = atof(msD);

		if(Int_ParametersDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = Int_ParametersDLG.m_Emin,  tp = Int_ParametersDLG.m_T;
			double Frange = Int_ParametersDLG.m_F,   Drange = Int_ParametersDLG.m_D;
			BOOL hef_flag;
			BOOL YOK = OnInterferenceQy(assignIDX,latX,lonX,freq_assgnX,Drange,Frange,_T("BT"),&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
			//		CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString name1;
					long terrakey;
					double lat0,lon0;
					CString *m_Sel; m_Sel = new CString[Nrow];
					long IDstY;

					for(int Yi = 0;Yi<Nrow;Yi++)
					{
						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
						terrakey = atol(GetFld(m_Sel[Yi],1));
						name1 = GetFld(m_Sel[Yi],4);
						name1.TrimRight();
						lat0 = atof(GetFld(m_Sel[Yi],5));
						lon0  = atof(GetFld(m_Sel[Yi],6));

				//		AddStation_disp(terrakey,lat0, lon0,name1);
						IDstY = atol(GetFld(m_Sel[Yi],31));
				//		AddStation_disp(IDstX,lat0, lon0,name1);
						AddStation_disp(IDstY,lat0, lon0,name1);
					}
//	97/12/21
double Lat1, Lon1,Lat2, Lon2;
Point2LatLon(m_stBoxPoint, &Lat1, &Lon1);		Point2LatLon(m_enBoxPoint, &Lat2, &Lon2);

			//		CLoSDLG freedlg;
			//		freedlg.m_title = "Free Space Model Parameters";
			//		if (freedlg.DoModal()==IDOK)
					{
						int yst=1200-1-m_stBoxPoint.y;
						int yen=1200-1-m_enBoxPoint.y;
						int xst=m_stBoxPoint.x;
						int xen=m_enBoxPoint.x;

						int xN    = abs(xst - xen)  ,  yN    = abs(yst - yen) ;
						int xNmin = min(xst , xen)  ,  yNmin = min(yst , yen);
						xN=4*(xN/4);//		xNmin=4*(xNmin/4);

						xN=max(0,min(xN,1200));	yN=max(0,min(yN,1200));

						((CSMS4DCApp *)AfxGetApp())->xN = xN;
						((CSMS4DCApp *)AfxGetApp())->yN = yN;

						((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("InterferenceBT2BT (Free Space)");
						CInt_BT2BT_FreeDoc *pDocFree=(CInt_BT2BT_FreeDoc *) DocUtil::GetLastDocument("InterferenceBT2BT (Free Space)");	

				//		pDocFree->Freek=freedlg.m_kfactor;
				//		pDocFree->FreeRxH=freedlg.m_RxH;

						pDocFree->bufAreaW = xN;			pDocFree->bufAreaH = yN;
						pDocFree->bufAreaFree = new _int16[xN*yN];

//						CSMS4DCDoc* pDoc = GetDocument();	//97/12/21
						for (int i=0;i<xN;i++)
							for (int j=0;j<yN;j++)
								pDocFree->bufAreaFree[i+xN*j]=pDoc->buf[(yNmin+j)][(xNmin+i)];

						pDocFree->m_SelX = m_SelX;
						pDocFree->m_Fmin = Emin;
						pDocFree->Freelat_ST = latX;
						pDocFree->Freelon_ST = lonX;
						pDocFree->FreeName_ST = nameX;
						pDocFree->P_Location = Int_ParametersDLG.m_L;
						pDocFree->methodSUM = Int_ParametersDLG.m_method;
						pDocFree->m_AntDisc = Int_ParametersDLG.m_AntDisc;
						pDocFree->m_PolDisc = Int_ParametersDLG.m_PolDisc;
						pDocFree->m_EDIT_PolDisc = Int_ParametersDLG.m_EDIT_PolDisc;
/*		//97/12/21
						double xpm = xNmin + 600.0*(pDoc->TileX-1);
						double ypm = yNmin + 600.0*(pDoc->TileY-1);
						double xUTM = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
						double yUTM = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
						yUTM=yUTM-pDoc->m_Resolution_y/2.0;
						xUTM=xUTM-pDoc->m_Resolution_x/2.0;
						pDocFree->Freelat0 = yUTM;
						pDocFree->Freelon0 = xUTM;
*/
pDocFree->Freelat0   = min(Lat1, Lat2);	pDocFree->Freelon0   = min(Lon1, Lon2);
pDocFree->Freelatmax = max(Lat1, Lat2);	pDocFree->Freelonmax = max(Lon1, Lon2);

						pDocFree->TileInfo=pDoc->TileInfo;
						pDocFree->m_Resolution_x = pDoc->m_Resolution_x;
						pDocFree->m_ReadyDoc=1;
						pDocFree->GetData();
						pDocFree->UpdateAllViews(NULL);
					}
					delete [] m_Sel;
				}
			}
		}
	}
	EndWaitCursor();	
}

void CSMS4DCView::OnCoordinationGe89Bt2bt() 
{
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();
		CString CDataBaseSTR;
///		CDataBaseSTR.Format("select * from GE89BT2BT where ((ctry=\'%s\') AND (stn_cls=\'%s\'))",CTYdlg.m_code,_T("BT"));
//		CDataBaseSTR.Format(_T("SELECT * FROM GE89BT2BT WHERE (((ctry)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) AND ((stn_cls)='BT'));"),CTYdlg.m_code);
		CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((ctry)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) AND ((stn_cls)='BT'));"),m_qGE89BT2BT,CTYdlg.m_code);

		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

		CDataBaseLDLG datadlg;
		datadlg.m_Heff1 = TRUE;
		datadlg.m_Title = _Z("Wanted Station");
		if (datadlg.DoModal()==IDOK)
		{
			BeginWaitCursor();
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
			{
				CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				double freq_assgn = atof(GetFld(m_Sel,14));

				CGE89_Functions GE89x;
				BOOL GE89_BAND = GE89x.GE89_BAND(CTYdlg.m_code,freq_assgn);

				if(GE89_BAND)
				{
					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0,Hagl_ST, /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw, Power, eff_hgtmax;

					double attnH,attnV, h10[37], attH0[37], attV0[37], Hg;
					long AntID , terrakey;
					int az0[37];

					terrakey = atof(GetFld(m_Sel,1));
					name1 = GetFld(m_Sel,4);			name1.TrimRight();
					lat0 = atof(GetFld(m_Sel,5));
					lon0  = atof(GetFld(m_Sel,6));
					Hagl_ST = atof(GetFld(m_Sel,7));
					fmtv_terra_polar = GetFld(m_Sel,8);	fmtv_terra_polar.TrimRight();
					erp_dbw = atof(GetFld(m_Sel,9));
					erp_h_dbw = atof(GetFld(m_Sel,10));
					erp_v_dbw = atof(GetFld(m_Sel,11));
					ant_dir = GetFld(m_Sel,12);			ant_dir.TrimRight();
					eff_hgtmax = atof(GetFld(m_Sel,20));
					AntID = atol(GetFld(m_Sel,31));	
			
					if(datadlg.m_Heff1)
					{
						OnDatabaseStationsindesktop2(lat0, lon0);
					//	OnDatabaseStationsindesktop(-999,name1, lat0, lon0);
						Hg = LatLon2Hg(lat0,lon0) ;
					}
					else
					{
						Hg = atof(GetFld(m_Sel,13));
				//		GE84Heff(terrakey,eff_hgtmax,h10) ;
						GE84Heff(AntID,eff_hgtmax,h10) ;
					}
					for(int i=0;i<36;i++)
						az0[i] = 10*i;
					if(ant_dir=="D")
						GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
					else
						for(int i=0;i<36;i++)
						{
							attH0[i] = 0;
							attV0[i] = 0;
						}
					az0[36] = 360;
					h10[36] = h10[0];
					attH0[36] = attH0[0];
					attV0[36] = attV0[0];
				
					float RLON = (float)(lon0*pi/180.0),
						  RLAT = (float)(lat0*pi/180.0),
						  RANGE = 1500.0,
						  RDIST,	RAZIM, 	  RLONb,	RLATb,
						  ARRAY[2][2] = {RLON, RLAT, RLON, RLAT};

					long IVAL = 1, IRANGE = 1500;
					GEOMAP( &IVAL, (float *)ARRAY, &IRANGE);

					CString cty1("");
					GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;

					long MAXCTY=500  ,NOCTY ,LUNCCD = 1, SORDER = 0, IREST;
					unsigned char CTYCOD[1500];
					short KMCTY[1000];
					GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
										 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					if(IREST==-1)
					{
						cty1 = CTYdlg.m_code;
						GEOCRDN( &LUNCCD, &SORDER, (BYTE *)cty1.GetBufferSetLength(3), &IRANGE, &MAXCTY, 
											 (unsigned char*)CTYCOD, (short*)KMCTY, &NOCTY, &IREST );
					}
					char temp[4];

					if(NOCTY>0)
					{
						CString m_CTY, Affected, REGION, str = "",	str1 = "";
						int k = 0;
						double DM = 0.0, h1;
						CPoint m_Point_STcr3,m_Point_STcr15;
						double lat3km,lon3km,lat15km,lon15km;
				//		CGE84_Functions GE84x;
						CString RLONbs,RLATbs;

						double zDist[8] , Di[8];
						CString Zones[8];
						int IER = 1;

						for(int i=0;i<NOCTY ;i++)
						{
							temp[0]=CTYCOD[3*i];
							temp[1]=CTYCOD[3*i+1];
							temp[2]=CTYCOD[3*i+2];
							temp[3]=0;
							m_CTY = temp;

							if(GE89x.Fixed_cty(m_CTY))
							{
								GEODC1( &RLON, &RLAT, (BYTE*)m_CTY.GetBufferSetLength(3), &RANGE, &RDIST, &RAZIM);
								if(RDIST<=RANGE)
								{
									GEOPDAP( &RLON, &RLAT, &RDIST, &RAZIM, &RLONb, &RLATb);
									/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
									if(cty1!=m_CTY)
									{
										if(datadlg.m_Heff1)
										{
											reckon( lat0,lon0,  3.0 , RAZIM , &lat3km  , &lon3km) ;
											reckon( lat0,lon0, 15.0 , RAZIM , &lat15km , &lon15km) ;
											double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
											h1 = Hg + Hagl_ST - hv1 ;
										}
										else
											h1 = Interp2(az0,h10,RAZIM,37) ;
																
										/////////////////////////////////////////////////////////////////////////////////////
										IER = 1;
										IER = GEZones(3,lat0,lon0,RLATb*180.0/pi,RLONb*180.0/pi,zDist,Zones) ;
								
										attnH = Interp2(az0,attH0,RAZIM,37) ;
										attnV = Interp2(az0,attV0,RAZIM,37) ;
										if	   (fmtv_terra_polar == _T("H"))	erpdbw = erp_h_dbw - attnH;
										else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
										else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));
										Power = pow(10.0,erpdbw/10.0);

										double h11 = h1;
								//		h1 = min(1800.0,max(10.0,h1));

										DM = 0;
										if(IER==0)
										{
											for(int j=0;j<8;j++)
											{
												Di[j] = GE89x.GE89_Dcord(Zones[j],h1,Power,freq_assgn);
												DM = DM + zDist[j]*Di[j];
											}
											DM = DM/RDIST;
										}

										if(RDIST<DM)		Affected = _T("+++");
										else				Affected = _T("---");

										if(Affected != _T("---"))
										{
											k++;
											GEOCTYR( (BYTE*)m_CTY.GetBufferSetLength(3), (BYTE*)REGION.GetBufferSetLength(1));
											Rad2Str(RLONb,RLATb, &RLONbs,&RLATbs);
											str.Format("%s,%s,%s  %s,%0.3f,%0.3f,%0.3f,%0.1f,%0.3f,%s",Affected,m_CTY,RLONbs,RLATbs,RAZIM,RDIST,DM,h11,freq_assgn,REGION);
											str1=str1+","+str;
										}

									}	//end if(RDIST!=0)
								}	//end if(RDIST<RANGE)

							}	//if(GE89x.Fixed_cty(m_CTY))

						}	//end for

						CString assignIDX = GetFld(m_Sel,2);
						str1.Delete(0);
						CGE84BC2BCDLG dlgList;
						dlgList.m_title = _Z("GE89 BT to BT - Coordination Distance");
						dlgList.m_nROWS = k+1+0;
						Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
						str.Format("%s,%s,%s  %s,%s,%s,%s,%s,%s,%s",assignIDX,cty1,RLONbs,RLATbs,name1," "," "," "," "," ");
						str1=str+","+str1;
						dlgList.m_data = str1;
						dlgList.DoModal();

					}	//end if(NOCTY>0)

				}	//end if freq_assgn

			}	//end if (Nrow==1)
		}	//end datadlg
		Set_STtable_Default();
		EndWaitCursor();
	}	//end CTYdlg		
}

int CSMS4DCView::GEZones(int plan,double lat01, double lon01 , double lat02, double lon02,double *zDist,CString *z) 
{
	double pi=4.*atan(1.);
	float RLON1 = (float)(lon01*pi/180.0),	  RLAT1 = (float)(lat01*pi/180.0),
		  RLON2 = (float)(lon02*pi/180.0),	  RLAT2 = (float)(lat02*pi/180.0);

	long N = plan,IER;
	GEOPRMS(&N, &IER);

//	long IVAL = 1,IRANGE = 1500;
//	float WND[2][2] = {RLONLL, RLATLL, RLONUR, RLATUR};

	long IVAL = 2 , IRANGE = 1500,  NRPNT = 2;
	float  ARRAY[2][2] = {RLON1, RLAT1, RLON2, RLAT2},  WND[2][2];
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOPRM( &IVAL, (float *)WND, &IRANGE);

	unsigned char PRCODVEK[2*10];
	float RDIST , PRDVEK[10], RATIOVEK[10];
	long IZONES , IER1;

	GEOPRCP( &RLON1, &RLAT1, &RLON2, &RLAT2, &RDIST, &IZONES, (unsigned char *)PRCODVEK, (float *)PRDVEK, (float *)RATIOVEK, &IER1);
	int i;
	if(IER1==0)
	{
		for(i=0;i<IZONES;i++)
		{
			z[i].Format("%c%c",PRCODVEK[2*i],PRCODVEK[2*i+1]);	z[i].TrimRight();
			zDist[i] = PRDVEK[i];
		}
	}
	else
	{
		for(i=0;i<IZONES;i++)
			zDist[i] = 0;
	}
	return IER1;
}

CString CSMS4DCView::OnGE89Qx(CString stn_cls) 
{
	BeginWaitCursor();
	CString SelX = _T(" ");
	CCountrySelectionDLG CTYdlg;
	if (CTYdlg.DoModal()==IDOK)
	{
		BeginWaitCursor();

		CString CDataBaseSTR;
///		CDataBaseSTR.Format("select * from GE89BT2BT where ((ctry=\'%s\') AND (stn_cls=\'%s\'))",CTYdlg.m_code,stn_cls);
//		CDataBaseSTR.Format(_T("SELECT * FROM GE89BT2BT WHERE (((ctry)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) AND ((stn_cls)=\'%s\'));"),CTYdlg.m_code,stn_cls);
		CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((ctry)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) AND ((stn_cls)=\'%s\'));"),m_qGE89BT2BT,CTYdlg.m_code,stn_cls);
		
		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
		CDataBaseLDLG datadlg;
		datadlg.m_Title = _T("Wanted Station");

		if (datadlg.DoModal()==IDOK)
		{
			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			if (Nrow==1)
				SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		}
		Set_STtable_Default();
	}
	return SelX;
}

BOOL CSMS4DCView::OnGE89Qy(long assignIDX,double latX, double lonX, double frqX, double Drange,CString stn_cls, BOOL *hef_flag,int tofrom) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

	CString CDataBaseSTR;
///	CDataBaseSTR.Format("select * from GE89BT2BT where (((assgn_id)<>%ld) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((stn_cls=\'%s\') ))",assignIDX,latmin,latmax,lonmin,lonmax,stn_cls);
//	CDataBaseSTR.Format(_T("SELECT * FROM GE89BT2BT WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((stn_cls)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)));"),assignIDX,latmin,latmax,lonmin,lonmax,stn_cls);
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Assgn_ID)<>%ld) AND ((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((stn_cls)=\'%s\') AND (((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)));"),m_qGE89BT2BT,assignIDX,latmin,latmax,lonmin,lonmax,stn_cls);
	
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = TRUE;
	if	   (tofrom==0)	datadlg.m_Title = _T("Interferer Stations");
	else if(tofrom==1)	datadlg.m_Title = _T("Victim Stations");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnCoordinationGe89Eu() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=" ")
	{
	//	CString assignIDX = GetFld(m_SelX,2);
		long assignIDX = atol(GetFld(m_SelX,2));
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);

		double FvX = atof(GetFld(m_SelX,18));
		double FsX = atof(GetFld(m_SelX,25));
		double offvX = atof(GetFld(m_SelX,23));
		double VSRx = atof(GetFld(m_SelX,27));
		int Yn , j , IER , Xn = atol(GetFld(m_SelX,28));
		CString Xcolor = GetFld(m_SelX,29) , Zones[8];	Xcolor.TrimRight();
		CString freq_stablX = GetFld(m_SelX,22);	freq_stablX.TrimRight();

		double FvY, FsY, offvY , offsY, VSRy , At, Ac , Elimit , zDist[8] , Alpha_t,Frac, ELt, ESt;
		BOOL PR89;

		CGE89_Functions GE89x;

		int BandNUM = GE89x.GE89_BAND1345(ctyX,FvX) ;
		if		(BandNUM == 1)	Elimit = 47;
		else if (BandNUM == 3)	Elimit = 53;
		else if (BandNUM == 4)	Elimit = 62;
		else if (BandNUM == 5)	Elimit = 67;
		else
		{
			CString str;
			str.Format(_Z("\n\tThe frequency of the Wanted Station [ %g ] is not included in GE89 .\t\n"),FvX);
			MessageBox(str,_Z("Warning!!!"));
			return;
		}

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 800;
		rangeDLG.m_Emin = Elimit;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			Elimit = rangeDLG.m_Emin;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag;
			BOOL YOK = OnGE89Qy(assignIDX,latX,lonX,FvX,Drange,_T("BT"),&hef_flag,0);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);
					nameX.TrimRight();
					CString Ysys, Xsys  = GetFld(m_SelX,16);	Xsys.TrimRight();
					CString fmtv_terra_polarX = GetFld(m_SelX,8);	fmtv_terra_polarX.TrimRight();

					CString name1, fmtv_terra_polar, ant_dir;
					double lat0,lon0,Hagl_ST, h10[37], attH0[37], attV0[37], /*pi = 4.0*atan(1.0),*/
							erp_dbw, erp_h_dbw, erp_v_dbw, erpdbw,attnH,attnV;
					long AntID , terrakey, k = 0;
					int az0[37];

					CString *m_Sel; m_Sel = new CString[Nrow];
					double *Esi; Esi = new double[Nrow];

					double RDIST, RAZIM, eff_hgtmax , h1;
					double Et = -999.999, E50 = Et;
					double PR, Bi = 0.0, Eu;
					double  Eu_out = Et, Es0;
					CString Yst_cls, assignIDY,ctyY, strX,strY="",strY1="";

					double g_dB , Lp;
					double *g_dBk;	g_dBk = new double[Nrow];

					for(int i=0;i<36;i++)
						az0[i] = 10*i;
					az0[36] = 360;

					int progress_num=0;
					CString progress_str, progress_char = _T("I");
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						Ysys  = GetFld(m_Sel[Yi],16);			Ysys.TrimRight();
						FvY = atof(GetFld(m_Sel[Yi],18));
						FsY = atof(GetFld(m_Sel[Yi],25));
						offvY = atof(GetFld(m_Sel[Yi],23));
						offsY = atof(GetFld(m_Sel[Yi],26));
						VSRy = atof(GetFld(m_Sel[Yi],27));
						Yn = atol(GetFld(m_Sel[Yi],28));

						PR89 = GE89x.Protection_Ratio(FvX , FvY , FsX , FsY , 
							offvX , offvY ,  offsY , VSRx ,VSRy ,Xn ,Yn ,
							Xsys, Ysys ,Xcolor ,freq_stablX ,&At ,&Ac );

						if(PR89==TRUE)
						{
							terrakey = atol(GetFld(m_Sel[Yi],1));
							assignIDY = GetFld(m_Sel[Yi],2);
							ctyY = GetFld(m_Sel[Yi],3);
							name1 = GetFld(m_Sel[Yi],4);			name1.TrimRight();
							lat0 = atof(GetFld(m_Sel[Yi],5));
							lon0  = atof(GetFld(m_Sel[Yi],6));
							Hagl_ST = atof(GetFld(m_Sel[Yi],7));
							fmtv_terra_polar = GetFld(m_Sel[Yi],8);	fmtv_terra_polar.TrimRight();
							erp_dbw = atof(GetFld(m_Sel[Yi],9));
							erp_h_dbw = atof(GetFld(m_Sel[Yi],10));
							erp_v_dbw = atof(GetFld(m_Sel[Yi],11));
							ant_dir = GetFld(m_Sel[Yi],12);			ant_dir.TrimRight();
							Yst_cls = GetFld(m_Sel[Yi],17);
							AntID = atol(GetFld(m_Sel[Yi],31));

							IER = 1;
							IER = GEZones(3,lat0,lon0,latX,lonX,zDist,Zones) ;
							if(IER==0)
							{
								if(ant_dir=="D")
									GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
								else
									for(int i=0;i<36;i++)
									{
										attH0[i] = 0;
										attV0[i] = 0;
									}
								attH0[36] = attH0[0];
								attV0[36] = attV0[0];

								RAZIM = Azimuth_Deg(lat0,lon0,latX,lonX);
								RDIST = Distance_km(lat0,lon0,latX,lonX);

								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(lat0 , lon0 , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_Sel[Yi],20));
								//	GE84Heff(terrakey,eff_hgtmax,h10) ;
									GE84Heff(AntID,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( lat0 , lon0, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FvY,RDIST,dH, ctyY);
								Lp = GE89x.F_2B_1_2(FvY, P_location, dH, ctyY);

								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == "H")			erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == "V")	erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == "M")
									erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FvY>=300)&&(FvY<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvY, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvY, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvY, tp, Zones[j], h1, RDIST) ;
								}
								E50 = 0;
								for( j=0;j<8;j++)
									E50 = E50 + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvY, 50.0, Zones[j], h1, RDIST) ;

								Et  = Et  + erpdbw - 30.0 - g_dB + Lp;
								E50 = E50 + erpdbw - 30.0 - g_dB + Lp;

								PR = ((E50+Ac)>=(Et+At)) ? Ac : At;

								Es0 = Et + PR + Bi;
								if (Es0>=Emin)
								{
									g_dBk[k] =  g_dB;

									Esi[k] = Es0;
									k++;
									strY1.Format("%s,%s,%s,%f,%0.2f,%s,%0.6f,%0.0f",assignIDY,name1,ctyY,FvY,PR,fmtv_terra_polar,Es0,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if PR89

					}// end for Yi


					if(k>0)
					{
						// g_dB = f(DeltaH)
						Eu = GE89x.Eu_SimpleMulti(Esi,k, P_location, FvX,  g_dBk) ;
						Eu_out = Eu;
					}
					delete [] g_dBk;delete [] Esi;	delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

			//		strX.Format("%s,%s,%s,%f,%s,%0.6f",assignIDX,nameX,ctyX,FvX,fmtv_terra_polarX,Eu_out);
					strX.Format("%ld,%s,%s,%f,%s,%0.6f",assignIDX,nameX,ctyX,FvX,fmtv_terra_polarX,Eu_out);
					strY.Delete(0);
					CGE89_EuDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();
				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX
	EndWaitCursor();
}

double CSMS4DCView::Delta_H(double lat0 , double lon0,double az) 
{
	double lat10km  , lon10km , latkm  , lonkm , lat50km  , lon50km;

	reckon( lat0,lon0, 10.0 , az , &lat10km , &lon10km) ;
	reckon( lat0,lon0, 50.0 , az , &lat50km , &lon50km) ;

	double latmin = min(lat0,min(lat10km,lat50km));
	double lonmin = min(lon0,min(lon10km,lon50km));
	OnDatabaseStationsindesktop2(latmin, lonmin);

	int N = 100;
	double step = (50.0-10.0)/N;

	double *hi;	hi = new double[N+1];

	double d,h0;
	long i;
	for( i=0;i<=N;i++)
	{
		d = 10.0 + i*step;
		reckon( lat0,lon0,  d , az , &latkm  , &lonkm) ;
		hi[i] = LatLon2Hg(latkm  , lonkm) ;
	}

	long j, k;
	double Per , minH = hi[0] , maxH = hi[0];

	for( j=0;j<=N;j++)
	{
		h0 = hi[j];
		k = 0;
		for( i=0;i<=N;i++)
		{
			if(hi[i]>h0)
				k++;
		}
		Per = 100.0*((double)(k))/((double)(N+1));

		if((Per>=10)||(Per<=90))
		{
			minH = min(h0,minH);
			maxH = max(h0,maxH);
		}
	}
	delete [] hi;

	double Delta_H = maxH - minH;
	return Delta_H;
}

double CSMS4DCView::Eff_H(double lat0 , double lon0,double az,double Hagl) 
{
	double lat3km  , lon3km , lat15km , lon15km , Hg;

	reckon( lat0,lon0,  3.0 , az , &lat3km  , &lon3km) ;
	reckon( lat0,lon0, 15.0 , az , &lat15km , &lon15km) ;

	double latmin = min(lat0,min(lat3km,lat15km));
	double lonmin = min(lon0,min(lon3km,lon15km));
	OnDatabaseStationsindesktop2(latmin, lonmin);

	Hg = LatLon2Hg(lat0,lon0) ;
	double hv1 = Points2HgAvr1(lat3km, lon3km, lat15km ,lon15km); 
	double h1 = Hg + Hagl - hv1 ;
	return h1;
}

void CSMS4DCView::OnCoordinationGe89Eui() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=" ")
	{
//		CString assignIDX = GetFld(m_SelX,2);
		long assignIDX = atol(GetFld(m_SelX,2));
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);	ctyX.TrimRight();

		double FvX = atof(GetFld(m_SelX,18));
		double FsX = atof(GetFld(m_SelX,25));
		double offvX = atof(GetFld(m_SelX,23));
		double VSRx = atof(GetFld(m_SelX,27));
		int Yn , j , IER , Xn = atol(GetFld(m_SelX,28));

		double offsX = atof(GetFld(m_SelX,26));
		CString Ycolor, freq_stablY , Zones[8];
		double Hagl_ST = atof(GetFld(m_SelX,7));
		CString ant_dir = GetFld(m_SelX,12);			ant_dir.TrimRight();
		CString	fmtv_terra_polar = GetFld(m_SelX,8);	fmtv_terra_polar.TrimRight();
		long terrakey = atol(GetFld(m_SelX,1));
		double erp_dbw = atof(GetFld(m_SelX,9));
		double erp_h_dbw = atof(GetFld(m_SelX,10));
		double erp_v_dbw = atof(GetFld(m_SelX,11));
		long AntID = atol(GetFld(m_SelX,31));

		double attH0[37], attV0[37];
		if(ant_dir=="D")
			GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
		else
			for(int i=0;i<36;i++)
			{
				attH0[i] = 0;
				attV0[i] = 0;
			}
		attH0[36] = attH0[0];
		attV0[36] = attV0[0];

		double FvY, FsY, offvY, VSRy , At, Ac , Elimit , zDist[8] , Alpha_t,Frac, ELt, ESt;

		CGE89_Functions GE89x;

		int BandNUM = GE89x.GE89_BAND1345(ctyX,FvX) ;
		if		(BandNUM == 1)	Elimit = 47;
		else if (BandNUM == 3)	Elimit = 53;
		else if (BandNUM == 4)	Elimit = 62;
		else if (BandNUM == 5)	Elimit = 67;
		else
		{
			CString str;
			str.Format(_Z("\n\tThe frequency of the Wanted Station [ %g ] is not included in GE89 .\t\n"),FvX);
			MessageBox(str,_Z("Warning!!!"));
			return;
		}

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 800;
		rangeDLG.m_Emin = Elimit;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			Elimit = rangeDLG.m_Emin;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag;
			BOOL YOK = OnGE89Qy(assignIDX,latX,lonX,FvX,Drange,_T("BT"),&hef_flag,1);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);			nameX.TrimRight();
					CString Ysys, Xsys  = GetFld(m_SelX,16);	Xsys.TrimRight();
					CString name1, fmtv_terra_polarY;
					CString *m_Sel; m_Sel = new CString[Nrow];
					CString Yst_cls, assignIDY,ctyY, strX,strY="",strY1="";

					double lat0,lon0,h10[37], /*pi = 4.0*atan(1.0),*/ erpdbw,attnH,attnV;
					double RDIST, RAZIM, eff_hgtmax , h1 ,  g_dB , Lp;
					double Et = -999.999, E50 = Et , Es0 , PR, Bi = 0.0;

					long k = 0;
					int az0[37];
					for(int i=0;i<36;i++)
						az0[i] = 10*i;
					az0[36] = 360;

					BOOL PR89;

					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						Ysys  = GetFld(m_Sel[Yi],16);		Ysys.TrimRight();
						FvY = atof(GetFld(m_Sel[Yi],18));
						FsY = atof(GetFld(m_Sel[Yi],25));
						offvY = atof(GetFld(m_Sel[Yi],23));
						VSRy = atof(GetFld(m_Sel[Yi],27));
						Yn = atol(GetFld(m_Sel[Yi],28));

						Ycolor = GetFld(m_Sel[Yi],29);	Ycolor.TrimRight();
						freq_stablY = GetFld(m_Sel[Yi],22);	freq_stablY.TrimRight();

						PR89 = GE89x.Protection_Ratio(FvY , FvX , FsY , FsX ,
							offvY , offvX ,  offsX , VSRy ,VSRx ,Yn ,Xn ,
							Ysys, Xsys ,Ycolor ,freq_stablY ,&At ,&Ac );

						if(PR89==TRUE)
						{
							assignIDY = GetFld(m_Sel[Yi],2);
							ctyY = GetFld(m_Sel[Yi],3);
							name1 = GetFld(m_Sel[Yi],4);	name1.TrimRight();
							lat0 = atof(GetFld(m_Sel[Yi],5));
							lon0  = atof(GetFld(m_Sel[Yi],6));
							fmtv_terra_polarY = GetFld(m_Sel[Yi],8);	fmtv_terra_polarY.TrimRight();
							Yst_cls = GetFld(m_Sel[Yi],17);

							IER = 1;
							IER = GEZones(3,latX,lonX,lat0,lon0,zDist,Zones) ;
							if(IER==0)
							{
								RAZIM = Azimuth_Deg(latX,lonX,lat0,lon0);
								RDIST = Distance_km(latX,lonX,lat0,lon0);
								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(latX,lonX , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_SelX,20));
								//	GE84Heff(terrakey,eff_hgtmax,h10) ;
									GE84Heff(AntID,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( latX,lonX, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FvX,RDIST,dH, ctyX);
								Lp = GE89x.F_2B_1_2(FvX, P_location, dH, ctyX);
								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == "H")			erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == "V")	erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == "M")
									erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FvX>=300)&&(FvX<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvX, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvX, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvX, tp, Zones[j], h1, RDIST) ;
								}
								E50 = 0;
								for( j=0;j<8;j++)
									E50 = E50 + (zDist[j]/RDIST)*GE89x.GE89_E_3(FvX, 50.0, Zones[j], h1, RDIST) ;

								Et  = Et  + erpdbw - 30.0 - g_dB + Lp;
								E50 = E50 + erpdbw - 30.0 - g_dB + Lp;

								PR = ((E50+Ac)>=(Et+At)) ? Ac : At;

								Es0 = Et + PR + Bi;
								if (Es0>=Emin)
								{
									k++;
									strY1.Format("%s,%s,%s,%f,%0.2f,%s,%0.6f,%0.0f",assignIDY,name1,ctyY,FvY,PR,fmtv_terra_polarY,Es0,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if PR89

					}// end for Yi

					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

			//		strX.Format("%s,%s,%s,%f,%s,%s",assignIDX,nameX,ctyX,FvX,fmtv_terra_polar,"----");
					strX.Format("%ld,%s,%s,%f,%s,%s",assignIDX,nameX,ctyX,FvX,fmtv_terra_polar,"----");
					strY.Delete(0);
					CGE89_EuDLG dlgList;

					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.m_title1 =  _Z("GE89 : Interference from wanted station to selected stations");
					dlgList.m_title2 =  _Z("Interference to : ");

					dlgList.DoModal();

				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX

	EndWaitCursor();	
}

BOOL CSMS4DCView::OnGE89FXMQy(double latX, double lonX, double frqX, double Drange, double Frange,CString stn_cls, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

	double fmin = frqX - Frange/1000.0;
	double fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
	if(stn_cls=="FX")
	{
//		CDataBaseSTR.Format("select * from GE89BT2FX where (((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_assgn)>=%f AND (freq_assgn)<=%f) AND ((stn_cls)=\'%s\'));",latmin,latmax,lonmin,lonmax,fmin,fmax, "FX");

		CString FLDs, geo_pt, FRQ;
		geo_pt.Format("(SELECT fxm_geo_pt.* FROM fxm_geo_pt WHERE fxm_geo_pt.lat_dec>=%f And fxm_geo_pt.lat_dec<=%f AND fxm_geo_pt.long_dec>=%f And fxm_geo_pt.long_dec<=%f)",latmin,latmax,lonmin,lonmax);
		FRQ.Format("fxm_terra.freq_assgn>=%f and fxm_terra.freq_assgn<=%f",fmin,fmax);
		FLDs.Format("select fxm_terra.terrakey, fxm_terra.assgn_id, fxm_terra.geo_key, freq_assgn,stn_cls, lat_dec, long_dec,bdwdth from fxm_terra");
		CDataBaseSTR.Format("%s , fxm_rx, %s as geoX where fxm_rx.geo_key=geoX.geo_key and fxm_terra.terrakey=fxm_rx.terrakey and %s and fxm_terra.stn_cls=\'%s\';",  FLDs, geo_pt, FRQ, "FX");
	}
	else if(stn_cls=="FB")
	{
//		CDataBaseSTR.Format("select * from GE89BT2FX where (((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_assgn)>=%f AND (freq_assgn)<=%f) AND ((stn_cls)=\'%s\' Or (stn_cls)=\'%s\'));",latmin,latmax,lonmin,lonmax,fmin,fmax, stn_cls,"ML");

		CString ML, FB, FLDs, geo_pt, FRQ;
		geo_pt.Format("(SELECT fxm_geo_pt.* FROM fxm_geo_pt WHERE fxm_geo_pt.lat_dec>=%f And fxm_geo_pt.lat_dec<=%f AND fxm_geo_pt.long_dec>=%f And fxm_geo_pt.long_dec<=%f)",latmin,latmax,lonmin,lonmax);
		FRQ.Format("fxm_terra.freq_assgn>=%f and fxm_terra.freq_assgn<=%f",fmin,fmax);
		FLDs.Format("select fxm_terra.terrakey, fxm_terra.assgn_id, fxm_terra.geo_key, freq_assgn,stn_cls, lat_dec, long_dec,bdwdth from fxm_terra");
	
		ML.Format("%s , %s where fxm_terra.geo_key=fxm_geo_pt.geo_key and %s and fxm_terra.stn_cls=\'%s\'",  FLDs, geo_pt, FRQ, "ML");
		FB.Format("%s , fxm_rx, %s as geoX where fxm_rx.geo_key=geoX.geo_key and fxm_terra.terrakey=fxm_rx.terrakey and %s and fxm_terra.stn_cls=\'%s\';",  FLDs, geo_pt, FRQ, "FB");
		CDataBaseSTR.Format("%s UNION ALL %s",ML,FB);
	}

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = TRUE;
	datadlg.m_Title = "Interferer Stations";

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

BOOL CSMS4DCView::OnGE89FXMQyL(double latX, double lonX, double frqX, double Drange, double Frange,CString stn_cls, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

	double fmin = frqX - Frange/1000.0;
	double fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
	if(stn_cls==_T("FX"))
	{
//		CDataBaseSTR.Format("select * from STtable where (((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((RXfreq)>=%f AND (RXfreq)<=%f) AND ((STTP)=\'%s\'));",latmin,latmax,lonmin,lonmax,fmin,fmax, _T("FX"));
///		CDataBaseSTR.Format(_T("SELECT * FROM STtable WHERE (((STlat_deg)>=%lf And (STlat_deg)<=%lf) AND ((STlon_deg)>=%lf And (STlon_deg)<=%lf) AND ((((RXfreq)>=47 And (RXfreq)<=68) Or ((RXfreq)>=230 And (RXfreq)<=238) Or ((RXfreq)>=246 And (RXfreq)<=254)) And ((RXfreq)>=%lf And (RXfreq)<=%lf)) AND ((STTP)=\'%s\'));"),latmin,latmax,lonmin,lonmax,fmin,fmax, _T("FX"));
		CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((STlat_deg)>=%lf And (STlat_deg)<=%lf) AND ((STlon_deg)>=%lf And (STlon_deg)<=%lf) AND ((((RXfreq)>=47 And (RXfreq)<=68) Or ((RXfreq)>=230 And (RXfreq)<=238) Or ((RXfreq)>=246 And (RXfreq)<=254)) And ((RXfreq)>=%lf And (RXfreq)<=%lf)) AND ((STTP)=\'%s\'));"),m_qSTtable,latmin,latmax,lonmin,lonmax,fmin,fmax, _T("FX"));

//		CDataBaseSTR.Format("select * from STtable where (((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((TXfreq)>=%f AND (TXfreq)<=%f) AND ((STTP)=\'%s\'));",latmin,latmax,lonmin,lonmax,fmin,fmax, _T("FX"));

//		CString FLDs, geo_pt, FRQ;
//		geo_pt.Format("(SELECT fxm_geo_pt.* FROM fxm_geo_pt WHERE fxm_geo_pt.lat_dec>=%f And fxm_geo_pt.lat_dec<=%f AND fxm_geo_pt.long_dec>=%f And fxm_geo_pt.long_dec<=%f)",latmin,latmax,lonmin,lonmax);
//		FRQ.Format("fxm_terra.freq_assgn>=%f and fxm_terra.freq_assgn<=%f",fmin,fmax);
//		FLDs.Format("select fxm_terra.terrakey, fxm_terra.assgn_id, fxm_terra.geo_key, freq_assgn,stn_cls, lat_dec, long_dec,bdwdth from fxm_terra");
//		CDataBaseSTR.Format("%s , fxm_rx, %s as geoX where fxm_rx.geo_key=geoX.geo_key and fxm_terra.terrakey=fxm_rx.terrakey and %s and fxm_terra.stn_cls=\'%s\';",  FLDs, geo_pt, FRQ, "FX");
	}
	else if(stn_cls==_T("FB"))
	{
//		CDataBaseSTR.Format("SELECT * FROM STtable WHERE (((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((RXfreq)>=%f And (RXfreq)<=%f) AND ((STTP)=\'FB\' Or (STTP)=\'ML\'));",latmin,latmax,lonmin,lonmax,fmin,fmax);
///		CDataBaseSTR.Format(_T("SELECT * FROM STtable WHERE (((STlat_deg)>=%lf And (STlat_deg)<=%lf) AND ((STlon_deg)>=%lf And (STlon_deg)<=%lf) AND ((((RXfreq)>=47 And (RXfreq)<=68) Or ((RXfreq)>=230 And (RXfreq)<=238) Or ((RXfreq)>=246 And (RXfreq)<=254)) And ((RXfreq)>=%lf And (RXfreq)<=%lf)) AND ((STTP)='FB' Or (STTP)='ML'));"),latmin,latmax,lonmin,lonmax,fmin,fmax);
		CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((STlat_deg)>=%lf And (STlat_deg)<=%lf) AND ((STlon_deg)>=%lf And (STlon_deg)<=%lf) AND ((((RXfreq)>=47 And (RXfreq)<=68) Or ((RXfreq)>=230 And (RXfreq)<=238) Or ((RXfreq)>=246 And (RXfreq)<=254)) And ((RXfreq)>=%lf And (RXfreq)<=%lf)) AND ((STTP)='FB' Or (STTP)='ML'));"),m_qSTtable,latmin,latmax,lonmin,lonmax,fmin,fmax);


//		CString ML, FB, FLDs, geo_pt, FRQ;
//		geo_pt.Format("(SELECT fxm_geo_pt.* FROM fxm_geo_pt WHERE fxm_geo_pt.lat_dec>=%f And fxm_geo_pt.lat_dec<=%f AND fxm_geo_pt.long_dec>=%f And fxm_geo_pt.long_dec<=%f)",latmin,latmax,lonmin,lonmax);
//		FRQ.Format("fxm_terra.freq_assgn>=%f and fxm_terra.freq_assgn<=%f",fmin,fmax);
//		FLDs.Format("select fxm_terra.terrakey, fxm_terra.assgn_id, fxm_terra.geo_key, freq_assgn,stn_cls, lat_dec, long_dec,bdwdth from fxm_terra");
	
//		ML.Format("%s , %s where fxm_terra.geo_key=fxm_geo_pt.geo_key and %s and fxm_terra.stn_cls=\'%s\'",  FLDs, geo_pt, FRQ, "ML");
//		FB.Format("%s , fxm_rx, %s as geoX where fxm_rx.geo_key=geoX.geo_key and fxm_terra.terrakey=fxm_rx.terrakey and %s and fxm_terra.stn_cls=\'%s\';",  FLDs, geo_pt, FRQ, "FB");
//		CDataBaseSTR.Format("%s UNION ALL %s",ML,FB);
	}

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = TRUE;
	datadlg.m_Title =_T("Victim Stations");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnCoordinationGe89Fx() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=_T(" "))
	{
		CString assignIDX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);	ctyX.TrimRight();
		double FaX = atof(GetFld(m_SelX,14));
		double FvX = atof(GetFld(m_SelX,18));
		double FsX = atof(GetFld(m_SelX,25));
		double Hagl_ST = atof(GetFld(m_SelX,7));
		CString ant_dir = GetFld(m_SelX,12);			ant_dir.TrimRight();
		CString	fmtv_terra_polar = GetFld(m_SelX,8);	fmtv_terra_polar.TrimRight();
		long terrakey = atol(GetFld(m_SelX,1));
		double erp_dbw = atof(GetFld(m_SelX,9));
		double erp_h_dbw = atof(GetFld(m_SelX,10));
		double erp_v_dbw = atof(GetFld(m_SelX,11));
		long AntID = atol(GetFld(m_SelX,31));

		double attH0[37], attV0[37];
		if(ant_dir==_T("D"))
			GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
		else
			for(int i=0;i<36;i++)
			{
				attH0[i] = 0;
				attV0[i] = 0;
			}
		attH0[36] = attH0[0];
		attV0[36] = attV0[0];

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 4000;
		rangeDLG.m_T = 10;

		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag;
			BOOL YOK = OnGE89FXMQyL(latX,lonX,FaX,Drange,Frange,_T("FX"),&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString Xcolor = GetFld(m_SelX,29);		Xcolor.TrimRight();
					CString RLONbs , RLATbs;

					CString *m_Sel; m_Sel = new CString[Nrow];
					CString name1 , Zones[8] , Yst_cls, assignIDY,ctyY, strX,strY=_T(""),strY1=_T("");

					int j , IER ;
					double Fc , DeltaF , RPR , Elimit , Ff , zDist[8] , Alpha_t,Frac, ELt, ESt;
					BOOL Fixed_Band;

					double Fs = FsX-FvX;
					if(Xcolor==_T("NTSC"))									Fc = 3.579;
					else if ((Xcolor==_T("PAL"))||(Xcolor==_T("SECAM")))	Fc = 4.43;

					double lat0,lon0,h10[37], /*pi = 4.0*atan(1.0),*/ erpdbw,attnH,attnV;
					double RDIST, RAZIM, eff_hgtmax , h1 ,  g_dB , Lp , Et = -999.999 ;
					float Rlon0, Rlat0;

					long k = 0;
					int az0[37];
					for(int i=0;i<36;i++)		az0[i] = 10*i;
					az0[36] = 360;

					CGE89_Functions GE89x;
					double Height_gain,HrI;

					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						name1 = GetFld(m_Sel[Yi],2);
						lat0 = atof(GetFld(m_Sel[Yi],3));		lon0  = atof(GetFld(m_Sel[Yi],4));
						ctyY = LatLon2Ctry( lat0, lon0);
						Rlon0 = (float)(lon0*pi/180.0);			Rlat0 = (float)(lat0*pi/180.0);

						Ff = atof(GetFld(m_Sel[Yi],21));
						Fixed_Band = GE89x.Fixed_Band(Ff,ctyY);

						if(Fixed_Band==TRUE)
						{
							assignIDY = GetFld(m_Sel[Yi],1);
							Yst_cls = GetFld(m_Sel[Yi],18);

							IER = 1;
							IER = GEZones(3,latX,lonX,lat0,lon0,zDist,Zones) ;
							if(IER==0)
							{
								RAZIM = Azimuth_Deg(latX,lonX,lat0,lon0);
								RDIST = Distance_km(latX,lonX,lat0,lon0);
								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(latX,lonX , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_SelX,20));
								//	GE84Heff(terrakey,eff_hgtmax,h10) ;
									GE84Heff(AntID,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( latX,lonX, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FaX,RDIST,dH, ctyX);
								Lp = GE89x.F_2B_1_2(FaX, P_location, dH, ctyX);
								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == _T("H"))				erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == _T("V"))		erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == _T("M"))		erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FaX>=300)&&(FaX<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
								}
							//	Et  = Et  + erpdbw - 30.0 + Lp;
								////////////////////////////////////
								HrI = atof(GetFld(m_Sel[Yi],5));
								Height_gain = 20.0*log10(HrI/10.0);
								Et  = Et  + erpdbw - 30.0 + Lp + Height_gain;
								////////////////////////////////////

								DeltaF = Ff - FvX;
								RPR =  GE89x.F_1(DeltaF,Fc,Fs);
								Elimit = -2.0 - RPR + g_dB;

						//		if (Et>Elimit)
								{
									k++;
									Rad2Str(Rlon0,Rlat0, &RLONbs,&RLATbs);
									strY1.Format("%s,%s,%s,%f,%0.2f,%s  %s,%0.6f,%0.0f",assignIDY,name1,ctyY,Ff,RPR,RLONbs,RLATbs,Et,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if Fixed_Band

					}// end for Yi

					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					strX.Format("%s,%s,%s,%f",assignIDX,nameX,ctyX,FaX);
					strY.Delete(0);
					CGE89_FXDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;	//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();
				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX
	EndWaitCursor();	
}

void CSMS4DCView::GE89site_name(long geo_key,CString *ctry, CString *site_name) 
{
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase m_mydb;
	if (m_mydb.Open(_T(m_DB),FALSE,TRUE, "ODBC;", FALSE))
	{
		CRecordset m_rs;
		CString	m_Tbl ;
		m_Tbl.Format("select * from fxm_geo WHERE (geo_key=%ld);",geo_key);
		m_rs.m_pDatabase = &m_mydb;
		m_rs.Open( CRecordset::snapshot, m_Tbl);

		CString ctry0, site_name0;
		m_rs.GetFieldValue("ctry",ctry0);
		m_rs.GetFieldValue("site_name",site_name0);
		m_rs.Close();

		*ctry = ctry0;
		*site_name = site_name0;
	}
	m_mydb.Close();
}

void CSMS4DCView::OnCoordinationGe89Lm() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=_T(" "))
	{
		CString assignIDX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);	ctyX.TrimRight();
		double FaX = atof(GetFld(m_SelX,14));
		double Hagl_ST = atof(GetFld(m_SelX,7));
		CString ant_dir = GetFld(m_SelX,12);			ant_dir.TrimRight();
		CString	fmtv_terra_polar = GetFld(m_SelX,8);	fmtv_terra_polar.TrimRight();
		long terrakey = atol(GetFld(m_SelX,1));
		double erp_dbw = atof(GetFld(m_SelX,9));
		double erp_h_dbw = atof(GetFld(m_SelX,10));
		double erp_v_dbw = atof(GetFld(m_SelX,11));
		long AntID = atol(GetFld(m_SelX,31));

		double attH0[37], attV0[37];
		if(ant_dir=="D")
			GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
		else
			for(int i=0;i<36;i++)
			{
				attH0[i] = 0;
				attV0[i] = 0;
			}
		attH0[36] = attH0[0];
		attV0[36] = attV0[0];

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 4000;
		rangeDLG.m_T = 10;

		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag;
			BOOL YOK = OnGE89FXMQyL(latX,lonX,FaX,Drange,Frange,"FB",&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString RLONbs , RLATbs;

					CString *m_Sel; m_Sel = new CString[Nrow];
					CString name1 , Zones[8] , Yst_cls, assignIDY,ctyY, strX,strY="",strY1="";

					int j , IER ;
					double Elimit , Fm , zDist[8] , Alpha_t,Frac, ELt, ESt;
					BOOL Mobile_Band;

					double lat0,lon0,h10[37], /*pi = 4.0*atan(1.0),*/ erpdbw,attnH,attnV;
					double RDIST, RAZIM, eff_hgtmax , h1 ,  g_dB , Lp , Et = -999.999 ;
					float Rlon0, Rlat0;

					double h2 , Height_gain;

					long k = 0;
					int az0[37];
					for(int i=0;i<36;i++)		az0[i] = 10*i;
					az0[36] = 360;

					CGE89_Functions GE89x;

					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%" + _Z(" complete") + " %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						name1 = GetFld(m_Sel[Yi],2);
						lat0 = atof(GetFld(m_Sel[Yi],3));
						lon0  = atof(GetFld(m_Sel[Yi],4));
						ctyY = LatLon2Ctry( lat0, lon0);

						Rlon0 = (float)(lon0*pi/180.0);
						Rlat0 = (float)(lat0*pi/180.0);

						Fm = atof(GetFld(m_Sel[Yi],21));
						Mobile_Band = GE89x.Mobile_Band(Fm,ctyY);

						if(Mobile_Band==TRUE)
						{
							assignIDY = GetFld(m_Sel[Yi],1);
							Yst_cls = GetFld(m_Sel[Yi],18);	Yst_cls.TrimRight();

							if     (Yst_cls==_T("FB"))	h2 = 1.5;
							else if(Yst_cls==_T("ML"))	h2 = 10.0;

							IER = 1;
							IER = GEZones(3,latX,lonX,lat0,lon0,zDist,Zones) ;
							if(IER==0)
							{
								RAZIM = Azimuth_Deg(latX,lonX,lat0,lon0);
								RDIST = Distance_km(latX,lonX,lat0,lon0);
								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(latX,lonX , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_SelX,20));
									GE84Heff(AntID,eff_hgtmax,h10) ;
								//	GE84Heff(terrakey,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( latX,lonX, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FaX,RDIST,dH, ctyX);
								Lp = GE89x.F_2B_1_2(FaX, P_location, dH, ctyX);
								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FaX>=300)&&(FaX<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
								}

								Height_gain = 20.0*log10(h2/10.0);

								Et  = Et  + erpdbw - 30.0 + Lp + Height_gain;
								Elimit = GE89x.Mobile_Elimit(Fm) + g_dB;

						//		if (Et>Elimit)
								{
									k++;
									Rad2Str(Rlon0,Rlat0, &RLONbs,&RLATbs);
									strY1.Format("%s,%s,%s,%f,%s,%s  %s,%0.6f,%0.0f",assignIDY,name1,ctyY,Fm,Yst_cls,RLONbs,RLATbs,Et,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if Fixed_Band

					}// end for Yi

					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					strX.Format("%s,%s,%s,%f",assignIDX,nameX,ctyX,FaX);
					strY.Delete(0);
					CGE89_FXDLG dlgList;

					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.m_title1 =  _Z("GE89 : Likely Affected Land Mobile Station(s)(BT-->LM)");
					dlgList.m_title2 =  _Z("Likely Affected Land Mobile Station(s) : ");
					dlgList.m_PR_CLS =  _T("stn_cls");
					dlgList.DoModal();

				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX

	EndWaitCursor();	
}

double CSMS4DCView::Emission2NBW(CString Emission) 
{
	double NBW_kHz = 0;
	CString c , BWs = Emission.Left(4);
	BWs.MakeUpper();

	for(int i=0;i<4;i++)
	{
		c = BWs.Mid(i,1);
		if(c=="H")
		{
			BWs.Replace('H','.');
			NBW_kHz = (0.001)*atof(BWs);
			return NBW_kHz;
		}
		else if(c=="K")
		{
			BWs.Replace('K','.');
			NBW_kHz = atof(BWs);
			return NBW_kHz;
		}
		else if(c=="M")
		{
			BWs.Replace('M','.');
			NBW_kHz = (1000.0)*atof(BWs);
			return NBW_kHz;
		}
		else if(c=="G")
		{
			BWs.Replace('G','.');
			NBW_kHz = (1000000.0)*atof(BWs);
			return NBW_kHz;
		}
	}
	return NBW_kHz;
}

void CSMS4DCView::DrawSymboleLink(CDC *pDC,double lat1,double lon1,double lat2,double lon2) 
{
	CPoint PointTx , PointRx;
	LatLon2Point(lat1,lon1,&PointTx); LatLon2Point(lat2,lon2,&PointRx); 

//	double pi = 4.0*atan(1.0);
	double a = (180.0/pi)*atan2(double(PointRx.y-PointTx.y),double(PointRx.x-PointTx.x));

//	CPen pen(PS_SOLID,1,m_SymbolColor);
//	pDC->SelectObject(&pen);

	pDC->MoveTo(PointTx);

	int scale = 1;
	if (pDC->IsPrinting())		scale = 5;

	ArrowTo(pDC, PointRx , 10*scale);
}

BOOL CSMS4DCView::DispLinkQ(long ID) 
{
	BOOL Q = FALSE;
	if(Num_Link>0)
	{
		for (int i=0;i<Num_Link;i++)
		{
			if(HopID[i] == ID)		Q = TRUE;
		}
	}
	return Q;
}
void CSMS4DCView::AddLink_disp(long ID,double lat1,double lon1,double lat2,double lon2) 
{
	if (Num_Link==0)
	{
		Num_Link = 1;

		HopID      = new long  [Num_Link];
		Lat_TxLink = new double[Num_Link];
		Lon_TxLink = new double[Num_Link];
		Lat_RxLink = new double[Num_Link];
		Lon_RxLink = new double[Num_Link];

		HopID[Num_Link-1]      = ID;
		Lat_TxLink[Num_Link-1] = lat1;
		Lon_TxLink[Num_Link-1] = lon1;
		Lat_RxLink[Num_Link-1] = lat2;
		Lon_RxLink[Num_Link-1] = lon2;
	}
	else
	{
		if(DispLinkQ(ID)==FALSE )
		{
			Num_Link = Num_Link + 1;

			long *HopID0        = new long  [Num_Link];
			double *Lat_TxLink0 = new double[Num_Link];
			double *Lon_TxLink0 = new double[Num_Link];
			double *Lat_RxLink0 = new double[Num_Link];
			double *Lon_RxLink0 = new double[Num_Link];

			for (int i=0;i<Num_Link-1;i++)
			{
				HopID0[i]      = HopID[i];
				Lat_TxLink0[i] = Lat_TxLink[i];
				Lon_TxLink0[i] = Lon_TxLink[i];
				Lat_RxLink0[i] = Lat_RxLink[i];
				Lon_RxLink0[i] = Lon_RxLink[i];
			}
			HopID0[Num_Link-1]      = ID;
			Lat_TxLink0[Num_Link-1] = lat1;
			Lon_TxLink0[Num_Link-1] = lon1;
			Lat_RxLink0[Num_Link-1] = lat2;
			Lon_RxLink0[Num_Link-1] = lon2;

			delete [] HopID;
			delete [] Lat_TxLink;	delete [] Lon_TxLink;
			delete [] Lat_RxLink;	delete [] Lon_RxLink;

			HopID      = new long  [Num_Link];
			Lat_TxLink = new double[Num_Link];
			Lon_TxLink = new double[Num_Link];
			Lat_RxLink = new double[Num_Link];
			Lon_RxLink = new double[Num_Link];

			for ( i=0;i<Num_Link;i++)
			{
				HopID[i] = HopID0[i];
				Lat_TxLink[i] = Lat_TxLink0[i];
				Lon_TxLink[i] = Lon_TxLink0[i];
				Lat_RxLink[i] = Lat_RxLink0[i];
				Lon_RxLink[i] = Lon_RxLink0[i];
			}
			delete [] HopID0;
			delete [] Lat_TxLink0;	delete [] Lon_TxLink0;
			delete [] Lat_RxLink0;	delete [] Lon_RxLink0;
		}
	}
	InvalidateRect(NULL,false);
}

void CSMS4DCView::ArrowTo(CDC* pDC, CPoint lpTo , int nWidth,float fTheta,bool bFill)
{
	HDC hDC=pDC->m_hDC;

	POINT pFrom, pBase, aptPoly[3];
	float vecLine[2], vecLeft[2], fLength, th, ta;

	MoveToEx(hDC, 0, 0, &pFrom);

	aptPoly[0].x = lpTo.x;
	aptPoly[0].y = lpTo.y;

	vecLine[0] = (float) aptPoly[0].x - pFrom.x;
	vecLine[1] = (float) aptPoly[0].y - pFrom.y;

	vecLeft[0] = -vecLine[1];
	vecLeft[1] = vecLine[0];

	fLength = (float) sqrt(vecLine[0] * vecLine[0] + vecLine[1] * vecLine[1]);
	th = nWidth / (2.0f * fLength);
	ta = nWidth / (2.0f * (tanf(fTheta) / 2.0f) * fLength);

	pBase.x = (int) (aptPoly[0].x + -ta * vecLine[0]);
	pBase.y = (int) (aptPoly[0].y + -ta * vecLine[1]);

	aptPoly[1].x = (int) (pBase.x + th * vecLeft[0]);
	aptPoly[1].y = (int) (pBase.y + th * vecLeft[1]);
	aptPoly[2].x = (int) (pBase.x + -th * vecLeft[0]);
	aptPoly[2].y = (int) (pBase.y + -th * vecLeft[1]);

	MoveToEx(hDC, pFrom.x, pFrom.y, NULL);

	if(bFill)
	{
		LineTo(hDC, aptPoly[0].x, aptPoly[0].y);
		Polygon(hDC, aptPoly, 3);
	}
	else
	{
		LineTo(hDC, pBase.x, pBase.y);
		LineTo(hDC, aptPoly[1].x, aptPoly[1].y);
		LineTo(hDC, aptPoly[0].x, aptPoly[0].y);
		LineTo(hDC, aptPoly[2].x, aptPoly[2].y);
		LineTo(hDC, pBase.x, pBase.y);
		MoveToEx(hDC, aptPoly[0].x, aptPoly[0].y, NULL);
	}
}

CString CSMS4DCView::OnFX2FXQx() 
{
	BeginWaitCursor();
	CString SelX = _T(" ");
	CString CDataBaseSTR;	CDataBaseSTR.Format( _T("select * from %s ;") , m_qQ_Links );
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("Wanted Hop");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
			SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

BOOL CSMS4DCView::OnFX2FXQy(long HopID, long TxID, double latX, double lonX, double frqX, double Drange, double Frange, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);
	double fmin = frqX - Frange/1000.0,		fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
if(lonmin<=lonmax)	CDataBaseSTR.Format(_T("select * from %s where (((RxLat)>=%lf And (RxLat)<=%lf) AND ((RxLon)>=%lf And (RxLon)<=%lf) AND ((TxFrq)>=%lf AND (TxFrq)<=%lf) AND (RxID)<>%ld AND (HopID)<>%ld);"), m_qQ_Links , latmin,latmax,lonmin,lonmax,fmin,fmax,TxID,HopID);
else				CDataBaseSTR.Format(_T("select * from %s where (((RxLat)>=%lf And (RxLat)<=%lf) AND ( (RxLon>=%lf And RxLon<=180) or (RxLon>=-180 And RxLon<=%lf) ) AND ((TxFrq)>=%lf AND (TxFrq)<=%lf) AND (RxID)<>%ld AND (HopID)<>%ld);"), m_qQ_Links , latmin,latmax,lonmin,lonmax,fmin,fmax,TxID,HopID);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _Z("Found Hop(s)");
	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

__declspec(dllimport) int BasicTxLossP452V15(double* mD, double* mH, CString *mZ, long Np, double LongM, double LatM, CString FilepathData,
											double mtime, int timeflag, double f, double htg, double hrg, double Gt, double Gr, 
											double pressure, double temp_C, CString POL, double ha_Clutter, double dk_Clutter, 
											double *loss);

void CSMS4DCView::OnInterferenceFx2fx() 
{
	BeginWaitCursor();
	CString m_SelX = OnFX2FXQx();

	if(m_SelX != _T(" "))
	{
		long HopID = atol(GetFld(m_SelX,1)), TxIDW = atol(GetFld(m_SelX,2));
		CString TxNameW  = GetFld(m_SelX,3);
		double TxLatW  = atof(GetFld(m_SelX,4)),  TxLonW  = atof(GetFld(m_SelX,5)),  TxFreqW = atof(GetFld(m_SelX,6));
		CString RxNameW = GetFld(m_SelX,16);
		double RxLatW  = atof(GetFld(m_SelX,17)), RxLonW  = atof(GetFld(m_SelX,18)), TxPwr_WW  = atof(GetFld(m_SelX,28));

		CInt_FX2FXparDLG rangeDLG;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			BOOL hef_flag;
			BOOL YOK = OnFX2FXQy(HopID,TxIDW,TxLatW,TxLonW,TxFreqW,Drange,Frange,&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];
					double RxLatI, RxLonI;

					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int path_type;
					double Hagl_Tx = atof(GetFld(m_SelX,8));
					double Gt = atof(GetFld(m_SelX,9));
					double RxSen , SdBm , InsLoss , Gr, Hagl_Rx , xps,yps,xpm,ypm , hi;
					double TxLatI , TxLonI , Linkk , TotalLoss , FsLoss , Dist /*, pi=4.0*atan(1.0)*/;
					CString tit , RLONbs, RLATbs, RLONbsR, RLATbsR;
					CString RxNameI , TxNameI , strX,strY="",strY1="";
/*
					int PN452_SUCCESS   = 0, PN452_PATH      = -1,	PN452_PROF      = -2, PN452_FREQ   = -3, PN452_ANT_HTS = -6;
					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1,	PN452_TRANS_HOZ = 2,  PN452_ERROR  = 3;
*/
					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;
								
					////////////////////////////////////////////////////
					double HtW = atof(GetFld(m_SelX,8));
					double HrW = atof(GetFld(m_SelX,21));
					CString RxPol , TxPol = GetFld(m_SelX,14);
					TxPol.TrimRight();		TxPol = TxPol.Left(1);		TxPol.MakeUpper();

//					double k50 = (157.0 / (157.0 - dN));
//					double ke = CP452.do_k_diff(tp,k50,beta);
//					double re = ke*6371000;

					double el , HtI, HrI , fpi,tpi,fi,ti,GhvTx,GhvRx , AZ0tW , EL0tW,AZ0rI, EL0rI , Rc , RxXPDI;

					long RxAntID , TxAntID = atol(GetFld(m_SelX,12));

					CString antfile , ANT_Rx , ANT_Tx = AntID2AntName(TxAntID) ;
					antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
					int Txf0[360] , Rxf0[360];
					double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];

					ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;
//					EL0tW = AZ_EL(TxLatW, TxLonW, RxLatW, RxLonW, HtW, HrW, re, &AZ0tW) ;
					////////////////////////////////////////////////////
					long RxIDI;
					double RxFreqI,TxFreqI,NFD;
					CPoint pointst[2];

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					int progress_num=0;
					CString progress_str, progress_char = _T("I");
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						TxNameI = GetFld(m_Sel[Yi],3);  TxLatI = atof(GetFld(m_Sel[Yi],4));  TxLonI = atof(GetFld(m_Sel[Yi],5));
						RxNameI = GetFld(m_Sel[Yi],16);	RxLatI = atof(GetFld(m_Sel[Yi],17)); RxLonI = atof(GetFld(m_Sel[Yi],18));
					
						Hagl_Rx = atof(GetFld(m_Sel[Yi],21));
						Gr = atof(GetFld(m_Sel[Yi],22));
						InsLoss = atof(GetFld(m_Sel[Yi],29));
/*
						//////////////////////////////////////// Antenna Effect ////////////////////////////////////////
						HtI = atof(GetFld(m_Sel[Yi],8));
						HrI = Hagl_Rx;
						RxAntID = atol(GetFld(m_Sel[Yi],25));

						RxXPDI  = atof(GetFld(m_Sel[Yi],26));
						RxPol = GetFld(m_Sel[Yi],27);
						RxPol.TrimRight();		RxPol = RxPol.Left(1);		RxPol.MakeUpper();

						el = AZ_EL(TxLatW, TxLonW, RxLatI, RxLonI, HtW, HrI, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0tW),(cos(EL0tW)*sin(tpi)*cos(fpi-AZ0tW)+cos(tpi)*sin(EL0tW)));
						ti = R2D*acos(cos(tpi)*cos(EL0tW)-sin(EL0tW)*sin(tpi)*cos(fpi-AZ0tW));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

						ANT_Rx = AntID2AntName(RxAntID) ;
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;

						EL0rI = AZ_EL(RxLatI, RxLonI, TxLatI, TxLonI, HrI, HtI, re, &AZ0rI) ;
						el = AZ_EL(RxLatI, RxLonI, TxLatW, TxLonW, HrI, HtW, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0rI),(cos(EL0rI)*sin(tpi)*cos(fpi-AZ0rI)+cos(tpi)*sin(EL0rI)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0rI)-sin(EL0rI)*sin(tpi)*cos(fpi-AZ0rI));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);

						if(((TxPol=="V")&&(RxPol=="V"))||((TxPol=="H")&&(RxPol=="H")))	Rc = 10.0*log10(1.0 + pow(10.0 , -abs(RxXPDI)/10.0));
						else															Rc = 3.0 - RxXPDI;
						Rc = Rc + 10.0*log10(GhvTx) + 10.0*log10(GhvRx);
						/////////////////////////////////////////////////////////////////////////////////////
*/
						RxSen = atof(GetFld(m_Sel[Yi],24));

						double latmin = min(TxLatW,RxLatI);
						double lonmin = min(TxLonW,RxLonI);
						OnDatabaseStationsindesktop2(latmin, lonmin);

						LatLon2Point(TxLatW,TxLonW,&pointst[0]);
						LatLon2Point(RxLatI,RxLonI,&pointst[1]);

						x1=pointst[0].x;	y1=pointst[0].y;
						x2=pointst[1].x;	y2=pointst[1].y;
						xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
						ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

						Np =((xabs>=yabs) ? xabs+1 : yabs+1);
						Np = (Np-1) * m_scalfactor + 1;

						double *X;		X=new double[Np];
						double *Y;		Y=new double[Np];

						if (xabs>=yabs)
						{
							for (int i=0;i<Np;i++)
							{
								X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
								Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
							}
						}
						else
						{
							for (int i=0;i<Np;i++)
							{
								Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
								X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
							}
						}
						double *di;			di=new double[Np];
						double *x_en;		x_en=new double[Np];
						double *y_en;		y_en=new double[Np];
						double *hikm;		hikm=new double[Np];
//						int *zi;			zi = new int[Np];
						CString *zi;		zi = new CString[Np+1];

						for (int i=0;i<Np;i++)
						{
							xps = X[i];
							yps = 1200.0-1.0-(Y[i]);

							xpm = xps + 600.0*((double)(pDoc->TileX-1));
							ypm = yps + 600.0*((double)(pDoc->TileY-1));

							x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
							y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
							y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
							x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

							if (pDoc->TileInfo != globeTileInfo)
							{
								CUtm m_utm;
								m_utm.y = y_en[i];
								m_utm.x = x_en[i];
								m_utm.UTM2philambda();
								y_en[i]=m_utm.phi;
								x_en[i]=m_utm.lambda;
							}
							hi = RoundBUF_Hg(xps, yps);
				//			hikm[i] = hi/1000.0;
							hikm[i] = hi;
							di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
							zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
						}
						Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(TxLonW, TxLatW, TxLonI, TxLatI, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, TxFreqW/1000.0, Hagl_Tx, Hagl_Rx, Gt,Gr, 
				Pressure, TempC, TxPol, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * TxFreqW/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
	EL0tW = AZ_EL(TxLatW, TxLonW, RxLatW, RxLonW, HtW, HrW, re, &AZ0tW) ;

						//////////////////////////////////////// Antenna Effect ////////////////////////////////////////
						HtI = atof(GetFld(m_Sel[Yi],8));
						HrI = Hagl_Rx;
						RxAntID = atol(GetFld(m_Sel[Yi],25));

						RxXPDI  = atof(GetFld(m_Sel[Yi],26));
						RxPol = GetFld(m_Sel[Yi],27);
						RxPol.TrimRight();		RxPol = RxPol.Left(1);		RxPol.MakeUpper();

						el = AZ_EL(TxLatW, TxLonW, RxLatI, RxLonI, HtW, HrI, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0tW),(cos(EL0tW)*sin(tpi)*cos(fpi-AZ0tW)+cos(tpi)*sin(EL0tW)));
						ti = R2D*acos(cos(tpi)*cos(EL0tW)-sin(EL0tW)*sin(tpi)*cos(fpi-AZ0tW));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

						ANT_Rx = AntID2AntName(RxAntID) ;
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;

						EL0rI = AZ_EL(RxLatI, RxLonI, TxLatI, TxLonI, HrI, HtI, re, &AZ0rI) ;
						el = AZ_EL(RxLatI, RxLonI, TxLatW, TxLonW, HrI, HtW, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0rI),(cos(EL0rI)*sin(tpi)*cos(fpi-AZ0rI)+cos(tpi)*sin(EL0rI)));
						ti = R2D*acos(cos(tpi)*cos(EL0rI)-sin(EL0rI)*sin(tpi)*cos(fpi-AZ0rI));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);

						if(((TxPol=="V")&&(RxPol=="V"))||((TxPol=="H")&&(RxPol=="H")))	Rc = 10.0*log10(1.0 + pow(10.0 , -abs(RxXPDI)/10.0));
						else															Rc = 3.0 - RxXPDI;
						Rc = Rc + 10.0*log10(GhvTx) + 10.0*log10(GhvRx);
						/////////////////////////////////////////////////////////////////////////////////////
/*
						val_p = 0;
						status = CP452.pn452_Lb(di,hikm,zi,Np,TxFreqW/1000.0,tp,N0,dN,beta,
												Gt,Gr,Hagl_Tx/1000.0,Hagl_Rx/1000.0,
												&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
												&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

						if(status == PN452_SUCCESS)
						{
							Linkk = o_k_e;
							path_type = o_path_type;
							TotalLoss = val_p;

							if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
							else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
							else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
						}
						else
						{
							Linkk = (157.0 / (157.0 - (dN)));
							FsLoss = 92.45 + (20.0 * log10 (Dist * TxFreqW/1000.0));
							TotalLoss = FsLoss;
							tit = _Z("Free Space");
						}
*/
						delete [] X;	delete [] Y;	delete [] hikm;	delete [] di;	delete [] x_en;	delete [] y_en;	delete [] zi;

		//				RxIDI = atof(GetFld(m_Sel[Yi],14));
		//				RxFreqI = atof(GetFld(m_Sel[Yi],18));
						RxIDI = atof(GetFld(m_Sel[Yi],15));
						RxFreqI = atof(GetFld(m_Sel[Yi],19));
						TxFreqI = atof(GetFld(m_Sel[Yi],6));

						NFD = NFDfixed_Loss(TxIDW,TxNameW,TxFreqW,RxIDI,RxNameI,TxFreqI) ;

						SdBm = 30.0 + 10.0*log10(TxPwr_WW) - TotalLoss + Gr - InsLoss + Rc - NFD;
						RxSen = 30.0 - 120.0 + 20.0*log10(RxSen) - 10.0*log10(50.0);	//dBm

						Rad2Str(RxLonI*pi/180.0,RxLatI*pi/180.0, &RLONbs,&RLATbs);
						Rad2Str(TxLonI*pi/180.0,TxLatI*pi/180.0, &RLONbsR,&RLATbsR);
						strY1.Format("%s,%s  %s,%s,%s  %s,%0.0f,%0.2f,%0.2f,%0.2f,%0.2f,%s",TxNameI,RLONbsR,RLATbsR,RxNameI,RLONbs,RLATbs,Dist,TotalLoss,SdBm-RxSen,SdBm,RxSen,tit);
						strY = strY+","+strY1;

///////////////////////////////////////////////////////////////////////////////////////////////
					}// end for Yi
					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					Rad2Str(TxLonW*pi/180.0,TxLatW*pi/180.0, &RLONbs,&RLATbs);
					Rad2Str(RxLonW*pi/180.0,RxLatW*pi/180.0, &RLONbsR,&RLATbsR);
					strX.Format("%s,%s  %s,%s,%s  %s,%0.4f",TxNameW,RLONbs,RLATbs,RxNameW,RLONbsR,RLATbsR,TxFreqW);
					strY.Delete(0);
				
					CInt_FX2FXDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();

				}//Nrow
			}//YOK
		}//rangeDLG
	}//m_SelX
}

double CSMS4DCView::AZ_EL(double latT , double lonT , double latR , double lonR, double HtAGL, double HrAGL, double re, double *AZrad) 
{
//	double pi=4.0*atan(1.0);
	*AZrad = D2R*Azimuth_Deg(latT , lonT , latR , lonR);
	double DIST = Distance_km(latT , lonT , latR , lonR);

	OnDatabaseStationsindesktop2(latT , lonT);
	double Ht = HtAGL + LatLon2Hg(latT , lonT);

	OnDatabaseStationsindesktop2(latR , lonR);
	double Hr = HrAGL + LatLon2Hg(latR , lonR);

	double ELrad = atan(((re+Hr)*cos(1000.0*DIST/re)-(re+Ht))/((re+Hr)*sin(1000.0*DIST/re)));
	return ELrad;
}

BOOL CSMS4DCView::OnFX2FXQyi(long HopID, long RxID, double latX, double lonX, double frqX, double Drange, double Frange, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;		*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);
	double fmin = frqX - Frange/1000.0,		fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
if(lonmin<=lonmax)	CDataBaseSTR.Format(_T("select * from %s  where (((TxLat)>=%lf And (TxLat)<=%lf) AND ((TxLon)>=%lf And (TxLon)<=%lf) AND ((TxFrq)>=%lf AND (TxFrq)<=%lf) AND (TxID)<>%ld AND (HopID)<>%ld);"),m_qQ_Links,latmin,latmax,lonmin,lonmax,fmin,fmax,RxID,HopID);
else				CDataBaseSTR.Format(_T("select * from %s  where (((TxLat)>=%lf And (TxLat)<=%lf) AND ( (TxLon>=%lf And TxLon<=180) or (TxLon>=-180 And TxLon<=%lf) ) AND ((TxFrq)>=%lf AND (TxFrq)<=%lf) AND (TxID)<>%ld AND (HopID)<>%ld);"),m_qQ_Links,latmin,latmax,lonmin,lonmax,fmin,fmax,RxID,HopID);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _Z("Found Hop(s)");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnInterferenceFx2fxi() 
{
	BeginWaitCursor();
	CString m_SelX = OnFX2FXQx();

	if(m_SelX != _T(" "))
	{
		long HopID = atol(GetFld(m_SelX,1));

		CString TxNameW  = GetFld(m_SelX,3);
		double TxLatW  = atof(GetFld(m_SelX,4)), TxLonW  = atof(GetFld(m_SelX,5)), TxFreqW = atof(GetFld(m_SelX,6));

		long RxIDW = atol(GetFld(m_SelX,15));
		CString RxNameW = GetFld(m_SelX,16);
		double RxLatW  = atof(GetFld(m_SelX,17)), RxLonW  = atof(GetFld(m_SelX,18)), RxFreqW = atof(GetFld(m_SelX,19));

		CInt_FX2FXparDLG rangeDLG;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			BOOL hef_flag;
	//		BOOL YOK = OnFX2FXQyi(HopID,RxIDW,RxLatW,RxLonW,RxFreqW,Drange,Frange,&hef_flag);
			BOOL YOK = OnFX2FXQyi(HopID,RxIDW,RxLatW,RxLonW,TxFreqW,Drange,Frange,&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];
					double RxLatI, RxLonI;

					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int  path_type;
					double RxSen , SdBm , InsLoss , Gr, Hagl_Rx , xps,yps,xpm,ypm , hi;
					double TxLatI , TxLonI , Linkk , TotalLoss , FsLoss , Dist /*, pi=4.0*atan(1.0)*/;
					CString tit , RLONbs, RLATbs, RLONbsR, RLATbsR;
					CString RxNameI , TxNameI , strX,strY="",strY1="";

					Hagl_Rx = atof(GetFld(m_SelX,21));
					Gr = atof(GetFld(m_SelX,22));

					InsLoss = atof(GetFld(m_SelX,29));
					RxSen = atof(GetFld(m_SelX, 24));
					RxSen = 30.0 - 120.0 + 20.0*log10(RxSen) - 10.0*log10(50.0);	//dBm

					double TxFreqI , TxPwr_WI , Hagl_Tx , Gt , Vus = 0;
/*
					int PN452_SUCCESS   = 0, PN452_PATH      = -1,	PN452_PROF      = -2, PN452_FREQ   = -3, PN452_ANT_HTS = -6;
					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1,	PN452_TRANS_HOZ = 2,  PN452_ERROR  = 3;
*/
					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;
							
					////////////////////////////////////////////////////
					double HtW = atof(GetFld(m_SelX,8));
					double HrW = atof(GetFld(m_SelX,21));
					CString TxPol , RxPol = GetFld(m_SelX,27);
					RxPol.TrimRight();		RxPol = RxPol.Left(1);		RxPol.MakeUpper();

//					double k50 = (157.0 / (157.0 - dN));
//					double ke = CP452.do_k_diff(tp,k50,beta);
//					double re = ke*6371000;

					double el , HtI, HrI , fpi,tpi,fi,ti,GhvTx,GhvRx , AZ0rW , EL0rW,AZ0tI, EL0tI , Rc , RxXPDI;

					long TxAntID , RxAntID = atol(GetFld(m_SelX,25));

					CString antfile , ANT_Tx , ANT_Rx = AntID2AntName(RxAntID) ;
					antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
					int Txf0[360] , Rxf0[360];
					double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];

					ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
//					EL0rW = AZ_EL( RxLatW, RxLonW, TxLatW, TxLonW, HrW, HtW, re, &AZ0rW) ;

					RxXPDI  = atof(GetFld(m_SelX,26));
					////////////////////////////////////////////////////
					long	TxIDI;
					double	NFD;
					CPoint pointst[2];
												
					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					int progress_num=0;
					CString progress_str, progress_char = _T("I");
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						TxNameI  = GetFld(m_Sel[Yi],3);
						TxLatI  = atof(GetFld(m_Sel[Yi],4));
						TxLonI  = atof(GetFld(m_Sel[Yi],5));

						RxNameI = GetFld(m_Sel[Yi],16);
						RxLatI  = atof(GetFld(m_Sel[Yi],17));
						RxLonI  = atof(GetFld(m_Sel[Yi],18));

						Hagl_Tx = atof(GetFld(m_Sel[Yi],8));
						Gt = atof(GetFld(m_Sel[Yi],9));

						TxFreqI = atof(GetFld(m_Sel[Yi],6));
						TxPwr_WI  = atof(GetFld(m_Sel[Yi],28));

						double latmin = min(TxLatI,RxLatW);
						double lonmin = min(TxLonI,RxLonW);
						OnDatabaseStationsindesktop2(latmin, lonmin);
			
						LatLon2Point(RxLatW,RxLonW,&pointst[1]);
						LatLon2Point(TxLatI,TxLonI,&pointst[0]);

						TxPol = GetFld(m_Sel[Yi],14);
						TxPol.TrimRight();		TxPol = TxPol.Left(1);		TxPol.MakeUpper();
/*
						//////////////////////////////////////// Antenna Effect ////////////////////////////////////////
						HtI = Hagl_Tx;
						HrI = atof(GetFld(m_Sel[Yi],21));
						TxAntID = atol(GetFld(m_Sel[Yi],12));

						el = AZ_EL(RxLatW, RxLonW, TxLatI, TxLonI, HrW, HtI, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0rW),(cos(EL0rW)*sin(tpi)*cos(fpi-AZ0rW)+cos(tpi)*sin(EL0rW)));
						ti = R2D*acos(cos(tpi)*cos(EL0rW)-sin(EL0rW)*sin(tpi)*cos(fpi-AZ0rW));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);

						ANT_Tx = AntID2AntName(TxAntID) ;
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
						ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

						EL0tI = AZ_EL(TxLatI, TxLonI, RxLatI, RxLonI, HtI, HrI, re, &AZ0tI) ;
						el = AZ_EL(TxLatI, TxLonI, RxLatW, RxLonW, HtI, HrW, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0tI),(cos(EL0tI)*sin(tpi)*cos(fpi-AZ0tI)+cos(tpi)*sin(EL0tI)));
						ti = R2D*acos(cos(tpi)*cos(EL0tI)-sin(EL0tI)*sin(tpi)*cos(fpi-AZ0tI));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

						if(((TxPol=="V")&&(RxPol=="V"))||((TxPol=="H")&&(RxPol=="H")))	Rc = 10.0*log10(1.0 + pow(10.0 , -abs(RxXPDI)/10.0));
						else															Rc = 3.0 - RxXPDI;
						Rc = Rc + 10.0*log10(GhvTx) + 10.0*log10(GhvRx);
						/////////////////////////////////////////////////////////////////////////////////////
*/
						x1=pointst[0].x;	y1=pointst[0].y;
						x2=pointst[1].x;	y2=pointst[1].y;
						xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
						ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

						Np =((xabs>=yabs) ? xabs+1 : yabs+1);
						Np = (Np-1) * m_scalfactor + 1;

						double *X;		X=new double[Np];
						double *Y;		Y=new double[Np];

						if (xabs>=yabs)
						{
							for (int i=0;i<Np;i++)
							{
								X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
								Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
							}
						}
						else
						{
							for (int i=0;i<Np;i++)
							{
								Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
								X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
							}
						}
						double *di;			di=new double[Np];
						double *x_en;		x_en=new double[Np];
						double *y_en;		y_en=new double[Np];
						double *hikm;		hikm=new double[Np];
//						int *zi;			zi = new int[Np];
						CString *zi;		zi = new CString[Np+1];

						for (int i=0;i<Np;i++)
						{
							xps = X[i];
							yps = 1200.0-1.0-(Y[i]);
							xpm = xps + 600.0*((double)(pDoc->TileX-1));
							ypm = yps + 600.0*((double)(pDoc->TileY-1));

							x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
							y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
							y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
							x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

							if (pDoc->TileInfo != globeTileInfo)
							{
								CUtm m_utm;
								m_utm.y = y_en[i];
								m_utm.x = x_en[i];
								m_utm.UTM2philambda();
								y_en[i]=m_utm.phi;
								x_en[i]=m_utm.lambda;
							}
							hi = RoundBUF_Hg(xps, yps);
//							hikm[i] = hi/1000.0;
							hikm[i] = hi;
							di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
							zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
						}
						Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(TxLonW, TxLatW, TxLonI, TxLatI, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, TxFreqI/1000.0, Hagl_Tx, Hagl_Rx, Gt,Gr, 
				Pressure, TempC, TxPol, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * TxFreqI/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
	EL0rW = AZ_EL( RxLatW, RxLonW, TxLatW, TxLonW, HrW, HtW, re, &AZ0rW) ;

						//////////////////////////////////////// Antenna Effect ////////////////////////////////////////
						HtI = Hagl_Tx;
						HrI = atof(GetFld(m_Sel[Yi],21));
						TxAntID = atol(GetFld(m_Sel[Yi],12));

						el = AZ_EL(RxLatW, RxLonW, TxLatI, TxLonI, HrW, HtI, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0rW),(cos(EL0rW)*sin(tpi)*cos(fpi-AZ0rW)+cos(tpi)*sin(EL0rW)));
						ti = R2D*acos(cos(tpi)*cos(EL0rW)-sin(EL0rW)*sin(tpi)*cos(fpi-AZ0rW));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);

						ANT_Tx = AntID2AntName(TxAntID) ;
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
						ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

						EL0tI = AZ_EL(TxLatI, TxLonI, RxLatI, RxLonI, HtI, HrI, re, &AZ0tI) ;
						el = AZ_EL(TxLatI, TxLonI, RxLatW, RxLonW, HtI, HrW, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0tI),(cos(EL0tI)*sin(tpi)*cos(fpi-AZ0tI)+cos(tpi)*sin(EL0tI)));
						ti = R2D*acos(cos(tpi)*cos(EL0tI)-sin(EL0tI)*sin(tpi)*cos(fpi-AZ0tI));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

						if(((TxPol=="V")&&(RxPol=="V"))||((TxPol=="H")&&(RxPol=="H")))	Rc = 10.0*log10(1.0 + pow(10.0 , -abs(RxXPDI)/10.0));
						else															Rc = 3.0 - RxXPDI;
						Rc = Rc + 10.0*log10(GhvTx) + 10.0*log10(GhvRx);
						/////////////////////////////////////////////////////////////////////////////////////
/*
						val_p = 0;
						status = CP452.pn452_Lb(di,hikm,zi,Np,TxFreqI/1000.0,tp,N0,dN,beta,
												Gt,Gr,Hagl_Tx/1000.0,Hagl_Rx/1000.0,
												&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
												&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

						if(status == PN452_SUCCESS)
						{
							Linkk = o_k_e;
							path_type = o_path_type;
							TotalLoss = val_p;

							if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
							else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
							else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
						}
						else
						{
							Linkk = (157.0 / (157.0 - (dN)));
							FsLoss = 92.45 + (20.0 * log10 (Dist * TxFreqI/1000.0));
							TotalLoss = FsLoss;
							tit = _Z("Free Space");
						}
*/
						delete [] X;	delete [] Y;	delete [] hikm;	delete [] di;	delete [] x_en;	delete [] y_en;	delete [] zi;

						TxIDI = atof(GetFld(m_Sel[Yi],2));
			//			NFD = NFDfixed_Loss(TxIDI,TxNameI,TxFreqI,RxIDW,RxNameW,RxFreqW) ;
						NFD = NFDfixed_Loss(TxIDI,TxNameI,TxFreqI,RxIDW,RxNameW,TxFreqW) ;

						SdBm = 30.0 + 10.0*log10(TxPwr_WI) - TotalLoss + Gr - InsLoss + Rc - NFD;

						Vus = Vus + pow(10.0,(SdBm-30.0)/5.0);	//W

						Rad2Str(RxLonI*pi/180.0,RxLatI*pi/180.0, &RLONbs,&RLATbs);
						Rad2Str(TxLonI*pi/180.0,TxLatI*pi/180.0, &RLONbsR,&RLATbsR);
						strY1.Format("%s,%s  %s,%s,%s  %s,%0.0f,%0.2f,%0.2f,%0.2f,%0.4f,%s",TxNameI,RLONbsR,RLATbsR,RxNameI,RLONbs,RLATbs,Dist,TotalLoss,SdBm-RxSen,SdBm,TxFreqI,tit);
						strY = strY+","+strY1;

					}// end for Yi
					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					Vus = sqrt(Vus);	//V
					Vus = 30.0 + 10.0*log10(Vus) ;	//dBm

					Rad2Str(TxLonW*pi/180.0,TxLatW*pi/180.0, &RLONbs,&RLATbs);
					Rad2Str(RxLonW*pi/180.0,RxLatW*pi/180.0, &RLONbsR,&RLATbsR);
					strX.Format("%s,%s  %s,%s,%s  %s,%0.2f,%0.2f,%0.2f",TxNameW,RLONbs,RLATbs,RxNameW,RLONbsR,RLATbsR,Vus,RxSen,Vus-RxSen);
					strY.Delete(0);
				
					CInt_FX2FXIDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();

				}//Nrow
			}//YOK
		}//rangeDLG
	}//m_SelX	
}

int CSMS4DCView::LandSeaCoastal(double RLON_deg,double RLAT_deg) 
{
//	double pi=4.0*atan(1.0);
	float RLON = (float)(RLON_deg*pi/180.0);
	float RLAT = (float)(RLAT_deg*pi/180.0);

	long int N=4, IER;
	GEOGCMS ( &N, &IER );

	float RLON1 = (float)(RLON-pi/90.0), RLAT1 = (float)(RLAT-pi/90.0),
		  RLON2 = (float)(RLON+pi/90.0), RLAT2 = (float)(RLAT+pi/90.0);

	long IVAL = 2 , IRANGE = 1500,  NRPNT = 2;
	float  ARRAY[2][2]={RLON1, RLAT1, RLON2, RLAT2},  WND[2][2],  GC;
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOGCM( &IVAL, (float *)WND, &IRANGE);
	GEOGCP( &RLON, &RLAT, &GC);

	int zone = 3;
	if		(GC==1)		zone = 1;	//LandSea = "Coastal Zone : Sea";
	else if (GC==3)		zone = 2;	//LandSea = "Coastal Zone : Coastal Land";
	else if (GC==4)		zone = 3;	//LandSea = "Coastal Zone : InLand";

	return zone;
}

void CSMS4DCView::OnDatabaseLinks() 
{
//	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from Q_Links;");
	CString CDataBaseSTR;	CDataBaseSTR.Format( _T("select * from %s ;") , m_qQ_Links);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG dbdlg;
	dbdlg.m_Title = _T("Link Table");
	if ((dbdlg.DoModal()) == IDOK)
	{
		CString Sel;
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			long TxID , RxID, HID;
			double TxLat, TxLon, RxLat, RxLon;
			CString TxName, RxName;

			for (int i=0;i<Nrow;i++)
			{
				Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				if (Sel!=_T(""))
				{
					HID = atol(GetFld(Sel,1));

					TxID = atol(GetFld(Sel,2));
					TxName = GetFld(Sel,3);
					TxLat  = atof(GetFld(Sel,4));	TxLon  = atof(GetFld(Sel,5));

					RxID = atol(GetFld(Sel,15));
					RxName = GetFld(Sel,16);
					RxLat  = atof(GetFld(Sel,17));	RxLon  = atof(GetFld(Sel,18));

					AddStation_disp(TxID,TxLat,TxLon,TxName) ;
					AddStation_disp(RxID,RxLat,RxLon,RxName) ;
					AddLink_disp(HID,TxLat,TxLon,RxLat,RxLon) ;

					OnDatabaseStationsindesktop2(min(TxLat,RxLat),min(TxLon,RxLon));
				}
			}
			InvalidateRect(NULL,false);
		}
	}
	Set_STtable_Default();
}

CString CSMS4DCView::AntID2AntName(long ID) 
{
	CDatabase DB;
	CRecordset m_rs;
	CString m_Tbl,Fld;
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB.Open(_T(m_DB),false,false,_T("ODBC;"),false);

//	m_Tbl.Format("SELECT AntName FROM AntCat WHERE (((AntCatID)=%ld));",ID);
	m_Tbl.Format("SELECT AntName FROM AntCat,antenna WHERE antenna.antcatid=antcat.antcatid and (((AntID)=%ld));",ID);

	m_rs.m_pDatabase = &DB;
	m_rs.Open(CRecordset::snapshot, m_Tbl);

	if(m_rs.GetRecordCount() == 1)
		m_rs.GetFieldValue("AntName",Fld);
	else
	{
		CString str;
		str.Format("The Antenna ID  [%ld]  was not found!  \r\rThe Isotropic Antenna will be select.",ID);
		MessageBox(str, "Warning", MB_ICONWARNING | MB_OK);
		Fld = _T("DEFAULT");
	}
	m_rs.Close();
	DB.Close();
	return Fld;
}

CString CSMS4DCView::OnFXM2BTQx(BOOL *hef_flag) 
{
	BeginWaitCursor();
	*hef_flag = FALSE;

	CString SelX = _T(" ");
///	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from STtable WHERE (((STTP)=\'FX\' Or (STTP)=\'FB\'));");
///	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtable WHERE ((((TXfreq)>=47 And (TXfreq)<=68) Or ((TXfreq)>=230 And (TXfreq)<=238) Or ((TXfreq)>=246 And (TXfreq)<=254)) AND ((STTP)='FX' Or (STTP)='FB' Or (STTP)='ML'));");
//	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtableGE89 WHERE ((((TXfreq)>=47 And (TXfreq)<=68) Or ((TXfreq)>=230 And (TXfreq)<=238) Or ((TXfreq)>=246 And (TXfreq)<=254)) AND ((STTP)='FX' Or (STTP)='FB' Or (STTP)='ML'));");

	CString str1 = _T(" [ SELECT Frequency.freqid AS IDst, SiteName AS STname, Geolat AS STlat_deg, Geolon AS STlon_deg, AntHeightAGL AS Sth_agl, frequency/1000000 AS TXfreq, iif(left(radPowerType,1)='E',RadPwr*1.65,iif(left(radPowerType,1)='V',RadPwr*3,RadPwr)) AS Power_eirp, Azimuth, Elevation, Gain AS ANTgain, BeamWidthH AS BWh, BeamWidthV AS BWv, Pol AS Polarization, AntName AS Antenna, InsLoss AS InsertionLoss, Sensitivity AS RxSensitivity, 1 as Srv,ClassStation AS STTP, EmDes AS Emission, Antenna.AntID ,respfreq/1000000 as  RXfreq,radius,NoiseFactor,HeightASL  AS Sth_asl,station.country as ctry , AntCat.MaxEffHght ");
	CString str2 = _T(" FROM station, equipment, eqcat, antenna, antcat, frequency ");
	CString str3 = _T(" WHERE station.stid=equipment.stid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid and ClassOfAnt<>'R'  and classstation='FX'  ");
	CString str4 = _T(" union all SELECT Frequency.freqid AS IDst, SiteName AS STname, Geolat AS STlat_deg, Geolon AS STlon_deg, AntHeightAGL AS Sth_agl, frequency/1000000 AS TXfreq, iif(left(radPowerType,1)='E',RadPwr*1.65,iif(left(radPowerType,1)='V',RadPwr*3,RadPwr)) AS Power_eirp, Azimuth, Elevation, Gain AS ANTgain, BeamWidthH AS BWh, BeamWidthV AS BWv, Pol AS Polarization, AntName AS Antenna, InsLoss AS InsertionLoss, Sensitivity AS RxSensitivity, 2 as Srv,ClassStation AS STTP, EmDes AS Emission, Antenna.AntID ,respfreq/1000000 as  RXfreq,radius,NoiseFactor,HeightASL  AS Sth_asll,station.country as ctry , AntCat.MaxEffHght ");
	CString str5 = _T(" FROM station, equipment, eqcat, antenna, antcat, frequency ");
	CString str6 = _T(" WHERE station.stid=equipment.stid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid and ClassOfAnt<>'R' and classstation='FB' ");
	CString str7 = _T(" union all SELECT Frequency.freqid AS IDst, SiteName AS STname, Geolat AS STlat_deg, Geolon AS STlon_deg, AntHeightAGL AS Sth_agl, frequency/1000000 AS TXfreq, iif(left(radPowerType,1)='E',RadPwr*1.65,iif(left(radPowerType,1)='V',RadPwr*3,RadPwr)) AS Power_eirp, Azimuth, Elevation, Gain AS ANTgain, BeamWidthH AS BWh, BeamWidthV AS BWv, Pol AS Polarization, AntName AS Antenna, InsLoss AS InsertionLoss, Sensitivity AS RxSensitivity, 3 as Srv,ClassStation AS STTP,  EmDes  AS Emission, Antenna.AntID ,respfreq/1000000 as  RXfreq,radius,NoiseFactor,HeightASL  AS Sth_asll,BCstation.country as ctry , AntCat.MaxEffHght ");
	CString str8 = _T(" FROM bcstation, equipment, eqcat, antenna, antcat, frequency ");
	CString str9 = _T(" WHERE bcstation.stid=equipment.bcid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid  ");
	CString str10 = _T(" UNION ALL SELECT Frequency.freqid AS IDst, MobName AS STname, Geolat AS STlat_deg, Geolon AS STlon_deg, AntHeightAGL AS Sth_agl, frequency/1000000 AS TXfreq, iif(left(radPowerType,1)='E',RadPwr*1.65,iif(left(radPowerType,1)='V',RadPwr*3,RadPwr)) AS Power_eirp, Azimuth, Elevation, Gain AS ANTgain, BeamWidthH AS BWh, BeamWidthV AS BWv, Pol AS Polarization, AntName AS Antenna, InsLoss AS InsertionLoss, Sensitivity AS RxSensitivity, 2  as Srv,ClassStation AS STTP,  EmDes  AS Emission, Antenna.AntID ,respfreq/1000000 as  RXfreq,radius,NoiseFactor,3 as Sth_asll,Mobiles.country as ctry , AntCat.MaxEffHght ");
	CString str11 = _T(" FROM mobiles, equipment, eqcat, antenna, antcat, frequency ");
	CString str12 = _T(" WHERE mobiles.mobid=equipment.mobid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid ");
	CString str13 = _T(" ]. as STtableGE89 ");
	CString str14 = str1+str2+str3+str4+str5+str6+str7+str8+str9+str10+str11+str12+str13;
	CString str;
	str.Format(_T("SELECT * FROM %s WHERE ((((TXfreq)>=47 And (TXfreq)<=68) Or ((TXfreq)>=230 And (TXfreq)<=238) Or ((TXfreq)>=246 And (TXfreq)<=254)) AND ((STTP)='FX' Or (STTP)='FB' Or (STTP)='ML'));")  ,  str14);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = str;

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _T("Wanted Station");
	datadlg.m_Heff1 = TRUE;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
		{
			*hef_flag = datadlg.m_Heff1;
			SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		}
	}
	Set_STtable_Default();
	return SelX;
}

BOOL CSMS4DCView::OnFXM2BTQy(double latX, double lonX, double frqX, double Drange, double Frange,BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

	double fmin = frqX - Frange/1000.0;
	double fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
///	CDataBaseSTR.Format("select * from GE89BT2BT where (((lat_dec)>=%f And (lat_dec)<=%f) AND ((long_dec)>=%f And (long_dec)<=%f) AND ((freq_assgn)>=%f AND (freq_assgn)<=%f) AND ((stn_cls)=\'%s\'));",latmin,latmax,lonmin,lonmax,fmin,fmax, "BT");
//	CDataBaseSTR.Format(_T("SELECT * FROM GE89BT2BT WHERE (((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) And ((freq_assgn)>=%lf And (freq_assgn)<=%lf)) AND ((stn_cls)='BT'));"),latmin,latmax,lonmin,lonmax,fmin,fmax);
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((lat_dec)>=%lf And (lat_dec)<=%lf) AND ((long_dec)>=%lf And (long_dec)<=%lf) AND ((((freq_assgn)>=47 And (freq_assgn)<=68) Or ((freq_assgn)>=230 And (freq_assgn)<=238) Or ((freq_assgn)>=246 And (freq_assgn)<=254)) And ((freq_assgn)>=%lf And (freq_assgn)<=%lf)) AND ((stn_cls)='BT'));"),m_qGE89BT2BT,latmin,latmax,lonmin,lonmax,fmin,fmax);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
//	datadlg.m_Title = _T("Interferer Stations");
	datadlg.m_Title = _T("Victim Stations");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnCoordinationGe89Fxlm2bt() 
{
	BeginWaitCursor();
	BOOL hef_flag;
	CString m_SelX = OnFXM2BTQx(&hef_flag);

	if(m_SelX!=_T(" "))
	{
		long IDX = atol(GetFld(m_SelX,1));
		CString nameX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double HaglX  = atof(GetFld(m_SelX,5));
		double Ffm = atof(GetFld(m_SelX,6));
		double Pw_eirp = atof(GetFld(m_SelX,7));
		CString polX = GetFld(m_SelX,13);

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 4000;
		rangeDLG.m_T = 1;

		rangeDLG.m_kflag = TRUE;

		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			double kfactor = rangeDLG.m_kfactorD;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag0;
			BOOL YOK = OnFXM2BTQy(latX,lonX,Ffm,Drange,Frange,&hef_flag0);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];

					double FvY , FsY , DeltaF , Fs , Fc , latY , lonY , zDist[8] , RAZIM , RDIST , h1;
					CString Ycolor , assignIDY , ctyY , nameY , fmtv_terra_polarY , Yst_cls , Zones[8];
					long IER , j ,k=0;
					double Et ,Frac,  ELt, ESt, Alpha_t , Elimit , RPR , g_dB , Lp,Ghv;

//					double pi=4.0*atan(1.0);
					float RLONX = (float)(lonX*pi/180.0) ;
					float RLATX = (float)(latX*pi/180.0) ;
					CString ctyX("");
					GEOPLC(&RLONX, &RLATX, (BYTE*)ctyX.GetBufferSetLength(3)) ;

					CString strX,strY=_T(""),strY1=_T("");

					double AZ0 = atof(GetFld(m_SelX,8));
					double EL0 = atof(GetFld(m_SelX,9));
					CString antX = GetFld(m_SelX,14);
					CString antfile;
					antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,antX);
					int f0[360];	double rH[360]  ,  rV[360];
					ReadAntennaData(antfile,f0,rH,rV) ;

					double HaglY,elevp,tpi,fpi,fi,ti , re=(kfactor)*6371000.0;
					double Fsmin , FaY;

					CGE89_Functions GE89x;

					double eff_hgtmax,h10[37];
					long AntID = atol(GetFld(m_SelX,20));
					int az0[37];
					for(int i=0;i<36;i++)	az0[i] = 10*i;
					az0[36] = 360;

					int progress_num=0;
					CString progress_str, progress_char = _T("I");
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						FvY = atof(GetFld(m_Sel[Yi],18));
						FsY = atof(GetFld(m_Sel[Yi],25));
						Ycolor = GetFld(m_Sel[Yi],29) ,	Ycolor.TrimRight();

						DeltaF = Ffm - FvY;
						Fs = FsY - FvY; 

						if(Ycolor==_T("NTSC"))									Fc = 3.579;
						else if ((Ycolor==_T("PAL"))||(Ycolor==_T("SECAM")))	Fc = 4.43;

						assignIDY = GetFld(m_Sel[Yi],2);
						ctyY = GetFld(m_Sel[Yi],3);
						nameY = GetFld(m_Sel[Yi],4);	nameY.TrimRight();
						latY = atof(GetFld(m_Sel[Yi],5));
						lonY  = atof(GetFld(m_Sel[Yi],6));
						fmtv_terra_polarY = GetFld(m_Sel[Yi],8);	fmtv_terra_polarY.TrimRight();
						Yst_cls = GetFld(m_Sel[Yi],17);

						HaglY  = atof(GetFld(m_Sel[Yi],7));
						FaY  = atof(GetFld(m_Sel[Yi],14));

						IER = 1;
						IER = GEZones(3,latX,lonX,latY,lonY,zDist,Zones) ;
						if(IER==0)
						{
							RAZIM = Azimuth_Deg(latX,lonX,latY,lonY);
							RDIST = Distance_km(latX,lonX,latY,lonY);
							/////////////////////////// h1 //////////////////////////////////////////////////////////
					//		if(hef_flag)
					//		{
					//			h1 = Eff_H(latX,lonX , RAZIM , HaglX) ;
					//		}

							if(hef_flag)
							{
								h1 = Eff_H(latX,lonX , RAZIM , HaglX) ;
							}
							else
							{
								eff_hgtmax = atof(GetFld(m_SelX,26));
								GE84Heff(AntID,eff_hgtmax,h10) ;
								h10[36] = h10[0];
								h1 = Interp2(az0,h10,RAZIM,37) ;
							}
							//////////////////////////////////Delta H///////////////////////////////////////////////////
							if(DHflag)
							{
								dH = Delta_H( latX,lonX, RAZIM) ;
							}
							g_dB =  GE89x.Delta_h_cr(Ffm,RDIST,dH, ctyX);
							Lp = GE89x.F_2B_1_2(Ffm, P_location, dH, ctyX);
							/////////////////////////////////////////////////////////////////////////////////////

							tp = rangeDLG.m_T;
							Et = 0;
							if((Ffm>=300)&&(Ffm<=3000)&&(tp<=10.0))
							{
								Frac = ELt = ESt =0;	
								for( j=0;j<3;j++)
									ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;

								for( j=3;j<8;j++)
								{
									ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;
									Frac = Frac + zDist[j]/RDIST;
								}
								Alpha_t = GE89x.F_2_1(Frac, tp);
								Et  = ELt  + Alpha_t*(ESt-ELt);
							}
							else
							{
								for( j=0;j<8;j++)
									Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;
							}

							//0000000000000000000000000000000000000000000000000000000000000000
							//                     Antenna    Effect
							//0000000000000000000000000000000000000000000000000000000000000000
							elevp = AZ_EL(latX,lonX,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - elevp;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0),(cos(EL0)*sin(tpi)*cos(fpi-AZ0)+cos(tpi)*sin(EL0)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0)-sin(EL0)*sin(tpi)*cos(fpi-AZ0));
							if (fi<0.0)		fi = fi + 359.4;
							Ghv = Interp2(f0,rH,fi,360) * Interp2(f0,rV,ti,360);
							//0000000000000000000000000000000000000000000000000000000000000000

							if     ((FaY>=47)&&(FaY<=68))			Fsmin = 46;
							else if((FaY>=174)&&(FaY<=254))			Fsmin = 49;
							else if((FaY>=470)&&(FaY<=582))			Fsmin = 53;
							else if((FaY> 582)&&(FaY<=862))			Fsmin = 58;

							Et = Et + 10.0*log10(Pw_eirp*Ghv/1650.0) + Lp;

						//	RPR =  GE89x.F_1(DeltaF,Fc,Fs);
							RPR =  GE89x.RPR_Int(DeltaF,Fc,Fs);

							Elimit = Fsmin - 58.0 - RPR + g_dB;

					//		if (Et>Elimit)
							{
								k++;
								strY1.Format("%s,%s,%s,%f,%0.2f,%0.6f,%0.0f",assignIDY,nameY,ctyY,FaY,RPR,Et,Elimit);
								strY = strY+","+strY1;
							}

						}	//IER

					}	//Yi
					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					strX.Format("%ld,%s,%s,%f",IDX,nameX,ctyX,Ffm);
					strY.Delete(0);
					CGE89_FXM2BTDLG dlgList;
					dlgList.m_title1 = _Z("GE89 : Likely Affected BT Stations(FX,LM-->BT)");
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();

				}	//Nrow
			}	//YOK
		}	//rangeDLG
	}	// m_SelX
	EndWaitCursor();
}

BOOL CSMS4DCView::OnBT2FXQy(double latX, double lonX, double frqX, double Drange, double Frange, BOOL *hef_flag) 
{
	BOOL YOK = FALSE;
	*hef_flag = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;

	double fmin = frqX - Frange/1000.0;
	double fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
////CDataBaseSTR.Format("select * from Q_Links where (((RxLat)>=%f And (RxLat)<=%f) AND ((RxLon)>=%f And (RxLon)<=%f) AND ((RxFrq)>=%f AND (RxFrq)<=%f));",latmin,latmax,lonmin,lonmax,fmin,fmax);
///	CDataBaseSTR.Format("select * from Q_Links where (((RxLat)>=%f And (RxLat)<=%f) AND ((RxLon)>=%f And (RxLon)<=%f) AND ((TxFrq)>=%f AND (TxFrq)<=%f));",latmin,latmax,lonmin,lonmax,fmin,fmax);
//	CDataBaseSTR.Format(_T("SELECT * FROM Q_Links WHERE (((RxLat)>=%lf And (RxLat)<=%lf) AND ((RxLon)>=%lf And (RxLon)<=%lf) AND ((((TxFrq)>=47 And (TxFrq)<=68) Or ((TxFrq)>=230 And (TxFrq)<=238) Or ((TxFrq)>=246 And (TxFrq)<=254)) And ((TxFrq)>=%lf And (TxFrq)<=%lf)));"),latmin,latmax,lonmin,lonmax,fmin,fmax);
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((RxLat)>=%lf And (RxLat)<=%lf) AND ((RxLon)>=%lf And (RxLon)<=%lf) AND ((((TxFrq)>=47 And (TxFrq)<=68) Or ((TxFrq)>=230 And (TxFrq)<=238) Or ((TxFrq)>=246 And (TxFrq)<=254)) And ((TxFrq)>=%lf And (TxFrq)<=%lf)));"),m_qQ_Links , latmin,latmax,lonmin,lonmax,fmin,fmax);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
//	datadlg.m_Heff1 = FALSE;
	datadlg.m_Heff1 = TRUE;
	datadlg.m_Title = _T("Found Hop(s)");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)
		{
			YOK = TRUE;
			*hef_flag = datadlg.m_Heff1;
		}
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnInterferenceBt2fx() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=" ")
	{
		CString assignIDX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);	ctyX.TrimRight();
		double FaX = atof(GetFld(m_SelX,14));
		double FvX = atof(GetFld(m_SelX,18));
		double FsX = atof(GetFld(m_SelX,25));
		double Hagl_ST = atof(GetFld(m_SelX,7));
		CString ant_dir = GetFld(m_SelX,12);			ant_dir.TrimRight();
		CString	fmtv_terra_polar = GetFld(m_SelX,8);	fmtv_terra_polar.TrimRight();
		long terrakey = atol(GetFld(m_SelX,1));
		double erp_dbw = atof(GetFld(m_SelX,9));
		double erp_h_dbw = atof(GetFld(m_SelX,10));
		double erp_v_dbw = atof(GetFld(m_SelX,11));

		long AntID = atol(GetFld(m_SelX,31));

		double attH0[37], attV0[37];
		if(ant_dir=="D")
			GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
		else
			for(int i=0;i<36;i++)
			{
				attH0[i] = 0;
				attV0[i] = 0;
			}
		attH0[36] = attH0[0];
		attV0[36] = attV0[0];

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 10000;
		rangeDLG.m_T = 10;
		rangeDLG.m_kflag = TRUE;

		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			double kfactor = rangeDLG.m_kfactorD;

			BOOL DHflag = rangeDLG.m_DHflag;

			BOOL hef_flag;

			BOOL YOK = OnBT2FXQy(latX,lonX,FaX,Drange,Frange,&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString Xcolor = GetFld(m_SelX,29);		Xcolor.TrimRight();
					CString RLONbs , RLATbs;

					CString *m_Sel; m_Sel = new CString[Nrow];
					CString name1 , Zones[8] , Yst_cls, assignIDY,ctyY, strX,strY=_T(""),strY1=_T("");

					int j , IER ;
					double Fc , DeltaF , RPR , Elimit , Ff , zDist[8] , Alpha_t,Frac, ELt, ESt;
					BOOL Fixed_Band;

					double Fs = FsX-FvX;
					if	     (Xcolor==_T("NTSC"))							Fc = 3.579;
					else if ((Xcolor==_T("PAL"))||(Xcolor==_T("SECAM")))	Fc = 4.43;

					double lat0,lon0,h10[37], /*pi = 4.0*atan(1.0),*/ erpdbw,attnH,attnV;
					double RDIST, RAZIM, eff_hgtmax , h1 ,  g_dB , Lp , Et = -999.999 ;
					float Rlon0, Rlat0;

					long k = 0;
					int az0[37];
					for(int i=0;i<36;i++)	az0[i] = 10*i;
					az0[36] = 360;

					CGE89_Functions GE89x;

					double Height_gain,TxLatI, TxLonI, HtI,HrI,EL0rI ,AZ0rI , el,fpi,tpi,fi,ti,RAD;
					double  HtW = Hagl_ST , re = kfactor*6371000;
					long RxAntID;
					CString ANT_Rx,antfile;
					int f0[360];
					double rH[360],rV[360];

					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						name1 = GetFld(m_Sel[Yi],16);
						lat0 = atof(GetFld(m_Sel[Yi],17));
						lon0  = atof(GetFld(m_Sel[Yi],18));

						Rlon0 = (float)(lon0*pi/180.0);
						Rlat0 = (float)(lat0*pi/180.0);
						GEOPLC(&Rlon0, &Rlat0, (BYTE*)ctyY.GetBufferSetLength(3)) ;

						//////////////////////////////////////// Antenna Effect ////////////////////////////////////////
						TxLatI  = atof(GetFld(m_Sel[Yi],4));
						TxLonI  = atof(GetFld(m_Sel[Yi],5));
						HtI = atof(GetFld(m_Sel[Yi],8));
						HrI = atof(GetFld(m_Sel[Yi],21));
						RxAntID  = atol(GetFld(m_Sel[Yi],25));

						EL0rI = AZ_EL( lat0, lon0, TxLatI, TxLonI, HrI, HtI, re, &AZ0rI) ;

						ANT_Rx = AntID2AntName(RxAntID) ;
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,f0,rH,rV) ;

						el = AZ_EL(lat0, lon0, latX, lonX, HrI,  HtW, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0rI),(cos(EL0rI)*sin(tpi)*cos(fpi-AZ0rI)+cos(tpi)*sin(EL0rI)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0rI)-sin(EL0rI)*sin(tpi)*cos(fpi-AZ0rI));
						if (fi<0.0)		fi = fi + 359.4;
						RAD = Interp2(f0,rH,fi,360) * Interp2(f0,rV,ti,360);
						RAD = 10.0*log10(RAD);
						//////////////////////////////////////// ////////////////////////////////////////
			//			Ff = atof(GetFld(m_Sel[Yi],19));
						Ff = atof(GetFld(m_Sel[Yi],6));

						Fixed_Band = GE89x.Fixed_Band(Ff,ctyY);

			//			if(Fixed_Band==TRUE)
						{
							assignIDY = GetFld(m_Sel[Yi],15);

							IER = 1;
							IER = GEZones(3,latX,lonX,lat0,lon0,zDist,Zones) ;
							if(IER==0)
							{
								RAZIM = Azimuth_Deg(latX,lonX,lat0,lon0);
								RDIST = Distance_km(latX,lonX,lat0,lon0);
								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(latX,lonX , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_SelX,20));
							//		GE84Heff(terrakey,eff_hgtmax,h10) ;
									GE84Heff(AntID,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( latX,lonX, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FaX,RDIST,dH, ctyX);
								Lp = GE89x.F_2B_1_2(FaX, P_location, dH, ctyX);
								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == _T("H"))			erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == _T("V"))	erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == _T("M"))	erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FaX>=300)&&(FaX<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
								}
								Height_gain = 20.0*log10(HrI/10.0);
								Et  = Et  + erpdbw - 30.0 + Lp + Height_gain;

								DeltaF = Ff - FvX;
								RPR =  GE89x.F_1(DeltaF,Fc,Fs);
								Elimit = -2.0 - RPR + g_dB -RAD;

						//		if (Et>Elimit)
								{
									k++;
									Rad2Str(Rlon0,Rlat0, &RLONbs,&RLATbs);
									strY1.Format("%s,%s,%s,%0.4f,%0.2f,%s  %s,%0.6f,%0.0f",assignIDY,name1,ctyY,Ff,RPR,RLONbs,RLATbs,Et,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if Fixed_Band

					}// end for Yi

					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					strX.Format("%s,%s,%s,%0.4f",assignIDX,nameX,ctyX,FaX);
					strY.Delete(0);
					CGE89_FXDLG dlgList;
					dlgList.m_title1 = _Z("GE89 : Interference from BT to FX Station(s) (BT-->FX)");
					dlgList.m_title2 = _Z("Interference to 'FX' Station(s) :");
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();
				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX
	EndWaitCursor();		
}

void CSMS4DCView::OnInterferenceFxlm2bt() 
{
	BeginWaitCursor();
	BOOL hef_flag;
	CString m_SelX = OnFXM2BTQx(&hef_flag);
	if(m_SelX!=_T(" "))
	{
		long IDX = atol(GetFld(m_SelX,1));
		CString nameX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double HaglX  = atof(GetFld(m_SelX,5));
		double Ffm = atof(GetFld(m_SelX,6));
		double Pw_eirp = atof(GetFld(m_SelX,7));
		CString polX = GetFld(m_SelX,13);	polX.TrimRight();	polX.MakeUpper();
		CString Xst_cls = GetFld(m_SelX,18);	Xst_cls.TrimRight();	Xst_cls.MakeUpper();

		double PR = 58;
		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 4000;
		rangeDLG.m_T = 1;
		rangeDLG.m_kflag = TRUE;
		rangeDLG.m_PRflag = TRUE;
		rangeDLG.m_PR = 58;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			double kfactor = rangeDLG.m_kfactorD;
			double PR = rangeDLG.m_PR;

			BOOL DHflag = rangeDLG.m_DHflag;
			BOOL hef_flag0;
			BOOL YOK = OnFXM2BTQy(latX,lonX,Ffm,Drange,Frange,&hef_flag0);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];

					double FvY , FsY , DeltaF , Fs , Fc , latY , lonY , zDist[8] , RAZIM , RDIST , h1;
					CString Ycolor , assignIDY , ctyY , nameY , fmtv_terra_polarY , Yst_cls , Zones[8];
					long IER , j ,k=0;
					double Et ,Frac,  ELt, ESt, Alpha_t , Elimit , RPR , g_dB , Lp,Ghv;

//					double pi=4.0*atan(1.0);
					float RLONX = (float)(lonX*pi/180.0) ;
					float RLATX = (float)(latX*pi/180.0) ;
					CString ctyX("");
					GEOPLC(&RLONX, &RLATX, (BYTE*)ctyX.GetBufferSetLength(3)) ;

					CString polY, strX,strY=_T(""),strY1=_T("");

					double AZ0 = atof(GetFld(m_SelX,8));
					double EL0 = atof(GetFld(m_SelX,9));
					CString antX = GetFld(m_SelX,14);
					CString antfile, antDIR;
					antfile.Format(_T("%sAntenna\\ant_%s.ant"),((CSMS4DCApp *)AfxGetApp())->m_AppPath ,antX);
					int f0[360];	double rH[360]  ,  rV[360];
					ReadAntennaData(antfile,f0,rH,rV) ;

					double HaglY,elevp,tpi,fpi,fi,ti , re=(kfactor)*6371000.0;
					double Fsmin , FaY , AF, az1, az2, dAZ;
					CGE89_Functions GE89x;

					double eff_hgtmax,h10[37];
					long AntID = atol(GetFld(m_SelX,20));
					int az0[37];
					for(int i=0;i<36;i++)	az0[i] = 10*i;
					az0[36] = 360;

					int progress_num=0;
					CString progress_str, progress_char = _T("I");
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						FvY = atof(GetFld(m_Sel[Yi],18));
						FsY = atof(GetFld(m_Sel[Yi],25));
						Ycolor = GetFld(m_Sel[Yi],29) ,	Ycolor.TrimRight();
						polY = GetFld(m_Sel[Yi],8) ,	polY.TrimRight();	polY.MakeUpper();

						DeltaF = Ffm - FvY;
						Fs = FsY - FvY; 

						if(Ycolor==_T("NTSC"))									Fc = 3.579;
						else if ((Ycolor==_T("PAL"))||(Ycolor==_T("SECAM")))	Fc = 4.43;

						assignIDY = GetFld(m_Sel[Yi],2);
						ctyY = GetFld(m_Sel[Yi],3);
						nameY = GetFld(m_Sel[Yi],4);	nameY.TrimRight();
						latY = atof(GetFld(m_Sel[Yi],5));
						lonY  = atof(GetFld(m_Sel[Yi],6));
						fmtv_terra_polarY = GetFld(m_Sel[Yi],8);	fmtv_terra_polarY.TrimRight();
						Yst_cls = GetFld(m_Sel[Yi],17);

						HaglY  = atof(GetFld(m_Sel[Yi],7));
						FaY  = atof(GetFld(m_Sel[Yi],14));

						IER = 1;
						IER = GEZones(3,latX,lonX,latY,lonY,zDist,Zones) ;
						if(IER==0)
						{
							RAZIM = Azimuth_Deg(latX,lonX,latY,lonY);
							RDIST = Distance_km(latX,lonX,latY,lonY);
							/////////////////////////// h1 //////////////////////////////////////////////////////////
					//		if(hef_flag)
					//		{
					//			h1 = Eff_H(latX,lonX , RAZIM , HaglX) ;
					//		}

							if(hef_flag)
							{
								h1 = Eff_H(latX,lonX , RAZIM , HaglX) ;
							}
							else
							{
								eff_hgtmax = atof(GetFld(m_SelX,26));
								GE84Heff(AntID,eff_hgtmax,h10) ;
								h10[36] = h10[0];
								h1 = Interp2(az0,h10,RAZIM,37) ;
							}

							//////////////////////////////////Delta H///////////////////////////////////////////////////
							if(DHflag)
							{
								dH = Delta_H( latX,lonX, RAZIM) ;
							}
							g_dB =  GE89x.Delta_h_cr(Ffm,RDIST,dH, ctyX);
							Lp = GE89x.F_2B_1_2(Ffm, P_location, dH, ctyX);
							/////////////////////////////////////////////////////////////////////////////////////

							tp = rangeDLG.m_T;
							Et = 0;
							if((Ffm>=300)&&(Ffm<=3000)&&(tp<=10.0))
							{
								Frac = ELt = ESt =0;	
								for( j=0;j<3;j++)
									ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;

								for( j=3;j<8;j++)
								{
									ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;
									Frac = Frac + zDist[j]/RDIST;
								}
								Alpha_t = GE89x.F_2_1(Frac, tp);
								Et  = ELt  + Alpha_t*(ESt-ELt);
							}
							else
							{
								for( j=0;j<8;j++)
									Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(Ffm, tp, Zones[j], h1, RDIST) ;
							}

							//0000000000000000000000000000000000000000000000000000000000000000
							//                     Antenna    Effect
							//0000000000000000000000000000000000000000000000000000000000000000
							elevp = AZ_EL(latX,lonX,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - elevp;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0),(cos(EL0)*sin(tpi)*cos(fpi-AZ0)+cos(tpi)*sin(EL0)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0)-sin(EL0)*sin(tpi)*cos(fpi-AZ0));
							if (fi<0.0)		fi = fi + 359.4;
							Ghv = Interp2(f0,rH,fi,360) * Interp2(f0,rV,ti,360);
							//0000000000000000000000000000000000000000000000000000000000000000

							if     ((FaY>=47)&&(FaY<=68))		Fsmin = 46;
							else if((FaY>=174)&&(FaY<=254))		Fsmin = 49;
							else if((FaY>=470)&&(FaY<=582))		Fsmin = 53;
							else if((FaY> 582)&&(FaY<=862))		Fsmin = 58;

							////////////////////////////Ant Adjustment Factor//////////////////
							AF = 0;
							antDIR  = GetFld(m_Sel[Yi],12);	antDIR.TrimRight();	antDIR.MakeUpper();
							if(antDIR==_T("D"))
							{
								az1  = atof(GetFld(m_Sel[Yi],30));
								az2 = Azimuth_Deg(latY,lonY , latX,lonX);
								dAZ = fabs(az1 - az2);
								if(dAZ>180.0)		dAZ = 360.0 - dAZ;
								AF = GE89x.AntAdjustmentFactor(dAZ,FaY,Xst_cls,polX,polY);
							}
							////////////////////////////////////////////////////////////////////

							Et = Et + 10.0*log10(Pw_eirp*Ghv/1650.0) + Lp;

						//	RPR =  GE89x.F_1(DeltaF,Fc,Fs);
							RPR =  GE89x.RPR_Int(DeltaF,Fc,Fs);

							Elimit = Fsmin - PR - RPR + g_dB - AF;

					//		if (Et>Elimit)
							{
								k++;
								strY1.Format(_T("%s,%s,%s,%f,%0.2f,%0.6f,%0.0f"),assignIDY,nameY,ctyY,FaY,RPR,Et,Elimit);
								strY = strY+","+strY1;
							}

						}	//IER

					}	//Yi
					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, _T(""));

					strX.Format(_T("%ld,%s,%s,%f"),IDX,nameX,ctyX,Ffm);
					strY.Delete(0);
					CGE89_FXM2BTDLG dlgList;
					dlgList.m_title1 =  _Z("GE89 : Interference from Land Mobile or 'FX' Station to BT Station (LM , FX-->BT)");
					dlgList.m_title2 =  _Z("Interference to BT Station(s) : ");
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.DoModal();
				}	//Nrow
			}	//YOK
		}	//rangeDLG
	}	// m_SelX
	EndWaitCursor();
}

void CSMS4DCView::OnInterferenceBt2lm() 
{
	BeginWaitCursor();
	CString m_SelX = OnGE89Qx(_T("BT"));

	if(m_SelX!=" ")
	{
		CString assignIDX = GetFld(m_SelX,2);
		double latX = atof(GetFld(m_SelX,5));
		double lonX  = atof(GetFld(m_SelX,6));
		CString ctyX = GetFld(m_SelX,3);	ctyX.TrimRight();
		double FaX = atof(GetFld(m_SelX,14));
		double Hagl_ST = atof(GetFld(m_SelX,7));
		CString ant_dir = GetFld(m_SelX,12);			ant_dir.TrimRight();
		CString	fmtv_terra_polar = GetFld(m_SelX,8);	fmtv_terra_polar.TrimRight();
		long terrakey = atol(GetFld(m_SelX,1));
		double erp_dbw = atof(GetFld(m_SelX,9));
		double erp_h_dbw = atof(GetFld(m_SelX,10));
		double erp_v_dbw = atof(GetFld(m_SelX,11));

		double attH0[37], attV0[37];
		if(ant_dir=="D")
			GE84pattern(terrakey,attH0,attV0,fmtv_terra_polar);
		else
			for(int i=0;i<36;i++)
			{
				attH0[i] = 0;		attV0[i] = 0;
			}
		attH0[36] = attH0[0];		attV0[36] = attV0[0];

		CGE89_rangeDLG rangeDLG;
		rangeDLG.m_D = 1500;
		rangeDLG.m_label1 = _Z("Frequency Range(kHz)");
		rangeDLG.m_Emin = 10000;
		rangeDLG.m_T = 10;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_Emin,  tp = rangeDLG.m_T;
			double Drange = rangeDLG.m_D,	P_location = rangeDLG.m_L , dH = rangeDLG.m_DH;
			BOOL DHflag = rangeDLG.m_DHflag;
			BOOL hef_flag;

//			BOOL YOK = OnGE89FXMQy(latX,lonX,FaX,Drange,Frange,"FB",&hef_flag);
			BOOL YOK = OnGE89FXMQyL(latX,lonX,FaX,Drange,Frange,_T("FB"),&hef_flag);
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				long Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString nameX = GetFld(m_SelX,4);		nameX.TrimRight();
					CString RLONbs , RLATbs;

					CString *m_Sel; m_Sel = new CString[Nrow];
					CString name1 , Zones[8] , Yst_cls, ctyY, strX,strY="",strY1="";

					int j , IER ;
					double Elimit , Fm , zDist[8] , Alpha_t,Frac, ELt, ESt;
					BOOL Mobile_Band;

					double lat0,lon0,h10[37], /*pi = 4.0*atan(1.0),*/ erpdbw,attnH,attnV;
					double RDIST, RAZIM, eff_hgtmax , h1 ,  g_dB , Lp , Et = -999.999 ;
					float Rlon0, Rlat0;
					double h2 , Height_gain;

					long assignIDY , k = 0;
					int az0[37];
					for(int i=0;i<36;i++)
						az0[i] = 10*i;
					az0[36] = 360;

					double FvY,FsY,RPR , DeltaF , Fc ,Fs , Fsmin ,Pd , necBWm;
					FvY = atof(GetFld(m_SelX,18));
					FsY = atof(GetFld(m_SelX,25));
					CString Ycolor = GetFld(m_SelX,29) ;	Ycolor.TrimRight();
					Fs = FsY - FvY; 
					if(Ycolor=="NTSC")								Fc = 3.579;
					else if ((Ycolor=="PAL")||(Ycolor=="SECAM"))	Fc = 4.43;

					Pd=0;
					if((fmtv_terra_polar=="H")&&(Yst_cls=="FB"))	Pd=18;

					CGE89_Functions GE89x;

					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",100*(++progress_num)/(Nrow),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/(Nrow)) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						name1 = GetFld(m_Sel[Yi],2);		name1.TrimRight();
						lat0 = atof(GetFld(m_Sel[Yi],3));
						lon0  = atof(GetFld(m_Sel[Yi],4));
						ctyY = GetFld(m_Sel[Yi],25);

						Rlon0 = (float)(lon0*pi/180.0);
						Rlat0 = (float)(lat0*pi/180.0);
						if(ctyY=="   ")
							GEOPLC(&Rlon0, &Rlat0, (BYTE*)ctyY.GetBufferSetLength(3)) ;

						Fm = atof(GetFld(m_Sel[Yi],6));
						necBWm  = Emission2NBW(GetFld(m_Sel[Yi],19)) ;

						DeltaF = Fm - FvY;
						Mobile_Band = GE89x.Mobile_Band(Fm,ctyY);

				//		if(Mobile_Band==TRUE)
						{
							assignIDY = atol(GetFld(m_Sel[Yi],1));
							Yst_cls = GetFld(m_Sel[Yi],18);	Yst_cls.TrimRight();

							if     (Yst_cls=="FB")	h2 = 1.5;
							else if(Yst_cls=="ML")	h2 = 10.0;

							IER = 1;
							IER = GEZones(3,latX,lonX,lat0,lon0,zDist,Zones) ;
							if(IER==0)
							{
								RAZIM = Azimuth_Deg(latX,lonX,lat0,lon0);
								RDIST = Distance_km(latX,lonX,lat0,lon0);
								/////////////////////////// h1 //////////////////////////////////////////////////////////
								if(hef_flag)
								{
									h1 = Eff_H(latX,lonX , RAZIM , Hagl_ST) ;
								}
								else
								{
									eff_hgtmax = atof(GetFld(m_SelX,20));
									GE84Heff(terrakey,eff_hgtmax,h10) ;
									h10[36] = h10[0];
									h1 = Interp2(az0,h10,RAZIM,37) ;
								}
								//////////////////////////////////Delta H///////////////////////////////////////////////////
								if(DHflag)
								{
									dH = Delta_H( latX,lonX, RAZIM) ;
								}
								g_dB =  GE89x.Delta_h_cr(FaX,RDIST,dH, ctyX);
								Lp = GE89x.F_2B_1_2(FaX, P_location, dH, ctyX);
								/////////////////////////////////////////////////////////////////////////////////////
								attnH = Interp2(az0,attH0,RAZIM,37) ;
								attnV = Interp2(az0,attV0,RAZIM,37) ;
								if(fmtv_terra_polar == "H")				erpdbw = erp_h_dbw - attnH;
								else if(fmtv_terra_polar == "V")		erpdbw = erp_v_dbw - attnV;
								else if(fmtv_terra_polar == "M")		erpdbw = 10.0*log10(pow(10.0,(erp_h_dbw - attnH)/10.0) + pow(10.0,(erp_v_dbw - attnV)/10.0));

								tp = rangeDLG.m_T;
								Et = 0;
								if((FaX>=300)&&(FaX<=3000)&&(tp<=10.0))
								{
									Frac = ELt = ESt =0;	
									for( j=0;j<3;j++)
										ELt  = ELt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;

									for( j=3;j<8;j++)
									{
										ESt  = ESt  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
										Frac = Frac + zDist[j]/RDIST;
									}
									Alpha_t = GE89x.F_2_1(Frac, tp);
									Et  = ELt  + Alpha_t*(ESt-ELt);
								}
								else
								{
									for( j=0;j<8;j++)
										Et  = Et  + (zDist[j]/RDIST)*GE89x.GE89_E_3(FaX, tp, Zones[j], h1, RDIST) ;
								}

								Height_gain = 20.0*log10(h2/10.0);

								RPR = GE89x.RPR_Int(DeltaF,Fc,Fs);
								Fsmin = GE89x.Mobile_Fsmin_Int(Fm,necBWm);

								Et  = Et  + erpdbw - 30.0 + Lp + Height_gain;

						//		Elimit = Fsmin-10-RPR-Pd + g_dB;
								Elimit = Fsmin-10-RPR+Pd + g_dB;

						//		if (Et>Elimit)
								{
									k++;
									Rad2Str(Rlon0,Rlat0, &RLONbs,&RLATbs);
									strY1.Format("%ld,%s,%s,%f,%s,%s  %s,%0.6f,%0.0f",assignIDY,name1,ctyY,Fm,Yst_cls,RLONbs,RLATbs,Et,Elimit);
									strY = strY+","+strY1;
								}

							}	// end if IER

						}	//end if Fixed_Band

					}// end for Yi

					delete [] m_Sel;
					((CSMS4DCApp *)AfxGetApp())->m_Sel = NULL;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

					strX.Format("%s,%s,%s,%f",assignIDX,nameX,ctyX,FaX);
					strY.Delete(0);
					CGE89_FXDLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = k+1;//Nrow+1;
					dlgList.m_editY = strY;
					dlgList.m_title1 =  _Z("GE89 : Interference from BT to Land Mobile Station(s)(BT-->LM)");
					dlgList.m_title2 =  _Z("Interference to Land Mobile Station(s) : ");
					dlgList.m_PR_CLS =  _T("stn_cls");
					dlgList.DoModal();
				}	//end if (Nrow>=1)
			}// end if YOK
		}// end if rangeDLG
	}// end if m_SelX
	EndWaitCursor();		
}

CString CSMS4DCView::OnBorderQx() 
{
	BeginWaitCursor();
	CString SelX = _T(" ");

	//Query INLMFX
//	CString str1 = _T(" [ SELECT Frequency.FreqID AS CoordReqID, Frequency/1000000 AS 1A1, Station.ClassStation AS 6A, 0 AS 10Z, Station.SiteName AS 4A, Station.Country AS 4B, Station.GeoLon AS 4C1, Station.GeoLat AS 4C2, Station.Radius AS 4D, Equipment.RadPwr AS 8B1, EqCat.RadPowerType AS 8B2, Antenna.AntHeightAGL AS 9Y, RespFreq/1000000 AS 1Y1, HeightASL as 4Z ");
	CString str1 = _T(" [ SELECT Frequency.FreqID AS CoordReqID, Frequency/1000000 AS 1A1, Station.ClassStation AS 6A, 0 AS 10Z, Station.SiteName AS 4A, Station.Country AS 4B, Station.GeoLon AS 4C1, Station.GeoLat AS 4C2, Station.Radius AS 4D, Equipment.RadPwr AS 8B1, EqCat.RadPowerType AS 8B2, Antenna.AntHeightAGL AS 9Y, RespFreq/1000000 AS 1Y1, HeightASL as 4Z , Azimuth as 9A, Elevation as 9B, AntName as 9XT ");
	CString str2 = _T(" FROM Frequency, EqCat, Equipment, Antenna, AntCat, Station ");
	CString str3 = _T(" WHERE station.stid=equipment.stid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid; ");
//	CString str4 = _T(" UNION ALL SELECT Frequency.FreqID AS CoordReqID, Frequency/1000000 AS 1A1,Mobiles.ClassStation AS 6A, 0 AS 10Z, Mobiles.MobName AS 4A, Mobiles.Country AS 4B, Mobiles.GeoLon AS 4C1, Mobiles.GeoLat AS 4C2, Mobiles.Radius AS 4D, Equipment.RadPwr AS 8B1, EqCat.RadPowerType AS 8B2, Antenna.AntHeightAGL AS 9Y, RespFreq/1000000 AS 1Y1, 0 as 4Z ");
	CString str4 = _T(" UNION ALL SELECT Frequency.FreqID AS CoordReqID, Frequency/1000000 AS 1A1,Mobiles.ClassStation AS 6A, 0 AS 10Z, Mobiles.MobName AS 4A, Mobiles.Country AS 4B, Mobiles.GeoLon AS 4C1, Mobiles.GeoLat AS 4C2, Mobiles.Radius AS 4D, Equipment.RadPwr AS 8B1, EqCat.RadPowerType AS 8B2, Antenna.AntHeightAGL AS 9Y, RespFreq/1000000 AS 1Y1, 0 as 4Z , Azimuth as 9A, Elevation as 9B, AntName as 9XT ");
	CString str5 = _T(" FROM Frequency, EqCat, Equipment, Antenna, AntCat, Mobiles ");
	CString str6 = _T(" WHERE Mobiles.Mobid=equipment.Mobid and equipment.eqcatid=eqcat.eqcatid and equipment.eqid=antenna.eqid and antenna.antcatid=antcat.antcatid and equipment.eqid=frequency.eqid ]. as INLMFX ");
	CString INLMFX = str1+str2+str3+str4+str5+str6;
	
	CString str;
	str.Format(_T("select * from %s ;"),  INLMFX);
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = str;
//	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from INLMFX");

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("Wanted Station");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
			SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

CString CSMS4DCView::OnAgreeMod1LMQ(CString cty,CString srv,double frq) 
{
	BeginWaitCursor();
	CString CDataBaseSTR , SelX = _T(" ");
//	CDataBaseSTR.Format(_T("SELECT * FROM AGREEMENT WHERE (((Countries) Like \'%%%s%%\') AND ((Service) Like \'%%%s%%\') AND ((LoFreq)<=%f) AND ((HiFreq)>=%f));") , cty,srv,frq,frq);

	//Query AGREEMENT
	CString str1 = _T(" [ SELECT Agreements.AgID, Agreements.AgName, Agreements.Countries, Agreements.Service, Agreements.Model, Agreements.Type, Agreements.PropModels, MODEL12.LoFreq, MODEL12.HiFreq, MODEL12.PrefCountries, MODEL12.PIFS, MODEL12.Xkm_CBR, MODEL12.ERP, MODEL12.CoordDist1, MODEL12.CoordDist2, MODEL12.Emergency ");
	CString str2 = _T(" FROM Agreements INNER JOIN MODEL12 ON Agreements.AgID = MODEL12.AgID ]. as AGREEMENT ");
	CString qAGREEMENT = str1+str2;
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Countries) Like \'%%%s%%\') AND ((Service) Like \'%%%s%%\') AND ((LoFreq)<=%f) AND ((HiFreq)>=%f));") , qAGREEMENT , cty,srv,frq,frq);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("Agreements");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
			SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

void CSMS4DCView::BorderCom2CtyD(double latst,double lonst,CString ctyI,double Dsearch,
							  double **datalat,double **datalon,long *numBorder) 
{
//	double pi = 4.0*atan(1.0);
	float RLATst = (float)(latst*pi/180.0);
	float RLONst = (float)(lonst*pi/180.0);
	CString ctyST("");
	CString ctyI0 = ((ctyI.GetLength())==1) ? ctyI+_T("  ") : ctyI;
	GEOPLC(&RLONst, &RLATst, (BYTE*)ctyST.GetBufferSetLength(3)) ;

	double *datalat0;	datalat0 = new double[30000];
	double *datalon0;	datalon0 = new double[30000];

	unsigned char BCILR;

	float CRDARR[2*15000], DENS=0;
	long LINE, NRCRD, NOMORE=0, NRCTY=1, ITYPE=2, MAXCRD=30000 ,NRCTY0 = 2;

	float RLONLL, RLATLL, RLONUR, RLATUR;
	unsigned char CTYVEK0[8];	strcpy((char *)CTYVEK0,ctyST+ctyI0);
	GEOCWI(&NRCTY0, (unsigned char *)CTYVEK0, &RLONLL, &RLATLL, &RLONUR, &RLATUR);

	unsigned char CTYVEK[4];	strcpy((char *)CTYVEK,ctyI0);
	GEODWD( &RLONLL, &RLATLL, &RLONUR, &RLATUR, &DENS, &NRCTY, (unsigned char *)CTYVEK);	

	long nBorder = 0;
	while(!NOMORE)
	{
		GEOLIW( &ITYPE, (float *)CRDARR, &MAXCRD, &LINE, &NRCRD, &BCILR, &NOMORE);
		for(int p=0;p<NRCRD;p++)
		{
			double lon = CRDARR[2*p] , lat = CRDARR[2*p+1];
			double d1 = Distance_km(latst, lonst , lat , lon);
			if(d1<=Dsearch)
			{
				datalon0[nBorder] = lon;	datalat0[nBorder] = lat;	nBorder++;
			}

		}//end for
	}//end while
	*datalat = new double[nBorder];		*datalon = new double[nBorder];
	for(int p=0; p<nBorder; p++)
	{
		(*datalat)[p] = datalat0[p];	(*datalon)[p] = datalon0[p];
	}
	delete [] datalat0;					delete [] datalon0;
	*numBorder = nBorder;
}

void CSMS4DCView::BorderCom2Cty(double latst,double lonst,CString ctyI,
							  double **datalat,double **datalon,long *numBorder) 
{
	double pi = 4.0*atan(1.0);
	float RLATst = (float)(latst*pi/180.0);
	float RLONst = (float)(lonst*pi/180.0);
	CString ctyST("");
	CString ctyI0 = ((ctyI.GetLength())==1) ? ctyI+_T("  ") : ctyI;
	GEOPLC(&RLONst, &RLATst, (BYTE*)ctyST.GetBufferSetLength(3)) ;

	double *datalat0;	datalat0 = new double[30000];
	double *datalon0;	datalon0 = new double[30000];

	long LINE1[100];
	unsigned char BCILR;

	int w , numLineI = 0;
	float CRDARR[2*15000], DENS=0;
	long LINE, NRCRD, NOMORE=0, NRCTY=1, ITYPE=2, MAXCRD=30000 ,NRCTY0 = 2;

	float RLONLL, RLATLL, RLONUR, RLATUR;
	unsigned char CTYVEK0[8];	strcpy((char *)CTYVEK0,ctyST+ctyI0);
	GEOCWI(&NRCTY0, (unsigned char *)CTYVEK0, &RLONLL, &RLATLL, &RLONUR, &RLATUR);

	unsigned char CTYVEK[4];	strcpy((char *)CTYVEK,ctyI0);
	GEODWD( &RLONLL, &RLATLL, &RLONUR, &RLATUR, &DENS, &NRCTY, (unsigned char *)CTYVEK);	
	while(!NOMORE)
	{
		GEOLIW( &ITYPE, (float *)CRDARR, &MAXCRD, &LINE, &NRCRD, &BCILR, &NOMORE);
		LINE1[numLineI] = LINE;		numLineI++;

	}//end while

	long nBorder = 0;
	NOMORE = 0;
	unsigned char CTYVEK1[4];	strcpy((char *)CTYVEK1,ctyST);
	GEODWD( &RLONLL, &RLATLL, &RLONUR, &RLATUR, &DENS, &NRCTY, (unsigned char *)CTYVEK1);	
	while(!NOMORE)
	{
		GEOLIW( &ITYPE, (float *)CRDARR, &MAXCRD, &LINE, &NRCRD, &BCILR, &NOMORE);
		w=0;
		for(int n=0;n<numLineI;n++)
		{
			if(LINE1[n]==LINE){	w=1;	break;}
		}
		if(w==1)
		{
			for(int p=0;p<NRCRD;p++)
			{
				datalon0[nBorder] = CRDARR[2*p];	datalat0[nBorder] = CRDARR[2*p+1];	nBorder++;
			}//end for
		}
	}//end while

	*datalat = new double[nBorder];		*datalon = new double[nBorder];
	for(int p=0; p<nBorder; p++)
	{
		(*datalat)[p] = datalat0[p];	(*datalon)[p] = datalon0[p];
	}
	delete [] datalat0;					delete [] datalon0;
	*numBorder = nBorder;
}
void CSMS4DCView::BorderCBR_Vector(double latst,double lonst,double CBR,CString ctyI,
							  double *Blat,double *Blon,long numBorder,double **CBRlat,double **CBRlon,long *numCBR) 
{
	double az , latC , lonC , pi = 4.0*atan(1.0);
	float RLATc,RLONc;
	CString ctyST("");
	CString ctyI0 = ((ctyI.GetLength())==1) ? ctyI+_T("  ") : ctyI;

	double *CBRlat0;	CBRlat0 = new double[30000];
	double *CBRlon0;	CBRlon0 = new double[30000];

	int nCBR = 0;
	for(int p = 0; p<numBorder; p++)
	{
		az = Azimuth_Deg(latst,lonst,Blat[p],Blon[p]) ;
		reckon(Blat[p],Blon[p],CBR,az,&latC,&lonC) ;
		RLATc = (float)(latC*pi/180.0);	RLONc = (float)(lonC*pi/180.0);
		GEOPLC(&RLONc, &RLATc, (BYTE*)ctyST.GetBufferSetLength(3)) ;
		if(ctyST==ctyI0)
		{
			CBRlat0[nCBR] = latC;	CBRlon0[nCBR] = lonC;	nCBR++;
		}
	}//end for
	*CBRlat = new double[nCBR];		*CBRlon = new double[nCBR];
	for( p=0; p<nCBR; p++)
	{
		(*CBRlat)[p] = CBRlat0[p];	(*CBRlon)[p] = CBRlon0[p];
	}
	delete [] CBRlat0;				delete [] CBRlon0;
	*numCBR = nCBR;
}
void CSMS4DCView::BorderXKM_Vector(double XKM,CString ctyI,
							  double *Blat,double *Blon,long numBorder,double **XKMlat,double **XKMlon,long *numXKM) 
{
	double az , latC, lonC,distC , pi = 4.0*atan(1.0);
	float RLATc,RLONc;
	CString ctyST("");
	CString ctyI0 = ((ctyI.GetLength())==1) ? ctyI+_T("  ") : ctyI;

	double *XKMlat0;	XKMlat0 = new double[30000];
	double *XKMlon0;	XKMlon0 = new double[30000];
	int w , nXKM = 0;

	int progress_num=0;
	CString progress_str, progress_char = "I";
	for(int p = 0; p<numBorder; p++)
	{
		progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder)),progress_char);
		progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder))) );
		((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
		PeekAndPump();
		az = Azimuth_Deg(Blat[p+1],Blon[p+1],Blat[p],Blon[p]) ;
		for(int j=0;j<72;j++)
		{
			reckon(Blat[p],Blon[p],XKM, j*5 + az ,&latC,&lonC) ;
			RLATc = (float)(latC*pi/180.0);		RLONc = (float)(lonC*pi/180.0);
			GEOPLC(&RLONc, &RLATc, (BYTE*)ctyST.GetBufferSetLength(3)) ;
			w=1;
			for(int p1=0;p1<numBorder;p1++)
			{
				distC = Distance_km(Blat[p1],Blon[p1],latC,lonC) ;
		//		if(distC<XKM)	{w=0;	break;}
				if(distC<(XKM-0.001))	{w=0;	break;}
			}
			if((ctyST==ctyI0)&&(w==1))
			{
				XKMlat0[nXKM] = latC;	XKMlon0[nXKM] = lonC;	nXKM++;
			}
		}
	}//end for
	*XKMlat = new double[nXKM];		*XKMlon = new double[nXKM];
	for( p=0; p<nXKM; p++)
	{
		(*XKMlat)[p] = XKMlat0[p];	(*XKMlon)[p] = XKMlon0[p];
	}
	delete [] XKMlat0;				delete [] XKMlon0;
	*numXKM = nXKM;
}

void CSMS4DCView::OnCoordinationBorder() 
{
	BeginWaitCursor();
	CString m_SelX = OnBorderQx();
	if(m_SelX != _T(" "))
	{
		long IDX = atol(GetFld(m_SelX,1));
		double FrqX = atof(GetFld(m_SelX,2));
		CString ctyX = GetFld(m_SelX,6);		ctyX.TrimRight();	ctyX.MakeUpper();
		CString stn_clsX = GetFld(m_SelX,3);	stn_clsX.TrimRight();	stn_clsX.MakeUpper();
		double FrqX1y = atof(GetFld(m_SelX,13));
		CString nameX = GetFld(m_SelX,5);		nameX.TrimRight();	nameX.MakeUpper();

		double HaglX = atof(GetFld(m_SelX,12));
		double AZ0X = atof(GetFld(m_SelX,15));
		double EL0X = atof(GetFld(m_SelX,16));
		CString ANT_NameX = GetFld(m_SelX,17);
		double  rH[360]  ,  rV[360];	int  f0[360];	CString antfile;
		antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_NameX);
		ReadAntennaData(antfile,f0,rH,rV) ;

		CString srvX;
		if(stn_clsX==_T("FX"))									srvX = _T("FX");
		else if((stn_clsX==_T("FB"))||(stn_clsX==_T("ML")))		srvX = _T("LM");

		CString m_SelA;
		if(FrqX>0)		m_SelA = OnAgreeMod1LMQ(ctyX,srvX,FrqX) ;
		else			m_SelA = OnAgreeMod1LMQ(ctyX,srvX,FrqX1y) ;

		if(m_SelA != _T(" "))
		{
			CString ctyA = GetFld(m_SelA,3);	ctyA.TrimRight();	ctyA.MakeUpper();
			ctyA.Replace("_",",");

			int L = ctyA.GetLength();
			CString c;
			int k = 0;
			for(int i=0;i<L;i++)
			{
				c = ctyA.Mid(i,1);
				if(c==",")	k++;
			}
			CString *ctyAs;		ctyAs = new CString[k+1];
			int contNUM = 0;
			for( i=0;i<k+1;i++)
			{
				c = GetFld(ctyA,i);	c.TrimRight();
				if(c!=ctyX)
				{
					ctyAs[contNUM] = c;		contNUM++;
				}
			}
			if(contNUM>0)
			{
				long Model = atol(GetFld(m_SelA,5));
				CString PropModels = GetFld(m_SelA,7);	PropModels.TrimRight();	PropModels.MakeUpper();
				
				CString strX,strY=_T(""),strY1=_T("");
				double pi = 4.0*atan(1.0);

				double LatX = atof(GetFld(m_SelX,8));
				double LonX = atof(GetFld(m_SelX,7));
				float LatXrad = (float)(LatX*pi/180.0);
				float LonXrad = (float)(LonX*pi/180.0);
				unsigned char LonLatXw[16];
				CRADDG4(&LonXrad, &LatXrad, (unsigned char *)LonLatXw);
				LonLatXw[15]=0;
				CString LonLatX = LonLatXw;
				CString LonXstr = LonLatX.Left(8);
				CString LatXstr = LonLatX.Mid(8,7);
				CString AgName = GetFld(m_SelA,2);	AgName.TrimRight();	AgName.MakeUpper();

				CString Categories = _T("");
				if(Model==1)				Categories = _Z("Frequency requiring coordination");
				else if(Model==2)			Categories = _Z("Preferential Frequency");

				CBorderRadiusDLG BorderRadiusDLG;
				BorderRadiusDLG.m_R = 200;
				if(BorderRadiusDLG.DoModal()!=IDOK)		return;

				double Dsearch = BorderRadiusDLG.m_R;
				double Continues = atof(GetFld(m_SelX,11));	//10Z

				//////////////////////////////////////////////////////////////////////////////
				if((Model==1)&&(stn_clsX=="ML"))
				{
					double PtGt_X = atof(GetFld(m_SelX,10));	//W
					PtGt_X = 10.0*log10(PtGt_X);

					CString Ptype = GetFld(m_SelX,11);
					double CBR = atof(GetFld(m_SelA,12));
					double PIFS = atof(GetFld(m_SelA,11));
					double ERP = atof(GetFld(m_SelA,13));
					if(PropModels==_T("FREE SPACE"))
					{
						CLoSDLG freedlg;
						freedlg.m_title = _Z("Free Space Model Parameters");
						freedlg.m_RxH = 10;
						if (freedlg.DoModal()==IDOK)
						{
							double HaglY = freedlg.m_RxH;
							double kfactor = freedlg.m_kfactor;

							double LatX0 = LatX , LonX0 = LonX;
							CString LatXstr0 = LatXstr , LonXstr0 = LonXstr;
							float LonXrad0 = LonXrad , LatXrad0 = LatXrad;
							for(int j=0; j<contNUM ; j++)
							{
								CBorderMLDLG BorderMLDLG;
								BorderMLDLG.m_Name = nameX;		BorderMLDLG.m_cty = ctyAs[j];
								BorderMLDLG.m_Lat = LatXstr0;	BorderMLDLG.m_Lon = LonXstr0;
								if(BorderMLDLG.DoModal()==IDOK)
								{
									int mobileFlag = BorderMLDLG.m_mobile;
									if(mobileFlag==2)
									{
										LatXstr0 = BorderMLDLG.m_Lat;	LonXstr0 = BorderMLDLG.m_Lon;
										unsigned char LonLatX[15];	strcpy((char *)LonLatX, LonXstr0 + LatXstr0);
										CDGRAD4(LonLatX, &LonXrad0, &LatXrad0);
										LatX0 = LatXrad0*180.0/pi;	LonX0 = LonXrad0*180.0/pi;
									}//if mobileFlag
									else if (mobileFlag==1)
									{
										double *Blat;	Blat = NULL;	double *Blon;	Blon = NULL;
										long numBorder;
										BorderCom2Cty(LatX0,LonX0,ctyAs[j],  &Blat, &Blon, &numBorder) ;
										double Radius = atof(GetFld(m_SelX,9));	//4D
										double latC,lonC, distC, MindistC = 999999999.000;
										for(int j1=0;j1<72;j1++)
										{
											reckon(LatX0,LonX0,Radius, j1*5.0 ,&latC,&lonC) ;
											float RLATc = (float)(latC*pi/180.0);
											float RLONc = (float)(lonC*pi/180.0);
											CString ctyC;
											GEOPLC(&RLONc, &RLATc, (BYTE*)ctyC.GetBufferSetLength(3)) ;
											for(int j2=0;j2<numBorder;j2++)
											{
												distC = Distance_km(latC,lonC , Blat[j2],Blon[j2]) ;
												if((distC<MindistC)&&(distC!=0)&&(ctyC==ctyX))
												{
													MindistC = distC;	LatX0 = latC;	LonX0 = lonC;
													LatXrad0 = LatX0*pi/180.0;	LonXrad0 = LonX0*pi/180.0;
													Rad2Str((float) LonXrad0,(float) LonXrad0,&LonXstr0,&LatXstr0) ;

												}//if distC
											}//for j2
										}//for j1
										if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
									}//else if mobileFlag

									strY1 = BorderM1LMFree(LatX0,LonX0,ctyX,FrqX,FrqX1y,stn_clsX, PtGt_X,ERP,Ptype,CBR,PIFS,ctyAs[j],Dsearch,
										HaglX, AZ0X, EL0X, f0,rH,rV, HaglY, kfactor) ;
									strY = strY+","+strY1;
								}//if BorderMLDLG
							}// for j contNUM
						}//if freedlg
					}// if PropModels = FREE SPACE

					else if(PropModels==_T("REC-1546"))
					{
						double kfactor, Pime, RxH, Plocation;
						int ENV,  syst , P1546Clangle , P1546landsea;
						CP1546DLG p1546dlg;
						if(Continues==0)	p1546dlg.m_time = 10;
						else				p1546dlg.m_time = 1;
						p1546dlg.m_RxH = 10;

						if(p1546dlg.DoModal()==IDOK)
						{
							Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
							kfactor = p1546dlg.m_k;		RxH = p1546dlg.m_RxH;
							syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
							P1546Clangle = p1546dlg.m_Clangle;		P1546landsea = p1546dlg.m_landsea;
							double HaglX = atof(GetFld(m_SelX,12));	//9Y

							double LatX0 = LatX , LonX0 = LonX;
							CString LatXstr0 = LatXstr , LonXstr0 = LonXstr;
							float LonXrad0 = LonXrad , LatXrad0 = LatXrad;
							for(int j=0; j<contNUM ; j++)
							{
								CBorderMLDLG BorderMLDLG;
								BorderMLDLG.m_Name = nameX;		BorderMLDLG.m_cty = ctyAs[j];
								BorderMLDLG.m_Lat = LatXstr0;	BorderMLDLG.m_Lon = LonXstr0;
								if(BorderMLDLG.DoModal()==IDOK)
								{
									int mobileFlag = BorderMLDLG.m_mobile;
									if(mobileFlag==2)
									{
										LatXstr0 = BorderMLDLG.m_Lat;	LonXstr0 = BorderMLDLG.m_Lon;
										unsigned char LonLatX[15];	strcpy((char *)LonLatX, LonXstr0 + LatXstr0);
										CDGRAD4(LonLatX, &LonXrad0, &LatXrad0);
										LatX0 = LatXrad0*180.0/pi;	LonX0 = LonXrad0*180.0/pi;
									}//if mobileFlag
									else if (mobileFlag==1)
									{
										double *Blat;	Blat = NULL;	double *Blon;	Blon = NULL;
										long numBorder;
										BorderCom2Cty(LatX0,LonX0,ctyAs[j],  &Blat, &Blon, &numBorder) ;
										double Radius = atof(GetFld(m_SelX,9));	//4D
										double latC,lonC, distC, MindistC = 999999999.000;
										for(int j1=0;j1<72;j1++)
										{
											reckon(LatX0,LonX0,Radius, j1*5.0 ,&latC,&lonC) ;
											float RLATc = (float)(latC*pi/180.0);
											float RLONc = (float)(lonC*pi/180.0);
											CString ctyC;
											GEOPLC(&RLONc, &RLATc, (BYTE*)ctyC.GetBufferSetLength(3)) ;
											for(int j2=0;j2<numBorder;j2++)
											{
												distC = Distance_km(latC,lonC , Blat[j2],Blon[j2]) ;
												if((distC<MindistC)&&(distC!=0)&&(ctyC==ctyX))
												{
													MindistC = distC;	LatX0 = latC;	LonX0 = lonC;
													LatXrad0 = LatX0*pi/180.0;	LonXrad0 = LonX0*pi/180.0;
													Rad2Str((float) LonXrad0,(float) LonXrad0,&LonXstr0,&LatXstr0) ;

												}//if distC
											}//for j2
										}//for j1
										if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
									}//else if mobileFlag

									OnDatabaseStationsindesktop2(LatX0,LonX0);
									double HaslX = LatLon2Hg(LatX0,LonX0);
									double HasglX = HaslX+HaglX;
									int p = LandWarmColdSea(LonX0, LatX0);

									strY1 = BorderM1LMP1546(LatX0,LonX0,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X,ERP,
												Ptype,CBR,PIFS,ctyAs[j],HasglX, kfactor, Pime,RxH,Plocation,
												ENV, syst,P1546Clangle ,P1546landsea, p,Dsearch,
											HaglX, AZ0X, EL0X, f0,rH,rV);
 
									strY = strY+","+strY1;
								}//if BorderMLDLG
							}// for j contNUM
						}// if p1546dlg
					}// if PropModels = REC-1546
				}// if Model=1 stn_clsX=ML
				//////////////////////////////////////////////////////////////////////////////
				else if((Model==2)&&(stn_clsX=="ML"))
				{
					double PtGt_X = atof(GetFld(m_SelX,10));	//W
					PtGt_X = 10.0*log10(PtGt_X);

					CString Ptype = GetFld(m_SelX,11);
					double XKM = atof(GetFld(m_SelA,12));
					double PIFS = atof(GetFld(m_SelA,11));
					double ERP = atof(GetFld(m_SelA,13));

					CString PrefCountries = GetFld(m_SelA,10);
					BOOL L1 = BorderISPrefCountries(PrefCountries,ctyX) ;
					if(L1==0)
					{
						CString strErr;
						strErr.Format(_Z("Country '' %s '' has not PREFERENTIAL RIGHT.\t\n"),ctyX);
						MessageBox(strErr,_Z("Warning!!!"),MB_ICONWARNING);
					}
					else
					{
						if(PropModels==_T("FREE SPACE"))
						{
							CLoSDLG freedlg;
							freedlg.m_title = _Z("Free Space Model Parameters");
							freedlg.m_RxH = 10;
							if (freedlg.DoModal()==IDOK)
							{
								double HaglY = freedlg.m_RxH;
								double kfactor = freedlg.m_kfactor;

								double LatX0 = LatX , LonX0 = LonX;
								CString LatXstr0 = LatXstr , LonXstr0 = LonXstr;
								float LonXrad0 = LonXrad , LatXrad0 = LatXrad;
								for(int j=0; j<contNUM ; j++)
								{
									CBorderMLDLG BorderMLDLG;
									BorderMLDLG.m_Name = nameX;		BorderMLDLG.m_cty = ctyAs[j];
									BorderMLDLG.m_Lat = LatXstr0;	BorderMLDLG.m_Lon = LonXstr0;
									if(BorderMLDLG.DoModal()==IDOK)
									{
										int mobileFlag = BorderMLDLG.m_mobile;
										if(mobileFlag==2)
										{
											LatXstr0 = BorderMLDLG.m_Lat;	LonXstr0 = BorderMLDLG.m_Lon;
											unsigned char LonLatX[15];	strcpy((char *)LonLatX, LonXstr0 + LatXstr0);
											CDGRAD4(LonLatX, &LonXrad0, &LatXrad0);
											LatX0 = LatXrad0*180.0/pi;	LonX0 = LonXrad0*180.0/pi;
										}//if mobileFlag
										else if (mobileFlag==1)
										{
											double *Blat;	Blat = NULL;	double *Blon;	Blon = NULL;
											long numBorder;
											BorderCom2Cty(LatX0,LonX0,ctyAs[j],  &Blat, &Blon, &numBorder) ;
											double Radius = atof(GetFld(m_SelX,9));	//4D
											double latC,lonC, distC, MindistC = 999999999.000;
											for(int j1=0;j1<72;j1++)
											{
												reckon(LatX0,LonX0,Radius, j1*5.0 ,&latC,&lonC) ;
												float RLATc = (float)(latC*pi/180.0);
												float RLONc = (float)(lonC*pi/180.0);
												CString ctyC;
												GEOPLC(&RLONc, &RLATc, (BYTE*)ctyC.GetBufferSetLength(3)) ;
												for(int j2=0;j2<numBorder;j2++)
												{
													distC = Distance_km(latC,lonC , Blat[j2],Blon[j2]) ;
													if((distC<MindistC)&&(distC!=0)&&(ctyC==ctyX))
													{
														MindistC = distC;	LatX0 = latC;	LonX0 = lonC;
														LatXrad0 = LatX0*pi/180.0;	LonXrad0 = LonX0*pi/180.0;
														Rad2Str((float) LonXrad0,(float) LonXrad0,&LonXstr0,&LatXstr0) ;

													}//if distC
												}//for j2
											}//for j1
											if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
										}//else if mobileFlag

										strY1 = BorderM2LMFree(LatX0,LonX0,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X, ERP,Ptype,XKM,PIFS,ctyAs[j],Dsearch,
										HaglX, AZ0X, EL0X, f0,rH,rV, HaglY, kfactor);

										strY = strY+","+strY1;
									}//if BorderMLDLG
								}// for j contNUM
							}//if freedlg
						}// if PropModels = FREE SPACE
						else if(PropModels==_T("REC-1546"))
						{
							double kfactor, Pime, RxH, Plocation;
							int ENV,  syst , P1546Clangle , P1546landsea;
							CP1546DLG p1546dlg;
							if(Continues==0)	p1546dlg.m_time = 10;
							else				p1546dlg.m_time = 1;
							p1546dlg.m_RxH = 10;
							if(p1546dlg.DoModal()==IDOK)
							{
								Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
								kfactor = p1546dlg.m_k;		RxH = p1546dlg.m_RxH;
								syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
								P1546Clangle = p1546dlg.m_Clangle;		P1546landsea = p1546dlg.m_landsea;
//???????????????			//	double HaglX = atof(GetFld(m_SelX,18));	//4Z
								double HaglX = atof(GetFld(m_SelX,12));	//9Y

								double LatX0 = LatX , LonX0 = LonX;
								CString LatXstr0 = LatXstr , LonXstr0 = LonXstr;
								float LonXrad0 = LonXrad , LatXrad0 = LatXrad;
								for(int j=0; j<contNUM ; j++)
								{
									CBorderMLDLG BorderMLDLG;
									BorderMLDLG.m_Name = nameX;		BorderMLDLG.m_cty = ctyAs[j];
									BorderMLDLG.m_Lat = LatXstr0;	BorderMLDLG.m_Lon = LonXstr0;
									if(BorderMLDLG.DoModal()==IDOK)
									{
										int mobileFlag = BorderMLDLG.m_mobile;
										if(mobileFlag==2)
										{
											LatXstr0 = BorderMLDLG.m_Lat;	LonXstr0 = BorderMLDLG.m_Lon;
											unsigned char LonLatX[15];	strcpy((char *)LonLatX, LonXstr0 + LatXstr0);
											CDGRAD4(LonLatX, &LonXrad0, &LatXrad0);
											LatX0 = LatXrad0*180.0/pi;	LonX0 = LonXrad0*180.0/pi;
										}//if mobileFlag
										else if (mobileFlag==1)
										{
											double *Blat;	Blat = NULL;	double *Blon;	Blon = NULL;
											long numBorder;
											BorderCom2Cty(LatX0,LonX0,ctyAs[j],  &Blat, &Blon, &numBorder) ;
											double Radius = atof(GetFld(m_SelX,9));	//4D
											double latC,lonC, distC, MindistC = 999999999.000;
											for(int j1=0;j1<72;j1++)
											{
												reckon(LatX0,LonX0,Radius, j1*5.0 ,&latC,&lonC) ;
												float RLATc = (float)(latC*pi/180.0);
												float RLONc = (float)(lonC*pi/180.0);
												CString ctyC;
												GEOPLC(&RLONc, &RLATc, (BYTE*)ctyC.GetBufferSetLength(3)) ;
												for(int j2=0;j2<numBorder;j2++)
												{
													distC = Distance_km(latC,lonC , Blat[j2],Blon[j2]) ;
													if((distC<MindistC)&&(distC!=0)&&(ctyC==ctyX))
													{
														MindistC = distC;	LatX0 = latC;	LonX0 = lonC;
														LatXrad0 = LatX0*pi/180.0;	LonXrad0 = LonX0*pi/180.0;
														Rad2Str((float) LonXrad0,(float) LonXrad0,&LonXstr0,&LatXstr0) ;

													}//if distC
												}//for j2
											}//for j1
											if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
										}//else if mobileFlag

										OnDatabaseStationsindesktop2(LatX0,LonX0);
										double HaslX = LatLon2Hg(LatX0,LonX0);
										double HasglX = HaslX+HaglX;
										int p = LandWarmColdSea(LonX0, LatX0);

										strY1 = BorderM2LMP1546(LatX0,LonX0,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X,ERP,
													Ptype,XKM,PIFS, ctyAs[j],HasglX, kfactor, Pime,RxH, Plocation,
													ENV,syst,P1546Clangle ,P1546landsea, p,Dsearch,
													HaglX, AZ0X, EL0X, f0,rH,rV);

										strY = strY+","+strY1;
									}//if BorderMLDLG
								}// for j contNUM
							}// if p1546dlg
						}// if PropModels = REC-1546
					}// if L1
				}// if Model=2 stn_clsX=ML
				//////////////////////////////////////////////////////////////////////////////
				else if((Model==1)&&((stn_clsX=="FB")||((stn_clsX=="FX")&&(FrqX<1000.0))))
				{
					double PtGt_X = atof(GetFld(m_SelX,10));	//W
					PtGt_X = 10.0*log10(PtGt_X);

					CString Ptype = GetFld(m_SelX,11);
					double CBR = atof(GetFld(m_SelA,12));
					double PIFS = atof(GetFld(m_SelA,11));
					double ERP = atof(GetFld(m_SelA,13));

					if(PropModels==_T("FREE SPACE"))
					{
						CLoSDLG freedlg;
						freedlg.m_title = _Z("Free Space Model Parameters");
						freedlg.m_RxH = 10;
						if (freedlg.DoModal()==IDOK)
						{
							double HaglY = freedlg.m_RxH;
							double kfactor = freedlg.m_kfactor;

							for(int j=0; j<contNUM ; j++)
							{
								strY1 = BorderM1LMFree(LatX,LonX,ctyX,FrqX,FrqX1y,stn_clsX, PtGt_X,ERP,Ptype,CBR,PIFS,ctyAs[j],Dsearch,
									 HaglX, AZ0X, EL0X, f0,rH,rV, HaglY, kfactor);

								strY = strY+","+strY1;
							}// for j contNUM
						}//if  freedlg

					}// if PropModels FREE SPACE

					if(PropModels==_T("REC-1546"))
					{
						double kfactor, Pime, RxH, Plocation;
						int ENV,  syst , P1546Clangle , P1546landsea;
						CP1546DLG p1546dlg;
						if(Continues==0)	p1546dlg.m_time = 10;
						else				p1546dlg.m_time = 1;
						p1546dlg.m_RxH = 10;
						if(p1546dlg.DoModal()==IDOK)
						{
							Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
							kfactor = p1546dlg.m_k;		RxH = p1546dlg.m_RxH;
							syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
							P1546Clangle = p1546dlg.m_Clangle;		P1546landsea = p1546dlg.m_landsea;

							OnDatabaseStationsindesktop2(LatX,LonX);
							double HaglX = atof(GetFld(m_SelX,12));	//9Y
							double HaslX = LatLon2Hg(LatX,LonX);
							double HasglX = HaslX+HaglX;
							int p = LandWarmColdSea(LonX, LatX);

							for(int j=0; j<contNUM ; j++)
							{
								strY1 = BorderM1LMP1546(LatX,LonX,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X,ERP,
											Ptype,CBR,PIFS,ctyAs[j],HasglX, kfactor, Pime,RxH,Plocation,
											ENV, syst,P1546Clangle ,P1546landsea, p,Dsearch,
									HaglX, AZ0X, EL0X, f0,rH,rV);

								strY = strY+","+strY1;
							}// for j contNUM
						}// if p1546dlg
					}// if PropModels  REC-1546
				}// if Model 1 stn_clsX=FB
				//////////////////////////////////////////////////////////////////////////////
				else if((Model==2)&&((stn_clsX=="FB")||((stn_clsX=="FX")&&(FrqX<1000.0))))
				{
					double PtGt_X = atof(GetFld(m_SelX,10));	//W
					PtGt_X = 10.0*log10(PtGt_X);

					CString Ptype = GetFld(m_SelX,11);
					double XKM = atof(GetFld(m_SelA,12));
					double PIFS = atof(GetFld(m_SelA,11));
					double ERP = atof(GetFld(m_SelA,13));

					CString PrefCountries = GetFld(m_SelA,10);
					BOOL L1 = BorderISPrefCountries(PrefCountries,ctyX) ;
					if(L1==0)
					{
						CString strErr;
						strErr.Format(_Z("Country '' %s '' has not PREFERENTIAL RIGHT.\t\n"),ctyX);
						for(int j=0; j<contNUM ; j++)
							strErr = strErr + BorderM2noPF( LatX, LonX, ctyAs[j], Dsearch);
						MessageBox(strErr,_Z("Warning!!!"),MB_ICONWARNING);
					}
					else
					{
						if(PropModels==_T("FREE SPACE"))
						{
							CLoSDLG freedlg;
							freedlg.m_title = _Z("Free Space Model Parameters");
							freedlg.m_RxH = 10;
							if (freedlg.DoModal()==IDOK)
							{
								double HaglY = freedlg.m_RxH;
								double kfactor = freedlg.m_kfactor;

								for(int j=0; j<contNUM ; j++)
								{
									strY1 = BorderM2LMFree(LatX,LonX,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X, ERP,Ptype,XKM,PIFS,ctyAs[j],Dsearch,
										HaglX, AZ0X, EL0X, f0,rH,rV, HaglY, kfactor);
									strY = strY+","+strY1;
								}
							}//if (freedlg

						}
						if(PropModels==_T("REC-1546"))
						{
							double kfactor, Pime, RxH, Plocation;
							int ENV,  syst , P1546Clangle , P1546landsea;
							CP1546DLG p1546dlg;
							if(Continues==0)	p1546dlg.m_time = 10;
							else				p1546dlg.m_time = 1;
							p1546dlg.m_RxH = 10;
							if(p1546dlg.DoModal()==IDOK)
							{
								Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
								kfactor = p1546dlg.m_k;		RxH = p1546dlg.m_RxH;
								syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
								P1546Clangle = p1546dlg.m_Clangle;	P1546landsea = p1546dlg.m_landsea;

								OnDatabaseStationsindesktop2(LatX,LonX);
								double HaglX = atof(GetFld(m_SelX,12));	//9Y
								double HaslX = LatLon2Hg(LatX,LonX);
								double HasglX = HaslX+HaglX;
								int p = LandWarmColdSea(LonX, LatX);
								for(int j=0; j<contNUM ; j++)
								{
									strY1 = BorderM2LMP1546(LatX,LonX,ctyX,FrqX,FrqX1y,stn_clsX,PtGt_X,ERP,Ptype,XKM,
													PIFS, ctyAs[j],HasglX, kfactor, Pime,RxH, Plocation,ENV,
													syst,P1546Clangle ,P1546landsea, p,Dsearch,
									HaglX, AZ0X, EL0X, f0,rH,rV);

									strY = strY+","+strY1;
								}//for j contNUM

							}//	if p1546dlg
						}// if PropModels = REC-1546
					}//if L1

				}// else if Model 2 FB
				//////////////////////////////////////////////////////////////////////////////
				else if((Model==1)&&(srvX=="FX")&&(FrqX>=1000.0))
				{
					double Hasl = atof(GetFld(m_SelX,14));	//4Z
					double Hagl = atof(GetFld(m_SelX,12));	//9Y

					double h = Hasl + Hagl;
				//	CString TxRx = GetFld(m_SelX,5);
//??????????????????????????????????????????????????????????????????????????

					double cord1 = atof(GetFld(m_SelA,14));
					double cord2 = atof(GetFld(m_SelA,15));
					if(FrqX>0)
					for(int j=0; j<contNUM ; j++)
					{
						strY1 = BorderM1FX1G( LatX, LonX, ctyX, FrqX, ctyAs[j], _T("TX"), h, cord1, cord2 , Dsearch); 
						strY = strY+","+strY1;
					}// for j contNUM
					if(FrqX1y>0)
					for(int j=0; j<contNUM ; j++)
					{
						strY1 = BorderM1FX1G( LatX, LonX, ctyX, FrqX1y, ctyAs[j], _T("RX"), h, cord1, cord2 , Dsearch); 
						strY = strY+","+strY1;
					}// for j contNUM

				}// else if Model 1 FX>1GHz

				strY.Delete(0);
				if(strY.Left(1)==_T(","))
					strY.Delete(0);

				strX.Format("%ld,%s,%s,%s,%s  %s,%s,%s",IDX,nameX,stn_clsX,ctyX,LonXstr,LatXstr,AgName,Categories);
		
				if(!(strY.IsEmpty()))
				{
					CBorderRep1DLG dlgList;
					dlgList.m_editX = strX;
					dlgList.m_rowsY = contNUM*((FrqX>0)+(FrqX1y>0))+1;
					dlgList.m_editY = strY;
				
					if((Model==1)&&(srvX=="FX")&&(FrqX>=1000.0))	dlgList.m_mode = 3;
					else if(Model==2)								dlgList.m_mode = 2;
					else											dlgList.m_mode = 1;
					dlgList.DoModal();
				}
			}// if contNUM>0
			delete [] ctyAs;
		}//if m_SelA
	}//if m_SelX
	EndWaitCursor();
}

CString CSMS4DCView::BorderM1FX1G(double LatX,double LonX,CString ctyX,double FrqX,CString ctyA,CString TxRx,
								 double h,double cord1,double cord2,double Dsearch) 
{
	double CordDist;
	if(h<=300.0)	CordDist = cord1;
	else			CordDist = cord2;
	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;

	double dist;
	double MinLat ,MinLon , Mindist =  9999999.999;

//	double Mindist = Distance_km(LatX,LonX , Blat[0],Blon[0]);
//	double MinLat = Blat[0];
//	double MinLon = Blon[0];
//	for(int i=1;i<numBorder;i++)
	for(int i=0;i<numBorder;i++)
	{
		dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
		if(dist<Mindist)
		{
			MinLat = Blat[i];	MinLon = Blon[i];	Mindist = dist;
		}
	}
	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}

//	CString Affected = _T("---");
//	if(Mindist<CordDist)
//		Affected = _T("+++");

	CString RLONb, RLATb, strY = _T("");

	double pi = 4.0*atan(1.0);
	MinLon = MinLon*pi/180.0;
	MinLat = MinLat*pi/180.0;
	Rad2Str(MinLon,MinLat, &RLONb,&RLATb);

	if(Mindist != 9999999.999)
		strY.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.1f",FrqX,TxRx,ctyA,Mindist,RLONb, RLATb,CordDist);
	else
		strY.Format("%0.4f,%s,%s,---  >%0.3f,%s  %s,%0.1f",FrqX,TxRx,ctyA,Dsearch,_T("---"), _T("---"),CordDist);
	return strY;
}

CString CSMS4DCView::BWCode(float BW)
{
	int i;
	CString Temp;
	BW*=1000;
	char Code;
	if(BW<1000)					{						Code='H';	}
	if(BW>=1000. && BW<1e+6)	{		BW/=1000.;		Code='K';	}
	if(BW>=1e+6  && BW<1e+9)	{		BW/=1e+6;		Code='M';	}
	if(BW>=1e+9  && BW<1e+12)	{		BW/=1e+9;		Code='G';	}
	int IPart=(int)BW;
	float FPart2=BW-IPart;
	char FP[10], tt[20];
	sprintf(FP,"%.3f",FPart2);
	strcpy(tt,FP+2);

	if(IPart)
	{
		if(FPart2)	Temp.Format("%d%c%s",IPart,Code,tt);
		else		Temp.Format("%d%c",IPart,Code);
	}
	else			Temp.Format("%c%s",Code,tt);

	for(i=Temp.GetLength();i<4;i++)
		Temp+="0";
	Temp=Temp.Left(4);
	return Temp;
}

double CSMS4DCView::E_P1546(double latST,double lonST,double lat0,double lon0,
						  double HasglST, double f_MHz,double PtGtSTw, double kfactor,
						  double Pime,double RxH,int ENV,int syst,double Plocation,
						  int P1546Clangle , int P1546landsea,int p)
{
	CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument();

	double dist , az , h1,lat3km  , lon3km , lat15km , lon15km,DseaW , DSea , Dland , DseaC ;
	double pi=4.0*atan(1.0)  ,  rearth=6371.0 , Ghv = 1;
	double tetai , mds , ds , tetamax15 = 0 , hi;	
	double StepRes , m_ZoomFactor = 1;
	double azI , mdz , dz , tetamax16 , hii,hir,ttca,corr_ca = 0;	
	double Eb , Ebfs,ELand,EfsLand,ESea,EfsSea,delta,deltafs,deltaE,deltaEfs,alpha,beta,XX;
	double E_sea_total,Efs_sea_total,Emix,Efsmix,E_Land_total,Efs_Land_total;
	CP1546_Functions CP1546;

	dist = Distance_km(latST,lonST,lat0,lon0);
	dist = max(dist,0.00001);
	az = Azimuth_Deg(latST,lonST,lat0,lon0);
	OnDatabaseStationsindesktop2(latST,lonST);
	/////////////////////////////// h1 (Heff) ///////////////////////////////////////////////
	if (dist>=15.0)
	{
		reckon( latST,lonST,  3.0 , az , &lat3km  , &lon3km) ;
		reckon( latST,lonST, 15.0 , az , &lat15km , &lon15km) ;
		h1 = HasglST - Points2HgAvr1(lat3km  , lon3km,lat15km , lon15km);
	}
	else
	{
		reckon( latST,lonST, 0.2*dist , az , &lat3km  , &lon3km) ;
		reckon( latST,lonST,     dist , az , &lat15km , &lon15km) ;
		h1 = HasglST - Points2HgAvr1(lat3km  , lon3km,lat15km , lon15km);
	}
	///////////////////////////////// tetamax15 /////////////////////////////////////////////
	StepRes = 1.0/m_ZoomFactor;
	CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
	if (pDoc->TileInfo != globeTileInfo)
		StepRes = (pDoc->m_Resolution_x/1000.0)/m_ZoomFactor;
	
	if (h1<0.0)
	{
		tetai=-pi/2.0;
		mds=m_ZoomFactor*min(dist,15.0);
		ds=0.0;
		while( ds< mds )  //ds=0->15
		{
			ds = ds+StepRes;
			reckon( latST,lonST, ds , az , &lat15km , &lon15km) ;
			hi = LatLon2Hg(lat15km , lon15km) ;
			tetai=max(tetai   ,(((hi-HasglST)/(ds*1000))-(ds/(2.0*kfactor*rearth))));
		}
		tetamax15 = (180.0/pi)*tetai;
	}
	/////////////////////////////////Rx ttca /////////////////////////////////////////////
	if (P1546Clangle==1)
	{
		OnDatabaseStationsindesktop2(lat0,lon0);
		hir = LatLon2Hg(lat0,lon0) ;
		azI=Azimuth_Deg(lat0,lon0,latST,lonST);
		mdz=m_ZoomFactor*min(dist,16.0);
		tetamax16=-pi/2.0;
		dz=0.0;
		while( dz< mdz )  //dz=0->16
		{
			dz=dz+StepRes;
			reckon(lat0,lon0, dz , azI , &lat15km , &lon15km) ;
			hii = LatLon2Hg(lat15km , lon15km) ;
			tetamax16=max(tetamax16   ,(((hii-10.0-hir)/(dz*1000))-(dz/(2.0*kfactor*rearth))));
		}
		ttca = tetamax16*(180.0/pi);
		corr_ca = TCAcorr1546(ttca,f_MHz);
	}
	//////////////////////////////////////////////////////////////////////////////
	if (P1546landsea==1)
	{
		DSea = D_Sea_kmIDWM(latST,lonST,lat0,lon0, &DseaW);
		Dland = dist - DSea;
		DseaC = DSea - DseaW;
		if (Dland==dist)		Eb = CP1546.P1546_8(f_MHz,Pime,1,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Ebfs);
		else if (DseaC==dist)	Eb = CP1546.P1546_8(f_MHz,Pime,2,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Ebfs);
		else if (DseaW==dist)	Eb = CP1546.P1546_8(f_MHz,Pime,3,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Ebfs);
		else
		{
			if (Dland<1.0)
			{
				ELand = CP1546.P1546_8(f_MHz,Pime,1,h1,1.0,RxH,ENV,tetamax15,syst,Plocation,&EfsLand);
				ESea  = CP1546.P1546_8(f_MHz,Pime,3,h1,1.0,RxH,ENV,tetamax15,syst,Plocation,&EfsSea);
				delta = Dland * (ELand - ESea);
				deltafs = Dland * (EfsLand - EfsSea);
			}
			else if (Dland>=1.0)
			{
				ELand = CP1546.P1546_8(f_MHz,Pime,1,h1,Dland,RxH,ENV,tetamax15,syst,Plocation,&EfsLand);
				ESea  = CP1546.P1546_8(f_MHz,Pime,3,h1,Dland,RxH,ENV,tetamax15,syst,Plocation,&EfsSea);
				delta = ELand - ESea;
				deltafs = EfsLand - EfsSea;
			}

			E_sea_total  = CP1546.P1546_8(f_MHz,Pime,3,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Efs_sea_total);
			Emix = E_sea_total + delta;
			Efsmix = Efs_sea_total + deltafs;

			E_Land_total  = CP1546.P1546_8(f_MHz,Pime,1,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Efs_Land_total);
			deltaE = Emix - E_Land_total;
			deltaEfs = Efsmix - Efs_Land_total;

			alpha = 0.3;      beta=0.0001;
			XX = alpha + (1.0 - alpha) * exp(-(beta *    pow( Dland , (2.42-0.0003527*h1) )    ));
			Eb = E_Land_total + deltaE * XX;
			Ebfs = Efs_Land_total + deltaEfs * XX;
		}
	}
	else
		Eb = CP1546.P1546_8(f_MHz,Pime,p,h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Ebfs);

	Eb = Eb + corr_ca;	Eb = min(Eb,Ebfs);
	Eb = Eb + 10.0*log10(PtGtSTw*Ghv/1650.0);
	return Eb;	//dBuV/m
}
double CSMS4DCView::TCAcorr1546(double Tdeg,double f_MHz)
{
	Tdeg=min(max(Tdeg , -0.8) ,40.0);
	double v = 0.065 * Tdeg * sqrt(f_MHz);
	double v01 = v - 0.1;
	double Jv = 6.9 + 20.0 * log10( sqrt(1+v01*v01) + v01 );
	double vp = 0.036 * sqrt(f_MHz);
	double vp01 = vp - 0.1;
	double Jvp = 6.9 + 20.0 *log10( sqrt(1+vp01*vp01) + vp01 );
	double Corr = Jvp - Jv;
	return Corr;
}

BOOL CSMS4DCView::PeekAndPump()
{
	static MSG msg;
	while (::PeekMessage(&msg,NULL,0,0,PM_NOREMOVE))
	{
		if (!AfxGetApp()->PumpMessage())
		{
			::PostQuitMessage(0);
			return FALSE;
		}	
	}
	return TRUE;
}

CString CSMS4DCView::BorderM2LMFree(double LatX,double LonX,CString ctyX,double FrqX,double FrqX1y,
									CString stn_clsX,double PtGtX,double ERP,CString Ptype,double XKM,
									double PIFS,CString ctyA,double Dsearch,
									double HaglX, double AZ0X, double EL0X, int f0[], double rH[], double rV[], double HaglY, double kfactor) 
{
	BeginWaitCursor();
	ctyX.TrimRight();		ctyX.MakeUpper();
	stn_clsX.TrimRight();	stn_clsX.MakeUpper();
	Ptype.TrimRight();		Ptype.MakeUpper();

//	double pi = 4.0*atan(1.0);
	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;

	//////////////////////////XKM//////////////////////////////////
	double *XKMlat;	XKMlat = NULL;
	double *XKMlon;	XKMlon = NULL;
	long numXKM;
	BorderXKM_Vector(XKM,ctyA,Blat,Blon, numBorder,&XKMlat,&XKMlon,&numXKM) ;

	CString strY="",strY1="";
	if(FrqX>0)
	{
		double PtGt_X = PtGtX;	//dBw
		if(Ptype=="I")
			PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double DistB = 0, EfsB , EfsBmax = -9999999.999 , Ghv = 1 , dist;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;

		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
			if(dist<=Dsearch)
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,Blat[i],Blon[i],  HaglY, kfactor);

				EfsB = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsB = 120.0+20.0*(log10(EfsB));
				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistXKM =0 ,EfsXKM , EfsXKMmax = -9999999.999;
		CString RLONXKM, RLATXKM;
		double XKMlat_rad,XKMlon_rad , XKMlat_deg,XKMlon_deg;
		for( i=0;i<numXKM;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , XKMlat[i],XKMlon[i]) ;
			if(dist<=(Dsearch+XKM))
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,XKMlat[i],XKMlon[i],  HaglY, kfactor);

				EfsXKM = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsXKM = 120.0+20.0*(log10(EfsXKM));
				if(EfsXKM>EfsXKMmax)
				{
					EfsXKMmax = EfsXKM;
					XKMlat_deg = XKMlat[i];
					XKMlon_deg = XKMlon[i];
					DistXKM = dist;
				}//if EfsXKM
			}
		}//numXKM

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		XKMlat_rad = XKMlat_deg*pi/180.0;	XKMlon_rad = XKMlon_deg*pi/180.0;
		Rad2Str(XKMlon_rad,XKMlat_rad, &RLONXKM,&RLATXKM);

		CString Affected = _T("+++");
		if(EfsXKMmax<PIFS)
			Affected = _T("---");

		if((EfsBmax != -9999999.999)&&(EfsXKMmax != -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsXKMmax,RLONXKM,RLATXKM,DistXKM,PIFS,XKM);
		else if((EfsBmax != -9999999.999)&&(EfsXKMmax == -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,XKM);
		else
			strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,XKM);

		strY = strY+","+strY1;
	}
	if(FrqX1y>0)
	{
		double PtGt_X = ERP;	//dBw
	//	if(Ptype=="I")
	//		PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double DistB = 0, EfsB , EfsBmax = -9999999.999 , Ghv = 1 , dist;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;

		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
			if(dist<=Dsearch)
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, Blat[i],Blon[i],  HaglY, kfactor);

				EfsB = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsB = 120.0+20.0*(log10(EfsB));
				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistXKM =0 ,EfsXKM , EfsXKMmax = -9999999.999;
		CString RLONXKM, RLATXKM;
		double XKMlat_rad,XKMlon_rad , XKMlat_deg,XKMlon_deg;
		for( i=0;i<numXKM;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , XKMlat[i],XKMlon[i]) ;
			if(dist<=(Dsearch+XKM))
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, XKMlat[i],XKMlon[i],  HaglY, kfactor);

				EfsXKM = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsXKM = 120.0+20.0*(log10(EfsXKM));
				if(EfsXKM>EfsXKMmax)
				{
					EfsXKMmax = EfsXKM;
					XKMlat_deg = XKMlat[i];
					XKMlon_deg = XKMlon[i];
					DistXKM = dist;
				}//if EfsXKM
			}
		}//numXKM

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		XKMlat_rad = XKMlat_deg*pi/180.0;	XKMlon_rad = XKMlon_deg*pi/180.0;
		Rad2Str(XKMlon_rad,XKMlat_rad, &RLONXKM,&RLATXKM);

		CString Affected = _T("+++");
		if(EfsXKMmax<PIFS)
			Affected = _T("---");

		if((EfsBmax != -9999999.999)&&(EfsXKMmax != -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsXKMmax,RLONXKM,RLATXKM,DistXKM,PIFS,XKM);
		else if((EfsBmax != -9999999.999)&&(EfsXKMmax == -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,XKM);
		else
			strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,XKM);

		strY = strY+","+strY1;
	}
	strY.Delete(0);

	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
	if(numXKM>0)	{XKMlat = NULL; delete [] XKMlat;	XKMlon = NULL; delete [] XKMlon;	}
	
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
	return strY;
}

CString CSMS4DCView::BorderM2LMP1546(double LatX,double LonX,CString ctyX,double FrqX,double FrqX1y,
									  CString stn_clsX,double PtGtX,double ERP,CString Ptype,double XKM,
									  double PIFS, CString ctyA,double HasglX, double kfactor, double Pime,
									  double RxH, double Plocation,int ENV, int syst,int P1546Clangle ,
									  int P1546landsea, int p,double Dsearch,
									double HaglX, double AZ0X, double EL0X, int f0[], double rH[], double rV[]) 
{
	double HaglY = RxH;
	
	BeginWaitCursor();
	ctyX.TrimRight();		ctyX.MakeUpper();
	stn_clsX.TrimRight();	stn_clsX.MakeUpper();
	Ptype.TrimRight();		Ptype.MakeUpper();

//	double pi = 4.0*atan(1.0);
	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;
	//////////////////////////XKM//////////////////////////////////
	double *XKMlat;	XKMlat = NULL;
	double *XKMlon;	XKMlon = NULL;
	long numXKM;
	BorderXKM_Vector(XKM,ctyA,Blat,Blon, numBorder,&XKMlat,&XKMlon,&numXKM) ;

LoadIDWMmap_r(LatX,LonX, Dsearch+XKM);

	CString strY="",strY1="";

	if(FrqX>0)
	{
		double PtGt_X = PtGtX;	//dBw
		if(Ptype=="I")
			PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double dist ,DistB =0 , EfsB , EfsBmax = -9999999.999;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;
		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]);
			if(dist<=Dsearch)
			{
				
//  EfsB = E_P1546(LatX,LonX , Blat[i],Blon[i], HasglX, FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsB = E_P1546_V05(LatX,LonX , Blat[i],Blon[i], HaglX,  FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, Blat[i],Blon[i],  HaglY, kfactor);
				EfsB = EfsB + 10.0*log10(Ghv);

				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistXKM =0 ,EfsXKM , EfsXKMmax = -9999999.999;
		CString RLONXKM, RLATXKM;
		double XKMlat_rad,XKMlon_rad , XKMlat_deg,XKMlon_deg;
		for( i=0;i<numXKM;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX ,XKMlat[i],XKMlon[i]);
			if(dist<=(Dsearch+XKM))
			{

//  EfsXKM = E_P1546(LatX,LonX , XKMlat[i],XKMlon[i], HasglX, FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsXKM = E_P1546_V05(LatX,LonX , XKMlat[i],XKMlon[i], HaglX,  FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, XKMlat[i],XKMlon[i],  HaglY, kfactor);
				EfsXKM = EfsXKM + 10.0*log10(Ghv);

				if(EfsXKM>EfsXKMmax)
				{
					EfsXKMmax = EfsXKM;
					XKMlat_deg = XKMlat[i];
					XKMlon_deg = XKMlon[i];
					DistXKM = dist;
				}//if EfsXKM
			}
		}//numXKM

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		XKMlat_rad = XKMlat_deg*pi/180.0;	XKMlon_rad = XKMlon_deg*pi/180.0;
		Rad2Str(XKMlon_rad,XKMlat_rad, &RLONXKM,&RLATXKM);

		CString				Affected = _T("+++");
		if(EfsXKMmax<PIFS)	Affected = _T("---");

		if     ((EfsBmax != -9999999.999)&&(EfsXKMmax != -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsXKMmax,RLONXKM,RLATXKM,DistXKM,PIFS,XKM);
		else if((EfsBmax != -9999999.999)&&(EfsXKMmax == -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,XKM);
		else											strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,XKM);
		strY = strY+","+strY1;
	}
	if(FrqX1y>0)
	{
		double PtGt_X = ERP;	//dBw
	//	if(Ptype=="I")
	//		PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double dist ,DistB =0 , EfsB , EfsBmax = -9999999.999;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;
		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]);
			if(dist<=Dsearch)
			{

//  EfsB = E_P1546(LatX,LonX , Blat[i],Blon[i], HasglX, FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsB = E_P1546_V05(LatX,LonX , Blat[i],Blon[i], HaglX,  FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, Blat[i],Blon[i],  HaglY, kfactor);
				EfsB = EfsB + 10.0*log10(Ghv);

				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistXKM =0 ,EfsXKM , EfsXKMmax = -9999999.999;
		CString RLONXKM, RLATXKM;
		double XKMlat_rad,XKMlon_rad , XKMlat_deg,XKMlon_deg;
		for( i=0;i<numXKM;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numXKM)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numXKM))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX ,XKMlat[i],XKMlon[i]);
			if(dist<=(Dsearch+XKM))
			{
				
//  EfsXKM = E_P1546(LatX,LonX , XKMlat[i],XKMlon[i], HasglX, FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsXKM = E_P1546_V05(LatX,LonX , XKMlat[i],XKMlon[i], HaglX,  FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, XKMlat[i],XKMlon[i],  HaglY, kfactor);
				EfsXKM = EfsXKM + 10.0*log10(Ghv);

				if(EfsXKM>EfsXKMmax)
				{
					EfsXKMmax = EfsXKM;
					XKMlat_deg = XKMlat[i];
					XKMlon_deg = XKMlon[i];
					DistXKM = dist;
				}//if EfsXKM
			}
		}//numXKM

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		XKMlat_rad = XKMlat_deg*pi/180.0;	XKMlon_rad = XKMlon_deg*pi/180.0;
		Rad2Str(XKMlon_rad,XKMlat_rad, &RLONXKM,&RLATXKM);

		CString             Affected = _T("+++");
		if(EfsXKMmax<PIFS)	Affected = _T("---");

		if     ((EfsBmax != -9999999.999)&&(EfsXKMmax != -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsXKMmax,RLONXKM,RLATXKM,DistXKM,PIFS,XKM);
		else if((EfsBmax != -9999999.999)&&(EfsXKMmax == -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,XKM);
		else											strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,XKM);
		strY = strY+","+strY1;
	}
	strY.Delete(0);

	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
	if(numXKM>0)	{XKMlat = NULL; delete [] XKMlat;	XKMlon = NULL; delete [] XKMlon;	}

	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
	return strY;
}

CString CSMS4DCView::BorderM1LMFree(double LatX,double LonX,CString ctyX,double FrqX,double FrqX1y,
									CString stn_clsX, double PtGtX,double ERP,CString Ptype,
									double CBR,double PIFS,CString ctyA,double Dsearch,
									double HaglX, double AZ0X, double EL0X, int f0[], double rH[], double rV[], double HaglY, double kfactor) 
{
	BeginWaitCursor();
	ctyX.TrimRight();		ctyX.MakeUpper();
	stn_clsX.TrimRight();	stn_clsX.MakeUpper();
	Ptype.TrimRight();		Ptype.MakeUpper();

//	double pi = 4.0*atan(1.0);
	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;
	//////////////////////////CBR//////////////////////////////////
	double *CBRlat;	CBRlat = NULL;
	double *CBRlon;	CBRlon = NULL;
	long numCBR;
	BorderCBR_Vector(LatX,LonX, CBR, ctyA, Blat,Blon, numBorder,&CBRlat,&CBRlon,&numCBR) ;

	CString strY="",strY1="";
	if(FrqX>0)
	{
		double PtGt_X = PtGtX;	//dBw
		if(Ptype=="I")
			PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double DistB = 0, EfsB , EfsBmax = -9999999.999 , Ghv = 1 , dist;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;

		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
			if(dist<=Dsearch)
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,	Blat[i],Blon[i],  HaglY, kfactor); 

				EfsB = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsB = 120.0+20.0*(log10(EfsB));
				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistCBR =0 ,EfsCBR , EfsCBRmax = -9999999.999;
		CString RLONcbr, RLATcbr;
		double CBRlat_rad,CBRlon_rad , CBRlat_deg,CBRlon_deg;
		for( i=0;i<numCBR;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , CBRlat[i],CBRlon[i]) ;
			if(dist<=(Dsearch+CBR))
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,	CBRlat[i],CBRlon[i],  HaglY, kfactor);
 
				EfsCBR = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsCBR = 120.0+20.0*(log10(EfsCBR));
				if(EfsCBR>EfsCBRmax)
				{
					EfsCBRmax = EfsCBR;
					CBRlat_deg = CBRlat[i];
					CBRlon_deg = CBRlon[i];
					DistCBR = dist;
				}//if EfsCBR
			}

		}//numCBR

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		CBRlat_rad = CBRlat_deg*pi/180.0;	CBRlon_rad = CBRlon_deg*pi/180.0;
		Rad2Str(CBRlon_rad,CBRlat_rad, &RLONcbr,&RLATcbr);

		CString Affected = _T("+++");
		if((EfsBmax<PIFS)&&(EfsCBRmax<PIFS))
			Affected = _T("---");

		if((EfsBmax != -9999999.999)&&(EfsCBRmax != -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsCBRmax,RLONcbr,RLATcbr,DistCBR,PIFS,CBR);
		else if((EfsBmax != -9999999.999)&&(EfsCBRmax == -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,CBR);
		else
			strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,CBR);

		strY = strY+","+strY1;
	}
	if(FrqX1y>0)
	{
		double PtGt_X = ERP;	//dBw
	//	if(Ptype=="I")
	//		PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double DistB = 0, EfsB , EfsBmax = -9999999.999 , Ghv = 1 , dist;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;

		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
			if(dist<=Dsearch)
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,	Blat[i],Blon[i],  HaglY, kfactor);

				EfsB = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsB = 120.0+20.0*(log10(EfsB));
				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}
		}//numBorder

		double DistCBR =0 ,EfsCBR , EfsCBRmax = -9999999.999;
		CString RLONcbr, RLATcbr;
		double CBRlat_rad,CBRlon_rad , CBRlat_deg,CBRlon_deg;
		for( i=0;i<numCBR;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , CBRlat[i],CBRlon[i]) ;
			if(dist<=(Dsearch+CBR))
			{
				Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV,	CBRlat[i],CBRlon[i],  HaglY, kfactor);

				EfsCBR = (sqrt(30.0*PtGt_X*Ghv))/(1000.0*dist);	
				EfsCBR = 120.0+20.0*(log10(EfsCBR));
				if(EfsCBR>EfsCBRmax)
				{
					EfsCBRmax = EfsCBR;
					CBRlat_deg = CBRlat[i];
					CBRlon_deg = CBRlon[i];
					DistCBR = dist;
				}//if EfsCBR
			}

		}//numCBR
		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		CBRlat_rad = CBRlat_deg*pi/180.0;	CBRlon_rad = CBRlon_deg*pi/180.0;
		Rad2Str(CBRlon_rad,CBRlat_rad, &RLONcbr,&RLATcbr);

		CString Affected = _T("+++");
		if((EfsBmax<PIFS)&&(EfsCBRmax<PIFS))
			Affected = _T("---");
	
		if((EfsBmax != -9999999.999)&&(EfsCBRmax != -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsCBRmax,RLONcbr,RLATcbr,DistCBR,PIFS,CBR);
		else if((EfsBmax != -9999999.999)&&(EfsCBRmax == -9999999.999))
			strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,CBR);
		else
			strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,CBR);

		strY = strY+","+strY1;
	}
	strY.Delete(0);
	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
	if(numCBR>0)	{CBRlat = NULL; delete [] CBRlat;	CBRlon = NULL; delete [] CBRlon;	}
	
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
	return strY;
}

CString CSMS4DCView::BorderM1LMP1546(double LatX,double LonX,CString ctyX,double FrqX,double FrqX1y,
									 CString stn_clsX,double PtGtX,double ERP,CString Ptype,double CBR,
									 double PIFS,CString ctyA,double HasglX, double kfactor, double Pime,
									 double RxH, double Plocation,int ENV, int syst,int P1546Clangle ,
									 int P1546landsea, int p,double Dsearch,
									double HaglX, double AZ0X, double EL0X, int f0[], double rH[], double rV[]) 
{
	double HaglY = RxH;

	BeginWaitCursor();
	ctyX.TrimRight();		ctyX.MakeUpper();
	stn_clsX.TrimRight();	stn_clsX.MakeUpper();
	Ptype.TrimRight();		Ptype.MakeUpper();

//	double pi = 4.0*atan(1.0);
	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;
	//////////////////////////CBR//////////////////////////////////
	double *CBRlat;	CBRlat = NULL;
	double *CBRlon;	CBRlon = NULL;
	long numCBR;
	BorderCBR_Vector(LatX,LonX, CBR, ctyA, Blat,Blon, numBorder,&CBRlat,&CBRlon,&numCBR);

LoadIDWMmap_r(LatX,LonX, Dsearch+CBR);

	CString strY="",strY1="";
	if(FrqX>0)
	{
		double PtGt_X = PtGtX;	//dBw
		if(Ptype=="I")
			PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double dist ,DistB =0 , EfsB , EfsBmax = -9999999.999;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;
		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]);
			if(dist<=Dsearch)
			{

//  EfsB = E_P1546(LatX,LonX , Blat[i],Blon[i], HasglX, FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsB = E_P1546_V05(LatX,LonX , Blat[i],Blon[i], HaglX,  FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, Blat[i],Blon[i],  HaglY, kfactor);
				EfsB = EfsB + 10.0*log10(Ghv);

				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}

		}//numBorder
		double DistCBR =0 , EfsCBR , EfsCBRmax = -9999999.999;
		CString RLONcbr, RLATcbr;
		double CBRlat_rad,CBRlon_rad , CBRlat_deg,CBRlon_deg;
		for( i=0;i<numCBR;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX ,CBRlat[i],CBRlon[i]);
			if(dist<=(Dsearch+CBR))
			{

//  EfsCBR = E_P1546(LatX,LonX , CBRlat[i],CBRlon[i], HasglX, FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsCBR = E_P1546_V05(LatX,LonX , CBRlat[i],CBRlon[i], HaglX,  FrqX,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, CBRlat[i],CBRlon[i],  HaglY, kfactor);
				EfsCBR = EfsCBR + 10.0*log10(Ghv);

				if(EfsCBR>EfsCBRmax)
				{
					EfsCBRmax = EfsCBR;
					CBRlat_deg = CBRlat[i];
					CBRlon_deg = CBRlon[i];
					DistCBR = dist;
				}//if EfsCBR
			}
		}//numCBR
		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		CBRlat_rad = CBRlat_deg*pi/180.0;	CBRlon_rad = CBRlon_deg*pi/180.0;
		Rad2Str(CBRlon_rad,CBRlat_rad, &RLONcbr,&RLATcbr);

		CString                                Affected = _T("+++");
		if((EfsBmax<PIFS)&&(EfsCBRmax<PIFS))   Affected = _T("---");
	
		if     ((EfsBmax != -9999999.999)&&(EfsCBRmax != -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsCBRmax,RLONcbr,RLATcbr,DistCBR,PIFS,CBR);
		else if((EfsBmax != -9999999.999)&&(EfsCBRmax == -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,CBR);
		else									        strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX,_T("Tx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,CBR);
		strY = strY+","+strY1;
	}
	if(FrqX1y>0)
	{
		double PtGt_X = ERP;	//dBw
//		if(Ptype=="I")
//			PtGt_X = PtGt_X - 2.1;

		PtGt_X = pow(10.0,PtGt_X/10.0);	//W

		double dist ,DistB =0 , EfsB , EfsBmax = -9999999.999;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;
		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]);
			if(dist<=Dsearch)
			{
				
//  EfsB = E_P1546(LatX,LonX , Blat[i],Blon[i], HasglX, FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsB = E_P1546_V05(LatX,LonX , Blat[i],Blon[i], HaglX,  FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, Blat[i],Blon[i],  HaglY, kfactor);
				EfsB = EfsB + 10.0*log10(Ghv);

				if(EfsB>EfsBmax)
				{
					EfsBmax = EfsB;
					Blat_deg = Blat[i];
					Blon_deg = Blon[i];
					DistB = dist;
				}//if EfsB
			}

		}//numBorder
		double DistCBR =0 , EfsCBR , EfsCBRmax = -9999999.999;
		CString RLONcbr, RLATcbr;
		double CBRlat_rad,CBRlon_rad , CBRlat_deg,CBRlon_deg;
		for( i=0;i<numCBR;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(100*(++progress_num)/(numBorder+numCBR)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((numBorder+numCBR))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX ,CBRlat[i],CBRlon[i]);
			if(dist<=(Dsearch+CBR))
			{
				
//  EfsCBR = E_P1546(LatX,LonX , CBRlat[i],CBRlon[i], HasglX, FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
EfsCBR = E_P1546_V05(LatX,LonX , CBRlat[i],CBRlon[i], HaglX,  FrqX1y,PtGt_X, kfactor, Pime, RxH, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

				double Ghv = BorderAnt(LatX,LonX,  HaglX, AZ0X,  EL0X, f0,rH,rV, CBRlat[i],CBRlon[i],  HaglY, kfactor);
				EfsCBR = EfsCBR + 10.0*log10(Ghv);

				if(EfsCBR>EfsCBRmax)
				{
					EfsCBRmax = EfsCBR;
					CBRlat_deg = CBRlat[i];
					CBRlon_deg = CBRlon[i];
					DistCBR = dist;
				}//if EfsCBR
			}
		}//numCBR
		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
		CBRlat_rad = CBRlat_deg*pi/180.0;	CBRlon_rad = CBRlon_deg*pi/180.0;
		Rad2Str(CBRlon_rad,CBRlat_rad, &RLONcbr,&RLATcbr);

		CString									Affected = _T("+++");
		if((EfsBmax<PIFS)&&(EfsCBRmax<PIFS))	Affected = _T("---");
		
		if     ((EfsBmax != -9999999.999)&&(EfsCBRmax != -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%0.3f,%s  %s,%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,EfsCBRmax,RLONcbr,RLATcbr,DistCBR,PIFS,CBR);
		else if((EfsBmax != -9999999.999)&&(EfsCBRmax == -9999999.999))	strY1.Format("%0.4f,%s,%s,%0.3f,%s  %s,%0.0f,%s,%s  %s,%s,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,EfsBmax,RLONb,RLATb,DistB,_T("---"),_T("---"),_T("---"),_T("---"),PIFS,CBR);
		else											strY1.Format("%0.4f,%s,%s,%s,%s  %s,  >%0.0f,%s,%s  %s,  >%0.0f,%0.3f,%0.1f",FrqX1y,_T("Rx"),ctyA,_T("---"),_T("---"),_T("---"),Dsearch,_T("---"),_T("---"),_T("---"),Dsearch,PIFS,CBR);
		strY = strY+","+strY1;
	}
	strY.Delete(0);

	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
	if(numCBR>0)	{CBRlat = NULL; delete [] CBRlat;	CBRlon = NULL; delete [] CBRlon;	}
	
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
	return strY;
}

BOOL CSMS4DCView::BorderISPrefCountries(CString PrefCountries,CString ctyX) 
{
	BOOL w = FALSE;
	PrefCountries.TrimRight();	PrefCountries.MakeUpper();

	int L = PrefCountries.GetLength();
	if(L>0)
	{
		PrefCountries.Replace("_",",");
		CString cty;
		int k = 0;
		for(int i=0;i<L;i++)
		{
			cty = PrefCountries.Mid(i,1);
			if(cty==",")	k++;
		}
		for( i=0;i<k+1;i++)
		{
			cty = GetFld(PrefCountries,i);	cty.TrimRight();
			if(cty==ctyX)	w = TRUE;
		} 
	}
	return w;
}

CString CSMS4DCView::OnFxmQx(BOOL Tx) 
{
	BeginWaitCursor();
	CString CDataBaseSTR , SelX = _T(" ");
//	if(Tx)		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtable WHERE (((STTP)=\'FB\')) OR (((STTP)=\'ML\')) OR (((TXfreq)<1000) AND ((STTP)=\'FX\'));");
//	else		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtable WHERE (((STTP)=\'FB\')) OR (((STTP)=\'ML\')) OR (((RXfreq)<1000) AND ((STTP)=\'FX\'));");

	if(Tx)	CDataBaseSTR.Format(  _T("SELECT * FROM %s WHERE (((STTP)=\'FB\')) OR (((STTP)=\'ML\')) OR (((TXfreq)<1000) AND ((STTP)=\'FX\'));")  ,  m_qSTtable );
	else	CDataBaseSTR.Format(  _T("SELECT * FROM %s WHERE (((STTP)=\'FB\')) OR (((STTP)=\'ML\')) OR (((RXfreq)<1000) AND ((STTP)=\'FX\'));")  ,  m_qSTtable );
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("Wanted Station");

	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
			SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

BOOL CSMS4DCView::OnFxmQy(long IDX,double latX, double lonX, double frqX, double Drange, double Frange, BOOL Tx) 
{
	BOOL YOK = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;
	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);

	double fmin = frqX - Frange/1000.0,		fmax = frqX + Frange/1000.0;
	CString CDataBaseSTR;
if(lonmin<=lonmax)
{	
	if(Tx)		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FB\' Or (STTP)=\'ML\' Or (STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)<1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FB\' Or (STTP)=\'ML\' Or (STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)<1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
else
{	
	if(Tx)		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FB\' Or (STTP)=\'ML\' Or (STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)<1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FB\' Or (STTP)=\'ML\' Or (STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)<1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	if(Tx)	datadlg.m_Title = _Z("Interferer Stations");
	else	datadlg.m_Title = _Z("Victim Stations");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)	YOK = TRUE;
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnInterferenceFxmTo() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxmQx(TRUE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,6));
		CString NameX = GetFld(m_SelX,2);
		CString st_clsX = GetFld(m_SelX,18);	st_clsX.TrimRight();	st_clsX.MakeUpper();

		CFXM_F_D_rngDLG F_D_rngeDLG;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = F_D_rngeDLG.m_Emin;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL Emergency = F_D_rngeDLG.m_Emergency;

			BOOL YOK = OnFxmQy(IDX,latX, lonX, frqX, Drange, Frange, FALSE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CKFactor KF;
					if(KF.DoModal()==IDOK)
					{
						double kfactor = atof_kfactor(KF.m_kfactorEdit);
						CString *m_Sel; m_Sel = new CString[Nrow];

						CString RxEmission , TxEmission = GetFld(m_SelX,19);	TxEmission.TrimRight();	TxEmission.MakeUpper();
						double PtGt_X  = atof(GetFld(m_SelX,7));
						
						CNFDmobile_Functions NFDmobile;
							
						double frqY, Gr, Df, NFDm, FsLimit, dist, Efs, latY, lonY;
						CString NameY, st_clsY , RLONx, RLATx , RLONy, RLATy , antfile, ANT_Tx,ANT_Rx;
						long IDY;
				//		double C2 = 2.1 , GhvTx , GhvRx;
						double C2 = 0.0 , GhvTx , GhvRx;
//						double pi = 4.0*atan(1.0);
						double EL0Tx ,AZ0Tx,EL0Rx, AZ0Rx, el,fpi , HaglX, HaglY ,tpi, fi, ti;

						int Txf0[360] , Rxf0[360];
						double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];
						double re = kfactor*6371000;

						HaglX  = atof(GetFld(m_SelX,5));
						EL0Tx  = (pi/180.0)*atof(GetFld(m_SelX,9));
						AZ0Tx  = (pi/180.0)*atof(GetFld(m_SelX,8));
						ANT_Tx = GetFld(m_SelX,14);

						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
						ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

						CString strX,strY="",strY1="";
						int progress_num=0;
						CString progress_str, progress_char = "I";
						for(long Yi = 0;Yi<Nrow;Yi++)
						{
							progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
							progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
							((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
							PeekAndPump();

							m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
			
							IDY = atol(GetFld(m_Sel[Yi],1));
							NameY = GetFld(m_Sel[Yi],2);
							st_clsY = GetFld(m_Sel[Yi],18);	st_clsY.TrimRight();	st_clsY.MakeUpper();

							frqY  = atof(GetFld(m_Sel[Yi],21));
							RxEmission = GetFld(m_Sel[Yi],19);	RxEmission.TrimRight();	RxEmission.MakeUpper();
							Gr  = atof(GetFld(m_Sel[Yi],10));
							latY = atof(GetFld(m_Sel[Yi],3));
							lonY  = atof(GetFld(m_Sel[Yi],4));
						
							/////////////////////Antenna Tx & Rx/////////////////////
							HaglY  = atof(GetFld(m_Sel[Yi],5));
							el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

							ANT_Rx = GetFld(m_Sel[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							EL0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
							AZ0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
							el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							GhvRx = 10.0*log10(GhvRx);
							/////////////////////////////////////////

							Df = fabs(frqX-frqY)*1000.0;
							NFDm = NFDmobile.NFDmobile1(TxEmission ,RxEmission ,Df, Emergency);
							FsLimit = Emin - Gr - GhvRx + C2 + NFDm;
							dist = Distance_km(latX,lonX ,latY,lonY);

							Efs = (sqrt(30.0*PtGt_X*GhvTx))/(1000.0*dist);	
							Efs = 120.0+20.0*(log10(Efs));

							Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							if(dist>0)
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%0.2f,%0.2f",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,Efs,FsLimit);
							else
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,0.0,frqY,st_clsY,"---","---");
							strY = strY+","+strY1;

						}//for Yi
						delete [] m_Sel;
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
						strY.Delete(0);

						Rad2Str(lonX*pi/180.0,latX*pi/180.0, &RLONx,&RLATx);
						strX.Format("%ld,%s,%s,%s  %s,%0.4f,%s",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX,st_clsX);

						if(!(strY.IsEmpty()))
						{
							CBorderRep1DLG dlgList;
							dlgList.m_editX = strX;
							dlgList.m_rowsY = Nrow+1;
							dlgList.m_editY = strY;
							dlgList.m_title1 = _Z("FXM : LM & FX below 1 GHz Interference Calculation");
							dlgList.m_title2 = _Z("Wanted Station :");
							dlgList.m_title3 = _Z("Interference to :");
							dlgList.m_mode = 4;
							dlgList.DoModal();
						}
					}//if kfactor
				}//if Nrow	Y
			}//if YOK
		}//if F_D_rngeDLG
	}// if m_SelX
	EndWaitCursor();
}

void CSMS4DCView::OnInterferenceFxmTo2() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxmQx(TRUE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,6));
		CString NameX = GetFld(m_SelX,2);
		CString st_clsX = GetFld(m_SelX,18);	st_clsX.TrimRight();	st_clsX.MakeUpper();

		CFXM_F_D_rngDLG F_D_rngeDLG;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = F_D_rngeDLG.m_Emin;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL Emergency = F_D_rngeDLG.m_Emergency;

			BOOL YOK = OnFxmQy(IDX,latX, lonX, frqX, Drange, Frange, FALSE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					double kfactor, Pime, Plocation;
					int ENV,  syst , P1546Clangle , P1546landsea;
					CP1546DLG p1546dlg;
					p1546dlg.m_RxShow=FALSE;
					if(p1546dlg.DoModal()==IDOK)
					{
						Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
						kfactor = p1546dlg.m_k;
						syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
						P1546Clangle = p1546dlg.m_Clangle;	P1546landsea = p1546dlg.m_landsea;

						OnDatabaseStationsindesktop2(latX,lonX);
						double HaglX = atof(GetFld(m_SelX,5));
						double HaslX = LatLon2Hg(latX,lonX);
						double HasglX = HaslX+HaglX;
						int p = LandWarmColdSea(lonX, latX);

LoadIDWMmap_r(latX,lonX, Drange);

						CString *m_Sel; m_Sel = new CString[Nrow];

						CString RxEmission , TxEmission = GetFld(m_SelX,19);	TxEmission.TrimRight();	TxEmission.MakeUpper();
						double PtGt_X  = atof(GetFld(m_SelX,7));
						
						CNFDmobile_Functions NFDmobile;
							
						double frqY, Gr, Df, NFDm, FsLimit, dist, Efs, latY, lonY;
						CString NameY, st_clsY , RLONx, RLATx , RLONy, RLATy , antfile, ANT_Tx,ANT_Rx;
						long IDY;
				//		double C2 = 2.1 , GhvTx , GhvRx;
						double C2 = 0.0 , GhvTx , GhvRx;
//						double pi = 4.0*atan(1.0);
						double EL0Tx ,AZ0Tx,EL0Rx, AZ0Rx, el,fpi , HaglY ,tpi, fi, ti;
						int Txf0[360] , Rxf0[360];
						double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];
						double re = kfactor*6371000;

						EL0Tx  = (pi/180.0)*atof(GetFld(m_SelX,9));
						AZ0Tx  = (pi/180.0)*atof(GetFld(m_SelX,8));
						ANT_Tx = GetFld(m_SelX,14);

						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
						ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

						CString strX,strY="",strY1="";
						int progress_num=0;
						CString progress_str, progress_char = "I";
						for(long Yi = 0;Yi<Nrow;Yi++)
						{
							progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
							progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
							((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
							PeekAndPump();

							m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
			
							IDY = atol(GetFld(m_Sel[Yi],1));
							NameY = GetFld(m_Sel[Yi],2);
							st_clsY = GetFld(m_Sel[Yi],18);	st_clsY.TrimRight();	st_clsY.MakeUpper();
							frqY  = atof(GetFld(m_Sel[Yi],21));
							RxEmission = GetFld(m_Sel[Yi],19);	RxEmission.TrimRight();	RxEmission.MakeUpper();
							Gr  = atof(GetFld(m_Sel[Yi],10));
							latY = atof(GetFld(m_Sel[Yi],3));
							lonY  = atof(GetFld(m_Sel[Yi],4));
						
							/////////////////////Antenna Tx & Rx/////////////////////
							HaglY  = atof(GetFld(m_Sel[Yi],5));
							el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);

							ANT_Rx = GetFld(m_Sel[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							EL0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
							AZ0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
							el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							GhvRx = 10.0*log10(GhvRx);
							/////////////////////////////////////////

							Df = fabs(frqX-frqY)*1000.0;
							NFDm = NFDmobile.NFDmobile1(TxEmission ,RxEmission ,Df, Emergency);
							FsLimit = Emin - Gr - GhvRx + C2 + NFDm;
							dist = Distance_km(latX,lonX ,latY,lonY);
							Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							if(dist>0)
							{
//    Efs = E_P1546(latX,lonX ,latY,lonY, HasglX, frqX,PtGt_X, kfactor, Pime, HaglY, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
Efs = E_P1546_V05(latX,lonX ,latY,lonY, HaglX,  frqX,PtGt_X, kfactor, Pime, HaglY, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);

								Efs = Efs +	10.0*log10(GhvTx);
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%0.2f,%0.2f",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,Efs,FsLimit);
							}
							else
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,0.0,frqY,st_clsY,"---","---");
							strY = strY+","+strY1;

						}//for Yi
						delete [] m_Sel;
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
						strY.Delete(0);

						Rad2Str(lonX*pi/180.0,latX*pi/180.0, &RLONx,&RLATx);
						strX.Format("%ld,%s,%s,%s  %s,%0.4f,%s",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX,st_clsX);

						if(!(strY.IsEmpty()))
						{
							CBorderRep1DLG dlgList;
							dlgList.m_editX = strX;
							dlgList.m_rowsY = Nrow+1;
							dlgList.m_editY = strY;
							dlgList.m_title1 = _Z("FXM : LM & FX below 1 GHz Interference Calculation");
							dlgList.m_title2 = _Z("Wanted Station :");
							dlgList.m_title3 = _Z("Interference to :");
							dlgList.m_mode = 4;
							dlgList.DoModal();
						}
					}//if kfactor
				}//if Nrow	Y
			}//if YOK
		}//if F_D_rngeDLG
	}// if m_SelX
	EndWaitCursor();	
}

void CSMS4DCView::OnInterferenceFxmFrom() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxmQx(FALSE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,21));
		CString NameX = GetFld(m_SelX,2);
		CString st_clsX = GetFld(m_SelX,18);	st_clsX.TrimRight();	st_clsX.MakeUpper();

		CFXM_F_D_rngDLG F_D_rngeDLG;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = F_D_rngeDLG.m_Emin;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL Emergency = F_D_rngeDLG.m_Emergency;

			BOOL YOK = OnFxmQy(IDX,latX, lonX, frqX, Drange, Frange, TRUE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CKFactor KF;
					if(KF.DoModal()==IDOK)
					{
						double kfactor = atof_kfactor(KF.m_kfactorEdit);
						CString *m_Sel; m_Sel = new CString[Nrow];

						CString TxEmission , RxEmission = GetFld(m_SelX,19);	RxEmission.TrimRight();	RxEmission.MakeUpper();
						CNFDmobile_Functions NFDmobile;
							
			//			BOOL Emergency = TRUE;
						double frqY, Gr, Df, NFDm, FsLimit, dist, Efs, latY, lonY;

						CString NameY, st_clsY , RLONx, RLATx , RLONy, RLATy , antfile, ANT_Tx,ANT_Rx;
						long IDY;
			//			double C2 = 2.1 , GhvTx , GhvRx, PtGt_Y;
						double C2 = 0.0 , GhvTx , GhvRx, PtGt_Y;
//						double pi = 4.0*atan(1.0);
						double EL0Tx ,AZ0Tx,EL0Rx, AZ0Rx, el,fpi , HaglX, HaglY ,tpi, fi, ti;
						int Txf0[360] , Rxf0[360];
						double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];
						double re = kfactor*6371000;

						HaglX  = atof(GetFld(m_SelX,5));
						EL0Rx  = (pi/180.0)*atof(GetFld(m_SelX,9));
						AZ0Rx  = (pi/180.0)*atof(GetFld(m_SelX,8));
						ANT_Rx = GetFld(m_SelX,14);
						Gr  = atof(GetFld(m_SelX,10));

						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;

						CString strX,strY="",strY1="";
						int progress_num=0;
						CString progress_str, progress_char = "I";
						for(long Yi = 0;Yi<Nrow;Yi++)
						{
							progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
							progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
							((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
							PeekAndPump();

							m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

							PtGt_Y  = atof(GetFld(m_Sel[Yi],7));
							IDY = atol(GetFld(m_Sel[Yi],1));
							NameY = GetFld(m_Sel[Yi],2);
							st_clsY = GetFld(m_Sel[Yi],18);	st_clsY.TrimRight();	st_clsY.MakeUpper();
							frqY  = atof(GetFld(m_Sel[Yi],6));
							TxEmission = GetFld(m_Sel[Yi],19);	TxEmission.TrimRight();	TxEmission.MakeUpper();
							latY = atof(GetFld(m_Sel[Yi],3));
							lonY  = atof(GetFld(m_Sel[Yi],4));
						
							/////////////////////Antenna Tx & Rx/////////////////////
							HaglY  = atof(GetFld(m_Sel[Yi],5));
							el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							GhvRx = 10.0*log10(GhvRx);

							ANT_Tx = GetFld(m_Sel[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
							ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;
							EL0Tx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
							AZ0Tx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
							el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
							/////////////////////////////////////////

							Df = fabs(frqX-frqY)*1000.0;
							NFDm = NFDmobile.NFDmobile1(TxEmission ,RxEmission ,Df, Emergency);
							FsLimit = Emin - Gr - GhvRx + C2 + NFDm;
							dist = Distance_km(latX,lonX ,latY,lonY);

							Efs = (sqrt(30.0*PtGt_Y*GhvTx))/(1000.0*dist);	
							Efs = 120.0+20.0*(log10(Efs));

							Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							//	strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%0.2f,%0.2f",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,Efs,FsLimit);
							
							if(dist>0)	strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%0.2f,%0.2f",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,Efs,FsLimit);
							else		strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,0.0,frqY,st_clsY,"---","---");
							strY = strY+","+strY1;

						}//for Yi
						delete [] m_Sel;
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
						strY.Delete(0);

						Rad2Str(lonX*pi/180.0,latX*pi/180.0, &RLONx,&RLATx);
						strX.Format("%ld,%s,%s,%s  %s,%0.4f,%s",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX,st_clsX);

						if(!(strY.IsEmpty()))
						{
							CBorderRep1DLG dlgList;
							dlgList.m_editX = strX;
							dlgList.m_rowsY = Nrow+1;
							dlgList.m_editY = strY;
							dlgList.m_title1 = _Z("FXM : LM & FX below 1 GHz Interference Calculation");
							dlgList.m_title2 = _Z("Wanted Station :");
							dlgList.m_title3 = _Z("Interference from :");
							dlgList.m_mode = 4;
							dlgList.DoModal();
						}

					}//if kfactor
				}//if Nrow	Y
			}//if YOK
		}//if F_D_rngeDLG
	}// if m_SelX
	EndWaitCursor();	
}

void CSMS4DCView::OnInterferenceFxmFrom2() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxmQx(FALSE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,21));
		CString NameX = GetFld(m_SelX,2);
		CString st_clsX = GetFld(m_SelX,18);	st_clsX.TrimRight();	st_clsX.MakeUpper();

		CFXM_F_D_rngDLG F_D_rngeDLG;
		if(F_D_rngeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Emin = F_D_rngeDLG.m_Emin;
			double Frange = F_D_rngeDLG.m_F,   Drange = F_D_rngeDLG.m_D;
			BOOL Emergency = F_D_rngeDLG.m_Emergency;

			BOOL YOK = OnFxmQy(IDX,latX, lonX, frqX, Drange, Frange, TRUE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					double kfactor, Pime, Plocation;
					int ENV,  syst , P1546Clangle , P1546landsea;
					CP1546DLG p1546dlg;
					p1546dlg.m_RxShow=FALSE;
					if(p1546dlg.DoModal()==IDOK)
					{
						Pime = p1546dlg.m_time;		Plocation = p1546dlg.m_location;
						kfactor = p1546dlg.m_k;
						syst = p1546dlg.m_syst;		ENV = p1546dlg.m_env;
						P1546Clangle = p1546dlg.m_Clangle;	P1546landsea = p1546dlg.m_landsea;

						double HaglX = atof(GetFld(m_SelX,5));
						int p = LandWarmColdSea(lonX, latX);

LoadIDWMmap_r(latX,lonX, Drange);

						double HaslY ,HasglY;
						CString *m_Sel; m_Sel = new CString[Nrow];

						CString TxEmission, RxEmission = GetFld(m_SelX,19);	RxEmission.TrimRight();	RxEmission.MakeUpper();
						CNFDmobile_Functions NFDmobile;
							
						double frqY, Gr, Df, NFDm, FsLimit, dist, Efs, latY, lonY;
						CString NameY, st_clsY , RLONx, RLATx , RLONy, RLATy , antfile, ANT_Tx,ANT_Rx;
						long IDY;
				//		double C2 = 2.1 , GhvTx , GhvRx;
						double C2 = 0.0 , GhvTx , GhvRx;
//						double pi = 4.0*atan(1.0);
						double EL0Tx ,AZ0Tx,EL0Rx, AZ0Rx, el,fpi , HaglY ,tpi, fi, ti , PtGt_Y;
						int Txf0[360] , Rxf0[360];
						double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];

						double re = kfactor*6371000;
						Gr  = atof(GetFld(m_SelX,10));
						EL0Rx  = (pi/180.0)*atof(GetFld(m_SelX,9));
						AZ0Rx  = (pi/180.0)*atof(GetFld(m_SelX,8));
						ANT_Rx = GetFld(m_SelX,14);

						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;

						CString strX,strY="",strY1="";
						int progress_num=0;
						CString progress_str, progress_char = "I";
						for(long Yi = 0;Yi<Nrow;Yi++)
						{
							progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
							progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
							((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
							PeekAndPump();

							m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

							PtGt_Y  = atof(GetFld(m_Sel[Yi],7));
							IDY = atol(GetFld(m_Sel[Yi],1));
							NameY = GetFld(m_Sel[Yi],2);
							st_clsY = GetFld(m_Sel[Yi],18);	st_clsY.TrimRight();	st_clsY.MakeUpper();
							frqY  = atof(GetFld(m_Sel[Yi],6));
							TxEmission = GetFld(m_Sel[Yi],19);	TxEmission.TrimRight();	TxEmission.MakeUpper();
							latY = atof(GetFld(m_Sel[Yi],3));
							lonY  = atof(GetFld(m_Sel[Yi],4));
						
							/////////////////////Antenna Tx & Rx/////////////////////
							HaglY  = atof(GetFld(m_Sel[Yi],5));
							el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							GhvRx = 10.0*log10(GhvRx);

							ANT_Tx = GetFld(m_Sel[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
							ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;
							EL0Tx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
							AZ0Tx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
							el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
							tpi = (pi/2.0) - el;
							fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
							ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
							if (fi<0.0)		fi = fi + 359.4;
							GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
							/////////////////////////////////////////

							OnDatabaseStationsindesktop2(latY,lonY);
							HaslY = LatLon2Hg(latY,lonY);
							HasglY = HaslY+HaglY;

							Df = fabs(frqX-frqY)*1000.0;
							NFDm = NFDmobile.NFDmobile1(TxEmission ,RxEmission ,Df, Emergency);
							FsLimit = Emin - Gr - GhvRx + C2 + NFDm;
							dist = Distance_km(latX,lonX ,latY,lonY);
							Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							if(dist>0)
							{
//  Efs = E_P1546(latY,lonY ,latX,lonX, HasglY, frqY,PtGt_Y, kfactor, Pime, HaglX, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
Efs = E_P1546_V05(latY,lonY ,latX,lonX, HaglY,  frqY,PtGt_Y, kfactor, Pime, HaglX, ENV, syst,Plocation,P1546Clangle , P1546landsea,p);
	
								Efs = Efs +	10.0*log10(GhvTx);
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%0.2f,%0.2f",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,Efs,FsLimit);
							}
							else
								strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,dist,frqY,st_clsY,"---","---");

							strY = strY+","+strY1;

						}//for Yi
						delete [] m_Sel;
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
						strY.Delete(0);

						Rad2Str(lonX*pi/180.0,latX*pi/180.0, &RLONx,&RLATx);
						strX.Format("%ld,%s,%s,%s  %s,%0.4f,%s",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX,st_clsX);

						if(!(strY.IsEmpty()))
						{
							CBorderRep1DLG dlgList;
							dlgList.m_editX = strX;
							dlgList.m_rowsY = Nrow+1;
							dlgList.m_editY = strY;
							dlgList.m_title1 = _Z("FXM : LM & FX below 1 GHz Interference Calculation");
							dlgList.m_title2 = _Z("Wanted Station :");
							dlgList.m_title3 = _Z("Interference from :");
							dlgList.m_mode = 4;
							dlgList.DoModal();
						}

					}//if kfactor
				}//if Nrow	Y
			}//if YOK
		}//if F_D_rngeDLG
	}// if m_SelX
	EndWaitCursor();		
}

CString CSMS4DCView::LatLon2Ctry(double lat,double lon) 
{
//	double pi=4.0*atan(1.0);
	float RLON = (float)(lon*pi/180.0) ;	float RLAT = (float)(lat*pi/180.0) ;
	CString cty1("");
	GEOPLC(&RLON, &RLAT, (BYTE*)cty1.GetBufferSetLength(3)) ;
	if(cty1=="   ")	cty1 = _T("Sea");
	return cty1;
}

CString CSMS4DCView::OnFxVQx(BOOL Tx) 
{
	BeginWaitCursor();
	CString CDataBaseSTR, SelX = _T(" ");
//	if(Tx)		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtable WHERE (((TXfreq)>=1000) AND ((STTP)=\'FX\'));");
//	else		((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("SELECT * FROM STtable WHERE (((RXfreq)>=1000) AND ((STTP)=\'FX\'));");

	if(Tx)	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE (((TXfreq)>=1000) AND ((STTP)=\'FX\'));") , m_qSTtable );
	else	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE (((RXfreq)>=1000) AND ((STTP)=\'FX\'));") , m_qSTtable );
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG datadlg;
	datadlg.m_Title = _T("Wanted Station");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)	SelX = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
	}
	Set_STtable_Default();
	return SelX;
}

BOOL CSMS4DCView::OnFxVQy(long IDX,double latX, double lonX, double frqX, double Drange, double Frange, BOOL Tx) 
{
	BOOL YOK = FALSE;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;
	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);
	double fmin = frqX - Frange/1000.0,		fmax = frqX + Frange/1000.0;

	CString CDataBaseSTR;
if(lonmin<=lonmax)
{
	if(Tx)		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
else
{
	if(Tx)		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		CDataBaseSTR.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
	
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	if(Tx)		datadlg.m_Title = _Z("Interferer Stations");
	else		datadlg.m_Title = _Z("Victim Stations");
	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>=1)	YOK = TRUE;
	}
	Set_STtable_Default();
	return YOK;
}

void CSMS4DCView::OnInterferenceFx2fxvTo() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxVQx(TRUE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,6));
		CString NameX = GetFld(m_SelX,2);
//		double pi = 4.0*atan(1.0);

		CInt_FX2FXvparDLG rangeDLG;
		rangeDLG.m_F = 1000;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
			double pTD = rangeDLG.m_pTD;			
			BOOL m_CHECK_Pol = rangeDLG.m_CHECK_Pol;
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;
			
int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure;
double TempC = rangeDLG.m_TempC;
double ha_Clutter = rangeDLG.m_ha_Clutter;
double dk_Clutter = rangeDLG.m_dk_Clutter;

			double PolarDisc;
//			double kfactor = (157.0 / (157.0 - (dN)));

			BOOL YOK = OnFxVQy(IDX,latX, lonX, frqX, Drange, Frange, FALSE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];

					double PtGt_X  = atof(GetFld(m_SelX,7));
					double InserLossX  = atof(GetFld(m_SelX,15));
					CString polX  = GetFld(m_SelX,13);	polX.TrimRight(); polX.MakeUpper();
					double HaglX  = atof(GetFld(m_SelX,5));
					double AZ0Tx  = D2R*atof(GetFld(m_SelX,8));
					double EL0Tx  = D2R*atof(GetFld(m_SelX,9));

					CString polY, ANT_Tx,ANT_Rx, antfile, RxEmission,NameY, RLONy,RLATy , RLONx,RLATx;
					double latY, lonY, HaglY ,el,fpi , GRx, InserLossY, GhvTx , GhvRx;
					double tpi,fi,ti, AZ0Rx ,EL0Rx , frqY , PrdBw , NFD = 0;					
					double TD , Npower , Tdeg = 290.0, Kbolt = 1.38e-23, nBWY, NFigureY;
					long IDY;

					int Txf0[360] , Rxf0[360];
					double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];
//					double re = kfactor*6371000;

					ANT_Tx = GetFld(m_SelX,14);
					antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
					ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

					CPoint pointst[2];
					double GTx  = atof(GetFld(m_SelX,10));

					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2,PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR	= 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;
								
					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strX,strY="",strY1="";
					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
						PeekAndPump();

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];

						IDY = atol(GetFld(m_Sel[Yi],1));
						NameY = GetFld(m_Sel[Yi],2);
						frqY  = atof(GetFld(m_Sel[Yi],21));
						polY  = GetFld(m_Sel[Yi],13);	polY.TrimRight(); polY.MakeUpper();
						latY = atof(GetFld(m_Sel[Yi],3));
						lonY  = atof(GetFld(m_Sel[Yi],4));
						GRx  = atof(GetFld(m_Sel[Yi],10));
						InserLossY  = atof(GetFld(m_Sel[Yi],15));
						NFigureY  = atof(GetFld(m_Sel[Yi],23));
						
						HaglY  = atof(GetFld(m_Sel[Yi],5));
/*
						/////////////////////Antenna Tx & Rx/////////////////////
						el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
						GhvTx = 10.0*log10(GhvTx);

						ANT_Rx = GetFld(m_Sel[Yi],14);
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
						EL0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
						AZ0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
						el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
						GhvRx = 10.0*log10(GhvRx);
						/////////////////////////////////////////
*/
						///////////////////////////////////P.452////////////////////////////////////////////////////////
						latmin = min(latX,latY);	lonmin = min(lonX,lonY);
						OnDatabaseStationsindesktop2(latmin, lonmin);
			
						LatLon2Point(latX,lonX,&pointst[0]);		LatLon2Point(latY,lonY,&pointst[1]);
						x1=pointst[0].x;	y1=pointst[0].y;
						x2=pointst[1].x;	y2=pointst[1].y;

						Rad2Str(lonY*D2R,latY*D2R, &RLONy,&RLATy);
						if((x1!=x2)||(y1!=y2))
						{
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
					//		int *zi;			zi = new int[Np];
							CString *zi;			zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];		yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));
								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
						//		hikm[i] = hi/1000.0;
								hikm[i] = hi;  //m
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqX/1000.0, HaglX, HaglY, GTx,GRx, 
				Pressure, TempC, polX, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
						/////////////////////Antenna Tx & Rx/////////////////////
						el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
						ti = R2D*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
						GhvTx = 10.0*log10(GhvTx);

						ANT_Rx = GetFld(m_Sel[Yi],14);
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
						EL0Rx  = D2R*atof(GetFld(m_Sel[Yi],9));
						AZ0Rx  = D2R*atof(GetFld(m_Sel[Yi],8));
						el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
						ti = R2D*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
						GhvRx = 10.0*log10(GhvRx);
						/////////////////////////////////////////
/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqX/1000.0,tp,N0,dN,beta,
													GTx,GRx,HaglX/1000.0,HaglY/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X; delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi;
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							if((((polX == "H")&&(polY == "V"))||((polX == "V")&&(polY == "H")))&&(m_CHECK_Pol))
									PolarDisc = m_EDIT_Pol;
							else	PolarDisc = 0.0;

							NFD = NFDfixed_Loss(IDX,NameX,frqX,IDY,NameY,frqY) ;
							PrdBw = 10.0*log10(PtGt_X) + GRx - InserLossY + GhvTx + GhvRx - NFD - TotalLoss - PolarDisc;

							RxEmission = GetFld(m_Sel[Yi],19);
							nBWY = 1000.0*Emission2NBW(RxEmission) ;
							Npower = NFigureY + 10.0*log10(Kbolt*Tdeg*nBWY);
							TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));

					//		Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,Dist,frqY,PrdBw,TD,TD-pTD,tit);
						}
						else
						{
							Dist = Distance_km( latX,lonX, latY,lonY);
							strY1.Format("%ld,%s,%s,%s  %s,%0.1f,%0.4f,%s,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,Dist,frqY,"---","---","---","---");
						}
						strY = strY+","+strY1;

					}//for Yi Nrow
					delete [] m_Sel;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
					strY.Delete(0);
					Rad2Str(lonX*D2R,latX*D2R, &RLONx,&RLATx);
					strX.Format("%ld,%s,%s,%s  %s,%0.4f",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX);
					if(!(strY.IsEmpty()))
					{
						CBorderRep1DLG dlgList;
						dlgList.m_editX = strX;
						dlgList.m_rowsY = Nrow+1;
						dlgList.m_editY = strY;
						dlgList.m_title1 = _Z("P.452 FX2FX : FX above 1 GHz Interference Calculation");
						dlgList.m_title2 = _Z("Wanted Station :");
						dlgList.m_title3 = _Z("Interference to :");
						dlgList.m_pTD.Format("TD(dB)-%0.1f",pTD);
						dlgList.m_mode = 5;
						dlgList.DoModal();
					}
				}//if  Nrow
			}//if YOK
		}//if F_D_rngeDLG
	}//if m_SelX
	EndWaitCursor();
}

void CSMS4DCView::OnInterferenceFx2fxvFrom() 
{
	BeginWaitCursor();
	CString m_SelX = OnFxVQx(FALSE);
	if(m_SelX!=" ")
	{
		long IDX = atol(GetFld(m_SelX,1));
		double latX = atof(GetFld(m_SelX,3));
		double lonX  = atof(GetFld(m_SelX,4));
		double frqX  = atof(GetFld(m_SelX,21));
		CString NameX = GetFld(m_SelX,2);
//		double pi = 4.0*atan(1.0);

		CInt_FX2FXvparDLG rangeDLG;
		rangeDLG.m_F = 1000;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
			double pTD = rangeDLG.m_pTD;			
			BOOL m_CHECK_Pol = rangeDLG.m_CHECK_Pol;
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;			
			double PolarDisc;
//			double kfactor = (157.0 / (157.0 - (dN)));

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure;
double TempC = rangeDLG.m_TempC;
double ha_Clutter = rangeDLG.m_ha_Clutter;
double dk_Clutter = rangeDLG.m_dk_Clutter;

			BOOL YOK = OnFxVQy(IDX,latX, lonX, frqX, Drange, Frange, TRUE) ;
			if(YOK==TRUE)
			{
				BeginWaitCursor();
				int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
				if (Nrow>=1)
				{
					CString *m_Sel; m_Sel = new CString[Nrow];

					double InserLossX  = atof(GetFld(m_SelX,15));
					CString polX  = GetFld(m_SelX,13);	polX.TrimRight(); polX.MakeUpper();
					double HaglX  = atof(GetFld(m_SelX,5));
					double AZ0Tx  = D2R*atof(GetFld(m_SelX,8));
					double EL0Tx  = D2R*atof(GetFld(m_SelX,9));

					CString polY, ANT_Tx,ANT_Rx, antfile, RxEmission,NameY, RLONy,RLATy , RLONx,RLATx;
					double latY, lonY, HaglY ,el,fpi , GRx, InserLossY, GhvTx , GhvRx;
					double tpi,fi,ti, AZ0Rx ,EL0Rx , frqY , PrdBw , NFD = 0;					
					double TD , Npower , Tdeg = 290.0, Kbolt = 1.38e-23, nBWX, NFigureX;
					long IDY;
					NFigureX  = atof(GetFld(m_SelX,23));

					int Txf0[360] , Rxf0[360];
					double TxrH[360]  ,  TxrV[360] , RxrH[360]  ,  RxrV[360];
//					double re = kfactor*6371000;

					RxEmission = GetFld(m_SelX,19);
					nBWX = 1000.0*Emission2NBW(RxEmission) ;

					ANT_Tx = GetFld(m_SelX,14);
					antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Tx);
					ReadAntennaData(antfile,Txf0,TxrH,TxrV) ;

					CPoint pointst[2];
					double GTx  = atof(GetFld(m_SelX,10));

					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status ;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss,PtGt_Y;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2, PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR = 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strX,strY="",strY1="";
					int progress_num=0;
					CString progress_str, progress_char = "I";
					for(long Yi = 0;Yi<Nrow;Yi++)
					{
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(Nrow)),progress_char);
						progress_char = str_rep("I",(int)(progress_num*50.0/((double)(Nrow))) );
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
						PeekAndPump();

						m_Sel[Yi] = ((CSMS4DCApp *)AfxGetApp())->m_Sel[Yi];
						PtGt_Y  = atof(GetFld(m_SelX,7));
						IDY = atol(GetFld(m_Sel[Yi],1));
						NameY = GetFld(m_Sel[Yi],2);
						frqY  = atof(GetFld(m_Sel[Yi],6));
						polY  = GetFld(m_Sel[Yi],13);	polY.TrimRight(); polY.MakeUpper();
						latY = atof(GetFld(m_Sel[Yi],3));
						lonY  = atof(GetFld(m_Sel[Yi],4));
						GRx  = atof(GetFld(m_Sel[Yi],10));
						InserLossY  = atof(GetFld(m_Sel[Yi],15));
						HaglY  = atof(GetFld(m_Sel[Yi],5));
/*
						/////////////////////Antenna Tx & Rx/////////////////////
						el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
						GhvTx = 10.0*log10(GhvTx);

						ANT_Rx = GetFld(m_Sel[Yi],14);
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
						EL0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],9));
						AZ0Rx  = (pi/180.0)*atof(GetFld(m_Sel[Yi],8));
						el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = (180.0/pi)*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
						ti = (180.0/pi)*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
						GhvRx = 10.0*log10(GhvRx);
						/////////////////////////////////////////
*/
						///////////////////////////////////P.452////////////////////////////////////////////////////////
						latmin = min(latX,latY);		lonmin = min(lonX,lonY);
						OnDatabaseStationsindesktop2(latmin, lonmin);

						LatLon2Point(latY,lonY,&pointst[0]);		LatLon2Point(latX,lonX,&pointst[1]);
						x1=pointst[0].x;	y1=pointst[0].y;
						x2=pointst[1].x;	y2=pointst[1].y;

						Rad2Str(lonY*D2R,latY*D2R, &RLONy,&RLATy);
						if((x1!=x2)||(y1!=y2))
						{
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
				//			int *zi;			zi = new int[Np];
							CString *zi;		zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];		yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));
								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
					//			hikm[i] = hi/1000.0;
								hikm[i] = hi;
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqY/1000.0, HaglY, HaglX, GRx,GTx, 
				Pressure, TempC, polY, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqY/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
						/////////////////////Antenna Tx & Rx/////////////////////
						el = AZ_EL(latX,lonX ,latY,lonY, HaglX, HaglY, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0Tx),(cos(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx)+cos(tpi)*sin(EL0Tx)));
						ti = R2D*acos(cos(tpi)*cos(EL0Tx)-sin(EL0Tx)*sin(tpi)*cos(fpi-AZ0Tx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvTx = Interp2(Txf0,TxrH,fi,360) * Interp2(Txf0,TxrV,ti,360);
						GhvTx = 10.0*log10(GhvTx);

						ANT_Rx = GetFld(m_Sel[Yi],14);
						antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
						ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
						EL0Rx  = D2R*atof(GetFld(m_Sel[Yi],9));
						AZ0Rx  = D2R*atof(GetFld(m_Sel[Yi],8));
						el = AZ_EL(latY,lonY, latX,lonX , HaglY, HaglX, re, &fpi) ;
						tpi = (pi/2.0) - el;
						fi = R2D*atan2(sin(tpi)*sin(fpi-AZ0Rx),(cos(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx)+cos(tpi)*sin(EL0Rx)));
						ti = R2D*acos(cos(tpi)*cos(EL0Rx)-sin(EL0Rx)*sin(tpi)*cos(fpi-AZ0Rx));
						if (fi<0.0)		fi = fi + 359.4;
						GhvRx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
						GhvRx = 10.0*log10(GhvRx);
						/////////////////////////////////////////
/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqY/1000.0,tp,N0,dN,beta,
													GRx,GTx,HaglY/1000.0,HaglX/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X; delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi;
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							if((((polX == "H")&&(polY == "V"))||((polX == "V")&&(polY == "H")))&&(m_CHECK_Pol))
									PolarDisc = m_EDIT_Pol;
							else	PolarDisc = 0.0;

							NFD = NFDfixed_Loss(IDY,NameY,frqY,IDX,NameX,frqX) ;
							PrdBw = 10.0*log10(PtGt_Y) + GTx - InserLossX + GhvTx + GhvRx - NFD - TotalLoss - PolarDisc;

							Npower = NFigureX + 10.0*log10(Kbolt*Tdeg*nBWX);
							TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));
						//	Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);
							strY1.Format("%ld,%s,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,Dist,frqY,PrdBw,TD,TD-pTD,tit);
						}
						else
						{
							Dist = Distance_km( latX,lonX, latY,lonY);
							strY1.Format("%ld,%s,%s,%s  %s,%0.1f,%0.4f,%s,%s,%s,%s",IDY,NameY,LatLon2Ctry(latY,lonY),RLONy,RLATy,Dist,frqY,"---","---","---","---");
						}
						strY = strY+","+strY1;

					}//for Yi Nrow
					delete [] m_Sel;
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
					strY.Delete(0);
					Rad2Str(lonX*D2R,latX*D2R, &RLONx,&RLATx);
					strX.Format("%ld,%s,%s,%s  %s,%0.4f",IDX,NameX,LatLon2Ctry(latX,lonX),RLONx,RLATx,frqX);
					if(!(strY.IsEmpty()))
					{
						CBorderRep1DLG dlgList;
						dlgList.m_editX = strX;
						dlgList.m_rowsY = Nrow+1;
						dlgList.m_editY = strY;
						dlgList.m_title1 = _Z("P.452 FX2FX : FX above 1 GHz Interference Calculation");
						dlgList.m_title2 = _Z("Wanted Station :");
						dlgList.m_title3 = _Z("Interference from :");
						dlgList.m_pTD.Format("TD(dB)-%0.1f",pTD);
						dlgList.m_mode = 5;
						dlgList.DoModal();
					}
				}//if  Nrow
			}//if YOK
		}//if F_D_rngeDLG
	}//if m_SelX
	EndWaitCursor();	
}


double CSMS4DCView::NFDfixed_Loss(long ID_Tx,CString Name_Tx,double fMHz_Tx,long ID_Rx,CString Name_Rx,double fMHz_Rx) 
{
	///////////////////////////////// NFD Fixed Service/////////////////////////////////
	double NFD = 0;
	CString str;

	str.Format("SELECT * FROM TxFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Tx);
	CTxRxFiltersSet m_pSet(str);
	m_pSet.Open();
	if(m_pSet.GetRecordCount()==1)
	{
		double ft0[20] , at0[20];
		m_pSet.MoveFirst();
		int TxNum = 0;
		while( !m_pSet.IsEOF())
		{
			ft0[TxNum] = m_pSet.m_CS;
			at0[TxNum] = m_pSet.m_Att;
			TxNum++;
			m_pSet.MoveNext();
		}
		m_pSet.Close();

		str.Format("SELECT * FROM RxFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Rx);
		CTxRxFiltersSet m_pSet1(str);
		m_pSet1.Open();
		if(m_pSet1.GetRecordCount()==1)
		{
			double fr0[20] , ar0[20];
			m_pSet1.MoveFirst();
			int RxNum = 0;
			while( !m_pSet1.IsEOF())
			{
				fr0[RxNum] = m_pSet1.m_CS;
				ar0[RxNum] = m_pSet1.m_Att;
				RxNum++;
				m_pSet1.MoveNext();
			}
			m_pSet1.Close();

			double  ft[20] , at[20], fr[20] , ar[20];
			double	ft0max = MaxValue(ft0,TxNum),	ft0min = MinValue(ft0,TxNum),
					fr0max = MaxValue(fr0,RxNum),	fr0min = MinValue(fr0,RxNum);

			double stepTx=(ft0max-ft0min)/19.0;
			double stepRx=(fr0max-fr0min)/19.0;
			int i;
			for( i=0;i<20;i++)
			{
				ft[i] = ft0min + i*stepTx;		at[i] = interwt(ft0,at0,TxNum,ft[i]);
				fr[i] = fr0min + i*stepRx;		ar[i] = interwt(fr0,ar0,RxNum,fr[i]);
				ft[i] = (ft[i] + fMHz_Tx)*1000000.0;
				fr[i] = (fr[i] + fMHz_Rx)*1000000.0;
			}
			double	ftmax = MaxValue(ft,20),	ftmin = MinValue(ft,20),
					frmax = MaxValue(fr,20),	frmin = MinValue(fr,20),
					fmax = max(ftmax,frmax),	fmin = min(ftmin,frmin);
			int nf = 1000;
			double	fstep=(fmax-fmin)/nf;
			double *fnew;	fnew = new double[nf];
			double *atnew;  atnew = new double[nf];
			double *arnew;  arnew = new double[nf];
			double *y;		y = new double[nf-1];
			double *z;		z = new double[nf-1];
			double *fnewp;  fnewp = new double[nf];
			double *atnewp; atnewp = new double[nf];
			double *arnewp; arnewp = new double[nf];
			double *atrp;	atrp = new double[nf];
			for( i=0;i<nf;i++)
			{
				fnew[i] = fmin + i*fstep;
				atnew[i] = interwt(ft,at,20,fnew[i]);
				arnew[i] = interwt(fr,ar,20,fnew[i]);
				fnewp[i] = fnew[i]/1000000.0;
				atnewp[i] = -atnew[i];
				arnewp[i] = -arnew[i];
				atrp[i] = -atnew[i]-arnew[i];
			}
			double fc,a,b, sumy = 0.0, sumz = 0.0 ;
			for( i=0;i<nf-1;i++)
			{
				fc = fabs(fnew[i+1]-fnew[i]);	a = (atnew[i+1]-atnew[i])/fc;	b = atnew[i];
				y[i] = subsection(a,b,fc);
				a = (atnew[i+1]-atnew[i]+arnew[i+1]-arnew[i])/fc;		b = atnew[i]+arnew[i];
				z[i] = subsection(a,b,fc); 
				sumy += y[i];		sumz += z[i];
			}
			NFD = 10.0*log10(sumy/sumz);
			delete [] fnew;	delete [] atnew;	delete [] arnew;	delete [] y;	delete [] z;
			delete [] atnewp;	delete [] arnewp;	delete [] fnewp;	delete [] atrp;
		}	// end if Rx Recoard set
		else
		{
			str.Format(_Z("\nRx Filter is not defined for the Receiver : %s.\t\t\n(Net Filter Discrimination = 0 dB)\n"),Name_Rx);
			MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
		}

	}	// end if Tx Recoard set
	else
	{
		str.Format(_Z("\nTx Filter is not defined for the Transmitter : %s.\t\t\n(Net Filter Discrimination = 0 dB)\n"),Name_Tx);
		MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
	}
	return NFD;
}

double CSMS4DCView::MinValue(double *xi,int N) 
{
	double  xiMIN = xi[0];
	for (int i=1;i<N;i++)		xiMIN = min(xiMIN,xi[i]);	
	return xiMIN;
}
double CSMS4DCView::MaxValue(double *xi,int N) 
{
	double  xiMAX = xi[0];
	for (int i=1;i<N;i++)		xiMAX = max(xiMAX,xi[i]);	
	return xiMAX;
}
double CSMS4DCView::interwt(double *ft,double *at,int n,double f0) 
{
	double t0;
	if		(f0>ft[n-1])	t0 = at[n-1];
	else if (f0<ft[0])		t0 = at[0];
	else
	{
		for (int i=0;i<n;i++)
		{
            if (ft[i]==f0)
			{
                t0 = at[i];   break;
			}
            else if (ft[i]>f0)
			{
				t0=at[i-1]+(f0-ft[i-1])*(at[i]-at[i-1])/(ft[i]-ft[i-1]);    break;
            }
		}
	}
	return t0;
}
double CSMS4DCView::subsection(double a,double b,double fc) 
{
	double y;
	if (a==0)   y = fc * pow(10.0,(-b/10.0));
	else        y = ( pow(10.0,(-b/10.0)) )*( pow(10.0,(-a*fc/10.0)) - 1.0 )/(-a*log(10.0)/10.0);
	return y;
}

//extern "C" int WINAPI AccessLevels(HWND hWndParent,CString DBSTR);	//IFIC.dll
extern "C" int WINAPI AccessLevels(HWND hWndParent,CString DBSTR, CString Lang);
void CSMS4DCView::OnDatabaseUsers() 
{
//	AccessLevels(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR);
	AccessLevels(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_Lang);
}
void CSMS4DCView::OnUpdateDatabaseUsers(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable((level==3)||(level==4));
}
void CSMS4DCView::OnUpdateDatabaseAudittrail(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable((level==3)||(level==4));
}
void CSMS4DCView::OnUpdateDatabaseBackup(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable((level==3)||(level==4));
}

void CSMS4DCView::OnUpdateCalculationUndertestIfic(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);
}
void CSMS4DCView::OnUpdateFrequencyallocationsFrequencyplan(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);	
}
void CSMS4DCView::OnUpdateFrequencyallocationsFrequencyassignment(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);	
}
void CSMS4DCView::OnUpdateToolsAntennaeditor(CCmdUI* pCmdUI) 
{
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);		
}

void CSMS4DCView::OnToolsMaplayersUsermap1() 
{
	CString TileInfo = m_AppPath + _T("Texts\\UserMap1.txt");
	MapLayerChange(TileInfo,1,1);
}
void CSMS4DCView::OnUpdateToolsMaplayersUsermap1(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	CString TileInfo = m_AppPath + _T("Texts\\UserMap1.txt");
	pCmdUI->SetCheck(pDoc->TileInfo == TileInfo ? 1 : 0);		
}

void CSMS4DCView::OnToolsMaplayersUsermap2() 
{
	CString TileInfo = m_AppPath + _T("Texts\\UserMap2.txt");
	MapLayerChange(TileInfo,1,1);	
}
void CSMS4DCView::OnUpdateToolsMaplayersUsermap2(CCmdUI* pCmdUI) 
{
	CSMS4DCDoc* pDoc = GetDocument();
	CString TileInfo = m_AppPath + _T("Texts\\UserMap2.txt");
	pCmdUI->SetCheck(pDoc->TileInfo == TileInfo ? 1 : 0);			
}

//extern "C" int WINAPI Agreements(HWND hWndParent,CString DBSTR,CString SDBSTR);	//IFIC.lib
extern "C" int WINAPI Agreements(HWND hWndParent,CString DBSTR,CString SBSTR, CString Lang);
void CSMS4DCView::OnCoordinationAgreements() 
{
//	Agreements(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR);
	Agreements(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_Lang);
}

long CSMS4DCView::OnESQx(CString * str1, CString TxRx) 
{
	BeginWaitCursor();
	long i = 0;
	int DataBaseFlag = 1;		//local database

	CAP7ESDLG dataDLG;
	dataDLG.m_TxRxQ = TxRx;
	dataDLG.m_DataBaseFlag = DataBaseFlag;
	if(TxRx==_T("E"))		dataDLG.m_Title = _Z("Select Tx Earth Station");
	else					dataDLG.m_Title = _Z("Select Rx Earth Station");
	if(dataDLG.DoModal() == IDOK)
	{
		CString strNTC  = dataDLG.m_Notice;
		BOOL bNTC = strNTC.IsEmpty();
		if(bNTC==1)
		{
			MessageBox(_Z("The Notice ID is Empty.\t\n\nPlease Select One Notice ID."),_Z("Warning!!!"),MB_ICONWARNING | MB_OK);
			return i;
		}
		CString strBEM  = dataDLG.m_Beam,	strGRP  = dataDLG.m_Group,	 strFrq  = dataDLG.m_Frq;
		BOOL bBEM = strBEM.IsEmpty(),		 bGRP = strGRP.IsEmpty(),	 bFrq = strFrq.IsEmpty();
		CString strSQT, CTY = dataDLG.m_Ctry;
		
		if((bNTC==0)&&(bBEM==1)&&(bGRP==1)&&(bFrq==1))		strSQT.Format(_T("select * FROM %s WHERE (((ctry)=\'%s\') AND ((ntc_id)=%ld) AND ((emi_rcp)=\'%s\'));"),m_qEarthStationAp7_Int,CTY,atol(strNTC),TxRx);
		else if((bNTC==0)&&(bBEM==0)&&(bGRP==1)&&(bFrq==1))	strSQT.Format(_T("select * from %s WHERE (((ctry)=\'%s\') AND ((ntc_id)=%ld) AND ((beam_name)=\'%s\') AND ((emi_rcp)=\'%s\'));"),m_qEarthStationAp7_Int,CTY,atol(strNTC),strBEM,TxRx);
		else if((bNTC==0)&&(bBEM==0)&&(bGRP==0)&&(bFrq==1))	strSQT.Format(_T("select * from %s WHERE (((ctry)=\'%s\') AND ((ntc_id)=%ld) AND ((beam_name)=\'%s\') AND ((emi_rcp)=\'%s\') AND ((grp_id)=%ld));"),m_qEarthStationAp7_Int,CTY,atol(strNTC),strBEM,TxRx,atol(strGRP));
		else if((bNTC==0)&&(bBEM==0)&&(bGRP==0)&&(bFrq==0))	strSQT.Format(_T("select * from %s WHERE (((ctry)=\'%s\') AND ((ntc_id)=%ld) AND ((beam_name)=\'%s\') AND ((emi_rcp)=\'%s\') AND ((grp_id)=%ld) AND ((freq_mhz)=%f));"),m_qEarthStationAp7_Int,CTY,atol(strNTC),strBEM,TxRx,atol(strGRP),atof(strFrq));
		
		CDatabase DB;		CRecordset m_rs;		CString str;
		if((DataBaseFlag)==0)	DB.Open(_T("SRS_DB"),false,false,_T("ODBC;"),false);
		else					DB.Open((((CSMS4DCApp *)AfxGetApp())->m_CDBSTR),false,false,_T("ODBC;"),false);
		m_rs.m_pDatabase = &DB;
		m_rs.Open( CRecordset::snapshot, strSQT);
		if(m_rs.GetRecordCount() == 1)
		{
			m_rs.MoveFirst();
			while(1)
			{
				if(m_rs.IsEOF()) break;
				for(int j=0; j<24;j++)
				{
					m_rs.GetFieldValue((short)j,str);	str1[i] = str1[i] + str + ",";
				}
				i++;
				m_rs.MoveNext();
			}
		}
		m_rs.Close();	DB.Close();
	}
	return i;
}

long CSMS4DCView::OnESQy(long ntc_id,double latX, double lonX, double frqX, double Drange, double Frange_MHz,CString TxRx,CString * str1) 
{
	long i = 0;
	int DataBaseFlag = 1;		//local database

	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;
	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);
	double fmin = frqX - Frange_MHz,	fmax = frqX + Frange_MHz;

	CString str, strSQT;	
if(lonmin<=lonmax)	strSQT.Format(_T("SELECT * FROM %s WHERE (((ntc_id)<>%ld) AND ((emi_rcp)=\'%s\') AND ((long_dec)>=%f And (long_dec)<=%f) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((freq_mhz)>=%f And (freq_mhz)<=%f));"),m_qEarthStationAp7_Int,ntc_id,TxRx,lonmin,lonmax,latmin,latmax,fmin,fmax);
else				strSQT.Format(_T("SELECT * FROM %s WHERE (((ntc_id)<>%ld) AND ((emi_rcp)=\'%s\') AND ( (long_dec>=%f And long_dec<=180) or (long_dec>=-180 And long_dec<=%f) ) AND ((lat_dec)>=%f And (lat_dec)<=%f) AND ((freq_mhz)>=%f And (freq_mhz)<=%f));"),m_qEarthStationAp7_Int,ntc_id,TxRx,lonmin,lonmax,latmin,latmax,fmin,fmax);

	CDatabase DB;	CRecordset m_rs;
	if((DataBaseFlag)==0)	DB.Open(_T("SRS_DB"),false,false,_T("ODBC;"),false);
	else					DB.Open((((CSMS4DCApp *)AfxGetApp())->m_CDBSTR),false,false,_T("ODBC;"),false);
	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		m_rs.MoveFirst();
		while(1)
		{
			if(m_rs.IsEOF()) break;
			for(int j=0; j<24;j++)
			{
				m_rs.GetFieldValue((short)j,str);		str1[i] = str1[i] + str + ",";
			}
			i++;
			m_rs.MoveNext();
		}
	}
	m_rs.Close();	DB.Close();
	return i;
}

void CSMS4DCView::OnInterferenceEsTo() 
{
	CString m_SelX[500];
	long NrowX = OnESQx(m_SelX, _T("E"));
	if(NrowX>=1)
	{
		CInt_ES2ESoutDLG dlgList;
		dlgList.m_rowsX = NrowX+1;
		dlgList.m_strXt = new CString[NrowX];
		dlgList.m_strYt = new CString[NrowX];
		dlgList.m_rowsYx = new long[NrowX];

		CIntES2ESparDLG rangeDLG;
		rangeDLG.m_D = 500;
		rangeDLG.m_F = 36;
		rangeDLG.m_EDIT_uPr = -144;
		rangeDLG.m_EDIT_Pol = 10;
		rangeDLG.m_time = 0.0015;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange_MHz = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
	//		double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
	//		double kfactor = (157.0 / (157.0 - (dN)));
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;
			double uEDIT_Pr = rangeDLG.m_EDIT_uPr;
			BOOL uPr = rangeDLG.m_uPr;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			int progress_num=0;
			CString progress_str, progress_char = _T("I");
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
			PeekAndPump();
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			for(long Xi=0;Xi<NrowX;Xi++)
			{
				long ntIDX = atol(GetFld(m_SelX[Xi],2));
				double lonX = atof(GetFld(m_SelX[Xi],6));
				double latX = atof(GetFld(m_SelX[Xi],7));
				double frqX = atof(GetFld(m_SelX[Xi],20));

				CString m_SelY[2000];
				long NrowY = OnESQy(ntIDX, latX, lonX, frqX, Drange, Frange_MHz,_T("R"),m_SelY) ;
		//		if (NrowY>=1)
		//		{
					BeginWaitCursor();
					double PtX = atof(GetFld(m_SelX[Xi],13));
					CString PolX = GetFld(m_SelX[Xi],21);
					double PolangX = atof(GetFld(m_SelX[Xi],22));
					long grpIDX = atol(GetFld(m_SelX[Xi],4));
					CString NameX = GetFld(m_SelX[Xi],8);
					CString beamX = GetFld(m_SelX[Xi],3);

//					double pi = 4.0*atan(1.0);
					double azmX = D2R*(atof(GetFld(m_SelX[Xi],10)) + atof(GetFld(m_SelX[Xi],11)))/2.0;
					double elvX = D2R*atof(GetFld(m_SelX[Xi],9));
					double gmaxX = atof(GetFld(m_SelX[Xi],12));
					CString patternX = GetFld(m_SelX[Xi],14);
					CString coefaX = GetFld(m_SelX[Xi],15);
					CString coefbX = GetFld(m_SelX[Xi],16);
					CString coefcX = GetFld(m_SelX[Xi],17);
					CString coefdX = GetFld(m_SelX[Xi],18);
					CString phi1X = GetFld(m_SelX[Xi],19);

					CAP7_ESantPattern  ESantPattern;

					double HaglX = 0;
			//		double re = 6371000*kfactor;
					double Kbolt = 1.38e-23;

					CPoint pointst[2];
					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2, PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR	= 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strY="",strY1="";
					for(long Yi = 0;Yi<NrowY;Yi++)
					{
						CString PolY = GetFld(m_SelY[Yi],21);
						double PolangY = atof(GetFld(m_SelY[Yi],22));
						double azmY = (pi/180.0)*(atof(GetFld(m_SelY[Yi],10)) + atof(GetFld(m_SelY[Yi],11)))/2.0;
						double elvY = (pi/180.0)*atof(GetFld(m_SelY[Yi],9));
						double gmaxY = atof(GetFld(m_SelY[Yi],12));
						CString patternY = GetFld(m_SelY[Yi],14);
						CString coefaY = GetFld(m_SelY[Yi],15);
						CString coefbY = GetFld(m_SelY[Yi],16);
						CString coefcY = GetFld(m_SelY[Yi],17);
						CString coefdY = GetFld(m_SelY[Yi],18);
						CString phi1Y = GetFld(m_SelY[Yi],19);
						double lonY = atof(GetFld(m_SelY[Yi],6));
						double latY = atof(GetFld(m_SelY[Yi],7));
						double HaglY = 0;
						double frqY = atof(GetFld(m_SelY[Yi],20));
						long grpIDY = atol(GetFld(m_SelY[Yi],4));
						CString RLONy, RLATy;
						CString ctryY = GetFld(m_SelY[Yi],1);
						long ntIDY = atol(GetFld(m_SelY[Yi],2));
						CString beamY = GetFld(m_SelY[Yi],3);
						CString NameY = GetFld(m_SelY[Yi],8);
						Rad2Str(lonY*pi/180.0,latY*pi/180.0, &RLONy,&RLATy);

						double Dist1 = Distance_km(latX , lonX , latY , lonY); 
				//		if((lonY != lonX)&&(latY != latX))
						if(Dist1>0)
						{
							double azmXY, azmYX, elvXY, elvYX, phiXY, phiYX, Gtx, Grx;
//							elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
//							elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
//							phiXY = R2D*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
//							phiYX = R2D*acos(cos(elvYX)*cos(elvY)*cos(azmYX-azmY)+sin(elvYX)*sin(elvY));
//							Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("E"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);
//							Grx = ESantPattern.ESantTuser(phiYX,ntIDY,beamY,_T("R"),gmaxY,patternY,coefaY,coefbY,coefcY,coefdY,phi1Y);

							///////////////////////////////////P.452////////////////////////////////////////////////////////
							latmin = min(latX,latY);	lonmin = min(lonX,lonY);
							OnDatabaseStationsindesktop2(latmin, lonmin);
				
							LatLon2Point(latX,lonX,&pointst[0]);	LatLon2Point(latY,lonY,&pointst[1]);
							x1=pointst[0].x;	y1=pointst[0].y;
							x2=pointst[1].x;	y2=pointst[1].y;
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;
							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
			//				int *zi;			zi = new int[Np];
							CString *zi;		zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];			yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));
								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
				//				hikm[i] = hi/1000.0;
								hikm[i] = hi;
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqX/1000.0, HaglX, HaglY, gmaxX,gmaxY, 
				Pressure, TempC, PolX, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
	elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
	elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
	phiXY = R2D*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
	phiYX = R2D*acos(cos(elvYX)*cos(elvY)*cos(azmYX-azmY)+sin(elvYX)*sin(elvY));
	Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("E"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);
	Grx = ESantPattern.ESantTuser(phiYX,ntIDY,beamY,_T("R"),gmaxY,patternY,coefaY,coefbY,coefcY,coefdY,phi1Y);

/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqX/1000.0,tp,N0,dN,beta,
													gmaxX,gmaxY,HaglX/1000.0,HaglY/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X;	delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi;
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							double PolarDisc = 0;

							if	(((PolX == _T("H"))&&(PolY == _T("V")))		||
								 ((PolX == _T("V"))&&(PolY == _T("H")))		||
								 ((PolX == _T("CR"))&&(PolY == _T("CL")))	||
								 ((PolX == _T("CL"))&&(PolY == _T("CR")))	||
								 ((PolX == _T("L"))&&(PolY == _T("L"))&&fabs(PolangX-PolangY)))
								PolarDisc = m_EDIT_Pol;

							double NFD = 0;
							NFD = NFD_ES2ES_Loss(grpIDX,NameX,frqX,grpIDY,NameY,frqY); 
							double PrdBw = PtX + Gtx - TotalLoss + Grx - NFD - PolarDisc;

							double noise_tY = atof(GetFld(m_SelY[Yi],23));
							if(noise_tY == 0)
							{
								if(frqY<=10000)							noise_tY = 75;
								else if ((frqY>10000)&&(frqY<=17000))	noise_tY = 150;
								else									noise_tY = 300;
							}
							double bdwdthY = 1000.0*atof(GetFld(m_SelY[Yi],24));
							double Npower = 10.0*log10(Kbolt*noise_tY*bdwdthY);
							double TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));
		
							BOOL rSysA =  RxSystemGRP_A_D_ES2ES(grpIDY) ;
							double Pr;
							if(uPr)	Pr = uEDIT_Pr;
							else	Pr = Npower + ESantPattern.func_Pr0_ES2ES(frqY, rSysA) ;
							strY1.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%0.2f,%s",ctryY,ntIDY,beamY,grpIDY,NameY,RLONy,RLATy,Dist,frqY,TD,PrdBw,Pr,PrdBw-Pr,tit);
						}
						else
							strY1.Format("%s,%ld,%s,%ld,%s,%s  %s,%d,%0.4f,%s,%s,%s,%s,%s",ctryY,ntIDY,beamY,grpIDY,NameY,RLONy,RLATy,0,frqY,"-","-","-","-","-");
						strY = strY+","+strY1;

						progress_char = str_rep("I",(int)((++progress_num)*50.0/((double)(NrowY*NrowX))) );
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(double)(NrowY*NrowX)),progress_char);
						PeekAndPump();
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
					}//for Yi
					strY.Delete(0);

					CString strX, RLONx, RLATx;
					CString ctryX = GetFld(m_SelX[Xi],1);
					Rad2Str(lonX*pi/180.0,latX*pi/180.0, &RLONx,&RLATx);
					strX.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.4f",ctryX,ntIDX,beamX,grpIDX,NameX,RLONx,RLATx,frqX);

					dlgList.m_strXt[Xi] = strX;
					dlgList.m_strYt[Xi] = strY;
					dlgList.m_rowsYx[Xi] = NrowY+1;

	//			}//if NrowY
			}//for  Xi
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

	//		if(dlgList.m_rowsYx[0]>0)
				dlgList.DoModal();
	//		else
	//		{
	//			delete [] dlgList.m_strXt;
	//			delete [] dlgList.m_strYt;
	//			delete [] dlgList.m_rowsYx;
	//			MessageBox("The Search Result is Empty.\t\t\n\nNo Rx Earth Station Found.\t\t\n","Warning!!!",MB_ICONINFORMATION | MB_OK);
	//		}

		}//if rangeDLG
	}//if NrowX
}

BOOL CSMS4DCView::RxSystem_A_D_ES2ES(CString emission) 
{
	BOOL A_D = FALSE;	//Digital
	if(!emission.IsEmpty())
	{
		CString EM6 = emission.Mid(5,1);
		if((EM6==_T("3"))||(EM6==_T("8")))	A_D = TRUE;		//Analogue
	}
	return A_D;
}

BOOL CSMS4DCView::RxSystemGRP_A_D_ES2ES(long grpID) 
{
	int DataBaseFlag = 1;		//local database

	BOOL GRP_A_D = FALSE;
	CDatabase DB;	CRecordset m_rs;
	CString strSQT , design_emi;

	strSQT.Format("SELECT design_emi FROM emiss WHERE (((grp_id)=%ld));",grpID);
	long k = 0;
	BOOL A_D[1000];

	if(DataBaseFlag==0)		DB.Open(_T("SRS_DB"),false,false,_T("ODBC;"),false);
	else					DB.Open((((CSMS4DCApp *)AfxGetApp())->m_CDBSTR),false,false,_T("ODBC;"),false);
	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		m_rs.MoveFirst();
		while(1)
		{
			if(m_rs.IsEOF()) break;

			m_rs.GetFieldValue((short)0,design_emi);
			A_D[k] = RxSystem_A_D_ES2ES(design_emi);
			k++;
			m_rs.MoveNext();
		}
	}
	m_rs.Close();DB.Close();

	if(k>0)
	{
		BOOL A_D0 = A_D[0];
		for(long i=0;i<k;i++)
		{
			if(A_D0 != A_D[i])	{GRP_A_D = FALSE;	break;}
			else 				 GRP_A_D = A_D0;
		}
	}
	return GRP_A_D;
}

void CSMS4DCView::OnInterferenceEsFrom() 
{
	CString m_SelX[500];
	long NrowX = OnESQx(m_SelX, _T("R"));
	if(NrowX>=1)
	{
		CInt_ES2ESoutDLG dlgList;
		dlgList.m_rowsX = NrowX+1;
		dlgList.m_strXt = new CString[NrowX];
		dlgList.m_strYt = new CString[NrowX];
		dlgList.m_rowsYx = new long[NrowX];

		CIntES2ESparDLG rangeDLG;
		rangeDLG.m_D = 500;
		rangeDLG.m_F = 36;
		rangeDLG.m_EDIT_uPr = -144;
		rangeDLG.m_EDIT_Pol = 10;
		rangeDLG.m_time = 0.0015;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange_MHz = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
//			double kfactor = (157.0 / (157.0 - (dN)));
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;
			double uEDIT_Pr = rangeDLG.m_EDIT_uPr;
			BOOL uPr = rangeDLG.m_uPr;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			int progress_num=0;
			CString progress_str, progress_char = _T("I");
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
			PeekAndPump();
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			for(long Xi=0;Xi<NrowX;Xi++)
			{
				long ntIDX = atol(GetFld(m_SelX[Xi],2));
				double lonX = atof(GetFld(m_SelX[Xi],6));
				double latX = atof(GetFld(m_SelX[Xi],7));
				double frqX = atof(GetFld(m_SelX[Xi],20));

				CString m_SelY[2000];
				long NrowY = OnESQy(ntIDX, latX, lonX, frqX, Drange, Frange_MHz,_T("E"),m_SelY) ;
		//		if (NrowY>=1)
		//		{
					BeginWaitCursor();

					long grpIDX = atol(GetFld(m_SelX[Xi],4));
					CString PolX = GetFld(m_SelX[Xi],21);
					double PolangX = atof(GetFld(m_SelX[Xi],22));
					CString NameX = GetFld(m_SelX[Xi],8);
					CString beamX = GetFld(m_SelX[Xi],3);
//					double pi = 4.0*atan(1.0);
				
					double azmX = (pi/180.0)*(atof(GetFld(m_SelX[Xi],10)) + atof(GetFld(m_SelX[Xi],11)))/2.0;
					double elvX = (pi/180.0)*atof(GetFld(m_SelX[Xi],9));
					double gmaxX = atof(GetFld(m_SelX[Xi],12));
					CString patternX = GetFld(m_SelX[Xi],14);
					CString coefaX = GetFld(m_SelX[Xi],15);
					CString coefbX = GetFld(m_SelX[Xi],16);
					CString coefcX = GetFld(m_SelX[Xi],17);
					CString coefdX = GetFld(m_SelX[Xi],18);
					CString phi1X = GetFld(m_SelX[Xi],19);

					CAP7_ESantPattern  ESantPattern;

					double HaglX = 0;
//					double re = 6371000*kfactor;
					double Kbolt = 1.38e-23;

					CPoint pointst[2];
					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2, PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR = 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;
	
					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strY="",strY1="";
					for(long Yi = 0;Yi<NrowY;Yi++)
					{
						double PtY = atof(GetFld(m_SelY[Yi],13));
						CString PolY = GetFld(m_SelY[Yi],21);
						double PolangY = atof(GetFld(m_SelY[Yi],22));
						double azmY = D2R*(atof(GetFld(m_SelY[Yi],10)) + atof(GetFld(m_SelY[Yi],11)))/2.0;
						double elvY = D2R*atof(GetFld(m_SelY[Yi],9));
						double gmaxY = atof(GetFld(m_SelY[Yi],12));
						CString patternY = GetFld(m_SelY[Yi],14);
						CString coefaY = GetFld(m_SelY[Yi],15);
						CString coefbY = GetFld(m_SelY[Yi],16);
						CString coefcY = GetFld(m_SelY[Yi],17);
						CString coefdY = GetFld(m_SelY[Yi],18);
						CString phi1Y = GetFld(m_SelY[Yi],19);
						double lonY = atof(GetFld(m_SelY[Yi],6));
						double latY = atof(GetFld(m_SelY[Yi],7));
						double HaglY = 0;
						double frqY = atof(GetFld(m_SelY[Yi],20));
						long grpIDY = atol(GetFld(m_SelY[Yi],4));
						CString RLONy, RLATy;
						CString ctryY = GetFld(m_SelY[Yi],1);
						long ntIDY = atol(GetFld(m_SelY[Yi],2));
						CString beamY = GetFld(m_SelY[Yi],3);
						CString NameY = GetFld(m_SelY[Yi],8);
						Rad2Str(lonY*D2R,latY*D2R, &RLONy,&RLATy);

						double Dist1 = Distance_km(latX , lonX , latY , lonY); 
				//		if((lonY != lonX)&&(latY != latX))
						if(Dist1>0)
						{
				//			double azmXY, azmYX, elvXY, elvYX, phiXY, phiYX, Gtx, Grx;
				//			elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
				//			elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
				//			phiXY = (180.0/pi)*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
				//			phiYX = (180.0/pi)*acos(cos(elvYX)*cos(elvY)*cos(azmYX-azmY)+sin(elvYX)*sin(elvY));
				//			Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("R"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);
				//			Grx = ESantPattern.ESantTuser(phiYX,ntIDY,beamY,_T("E"),gmaxY,patternY,coefaY,coefbY,coefcY,coefdY,phi1Y);

							///////////////////////////////////P.452////////////////////////////////////////////////////////
							latmin = min(latX,latY);		lonmin = min(lonX,lonY);
							OnDatabaseStationsindesktop2(latmin, lonmin);
				
							LatLon2Point(latX,lonX,&pointst[1]);	LatLon2Point(latY,lonY,&pointst[0]);
							x1=pointst[0].x;	y1=pointst[0].y;
							x2=pointst[1].x;	y2=pointst[1].y;
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
//							int *zi;			zi = new int[Np];
							CString *zi;		zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];			yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));
								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
						//		hikm[i] = hi/1000.0;
								hikm[i] = hi;
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal_C(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqY/1000.0, HaglY, HaglX, gmaxY,gmaxX, 
				Pressure, TempC, PolY, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqY/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
	double azmXY, azmYX, elvXY, elvYX, phiXY, phiYX, Gtx, Grx;
	elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
	elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
	phiXY = R2D*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
	phiYX = R2D*acos(cos(elvYX)*cos(elvY)*cos(azmYX-azmY)+sin(elvYX)*sin(elvY));
	Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("R"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);
	Grx = ESantPattern.ESantTuser(phiYX,ntIDY,beamY,_T("E"),gmaxY,patternY,coefaY,coefbY,coefcY,coefdY,phi1Y);
/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqY/1000.0,tp,N0,dN,beta,
													gmaxY,gmaxX,HaglY/1000.0,HaglX/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X; delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi;
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							double PolarDisc = 0;

							if	(((PolX == _T("H"))&&(PolY == _T("V")))		||
								 ((PolX == _T("V"))&&(PolY == _T("H")))		||
								 ((PolX == _T("CR"))&&(PolY == _T("CL")))	||
								 ((PolX == _T("CL"))&&(PolY == _T("CR")))	||
								 ((PolX == _T("L"))&&(PolY == _T("L"))&&fabs(PolangX-PolangY)))
								PolarDisc = m_EDIT_Pol;

							double NFD = 0;
							NFD = NFD_ES2ES_Loss(grpIDY,NameY,frqY,grpIDX,NameX,frqX); 

							double PrdBw = PtY + Gtx - TotalLoss + Grx - NFD - PolarDisc;

							double noise_tX = atof(GetFld(m_SelX[Xi],23));
							if(noise_tX == 0)
							{
								if(frqX<=10000)							noise_tX = 75;
								else if ((frqX>10000)&&(frqX<=17000))	noise_tX = 150;
								else									noise_tX = 300;
							}
							double bdwdthX = 1000.0*atof(GetFld(m_SelX[Xi],24));
							double Npower = 10.0*log10(Kbolt*noise_tX*bdwdthX);
							double TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));
		
							BOOL rSysA =  RxSystemGRP_A_D_ES2ES(grpIDX) ;
							double Pr;
							if(uPr)		Pr = uEDIT_Pr;
							else		Pr = Npower + ESantPattern.func_Pr0_ES2ES(frqX, rSysA) ;

							strY1.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%0.2f,%s",ctryY,ntIDY,beamY,grpIDY,NameY,RLONy,RLATy,Dist,frqY,TD,PrdBw,Pr,PrdBw-Pr,tit);
						}
						else
							strY1.Format("%s,%ld,%s,%ld,%s,%s  %s,%d,%0.4f,%s,%s,%s,%s,%s",ctryY,ntIDY,beamY,grpIDY,NameY,RLONy,RLATy,0,frqY,"-","-","-","-","-");
						strY = strY+","+strY1;

						progress_char = str_rep("I",(int)((++progress_num)*50.0/((double)(NrowY*NrowX))) );
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(double)(NrowY*NrowX)),progress_char);
						PeekAndPump();
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

					}//for Yi
					strY.Delete(0);

					CString strX, RLONx, RLATx;
					CString ctryX = GetFld(m_SelX[Xi],1);
					Rad2Str(lonX*D2R,latX*D2R, &RLONx,&RLATx);
					strX.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.4f",ctryX,ntIDX,beamX,grpIDX,NameX,RLONx,RLATx,frqX);
					dlgList.m_strXt[Xi] = strX;
					dlgList.m_strYt[Xi] = strY;
					dlgList.m_rowsYx[Xi] = NrowY+1;

	//			}//if NrowY
			}//for  Xi
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

	//		if(dlgList.m_rowsYx[0]>0)
	//		{
				dlgList.m_Title1 = _Z("P.452 ES2ES : Interference from the Found ES(s) to the Wanted ES");
				dlgList.m_Title2 = _Z("Wanted ES (Rx): ");
				dlgList.m_Title3 = _Z("Found ES(s) (Tx):");
				dlgList.DoModal();
	//		}
	//		else
	//		{
	//			delete [] dlgList.m_strXt;
	//			delete [] dlgList.m_strYt;
	//			delete [] dlgList.m_rowsYx;
	//			MessageBox("The Search Result is Empty.\t\t\n\nNo Tx Earth Station Found.\t\t\n","Warning!!!",MB_ICONINFORMATION | MB_OK);
	//		}

		}//if rangeDLG
	}//if NrowX	
}

long CSMS4DCView::OnES2FXQy(long IDX,double latX, double lonX, double frqX, double Drange, double Frange_MHz, BOOL Tx,CString * str1) 
{
	long i = 0;
	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = Drange;

	reckon(latX,lonX, rng_km,  0.0,&latmax,&dumy) ;
	reckon(latX,lonX, rng_km,180.0,&latmin,&dumy) ;
	reckon(latX,lonX, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(latX,lonX, rng_km,270.0,&dumy,&lonmin) ;
lonmin = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmin);
lonmax = ((CSMS4DCApp *)AfxGetApp())->ReverseLon(lonmax);
	double fmin = frqX - Frange_MHz,	fmax = frqX + Frange_MHz;
	CString strSQT;
if(lonmin<=lonmax)
{
	if(Tx)		strSQT.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		strSQT.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ((STlon_deg)>=%f And (STlon_deg)<=%f) AND ((STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
else
{
	if(Tx)		strSQT.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FX\') AND ((TXfreq)>=%f And (TXfreq)<=%f And (TXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
	else		strSQT.Format("SELECT * FROM %s WHERE (((IDst)<>%ld) AND ((STlat_deg)>=%f And (STlat_deg)<=%f) AND ( (STlon_deg>=%f And STlon_deg<=180) or (STlon_deg>=-180 And STlon_deg<=%f) ) AND ((STTP)=\'FX\') AND ((RXfreq)>=%f And (RXfreq)<=%f And (RXfreq)>=1000));",m_qSTtable,IDX,latmin,latmax,lonmin,lonmax,fmin,fmax);
}
	CDatabase DB;	CRecordset m_rs;
	CString str , CDBSTR = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB.Open(CDBSTR,false,false,_T("ODBC;"),false);
	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		m_rs.MoveFirst();
		while(1)
		{
			if(m_rs.IsEOF()) break;
			for(int j=0; j<25;j++)
			{
				m_rs.GetFieldValue((short)j,str);	str1[i] = str1[i] + str + ",";
			}
			i++;
			m_rs.MoveNext();
		}
	}
	m_rs.Close();	DB.Close();
	return i;
}

void CSMS4DCView::OnInterferenceEs2fx() 
{
	CString m_SelX[500];
	long NrowX = OnESQx(m_SelX, _T("E"));
	if(NrowX>=1)
	{
		CInt_ES2ESoutDLG dlgList;
		dlgList.m_rowsX = NrowX+1;
		dlgList.m_strXt = new CString[NrowX];
		dlgList.m_strYt = new CString[NrowX];
		dlgList.m_rowsYx = new long[NrowX];

		CIntES2ESparDLG rangeDLG;
		rangeDLG.m_D = 500;
		rangeDLG.m_F = 36;
		rangeDLG.m_EDIT_uPr = -110;
		rangeDLG.m_EDIT_Pol = 10;
		rangeDLG.m_time = 20;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange_MHz = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
//			double kfactor = (157.0 / (157.0 - (dN)));
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;
			double uEDIT_Pr = rangeDLG.m_EDIT_uPr;
			BOOL uPr = rangeDLG.m_uPr;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			int progress_num=0;
			CString progress_str, progress_char = _T("I");
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
			PeekAndPump();
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			for(long Xi=0;Xi<NrowX;Xi++)
			{
				long ntIDX = atol(GetFld(m_SelX[Xi],2));
				double lonX = atof(GetFld(m_SelX[Xi],6));
				double latX = atof(GetFld(m_SelX[Xi],7));
				double frqX = atof(GetFld(m_SelX[Xi],20));

				CString m_SelY[2000];
				long NrowY = OnES2FXQy(ntIDX,latX, lonX, frqX, Drange, Frange_MHz, FALSE ,m_SelY); 
		//		if (NrowY>=1)
		//		{
					BeginWaitCursor();
					double PtX = atof(GetFld(m_SelX[Xi],13));
					CString PolX = GetFld(m_SelX[Xi],21);
					long grpIDX = atol(GetFld(m_SelX[Xi],4));
					CString NameX = GetFld(m_SelX[Xi],8);
					CString beamX = GetFld(m_SelX[Xi],3);
		//			double pi = 4.0*atan(1.0);
					double azmX = D2R*(atof(GetFld(m_SelX[Xi],10)) + atof(GetFld(m_SelX[Xi],11)))/2.0;
					double elvX = D2R*atof(GetFld(m_SelX[Xi],9));
					double gmaxX = atof(GetFld(m_SelX[Xi],12));
					CString patternX = GetFld(m_SelX[Xi],14);
					CString coefaX = GetFld(m_SelX[Xi],15);
					CString coefbX = GetFld(m_SelX[Xi],16);
					CString coefcX = GetFld(m_SelX[Xi],17);
					CString coefdX = GetFld(m_SelX[Xi],18);
					CString phi1X = GetFld(m_SelX[Xi],19);

					CAP7_ESantPattern  ESantPattern;

					double HaglX = 0;
//					double re = 6371000*kfactor;
					double Kbolt = 1.38e-23;

					CPoint pointst[2];
					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2, PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR = 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
//					CP452_Functions CP452;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strY="",strY1="";
					double fi,ti, RxrH[360]  ,  RxrV[360];					
					int Rxf0[360];
					for(long Yi = 0;Yi<NrowY;Yi++)
					{
						CString PolY = GetFld(m_SelY[Yi],13);
						double azmY = D2R*atof(GetFld(m_SelY[Yi],8));
						double elvY = D2R*atof(GetFld(m_SelY[Yi],9));
						double gmaxY = atof(GetFld(m_SelY[Yi],10));
						double lonY = atof(GetFld(m_SelY[Yi],4));
						double latY = atof(GetFld(m_SelY[Yi],3));
						double HaglY = atof(GetFld(m_SelY[Yi],5));
						double frqY = atof(GetFld(m_SelY[Yi],21));
						CString ctryY = GetFld(m_SelY[Yi],25);
						long IDstY = atol(GetFld(m_SelY[Yi],1));
						CString NameY = GetFld(m_SelY[Yi],2);

						CString RLONy, RLATy;
						Rad2Str(lonY*D2R,latY*D2R, &RLONy,&RLATy);

						double Dist1 = Distance_km(latX , lonX , latY , lonY); 
				//		if((lonY != lonX)&&(latY != latX))
						if(Dist1>0)
						{
/*
							double azmXY, azmYX, elvXY, elvYX, phiXY, Gtx, Grx;
							elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
							phiXY = (180.0/pi)*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
							Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("E"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);

							/////////////////////Antenna Rx/////////////////////
							CString ANT_Rx, antfile;
							ANT_Rx = GetFld(m_SelY[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
							elvYX = (pi/2.0) - elvYX;
							fi = (180.0/pi)*atan2(sin(elvYX)*sin(azmYX-azmY),(cos(elvY)*sin(elvYX)*cos(azmYX-azmY)+cos(elvYX)*sin(elvY)));
							ti = (180.0/pi)*acos(cos(elvYX)*cos(elvY)-sin(elvY)*sin(elvYX)*cos(azmYX-azmY));
							if (fi<0.0)		fi = fi + 359.4;
							Grx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							Grx = 10.0*log10(Grx);
							/////////////////////////////////////////
*/
							///////////////////////////////////P.452////////////////////////////////////////////////////////
							latmin = min(latX,latY);	lonmin = min(lonX,lonY);
							OnDatabaseStationsindesktop2(latmin, lonmin);
				
							LatLon2Point(latX,lonX,&pointst[0]); LatLon2Point(latY,lonY,&pointst[1]);
							x1=pointst[0].x;	y1=pointst[0].y;
							x2=pointst[1].x;	y2=pointst[1].y;
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
//							int *zi;			zi = new int[Np];
							CString *zi;		zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];			yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));
								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
//								hikm[i] = hi/1000.0;
								hikm[i] = hi;
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];
	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqX/1000.0, HaglX, HaglY, gmaxX,gmaxY, 
				Pressure, TempC, PolX, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;

							double azmXY, azmYX, elvXY, elvYX, phiXY, Gtx, Grx;
							elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
							phiXY = R2D*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
							Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("E"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);

							/////////////////////Antenna Rx/////////////////////
							CString ANT_Rx, antfile;
							ANT_Rx = GetFld(m_SelY[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
							elvYX = (pi/2.0) - elvYX;
							fi = R2D*atan2(sin(elvYX)*sin(azmYX-azmY),(cos(elvY)*sin(elvYX)*cos(azmYX-azmY)+cos(elvYX)*sin(elvY)));
							ti = R2D*acos(cos(elvYX)*cos(elvY)-sin(elvY)*sin(elvYX)*cos(azmYX-azmY));
							if (fi<0.0)		fi = fi + 359.4;
							Grx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							Grx = 10.0*log10(Grx);
							/////////////////////////////////////////
/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqX/1000.0,tp,N0,dN,beta,
													gmaxX,gmaxY,HaglX/1000.0,HaglY/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X; delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi;
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							double PolarDisc = 0;

							if	(((PolX == _T("H"))&&(PolY == _T("V")))||((PolX == _T("V"))&&(PolY == _T("H"))))
								PolarDisc = m_EDIT_Pol;

							double NFD = 0;
							NFD = NFD_ES2FX_Loss(grpIDX,NameX,frqX, IDstY,NameY,frqY) ;
							double PrdBw = PtX + Gtx - TotalLoss + Grx - NFD - PolarDisc;

							double NFigureY  = atof(GetFld(m_SelY[Yi],23));
							double noise_tY =  290.0;
							CString RxEmission = GetFld(m_SelY[Yi],19);
							double bdwdthY = 1000.0*Emission2NBW(RxEmission) ;
							double Npower = NFigureY + 10.0*log10(Kbolt*noise_tY*bdwdthY);
							double TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));

							BOOL rSysA =  RxSystem_A_D_ES2FX(RxEmission, tp) ;
							double Pr;
							if(uPr)	Pr = uEDIT_Pr;
							else	Pr = Npower + ESantPattern.func_Pr0_ES2FX(frqY, rSysA, tp) ;

							strY1.Format("%s,%ld,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%0.2f,%s",ctryY,IDstY,NameY,RLONy,RLATy,Dist,frqY,TD,PrdBw,Pr,PrdBw-Pr,tit);
						}
						else
							strY1.Format("%s,%ld,%s,%s  %s,%d,%0.4f,%s,%s,%s,%s,%s",ctryY,IDstY,NameY,RLONy,RLATy,0,frqY,"-","-","-","-","-");
						strY = strY+","+strY1;

						progress_char = str_rep("I",(int)((++progress_num)*50.0/((double)(NrowY*NrowX))) );
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(double)(NrowY*NrowX)),progress_char);
						PeekAndPump();
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

					}//for Yi
					strY.Delete(0);

					CString strX, RLONx, RLATx;
					CString ctryX = GetFld(m_SelX[Xi],1);
					Rad2Str(lonX*D2R,latX*D2R, &RLONx,&RLATx);
					strX.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.4f",ctryX,ntIDX,beamX,grpIDX,NameX,RLONx,RLATx,frqX);
					dlgList.m_strXt[Xi] = strX;
					dlgList.m_strYt[Xi] = strY;
					dlgList.m_rowsYx[Xi] = NrowY+1;

		//		}//if NrowY
			}//for  Xi
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

		//	if(dlgList.m_rowsYx[0]>0)
		//	{
				dlgList.m_mode = 2;
				dlgList.m_Title1 = _Z("P.452 ES2FX : Interference from the Wanted ES to the Found FX(s)");
				dlgList.m_Title2 = _Z("Wanted ES (Tx): ");
				dlgList.m_Title3 = _Z("Found FX(s) (Rx above 1GHz):");
				dlgList.DoModal();
		//	}
		//	else
		//	{
		//		delete [] dlgList.m_strXt;
		//		delete [] dlgList.m_strYt;
		//		delete [] dlgList.m_rowsYx;
		//		MessageBox("The Search Result is Empty.\t\t\n\nNo Rx Fixed Station Found.\t\t\n","Warning!!!",MB_ICONINFORMATION | MB_OK);
		//	}

		}//if rangeDLG
	}//if NrowX	
}

BOOL CSMS4DCView::RxSystem_A_D_ES2FX(CString emission, double timeP) 
{
	BOOL A_D = FALSE;		//Digital
	if(!emission.IsEmpty())
	{
		CString EM6 = emission.Mid(5,1);
		if((EM6==_T("3"))||(EM6==_T("8")))							A_D = TRUE;		//Analogue
		else if((EM6==_T("1"))||(EM6==_T("2"))||(EM6==_T("7")))		A_D = FALSE;	//Digital
		else
		{
			if(timeP>=1)	A_D = FALSE;	//Digital
			else			A_D = TRUE;		//Analogue
		}
	}
	return A_D;
}

void CSMS4DCView::OnInterferenceFx2es() 
{
	CString m_SelX[500];
	long NrowX = OnESQx(m_SelX, _T("R"));
	if(NrowX>=1)
	{
		CInt_ES2ESoutDLG dlgList;
		dlgList.m_rowsX = NrowX+1;
		dlgList.m_strXt = new CString[NrowX];
		dlgList.m_strYt = new CString[NrowX];
		dlgList.m_rowsYx = new long[NrowX];

		CIntES2ESparDLG rangeDLG;
		rangeDLG.m_D = 500;
		rangeDLG.m_F = 36;
		rangeDLG.m_EDIT_uPr = -144;
		rangeDLG.m_EDIT_Pol = 10;
		rangeDLG.m_time = 20;
		if(rangeDLG.DoModal()==IDOK)
		{
			BeginWaitCursor();
			double Frange_MHz = rangeDLG.m_F,   tp = rangeDLG.m_time, Drange = rangeDLG.m_D;
//			double beta = rangeDLG.m_beta, N0 = rangeDLG.m_N0, dN = rangeDLG.m_dN;
//			double kfactor = (157.0 / (157.0 - (dN)));
			double m_EDIT_Pol = rangeDLG.m_EDIT_Pol;
			double uEDIT_Pr = rangeDLG.m_EDIT_uPr;
			BOOL uPr = rangeDLG.m_uPr;

int flagAvWo = rangeDLG.m_flagAvWo;
double Pressure = rangeDLG.m_Pressure, TempC = rangeDLG.m_TempC, ha_Clutter = rangeDLG.m_ha_Clutter, dk_Clutter = rangeDLG.m_dk_Clutter;

			int progress_num=0;
			CString progress_str, progress_char = _T("I");
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
			PeekAndPump();
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			for(long Xi=0;Xi<NrowX;Xi++)
			{
				long ntIDX = atol(GetFld(m_SelX[Xi],2));
				double lonX = atof(GetFld(m_SelX[Xi],6));
				double latX = atof(GetFld(m_SelX[Xi],7));
				double frqX = atof(GetFld(m_SelX[Xi],20));

				CString m_SelY[2000];
				long NrowY = OnES2FXQy(ntIDX,latX, lonX, frqX, Drange, Frange_MHz, TRUE ,m_SelY); 
		//		if (NrowY>=1)
		//		{
					BeginWaitCursor();

					long grpIDX = atol(GetFld(m_SelX[Xi],4));
					CString PolX = GetFld(m_SelX[Xi],21);
					CString NameX = GetFld(m_SelX[Xi],8);
					CString beamX = GetFld(m_SelX[Xi],3);
		//			double pi = 4.0*atan(1.0);
				
					double azmX = D2R*(atof(GetFld(m_SelX[Xi],10)) + atof(GetFld(m_SelX[Xi],11)))/2.0;
					double elvX = D2R*atof(GetFld(m_SelX[Xi],9));
					double gmaxX = atof(GetFld(m_SelX[Xi],12));
					CString patternX = GetFld(m_SelX[Xi],14);
					CString coefaX = GetFld(m_SelX[Xi],15);
					CString coefbX = GetFld(m_SelX[Xi],16);
					CString coefcX = GetFld(m_SelX[Xi],17);
					CString coefdX = GetFld(m_SelX[Xi],18);
					CString phi1X = GetFld(m_SelX[Xi],19);

					CAP7_ESantPattern  ESantPattern;

					double HaglX = 0;
		//			double re = 6371000*kfactor;
					double Kbolt = 1.38e-23;

					CPoint pointst[2];
					long x1,y1,x2,y2 , xmin, xmax, xabs, ymin, ymax, yabs , Np , m_scalfactor = 16;
//					double val_p, o_loss_bd,o_loss_bs,o_loss_ba,o_loss_d,o_clear_e,o_clear_50,o_k_e;
//					int o_done_d,o_done_a,o_path_type, status ;
					int path_type;
					double xps,yps,xpm,ypm , hi , Dist,Linkk,TotalLoss,FsLoss;
					CString tit;
					double latmin,	lonmin;				

//					int PN452_SUCCESS = 0, PN452_PATH = -1, PN452_PROF = -2, PN452_FREQ = -3, PN452_ANT_HTS = -6;
//					int PN452_LOS_CLEAR = 0, PN452_LOS_SUB_P = 1, PN452_TRANS_HOZ = 2, PN452_ERROR = 3;

					CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
		//			CP452_Functions CP452;

					CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
					CString FilepathData = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + "\\Texts\\";

					CString strY="",strY1="";
					double fi,ti, RxrH[360]  ,  RxrV[360];					
					int Rxf0[360];

					for(long Yi = 0;Yi<NrowY;Yi++)
					{
						CString PolY = GetFld(m_SelY[Yi],13);
						double azmY = D2R*atof(GetFld(m_SelY[Yi],8));
						double elvY = D2R*atof(GetFld(m_SelY[Yi],9));
						double gmaxY = atof(GetFld(m_SelY[Yi],10));
						double lonY = atof(GetFld(m_SelY[Yi],4));
						double latY = atof(GetFld(m_SelY[Yi],3));
						double HaglY = atof(GetFld(m_SelY[Yi],5));
						double frqY = atof(GetFld(m_SelY[Yi],6));
						CString ctryY = GetFld(m_SelY[Yi],25);
						long IDstY = atol(GetFld(m_SelY[Yi],1));
						CString NameY = GetFld(m_SelY[Yi],2);

						double PtY = atof(GetFld(m_SelY[Yi],7));	PtY = 10.0*log10(PtY);

						CString RLONy, RLATy;
						Rad2Str(lonY*D2R,latY*D2R, &RLONy,&RLATy);

						double Dist1 = Distance_km(latX , lonX , latY , lonY); 
				//		if((lonY != lonX)&&(latY != latX))
						if(Dist1>0)
						{
/*
							double azmXY, azmYX, elvXY, elvYX, phiXY, Gtx, Grx;
							elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
							phiXY = (180.0/pi)*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
							Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("R"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);

							/////////////////////Antenna Tx/////////////////////
							CString ANT_Rx, antfile;
							ANT_Rx = GetFld(m_SelY[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
							elvYX = (pi/2.0) - elvYX;
							fi = (180.0/pi)*atan2(sin(elvYX)*sin(azmYX-azmY),(cos(elvY)*sin(elvYX)*cos(azmYX-azmY)+cos(elvYX)*sin(elvY)));
							ti = (180.0/pi)*acos(cos(elvYX)*cos(elvY)-sin(elvY)*sin(elvYX)*cos(azmYX-azmY));
							if (fi<0.0)		fi = fi + 359.4;
							Grx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							Grx = 10.0*log10(Grx);
							/////////////////////////////////////////
*/
							///////////////////////////////////P.452////////////////////////////////////////////////////////
							latmin = min(latX,latY);		lonmin = min(lonX,lonY);
							OnDatabaseStationsindesktop2(latmin, lonmin);
							LatLon2Point(latX,lonX,&pointst[1]);	LatLon2Point(latY,lonY,&pointst[0]);

							x1=pointst[0].x;	y1=pointst[0].y;
							x2=pointst[1].x;	y2=pointst[1].y;
							xmin=min(x1 , x2);	xmax=max(x1 , x2);	xabs=xmax-xmin;
							ymin=min(y1 , y2);	ymax=max(y1 , y2);	yabs=ymax-ymin;

							Np =((xabs>=yabs) ? xabs+1 : yabs+1);
							Np = (Np-1) * m_scalfactor + 1;

							double *X;		X=new double[Np];
							double *Y;		Y=new double[Np];
							if (xabs>=yabs)
							{
								for (int i=0;i<Np;i++)
								{
									X[i]=((x1<x2) ? x1+(double)i/(double)m_scalfactor : x1-(double)i/(double)m_scalfactor);
									Y[i]=((double)y1+(double)((X[i]-x1)*(y2-y1))/((double)(x2-x1)));
								}
							}
							else
							{
								for (int i=0;i<Np;i++)
								{
									Y[i]=((y1<y2) ? y1+(double)i/(double)m_scalfactor :y1-(double)i/(double)m_scalfactor);
									X[i]=((double)x1+(double)((Y[i]-y1)*(x2-x1))/((double)(y2-y1)));
								}
							}
							double *di;			di=new double[Np];
							double *x_en;		x_en=new double[Np];
							double *y_en;		y_en=new double[Np];
							double *hikm;		hikm=new double[Np];
//							int *zi;			zi = new int[Np];
							CString *zi;		zi = new CString[Np+1];

							for (int i=0;i<Np;i++)
							{
								xps = X[i];
								yps = 1200.0-1.0-(Y[i]);
								xpm = xps + 600.0*((double)(pDoc->TileX-1));
								ypm = yps + 600.0*((double)(pDoc->TileY-1));

								x_en[i] = pDoc->m_Lower_left_x + pDoc->m_Resolution_x*(xpm-1.0);
								y_en[i] = pDoc->m_Lower_left_y + pDoc->m_Resolution_y*(ypm-1.0);
								y_en[i] = y_en[i]-pDoc->m_Resolution_y/2.0;
								x_en[i] = x_en[i]-pDoc->m_Resolution_x/2.0;

								if (pDoc->TileInfo != globeTileInfo)
								{
									CUtm m_utm;
									m_utm.y = y_en[i];
									m_utm.x = x_en[i];
									m_utm.UTM2philambda();
									y_en[i]=m_utm.phi;
									x_en[i]=m_utm.lambda;
								}
								hi = RoundBUF_Hg(xps, yps);
//								hikm[i] = hi/1000.0;
								hikm[i] = hi;
								di[i] = Distance_km( y_en[0], x_en[0], y_en[i], x_en[i]);
								zi[i] = LandSeaCoastal(x_en[i],y_en[i]);
							}
							Dist = di[Np-1]-di[0];

	double LongM, LatM;	
	PathMean(lonX, latX, lonY, latY, &LongM, &LatM);
	
	zi[i] = "";

	double loss[7];
	int status = BasicTxLossP452V15(di, hikm, zi, Np, LongM, LatM, FilepathData,
				tp, flagAvWo, frqY/1000.0, HaglY, HaglX, gmaxY,gmaxX, 
				Pressure, TempC, PolY, ha_Clutter, dk_Clutter, 
				loss);

	if(status==0)
	{
		path_type = loss[5];
		Linkk = loss[6];
		TotalLoss = loss[4];
		if(path_type==3)	tit = _Z("Transhorizon Path");
		else				tit = _Z("Line of Sight Path");
	}
	else
	{
		if     (status==1)  tit = _Z("The file 'DN50.dat' was not opened.");
		else if(status==2)  tit = _Z("The file 'N050.dat' was not opened.");
		Linkk = 4.0/3.0;
		FsLoss = 92.45 + (20.0 * log10 (Dist * frqY/1000.0));
		TotalLoss = FsLoss;
		tit = _Z("Free Space");
	}
	double re = Linkk*6371000;
							double azmXY, azmYX, elvXY, elvYX, phiXY, Gtx, Grx;
							elvXY = AZ_EL(latX , lonX , latY , lonY, HaglX, HaglY, re, &azmXY) ;
							phiXY = (180.0/pi)*acos(cos(elvXY)*cos(elvX)*cos(azmXY-azmX)+sin(elvXY)*sin(elvX));
							Gtx = ESantPattern.ESantTuser(phiXY,ntIDX,beamX,_T("R"),gmaxX,patternX,coefaX,coefbX,coefcX,coefdX,phi1X);

							/////////////////////Antenna Tx/////////////////////
							CString ANT_Rx, antfile;
							ANT_Rx = GetFld(m_SelY[Yi],14);
							antfile.Format("%sAntenna\\ant_%s.ant",((CSMS4DCApp *)AfxGetApp())->m_AppPath ,ANT_Rx);
							ReadAntennaData(antfile,Rxf0,RxrH,RxrV) ;
							elvYX = AZ_EL(latY , lonY , latX , lonX, HaglY, HaglX, re, &azmYX) ;
							elvYX = (pi/2.0) - elvYX;
							fi = R2D*atan2(sin(elvYX)*sin(azmYX-azmY),(cos(elvY)*sin(elvYX)*cos(azmYX-azmY)+cos(elvYX)*sin(elvY)));
							ti = R2D*acos(cos(elvYX)*cos(elvY)-sin(elvY)*sin(elvYX)*cos(azmYX-azmY));
							if (fi<0.0)		fi = fi + 359.4;
							Grx = Interp2(Rxf0,RxrH,fi,360) * Interp2(Rxf0,RxrV,ti,360);
							Grx = 10.0*log10(Grx);
							/////////////////////////////////////////

/*
							val_p = 0;
							status = CP452.pn452_Lb(di,hikm,zi,Np,frqY/1000.0,tp,N0,dN,beta,
													gmaxY,gmaxX,HaglY/1000.0,HaglX/1000.0,
													&val_p,&o_loss_bd,&o_loss_bs,&o_loss_ba,&o_loss_d,
													&o_done_d,&o_done_a,&o_clear_e,&o_clear_50,&o_path_type,&o_k_e);

							if(status == PN452_SUCCESS)
							{
								Linkk = o_k_e;
								path_type = o_path_type;
								TotalLoss = val_p;

								if ((path_type==PN452_LOS_CLEAR)||(path_type==PN452_ERROR))	tit = _Z("Line of Sight with > 0.6 Fresnel Clearance");
								else if (path_type==PN452_LOS_SUB_P)						tit = _Z("Line of Sight with Sub-Path Obstruction");
								else if (path_type==PN452_TRANS_HOZ)						tit = _Z("Transhorizon Path");
							}
							else
							{
								Linkk = (157.0 / (157.0 - (dN)));
								FsLoss = 92.45 + (20.0 * log10 (Dist * frqX/1000.0));
								TotalLoss = FsLoss;
								tit = _Z("Free Space");
							}
*/
							delete [] X; delete [] Y; delete [] hikm; delete [] di; delete [] x_en; delete [] y_en; delete [] zi; 
							//////////////////////////////////////////////////////////////////////////////////////////
							/////////////////// Polarization Discrimination ////////
							double PolarDisc = 0;

							if	(((PolX == _T("H"))&&(PolY == _T("V")))||((PolX == _T("V"))&&(PolY == _T("H"))))
								PolarDisc = m_EDIT_Pol;

							double NFD = 0;
							NFD = NFD_FX2ES_Loss(IDstY,NameY,frqY,grpIDX,NameX,frqX) ;
							double PrdBw = PtY + Gtx - TotalLoss + Grx - NFD - PolarDisc;

							double noise_tX = atof(GetFld(m_SelX[Xi],23));
							if(noise_tX == 0)
							{
								if(frqX<=10000)							noise_tX = 100;
								else if ((frqX>10000)&&(frqX<=15000))	noise_tX = 200;
								else									noise_tX = 300;
							}
							double bdwdthX = 1000.0*atof(GetFld(m_SelX[Xi],24));
							double Npower = 10.0*log10(Kbolt*noise_tX*bdwdthX);
							double TD = 10.0*log10(1.0+pow(10.0,(PrdBw-Npower)/10.0));
		
							BOOL rSysA =  RxSystemGRP_A_D_FX2ES(grpIDX) ;
							double Pr;
							if(uPr) Pr = uEDIT_Pr;
							else 	Pr = Npower + ESantPattern.func_Pr0_FX2ES(frqX, rSysA , tp) ;

							strY1.Format("%s,%ld,%s,%s  %s,%0.0f,%0.4f,%0.3f,%0.2f,%0.2f,%0.2f,%s",ctryY,IDstY,NameY,RLONy,RLATy,Dist,frqY,TD,PrdBw,Pr,PrdBw-Pr,tit);
						}// Dist>0
						else
							strY1.Format("%s,%ld,%s,%s  %s,%d,%0.4f,%s,%s,%s,%s,%s",ctryY,IDstY,NameY,RLONy,RLATy,0,frqY,"-","-","-","-","-");
						strY = strY+","+strY1;

						progress_char = str_rep("I",(int)((++progress_num)*50.0/((double)(NrowY*NrowX))) );
						progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(double)(NrowY*NrowX)),progress_char);
						PeekAndPump();
						((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

					}//for Yi
					strY.Delete(0);
					CString strX, RLONx, RLATx;
					CString ctryX = GetFld(m_SelX[Xi],1);
					Rad2Str(lonX*D2R,latX*D2R, &RLONx,&RLATx);
					strX.Format("%s,%ld,%s,%ld,%s,%s  %s,%0.4f",ctryX,ntIDX,beamX,grpIDX,NameX,RLONx,RLATx,frqX);
					dlgList.m_strXt[Xi] = strX;
					dlgList.m_strYt[Xi] = strY;
					dlgList.m_rowsYx[Xi] = NrowY+1;

	//			}//if NrowY

			}//for  Xi
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");

	//		if(dlgList.m_rowsYx[0]>0)
	//		{
				dlgList.m_mode = 3;
				dlgList.m_Title1 = _Z("P.452 FX2ES : Interference from the Found FX(s) to the Wanted ES");
				dlgList.m_Title2 = _Z("Wanted ES (Rx): ");
				dlgList.m_Title3 = _Z("Found FX(s) (Tx above 1GHz):");
				dlgList.DoModal();
	//		}
	//		else
	//		{
	//			delete [] dlgList.m_strXt;
	//			delete [] dlgList.m_strYt;
	//			delete [] dlgList.m_rowsYx;
	//			MessageBox("The Search Result is Empty.\t\t\n\nNo Tx Fixed Station Found.\t\t\n","Warning!!!",MB_ICONINFORMATION | MB_OK);
	//		}

		}//if rangeDLG
	}//if NrowX		
}


BOOL CSMS4DCView::RxSystem_A_D_FX2ES(CString emission) 
{
	BOOL A_D = TRUE;	//Analogue
	if(!emission.IsEmpty())
	{
		CString EM6 = emission.Mid(5,1);
		if((EM6==_T("1"))||(EM6==_T("2"))||(EM6==_T("7")))	A_D = FALSE;		//Digital
	}
	return A_D;
}


BOOL CSMS4DCView::RxSystemGRP_A_D_FX2ES(long grpID) 
{
	int DataBaseFlag = 1;		//local database

	BOOL GRP_A_D = TRUE;
	CDatabase DB;
	CRecordset m_rs;
	CString strSQT , design_emi;

	strSQT.Format("SELECT design_emi FROM emiss WHERE (((grp_id)=%ld));",grpID);
	long k = 0;
	BOOL A_D[1000];

	if(DataBaseFlag==0)		DB.Open(_T("SRS_DB"),false,false,_T("ODBC;"),false);
	else					DB.Open((((CSMS4DCApp *)AfxGetApp())->m_CDBSTR),false,false,_T("ODBC;"),false);

	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		m_rs.MoveFirst();
		while(1)
		{
			if(m_rs.IsEOF()) break;

			m_rs.GetFieldValue((short)0,design_emi);
			A_D[k] = RxSystem_A_D_ES2ES(design_emi);
			k++;
			m_rs.MoveNext();
		}
	}
	m_rs.Close();	DB.Close();

	if(k>0)
	{
		BOOL A_D0 = A_D[0];
		for(long i=0;i<k;i++)
		{
			if(A_D0 != A_D[i])	{GRP_A_D = TRUE;	break;}
			else			     GRP_A_D = A_D0;
		}
	}
	return GRP_A_D;
}

BOOL CSMS4DCView::PreTranslateMessage(MSG* pMsg) 
{
	if (NULL != m_pToolTip)        m_pToolTip->RelayEvent(pMsg);
	if (NULL != m_pToolTipES)     m_pToolTipES->RelayEvent(pMsg);
	return CScrollView::PreTranslateMessage(pMsg);
}

CString CSMS4DCView::IDst2Information(long IDst) 
{
	CString strSQT, CDBSTR , strT = _T("");
	CDatabase DB;
	CRecordset m_rs;
//	strSQT.Format(_T("SELECT * FROM STtable WHERE (((IDst)=%ld));"),IDst);
	strSQT.Format(_T("SELECT * FROM %s WHERE (((IDst)=%ld));"),m_qSTtable,IDst);

	CDBSTR = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB.Open(CDBSTR,false,false,_T("ODBC;"),false);

	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		CString str,str0 = _T("");
		m_rs.MoveFirst();
		m_rs.GetFieldValue((short)4,str);	str0 = str0 + str + _T(",");
		m_rs.GetFieldValue((short)5,str);	str0 = str0 + str + _T(",");
		m_rs.GetFieldValue((short)6,str);	str0 = str0 + str + _T(",");
		m_rs.GetFieldValue((short)17,str);	str0 = str0 + str + _T(",");
		m_rs.GetFieldValue((short)18,str);	str0 = str0 + str;
		strT = str0;
	}
	m_rs.Close();	DB.Close();
	return strT;
}

BOOL CSMS4DCView::OnMouseWheel(UINT nFlags, short zDelta, CPoint pt) 
{
	int n = 0;
	if		(zDelta<0)		n = +10;
	else if (zDelta>0)		n = -10;

	SetScrollPos(SB_VERT,VScrollpos + n);
	VScrollpos = GetScrollPos(SB_VERT);	
	InvalidateRect(NULL,false);

	return FALSE;
//	return CScrollView::OnMouseWheel(nFlags, zDelta, pt);
}



double CSMS4DCView::NFD_FX2ES_Loss(long ID_Tx,CString Name_Tx,double fMHz_Tx,long ID_Grp,CString Name_ES,double fMHz_ES) 
{
	///////////////////////////////// NFD ES and Fixed Station/////////////////////////////////
	double NFD = 0;
	CString str;

	str.Format("SELECT * FROM TxFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Tx);
	CTxRxFiltersSet m_pSet(str);
	m_pSet.Open();
	if(m_pSet.GetRecordCount()==1)
	{
		double ft0[20] , at0[20];
		m_pSet.MoveFirst();
		int TxNum = 0;
		while( !m_pSet.IsEOF())
		{
			ft0[TxNum] = m_pSet.m_CS;
			at0[TxNum] = m_pSet.m_Att;
			TxNum++;
			m_pSet.MoveNext();
		}
		m_pSet.Close();

		str.Format("SELECT * FROM ESFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Grp);
		CTxRxFiltersSet m_pSet1(str);
		m_pSet1.Open();
		if(m_pSet1.GetRecordCount()==1)
		{
			double fr0[20] , ar0[20];
			m_pSet1.MoveFirst();
			int RxNum = 0;
			while( !m_pSet1.IsEOF())
			{
				fr0[RxNum] = m_pSet1.m_CS;
				ar0[RxNum] = m_pSet1.m_Att;
				RxNum++;
				m_pSet1.MoveNext();
			}
			m_pSet1.Close();

			double  ft[20] , at[20], fr[20] , ar[20];
			double	ft0max = MaxValue(ft0,TxNum),	ft0min = MinValue(ft0,TxNum),
					fr0max = MaxValue(fr0,RxNum),	fr0min = MinValue(fr0,RxNum);

			double stepTx=(ft0max-ft0min)/19.0;
			double stepRx=(fr0max-fr0min)/19.0;
			int i;
			for( i=0;i<20;i++)
			{
				ft[i] = ft0min + i*stepTx;		at[i] = interwt(ft0,at0,TxNum,ft[i]);
				fr[i] = fr0min + i*stepRx;		ar[i] = interwt(fr0,ar0,RxNum,fr[i]);
				ft[i] = (ft[i] + fMHz_Tx)*1000000.0;
				fr[i] = (fr[i] + fMHz_ES)*1000000.0;
			}
			double	ftmax = MaxValue(ft,20),	ftmin = MinValue(ft,20),
					frmax = MaxValue(fr,20),	frmin = MinValue(fr,20),
					fmax = max(ftmax,frmax),	fmin = min(ftmin,frmin);

			int nf = 1000;
			double	fstep=(fmax-fmin)/nf;
			double *fnew;	fnew = new double[nf];
			double *atnew;  atnew = new double[nf];
			double *arnew;  arnew = new double[nf];
			double *y;		y = new double[nf-1];
			double *z;		z = new double[nf-1];
			double *fnewp;  fnewp = new double[nf];
			double *atnewp; atnewp = new double[nf];
			double *arnewp; arnewp = new double[nf];
			double *atrp;	atrp = new double[nf];

			for( i=0;i<nf;i++)
			{
				fnew[i] = fmin + i*fstep;
				atnew[i] = interwt(ft,at,20,fnew[i]);
				arnew[i] = interwt(fr,ar,20,fnew[i]);

				fnewp[i] = fnew[i]/1000000.0;
				atnewp[i] = -atnew[i];
				arnewp[i] = -arnew[i];
				atrp[i] = -atnew[i]-arnew[i];
			}
			double fc,a,b, sumy = 0.0, sumz = 0.0 ;
			for( i=0;i<nf-1;i++)
			{
				fc = fabs(fnew[i+1]-fnew[i]);	a = (atnew[i+1]-atnew[i])/fc;	b = atnew[i];
				y[i] = subsection(a,b,fc);
				a = (atnew[i+1]-atnew[i]+arnew[i+1]-arnew[i])/fc;				b = atnew[i]+arnew[i];
				z[i] = subsection(a,b,fc); 
				sumy += y[i];		sumz += z[i];
			}
			NFD = 10.0*log10(sumy/sumz);
			delete [] fnew;	delete [] atnew;	delete [] arnew;	delete [] y;	delete [] z;
			delete [] atnewp;	delete [] arnewp;	delete [] fnewp;	delete [] atrp;

		}	// end if Rx Recoard set
		else
		{
			str.Format("\nThe Mask Filter is not defined for the Earth Station : %s  (Group ID : %ld).\t\t\n(Net Filter Discrimination = 0 dB)\n",Name_ES,ID_Grp);
			MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
		}

	}	// end if Tx Recoard set
	else
	{
		str.Format(_Z("\nTx Filter is not defined for the Transmitter : %s.\t\t\n(Net Filter Discrimination = 0 dB)\n"),Name_Tx);
		MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
	}
	return NFD;
}


double CSMS4DCView::NFD_ES2FX_Loss(long ID_Grp,CString Name_ES,double fMHz_ES,long ID_Rx,CString Name_Rx,double fMHz_Rx) 
{
	///////////////////////////////// NFD Fixed Service/////////////////////////////////
	double NFD = 0;
	CString str;

	str.Format("SELECT * FROM ESFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Grp);
	CTxRxFiltersSet m_pSet(str);
	m_pSet.Open();
	if(m_pSet.GetRecordCount()==1)
	{
		double ft0[20] , at0[20];
		m_pSet.MoveFirst();
		int TxNum = 0;
		while( !m_pSet.IsEOF())
		{
			ft0[TxNum] = m_pSet.m_CS;
			at0[TxNum] = m_pSet.m_Att;
			TxNum++;
			m_pSet.MoveNext();
		}
		m_pSet.Close();

		str.Format("SELECT * FROM RxFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Rx);
		CTxRxFiltersSet m_pSet1(str);
		m_pSet1.Open();
		if(m_pSet1.GetRecordCount()==1)
		{
			double fr0[20] , ar0[20];
			m_pSet1.MoveFirst();
			int RxNum = 0;
			while( !m_pSet1.IsEOF())
			{
				fr0[RxNum] = m_pSet1.m_CS;
				ar0[RxNum] = m_pSet1.m_Att;
				RxNum++;
				m_pSet1.MoveNext();
			}
			m_pSet1.Close();

			double  ft[20] , at[20], fr[20] , ar[20];
			double	ft0max = MaxValue(ft0,TxNum),	ft0min = MinValue(ft0,TxNum),
					fr0max = MaxValue(fr0,RxNum),	fr0min = MinValue(fr0,RxNum);

			double stepTx=(ft0max-ft0min)/19.0;
			double stepRx=(fr0max-fr0min)/19.0;
			int i;
			for( i=0;i<20;i++)
			{
				ft[i] = ft0min + i*stepTx;		at[i] = interwt(ft0,at0,TxNum,ft[i]);
				fr[i] = fr0min + i*stepRx;		ar[i] = interwt(fr0,ar0,RxNum,fr[i]);

				ft[i] = (ft[i] + fMHz_ES)*1000000.0;
				fr[i] = (fr[i] + fMHz_Rx)*1000000.0;
			}
			double	ftmax = MaxValue(ft,20),	ftmin = MinValue(ft,20),
					frmax = MaxValue(fr,20),	frmin = MinValue(fr,20),
					fmax = max(ftmax,frmax),	fmin = min(ftmin,frmin);

			int nf = 1000;
			double	fstep=(fmax-fmin)/nf;
			double *fnew;	fnew = new double[nf];
			double *atnew;  atnew = new double[nf];
			double *arnew;  arnew = new double[nf];
			double *y;		y = new double[nf-1];
			double *z;		z = new double[nf-1];
			double *fnewp;  fnewp = new double[nf];
			double *atnewp; atnewp = new double[nf];
			double *arnewp; arnewp = new double[nf];
			double *atrp;	atrp = new double[nf];

			for( i=0;i<nf;i++)
			{
				fnew[i] = fmin + i*fstep;
				atnew[i] = interwt(ft,at,20,fnew[i]);
				arnew[i] = interwt(fr,ar,20,fnew[i]);

				fnewp[i] = fnew[i]/1000000.0;
				atnewp[i] = -atnew[i];
				arnewp[i] = -arnew[i];
				atrp[i] = -atnew[i]-arnew[i];
			}
			double fc,a,b, sumy = 0.0, sumz = 0.0 ;
			for( i=0;i<nf-1;i++)
			{
				fc = fabs(fnew[i+1]-fnew[i]);	a = (atnew[i+1]-atnew[i])/fc;	b = atnew[i];
				y[i] = subsection(a,b,fc);
				a = (atnew[i+1]-atnew[i]+arnew[i+1]-arnew[i])/fc;				b = atnew[i]+arnew[i];
				z[i] = subsection(a,b,fc); 
				sumy += y[i];		sumz += z[i];
			}
			NFD = 10.0*log10(sumy/sumz);
			delete [] fnew;	delete [] atnew;	delete [] arnew;	delete [] y;	delete [] z;
			delete [] atnewp;	delete [] arnewp;	delete [] fnewp;	delete [] atrp;

		}	// end if Rx Recoard set
		else
		{
			str.Format(_Z("\nRx Filter is not defined for the Receiver : %s.\t\t\n(Net Filter Discrimination = 0 dB)\n"),Name_Rx);
			MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
		}

	}	// end if Tx Recoard set
	else
	{
		str.Format("\nThe mask Filter is not defined for the Earth Station : %s  (Group ID : %ld).\t\t\n(Net Filter Discrimination = 0 dB)\n",Name_ES,ID_Grp);
		MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
	}
	return NFD;
}

double CSMS4DCView::NFD_ES2ES_Loss(long ID_Grp1,CString Name_ES1,double fMHz_ES1,long ID_Grp2,CString Name_ES2,double fMHz_ES2) 
{
	///////////////////////////////// NFD Fixed Service/////////////////////////////////
	double NFD = 0;
	CString str;

	str.Format("SELECT * FROM ESFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Grp1);
	CTxRxFiltersSet m_pSet(str);
	m_pSet.Open();
	if(m_pSet.GetRecordCount()==1)
	{
		double ft0[20] , at0[20];
		m_pSet.MoveFirst();
		int TxNum = 0;
		while( !m_pSet.IsEOF())
		{
			ft0[TxNum] = m_pSet.m_CS;
			at0[TxNum] = m_pSet.m_Att;
			TxNum++;
			m_pSet.MoveNext();
		}
		m_pSet.Close();

		str.Format("SELECT * FROM ESFilters WHERE (((EqID)=%ld)) ORDER BY CS;",ID_Grp2);
		CTxRxFiltersSet m_pSet1(str);
		m_pSet1.Open();
		if(m_pSet1.GetRecordCount()==1)
		{
			double fr0[20] , ar0[20];
			m_pSet1.MoveFirst();
			int RxNum = 0;
			while( !m_pSet1.IsEOF())
			{
				fr0[RxNum] = m_pSet1.m_CS;
				ar0[RxNum] = m_pSet1.m_Att;
				RxNum++;
				m_pSet1.MoveNext();
			}
			m_pSet1.Close();

			double  ft[20] , at[20], fr[20] , ar[20];
			double	ft0max = MaxValue(ft0,TxNum),	ft0min = MinValue(ft0,TxNum),
					fr0max = MaxValue(fr0,RxNum),	fr0min = MinValue(fr0,RxNum);

			double stepTx=(ft0max-ft0min)/19.0;
			double stepRx=(fr0max-fr0min)/19.0;
			int i;
			for( i=0;i<20;i++)
			{
				ft[i] = ft0min + i*stepTx;		at[i] = interwt(ft0,at0,TxNum,ft[i]);
				fr[i] = fr0min + i*stepRx;		ar[i] = interwt(fr0,ar0,RxNum,fr[i]);

				ft[i] = (ft[i] + fMHz_ES1)*1000000.0;
				fr[i] = (fr[i] + fMHz_ES2)*1000000.0;
			}
			double	ftmax = MaxValue(ft,20),	ftmin = MinValue(ft,20),
					frmax = MaxValue(fr,20),	frmin = MinValue(fr,20),
					fmax = max(ftmax,frmax),	fmin = min(ftmin,frmin);

			int nf = 1000;
			double	fstep=(fmax-fmin)/nf;
			double *fnew;	fnew = new double[nf];
			double *atnew;  atnew = new double[nf];
			double *arnew;  arnew = new double[nf];
			double *y;		y = new double[nf-1];
			double *z;		z = new double[nf-1];
			double *fnewp;  fnewp = new double[nf];
			double *atnewp; atnewp = new double[nf];
			double *arnewp; arnewp = new double[nf];
			double *atrp;	atrp = new double[nf];

			for( i=0;i<nf;i++)
			{
				fnew[i] = fmin + i*fstep;
				atnew[i] = interwt(ft,at,20,fnew[i]);
				arnew[i] = interwt(fr,ar,20,fnew[i]);

				fnewp[i] = fnew[i]/1000000.0;
				atnewp[i] = -atnew[i];
				arnewp[i] = -arnew[i];
				atrp[i] = -atnew[i]-arnew[i];
			}
			double fc,a,b, sumy = 0.0, sumz = 0.0 ;
			for( i=0;i<nf-1;i++)
			{
				fc = fabs(fnew[i+1]-fnew[i]);	a = (atnew[i+1]-atnew[i])/fc;			b = atnew[i];
				y[i] = subsection(a,b,fc);
				a = (atnew[i+1]-atnew[i]+arnew[i+1]-arnew[i])/fc;	b = atnew[i]+arnew[i];
				z[i] = subsection(a,b,fc); 
				sumy += y[i];	sumz += z[i];
			}
			NFD = 10.0*log10(sumy/sumz);
			delete [] fnew;	delete [] atnew;	delete [] arnew;	delete [] y;	delete [] z;
			delete [] atnewp;	delete [] arnewp;	delete [] fnewp;	delete [] atrp;

		}	// end if Rx Recoard set
		else
		{
			str.Format("\nThe mask Filter is not defined for the Earth Station : %s  (Group ID : %ld).\t\t\n(Net Filter Discrimination = 0 dB)\n",Name_ES2,ID_Grp2);
			MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
		}

	}	// end if Tx Recoard set
	else
	{
		str.Format("\nThe mask Filter is not defined for the Earth Station : %s  (Group ID : %ld).\t\t\n(Net Filter Discrimination = 0 dB)\n",Name_ES1,ID_Grp1);
		MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
	}
	return NFD;
}

void CSMS4DCView::OnDatabaseDisplayearthstation() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");

	CDataBaseLDLG dbdlg;
	int xxDLG = dbdlg.DoModal();
	if (xxDLG == IDOK)
	{
		CString m_Sel;
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			double lat1,lon1;
			CString name1;
			long ID;
			for (int i=0;i<Nrow;i++)
			{
				m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				if (m_Sel!="")
				{
					ID = atol(GetFld(m_Sel,1));				name1 = GetFld(m_Sel,2);
					lat1  = atof(GetFld(m_Sel,22));			lon1  = atof(GetFld(m_Sel,21));
					AddEarthStation_disp(ID,lat1,lon1,name1) ;
				}
			}
			InvalidateRect(NULL,false);
		}
	}
	Set_STtable_Default();
}

void CSMS4DCView::DrawSymboleEarthStation(CDC* pDC,double lats,double lons,COLORREF color1,int len1) 
{
	CPen penStation(PS_SOLID,1,color1);
	CPen *Oldpen=pDC->SelectObject(&penStation);
	CBrush brushStation(color1);
	CBrush *Oldbrush=pDC->SelectObject(&brushStation);

	CPoint points;
	LatLon2Point(lats,lons,&points);
	pDC->MoveTo(points.x-len1,points.y);
	pDC->LineTo(points.x+len1,points.y);
	pDC->MoveTo(points.x,points.y-3*len1);
	pDC->LineTo(points.x,points.y+3*len1);

	pDC->Arc(points.x-2*len1,points.y-5*len1,points.x+2*len1,points.y-1*len1,points.x-2*len1,points.y-3*len1,points.x+2*len1,points.y-3*len1);

	pDC->MoveTo(points.x-len1,points.y-len1);
	pDC->LineTo(points.x+len1,points.y-len1);
	pDC->LineTo(points.x+len1,points.y+len1);
	pDC->LineTo(points.x-len1,points.y+len1);
	pDC->LineTo(points.x-len1,points.y-len1);

	CPoint pointsBT[5];
	pointsBT[0]=CPoint(points.x-len1,points.y+len1);
	pointsBT[1]=CPoint(points.x+len1,points.y+len1);
	pointsBT[2]=CPoint(points.x+3*len1,points.y+3*len1);
	pointsBT[3]=CPoint(points.x-3*len1,points.y+3*len1);
	pointsBT[4]=pointsBT[0];
	pDC->Polygon(pointsBT,5);

	if(!pDC->IsPrinting())
	{
		pDC->SelectObject(&Oldpen);	pDC->SelectObject(&Oldbrush);
	}
}

void CSMS4DCView::AddEarthStation_disp(long ID,double lat1,double lon1,CString name1) 
{
	BeginWaitCursor();
	if (Num_EST==0)
	{
		Num_EST = 1;
		ID_EST = new long[Num_EST];
		Lat_EST = new double[Num_EST];
		Lon_EST = new double[Num_EST];
		Name_EST = new CString[Num_EST];
		m_ESTinfo = new CString[Num_EST];

		ID_EST[Num_EST-1] = ID;
		Lat_EST[Num_EST-1] = lat1;
		Lon_EST[Num_EST-1] = lon1;
		Name_EST[Num_EST-1] = name1;
		m_ESTinfo[Num_EST-1] = IDstES2Information(ID) ;
	}
	else
	{
		if(DispEarthStationQ(ID,name1)==FALSE )
		{
			Num_EST = Num_EST + 1;

			long *ID_EST0 = new long[Num_EST];
			double *Lat_EST0 = new double[Num_EST];
			double *Lon_EST0 = new double[Num_EST];
			CString *Name_EST0 = new CString[Num_EST];
			CString *m_ESTinfo0 = new CString[Num_EST];

			for (int i=0;i<Num_EST-1;i++)
			{
				ID_EST0[i] = ID_EST[i];
				Lat_EST0[i] = Lat_EST[i];
				Lon_EST0[i] = Lon_EST[i];
				Name_EST0[i] = Name_EST[i];
				m_ESTinfo0[i] = m_ESTinfo[i];
			}
			ID_EST0[Num_EST-1] = ID;
			Lat_EST0[Num_EST-1] = lat1;
			Lon_EST0[Num_EST-1] = lon1;
			Name_EST0[Num_EST-1] = name1;
			m_ESTinfo0[Num_EST-1] = IDstES2Information(ID) ;

			delete [] ID_EST; delete [] Lat_EST; delete [] Lon_EST; delete [] Name_EST; delete [] m_ESTinfo;
			ID_EST = new long[Num_EST];
			Lat_EST = new double[Num_EST];
			Lon_EST = new double[Num_EST];
			Name_EST = new CString[Num_EST];
			m_ESTinfo = new CString[Num_EST];

			for ( i=0;i<Num_EST;i++)
			{
				ID_EST[i] = ID_EST0[i];
				Lat_EST[i] = Lat_EST0[i];
				Lon_EST[i] = Lon_EST0[i];
				Name_EST[i] = Name_EST0[i];
				m_ESTinfo[i] = m_ESTinfo0[i];
			}
			delete [] ID_EST0; 	delete [] Lat_EST0; delete [] Lon_EST0; delete [] Name_EST0; delete [] m_ESTinfo0;
		}
	}
	InvalidateRect(NULL,false);
	EndWaitCursor();
}

BOOL CSMS4DCView::DispEarthStationQ(long ID, CString name1) 
{
	BOOL Q = FALSE;
	if(Num_EST>0)
	{
		for (int i=0;i<Num_EST;i++)
		{
			if((ID_EST[i] == ID) && (Name_EST[i] == name1)) Q = TRUE;
		}
	}
	return Q;
}

void CSMS4DCView::OnAddESStation(){	m_bToolBarDraw=_T("addESstation");}
void CSMS4DCView::OnUpdateAddESStation(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_bToolBarDraw == _T("addESstation"));
	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable(level!=6);
}

void CSMS4DCView::OnAddESStationFUC(double lat1,double lon1) 
{
	CAddESStationDLG stationdlg;
	stationdlg.m_ntcID = -1;
	CString NameStr;
	NameStr.Format("Station%d%d",int(lat1),int(lon1));
	stationdlg.m_STname = NameStr;
	NameStr.Format("SpaceStation%d%d",int(lat1),int(lon1));
	stationdlg.m_nameSat = NameStr;
	stationdlg.m_STlat_deg = lat1;
	stationdlg.m_STlon_deg = lon1;
	stationdlg.m_STh_asl = (int)(LatLon2Hg(lat1, lon1));

	if(stationdlg.DoModal()==IDOK)
		AddEarthStation_disp(stationdlg.m_ntcID,stationdlg.m_STlat_deg,stationdlg.m_STlon_deg,stationdlg.m_STname) ;
}


///////////////////ToolBar Move Station///////////////////////////
void CSMS4DCView::OnMoveESStationFlag() 
{
	if(m_bToolBarDraw == _T("moveESstation"))	m_bToolBarDraw = _T("");
	else										m_bToolBarDraw = _T("moveESstation");	
}

void CSMS4DCView::OnUpdateMoveESStationFlag(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_bToolBarDraw == _T("moveESstation"));

	int level = ((CSMS4DCApp *)AfxGetApp())->m_UserLevel;
	pCmdUI->Enable((level!=6)&&(Num_EST>0));	
}

void CSMS4DCView::OnDatabaseEsdesktop() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");

	CDataBaseLDLG dbdlg;
	int xxDLG = dbdlg.DoModal();
	if (xxDLG == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;			//950909
		if(Nrow<=0)	{ Set_STtable_Default();	return;	}		//950909

		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument() ;
		/////////////////////////////////////////////////
		double stBoxlat,stBoxlon,enBoxlat,enBoxlon;
		Point2LatLon(m_stBoxPoint,&stBoxlat,&stBoxlon);
		Point2LatLon(m_enBoxPoint,&enBoxlat,&enBoxlon);

		double stLinelat,stLinelon,enLinelat,enLinelon;
		Point2LatLon(m_stLinePoint,&stLinelat,&stLinelon);
		Point2LatLon(m_enLinePoint,&enLinelat,&enLinelon);

		double *latp;	latp=new double[m_PolyPointNum+1];
		double *lonp;	lonp=new double[m_PolyPointNum+1];
		double lat01,lon01;
		for (int k=0;k<m_PolyPointNum+1;k++)
		{
			Point2LatLon(m_PolyPoint[k],&lat01,&lon01);
			latp[k]=lat01;	lonp[k]=lon01;
		}
/*
		double *latcr;	latcr=new double[73];
		double *loncr;	loncr=new double[73];
		for ( k=0;k<73;k++)
		{
			Point2LatLon(m_Point_STcr[k],&lat01,&lon01);		latcr[k]=lat01;	loncr[k]=lon01;
		}
*/
		/////////////////////////////////////////////////
		CString m_Sel,name1;
		int Tx=1000,Ty=1000;
		double lat1,lon1,ix,jy;
//		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;		//950909
		long ID1;
		for (int i=0;i<Nrow;i++)
		{
			m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
			ID1  = atol(GetFld(m_Sel,1));
			name1 = GetFld(m_Sel,2);
			lat1  = atof(GetFld(m_Sel,22));
			lon1  = atof(GetFld(m_Sel,21));
			AddEarthStation_disp(ID1,lat1,lon1,name1);

			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
			{
				CUtm m_utm;
				m_utm.phi = lat1;
				m_utm.lambda = lon1;
				m_utm.philambda2UTM();
				lat1 = m_utm.y;
				lon1 = m_utm.x;
			}
			ix = (lon1 - pDoc->m_Lower_left_x) / (600.0*pDoc->m_Resolution_x);
			jy = (lat1 - pDoc->m_Lower_left_y) / (600.0*pDoc->m_Resolution_y);
			Tx = min(Tx, 1+(int) ix);
			Ty = min(Ty, 1+(int) jy);
		}
		if ( !(( Tx==pDoc->TileX || Tx==1+pDoc->TileX ) 
			&& ( Ty==pDoc->TileY || Ty==1+pDoc->TileY )) )
		{
			pDoc->TileX=Tx;	pDoc->TileY=Ty; pDoc->GetData();
		}
				///////////////////////////////////////////////////////
		LatLon2Point(stBoxlat,stBoxlon,&m_stBoxPoint);		LatLon2Point(enBoxlat,enBoxlon,&m_enBoxPoint);
SetBoxCorner();
		LatLon2Point(stLinelat,stLinelon,&m_stLinePoint);	LatLon2Point(enLinelat,enLinelon,&m_enLinePoint);

		for ( k=0;k<m_PolyPointNum+1;k++)	LatLon2Point(latp[k],lonp[k],&m_PolyPoint[k]);
		delete [] latp;	delete [] lonp;

//		for ( k=0;k<73;k++)		LatLon2Point(latcr[k],loncr[k],&m_Point_STcr[k]);
//		delete [] latcr;	delete [] loncr;
		///////////////////////////////////////////////////////
		UpDate_hBitmap(pDoc);
		InvalidateRect(NULL,false);
	}		
	Set_STtable_Default();
}

CString CSMS4DCView::IDstES2Information(long ntc_id) 
{
	CString strSQT, CDBSTR , strT = _T("");
	CDatabase DB;
	CRecordset m_rs;
	strSQT.Format("SELECT * FROM e_stn WHERE (((ntc_id)=%ld));",ntc_id);

	CDBSTR = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	DB.Open(CDBSTR,false,false,_T("ODBC;"),false);

	m_rs.m_pDatabase = &DB;
	m_rs.Open( CRecordset::snapshot, strSQT);
	if(m_rs.GetRecordCount() == 1)
	{
		CString str,str0 = _T("");
		m_rs.MoveFirst();
//		m_rs.GetFieldValue((short)4,str);	str0 = str0 + str + _T(",");
//		m_rs.GetFieldValue((short)5,str);	str0 = str0 + str + _T(",");
//		m_rs.GetFieldValue((short)6,str);	str0 = str0 + str + _T(",");
//		m_rs.GetFieldValue((short)17,str);	str0 = str0 + str + _T(",");
		m_rs.GetFieldValue((short)11,str);	str0 = str0 + str;
		strT = str0;
	}
	m_rs.Close();	DB.Close();
	return strT;
}

void CSMS4DCView::OnDatabaseRemovees() 
{
	if (Num_EST>0)
	{
		delete [] ID_EST; delete [] Lat_EST; delete [] Lon_EST; delete [] Name_EST; delete [] m_ESTinfo;
		Num_EST = 0;
	}
	m_bToolBarDraw = _T("");
	InvalidateRect(NULL,false);	
}

//extern "C" int WINAPI SRSImport(HWND hWndParent,CString DBSTR);	//IFIC.lib
extern "C" int WINAPI SRSImport(HWND hWndParent,CString DBSTR, CString Lang);
void CSMS4DCView::OnDatabaseImportsrs() 
{
//	SRSImport(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR);
	SRSImport(this->m_hWnd,((CSMS4DCApp *)AfxGetApp())->m_CDBSTR,((CSMS4DCApp *)AfxGetApp())->m_Lang);
}

void CSMS4DCView::OnDatabaseSearchesfrq() 
{
	CAddFreqDLG frqDLG;
	frqDLG.m_Flag = TRUE;
	frqDLG.m_Flo   = _Z("Lower Frequency(MHz)");
	frqDLG.m_Fhi   = _Z("Upper Frequency(MHz)");
	frqDLG.m_title = _Z("Frequency Range");
	if(frqDLG.DoModal()==IDOK)
	{
		OnDatabaseRemovees() ;
		double Lon01,Lat01,Lon02,Lat02,		Flo = frqDLG.m_Freq,	 Fhi = frqDLG.m_BW;
		Point2LatLon(m_stBoxPoint,&Lat01,&Lon01);		Point2LatLon(m_enBoxPoint,&Lat02,&Lon02);
//		double Lat1=min(Lat01,Lat02),	Lat2=max(Lat01,Lat02),	Lon1=min(Lon01,Lon02),	Lon2=max(Lon01,Lon02);

		CDBVariant Fld;		CDatabase m_mydb;		CRecordset m_rs;
		CString  Filter , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
		if (m_mydb.Open(_T(m_DB),FALSE,TRUE, _T("ODBC;"), FALSE))
		{
			m_rs.m_pDatabase = &m_mydb;
//			Filter.Format("(lat_dec>%lf and lat_dec<%lf and long_dec>%lf and long_dec<%lf and freq_mhz>%lf and freq_mhz<%lf)",Lat1,Lat2,Lon1,Lon2,Flo,Fhi);
if(Lon01<=Lon02)	Filter.Format("( (freq_mhz>=%lf and freq_mhz<=%lf and lat_dec>%lf and lat_dec<%lf) and (long_dec>%lf and long_dec<%lf) )",Flo,Fhi,Lat01,Lat02,Lon01,Lon02);
else				Filter.Format("( (freq_mhz>=%lf and freq_mhz<=%lf and lat_dec>%lf and lat_dec<%lf) and ((long_dec>%lf and long_dec<180) or (long_dec>-180 and long_dec<%lf)) )",Flo,Fhi,Lat01,Lat02,Lon01,Lon02);

			CString	m_Tbl;	m_Tbl.Format( _T("select * from %s  where  %s;") , m_qEarthStationAp7_Int ,Filter);
			m_rs.Open( CRecordset::snapshot, m_Tbl);

			int k = 0;
			while(!m_rs.IsEOF())	{	m_rs.MoveNext();	k = k+1;	}
			if (k>0)
			{
				m_rs.MoveFirst();
				double lat1,lon1;	CString name1;	long ID1;
				for (int j=0;j<k;j++)
				{
					m_rs.GetFieldValue((short)1, Fld);		ID1  = Fld.m_lVal;
					m_rs.GetFieldValue((short)7, Fld);		name1 = *Fld.m_pstring;
					m_rs.GetFieldValue((short)6, Fld);		lat1  = Fld.m_fltVal;
					m_rs.GetFieldValue((short)5, Fld);		lon1  = Fld.m_fltVal;
					AddEarthStation_disp(ID1,lat1,lon1,name1) ;
					m_rs.MoveNext();
				}
			}
			m_rs.Close();	m_mydb.Close();
			InvalidateRect(NULL,false);
		}
	}
}
void CSMS4DCView::OnUpdateDatabaseSearchesfrq(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );	
}

void CSMS4DCView::OnDatabaseListes() 
{
	BeginWaitCursor();
	CString CDataBaseSTR , str1 , str2;
	str1.Format("(((ntc_id)=%ld))",ID_EST[0]);
	for (int i=1;i<Num_EST;i++)
	{
		str2.Format(" OR (((ntc_id)=%ld))",ID_EST[i]);
		str1 = str1 + str2;
	}
///	CDataBaseSTR = _T("SELECT * FROM EarthStationAp7_Int WHERE ") + str1 + ";";
//	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE %s ;") , m_qEarthStationAp7_Int , str1 );
	CDataBaseSTR.Format( _T("SELECT * FROM e_stn WHERE %s ;") , str1 );

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Title = _Z("List of Queried Earth Station(s)");
	datadlg.m_ReportFlag = TRUE;
	datadlg.DoModal();
	Set_STtable_Default();
	EndWaitCursor();	
}
void CSMS4DCView::OnUpdateDatabaseListes(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable((Num_EST>0) ? 1 : 0 );	
}

void CSMS4DCView::OnDatabaseSearchesloc() 
{
	OnDatabaseRemovees() ;
	double Lon01,Lat01,Lon02,Lat02;
	Point2LatLon(m_stBoxPoint,&Lat01,&Lon01);	Point2LatLon(m_enBoxPoint,&Lat02,&Lon02);
//	double Lat1=min(Lat01,Lat02),	Lat2=max(Lat01,Lat02),	Lon1=min(Lon01,Lon02),	Lon2=max(Lon01,Lon02);

	CDBVariant Fld;	CDatabase m_mydb;	CRecordset m_rs;
	CString  Filter  , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CString	m_Tbl=_T("select * from e_stn");
	if (m_mydb.Open(_T(m_DB),FALSE,TRUE, "ODBC;", FALSE))
	{
		m_rs.m_pDatabase=&m_mydb;
//		Filter.Format("(lat_dec>%lf and lat_dec<%lf and long_dec>%lf and long_dec<%lf)",Lat1,Lat2,Lon1,Lon2);
if(Lon01<=Lon02)	Filter.Format("(lat_dec>%lf and lat_dec<%lf and long_dec>%lf and long_dec<%lf)",Lat01,Lat02,Lon01,Lon02);
else				Filter.Format("( (lat_dec>%lf and lat_dec<%lf) and ((long_dec>%lf and long_dec<180) or (long_dec>-180 and long_dec<%lf)) )",Lat01,Lat02,Lon01,Lon02);

		if(m_Tbl.Find(" where ")==-1)	Filter = m_Tbl + " where " + Filter;
		else							Filter = m_Tbl + " and "   + Filter;
		m_rs.Open( CRecordset::snapshot, Filter);

		int k = 0;
		while(!m_rs.IsEOF())		{	m_rs.MoveNext();	k = k+1;	}
		if (k>0)
		{
			m_rs.MoveFirst();
			double lat1,lon1;	CString name1;	long ID1;
			for (int j=0;j<k;j++)
			{
				m_rs.GetFieldValue((short)0, Fld);		ID1  = Fld.m_lVal;
				m_rs.GetFieldValue((short)1, Fld);		name1 = *Fld.m_pstring;
				m_rs.GetFieldValue((short)21, Fld);		lat1  = Fld.m_fltVal;
				m_rs.GetFieldValue((short)20, Fld);		lon1  = Fld.m_fltVal;
				AddEarthStation_disp(ID1,lat1,lon1,name1) ;
				m_rs.MoveNext();
			}
		}
		m_rs.Close();	m_mydb.Close();
		InvalidateRect(NULL,false);
	}		
}
void CSMS4DCView::OnUpdateDatabaseSearchesloc(CCmdUI* pCmdUI) 
{
	pCmdUI->Enable(m_stBoxPoint != m_enBoxPoint ? 1 : 0 );		
}

void CSMS4DCView::OnSize(UINT nType, int cx, int cy) 
{
	CScrollView::OnSize(nType, cx, cy);
	HScrollpos = GetScrollPos(SB_HORZ);	
	VScrollpos = GetScrollPos(SB_VERT);	
}
///////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////GE06/////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

CString CSMS4DCView::QGE06_IntTo_Qx(int type) 
{
	CString CDataBaseSTR, Selx = _T("");
//	if	   (type==0)	CDataBaseSTR = _T("SELECT * FROM STtableGE06ASAL WHERE (((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DS2' Or (NoticeType)='GS2' Or (NoticeType)='DT2' Or (NoticeType)='GT2')) OR (((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='S' Or (AssignCode)='L' Or (AssignCode) Is Null Or (AssignCode)='')) OR (((Fragment)='GE06A'));");
//	else if(type==1)	CDataBaseSTR = _T("SELECT * FROM STtableGE06ASAL WHERE (((Fragment)='GE06L') AND ((STTP)='FX' Or (STTP)='FB' Or (STTP)='ML') AND (((TXfreq)>=174 And (TXfreq)<=230) Or ((TXfreq)>=470 And (TXfreq)<=862)));");
	if	   (type==0)	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DS2' Or (NoticeType)='GS2' Or (NoticeType)='DT2' Or (NoticeType)='GT2')) OR (((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='S' Or (AssignCode)='L' Or (AssignCode) Is Null Or (AssignCode)='')) OR (((Fragment)='GE06A'));"),  m_qSTtableGE06ASAL);
	else if(type==1)	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Fragment)='GE06L') AND ((STTP)='FX' Or (STTP)='FB' Or (STTP)='ML') AND (((TXfreq)>=174 And (TXfreq)<=230) Or ((TXfreq)>=470 And (TXfreq)<=862)));") , m_qSTtableGE06ASAL);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	CDataBaseLDLG datadlg;
	if	   (type==0)	datadlg.m_Title = _T("Select One Interferer Assignment / Allotment");
	else if(type==1)	datadlg.m_Title = _T("Select One Interferer Station");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
			Selx = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		else
		{
			MessageBox(_Z("Please Select One Record."),_Z("ERROR!!!"),MB_ICONERROR);
			Set_STtable_Default();
			EndWaitCursor();
		}
	}
	return Selx;
}
long CSMS4DCView::QGE06_IntTo_Q1(CString IDst0, CString SfnID,CString *IDst,double *GRlat,double *GRlon,CString *strOUT, int mode) 
{
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;

//	if(mode==0)			tbl.Format(_T("SELECT * FROM CommonFields WHERE ((IDst<>\'---\') AND (SfnID=\'%s\'));"), SfnID);
//	else if(mode==1)	tbl.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)<>'---') AND ((SfnID)=\'%s\') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='L'));"), SfnID);
	if(mode==0)			tbl.Format(_T("SELECT * FROM %s WHERE ((IDst<>\'---\') AND (SfnID=\'%s\'));"), m_qCommonFields,SfnID);
	else if(mode==1)	tbl.Format(_T("SELECT * FROM %s WHERE (((IDst)<>'---') AND ((SfnID)=\'%s\') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='L'));"), m_qCommonFields,SfnID);
	
	rs.Open(CRecordset::snapshot, tbl);
	long c = 0;

	CString GeoLat = _T(""),GeoLon = _T("");
	CString Country,SiteName,NoticeType,PlanEntry,AssignCode,Frequency,AssocAllotID,Pol,AdmRefID;
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		CString str = _T("");
		while(1)
		{
			if(rs.IsEOF()) break;
			rs.GetFieldValue(_T("IDst"),str);				*IDst = *IDst + _T(",") + str;
			rs.GetFieldValue(_T("GeoLat"),str);				GeoLat = GeoLat + _T(",") + str;
			rs.GetFieldValue(_T("GeoLon"),str);				GeoLon = GeoLon + _T(",") + str;

			rs.GetFieldValue(_T("Country"),str);			Country = Country + _T(",") + str;
			rs.GetFieldValue(_T("SiteName"),str);			SiteName = SiteName + _T(",") + str;
			rs.GetFieldValue(_T("NoticeType"),str);			NoticeType = NoticeType + _T(",") + str;
			rs.GetFieldValue(_T("PlanEntry"),str);			PlanEntry = PlanEntry + _T(",") + str;
			rs.GetFieldValue(_T("AssignCode"),str);			AssignCode = AssignCode + _T(",") + str;
			rs.GetFieldValue(_T("Frequency"),str);			Frequency = Frequency + _T(",") + str;
			rs.GetFieldValue(_T("AssocAllotID"),str);		AssocAllotID = AssocAllotID + _T(",") + str;
			rs.GetFieldValue(_T("Pol"),str);				Pol = Pol + _T(",") + str;
			rs.GetFieldValue(_T("AdmRefID"),str);			AdmRefID = AdmRefID + _T(",") + str;

			c++;
			rs.MoveNext();
		}
	}
	rs.Close();	DB1.Close();
	(*IDst).Delete(0);		(GeoLat).Delete(0);		(GeoLon).Delete(0);

	Country.Delete(0);		SiteName.Delete(0);		NoticeType.Delete(0);
	PlanEntry.Delete(0);	AssignCode.Delete(0);	Frequency.Delete(0);
	AssocAllotID.Delete(0);	Pol.Delete(0);			AdmRefID.Delete(0);
//	double pi = 4.0*atan(1.0);

	CString str_I,str;

	if(c>0)
	{
		double *Lat , *Lon , GRlat0 , GRlon0;
		Lat = new double[c];	Lon = new double[c];
		for(int i=0;i<c;i++)
		{
			Lat[i] = atof(GetFld(GeoLat,i+1));			Lon[i] = atof(GetFld(GeoLon,i+1));

			float RLON   = (float)((pi/180.0)*Lon[i]), RLAT   = (float)((pi/180.0)*Lat[i]);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

			CString ctry_I = GetFld(Country,i+1);
		//	if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
		//	else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
		//	CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			CString SiteName_I = GetFld(SiteName,i+1);
			CString NoticeType_I = GetFld(NoticeType,i+1);
			CString PEC_I = GetFld(PlanEntry,i+1);
			CString AssignCode_I = GetFld(AssignCode,i+1);
			CString Freq_I = GetFld(Frequency,i+1);
			CString Pol_I = GetFld(Pol,i+1);
			CString AssocAllotID_I = GetFld(AssocAllotID,i+1);
			CString AdmRefID_I = GetFld(AdmRefID,i+1);

			CString IDst_I = GetFld((*IDst),i+1);
			if(IDst_I==IDst0)		str.Format(_T("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID);
			else					str.Format(_T("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s  %s,%s,%s,%s") , _T("L"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID);

			str_I = str_I + _T(",") + str;
		}
		str_I.Delete(0);
		*strOUT = str_I;

		CP154606_Functions CP154606;
		CP154606.GrPointT(Lat , Lon, c, &GRlat0 , &GRlon0);
		*GRlat = GRlat0;		*GRlon = GRlon0;
		delete [] Lat;			delete [] Lon;
	}
	return c;
}

void CSMS4DCView::QGE06_IntTo_Q2(CString allotkey,double *GRlat,double *GRlon) 
{
	CString contourkeyN , nb_test_ptsN;
	long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey) , &contourkeyN , &nb_test_ptsN);
	long *contourkeyI;		contourkeyI = new long[contourkeyNum];
	long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
	double *GRlatC;			GRlatC = new double[contourkeyNum];
	double *GRlonC;			GRlonC = new double[contourkeyNum];
	long NcontourT = 0;
	for(long i=0;i<contourkeyNum;i++)
	{
		contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
		nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
		NcontourT = NcontourT + nb_test_ptsI[i];
	}
	double * lat_TP;   lat_TP = new double[NcontourT];
	double * lon_TP;   lon_TP = new double[NcontourT];
	double * y;		y = lat_TP;
	double * x;		x = lon_TP;
	for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
	{
		CString lat_tpStr, lon_tpStr;
		long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM] ,nb_test_ptsI[iCNUM] , &lat_tpStr, &lon_tpStr , &GRlatC[iCNUM] , &GRlonC[iCNUM]) ;
		for(long jTP=0;jTP<n_tp;jTP++)
		{
			*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
			*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
		}
	}
	double GRlat0 , GRlon0;
	CP154606_Functions CP154606;
	CP154606.GrPointT(GRlatC , GRlonC, contourkeyNum, &GRlat0 , &GRlon0);

//	double pi = 4.0*atan(1.0);
	float POINTgr[1][2];
	POINTgr[0][0] = (float)(GRlon0*pi/180.0);	POINTgr[0][1] = (float)(GRlat0*pi/180.0);
	int uflag = false;

	long i1=0,i2=0;
	for( iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
	{
		long n_tp = nb_test_ptsI[iCNUM];
		i2 = i2 + n_tp;
		float (*CRDARR)[2]; CRDARR = new float[n_tp][2];
		long NRPNT = n_tp;
		
		long i3 = 0;
		for(long jTP = i1; jTP<i2 ; jTP++)
		{
			CRDARR[i3][0] = (float)(lon_TP[jTP]*pi/180.0);
			CRDARR[i3][1] = (float)(lat_TP[jTP]*pi/180.0);
			i3++;
		}
		uflag = GEOPIA2((float *)POINTgr, (float *)CRDARR, &NRPNT);
		delete [] CRDARR;
		i1 = i1 + n_tp;
		if(uflag)
		{
			*GRlat = GRlat0;		*GRlon = GRlon0;		break;
		}
	}
	if(!uflag)
	{
		double dist1 , dist0 = 99999999999.0;
		for( i=0;i<NcontourT;i++)
		{
			dist1 = Distance_km(lat_TP[i],lon_TP[i],GRlat0,GRlon0);
			dist0 = min(dist0, dist1);
			if(dist0==dist1)
			{
				*GRlat = lat_TP[i];	*GRlon = lon_TP[i];
			}
		}
	}
	delete [] contourkeyI;
	delete [] nb_test_ptsI;
	delete [] GRlatC;
	delete [] GRlonC;
	delete [] lat_TP;
	delete [] lon_TP;
}

BOOL CSMS4DCView::QGE06_IntTo_Q5(CString cty, double GeoLat, double GeoLon,double SearchRadius) 
{
	BOOL uflag = FALSE;

	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;
	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;
	tbl.Format(_T("SELECT test_pt, long_deg, long_min, long_sec, long_ew, lat_deg, lat_min, lat_sec, lat_ns,nb_test_pts FROM rrc_aux_border_contour, rrc_aux_border_contour_pt WHERE (((ctry)=\'%s\') AND ((rrc_aux_border_contour.contourkey)=[rrc_aux_border_contour_pt].[contourkey])) ORDER BY test_pt;"),cty); 
	rs.Open(CRecordset::snapshot, tbl);
	long n_tp , c = 0;

	double lat_deg, lat_min, lat_sec , long_deg, long_min, long_sec;
	int EW , NS;
	if(rs.GetRecordCount() == 1)
	{
		CString str = _T("");
		rs.GetFieldValue(_T("nb_test_pts"),str);	n_tp = atol(str);
		double *lat;  lat = new double[n_tp];
		double *lon;  lon = new double[n_tp];

		rs.MoveFirst();
		while(1)
		{
			if(rs.IsEOF()) break;
			rs.GetFieldValue(_T("long_deg"),str);	long_deg = atof(str);
			rs.GetFieldValue(_T("long_min"),str);	long_min = atof(str);
			rs.GetFieldValue(_T("long_sec"),str);	long_sec = atof(str);
			rs.GetFieldValue(_T("long_ew"),str);	EW = (str==_T("E")) ? 1 : -1; 
			lon[c] = (long_deg + long_min/60.0 + long_sec/3600.0)*EW;

			rs.GetFieldValue(_T("lat_deg"),str);	lat_deg = atof(str);
			rs.GetFieldValue(_T("lat_min"),str);	lat_min = atof(str);
			rs.GetFieldValue(_T("lat_sec"),str);	lat_sec = atof(str);
			rs.GetFieldValue(_T("lat_ns"),str);		NS = (str==_T("N")) ? 1 : -1; 
			lat[c] = (lat_deg + lat_min/60.0 + lat_sec/3600.0)*NS;
			
			c++;
			rs.MoveNext();
		}
		double lat0[360],lon0[360];
		for(int i=0;i<360;i++)		reckon(GeoLat,GeoLon, SearchRadius, (double)i, &lat0[i], &lon0[i]) ;
		uflag = InterSection(lat0,lon0,360,lat , lon, n_tp) ;
		delete [] lat;		delete [] lon;
	}
	rs.Close();		DB1.Close();
	return uflag;
}

CString CSMS4DCView::QGE06_IntTo_Q3(CString SfnID) 
{
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;
//	tbl.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)='---') AND ((SfnID)=\'%s\'));") ,SfnID);
	tbl.Format(_T("SELECT * FROM %s WHERE (((IDst)='---') AND ((SfnID)=\'%s\'));") ,m_qCommonFields,SfnID);
	rs.Open(CRecordset::snapshot, tbl);
	
	CString strT = _T("");
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		CString str = _T("");
		rs.GetFieldValue(_T("allotkey"),str);		strT = str;
		rs.GetFieldValue(_T("GeoArea"),str);		strT = strT + _T(",") + str;
	}
	rs.Close();	DB1.Close();
	return strT;
}

int CSMS4DCView::QGE06_IntTo_Q4(CString AdmRefID,CString *IDst,CString *GeoLat,CString *GeoLon,CString *Frequency,CString *strOUT) 
{
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;
	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;
//	tbl.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)<>'---') AND ((AssocAllotID)=\'%s\'));"),AdmRefID);
	tbl.Format(_T("SELECT * FROM %s WHERE (((IDst)<>'---') AND ((AssocAllotID)=\'%s\'));"),m_qCommonFields,AdmRefID);
	rs.Open(CRecordset::snapshot, tbl);
	long c = rs.GetRecordCount();

	CString GLat = _T(""),GLon = _T("");
	CString ctry_I,SiteName,NoticeType,PlanEntry,AssignCode,Frq,AssocAllotID,Pol,SfnID,AdmRefID_I;
	if(c == 1)
	{
		rs.MoveFirst();
		CString str = _T("");
		rs.GetFieldValue(_T("IDst"),str);				*IDst = str;
		rs.GetFieldValue(_T("GeoLat"),GLat);			*GeoLat = GLat;
		rs.GetFieldValue(_T("GeoLon"),GLon);			*GeoLon = GLon;
		rs.GetFieldValue(_T("Frequency"),Frq);			*Frequency = Frq;

		rs.GetFieldValue(_T("Country"),ctry_I);
		rs.GetFieldValue(_T("SiteName"),SiteName);	
		rs.GetFieldValue(_T("NoticeType"),NoticeType);	
		rs.GetFieldValue(_T("PlanEntry"),PlanEntry);	
		rs.GetFieldValue(_T("AssignCode"),AssignCode);	
		rs.GetFieldValue(_T("AssocAllotID"),AssocAllotID);
		rs.GetFieldValue(_T("Pol"),Pol);
		rs.GetFieldValue(_T("SfnID"),SfnID);
		rs.GetFieldValue(_T("AdmRefID"),AdmRefID_I);
		
//		double pi = 4.0*atan(1.0);
		float RLON   = (float)((pi/180.0)*atof(GLon)), RLAT   = (float)((pi/180.0)*atof(GLat));
		CString RLONbs,RLATbs;
		Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
		CString adm_I = Cty2AdmGE06(&ctry_I);

		str.Format(_T("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s  %s,%s,%s,%s") , _T("L"),_T("AS"),adm_I,ctry_I,SiteName,AdmRefID_I,NoticeType,PlanEntry,AssignCode,Frq,RLONbs,RLATbs,Pol,AssocAllotID,SfnID);
		*strOUT = str;
	}
	rs.Close();	DB1.Close();
	return c;
}

int CSMS4DCView::QGE06_IntToBCBT2DBCBT_Qy(CString IDst_IT, int nIDst_IT, CString allotkey_IT, int nallotkey_IT, double GRlat, double GRlon, double SR, double Freq_I, double FR) 
{
	int NrowT = 0, Nrow = 0;
	CString CDataBaseSTR = _T("");

	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = SR , fmin , fmax;
	fmin = Freq_I - FR;
	fmax = Freq_I + FR;

	reckon(GRlat,GRlon, rng_km,  0.0,&latmax,&dumy) ;
	reckon(GRlat,GRlon, rng_km,180.0,&latmin,&dumy) ;
	reckon(GRlat,GRlon, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(GRlat,GRlon, rng_km,270.0,&dumy,&lonmin) ;

//	CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)<>'---') AND ((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DT1' Or (NoticeType)='GT1' Or (NoticeType)='DS1' Or (NoticeType)='GS1') AND ((GeoLat)>=%lf And (GeoLat)<=%lf) AND ((GeoLon)>=%lf And (GeoLon)<=%lf) AND ((Frequency)>=%lf And (Frequency)<=%lf)) OR (((IDst)='---') AND ((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DT2' Or (NoticeType)='GT2' Or (NoticeType)='DS2' Or (NoticeType)='GS2') AND ((Frequency)>=%lf And (Frequency)<=%lf));"), latmin , latmax, lonmin , lonmax, fmin , fmax, fmin , fmax);
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((IDst)<>'---') AND ((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DT1' Or (NoticeType)='GT1' Or (NoticeType)='DS1' Or (NoticeType)='GS1') AND ((GeoLat)>=%lf And (GeoLat)<=%lf) AND ((GeoLon)>=%lf And (GeoLon)<=%lf) AND ((Frequency)>=%lf And (Frequency)<=%lf)) OR (((IDst)='---') AND ((Fragment)='GE06D' Or (Fragment)='RC06') AND ((NoticeType)='DT2' Or (NoticeType)='GT2' Or (NoticeType)='DS2' Or (NoticeType)='GS2') AND ((Frequency)>=%lf And (Frequency)<=%lf));"), m_qCommonFields,latmin , latmax, lonmin , lonmax, fmin , fmax, fmin , fmax);

	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;		CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;

	double STlat_deg , STlon_deg;
	CString str, IDst, GeoArea , IDstN = _T(""), allotkey , allotkeyN = _T("");

	rs.Open(CRecordset::snapshot, CDataBaseSTR);
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		while(1)
		{
			if(rs.IsEOF()) break;
			rs.GetFieldValue(_T("IDst"),IDst);
			rs.GetFieldValue(_T("GeoLat"),str);		STlat_deg = atof(str);
			rs.GetFieldValue(_T("GeoLon"),str);		STlon_deg = atof(str);
			rs.GetFieldValue(_T("GeoArea"),GeoArea);
			rs.GetFieldValue(_T("allotkey"),allotkey);

			if(IDst==_T("---"))
			{
				int flagID = IDstCompare(allotkey, allotkey_IT, nallotkey_IT);
				if(flagID==0)
				{
					BOOL uflag;
					if(GeoArea.IsEmpty())		uflag = QGE06_CArea_Q1(atol(allotkey),GRlat,GRlon,SR);
					else						uflag = QGE06_IntTo_Q5(GeoArea,GRlat,GRlon,SR);
					if(uflag)
					{
						IDstN = IDstN + _T(",") + IDst;
						allotkeyN = allotkeyN + _T(",") + allotkey;
						Nrow++;
					}
				}
			}
			else
			{
				int flagID = IDstCompare(IDst, IDst_IT, nIDst_IT);
				if(flagID==0)
				{
					double dist = Distance_km(GRlat,GRlon,STlat_deg,STlon_deg);
					if((dist <= SR)&&(dist > 0.0000001))
					{
						IDstN = IDstN + _T(",") + IDst;
						allotkeyN = allotkeyN + _T(",") + allotkey;
						Nrow++;
					}
				}
			}
			rs.MoveNext();
		}//while
	}//if
	rs.Close();		DB1.Close();

	IDstN.Delete(0);	allotkeyN.Delete(0);
	if(Nrow>0)
	{
		CString str1,str2 = _T("");
		for(long j=0 ; j<Nrow ;j++)
		{
			str1.Format(_T("(((IDst)=\'%s\') AND ((allotkey)=\'%s\'))"),GetFld(IDstN,j+1),GetFld(allotkeyN,j+1));
			str2 = str2 + _T(" OR ") + str1;
		}
		str2.Delete(0,4);	str2 = str2 + _T(";");
//		CDataBaseSTR.Format(_T("SELECT * FROM STtableGE06ASAL WHERE %s;"),str2);
		CDataBaseSTR.Format(_T("SELECT * FROM %s  WHERE %s "),m_qSTtableGE06ASAL,str2 );
	}
	else	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE IDst=\'z\';") ,m_qSTtableGE06ASAL );
//	else	CDataBaseSTR = _T("SELECT * FROM STtableGE06ASAL WHERE IDst=\'z\';");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _T("Victim Assignment / Allotment");
	if (datadlg.DoModal()==IDOK)
		NrowT = ((CSMS4DCApp *)AfxGetApp())->Nrow;
	
	return NrowT;
}

long CSMS4DCView::QGE06_IntTo_Q6(CString IDst,CString *GeoLat,CString *GeoLon, CString *UFS, CString *Em) 
{
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;
	
	tbl.Format(_T("SELECT IDst, SiteName, GeoLat, GeoLon, UFS, Em FROM CSArea WHERE (((IDst)=%ld));"), atol(IDst));
	rs.Open(CRecordset::snapshot, tbl);
	long c = 0;
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		CString str = _T("");
		while(1)
		{
			if(rs.IsEOF()) break;
			rs.GetFieldValue(_T("GeoLat"),str);				*GeoLat = *GeoLat + _T(",") + str;
			rs.GetFieldValue(_T("GeoLon"),str);				*GeoLon = *GeoLon + _T(",") + str;
			rs.GetFieldValue(_T("UFS"),str);				*UFS = *UFS + _T(",") + str;
			rs.GetFieldValue(_T("Em"),str);					*Em = *Em + _T(",") + str;
			c++;
			rs.MoveNext();
		}
	}
	rs.Close();	DB1.Close();
	(*Em).Delete(0);	(*GeoLat).Delete(0);	(*GeoLon).Delete(0);	(*UFS).Delete(0);
	return c;
}


long CSMS4DCView::QGE06_IntTo_Q7(CString allotkey,CString mode, CString *strOUT) 
{
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;	CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;
//	tbl.Format(_T("SELECT * FROM CommonFields WHERE ((IDst=\'---\') AND (allotkey=\'%s\'));"), allotkey);
	tbl.Format(_T("SELECT * FROM %s WHERE ((IDst=\'---\') AND (allotkey=\'%s\'));"), m_qCommonFields,allotkey);

	rs.Open(CRecordset::snapshot, tbl);
	long c = 0;

	CString Country,SiteName,NoticeType,PlanEntry,AssignCode,Frequency,AssocAllotID,Pol,SfnID,AdmRefID;
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		CString str = _T("");
		while(1)
		{
			if(rs.IsEOF()) break;

			rs.GetFieldValue(_T("Country"),str);			Country = Country + _T(",") + str;
			rs.GetFieldValue(_T("SiteName"),str);			SiteName = SiteName + _T(",") + str;
			rs.GetFieldValue(_T("NoticeType"),str);			NoticeType = NoticeType + _T(",") + str;
			rs.GetFieldValue(_T("PlanEntry"),str);			PlanEntry = PlanEntry + _T(",") + str;
			rs.GetFieldValue(_T("AssignCode"),str);			AssignCode = AssignCode + _T(",") + str;
			rs.GetFieldValue(_T("Frequency"),str);			Frequency = Frequency + _T(",") + str;
			rs.GetFieldValue(_T("AssocAllotID"),str);		AssocAllotID = AssocAllotID + _T(",") + str;
			rs.GetFieldValue(_T("Pol"),str);				Pol = Pol + _T(",") + str;
			rs.GetFieldValue(_T("SfnID"),str);				SfnID = SfnID + _T(",") + str;
			rs.GetFieldValue(_T("AdmRefID"),str);			AdmRefID = AdmRefID + _T(",") + str;

			c++;
			rs.MoveNext();
		}
	}
	rs.Close();	DB1.Close();

	Country.Delete(0);		SiteName.Delete(0);		NoticeType.Delete(0);
	PlanEntry.Delete(0);	AssignCode.Delete(0);	Frequency.Delete(0);
	AssocAllotID.Delete(0);	Pol.Delete(0);			SfnID.Delete(0);		AdmRefID.Delete(0);
//	double pi = 4.0*atan(1.0);

	CString str_I,str;
	if(c>0)
	{
		for(int i=0;i<c;i++)
		{
			CString ctry_I = GetFld(Country,i+1);
	//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
	//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
	//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			CString SiteName_I = GetFld(SiteName,i+1);
			CString NoticeType_I = GetFld(NoticeType,i+1);
			CString PEC_I = GetFld(PlanEntry,i+1);
			CString AssignCode_I = GetFld(AssignCode,i+1);
			CString Freq_I = GetFld(Frequency,i+1);
			CString Pol_I = GetFld(Pol,i+1);
			CString AssocAllotID_I = GetFld(AssocAllotID,i+1);
			CString SfnID_I = GetFld(SfnID,i+1);
			CString AdmRefID_I = GetFld(AdmRefID,i+1);

			str.Format(_T("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s  %s,%s,%s,%s") , mode,_T("AL"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,_T("---"),_T("---"),Pol_I,AssocAllotID_I,SfnID_I);

			str_I = str_I + _T(",") + str;
		}
		str_I.Delete(0);
		*strOUT = str_I;
	}
	return c;
}


double CSMS4DCView::QGE06_IntToBCBT2DBCBT_CNFS(CString Fragment_W,CString NoticeType_W,double Freq_W, CString TV_SYS_W, CString RPC_W, CString RxMode_W, 
									double GeoLat_W, double GeoLon_W, CString Pol_W, double Sigma_W, CString SYS_VAR_W, double miu_W,
									CString Fragment_I,CString NoticeType_I,double Freq_I, CString TV_SYS_I, CString RPC_I, CString RxMode_I,
									double GeoLat_I,double GeoLon_I, CString Pol_I, double Sigma_I, double freq_vcarr_I, CString NET_I,int PEC_I,
									CString AdmRefID_I,	CString AssocAllotID_I, CString SfnID_I, CString allotkey_I, CString Hagl_I, CString AntDir_I,
									CString AntCatID_I, CString ERP_h_dbw_I, CString ERP_v_dbw_I, CString TV_COLOR_I, CString GeoArea_I, CString RN_I,
									double latCal,double lonCal, double CF, double PR0, int AntDisc, int ENV,double Ti,double kfactor) 
{
	double CNFS;
	CP154606_Functions CP154606;
	double PR = PR0;

	if((NET_I==_T("ASA0"))||(PEC_I==1))
	{
		CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
								 GeoLat_I, GeoLon_I, Freq_I, Pol_I, Hagl_I,AntDir_I, AntCatID_I, ERP_h_dbw_I, 
								 ERP_v_dbw_I, latCal, lonCal, CF, PR, AntDisc, ENV, Ti, kfactor);
	}//if(PEC_I==1)
	else if(PEC_I==2)
	{
		CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN, ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN;
		long numAssign = QGE06_CArea_Q2(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
										&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN) ;
		double CNFSjAS = 0;
		for(int iAS = 0; iAS<numAssign ; iAS++)
		{
			double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
			CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
					AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
					ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

			double CNFS1 = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
											 GeoLat_Ii, GeoLon_Ii, Freq_I, Pol_Ii, Hagl_Ii, AntDir_Ii, AntCatID_Ii, ERP_h_dbw_Ii,
											 ERP_v_dbw_Ii, latCal, lonCal, CF, PR, AntDisc, ENV, Ti, kfactor); 
			CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
		}
		CNFS = 10.0*log10(CNFSjAS);
	}//if(PEC_I==2)
	else if(PEC_I==3)
	{
		if(GeoArea_I.IsEmpty())
		{
			CString contourkeyN , nb_test_ptsN;
			long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_I) , &contourkeyN , &nb_test_ptsN);
			long *contourkeyI;		contourkeyI = new long[contourkeyNum];
			long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
			double dum;
			long NcontourT = 0;
			for(long i=0;i<contourkeyNum;i++)
			{
				contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
				nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
				NcontourT = NcontourT + nb_test_ptsI[i];
			}
			double * lat_TP;   lat_TP = new double[NcontourT];
			double * lon_TP;   lon_TP = new double[NcontourT];
			double * y;		y = lat_TP;
			double * x;		x = lon_TP;
			for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
			{
				CString lat_tpStr, lon_tpStr;
				long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
				for(long jTP=0;jTP<n_tp;jTP++)
				{
					*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
					*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
				}
			}
			CString RN = _T("");
			if     (NET_I==_T("ALT3"))							RN = RN_I;
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

			CNFS = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
									 latCal, lonCal, Freq_I, Pol_I, RPC_I, RN, lat_TP, lon_TP, NcontourT, CF, PR, AntDisc, ENV, Ti); 

			delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] lat_TP;	delete [] lon_TP;
		}//if GeoArea_I
		else
		{
			CString lat_tpSTR, lon_tpSTR;
			double dum;
			long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
			double * lat_TP;   lat_TP = new double[NcontourT];
			double * lon_TP;   lon_TP = new double[NcontourT];
			for(long jTP=0;jTP<NcontourT;jTP++)
			{
				lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
				lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
			}
			CString RN = _T("");
			if     (NET_I==_T("ALT3"))							RN = RN_I;
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

			CNFS = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
									 latCal, lonCal, Freq_I, Pol_I, RPC_I, RN, lat_TP, lon_TP, NcontourT, CF, PR, AntDisc, ENV, Ti); 

			delete [] lat_TP;		delete [] lon_TP;
		}//else GeoArea_I
	}//if(PEC_I==3)
	else if(PEC_I==4)
	{
		if((NET_I==_T("ASS4"))||(NET_I==_T("AST4")))	/////////A4_1
		{
			double CNFSsfn = 0, CNFSallot = 0;
			//+++++++++++++++Assignment++++++++++++++++++++++++++++++++++++++++

			CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN,ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN;
			long numAssign = QGE06_CArea_Q2(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
											&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN,1) ;
			double CNFSjAS = 0;
			for(int iAS = 0; iAS<numAssign ; iAS++)
			{
				double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
				CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
						AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
						ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

				double CNFS1 = CNFS_Function_Int_0( GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
									 GeoLat_Ii, GeoLon_Ii, Freq_I, Pol_Ii, Hagl_Ii,
									 AntDir_Ii, AntCatID_Ii, ERP_h_dbw_Ii, ERP_v_dbw_Ii,
									 latCal, lonCal, CF, PR, AntDisc, ENV, Ti, kfactor);

				CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
			}//for  iAS
			CNFSsfn = 10.0*log10(CNFSjAS);

			//+++++++++++++++Allotment++++++++++++++++++++++++++++++++++++++++
			CString AllotmentSTR = QGE06_BCBT_A4_1(SfnID_I) ;
			CString allotkey_Ii = GetFld(AllotmentSTR,1),
					NoticeType_Ii = GetFld(AllotmentSTR,3),		GeoArea_Ii = GetFld(AllotmentSTR,9),
					Pol_Ii = GetFld(AllotmentSTR,10),			SYS_VAR_Ii = GetFld(AllotmentSTR,11);
			if(GeoArea_Ii.IsEmpty())
			{
				CString contourkeyN , nb_test_ptsN;
				long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_Ii) , &contourkeyN , &nb_test_ptsN);
				long *contourkeyI;		contourkeyI = new long[contourkeyNum];
				long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
				double dum;
				long NcontourT = 0;
				for(long i=0;i<contourkeyNum;i++)
				{
					contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
					nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
					NcontourT = NcontourT + nb_test_ptsI[i];
				}
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				double * y;		y = lat_TP;
				double * x;		x = lon_TP;
				for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
				{
					CString lat_tpStr, lon_tpStr;
					long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
					for(long jTP=0;jTP<n_tp;jTP++)
					{
						*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
						*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
					}
				}
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				CString STNal = CP154606.GE06_STN(GetFld(AllotmentSTR,2),GetFld(AllotmentSTR,3));
				int PECal = GE06_PEC(GetFld(AllotmentSTR,4) , GetFld(AllotmentSTR,5) , GetFld(AllotmentSTR,6) , SfnID_I , STNal) ;
				CString NETal;	NETal.Format("%s%d",STNal,PECal);
				CString RPCal = GetFld(AllotmentSTR,7);
				CString RNal = _T("");
				if     (NETal==_T("ALT4"))							RNal = GetFld(AllotmentSTR,8);
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC4")))	RNal = _T("RN5");
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC5")))	RNal = _T("RN6");

				double PRal = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
						Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPCal,SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I); 

				double Sigma_Nal = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_Ii, RxMode_I, RPCal, Freq_I, -1);
				double CFal = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_Nal*Sigma_Nal);
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				double CNFSj = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
													 latCal, lonCal, Freq_I, Pol_Ii, RPCal, RNal,
													 lat_TP, lon_TP, NcontourT, CFal, PRal, AntDisc, ENV, Ti); 
				CNFSallot = CNFSj;
				delete [] contourkeyI;	delete [] nb_test_ptsI;		delete [] lat_TP;		delete [] lon_TP;
			}//if GeoArea_I
			else
			{
				CString lat_tpSTR, lon_tpSTR;
				double dum;
				long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_Ii, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				for(long jTP=0;jTP<NcontourT;jTP++)
				{
					lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
					lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
				}
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				CString STNal = CP154606.GE06_STN(GetFld(AllotmentSTR,2),GetFld(AllotmentSTR,3));
				int PECal = GE06_PEC(GetFld(AllotmentSTR,4) , GetFld(AllotmentSTR,5) , GetFld(AllotmentSTR,6) , SfnID_I , STNal) ;
				CString NETal;	NETal.Format("%s%d",STNal,PECal);
				CString RPCal = GetFld(AllotmentSTR,7);
				CString RNal = _T("");
				if     (NETal==_T("ALT4"))							RNal = GetFld(AllotmentSTR,8);
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC4")))	RNal = _T("RN5");
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC5")))	RNal = _T("RN6");

				double PRal = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
						Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPCal,SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I); 

				double Sigma_Nal = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_Ii, RxMode_I, RPCal, Freq_I, -1);
				double CFal = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_Nal*Sigma_Nal);
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				double CNFSj = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
													 latCal, lonCal, Freq_I, Pol_Ii, RPCal, RNal,
													 lat_TP, lon_TP, NcontourT, CFal, PRal, AntDisc, ENV, Ti); 
				CNFSallot = CNFSj;
				delete [] lat_TP;	delete [] lon_TP;
			}//else GeoArea_I
			CNFS = max(CNFSsfn , CNFSallot);

		}/////////A4_1
		else if((NET_I==_T("ALS4"))||(NET_I==_T("ALT4")))	/////////A4_2
		{
			double CNFSsfn = 0, CNFSallot = 0;
			CString dumstr;
			//+++++++++++++++Assignment++++++++++++++++++++++++++++++++++++++++
			CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN,ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN, NoticeTypeN, RPCN , SysVarN, RxModeN;
			long numAssign = QGE06_CArea_Q2_1(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
											&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN,
											&NoticeTypeN, &RPCN , &SysVarN, &RxModeN,&dumstr) ;

			CString NoticeType_Ii = GetFld(NoticeTypeN,1),	RPC_Ii = GetFld(RPCN,1),	SysVar_Ii = GetFld(SysVarN,1),			RxMode_Ii = GetFld(RxModeN,1);

			double PRas = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
						Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPC_Ii,SysVar_Ii, freq_vcarr_I, TV_COLOR_I); 

			double Sigma_Nas = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_Ii, RxMode_Ii, RPC_Ii, Freq_I, -1);
			double CFas = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_Nas*Sigma_Nas);
			double CNFSjAS = 0;
			for(int iAS = 0; iAS<numAssign ; iAS++)
			{
				double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
				CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
						AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
						ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

				double CNFS1 = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
									 GeoLat_Ii, GeoLon_Ii, Freq_I, Pol_Ii, Hagl_Ii,
									 AntDir_Ii, AntCatID_Ii, ERP_h_dbw_Ii, ERP_v_dbw_Ii,
									 latCal, lonCal, CFas, PRas, AntDisc, ENV, Ti, kfactor);

				CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
			}//for  iAS
			CNFSsfn = 10.0*log10(CNFSjAS);

			//+++++++++++++++Allotment++++++++++++++++++++++++++++++++++++++++
			if(GeoArea_I.IsEmpty())
			{
				CString contourkeyN , nb_test_ptsN;
				long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_I) , &contourkeyN , &nb_test_ptsN);
				long *contourkeyI;		contourkeyI = new long[contourkeyNum];
				long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
				double dum;
				long NcontourT = 0;
				for(long i=0;i<contourkeyNum;i++)
				{
					contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
					nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
					NcontourT = NcontourT + nb_test_ptsI[i];
				}
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				double * y;		y = lat_TP;
				double * x;		x = lon_TP;
				for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
				{
					CString lat_tpStr, lon_tpStr;
					long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
					for(long jTP=0;jTP<n_tp;jTP++)
					{
						*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
						*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
					}
				}
				CString RN = _T("");
				if     (NET_I==_T("ALT4"))							RN = RN_I;
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

				double CNFSj = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
													 latCal, lonCal, Freq_I, Pol_I, RPC_I, RN,
													 lat_TP, lon_TP, NcontourT, CF, PR, AntDisc, ENV, Ti); 

				CNFSallot = CNFSj;
				delete [] contourkeyI;	delete [] nb_test_ptsI;	delete [] lat_TP;		delete [] lon_TP;
			}//if GeoArea_I
			else
			{
				CString lat_tpSTR, lon_tpSTR;
				double dum;
				long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				for(long jTP=0;jTP<NcontourT;jTP++)
				{
					lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
					lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
				}
				CString RN = _T("");
				if     (NET_I==_T("ALT4"))							RN = RN_I;
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

				double CNFSj = CNFS_FunctionAL_Int_0(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
													 latCal, lonCal, Freq_I, Pol_I, RPC_I, RN,
													 lat_TP, lon_TP, NcontourT, CF, PR, AntDisc, ENV, Ti); 

				CNFSallot = CNFSj;
				delete [] lat_TP;		delete [] lon_TP;
			}//else GeoArea_I
			CNFS = max(CNFSsfn , CNFSallot);

		}/////////A4_2
	}//if(PEC_I==4)
	else if(PEC_I==5)
	{
		if((NET_I==_T("ASS5"))||(NET_I==_T("AST5")))	/////////A5_1
		{
			CString allotkey_Ii = QGE06_CArea_Q3(AssocAllotID_I) ;
			CNFS = CNFS_Function_Int_0( GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
											 GeoLat_I, GeoLon_I, Freq_I, Pol_I, Hagl_I,
											 AntDir_I, AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I,
											 latCal, lonCal, CF, PR, AntDisc, ENV, Ti, kfactor);
		}	/////////A5_1
		else if((NET_I==_T("ALS5"))||(NET_I==_T("ALT5")))	/////////A5_2
		{
			CString ASstr = QGE06_CArea_Q4(AdmRefID_I),
					IDst_Ii = GetFld(ASstr,1),
					Pol_Ii = GetFld(ASstr,2),			ERP_h_dbw_Ii = GetFld(ASstr,5),
					ERP_v_dbw_Ii = GetFld(ASstr,6),		AntDir_Ii = GetFld(ASstr,7),
					AntCatID_Ii = GetFld(ASstr,8),		Hagl_Ii = GetFld(ASstr,9),
					NoticeType_Ii = GetFld(ASstr,10),	RPC_Ii = GetFld(ASstr,11),
					SYS_VAR_Ii = GetFld(ASstr,12),		RxMode_Ii = GetFld(ASstr,13);
			double  GeoLat_Ii = atof(GetFld(ASstr,3)),	GeoLon_Ii = atof(GetFld(ASstr,4));

			double PRas = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
						Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPC_Ii,SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I); 
			double Sigma_Nas = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_Ii, RxMode_Ii, RPC_Ii, Freq_I, -1);
			double CFas = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_Nas*Sigma_Nas);

			CNFS = CNFS_Function_Int_0( GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W, NoticeType_W, RxMode_W, RPC_W,
											 GeoLat_Ii, GeoLon_Ii, Freq_I, Pol_Ii, Hagl_Ii,
											 AntDir_Ii, AntCatID_Ii, ERP_h_dbw_Ii, ERP_v_dbw_Ii,
											 latCal, lonCal, CFas, PRas, AntDisc, ENV, Ti, kfactor);
		}	/////////A5_2
	}//if(PEC_I==5)

	return CNFS;
}


double CSMS4DCView::CNFS_Function_Int(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
								CString NoticeType_W,CString RXMode_W,CString RPC_W,
								double GeoLat_I,double GeoLon_I,double Freq_I, CString Pol_I, CString Hagl_I,
								CString AntDir_I, CString AntCatID_I, CString ERP_h_dbw_I,CString ERP_v_dbw_I,
								double latCal,double lonCal,double CF,double  PR,
								int AntDisc, int ENV,double Ti,double kfactor,double A2D) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	int az0[37];
	for(int i=0;i<=36;i++)		az0[i] = 10*i;
	double az_I2Cal = Azimuth_Deg(GeoLat_I,GeoLon_I,latCal,lonCal) ;
	double attH0_I[37], attV0_I[37];
	if(AntDir_I==_T("D"))
		GE84pattern(atol(AntCatID_I),attH0_I,attV0_I,Pol_I);
	else
		for(int i=0;i<36;i++)
		{
			attH0_I[i] = 0;		attV0_I[i] = 0;
		}
	attH0_I[36] = attH0_I[0];	attV0_I[36] = attV0_I[0];

	double attnH_I2Cal = Interp2(az0,attH0_I,az_I2Cal,37) ;
	double attnV_I2Cal = Interp2(az0,attV0_I,az_I2Cal,37) ;

	double ERPH,ERPV;
	if     (Pol_I==_T("H"))						ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal;
	else if(Pol_I==_T("V"))						ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal-A2D;	ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal-A2D;}
	/////////////////////////// h1_I //////////////////////
	double h1_I, lat3km, lon3km, lat15km, lon15km;
	double dist_I2Cal = Distance_km(GeoLat_I,GeoLon_I,latCal,lonCal) ;

	OnDatabaseStationsindesktop2(GeoLat_I,GeoLon_I);
	double Hasl_I = LatLon2Hg(GeoLat_I,GeoLon_I);
	double Hasgl_I = Hasl_I + atof(Hagl_I);

	if (dist_I2Cal>=15.0)
	{
		reckon(GeoLat_I,GeoLon_I,  3.0 , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I, 15.0 , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km,120);
	}
	else
	{
		reckon(GeoLat_I,GeoLon_I, 0.2*dist_I2Cal , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I,     dist_I2Cal , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km,120);
	}
	double ATTNantrec = 0, PolAntDisc = 0;
	if((AntDisc==1)&&((NoticeType_W==_T("DT1"))||(NoticeType_W==_T("GT1")))&&((RXMode_W==_T("FX"))||(RPC_W==_T("RPC1"))))
	{
		double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
		double az_Cal2I = Azimuth_Deg(latCal,lonCal,GeoLat_I,GeoLon_I) ;
		double AZMantrec = fabs(az_Cal2W-az_Cal2I);
		if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
		ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
		PolAntDisc = 16;
	}
	double Em = -999, EmH = -999, EmV = -999, EmI = -999;
	Em = E_P154606(GeoLat_I,GeoLon_I,latCal,lonCal, h1_I, Hasgl_I, Freq_I, kfactor, Ti, 10, ENV,0,50, 0);

	if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
	else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}

	if     (Pol_W==_T("H"))						EmI = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
	else if(Pol_W==_T("V"))						EmI = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
	else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	EmI = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));

	double EmIT = EmI;

	CNFS = EmIT + PR + CF;
	return CNFS;
}


double CSMS4DCView::CNFS_FunctionAL_Int(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
									CString NoticeType_W,CString RXMode_W,CString RPC_W,
									double latCal,double lonCal,double Freq_I, CString Pol_I, CString RPC_I,CString RN,
									double lat_TP[],double lon_TP[],long NcontourT,double CF,double PR,
									int AntDisc, int ENV,double Ti) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	double latTx[7], lonTx[7] , ERPall[7];
	CString Band_I  = CP154606.GE06_Band(Freq_I);

	double DistLimit = 999999999999 , latmin, lonmin , Di1;
	for(long jTP=0;jTP<NcontourT;jTP++)
	{
		Di1 = Distance_km(latCal, lonCal,lat_TP[jTP],lon_TP[jTP]);
		DistLimit = min(DistLimit , Di1);
		if(DistLimit == Di1)
		{
			latmin = lat_TP[jTP];		lonmin = lon_TP[jTP];
		}
	}
	int N_Tx = CP154606.Table_RNs(latCal,lonCal, latmin,lonmin,Freq_I,Band_I,RPC_I,RN, ERPall,latTx,lonTx) ;

	double ERPH,ERPV, EmIT = 0;
	for(int ASi=0;ASi<N_Tx;ASi++)
	{
		if     (Pol_I==_T("H"))						ERPH = ERPall[ASi];
		else if(Pol_I==_T("V"))						ERPV = ERPall[ASi];
		else if((Pol_I==_T("M"))||(Pol_I==_T("U"))){ERPH = ERPall[ASi]-3.0;	ERPV = ERPall[ASi]-3.0;}
		double ATTNantrec = 0, PolAntDisc = 0;
		if((AntDisc==1)&&((NoticeType_W==_T("DT1"))||(NoticeType_W==_T("GT1")))&&((RXMode_W==_T("FX"))||(RPC_W==_T("RPC1"))))
		{
			double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
			double az_Cal2I = Azimuth_Deg(latCal,lonCal,latTx[ASi],lonTx[ASi]) ;
			double AZMantrec = fabs(az_Cal2W-az_Cal2I);
			if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
			ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
			PolAntDisc = 16;
		}
		double Em = -999, EmH = -999, EmV = -999, Em1 = -999;
//		Em = E_P154606AL(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, Freq_I, Ti,10, ENV,0,50);
		Em = E_P154606AL(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, Freq_I, Ti);
		if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
		else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
		else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}
		if     (Pol_W==_T("H"))						Em1 = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
		else if(Pol_W==_T("V"))						Em1 = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
		else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	Em1 = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));
		EmIT = EmIT + pow(10.0 , Em1/10.0);
	}
	EmIT = 10.0*log10(EmIT);

	CNFS = EmIT + PR + CF;
	return CNFS;
}

void CSMS4DCView::OnCoordinationGe06InttoBcbt2dbcbt() 
{
	CString Sel_I = QGE06_IntTo_Qx();
	if(Sel_I.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;

			CString IDst_I = GetFld(Sel_I,1),				Fragment_I = GetFld(Sel_I,28),	
					NoticeType_I = GetFld(Sel_I,35),		AdmRefID_I = GetFld(Sel_I,33),
					AssocAllotID_I = GetFld(Sel_I,59),		PlanEntry_I = GetFld(Sel_I,50),
					SfnID_I = GetFld(Sel_I,52),				allotkey_I = GetFld(Sel_I,64),
					RxMode_I = GetFld(Sel_I,54),			RPC_I = GetFld(Sel_I,37),
					TV_SYS_I = GetFld(Sel_I,36),			SYS_VAR_I = GetFld(Sel_I,38),
					TV_COLOR_I = GetFld(Sel_I,40);
			CString Pol_I = GetFld(Sel_I,13),				Hagl_I = GetFld(Sel_I,5),
					AntDir_I = GetFld(Sel_I,31),			AntCatID_I = GetFld(Sel_I,30),
					ERP_h_dbw_I = GetFld(Sel_I,62),			ERP_v_dbw_I = GetFld(Sel_I,63),
					GeoArea_I = GetFld(Sel_I,53),
					RN_I = GetFld(Sel_I,61),				SiteName_I = GetFld(Sel_I,2),
					ctry_I = GetFld(Sel_I,25),				AssignCode_I = GetFld(Sel_I,51);
			double  Freq_I = atof(GetFld(Sel_I,6)),			GeoLat_I = atof(GetFld(Sel_I,3)),
					freq_vcarr_I = atof(GetFld(Sel_I,39)),	GeoLon_I = atof(GetFld(Sel_I,4));

//			if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
//			else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
//			CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			CP154606_Functions CP154606;
			CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
			int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
			CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);

			int nstr_I = 0;
			CString str_I;
//			double pi = 4.0*atan(1.0);

			double GRlat_I , GRlon_I , frq_MHz_I;
			CString IDst_IT = _T(""), allotkey_IT = _T("");
			int nIDst_IT = 0, nallotkey_IT = 0;

			if((NET_I==_T("ASS1"))||(NET_I==_T("AST1"))||(NET_I==_T("ASA0")))	/////////A1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;			frq_MHz_I = Freq_I;
				IDst_IT = IDst_IT + _T(",") + IDst_I;		nIDst_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A1
			else if((NET_I==_T("ASS2"))||(NET_I==_T("AST2")))	/////////A2
			{
				CString IDstN;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &GRlat_I, &GRlon_I,&str_I);
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;		nIDst_IT = nIDst_IT + nASS;

				nstr_I = nASS;

			}	/////////A2
			else if((NET_I==_T("ALS3"))||(NET_I==_T("ALT3")))	/////////A3
			{
				CString GeoArea_I = GetFld(Sel_I,53);
				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				CString IDstN,dum;
				long nASS = QGE06_IntFrom_C(SfnID_I,&IDstN,&dum); 
				IDst_IT = IDst_IT + _T(",") + IDstN;					nIDst_IT = nIDst_IT + nASS;

				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A3
			else if((NET_I==_T("ASS4"))||(NET_I==_T("AST4")))	/////////A4_1
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString str_IL = QGE06_IntTo_Q3(SfnID_I);
				CString allotkey_IL = GetFld(str_IL,1);
				CString GeoArea_IL = GetFld(str_IL,2);
				if(GeoArea_IL.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_IL, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_IL, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				CString IDstN0,dums;
				long nASS0 = QGE06_IntFrom_C(SfnID_I,&IDstN0,&dums); 

				IDst_IT = IDst_IT + _T(",") + IDstN0;					nIDst_IT = nIDst_IT + nASS0;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_1
			else if((NET_I==_T("ALS4"))||(NET_I==_T("ALT4")))	/////////A4_2
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I, SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString GeoArea_I = GetFld(Sel_I,53);

				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				CString IDstN0,dums;
				long nASS0 = QGE06_IntFrom_C(SfnID_I,&IDstN0,&dums); 

				IDst_IT = IDst_IT + _T(",") + IDstN0;					nIDst_IT = nIDst_IT + nASS0;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_2
			else if((NET_I==_T("ASS5"))||(NET_I==_T("AST5")))	/////////A5_1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;		frq_MHz_I = Freq_I;

		//		CString str_IL = QGE06_IntTo_Q3(SfnID_I);
		//		CString allotkey_IL = GetFld(str_IL,1),		GeoArea_ILx = GetFld(str_IL,2);
				CString allotkey_IL = QGE06_CArea_Q3(AssocAllotID_I) ;

				IDst_IT = IDst_IT + _T(",") + IDst_I;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				CString str_I1, str_I2;
				str_I1.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);
				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_1
			else if((NET_I==_T("ALS5"))||(NET_I==_T("ALT5")))	/////////A5_2
			{
				CString AdmRefID_I = GetFld(Sel_I,33);
				CString IDst_IL,GeoLat0,GeoLon0,Frequency0, str_I1, str_I2;
				int c = QGE06_IntTo_Q4(AdmRefID_I,&IDst_IL, &GeoLat0, &GeoLon0, &Frequency0, &str_I1);

				GRlat_I = atof(GeoLat0);	GRlon_I = atof(GeoLon0);		frq_MHz_I = atof(Frequency0);

				IDst_IT = IDst_IT + _T(",") + IDst_IL;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_2
			IDst_IT.Delete(0);
			allotkey_IT.Delete(0);
			double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, -1);

			//Victim Records
			CString str_W = _T("");
			int Nstr_W = 0;
			int Nrowy = QGE06_IntToBCBT2DBCBT_Qy(IDst_IT, nIDst_IT, allotkey_IT, nallotkey_IT, GRlat_I, GRlon_I, SR, frq_MHz_I, FR); 
			if(Nrowy>0)
			{
				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_I, GRlon_I , 1500.0); 
				for(int i_W=0;i_W<Nrowy;i_W++)
				{
					CString Sel_W = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_W];
					CString IDst_W = GetFld(Sel_W,1),		Fragment_W = GetFld(Sel_W,28),	NoticeType_W = GetFld(Sel_W,35),
							TV_SYS_W = GetFld(Sel_W,36),	RPC_W = GetFld(Sel_W,37),		GeoArea_W = GetFld(Sel_W,53),
							SYS_VAR_W = GetFld(Sel_W,38),	RxMode_W = GetFld(Sel_W,54),	allotkey_W = GetFld(Sel_W,64),	
							Pol_W = GetFld(Sel_W,13),
							AdmRefID_W = GetFld(Sel_W,33),	AssocAllotID_W = GetFld(Sel_W,59),
							PlanEntry_W = GetFld(Sel_W,50),	SfnID_W = GetFld(Sel_W,52),
							SiteName_W = GetFld(Sel_W,2),	ctry_W = GetFld(Sel_W,25),	AssignCode_W = GetFld(Sel_W,51);

		//			if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
		//			else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
		//			CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
					CString adm_W = Cty2AdmGE06(&ctry_W);

					double  Freq_W = atof(GetFld(Sel_W,6)),	GeoLat_W = atof(GetFld(Sel_W,3)),	GeoLon_W = atof(GetFld(Sel_W,4));

					CString STN_W = CP154606.GE06_STN(Fragment_W, NoticeType_W);
					int PEC_W = GE06_PEC(AdmRefID_W , AssocAllotID_W , PlanEntry_W , SfnID_W , STN_W) ;

					double L, EmedW, Sigma_W;	int AntDisc0;
					CP154606.Default_CArea_0(Fragment_W, NoticeType_W, RxMode_W, RPC_W,Freq_W, TV_SYS_W, SYS_VAR_W, &L,&EmedW,&AntDisc0,&Sigma_W); 
					double miu_W = CP154606.Qi(100-L);
					double CF = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_I*Sigma_I);
					double PR = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
											Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I,SYS_VAR_I, freq_vcarr_I, TV_COLOR_I); 
					if(PR>-999)
					{
						double PMmin = 9999999, LatMin,LonMin,CNFSmax,PM;
						BOOL falg1 = TRUE;
						if(IDst_W!=_T("---"))
						{
							CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
							long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
							if(nSRV<3)
							{
								CString strOUT;
								strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
								MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
								falg1 = FALSE;
							}
							else
							{
								double lat_TP,	lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<nSRV;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																	GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																	Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																	GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																	AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																	AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																	lat_TP, lon_TP, CF, PR, AntDisc, ENV, Ti, kfactor);
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for

							}//if nSRV

						}//if Dst_W
						else if(IDst_W==_T("---"))
						{
							if(GeoArea_W.IsEmpty())
							{
								CString contourkeyN , nb_test_ptsN;
								long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_W) , &contourkeyN , &nb_test_ptsN);
								long *contourkeyI;		contourkeyI = new long[contourkeyNum];
								long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
								double *GRlatC;			GRlatC = new double[contourkeyNum];
								double *GRlonC;			GRlonC = new double[contourkeyNum];
								long NcontourT = 0;
								for(long i=0;i<contourkeyNum;i++)
								{
									contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
									nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
									NcontourT = NcontourT + nb_test_ptsI[i];
								}
								double * lat_TP;   lat_TP = new double[NcontourT];
								double * lon_TP;   lon_TP = new double[NcontourT];
								double * y;		y = lat_TP;
								double * x;		x = lon_TP;
								for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
								{
									CString lat_tpStr, lon_tpStr;
									long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM] ,nb_test_ptsI[iCNUM] , &lat_tpStr, &lon_tpStr , &GRlatC[iCNUM] , &GRlonC[iCNUM]) ;
									for(long jTP=0;jTP<n_tp;jTP++)
									{
										*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
										*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
									}
								}

								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																	GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																	Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																	GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																	AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																	AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																	lat_TP[jTP], lon_TP[jTP], CF, PR, AntDisc, ENV, Ti, kfactor);
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
									}
								}//for
								delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] GRlatC;	delete [] GRlonC;
								delete [] lat_TP;			delete [] lon_TP;
							}//if GeoArea_W
							else
							{
								CString lat_tpSTR, lon_tpSTR;
								double dum;
								long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR,&dum , &dum) ;
								double lat_TP, lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));	lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																	GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																	Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																	GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																	AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																	AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																	lat_TP, lon_TP, CF, PR, AntDisc, ENV, Ti, kfactor);
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for
							}//else GeoArea_W
						}//if(IDst_W==_T("---"))
						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_W1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							str_W1.Format(_T("%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") , adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,SfnID_W,L,EmedW,CNFSmax,PMmin,LPM);
							str_W = str_W + _T(",") + str_W1;
							Nstr_W++;
						}

					}//if (PR>-999)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_W<Nrowy
				if(Nstr_W>0)
				{
					str_W.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_I;
					dlgList.m_dataY = str_W;
					dlgList.m_rowsX = nstr_I+1;
					dlgList.m_rowsY = 1+Nstr_W;
					dlgList.m_mode = 4;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference BC-BT to Digital BC-BT");
					dlgList.m_title2 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title3 = _Z("Victim Assignments/Allotments :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//if Nrowy

		}//if DLG
		
	}//if Sel_I
	Set_STtable_Default();
	EndWaitCursor();
}


int CSMS4DCView::QGE06_IntToBCBT2ABCBT_Qy(CString IDst_I, double GRlat, double GRlon, double SR, double Freq_I, double FR) 
{
	int NrowT = 0, Nrow = 0;
	CString CDataBaseSTR = _T("");

	double dumy,  lonmin , lonmax , latmin , latmax ,rng_km = SR , fmin , fmax;
	fmin = Freq_I - FR;
	fmax = Freq_I + FR;
	reckon(GRlat,GRlon, rng_km,  0.0,&latmax,&dumy) ;
	reckon(GRlat,GRlon, rng_km,180.0,&latmin,&dumy) ;
	reckon(GRlat,GRlon, rng_km, 90.0,&dumy,&lonmax) ;
	reckon(GRlat,GRlon, rng_km,270.0,&dumy,&lonmin) ;
//	CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)<>\'%s\') AND ((Fragment)='GE06A') AND ((Frequency)>=%lf And (Frequency)<=%lf) AND ((GeoLat)>=%lf And (GeoLat)<=%lf) AND ((GeoLon)>=%lf And (GeoLon)<=%lf));"), IDst_I, fmin , fmax, latmin , latmax, lonmin , lonmax);
	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((IDst)<>\'%s\') AND ((Fragment)='GE06A') AND ((Frequency)>=%lf And (Frequency)<=%lf) AND ((GeoLat)>=%lf And (GeoLat)<=%lf) AND ((GeoLon)>=%lf And (GeoLon)<=%lf));"), m_qCommonFields,IDst_I, fmin , fmax, latmin , latmax, lonmin , lonmax);
	CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase DB1;		CRecordset rs;
	DB1.Open(m_DB,false,false,_T("ODBC;"),false);
	rs.m_pDatabase = &DB1;

	double STlat_deg , STlon_deg;
	CString str, IDst , IDstN = _T("");

	rs.Open(CRecordset::snapshot, CDataBaseSTR);
	if(rs.GetRecordCount() == 1)
	{
		rs.MoveFirst();
		while(1)
		{
			if(rs.IsEOF()) break;
			rs.GetFieldValue(_T("IDst"),IDst);
			rs.GetFieldValue(_T("GeoLat"),str);		STlat_deg = atof(str);
			rs.GetFieldValue(_T("GeoLon"),str);		STlon_deg = atof(str);
			double dist = Distance_km(GRlat,GRlon,STlat_deg,STlon_deg);
			if((dist <= SR)&&(dist > 0.0000001))
			{
				IDstN = IDstN + _T(",") + IDst;
				Nrow++;
			}
			rs.MoveNext();
		}//while
	}//if
	rs.Close();		DB1.Close();

	IDstN.Delete(0);
	if(Nrow>0)
	{
		CString str1,str2 = _T("");
		for(long j=0 ; j<Nrow ;j++)
		{
			str1.Format(_T("(((IDst)=\'%s\'))"),GetFld(IDstN,j+1));
			str2 = str2 + _T(" OR ") + str1;
		}
		str2.Delete(0,4);	str2 = str2 + _T(";");
//		CDataBaseSTR.Format(_T("SELECT * FROM STtableGE06ASAL WHERE %s"),str2);
		CDataBaseSTR.Format(_T("SELECT * FROM %s  WHERE %s "),m_qSTtableGE06ASAL,str2);
	}
	else	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE IDst=\'z\';") , m_qSTtableGE06ASAL);
//	else	CDataBaseSTR = _T("SELECT * FROM STtableGE06ASAL WHERE IDst=\'z\';");

	((CSMS4DCApp *)AfxGetApp())->Nrow = 0;
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _T("Victim Assignments");
	if (datadlg.DoModal()==IDOK)
		NrowT = ((CSMS4DCApp *)AfxGetApp())->Nrow;
	
	return NrowT;
}

void CSMS4DCView::OnCoordinationGe06InttoBcbt2Abt() 
{
	CString Sel_I = QGE06_IntTo_Qx();
	if(Sel_I.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 0.5;
		intDLG.m_LPMstr = _Z("Limiting Margin (dB) :");
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;

			CString IDst_I = GetFld(Sel_I,1),				Fragment_I = GetFld(Sel_I,28),	
					NoticeType_I = GetFld(Sel_I,35),		AdmRefID_I = GetFld(Sel_I,33),
					AssocAllotID_I = GetFld(Sel_I,59),		PlanEntry_I = GetFld(Sel_I,50),
					SfnID_I = GetFld(Sel_I,52),				allotkey_I = GetFld(Sel_I,64),
					RxMode_I = GetFld(Sel_I,54),			RPC_I = GetFld(Sel_I,37),
					TV_SYS_I = GetFld(Sel_I,36),			SYS_VAR_I = GetFld(Sel_I,38),
					TV_COLOR_I = GetFld(Sel_I,40);
			CString Pol_I = GetFld(Sel_I,13),				Hagl_I = GetFld(Sel_I,5),
					AntDir_I = GetFld(Sel_I,31),			AntCatID_I = GetFld(Sel_I,30),
					ERP_h_dbw_I = GetFld(Sel_I,62),			ERP_v_dbw_I = GetFld(Sel_I,63),
					GeoArea_I = GetFld(Sel_I,53),
					RN_I = GetFld(Sel_I,61),				SiteName_I = GetFld(Sel_I,2),
					ctry_I = GetFld(Sel_I,25),				AssignCode_I = GetFld(Sel_I,51);
			CString oset_v_khz_I = GetFld(Sel_I,43),		TV_ch_I = GetFld(Sel_I,44),
					oset_v_12_I = GetFld(Sel_I,42);
			double  Freq_I = atof(GetFld(Sel_I,6)),			GeoLat_I = atof(GetFld(Sel_I,3)),
					freq_vcarr_I = atof(GetFld(Sel_I,39)),	GeoLon_I = atof(GetFld(Sel_I,4));
			double  freq_scarr_I = atof(GetFld(Sel_I,41)),	pwr_ratio_I = atof(GetFld(Sel_I,46));

	//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
	//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
	//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			CP154606_Functions CP154606;
			CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
			int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
			CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);

			int nstr_I = 0;
			CString str_I;
//			double pi = 4.0*atan(1.0);

			double GRlat_I , GRlon_I , frq_MHz_I;
			CString IDst_IT = _T(""), allotkey_IT = _T("");
			int nIDst_IT = 0, nallotkey_IT = 0;

			if((NET_I==_T("ASS1"))||(NET_I==_T("AST1"))||(NET_I==_T("ASA0")))	/////////A1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;			frq_MHz_I = Freq_I;
				IDst_IT = IDst_IT + _T(",") + IDst_I;		nIDst_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A1
			else if((NET_I==_T("ASS2"))||(NET_I==_T("AST2")))	/////////A2
			{
				CString IDstN;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &GRlat_I, &GRlon_I,&str_I);
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;		nIDst_IT = nIDst_IT + nASS;

				nstr_I = nASS;

			}	/////////A2
			else if((NET_I==_T("ALS3"))||(NET_I==_T("ALT3")))	/////////A3
			{
				CString GeoArea_I = GetFld(Sel_I,53);
				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A3
			else if((NET_I==_T("ASS4"))||(NET_I==_T("AST4")))	/////////A4_1
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString str_IL = QGE06_IntTo_Q3(SfnID_I);
				CString allotkey_IL = GetFld(str_IL,1);
				CString GeoArea_IL = GetFld(str_IL,2);
				if(GeoArea_IL.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_IL, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_IL, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;					nIDst_IT = nIDst_IT + nASS;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_1
			else if((NET_I==_T("ALS4"))||(NET_I==_T("ALT4")))	/////////A4_2
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I, SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString GeoArea_I = GetFld(Sel_I,53);

				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;					nIDst_IT = nIDst_IT + nASS;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_2
			else if((NET_I==_T("ASS5"))||(NET_I==_T("AST5")))	/////////A5_1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;		frq_MHz_I = Freq_I;

			//	CString str_IL = QGE06_IntTo_Q3(SfnID_I);
			//	CString allotkey_IL = GetFld(str_IL,1),		GeoArea_IL = GetFld(str_IL,2);
				CString allotkey_IL = QGE06_CArea_Q3(AssocAllotID_I) ;

				IDst_IT = IDst_IT + _T(",") + IDst_I;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				CString str_I1, str_I2;
				str_I1.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);
				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_1
			else if((NET_I==_T("ALS5"))||(NET_I==_T("ALT5")))	/////////A5_2
			{
				CString AdmRefID_I = GetFld(Sel_I,33);
				CString IDst_IL,GeoLat0,GeoLon0,Frequency0, str_I1, str_I2;
				int c = QGE06_IntTo_Q4(AdmRefID_I,&IDst_IL, &GeoLat0, &GeoLon0, &Frequency0, &str_I1);

				GRlat_I = atof(GeoLat0);	GRlon_I = atof(GeoLon0);		frq_MHz_I = atof(Frequency0);

				IDst_IT = IDst_IT + _T(",") + IDst_IL;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_2
			IDst_IT.Delete(0);
			allotkey_IT.Delete(0);
			double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, -1);

			//Victim Records
			CString str_W = _T("");
			int Nstr_W = 0;
			int Nrowy = QGE06_IntToBCBT2ABCBT_Qy(IDst_I, GRlat_I, GRlon_I, SR, frq_MHz_I, FR); 
			if(Nrowy>0)
			{
				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_I, GRlon_I , 1500.0); 
				for(int i_W=0;i_W<Nrowy;i_W++)
				{
					CString Sel_W = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_W];
					CString IDst_W = GetFld(Sel_W,1),			Fragment_W = GetFld(Sel_W,28),	NoticeType_W = GetFld(Sel_W,35),
							TV_SYS_W = GetFld(Sel_W,36),		Pol_W = GetFld(Sel_W,13),		AdmRefID_W = GetFld(Sel_W,33),
							SiteName_W = GetFld(Sel_W,2),		ctry_W = GetFld(Sel_W,25);
					CString TV_COLOR_W = GetFld(Sel_W,40),		oset_v_12_W = GetFld(Sel_W,42),	oset_v_khz_W = GetFld(Sel_W,43),
							TV_ch_W = GetFld(Sel_W,44),			freq_stabl_W = GetFld(Sel_W,45);
				
		//			TV_SYS_W.TrimLeft();		TV_SYS_W.TrimRight();
		//			TV_COLOR_W.TrimLeft();		TV_COLOR_W.TrimRight();
		//			freq_stabl_W.TrimLeft();	freq_stabl_W.TrimRight();
		//			TV_SYS_I.TrimLeft();		TV_SYS_I.TrimRight();
		//			TV_COLOR_I.TrimLeft();		TV_COLOR_I.TrimRight();

					double	freq_vcarr_W = atof(GetFld(Sel_W,39)),	freq_scarr_W = atof(GetFld(Sel_W,41));

			//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
			//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
			//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
					CString adm_W = Cty2AdmGE06(&ctry_W);

					double  Freq_W = atof(GetFld(Sel_W,6)),	GeoLat_W = atof(GetFld(Sel_W,3)),	GeoLon_W = atof(GetFld(Sel_W,4));

					double L = 50, CF = 0;	
			//		double EmedW = CP154606.Table_1_Rec417(Freq_W , TV_SYS_W) ;

					double PRC = -999 , PRT = -999;	// NA
					CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W, 
							 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
							 Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, SYS_VAR_I, freq_vcarr_I, TV_COLOR_I,
							 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRC, &PRT);

					if((PRC>-999)&&(PRT>-999))
					{
						double PMmax = -99999, LatMin,LonMin,CNFSmax,PM, EmWmax, UFSmax;
						BOOL falg1 = TRUE;
						if(IDst_W!=_T("---"))
						{
							CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
							long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
							if(nSRV<3)
							{
								CString strOUT;
								strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
								MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
								falg1 = FALSE;
							}
							else
							{
								double lat_TP,	lon_TP,	UFS_TP, EmW_TP;
								PMmax = -99999;
								for(long jTP=0;jTP<nSRV;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));
									UFS_TP =  atof(GetFld(UFS_tpSTR , jTP+1));		EmW_TP =  atof(GetFld(Em_tpSTR , jTP+1));

									double CNFS = QGE06_IntToBCBT2ABCBT_CNFS(Freq_W, TV_SYS_W, GeoLat_W, GeoLon_W, Pol_W,
																	Fragment_I,NoticeType_I,Freq_I, TV_SYS_I, RPC_I,
																	GeoLat_I,GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I,PEC_I,
																	AdmRefID_I,	AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																	AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																	lat_TP, lon_TP, CF, PRC, PRT, AntDisc, ENV,Ti,kfactor,
																	freq_vcarr_W,freq_scarr_W,TV_ch_W,TV_COLOR_W,oset_v_12_W,oset_v_khz_W,freq_stabl_W,
																	SYS_VAR_I,freq_scarr_I,oset_v_12_I,oset_v_khz_I,TV_ch_I,pwr_ratio_I); 

									PM = 10.0*log10(pow(10.0, UFS_TP/10.0) + pow(10.0, CNFS/10.0)) - UFS_TP;
									PMmax = max(PMmax , PM);
									if(PMmax==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;  CNFSmax = CNFS;
										EmWmax = EmW_TP;	UFSmax = UFS_TP;
									}
								}//for

							}//if nSRV
						}//if Dst_W
						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_W1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

							str_W1.Format(_T("%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%0.1lf,%0.3lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") ,	adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,Freq_W,RLONbs,RLATbs,Pol_W,L,EmWmax,UFSmax,CNFSmax,PMmax,LPM);
							str_W = str_W + _T(",") + str_W1;
							Nstr_W++;
						}

					}//if((PRC>-999)&&(PRT>-999))

					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_W<Nrowy
				if(Nstr_W>0)
				{
					str_W.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_I;
					dlgList.m_dataY = str_W;
					dlgList.m_rowsX = nstr_I+1;
					dlgList.m_rowsY = 1+Nstr_W;
					dlgList.m_mode = 5;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference BC-BT to Analogue BT");
					dlgList.m_title2 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title3 = _Z("Victim Analogue Assignments :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//if Nrowy

		}//if DLG
		
	}//if Sel_I	
	Set_STtable_Default();
	EndWaitCursor();
}



double CSMS4DCView::QGE06_IntToBCBT2ABCBT_CNFS(double Freq_W, CString TV_SYS_W,	double GeoLat_W, double GeoLon_W, CString Pol_W,
									CString Fragment_I,CString NoticeType_I,double Freq_I, CString TV_SYS_I, CString RPC_I,
									double GeoLat_I,double GeoLon_I, CString Pol_I, double Sigma_I, double freq_vcarr_I, CString NET_I,int PEC_I,
									CString AdmRefID_I,	CString AssocAllotID_I, CString SfnID_I, CString allotkey_I, CString Hagl_I, CString AntDir_I,
									CString AntCatID_I, CString ERP_h_dbw_I, CString ERP_v_dbw_I, CString TV_COLOR_I, CString GeoArea_I, CString RN_I,
									double latCal,double lonCal, double CF, double PRC, double PRT, int AntDisc, int ENV,double Ti,double kfactor,
									
									double freq_vcarr_W,double freq_scarr_W,CString TV_ch_W,
									CString TV_COLOR_W,CString oset_v_12_W,CString oset_v_khz_W,CString freq_stabl_W,
									CString SYS_VAR_I,double freq_scarr_I,CString oset_v_12_I,CString oset_v_khz_I,
									CString TV_ch_I,double pwr_ratio_I) 
{
	double CNFS;
	CP154606_Functions CP154606;
	CString Fragment_W = _T("GE06A");

	if((NET_I==_T("ASA0"))||(PEC_I==1))
	{
		CNFS = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
							 GeoLat_I, GeoLon_I, Freq_I,Pol_I,Hagl_I,AntDir_I,AntCatID_I,ERP_h_dbw_I,
							 ERP_v_dbw_I,latCal, lonCal, CF,PRC,PRT,-999,AntDisc,ENV, Ti, kfactor, 0);

	}//if(PEC_I==1)
	else if(PEC_I==2)
	{
		CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN, ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN;
		long numAssign = QGE06_CArea_Q2(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
										&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN) ;
		double CNFSjAS = 0;
		for(int iAS = 0; iAS<numAssign ; iAS++)
		{
			double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
			CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
					AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
					ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

			double CNFS1 = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
							GeoLat_Ii, GeoLon_Ii, Freq_I,Pol_Ii,Hagl_Ii,AntDir_Ii,AntCatID_Ii,ERP_h_dbw_Ii,
							ERP_v_dbw_Ii,latCal, lonCal, CF,PRC,PRT,-999,AntDisc,ENV, Ti, kfactor, 0);
			CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
		}
		CNFS = 10.0*log10(CNFSjAS);
	}//if(PEC_I==2)
	else if(PEC_I==3)
	{
		if(GeoArea_I.IsEmpty())
		{
			CString contourkeyN , nb_test_ptsN;
			long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_I) , &contourkeyN , &nb_test_ptsN);
			long *contourkeyI;		contourkeyI = new long[contourkeyNum];
			long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
			double dum;
			long NcontourT = 0;
			for(long i=0;i<contourkeyNum;i++)
			{
				contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
				nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
				NcontourT = NcontourT + nb_test_ptsI[i];
			}
			double * lat_TP;   lat_TP = new double[NcontourT];
			double * lon_TP;   lon_TP = new double[NcontourT];
			double * y;		y = lat_TP;
			double * x;		x = lon_TP;
			for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
			{
				CString lat_tpStr, lon_tpStr;
				long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
				for(long jTP=0;jTP<n_tp;jTP++)
				{
					*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
					*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
				}
			}
			CString RN = _T("");
			if     (NET_I==_T("ALT3"))							RN = RN_I;
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

			CNFS = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
									latCal,lonCal,Freq_I, Pol_I, RPC_I,RN,lat_TP,lon_TP,NcontourT,CF,PRC,PRT,-999,AntDisc, ENV,Ti); 

			delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] lat_TP;	delete [] lon_TP;
		}//if GeoArea_I
		else
		{
			CString lat_tpSTR, lon_tpSTR;
			double dum;
			long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
			double * lat_TP;   lat_TP = new double[NcontourT];
			double * lon_TP;   lon_TP = new double[NcontourT];
			for(long jTP=0;jTP<NcontourT;jTP++)
			{
				lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
				lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
			}
			CString RN = _T("");
			if     (NET_I==_T("ALT3"))							RN = RN_I;
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
			else if((NET_I==_T("ALS3"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

			CNFS = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
									latCal,lonCal,Freq_I, Pol_I, RPC_I,RN,lat_TP,lon_TP,NcontourT,CF,PRC,PRT,-999,AntDisc, ENV,Ti); 
			delete [] lat_TP;		delete [] lon_TP;
		}//else GeoArea_I
	}//if(PEC_I==3)
	else if(PEC_I==4)
	{
		if((NET_I==_T("ASS4"))||(NET_I==_T("AST4")))	/////////A4_1
		{
			double CNFSsfn = 0, CNFSallot = 0;
			//+++++++++++++++Assignment++++++++++++++++++++++++++++++++++++++++
			CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN,ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN;
			long numAssign = QGE06_CArea_Q2(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
											&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN,1) ;
			double CNFSjAS = 0;
			for(int iAS = 0; iAS<numAssign ; iAS++)
			{
				double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
				CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
						AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
						ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

				double CNFS1 = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
								GeoLat_Ii, GeoLon_Ii, Freq_I,Pol_Ii,Hagl_Ii,AntDir_Ii,AntCatID_Ii,ERP_h_dbw_Ii,
								ERP_v_dbw_Ii,latCal, lonCal, CF,PRC,PRT,-999,AntDisc,ENV, Ti, kfactor, 0);
				CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
			}//for  iAS
			CNFSsfn = 10.0*log10(CNFSjAS);

			//+++++++++++++++Allotment++++++++++++++++++++++++++++++++++++++++
			CString AllotmentSTR = QGE06_BCBT_A4_1(SfnID_I) ;
			CString allotkey_Ii = GetFld(AllotmentSTR,1),
					NoticeType_Ii = GetFld(AllotmentSTR,3),		GeoArea_Ii = GetFld(AllotmentSTR,9),
					Pol_Ii = GetFld(AllotmentSTR,10),			SYS_VAR_Ii = GetFld(AllotmentSTR,11);
			if(GeoArea_Ii.IsEmpty())
			{
				CString contourkeyN , nb_test_ptsN;
				long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_Ii) , &contourkeyN , &nb_test_ptsN);
				long *contourkeyI;		contourkeyI = new long[contourkeyNum];
				long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
				double dum;
				long NcontourT = 0;
				for(long i=0;i<contourkeyNum;i++)
				{
					contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
					nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
					NcontourT = NcontourT + nb_test_ptsI[i];
				}
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				double * y;		y = lat_TP;
				double * x;		x = lon_TP;
				for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
				{
					CString lat_tpStr, lon_tpStr;
					long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
					for(long jTP=0;jTP<n_tp;jTP++)
					{
						*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
						*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
					}
				}
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				CString STNal = CP154606.GE06_STN(GetFld(AllotmentSTR,2),GetFld(AllotmentSTR,3));
				int PECal = GE06_PEC(GetFld(AllotmentSTR,4) , GetFld(AllotmentSTR,5) , GetFld(AllotmentSTR,6) , SfnID_I , STNal) ;
				CString NETal;	NETal.Format("%s%d",STNal,PECal);
				CString RPCal = GetFld(AllotmentSTR,7);
				CString RNal = _T("");
				if     (NETal==_T("ALT4"))							RNal = GetFld(AllotmentSTR,8);
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC4")))	RNal = _T("RN5");
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC5")))	RNal = _T("RN6");

				double PRCal = -999 , PRTal = -999;	// NA
				CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W, 
						 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
						 Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPCal, SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I,
						 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRCal, &PRTal); 
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				double CNFSj = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
										latCal,lonCal,Freq_I, Pol_Ii, RPCal,RNal,lat_TP,lon_TP,NcontourT,CF,PRCal,PRTal,-999,AntDisc, ENV,Ti); 
				CNFSallot = CNFSj;
				delete [] contourkeyI;	delete [] nb_test_ptsI;		delete [] lat_TP;		delete [] lon_TP;
			}//if GeoArea_I
			else
			{
				CString lat_tpSTR, lon_tpSTR;
				double dum;
				long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_Ii, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				for(long jTP=0;jTP<NcontourT;jTP++)
				{
					lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
					lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
				}
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				CString STNal = CP154606.GE06_STN(GetFld(AllotmentSTR,2),GetFld(AllotmentSTR,3));
				int PECal = GE06_PEC(GetFld(AllotmentSTR,4) , GetFld(AllotmentSTR,5) , GetFld(AllotmentSTR,6) , SfnID_I , STNal) ;
				CString NETal;	NETal.Format("%s%d",STNal,PECal);
				CString RPCal = GetFld(AllotmentSTR,7);
				CString RNal = _T("");
				if     (NETal==_T("ALT4"))							RNal = GetFld(AllotmentSTR,8);
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC4")))	RNal = _T("RN5");
				else if((NETal==_T("ALS4"))&&(RPCal==_T("RPC5")))	RNal = _T("RN6");

				double PRCal = -999 , PRTal = -999;	// NA
				CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W,
						 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
						 Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPCal, SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I,
						 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRCal, &PRTal); 
		//00000000000000000000000000000000000000000000000000000000000000000000000000
				double CNFSj = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
										latCal,lonCal,Freq_I, Pol_Ii, RPCal,RNal,lat_TP,lon_TP,NcontourT,CF,PRCal,PRTal,-999,AntDisc, ENV,Ti); 
				CNFSallot = CNFSj;
				delete [] lat_TP;	delete [] lon_TP;
			}//else GeoArea_I
			CNFS = max(CNFSsfn , CNFSallot);

		}/////////A4_1
		else if((NET_I==_T("ALS4"))||(NET_I==_T("ALT4")))	/////////A4_2
		{
			double CNFSsfn = 0, CNFSallot = 0;
			CString dumstr;
			//+++++++++++++++Assignment++++++++++++++++++++++++++++++++++++++++
			CString GeoLatN , GeoLonN , FrequencyN,PolN,ERP_h_dbwN,ERP_v_dbwN,AntCatIDN,AntHeightAGLN,AntIDN,MaxEffHghtN ,AntDirN ,IDstN, NoticeTypeN, RPCN , SysVarN, RxModeN;
			long numAssign = QGE06_CArea_Q2_1(SfnID_I,&GeoLatN,&GeoLonN,&FrequencyN,&PolN,&ERP_h_dbwN,&ERP_v_dbwN,
											&AntCatIDN,&AntHeightAGLN,&AntIDN,&MaxEffHghtN,&AntDirN,&IDstN,
											&NoticeTypeN, &RPCN , &SysVarN, &RxModeN,&dumstr) ;

			CString NoticeType_Ii = GetFld(NoticeTypeN,1),	RPC_Ii = GetFld(RPCN,1),	SysVar_Ii = GetFld(SysVarN,1);

			double PRCas = -999 , PRTas = -999;	// NA
			CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W,
					 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
					 Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPC_Ii, SysVar_Ii, freq_vcarr_I, TV_COLOR_I,
					 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRCas, &PRTas); 

			double CNFSjAS = 0;
			for(int iAS = 0; iAS<numAssign ; iAS++)
			{
				double  GeoLat_Ii = atof(GetFld(GeoLatN,iAS+1)),	GeoLon_Ii = atof(GetFld(GeoLonN,iAS+1));
				CString Pol_Ii = GetFld(PolN,iAS+1),				AntDir_Ii = GetFld(AntDirN,iAS+1),
						AntCatID_Ii = GetFld(AntCatIDN,iAS+1),		ERP_h_dbw_Ii = GetFld(ERP_h_dbwN,iAS+1),
						ERP_v_dbw_Ii = GetFld(ERP_v_dbwN,iAS+1),	Hagl_Ii = GetFld(AntHeightAGLN,iAS+1);

				double CNFS1 = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
								GeoLat_Ii, GeoLon_Ii, Freq_I,Pol_Ii,Hagl_Ii,AntDir_Ii,AntCatID_Ii,ERP_h_dbw_Ii,
								ERP_v_dbw_Ii,latCal, lonCal, CF,PRCas,PRTas,-999,AntDisc,ENV, Ti, kfactor, 0);
				CNFSjAS = CNFSjAS + pow(10.0, (CNFS1)/10.0);
			}//for  iAS
			CNFSsfn = 10.0*log10(CNFSjAS);

			//+++++++++++++++Allotment++++++++++++++++++++++++++++++++++++++++
			if(GeoArea_I.IsEmpty())
			{
				CString contourkeyN , nb_test_ptsN;
				long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_I) , &contourkeyN , &nb_test_ptsN);
				long *contourkeyI;		contourkeyI = new long[contourkeyNum];
				long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
				double dum;
				long NcontourT = 0;
				for(long i=0;i<contourkeyNum;i++)
				{
					contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
					nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
					NcontourT = NcontourT + nb_test_ptsI[i];
				}
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				double * y;		y = lat_TP;
				double * x;		x = lon_TP;
				for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
				{
					CString lat_tpStr, lon_tpStr;
					long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM], nb_test_ptsI[iCNUM], &lat_tpStr, &lon_tpStr, &dum, &dum) ;
					for(long jTP=0;jTP<n_tp;jTP++)
					{
						*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
						*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
					}
				}
				CString RN = _T("");
				if     (NET_I==_T("ALT4"))							RN = RN_I;
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

				double CNFSj = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
										latCal,lonCal,Freq_I, Pol_I, RPC_I,RN,lat_TP,lon_TP,NcontourT,CF,PRC,PRT,-999,AntDisc, ENV,Ti); 
				CNFSallot = CNFSj;
				delete [] contourkeyI;	delete [] nb_test_ptsI;	delete [] lat_TP;		delete [] lon_TP;
			}//if GeoArea_I
			else
			{
				CString lat_tpSTR, lon_tpSTR;
				double dum;
				long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &dum, &dum) ;
				double * lat_TP;   lat_TP = new double[NcontourT];
				double * lon_TP;   lon_TP = new double[NcontourT];
				for(long jTP=0;jTP<NcontourT;jTP++)
				{
					lat_TP[jTP] =  atof(GetFld(lat_tpSTR , jTP+1));
					lon_TP[jTP] =  atof(GetFld(lon_tpSTR , jTP+1));
				}
				CString RN = _T("");
				if     (NET_I==_T("ALT4"))							RN = RN_I;
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC4")))	RN = _T("RN5");
				else if((NET_I==_T("ALS4"))&&(RPC_I==_T("RPC5")))	RN = _T("RN6");

				double CNFSj = CNFS_FunctionAL_0(GeoLat_W,GeoLon_W,Freq_W, Pol_W, Fragment_W,
										latCal,lonCal,Freq_I, Pol_I, RPC_I,RN,lat_TP,lon_TP,NcontourT,CF,PRC,PRT,-999,AntDisc, ENV,Ti); 
				CNFSallot = CNFSj;
				delete [] lat_TP;		delete [] lon_TP;
			}//else GeoArea_I
			CNFS = max(CNFSsfn , CNFSallot);

		}/////////A4_2
	}//if(PEC_I==4)
	else if(PEC_I==5)
	{
		if((NET_I==_T("ASS5"))||(NET_I==_T("AST5")))	/////////A5_1
		{
			CNFS = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
							GeoLat_I, GeoLon_I, Freq_I,Pol_I,Hagl_I,AntDir_I,AntCatID_I,ERP_h_dbw_I,
							ERP_v_dbw_I,latCal, lonCal, CF,PRC,PRT,-999,AntDisc,ENV, Ti, kfactor, 0);
		}	/////////A5_1
		else if((NET_I==_T("ALS5"))||(NET_I==_T("ALT5")))	/////////A5_2
		{
			CString ASstr = QGE06_CArea_Q4(AdmRefID_I),
					Pol_Ii = GetFld(ASstr,2),			ERP_h_dbw_Ii = GetFld(ASstr,5),
					ERP_v_dbw_Ii = GetFld(ASstr,6),		AntDir_Ii = GetFld(ASstr,7),
					AntCatID_Ii = GetFld(ASstr,8),		Hagl_Ii = GetFld(ASstr,9),
					NoticeType_Ii = GetFld(ASstr,10),	RPC_Ii = GetFld(ASstr,11),
					SYS_VAR_Ii = GetFld(ASstr,12);		
			double  GeoLat_Ii = atof(GetFld(ASstr,3)),	GeoLon_Ii = atof(GetFld(ASstr,4));

			double PRCas = -999 , PRTas = -999;	// NA
			CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W,
					 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
					 Fragment_I, NoticeType_Ii, Freq_I, TV_SYS_I, RPC_Ii, SYS_VAR_Ii, freq_vcarr_I, TV_COLOR_I,
					 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRCas, &PRTas); 

			CNFS = CNFS_Function_0(GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
							GeoLat_Ii, GeoLon_Ii, Freq_I,Pol_Ii,Hagl_Ii,AntDir_Ii,AntCatID_Ii,ERP_h_dbw_Ii,
							ERP_v_dbw_Ii,latCal, lonCal, CF,PRCas,PRTas,-999,AntDisc,ENV, Ti, kfactor, 0);

		}	/////////A5_2
	}//if(PEC_I==5)

	return CNFS;
}

void CSMS4DCView::OnCoordinationGe06InttoFxm2dbcbt() 
{
	CString Sel_I = QGE06_IntTo_Qx(1);
	if(Sel_I.GetLength()>0)
	{
		CString sttp_I = GetFld(Sel_I,18),	StType_I = GetFld(Sel_I,29);
		int STflag = 0;

		if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
			STflag = 0;
		else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
			STflag = 1;

		CGE06intDLG1 intDLG;
		intDLG.m_FXMlocationDisp = STflag;
//		intDLG.m_FXMDisp = 1;
		if(intDLG.DoModal() == IDOK)
		{
			double	SR = intDLG.m_SR,			FR = intDLG.m_FR,
					Ti = intDLG.m_Ti,			LPM = intDLG.m_LPM,
					lat_I = intDLG.m_Lat,		lon_I = intDLG.m_Lon;
			int		ENV = intDLG.m_env,			
					AntDisc = intDLG.m_AntDisc,	FXMlocation = intDLG.m_FXMlocation;
//			int		 srv_I = intDLG.m_srv;

			double kfactor=4.0/3.0;

			CString IDst_I = GetFld(Sel_I,1),			Pol_I = GetFld(Sel_I,13),			ctry_I = GetFld(Sel_I,25),			NoticeType_I = GetFld(Sel_I,35),
					Fragment_I = GetFld(Sel_I,28),		AreaOfTrans_I = GetFld(Sel_I,34),	SiteName_I = GetFld(Sel_I,2),
					RxMode_I = GetFld(Sel_I,54),		RPC_I = GetFld(Sel_I,37),			AdmRefID_I = GetFld(Sel_I,33),
					AntDir_I = GetFld(Sel_I,31),		AntCatID_I = GetFld(Sel_I,30),		Hagl_I = GetFld(Sel_I,5);
			double  GeoLat_I = atof(GetFld(Sel_I,3)),	GeoLon_I = atof(GetFld(Sel_I,4)),	Freq_I = atof(GetFld(Sel_I,6));

			double PWR_I = atof(GetFld(Sel_I,7));	//W
			double PwrERP_I = 10.0*log10(PWR_I) - 2.15;	//dBw
			CString ERP_h_dbw_I;	ERP_h_dbw_I.Format(_T("%lf"), PwrERP_I);
			CString ERP_v_dbw_I;	ERP_v_dbw_I.Format(_T("%lf"), PwrERP_I);

	//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
	//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
	//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			double GRlat_I, GRlon_I;
			if(STflag == 0)
			{
				GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
				lat_I	= GeoLat_I;			lon_I	= GeoLon_I;
			}
			else if(STflag == 1)
			{
				if(AreaOfTrans_I.GetLength()>0)
				{
					Zone2GRpoint(AreaOfTrans_I ,&GRlat_I, &GRlon_I); 
					if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
				}
				else
				{
					GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
					if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
				}
			}

			CP154606_Functions CP154606;
		//	double Sigma_I = CP154606.Table_SigmaN(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, srv_I);
			double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, ENV,sttp_I);

			int nstr_I = 0;
			CString str_I;
//			double pi = 4.0*atan(1.0);

			double GeoLat_Im = GeoLat_I, GeoLon_Im = GeoLon_I;
			if(sttp_I==_T("ML"))
			{
				GeoLat_Im = GRlat_I;	GeoLon_Im = GRlon_I;
			}
			float RLON   = (float)((pi/180.0)*GeoLon_Im), RLAT   = (float)((pi/180.0)*GeoLat_Im);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
			nstr_I = 1;
			str_I.Format(_T("%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%s") ,IDst_I,adm_I,ctry_I,SiteName_I,AdmRefID_I,Freq_I,RLONbs,RLATbs,Pol_I,sttp_I);

			//Victim Records
			CString str_W = _T("");
			int Nstr_W = 0;
			int Nrowy = QGE06_IntToBCBT2DBCBT_Qy(_T(""), 0, _T(""), 0, GRlat_I, GRlon_I, SR, Freq_I, FR); 
			if(Nrowy>0)
			{
				CString Emission_I = GetFld(Sel_I,19),	SysType1_I = GetFld(Sel_I,26),	SysType2_I = GetFld(Sel_I,27);
				SysType1_I.TrimLeft();		SysType1_I.TrimRight();
				SysType2_I.TrimLeft();		SysType2_I.TrimRight();

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_I, GRlon_I , 1500.0);
				for(int i_W=0;i_W<Nrowy;i_W++)
				{
					CString Sel_W = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_W];
					CString IDst_W = GetFld(Sel_W,1),		Fragment_W = GetFld(Sel_W,28),	NoticeType_W = GetFld(Sel_W,35),
							TV_SYS_W = GetFld(Sel_W,36),	RPC_W = GetFld(Sel_W,37),		GeoArea_W = GetFld(Sel_W,53),
							SYS_VAR_W = GetFld(Sel_W,38),	RxMode_W = GetFld(Sel_W,54),	allotkey_W = GetFld(Sel_W,64),	
							Pol_W = GetFld(Sel_W,13),
							AdmRefID_W = GetFld(Sel_W,33),	AssocAllotID_W = GetFld(Sel_W,59),
							PlanEntry_W = GetFld(Sel_W,50),	SfnID_W = GetFld(Sel_W,52),
							SiteName_W = GetFld(Sel_W,2),	ctry_W = GetFld(Sel_W,25),	AssignCode_W = GetFld(Sel_W,51);

		//			if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
		//			else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
		//			CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
					CString adm_W = Cty2AdmGE06(&ctry_W);

					double  Freq_W = atof(GetFld(Sel_W,6)),	GeoLat_W = atof(GetFld(Sel_W,3)),	GeoLon_W = atof(GetFld(Sel_W,4));

					CString STN_W = CP154606.GE06_STN(Fragment_W, NoticeType_W);
					int PEC_W = GE06_PEC(AdmRefID_W , AssocAllotID_W , PlanEntry_W , SfnID_W , STN_W) ;

					double PR = CP154606.GE06_PR_FXM2Dbcbt(Fragment_W,NoticeType_W,Freq_W,TV_SYS_W,RPC_W,SYS_VAR_W,RxMode_W,
															Freq_I,sttp_I,Emission_I,SysType1_I,SysType2_I); 
					if(PR>-999)
					{
						double L, EmedW, Sigma_W;	int AntDisc0;
						CP154606.Default_CArea_0(Fragment_W, NoticeType_W, RxMode_W, RPC_W,Freq_W, TV_SYS_W, SYS_VAR_W, &L,&EmedW,&AntDisc0,&Sigma_W); 

				//		Sigma_W = CP154606.Table_SigmaN_0(Fragment_W, NoticeType_W, RxMode_W, RPC_W, Freq_W, -1);

						double miu_W = CP154606.Qi(100-L);
						double CF = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_I*Sigma_I);

						double PMmin = 9999999, LatMin,LonMin,CNFSmax,PM;
						BOOL falg1 = TRUE;
						if(IDst_W!=_T("---"))
						{
							CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
							long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
							if(nSRV<3)
							{
								CString strOUT;
								strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
								MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
								falg1 = FALSE;
							}
							else
							{
								double lat_TP,	lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<nSRV;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP, lon_TP,CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for

							}//if nSRV

						}//if IDst_W
						else if(IDst_W==_T("---"))
						{
							if(GeoArea_W.IsEmpty())
							{
								CString contourkeyN , nb_test_ptsN;
								long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_W) , &contourkeyN , &nb_test_ptsN);
								long *contourkeyI;		contourkeyI = new long[contourkeyNum];
								long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
								double *GRlatC;			GRlatC = new double[contourkeyNum];
								double *GRlonC;			GRlonC = new double[contourkeyNum];
								long NcontourT = 0;
								for(long i=0;i<contourkeyNum;i++)
								{
									contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
									nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
									NcontourT = NcontourT + nb_test_ptsI[i];
								}
								double * lat_TP;   lat_TP = new double[NcontourT];
								double * lon_TP;   lon_TP = new double[NcontourT];
								double * y;		y = lat_TP;
								double * x;		x = lon_TP;
								for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
								{
									CString lat_tpStr, lon_tpStr;
									long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM] ,nb_test_ptsI[iCNUM] , &lat_tpStr, &lon_tpStr , &GRlatC[iCNUM] , &GRlonC[iCNUM]) ;
									for(long jTP=0;jTP<n_tp;jTP++)
									{
										*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
										*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
									}
								}

								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP[jTP], lon_TP[jTP] ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP[jTP], lon_TP[jTP]) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP[jTP], lon_TP[jTP],CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
									}
								}//for
								delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] GRlatC;	delete [] GRlonC;
								delete [] lat_TP;			delete [] lon_TP;
							}//if GeoArea_W
							else
							{
								CString lat_tpSTR, lon_tpSTR;
								double dum;
								long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR,&dum , &dum) ;
								double lat_TP, lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));	lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP, lon_TP,CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for
							}//else GeoArea_W
						}//if(IDst_W==_T("---"))
						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_W1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							str_W1.Format(_T("%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") , adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,SfnID_W,L,EmedW,CNFSmax,PMmin,LPM);
							str_W = str_W + _T(",") + str_W1;
							Nstr_W++;
						}

					}//if(PR>-999)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_W<Nrowy
				if(Nstr_W>0)
				{
					str_W.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_I;
					dlgList.m_dataY = str_W;
					dlgList.m_rowsX = nstr_I+1;
					dlgList.m_rowsY = 1+Nstr_W;
					dlgList.m_mode = 6;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference FXM to Digital BC-BT");
					dlgList.m_title2 = _Z("Interferer Station :");
					dlgList.m_title3 = _Z("Victim Assignments/Allotments :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//if Nrowy

		}//if intDLG

	}//if Sel_I
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06InttoFxm2Abt() 
{
	CString Sel_I = QGE06_IntTo_Qx(1);
	if(Sel_I.GetLength()>0)
	{
		CString sttp_I = GetFld(Sel_I,18),	StType_I = GetFld(Sel_I,29);
		int STflag = 0;

		if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
			STflag = 0;
		else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
			STflag = 1;

		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 0.5;
		intDLG.m_LPMstr = _Z("Limiting Margin (dB) :");
		intDLG.m_FXMlocationDisp = STflag;
//		intDLG.m_FXMDisp = 1;
		if(intDLG.DoModal() == IDOK)
		{
			double	SR = intDLG.m_SR,			FR = intDLG.m_FR,
					Ti = intDLG.m_Ti,			LPM = intDLG.m_LPM,
					lat_I = intDLG.m_Lat,		lon_I = intDLG.m_Lon;
			int		ENV = intDLG.m_env,			
					AntDisc = intDLG.m_AntDisc,	FXMlocation = intDLG.m_FXMlocation;
			double kfactor=4.0/3.0;
		//	int srv_I = intDLG.m_srv;

			CString IDst_I = GetFld(Sel_I,1),			Pol_I = GetFld(Sel_I,13),			ctry_I = GetFld(Sel_I,25),			NoticeType_I = GetFld(Sel_I,35),
					Fragment_I = GetFld(Sel_I,28),		AreaOfTrans_I = GetFld(Sel_I,34),	SiteName_I = GetFld(Sel_I,2),
					RxMode_I = GetFld(Sel_I,54),		RPC_I = GetFld(Sel_I,37),			AdmRefID_I = GetFld(Sel_I,33),
					AntDir_I = GetFld(Sel_I,31),		AntCatID_I = GetFld(Sel_I,30),		Hagl_I = GetFld(Sel_I,5);
			double  GeoLat_I = atof(GetFld(Sel_I,3)),	GeoLon_I = atof(GetFld(Sel_I,4)),	Freq_I = atof(GetFld(Sel_I,6));

			double PWR_I = atof(GetFld(Sel_I,7));	//W
			double PwrERP_I = 10.0*log10(PWR_I) - 2.15;	//dBw
			CString ERP_h_dbw_I;	ERP_h_dbw_I.Format(_T("%lf"), PwrERP_I);
			CString ERP_v_dbw_I;	ERP_v_dbw_I.Format(_T("%lf"), PwrERP_I);

	//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
	//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
	//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			double GRlat_I, GRlon_I;
			if(STflag == 0)
			{
				GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
				lat_I	= GeoLat_I;			lon_I	= GeoLon_I;
			}
			else if(STflag == 1)
			{
				if(AreaOfTrans_I.GetLength()>0)
				{
					Zone2GRpoint(AreaOfTrans_I ,&GRlat_I, &GRlon_I); 
					if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
				}
				else
				{
					GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
					if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
				}
			}

			int nstr_I = 0;
			CString str_I;
//			double pi = 4.0*atan(1.0);

			double GeoLat_Im = GeoLat_I, GeoLon_Im = GeoLon_I;
			if(sttp_I==_T("ML"))
			{
				GeoLat_Im = GRlat_I;	GeoLon_Im = GRlon_I;
			}
			float RLON   = (float)((pi/180.0)*GeoLon_Im), RLAT   = (float)((pi/180.0)*GeoLat_Im);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
			nstr_I = 1;
			str_I.Format(_T("%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%s") ,IDst_I,adm_I,ctry_I,SiteName_I,AdmRefID_I,Freq_I,RLONbs,RLATbs,Pol_I,sttp_I);

			double L = 50, CF = 0;	

			//Victim Records
			CString str_W = _T("");
			int Nstr_W = 0;
			int Nrowy = QGE06_IntToBCBT2ABCBT_Qy(IDst_I, GRlat_I, GRlon_I, SR, Freq_I, FR); 
			if(Nrowy>0)
			{
				CP154606_Functions CP154606;

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_I, GRlon_I , 1500.0);
				for(int i_W=0;i_W<Nrowy;i_W++)
				{

					CString Sel_W = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_W];
					CString IDst_W = GetFld(Sel_W,1),			Fragment_W = GetFld(Sel_W,28),
							NoticeType_W = GetFld(Sel_W,35),	TV_SYS_W = GetFld(Sel_W,36),
							RxMode_W = GetFld(Sel_W,54),		Pol_W = GetFld(Sel_W,13),
							AdmRefID_W = GetFld(Sel_W,33),		SiteName_W = GetFld(Sel_W,2),
							ctry_W = GetFld(Sel_W,25),			TV_COLOR_W = GetFld(Sel_W,40);

//					TV_COLOR_W.TrimLeft();	TV_COLOR_W.TrimRight();
//					TV_SYS_W.TrimLeft();	TV_SYS_W.TrimRight();

		//			if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
		//			else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
		//			CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
					CString adm_W = Cty2AdmGE06(&ctry_W);

					double  Freq_W = atof(GetFld(Sel_W,6)),		GeoLat_W = atof(GetFld(Sel_W,3)),
							GeoLon_W = atof(GetFld(Sel_W,4)),	freq_vcarr_W = atof(GetFld(Sel_W,39));

					double PRC = -999 , PRT = -999;	// NA
					CP154606.FXM2ATV_PR(Freq_I, freq_vcarr_W, TV_COLOR_W, TV_SYS_W,&PRC,&PRT);
					if((PRC>-999)&&(PRT>-999))
					{
				//		double EmedW = CP154606.Table_1_Rec417(Freq_W, TV_SYS_W) ;

						double PMmax = -99999, LatMin,LonMin,CNFSmax,PM, EmWmax, UFSmax;
						BOOL falg1 = TRUE;
						
						CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
						long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
						if(nSRV<3)
						{
							CString strOUT;
							strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
							MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
							falg1 = FALSE;
						}
						else
						{
							double lat_TP,	lon_TP,	UFS_TP, EmW_TP;
							PMmax = -99999;
							for(long jTP=0;jTP<nSRV;jTP++)
							{
								lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));
								UFS_TP =  atof(GetFld(UFS_tpSTR , jTP+1));		EmW_TP =  atof(GetFld(Em_tpSTR , jTP+1));

								if((FXMlocation==0)&&(STflag == 1))
								{
									if(AreaOfTrans_I.GetLength()>0)
										Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
									else
									{
										double radius_I = atof(GetFld(Sel_I,22));
										double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
										reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
									}
								}

								double CNFS = CNFS_Function_IntA(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W,
																 NoticeType_W, RxMode_W, _T(""),
																 lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																 AntDir_I, AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I,
																 lat_TP, lon_TP, CF, PRC, PRT,
																 AntDisc, ENV, Ti, kfactor, 3); 

								PM = 10.0*log10(pow(10.0, UFS_TP/10.0) + pow(10.0, CNFS/10.0)) - UFS_TP;
								PMmax = max(PMmax , PM);
								if(PMmax==PM)
								{
									LatMin = lat_TP;	LonMin = lon_TP;  CNFSmax = CNFS;
									EmWmax = EmW_TP;	UFSmax = UFS_TP;
								}
							}//for

						}//if nSRV

						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_W1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

							str_W1.Format(_T("%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%0.1lf,%0.3lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") ,	adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,Freq_W,RLONbs,RLATbs,Pol_W,L,EmWmax,UFSmax,CNFSmax,PMmax,LPM);
							str_W = str_W + _T(",") + str_W1;
							Nstr_W++;
						}

					}//if((PRC>-999)&&(PRT>-999))
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_W<Nrowy
				if(Nstr_W>0)
				{
					str_W.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_I;
					dlgList.m_dataY = str_W;
					dlgList.m_rowsX = nstr_I+1;
					dlgList.m_rowsY = 1+Nstr_W;
					dlgList.m_mode = 7;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference FXM to Analogue BT");
					dlgList.m_title2 = _Z("Interferer Station :");
					dlgList.m_title3 = _Z("Victim Analogue Assignments :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//Nrowy

		}//intDLG
	
	}//Sel_I
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06InttoBcbt2fxm() 
{
	CString Sel_I = QGE06_IntTo_Qx();
	if(Sel_I.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 6;
		intDLG.m_Ti = 10;
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;

			CString IDst_I = GetFld(Sel_I,1),				Fragment_I = GetFld(Sel_I,28),	
					NoticeType_I = GetFld(Sel_I,35),		AdmRefID_I = GetFld(Sel_I,33),
					AssocAllotID_I = GetFld(Sel_I,59),		PlanEntry_I = GetFld(Sel_I,50),
					SfnID_I = GetFld(Sel_I,52),				allotkey_I = GetFld(Sel_I,64),
					RxMode_I = GetFld(Sel_I,54),			RPC_I = GetFld(Sel_I,37),
					TV_SYS_I = GetFld(Sel_I,36),			SYS_VAR_I = GetFld(Sel_I,38),
					TV_COLOR_I = GetFld(Sel_I,40);
			CString Pol_I = GetFld(Sel_I,13),				Hagl_I = GetFld(Sel_I,5),
					AntDir_I = GetFld(Sel_I,31),			AntCatID_I = GetFld(Sel_I,30),
					ERP_h_dbw_I = GetFld(Sel_I,62),			ERP_v_dbw_I = GetFld(Sel_I,63),
					GeoArea_I = GetFld(Sel_I,53),
					RN_I = GetFld(Sel_I,61),				SiteName_I = GetFld(Sel_I,2),
					ctry_I = GetFld(Sel_I,25),				AssignCode_I = GetFld(Sel_I,51);
			CString oset_v_khz_I = GetFld(Sel_I,43),		TV_ch_I = GetFld(Sel_I,44),
					oset_v_12_I = GetFld(Sel_I,42);
			double  Freq_I = atof(GetFld(Sel_I,6)),			GeoLat_I = atof(GetFld(Sel_I,3)),
					freq_vcarr_I = atof(GetFld(Sel_I,39)),	GeoLon_I = atof(GetFld(Sel_I,4));
			double  freq_scarr_I = atof(GetFld(Sel_I,41)),	pwr_ratio_I = atof(GetFld(Sel_I,46));

			CString SpecMask_I = GetFld(Sel_I,47);

	//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
	//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
	//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
			CString adm_I = Cty2AdmGE06(&ctry_I);

			CP154606_Functions CP154606;
			CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
			int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
			CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);

			int nstr_I = 0;
			CString str_I;
//			double pi = 4.0*atan(1.0);

			double GRlat_I , GRlon_I , frq_MHz_I;
			CString IDst_IT = _T(""), allotkey_IT = _T("");
			int nIDst_IT = 0, nallotkey_IT = 0;

			if((NET_I==_T("ASS1"))||(NET_I==_T("AST1"))||(NET_I==_T("ASA0")))	/////////A1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;			frq_MHz_I = Freq_I;
				IDst_IT = IDst_IT + _T(",") + IDst_I;		nIDst_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A1
			else if((NET_I==_T("ASS2"))||(NET_I==_T("AST2")))	/////////A2
			{
				CString IDstN;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &GRlat_I, &GRlon_I,&str_I);
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;		nIDst_IT = nIDst_IT + nASS;

				nstr_I = nASS;

			}	/////////A2
			else if((NET_I==_T("ALS3"))||(NET_I==_T("ALT3")))	/////////A3
			{
				CString GeoArea_I = GetFld(Sel_I,53);
				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_I = 1;
				str_I.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);

			}	/////////A3
			else if((NET_I==_T("ASS4"))||(NET_I==_T("AST4")))	/////////A4_1
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I,SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString str_IL = QGE06_IntTo_Q3(SfnID_I);
				CString allotkey_IL = GetFld(str_IL,1);
				CString GeoArea_IL = GetFld(str_IL,2);
				if(GeoArea_IL.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_IL, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_IL, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;					nIDst_IT = nIDst_IT + nASS;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_1
			else if((NET_I==_T("ALS4"))||(NET_I==_T("ALT4")))	/////////A4_2
			{
				CString str_I1, str_I2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_I, SfnID_I,&IDstN, &dum, &dum,&str_I1, 1);
				CString GeoArea_I = GetFld(Sel_I,53);

				if(GeoArea_I.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_I, &GRlat_I, &GRlon_I);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_I, &lat_tpSTR, &lon_tpSTR, &GRlat_I, &GRlon_I) ;
				}
				frq_MHz_I = Freq_I;

				IDst_IT = IDst_IT + _T(",") + IDstN;					nIDst_IT = nIDst_IT + nASS;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;

				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = nASS+1;

			}	/////////A4_2
			else if((NET_I==_T("ASS5"))||(NET_I==_T("AST5")))	/////////A5_1
			{
				GRlat_I = GeoLat_I;		GRlon_I = GeoLon_I;		frq_MHz_I = Freq_I;

		//		CString str_IL = QGE06_IntTo_Q3(SfnID_I);
		//		CString allotkey_IL = GetFld(str_IL,1),		GeoArea_IL = GetFld(str_IL,2);
				CString allotkey_IL = QGE06_CArea_Q3(AssocAllotID_I) ;

				IDst_IT = IDst_IT + _T(",") + IDst_I;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_IL;		nallotkey_IT++;

				float RLON   = (float)((pi/180.0)*GeoLon_I), RLAT   = (float)((pi/180.0)*GeoLat_I);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				CString str_I1, str_I2;
				str_I1.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,PEC_I,AssignCode_I,Freq_I,RLONbs,RLATbs,Pol_I,AssocAllotID_I,SfnID_I);
				QGE06_IntTo_Q7(allotkey_IL, _T("L"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_1
			else if((NET_I==_T("ALS5"))||(NET_I==_T("ALT5")))	/////////A5_2
			{
				CString AdmRefID_I = GetFld(Sel_I,33);
				CString IDst_IL,GeoLat0,GeoLon0,Frequency0, str_I1, str_I2;
				int c = QGE06_IntTo_Q4(AdmRefID_I,&IDst_IL, &GeoLat0, &GeoLon0, &Frequency0, &str_I1);

				GRlat_I = atof(GeoLat0);	GRlon_I = atof(GeoLon0);		frq_MHz_I = atof(Frequency0);

				IDst_IT = IDst_IT + _T(",") + IDst_IL;					nIDst_IT++;
				allotkey_IT = allotkey_IT + _T(",") + allotkey_I;		nallotkey_IT++;

				QGE06_IntTo_Q7(allotkey_I, _T("W"), &str_I2) ;
				str_I = str_I1 + _T(",") + str_I2;
				nstr_I = 1+1;

			}	/////////A5_2
			IDst_IT.Delete(0);
			allotkey_IT.Delete(0);

			double fminI = frq_MHz_I - FR;
			double fmaxI = frq_MHz_I + FR;
			double L = 50 , CF = 0;
			double BW_I = CP154606.AP3_BandW_BS(STN_I, TV_SYS_I, RPC_I,SYS_VAR_I, Freq_I); 

			//Victim Records
			CString str_W = _T("");
			int Nstr_W = 0;
			int Nrowy = QGE06_IntToBCBT2FXM_Qy(GRlat_I, GRlon_I, SR, frq_MHz_I, FR); 
			if(Nrowy>0)
			{
				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_I, GRlon_I , 1500.0);
				for(int i_W=0;i_W<Nrowy;i_W++)
				{
					CString Sel_W = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_W];
					CString IDst_W = GetFld(Sel_W,1),			sttp_W = GetFld(Sel_W,18),
							StType_W = GetFld(Sel_W,29),		SysType1_W = GetFld(Sel_W,26),
							SysType2_W = GetFld(Sel_W,27),		Emission_W = GetFld(Sel_W,19),
							Fragment_W = GetFld(Sel_W,28),		NoticeType_W = GetFld(Sel_W,35),
							Pol_W = GetFld(Sel_W,13),			ctry_W = GetFld(Sel_W,25),
							SiteName_W = GetFld(Sel_W,2),		AdmRefID_W = GetFld(Sel_W,33),
							AntDir_W = GetFld(Sel_W,31),		AntCatID_W = GetFld(Sel_W,30);

					double  TxFreq_W = atof(GetFld(Sel_W,6)),	RxFreq_W = atof(GetFld(Sel_W,21)),
							GeoLat_W = atof(GetFld(Sel_W,3)),	GeoLon_W = atof(GetFld(Sel_W,4));

					int ant = atol(GetFld(Sel_W,65));
					CString GeoType_W = GetFld(Sel_W,66);
					CString sttp1_W = GetFld(Sel_W,67);
					double Freq_W = atof(GetFld(Sel_W,68));

		//			if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
		//			else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
		//			CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
					CString adm_W = Cty2AdmGE06(&ctry_W);

					SysType1_W.TrimLeft();		SysType1_W.TrimRight();
					SysType2_W.TrimLeft();		SysType2_W.TrimRight();

					CString inputfxmrec_W, FXM, zone = _T("");
					int nSRV = 0, flag_W = 0;
					double latci,lonci,Rci;

					if(GeoType_W==_T("POINT"))
					{
						inputfxmrec_W = GeoType_W;	FXM = sttp1_W;
						nSRV = 1;					flag_W = 1;
					}
					else if(GeoType_W==_T("MULTIPOINT"))
					{
						inputfxmrec_W = _T("AREA");	FXM = sttp1_W;
						nSRV = 6;					flag_W = 2;
					}
					else if(GeoType_W==_T("ZONE"))
					{
						inputfxmrec_W = _T("AREA");	FXM = _T("ML");
						zone = GetFld(Sel_W,69);
						nSRV = Ctry2Point(zone);	flag_W = 4;
					}
					else if(GeoType_W==_T("CIRCLE"))
					{
						inputfxmrec_W = _T("AREA");	FXM = _T("ML");
						latci = atof(GetFld(Sel_W,70));		lonci = atof(GetFld(Sel_W,71));
						Rci = atof(GetFld(Sel_W,72));
						nSRV = 36;					flag_W = 5;
					}
					if(sttp_W==_T("ML"))	inputfxmrec_W = _T("NA");
/*
					if((sttp_W==_T("FX"))&&(RxFreq_W>=fminI)&&(RxFreq_W<=fmaxI))
					{
						Freq_W = RxFreq_W;	inputfxmrec_W = _T("POINT");	ant = 1;	FXM = sttp_W;
						nSRV = 1;			flag_W = 1;
					}
					else if((sttp_W==_T("FX"))&&(TxFreq_W>=fminI)&&(TxFreq_W<=fmaxI))
					{
						Freq_W = TxFreq_W;	inputfxmrec_W = _T("AREA");		ant = 0;	FXM = sttp_W;
						nSRV = 6;			flag_W = 2;
					}
					else if((sttp_W==_T("FB"))&&(RxFreq_W>=fminI)&&(RxFreq_W<=fmaxI))
					{
						Freq_W = RxFreq_W;	inputfxmrec_W = _T("POINT");	ant = 1;	FXM = sttp_W;
						nSRV = 1;			flag_W = 3;
					}
					else if((sttp_W==_T("FB"))&&(TxFreq_W>=fminI)&&(TxFreq_W<=fmaxI))
					{
						Freq_W = TxFreq_W;	inputfxmrec_W = _T("AREA");		ant = 0;	FXM = _T("ML");
						zone = QGE06_IntToBCBT2FXM_Q2(atol(IDst_W));
						if(zone.GetLength()>0)
						{
							nSRV = Ctry2Point(zone); 		flag_W = 4;
						}
						else
						{
							QGE06_IntToBCBT2FXM_Q4(atol(IDst_W) , &latci,&lonci,&Rci) ;
							nSRV = 36; 	flag_W = 5;
						}
					}
					else if(sttp_W==_T("ML"))
					{
						Freq_W = RxFreq_W;	inputfxmrec_W = _T("NA");		ant = 0;	FXM = sttp_W;
						zone = GetFld(Sel_W,34);
						if(zone.GetLength()>0)
						{
							nSRV = Ctry2Point(zone); 		flag_W = 6;
						}
						else
						{
							Rci = atof(GetFld(Sel_W,22));
							latci = GeoLat_W;	lonci = GeoLon_W;
							if(Rci>0)
							{
								nSRV = 36; 					flag_W = 7;
							}
						}
					}
*/

					double *lat_TP;		lat_TP = new double[nSRV];
					double *lon_TP;		lon_TP = new double[nSRV];
					if((flag_W==1)||(flag_W==3))
					{
						lat_TP[0] = GeoLat_W;	lon_TP[0] = GeoLon_W;
					}
					else if(flag_W==2)
					{
						nSRV = QGE06_IntToBCBT2FXM_Q1(atol(IDst_W) ,lat_TP, lon_TP); 
					}
					else if((flag_W==4)||(flag_W==6))
					{
						QGE06_IntToBCBT2FXM_Q3(zone,lat_TP,lon_TP,nSRV); 
					}
					else if((flag_W==5)||(flag_W==7))
					{
						for(long i=0;i<36;i++)	reckon(latci,lonci, Rci , i*10 , &lat_TP[i] , &lon_TP[i]) ;
					}

			//		if(((sttp_W==_T("FX"))||(sttp_W==_T("FB")))&&(((RxFreq_W>=174)&&(RxFreq_W<=230))||((RxFreq_W>=470)&&(RxFreq_W<=862)))&&(inputfxmrec_W==_T("POINT")))
			//			Freq_W = RxFreq_W;
			//		else if(((sttp_W==_T("FX"))||(sttp_W==_T("FB")))&&(((TxFreq_W>=174)&&(TxFreq_W<=230))||((TxFreq_W>=470)&&(TxFreq_W<=862)))&&(inputfxmrec_W==_T("AREA")))
			//			Freq_W = TxFreq_W;
			//		else if(((sttp_W==_T("ML")))&&(((RxFreq_W>=174)&&(RxFreq_W<=230))||((RxFreq_W>=470)&&(RxFreq_W<=862))))
			//			Freq_W = RxFreq_W;

					int GENERIC;
					double hR, CNFS , EminW, PR = -999;

					if( ((NoticeType_I==_T("DT1"))||(NoticeType_I==_T("GT1"))||(NoticeType_I==_T("DT2"))||(NoticeType_I==_T("GT2")) ||(Fragment_I==_T("GE06A")) )&&
						(((SysType1_W.GetLength()==0)&&(SysType2_W.GetLength()==0)) || 
						(SysType1_W==_T("FK"))||(SysType1_W==_T("NV"))||(SysType1_W==_T("NB"))||(SysType2_W==_T("FK"))||(SysType2_W==_T("NV"))||(SysType2_W==_T("NB")))  )
					{
						GENERIC = 1;	PR = 0;		hR = 10;

						double BW_W = CP154606.Emission2NBW(Emission_W)/1000.0;
						EminW = CP154606.Table_AP4_2_45(FXM, Freq_I, Freq_W, BW_I,BW_W, SpecMask_I,
												Fragment_I,NoticeType_I,TV_COLOR_I,TV_SYS_I,freq_vcarr_I,freq_scarr_I); 
					}
					else
					{
						GENERIC = 0;
						PR = CP154606.GE06_PR_BCBT2FXM(Freq_W, sttp_W, Emission_W, SysType1_W, SysType2_W,
													 Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I,
													 SYS_VAR_I, freq_vcarr_I, TV_COLOR_I, freq_scarr_I,	 SpecMask_I);
						
						
						if     (SysType1_W.GetLength()==0)	EminW = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType2_W,Freq_W,&hR); 
						else if(SysType2_W.GetLength()==0)	EminW = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType1_W,Freq_W,&hR); 
						else
						{
							double hR1,hR2,Emin1,Emin2;
							Emin1 = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType1_W,Freq_W,&hR1); 
							Emin2 = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType2_W,Freq_W,&hR2); 
							EminW = min(Emin1,Emin2);
							if(EminW==Emin1)	hR = hR1;
							else				hR = hR2;
						}
					}
					if(PR>-999)
					{
						double PMmin = 999999;
						double LatMin, LonMin, CNFSmax;
						for(long jTP=0;jTP<nSRV;jTP++)
						{
							CNFS = GE06UFS_FXM( GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
												 GeoLat_I, GeoLon_I, Freq_I,Pol_I,Hagl_I,
												 AntDir_I,AntCatID_I,ERP_h_dbw_I, ERP_v_dbw_I,
												 lat_TP[jTP],lon_TP[jTP], CF,PR,
												 AntDisc,ENV, Ti, kfactor, ant, hR,
												 NET_I, PEC_I, SfnID_I, GeoArea_I,  allotkey_I,
												 RN_I,RPC_I,AdmRefID_I,AntDir_W, AntCatID_W,
											 	 sttp_W,Emission_W,SysType1_W,SysType2_W,Fragment_I,GENERIC);

							double PM = EminW - CNFS;
							PMmin = min(PMmin,PM);
							if(PMmin==PM)
							{
								LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
							}

						}//for jTP
						if(flag_W>0)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_W1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							if(GENERIC==1)		str_W1.Format(_T("%s,%s,%s,%s,%0.4lf,%s  %s,%s,%s,%s,%0.1lf,%0.3lf,%0.3lf,%0.6lf,%d") , adm_W,ctry_W,SiteName_W,AdmRefID_W,Freq_W,RLONbs,RLATbs,Pol_W,SysType1_W,SysType2_W,L,EminW,CNFSmax,PMmin,0);
							else				str_W1.Format(_T("%s,%s,%s,%s,%0.4lf,%s  %s,%s,%s,%s,%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") , adm_W,ctry_W,SiteName_W,AdmRefID_W,Freq_W,RLONbs,RLATbs,Pol_W,SysType1_W,SysType2_W,L,EminW,CNFSmax,PMmin,LPM);
							
							str_W = str_W + _T(",") + str_W1;
							Nstr_W++;
						}
					
					}//if(PR>-999)
					delete [] lat_TP;	delete [] lon_TP;
		
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_W<Nrowy
				if(Nstr_W>0)
				{
					str_W.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_I;
					dlgList.m_dataY = str_W;
					dlgList.m_rowsX = nstr_I+1;
					dlgList.m_rowsY = 1+Nstr_W;
					dlgList.m_mode = 8;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference BC-BT to FXM");
					dlgList.m_title2 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title3 = _Z("Victim FXM Stations :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//if Nrowy

		}//if intDLG

	}//if(Sel_I
	Set_STtable_Default();
	EndWaitCursor();
}

CString CSMS4DCView::QGE06_Showsrvbcbt() 
{
	CString CDataBaseSTR, Selx = _T("");
//	CDataBaseSTR = _T("SELECT DISTINCT CommonFields.IDst, CommonFields.TerraKey, CommonFields.AdmRefID, CommonFields.SiteName, CommonFields.GeoLat, CommonFields.GeoLon, CommonFields.Country, CommonFields.Fragment, CommonFields.Plan, CommonFields.PlanEntry, CommonFields.AssignCode, CommonFields.SfnID, CommonFields.NoticeType, CommonFields.GeoArea, CommonFields.RefPlanCfg, CommonFields.SysVar, CommonFields.RXMode, CommonFields.ERPTilt, CommonFields.Tilt, CommonFields.AntHeightAGL, CommonFields.Pol, CommonFields.Frequency, CommonFields.TVChan, CommonFields.SpectMask, CommonFields.Offset, CommonFields.ClassStation, CommonFields.StID, CommonFields.AssocAllotID, CommonFields.nb_sub_areas, CommonFields.TypRefNetwk, CommonFields.ERP_h_dbw, CommonFields.ERP_v_dbw, CommonFields.AntCatID, CommonFields.AntID, CommonFields.AntDir, CommonFields.MaxEffHght, CommonFields.allotkey, CommonFields.TVSys FROM CommonFields, CSArea WHERE (((CSArea.IDst)=Val([CommonFields].[IDst])));");
	CDataBaseSTR.Format( _T("SELECT DISTINCT CommonFields.IDst, CommonFields.TerraKey, CommonFields.AdmRefID, CommonFields.SiteName, CommonFields.GeoLat, CommonFields.GeoLon, CommonFields.Country, CommonFields.Fragment, CommonFields.Plan, CommonFields.PlanEntry, CommonFields.AssignCode, CommonFields.SfnID, CommonFields.NoticeType, CommonFields.GeoArea, CommonFields.RefPlanCfg, CommonFields.SysVar, CommonFields.RXMode, CommonFields.ERPTilt, CommonFields.Tilt, CommonFields.AntHeightAGL, CommonFields.Pol, CommonFields.Frequency, CommonFields.TVChan, CommonFields.SpectMask, CommonFields.Offset, CommonFields.ClassStation, CommonFields.StID, CommonFields.AssocAllotID, CommonFields.nb_sub_areas, CommonFields.TypRefNetwk, CommonFields.ERP_h_dbw, CommonFields.ERP_v_dbw, CommonFields.AntCatID, CommonFields.AntID, CommonFields.AntDir, CommonFields.MaxEffHght, CommonFields.allotkey, CommonFields.TVSys FROM %s, CSArea WHERE (((CSArea.IDst)=Val([CommonFields].[IDst])));") , m_qCommonFields );

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _T("Select One Station");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
		{
			Selx = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			CString IDst = GetFld(Selx,1),	lat = GetFld(Selx,5),	lon = GetFld(Selx,6),	name = GetFld(Selx,4);
			CString str;
			str = IDst + _T(",") + lat + _T(",") + lon + _T(",") + name;
			return str;
		}
		else
		{
			MessageBox(_Z("Please Select One Record."),_Z("ERROR!!!"),MB_ICONERROR);
			Set_STtable_Default();
			EndWaitCursor();
		}
	}
	return _T("");
}

void CSMS4DCView::OnDatabaseShowsrvbcbt() 
{
	CString str = QGE06_Showsrvbcbt();
	if(str.GetLength()>0)
	{
		long IDst = atol(GetFld(str,1));
		double lats = atof(GetFld(str,2)),	lons = atof(GetFld(str,3));
		CString name = GetFld(str,4);

		CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
		CDatabase DB1;	CRecordset rs;
		DB1.Open(m_DB,false,false,_T("ODBC;"),false);
		rs.m_pDatabase = &DB1;
		tbl.Format(_T("SELECT IDst, SiteName, GeoLat, GeoLon FROM CSArea WHERE (((IDst)=%ld));"), IDst);

		double lat,lon;
		rs.Open(CRecordset::snapshot, tbl);
		if(rs.GetRecordCount() == 1)
		{
			rs.MoveFirst();
			m_POLYnum++;

			CString sFile;
			sFile.Format(_T("%s%s%d.tmp") , ((CSMS4DCApp *)AfxGetApp())->m_AppPath , _T("Temp\\tempM") , m_POLYnum);
			FILE *fptemp=fopen(sFile,"wt");
			while(!rs.IsEOF())
			{
				rs.GetFieldValue(_T("GeoLat"),str);		lat = atof(str);
				rs.GetFieldValue(_T("GeoLon"),str);		lon = atof(str);
				fprintf(fptemp,"%0.14lf  %0.14lf\n",lon, lat);
				rs.MoveNext();
			}
			fclose(fptemp);
			OnDrawVector(sFile,2);
			OnDatabaseStationsindesktop2(lats,lons);
			AddStation_disp(IDst,lats,lons,name) ;
			InvalidateRect(NULL,false);
		}
		rs.Close();	DB1.Close();
	}
	Set_STtable_Default();
}

void CSMS4DCView::OnCoordinationGe06IntfromBcbt2dbcbt() 
{
	CString Sel_W = QGE06_IntFrom_Qx();
	if(Sel_W.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;

			CString IDst_W = GetFld(Sel_W,1),				Fragment_W = GetFld(Sel_W,28),	
					NoticeType_W = GetFld(Sel_W,35),		AdmRefID_W = GetFld(Sel_W,33),
					AssocAllotID_W = GetFld(Sel_W,59),		PlanEntry_W = GetFld(Sel_W,50),
					SfnID_W = GetFld(Sel_W,52),				allotkey_W = GetFld(Sel_W,64),
					RxMode_W = GetFld(Sel_W,54),			RPC_W = GetFld(Sel_W,37),
					TV_SYS_W = GetFld(Sel_W,36),			SYS_VAR_W = GetFld(Sel_W,38),
					Pol_W = GetFld(Sel_W,13),				GeoArea_W = GetFld(Sel_W,53),
					SiteName_W = GetFld(Sel_W,2),			ctry_W = GetFld(Sel_W,25),
					AssignCode_W = GetFld(Sel_W,51);
		
			double  Freq_W = atof(GetFld(Sel_W,6)),			GeoLat_W = atof(GetFld(Sel_W,3)),
					GeoLon_W = atof(GetFld(Sel_W,4));

	//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
	//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
	//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
			CString adm_W = Cty2AdmGE06(&ctry_W);

			CP154606_Functions CP154606;
			CString STN_W = CP154606.GE06_STN(Fragment_W, NoticeType_W);
			int PEC_W = GE06_PEC(AdmRefID_W , AssocAllotID_W , PlanEntry_W , SfnID_W , STN_W) ;
			CString NET_W;	NET_W.Format("%s%d",STN_W,PEC_W);

			int nstr_W = 0;
			CString str_W;
//			double pi = 4.0*atan(1.0);

			double GRlat_W , GRlon_W , frq_MHz_W;
			CString IDst_WT = _T(""), allotkey_WT = _T("");
			int nIDst_WT = 0, nallotkey_WT = 0;

			if((NET_W==_T("ASS1"))||(NET_W==_T("AST1"))||(NET_W==_T("ASA0")))	/////////A1
			{
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;			frq_MHz_W = Freq_W;
				IDst_WT = IDst_WT + _T(",") + IDst_W;		nIDst_WT++;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A1
			else if((NET_W==_T("ASS2"))||(NET_W==_T("AST2")))	/////////A2
			{
				CString IDstN;
				long nASS = QGE06_IntTo_Q1(IDst_W,SfnID_W,&IDstN, &GRlat_W, &GRlon_W,&str_W);
				frq_MHz_W = Freq_W;

				IDst_WT = IDst_WT + _T(",") + IDstN;		nIDst_WT = nIDst_WT + nASS;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A2
			else if((NET_W==_T("ALS3"))||(NET_W==_T("ALT3")))	/////////A3
			{
				CString GeoArea_W = GetFld(Sel_W,53);
				if(GeoArea_W.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_W, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_W;		nallotkey_WT++;

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A3
			else if((NET_W==_T("ASS4"))||(NET_W==_T("AST4")))	/////////A4_1
			{
				CString str_W1;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_W,SfnID_W,&IDstN, &dum, &dum,&str_W1, 1);
				CString str_WL = QGE06_IntTo_Q3(SfnID_W);
				CString allotkey_WL = GetFld(str_WL,1);
				CString GeoArea_WL = GetFld(str_WL,2);
				if(GeoArea_WL.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_WL, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_WL, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;

				IDst_WT = IDst_WT + _T(",") + IDstN;					nIDst_WT = nIDst_WT + nASS;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_WL;		nallotkey_WT++;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A4_1
			else if((NET_W==_T("ALS4"))||(NET_W==_T("ALT4")))	/////////A4_2
			{
				CString str_W1, str_W2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_W, SfnID_W,&IDstN, &dum, &dum,&str_W1, 1);
				CString GeoArea_W = GetFld(Sel_W,53);

				if(GeoArea_W.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_W, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;

				IDst_WT = IDst_WT + _T(",") + IDstN;					nIDst_WT = nIDst_WT + nASS;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_W;		nallotkey_WT++;

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A4_2
			else if((NET_W==_T("ASS5"))||(NET_W==_T("AST5")))	/////////A5_1
			{
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;		frq_MHz_W = Freq_W;

		//		CString str_WL = QGE06_IntTo_Q3(SfnID_W);
		//		CString allotkey_WL = GetFld(str_WL,1),		GeoArea_WL = GetFld(str_WL,2);
				CString allotkey_WL = QGE06_CArea_Q3(AssocAllotID_W) ;

				IDst_WT = IDst_WT + _T(",") + IDst_W;					nIDst_WT++;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_WL;		nallotkey_WT++;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A5_1
			else if((NET_W==_T("ALS5"))||(NET_W==_T("ALT5")))	/////////A5_2
			{
				CString AdmRefID_W = GetFld(Sel_W,33);
				CString IDst_WL,GeoLat0,GeoLon0,Frequency0, str_W1, str_W2;
				int c = QGE06_IntTo_Q4(AdmRefID_W,&IDst_WL, &GeoLat0, &GeoLon0, &Frequency0, &str_W1);

				GRlat_W = atof(GeoLat0);	GRlon_W = atof(GeoLon0);		frq_MHz_W = atof(Frequency0);

				IDst_WT = IDst_WT + _T(",") + IDst_WL;					nIDst_WT++;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_W;		nallotkey_WT++;

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A5_2
			else if((NET_W==_T("ASS3"))||(NET_W==_T("AST3")))	/////////A3_C
			{
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;		frq_MHz_W = Freq_W;
				CString IDstN , allotkey_WL;
				long nASS = QGE06_IntFrom_C(SfnID_W,&IDstN,&allotkey_WL) ;;

				IDst_WT = IDst_WT + _T(",") + IDstN;					nIDst_WT = nIDst_WT + nASS;
				allotkey_WT = allotkey_WT + _T(",") + allotkey_WL;		nallotkey_WT++;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A3_C

			IDst_WT.Delete(0);
			allotkey_WT.Delete(0);

			double L, EmedW, Sigma_W;	int AntDisc0;
			CP154606.Default_CArea_0(Fragment_W, NoticeType_W, RxMode_W, RPC_W,Freq_W, TV_SYS_W, SYS_VAR_W, &L,&EmedW,&AntDisc0,&Sigma_W); 
			double miu_W = CP154606.Qi(100-L);

			//Interferer Records
			CString str_I = _T("");
			int Nstr_I = 0;
			int Nrowy = QGE06_IntFromBCBT2DBCBT_Qy(IDst_WT, nIDst_WT, allotkey_WT, nallotkey_WT, GRlat_W, GRlon_W, SR, frq_MHz_W, FR); 
			if(Nrowy>0)
			{
				CString strAS_I = _T("") , strAL_I = _T("");
				int NstrAS_I = 0, NstrAL_I = 0;

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_W, GRlon_W , 1500.0);
				for(int i_I=0;i_I<Nrowy;i_I++)
				{
					CString Sel_I = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_I];
					CString IDst_I = GetFld(Sel_I,1),		Fragment_I = GetFld(Sel_I,28),	NoticeType_I = GetFld(Sel_I,35),
							TV_SYS_I = GetFld(Sel_I,36),	RPC_I = GetFld(Sel_I,37),		GeoArea_I = GetFld(Sel_I,53),
							SYS_VAR_I = GetFld(Sel_I,38),	RxMode_I = GetFld(Sel_I,54),	allotkey_I = GetFld(Sel_I,64),	
							Pol_I = GetFld(Sel_I,13),		AdmRefID_I = GetFld(Sel_I,33),	AssocAllotID_I = GetFld(Sel_I,59),
							TV_COLOR_I = GetFld(Sel_I,40),	PlanEntry_I = GetFld(Sel_I,50),	SfnID_I = GetFld(Sel_I,52),
							SiteName_I = GetFld(Sel_I,2),	ctry_I = GetFld(Sel_I,25),		AssignCode_I = GetFld(Sel_I,51),
							Hagl_I = GetFld(Sel_I,5),		AntDir_I = GetFld(Sel_I,31),	AntCatID_I = GetFld(Sel_I,30),
							RN_I = GetFld(Sel_I,61),		ERP_h_dbw_I = GetFld(Sel_I,62),	ERP_v_dbw_I = GetFld(Sel_I,63);

					int IDflag = 1;
					if(IDst_I==_T("---"))	IDflag =  IDstCompare(allotkey_I, strAL_I,NstrAL_I);
					else					IDflag =  IDstCompare(IDst_I, strAS_I,NstrAS_I);
					if(IDflag == 0)
					{
				//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
				//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
				//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
						CString adm_I = Cty2AdmGE06(&ctry_I);

						double  Freq_I = atof(GetFld(Sel_I,6)),	GeoLat_I = atof(GetFld(Sel_I,3)),	GeoLon_I = atof(GetFld(Sel_I,4)),
								freq_vcarr_I = atof(GetFld(Sel_I,39));

						CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
						int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
						CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);

						double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, -1);
						double CF = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_I*Sigma_I);
						double PR = CP154606.GE06_PR_bcbt2Dbcbt(Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W,SYS_VAR_W, RxMode_W,
												Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I,SYS_VAR_I, freq_vcarr_I, TV_COLOR_I); 
						if(PR>-999)
						{
							double PMmin = 9999999, LatMin,LonMin,CNFSmax,PM;
							BOOL falg1 = TRUE;
							if(IDst_W!=_T("---"))
							{
								CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
								long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
								if(nSRV<3)
								{
									CString strOUT;
									strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
									MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
									falg1 = FALSE;
								}
								else
								{
									double lat_TP,	lon_TP;
									PMmin = 99999;
									for(long jTP=0;jTP<nSRV;jTP++)
									{
										lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

										double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																		GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																		Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																		GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																		AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																		AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																		lat_TP, lon_TP, CF, PR, AntDisc, ENV, Ti, kfactor);
										PM = EmedW - CNFS;
										PMmin = min(PMmin , PM);
										if(PMmin==PM)
										{
											LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
										}
									}//for

								}//if nSRV

							}//if Dst_W
							else if(IDst_W==_T("---"))
							{
								if(GeoArea_W.IsEmpty())
								{
									CString contourkeyN , nb_test_ptsN;
									long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_W) , &contourkeyN , &nb_test_ptsN);
									long *contourkeyI;		contourkeyI = new long[contourkeyNum];
									long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
									double *GRlatC;			GRlatC = new double[contourkeyNum];
									double *GRlonC;			GRlonC = new double[contourkeyNum];
									long NcontourT = 0;
									for(long i=0;i<contourkeyNum;i++)
									{
										contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
										nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
										NcontourT = NcontourT + nb_test_ptsI[i];
									}
									double * lat_TP;   lat_TP = new double[NcontourT];
									double * lon_TP;   lon_TP = new double[NcontourT];
									double * y;		y = lat_TP;
									double * x;		x = lon_TP;
									for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
									{
										CString lat_tpStr, lon_tpStr;
										long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM] ,nb_test_ptsI[iCNUM] , &lat_tpStr, &lon_tpStr , &GRlatC[iCNUM] , &GRlonC[iCNUM]) ;
										for(long jTP=0;jTP<n_tp;jTP++)
										{
											*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
											*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
										}
									}

									PMmin = 99999;
									for(long jTP=0;jTP<NcontourT;jTP++)
									{
										double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																		GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																		Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																		GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																		AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																		AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																		lat_TP[jTP], lon_TP[jTP], CF, PR, AntDisc, ENV, Ti, kfactor);
										PM = EmedW - CNFS;
										PMmin = min(PMmin , PM);
										if(PMmin==PM)
										{
											LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
										}
									}//for
									delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] GRlatC;	delete [] GRlonC;
									delete [] lat_TP;			delete [] lon_TP;
								}//if GeoArea_W
								else
								{
									CString lat_tpSTR, lon_tpSTR;
									double dum;
									long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR,&dum , &dum) ;
									double lat_TP, lon_TP;
									PMmin = 99999;
									for(long jTP=0;jTP<NcontourT;jTP++)
									{
										lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));	lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

										double CNFS = QGE06_IntToBCBT2DBCBT_CNFS( Fragment_W, NoticeType_W, Freq_W, TV_SYS_W, RPC_W, RxMode_W, 
																		GeoLat_W, GeoLon_W, Pol_W, Sigma_W, SYS_VAR_W, miu_W,
																		Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, RxMode_I,
																		GeoLat_I, GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I, PEC_I,
																		AdmRefID_I, AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																		AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																		lat_TP, lon_TP, CF, PR, AntDisc, ENV, Ti, kfactor);
										PM = EmedW - CNFS;
										PMmin = min(PMmin , PM);
										if(PMmin==PM)
										{
											LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
										}
									}//for
								}//else GeoArea_W
							}//if(IDst_W==_T("---"))
							if(falg1)
							{
								float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
								CString RLONbs,RLATbs , str_I1;
								Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

								CString P_out, IDst_out, allotkey_out;
								int Nas, Nal;

								P_out.Format(_T("%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf"), L,EmedW,CNFSmax,PMmin,LPM);

								str_I1 = QGE06_IntFrom_Q1(IDst_I,SfnID_I,NET_I, PEC_I,allotkey_I, AssocAllotID_I, AdmRefID_I,
																	  adm_I,ctry_I,SiteName_I,
																	  NoticeType_I,AssignCode_I,Freq_I,Pol_I,
																	  RLONbs,RLATbs,P_out,
																	  &IDst_out, &Nas, &allotkey_out, &Nal); 
								str_I = str_I + _T(",") + str_I1;
								Nstr_I = Nstr_I + (Nas+Nal);

								strAS_I = strAS_I + _T(",") + IDst_out ;
								strAL_I = strAL_I + _T(",") + allotkey_out ;

								NstrAS_I = NstrAS_I + Nas;
								NstrAL_I = NstrAL_I + Nal;
							}

						}//if (PR>-999)

					}//if(IDflag == 0)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_I<Nrowy
				if(Nstr_I>0)
				{
					str_I.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_W;
					dlgList.m_dataY = str_I;
					dlgList.m_rowsX = nstr_W+1;
					dlgList.m_rowsY = 1+Nstr_I;
					dlgList.m_mode = 9;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference Digital BC-BT from BC-BT");
					dlgList.m_title3 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title2 = _Z("Victim Assignment/Allotment :");
					dlgList.DoModal();
				}//if(Nstr_I>0)

			}//if(Nrowy>0)

		}//if intDLG
		
	}//if Sel_W
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06IntfromBcbt2abt() 
{
	CString Sel_W = QGE06_IntFrom_Qx(1);
	if(Sel_W.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 0.5;
		intDLG.m_LPMstr = _Z("Limiting Margin (dB) :");
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;
		
			CString	IDst_W = GetFld(Sel_W,1),		SiteName_W = GetFld(Sel_W,2),	NoticeType_W = GetFld(Sel_W,35),
					ctry_W = GetFld(Sel_W,25),		TV_SYS_W = GetFld(Sel_W,36),
					Pol_W = GetFld(Sel_W,13),		AdmRefID_W = GetFld(Sel_W,33);
			
			CString TV_COLOR_W = GetFld(Sel_W,40),		oset_v_12_W = GetFld(Sel_W,42),	oset_v_khz_W = GetFld(Sel_W,43),
					TV_ch_W = GetFld(Sel_W,44),			freq_stabl_W = GetFld(Sel_W,45);

			double  Freq_W = atof(GetFld(Sel_W,6)),			GeoLat_W = atof(GetFld(Sel_W,3)),
					GeoLon_W = atof(GetFld(Sel_W,4)),		freq_vcarr_W = atof(GetFld(Sel_W,39)),
					freq_scarr_W = atof(GetFld(Sel_W,41));

	//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
	//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
	//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
			CString adm_W = Cty2AdmGE06(&ctry_W);

//			double pi = 4.0*atan(1.0);
			float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

			int nstr_W = 1;
			CString str_W;
			str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,Freq_W,RLONbs,RLATbs,Pol_W);

			CP154606_Functions CP154606;
			double L = 50, CF = 0;	
	//		double EmedW = CP154606.Table_1_Rec417(Freq_W , TV_SYS_W) ;

			//Interferer Records
			CString str_I = _T("");
			int Nstr_I = 0;
			int Nrowy = QGE06_IntFromBCBT2DBCBT_Qy(IDst_W, 1, _T(""), 0, GeoLat_W, GeoLon_W, SR, Freq_W, FR); 
			if(Nrowy>0)
			{
				CString strAS_I = _T("") , strAL_I = _T("");
				int NstrAS_I = 0, NstrAL_I = 0;

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GeoLat_W, GeoLon_W , 1500.0);
				for(int i_I=0;i_I<Nrowy;i_I++)
				{
					CString Sel_I = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_I];
					CString IDst_I = GetFld(Sel_I,1),		Fragment_I = GetFld(Sel_I,28),	NoticeType_I = GetFld(Sel_I,35),
							TV_SYS_I = GetFld(Sel_I,36),	RPC_I = GetFld(Sel_I,37),		GeoArea_I = GetFld(Sel_I,53),
							SYS_VAR_I = GetFld(Sel_I,38),	RxMode_I = GetFld(Sel_I,54),	allotkey_I = GetFld(Sel_I,64),	
							Pol_I = GetFld(Sel_I,13),		AdmRefID_I = GetFld(Sel_I,33),	AssocAllotID_I = GetFld(Sel_I,59),
							TV_COLOR_I = GetFld(Sel_I,40),	PlanEntry_I = GetFld(Sel_I,50),	SfnID_I = GetFld(Sel_I,52),
							SiteName_I = GetFld(Sel_I,2),	ctry_I = GetFld(Sel_I,25),		AssignCode_I = GetFld(Sel_I,51),
							Hagl_I = GetFld(Sel_I,5),		AntDir_I = GetFld(Sel_I,31),	AntCatID_I = GetFld(Sel_I,30),
							RN_I = GetFld(Sel_I,61),		ERP_h_dbw_I = GetFld(Sel_I,62),	ERP_v_dbw_I = GetFld(Sel_I,63);
					CString oset_v_khz_I = GetFld(Sel_I,43),		TV_ch_I = GetFld(Sel_I,44),
							oset_v_12_I = GetFld(Sel_I,42);

					int IDflag = 1;
					if(IDst_I==_T("---"))	IDflag =  IDstCompare(allotkey_I, strAL_I,NstrAL_I);
					else					IDflag =  IDstCompare(IDst_I, strAS_I,NstrAS_I);
					if(IDflag == 0)
					{
				//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
				//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
				//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
						CString adm_I = Cty2AdmGE06(&ctry_I);

						double  Freq_I = atof(GetFld(Sel_I,6)),			GeoLat_I = atof(GetFld(Sel_I,3)),		GeoLon_I = atof(GetFld(Sel_I,4)),
								freq_vcarr_I = atof(GetFld(Sel_I,39)),	freq_scarr_I = atof(GetFld(Sel_I,41)),	pwr_ratio_I = atof(GetFld(Sel_I,46));

						CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
						int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
						CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);

						double PRC = -999 , PRT = -999;	// NA
						CP154606.GE06_PR_bcbt2Abcbt(Freq_W, TV_SYS_W, 
								 freq_vcarr_W, TV_COLOR_W,freq_scarr_W, oset_v_12_W, oset_v_khz_W, TV_ch_W, freq_stabl_W,
								 Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I, SYS_VAR_I, freq_vcarr_I, TV_COLOR_I,
								 freq_scarr_I, oset_v_12_I, oset_v_khz_I, TV_ch_I,pwr_ratio_I, &PRC, &PRT);

						if((PRC>-999)&&(PRT>-999))
						{
							double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, -1);

							double PMmax = -99999, LatMin,LonMin,CNFSmax,PM, EmWmax, UFSmax;
							BOOL falg1 = TRUE;
							if(IDst_W!=_T("---"))
							{
								CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
								long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
								if(nSRV<3)
								{
									CString strOUT;
									strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
									MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
									falg1 = FALSE;
								}
								else
								{
									double lat_TP,	lon_TP,	UFS_TP, EmW_TP;
									PMmax = -99999;
									for(long jTP=0;jTP<nSRV;jTP++)
									{
										lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));
										UFS_TP =  atof(GetFld(UFS_tpSTR , jTP+1));		EmW_TP =  atof(GetFld(Em_tpSTR , jTP+1));

										double CNFS = QGE06_IntToBCBT2ABCBT_CNFS(Freq_W, TV_SYS_W, GeoLat_W, GeoLon_W, Pol_W,
																		Fragment_I,NoticeType_I,Freq_I, TV_SYS_I, RPC_I,
																		GeoLat_I,GeoLon_I, Pol_I, Sigma_I, freq_vcarr_I, NET_I,PEC_I,
																		AdmRefID_I,	AssocAllotID_I, SfnID_I, allotkey_I, Hagl_I, AntDir_I,
																		AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I, TV_COLOR_I, GeoArea_I, RN_I,
																		lat_TP, lon_TP, CF, PRC, PRT, AntDisc, ENV,Ti,kfactor,
																		freq_vcarr_W,freq_scarr_W,TV_ch_W,TV_COLOR_W,oset_v_12_W,oset_v_khz_W,freq_stabl_W,
																		SYS_VAR_I,freq_scarr_I,oset_v_12_I,oset_v_khz_I,TV_ch_I,pwr_ratio_I); 

										PM = 10.0*log10(pow(10.0, UFS_TP/10.0) + pow(10.0, CNFS/10.0)) - UFS_TP;
										PMmax = max(PMmax , PM);
										if(PMmax==PM)
										{
											LatMin = lat_TP;	LonMin = lon_TP;  CNFSmax = CNFS;
											EmWmax = EmW_TP;	UFSmax = UFS_TP;
										}
									}//for

								}//if nSRV
							}//if Dst_W
							if(falg1)
							{
								float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
								CString RLONbs,RLATbs , str_I1;
								Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

								CString P_out, IDst_out, allotkey_out;
								P_out.Format(_T("%0.1lf,%0.3lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf"), L,EmWmax,UFSmax,CNFSmax,PMmax,LPM);

								int Nas, Nal;
								str_I1 = QGE06_IntFrom_Q1(IDst_I,SfnID_I,NET_I, PEC_I,allotkey_I, AssocAllotID_I,
									AdmRefID_I, adm_I,ctry_I,SiteName_I, NoticeType_I,AssignCode_I,Freq_I,Pol_I,
									RLONbs, RLATbs, P_out,
									&IDst_out, &Nas,&allotkey_out, &Nal); 

								str_I = str_I + _T(",") + str_I1;
								Nstr_I = Nstr_I + (Nas+Nal);

								strAS_I = strAS_I + _T(",") + IDst_out ;
								strAL_I = strAL_I + _T(",") + allotkey_out ;

								NstrAS_I = NstrAS_I + Nas;
								NstrAL_I = NstrAL_I + Nal;
							}

						}//if((PRC>-999)&&(PRT>-999))

					}//if(IDflag == 0)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_I<Nrowy

				if(Nstr_I>0)
				{
					str_I.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_W;
					dlgList.m_dataY = str_I;
					dlgList.m_rowsX = nstr_W+1;
					dlgList.m_rowsY = 1+Nstr_I;
					dlgList.m_mode = 10;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference Analogue BT from BC-BT");
					dlgList.m_title3 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title2 = _Z("Victim Assignment :");
					dlgList.DoModal();
				}//if(Nstr_I>0)

			}//if(Nrowy>0)

		}//if intDLG

	}//if Sel_W
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06IntfromFxm2dbcbt() 
{
	CString Sel_W = QGE06_IntFrom_Qx();
	if(Sel_W.GetLength()>0)
	{
//		CString sttp_I = GetFld(Sel_I,18),	StType_I = GetFld(Sel_I,29);
//		int STflag = 0;
//		if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
//			STflag = 0;
//		else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
//			STflag = 1;

		int STflag = 1;
		CGE06intDLG1 intDLG;
		intDLG.m_FXMlocationDisp = STflag;
//		intDLG.m_FXMDisp = 1;
		if(intDLG.DoModal() == IDOK)
		{
			double	SR = intDLG.m_SR,			FR = intDLG.m_FR,
					Ti = intDLG.m_Ti,			LPM = intDLG.m_LPM,
					lat_I = intDLG.m_Lat,		lon_I = intDLG.m_Lon;
			int		ENV = intDLG.m_env,			
					AntDisc = intDLG.m_AntDisc,	FXMlocation = intDLG.m_FXMlocation;
			double kfactor=4.0/3.0;
		//	int srv_I = intDLG.m_srv;

			CString IDst_W = GetFld(Sel_W,1),				Fragment_W = GetFld(Sel_W,28),	
					NoticeType_W = GetFld(Sel_W,35),		AdmRefID_W = GetFld(Sel_W,33),
					AssocAllotID_W = GetFld(Sel_W,59),		PlanEntry_W = GetFld(Sel_W,50),
					SfnID_W = GetFld(Sel_W,52),				allotkey_W = GetFld(Sel_W,64),
					RxMode_W = GetFld(Sel_W,54),			RPC_W = GetFld(Sel_W,37),
					TV_SYS_W = GetFld(Sel_W,36),			SYS_VAR_W = GetFld(Sel_W,38),
					Pol_W = GetFld(Sel_W,13),				GeoArea_W = GetFld(Sel_W,53),
					SiteName_W = GetFld(Sel_W,2),			ctry_W = GetFld(Sel_W,25),
					AssignCode_W = GetFld(Sel_W,51);
		
			double  Freq_W = atof(GetFld(Sel_W,6)),			GeoLat_W = atof(GetFld(Sel_W,3)),
					GeoLon_W = atof(GetFld(Sel_W,4));

	//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
	//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
	//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
			CString adm_W = Cty2AdmGE06(&ctry_W);

			CP154606_Functions CP154606;
			CString STN_W = CP154606.GE06_STN(Fragment_W, NoticeType_W);
			int PEC_W = GE06_PEC(AdmRefID_W , AssocAllotID_W , PlanEntry_W , SfnID_W , STN_W) ;
			CString NET_W;	NET_W.Format("%s%d",STN_W,PEC_W);

			int nstr_W = 0;
			CString str_W;
//			double pi = 4.0*atan(1.0);

			double GRlat_W , GRlon_W , frq_MHz_W;
			if((NET_W==_T("ASS1"))||(NET_W==_T("AST1"))||(NET_W==_T("ASA0")))	/////////A1
			{
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;			frq_MHz_W = Freq_W;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A1
			else if((NET_W==_T("ASS2"))||(NET_W==_T("AST2")))	/////////A2
			{
				CString IDstN;
				long nASS = QGE06_IntTo_Q1(IDst_W,SfnID_W,&IDstN, &GRlat_W, &GRlon_W,&str_W);
				frq_MHz_W = Freq_W;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A2
			else if((NET_W==_T("ALS3"))||(NET_W==_T("ALT3")))	/////////A3
			{
				CString GeoArea_W = GetFld(Sel_W,53);
				if(GeoArea_W.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_W, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A3
			else if((NET_W==_T("ASS4"))||(NET_W==_T("AST4")))	/////////A4_1
			{
				CString str_W1, str_W2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_W,SfnID_W,&IDstN, &dum, &dum,&str_W1, 1);
				CString str_WL = QGE06_IntTo_Q3(SfnID_W);
				CString allotkey_WL = GetFld(str_WL,1);
				CString GeoArea_WL = GetFld(str_WL,2);
				if(GeoArea_WL.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_WL, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_WL, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A4_1
			else if((NET_W==_T("ALS4"))||(NET_W==_T("ALT4")))	/////////A4_2
			{
				CString str_W1, str_W2;

				CString IDstN;
				double dum;
				long nASS = QGE06_IntTo_Q1(IDst_W, SfnID_W,&IDstN, &dum, &dum,&str_W1, 1);
				CString GeoArea_W = GetFld(Sel_W,53);

				if(GeoArea_W.IsEmpty())
				{
					QGE06_IntTo_Q2(allotkey_W, &GRlat_W, &GRlon_W);
				}
				else
				{
					CString lat_tpSTR, lon_tpSTR;
					long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR, &GRlat_W, &GRlon_W) ;
				}
				frq_MHz_W = Freq_W;

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A4_2
			else if((NET_W==_T("ASS5"))||(NET_W==_T("AST5")))	/////////A5_1
			{
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;		frq_MHz_W = Freq_W;

			//	CString str_WL = QGE06_IntTo_Q3(SfnID_W);
			//	CString allotkey_WL = GetFld(str_WL,1),		GeoArea_WL = GetFld(str_WL,2);
				CString allotkey_WL = QGE06_CArea_Q3(AssocAllotID_W) ;

				float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
				CString RLONbs,RLATbs;
				Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AS"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,RLONbs,RLATbs,Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A5_1
			else if((NET_W==_T("ALS5"))||(NET_W==_T("ALT5")))	/////////A5_2
			{
				CString AdmRefID_W = GetFld(Sel_W,33);
				CString IDst_WL,GeoLat0,GeoLon0,Frequency0, str_W1, str_W2;
				int c = QGE06_IntTo_Q4(AdmRefID_W,&IDst_WL, &GeoLat0, &GeoLon0, &Frequency0, &str_W1);

				GRlat_W = atof(GeoLat0);	GRlon_W = atof(GeoLon0);		frq_MHz_W = atof(Frequency0);

				nstr_W = 1;
				str_W.Format(_T("%s,%s,%s,%s,%s,%s,%s,%d,%s,%0.4lf,%s  %s,%s,%s,%s") , _T("W"),_T("AL"),adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,PEC_W,AssignCode_W,Freq_W,_T("---"),_T("---"),Pol_W,AssocAllotID_W,SfnID_W);

			}	/////////A5_2

			double L, EmedW, Sigma_W;	int AntDisc0;
			CP154606.Default_CArea_0(Fragment_W, NoticeType_W, RxMode_W, RPC_W,Freq_W, TV_SYS_W, SYS_VAR_W, &L,&EmedW,&AntDisc0,&Sigma_W); 
			double miu_W = CP154606.Qi(100-L);

			//Interferer Records
			CString str_I = _T("");
			int Nstr_I = 0;
			int Nrowy = QGE06_IntFromFXM2DBCBT_Qy(GRlat_W, GRlon_W, SR, frq_MHz_W, FR); 
			if(Nrowy>0)
			{
				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GRlat_W, GRlon_W , 1500.0);
				for(int i_I=0;i_I<Nrowy;i_I++)
				{
					CString Sel_I = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_I];
					CString IDst_I = GetFld(Sel_I,1),			Pol_I = GetFld(Sel_I,13),			ctry_I = GetFld(Sel_I,25),
							Fragment_I = GetFld(Sel_I,28),		AreaOfTrans_I = GetFld(Sel_I,34),	SiteName_I = GetFld(Sel_I,2),
							RxMode_I = GetFld(Sel_I,54),		RPC_I = GetFld(Sel_I,37),			AdmRefID_I = GetFld(Sel_I,33),
							AntDir_I = GetFld(Sel_I,31),		AntCatID_I = GetFld(Sel_I,30),		Hagl_I = GetFld(Sel_I,5),
							sttp_I = GetFld(Sel_I,18),			StType_I = GetFld(Sel_I,29),		NoticeType_I = GetFld(Sel_I,35),
							Emission_I = GetFld(Sel_I,19),		SysType1_I = GetFld(Sel_I,26),		SysType2_I = GetFld(Sel_I,27);
					double  GeoLat_I = atof(GetFld(Sel_I,3)),	GeoLon_I = atof(GetFld(Sel_I,4)),	Freq_I = atof(GetFld(Sel_I,6));

					SysType1_I.TrimLeft();		SysType1_I.TrimRight();
					SysType2_I.TrimLeft();		SysType2_I.TrimRight();

			//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
			//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
			//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
					CString adm_I = Cty2AdmGE06(&ctry_I);

					if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
						STflag = 0;
					else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
						STflag = 1;

					double GRlat_I, GRlon_I;
					if(STflag == 0)
					{
						GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
						lat_I	= GeoLat_I;			lon_I	= GeoLon_I;
					}
					else if(STflag == 1)
					{
						if(AreaOfTrans_I.GetLength()>0)
						{
							Zone2GRpoint(AreaOfTrans_I ,&GRlat_I, &GRlon_I); 
							if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
						}
						else
						{
							GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
							if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
						}
					}
					double PR = CP154606.GE06_PR_FXM2Dbcbt(Fragment_W,NoticeType_W,Freq_W,TV_SYS_W,RPC_W,SYS_VAR_W,RxMode_W,
															Freq_I,sttp_I,Emission_I,SysType1_I,SysType2_I); 
					if(PR>-999)
					{
						double PWR_I = atof(GetFld(Sel_I,7));	//W
						double PwrERP_I = 10.0*log10(PWR_I) - 2.15;	//dBw
						CString ERP_h_dbw_I;	ERP_h_dbw_I.Format(_T("%lf"), PwrERP_I);
						CString ERP_v_dbw_I;	ERP_v_dbw_I.Format(_T("%lf"), PwrERP_I);

					//	double Sigma_I = CP154606.Table_SigmaN(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, srv_I);
						double Sigma_I = CP154606.Table_SigmaN_0(Fragment_I, NoticeType_I, RxMode_I, RPC_I, Freq_I, ENV,sttp_I);
						double CF = miu_W*sqrt(Sigma_W*Sigma_W + Sigma_I*Sigma_I);

						double PMmin = 9999999, LatMin,LonMin,CNFSmax,PM;
						BOOL falg1 = TRUE;
						if(IDst_W!=_T("---"))
						{
							CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
							long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
							if(nSRV<3)
							{
								CString strOUT;
								strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
								MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
								falg1 = FALSE;
							}
							else
							{
								double lat_TP,	lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<nSRV;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP, lon_TP,CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for

							}//if nSRV

						}//if IDst_W
						else if(IDst_W==_T("---"))
						{
							if(GeoArea_W.IsEmpty())
							{
								CString contourkeyN , nb_test_ptsN;
								long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey_W) , &contourkeyN , &nb_test_ptsN);
								long *contourkeyI;		contourkeyI = new long[contourkeyNum];
								long *nb_test_ptsI;		nb_test_ptsI = new long[contourkeyNum];
								double *GRlatC;			GRlatC = new double[contourkeyNum];
								double *GRlonC;			GRlonC = new double[contourkeyNum];
								long NcontourT = 0;
								for(long i=0;i<contourkeyNum;i++)
								{
									contourkeyI[i] = atol(GetFld(contourkeyN,i+1));
									nb_test_ptsI[i] = atol(GetFld(nb_test_ptsN,i+1));
									NcontourT = NcontourT + nb_test_ptsI[i];
								}
								double * lat_TP;   lat_TP = new double[NcontourT];
								double * lon_TP;   lon_TP = new double[NcontourT];
								double * y;		y = lat_TP;
								double * x;		x = lon_TP;
								for(long iCNUM=0;iCNUM<contourkeyNum;iCNUM++)
								{
									CString lat_tpStr, lon_tpStr;
									long n_tp = QGE06_BCBT_A3_1(contourkeyI[iCNUM] ,nb_test_ptsI[iCNUM] , &lat_tpStr, &lon_tpStr , &GRlatC[iCNUM] , &GRlonC[iCNUM]) ;
									for(long jTP=0;jTP<n_tp;jTP++)
									{
										*y = atof(GetFld(lat_tpStr,jTP+1));	y++;
										*x = atof(GetFld(lon_tpStr,jTP+1));	x++;
									}
								}

								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP[jTP], lon_TP[jTP] ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP[jTP], lon_TP[jTP]) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP[jTP], lon_TP[jTP],CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
									}
								}//for
								delete [] contourkeyI;		delete [] nb_test_ptsI;	delete [] GRlatC;	delete [] GRlonC;
								delete [] lat_TP;			delete [] lon_TP;
							}//if GeoArea_W
							else
							{
								CString lat_tpSTR, lon_tpSTR;
								double dum;
								long NcontourT = QGE06_BCBT_Aux_Border(GeoArea_W, &lat_tpSTR, &lon_tpSTR,&dum , &dum) ;
								double lat_TP, lon_TP;
								PMmin = 99999;
								for(long jTP=0;jTP<NcontourT;jTP++)
								{
									lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));	lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));

									if((FXMlocation==0)&&(STflag == 1))
									{
										if(AreaOfTrans_I.GetLength()>0)
											Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
										else
										{
											double radius_I = atof(GetFld(Sel_I,22));
											double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
											reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
										}
									}
									double CNFS = CNFS_Function_Int_0(GeoLat_W, GeoLon_W, Freq_W,  Pol_W,  Fragment_W,
																	NoticeType_W, RxMode_W, RPC_W,
																	lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																	AntDir_I, AntCatID_I, ERP_h_dbw_I,ERP_v_dbw_I,
																	lat_TP, lon_TP,CF,PR,AntDisc, ENV,Ti,kfactor,3); 
									PM = EmedW - CNFS;
									PMmin = min(PMmin , PM);
									if(PMmin==PM)
									{
										LatMin = lat_TP;	LonMin = lon_TP;	CNFSmax = CNFS;
									}
								}//for
							}//else GeoArea_W
						}//if(IDst_W==_T("---"))
						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_I1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							str_I1.Format(_T("%s,%s,%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") ,IDst_I,adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,sttp_I,Freq_I,RLONbs,RLATbs,Pol_I,L,EmedW,CNFSmax,PMmin,LPM);
							
							str_I = str_I + _T(",") + str_I1;
							Nstr_I++;
						}

					}//if(PR>-999)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_I<Nrowy

				if(Nstr_I>0)
				{
					str_I.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_W;
					dlgList.m_dataY = str_I;
					dlgList.m_rowsX = nstr_W+1;
					dlgList.m_rowsY = 1+Nstr_I;
					dlgList.m_mode = 11;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference Digital BC-BT from FXM");
					dlgList.m_title3 = _Z("Interferer Stations :");
					dlgList.m_title2 = _Z("Victim Assignment/Allotment :");
					dlgList.DoModal();
				}//if(Nstr_I>0)

			}//if(Nrowy>0)

		}//if intDLG

	}//if Sel_W
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06IntfromFxm2abt() 
{
	CString Sel_W = QGE06_IntFrom_Qx(1);
	if(Sel_W.GetLength()>0)
	{
//		CString sttp_I = GetFld(Sel_I,18),	StType_I = GetFld(Sel_I,29);
//		int STflag = 0;
//		if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
//			STflag = 0;
//		else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
//			STflag = 1;

		int STflag = 1;
		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 0.5;
		intDLG.m_LPMstr = _Z("Limiting Margin (dB) :");
		intDLG.m_FXMlocationDisp = STflag;
//		intDLG.m_FXMDisp = 0;
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			double lat_I = intDLG.m_Lat,		lon_I = intDLG.m_Lon;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc, FXMlocation = intDLG.m_FXMlocation;;
			double kfactor=4.0/3.0;
		
			CString	IDst_W = GetFld(Sel_W,1),		SiteName_W = GetFld(Sel_W,2),	NoticeType_W = GetFld(Sel_W,35),
					ctry_W = GetFld(Sel_W,25),		TV_SYS_W = GetFld(Sel_W,36),	Fragment_W = GetFld(Sel_W,28),
					Pol_W = GetFld(Sel_W,13),		AdmRefID_W = GetFld(Sel_W,33),	RxMode_W = GetFld(Sel_W,54);
			
			CString TV_COLOR_W = GetFld(Sel_W,40),		oset_v_12_W = GetFld(Sel_W,42),	oset_v_khz_W = GetFld(Sel_W,43),
					TV_ch_W = GetFld(Sel_W,44),			freq_stabl_W = GetFld(Sel_W,45);

			double  Freq_W = atof(GetFld(Sel_W,6)),			GeoLat_W = atof(GetFld(Sel_W,3)),
					GeoLon_W = atof(GetFld(Sel_W,4)),		freq_vcarr_W = atof(GetFld(Sel_W,39)),
					freq_scarr_W = atof(GetFld(Sel_W,41));

	//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
	//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
	//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
			CString adm_W = Cty2AdmGE06(&ctry_W);

//			double pi = 4.0*atan(1.0);
			float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

			int nstr_W = 1;
			CString str_W;
			str_W.Format(_T("%s,%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s") ,IDst_W,adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,Freq_W,RLONbs,RLATbs,Pol_W);

			CP154606_Functions CP154606;
			double L = 50, CF = 0;	
	//		double EmedW = CP154606.Table_1_Rec417(Freq_W , TV_SYS_W) ;
	
			//Interferer Records
			CString str_I = _T("");
			int Nstr_I = 0;
			int Nrowy = QGE06_IntFromFXM2DBCBT_Qy(GeoLat_W, GeoLon_W, SR, Freq_W, FR); 
			if(Nrowy>0)
			{
				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				LoadMap_IDWMpr(4,GeoLat_W, GeoLon_W , 1500.0);
				for(int i_I=0;i_I<Nrowy;i_I++)
				{
					CString Sel_I = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_I];
					CString IDst_I = GetFld(Sel_I,1),			Pol_I = GetFld(Sel_I,13),			ctry_I = GetFld(Sel_I,25),
							Fragment_I = GetFld(Sel_I,28),		AreaOfTrans_I = GetFld(Sel_I,34),	SiteName_I = GetFld(Sel_I,2),
							RxMode_I = GetFld(Sel_I,54),		RPC_I = GetFld(Sel_I,37),			AdmRefID_I = GetFld(Sel_I,33),
							AntDir_I = GetFld(Sel_I,31),		AntCatID_I = GetFld(Sel_I,30),		Hagl_I = GetFld(Sel_I,5),
							sttp_I = GetFld(Sel_I,18),			StType_I = GetFld(Sel_I,29),		NoticeType_I = GetFld(Sel_I,35),
							Emission_I = GetFld(Sel_I,19),		SysType1_I = GetFld(Sel_I,26),		SysType2_I = GetFld(Sel_I,27);
					double  GeoLat_I = atof(GetFld(Sel_I,3)),	GeoLon_I = atof(GetFld(Sel_I,4)),	Freq_I = atof(GetFld(Sel_I,6));

					SysType1_I.TrimLeft();		SysType1_I.TrimRight();
					SysType2_I.TrimLeft();		SysType2_I.TrimRight();

		//			if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
		//			else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
		//			CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
					CString adm_I = Cty2AdmGE06(&ctry_I);

					if(((sttp_I==_T("FX"))||(sttp_I==_T("FB"))) && (StType_I!=_T("Typical")))
						STflag = 0;
					else if((((sttp_I==_T("FX"))||(sttp_I==_T("FB")))&&(StType_I==_T("Typical"))) || ((sttp_I==_T("ML"))&&(StType_I!=_T("Typical"))))
						STflag = 1;

					double GRlat_I, GRlon_I;
					if(STflag == 0)
					{
						GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
						lat_I	= GeoLat_I;			lon_I	= GeoLon_I;
					}
					else if(STflag == 1)
					{
						if(AreaOfTrans_I.GetLength()>0)
						{
							Zone2GRpoint(AreaOfTrans_I ,&GRlat_I, &GRlon_I); 
							if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
						}
						else
						{
							GRlat_I = GeoLat_I;			GRlon_I = GeoLon_I;
							if(FXMlocation==1)		{	lat_I = GRlat_I;	lon_I = GRlon_I;	}
						}
					}
					double PRC = -999 , PRT = -999;	// NA
					CP154606.FXM2ATV_PR(Freq_I, freq_vcarr_W, TV_COLOR_W, TV_SYS_W,&PRC,&PRT);
					if((PRC>-999)&&(PRT>-999))
					{
						double PWR_I = atof(GetFld(Sel_I,7));	//W
						double PwrERP_I = 10.0*log10(PWR_I) - 2.15;	//dBw
						CString ERP_h_dbw_I;	ERP_h_dbw_I.Format(_T("%lf"), PwrERP_I);
						CString ERP_v_dbw_I;	ERP_v_dbw_I.Format(_T("%lf"), PwrERP_I);

						double PMmax = -99999, LatMin,LonMin,CNFSmax,PM, EmWmax, UFSmax;
						BOOL falg1 = TRUE;
						
						CString lat_tpSTR, lon_tpSTR, UFS_tpSTR, Em_tpSTR;
						long nSRV = QGE06_IntTo_Q6(IDst_W, &lat_tpSTR, &lon_tpSTR, &UFS_tpSTR,&Em_tpSTR); 
						if(nSRV<3)
						{
							CString strOUT;
							strOUT.Format(_Z("No service area test point was found for this station:\n AdmRefID : ( %s )\n ID No : ( %s )\n Name : ( %s )\nPlease run service area function before interference calculation.") , AdmRefID_W , IDst_W,SiteName_W);
							MessageBox(strOUT,_Z("ERROR!!!"),MB_ICONERROR);
							falg1 = FALSE;
						}
						else
						{
							double lat_TP,	lon_TP,	UFS_TP, EmW_TP;
							PMmax = -99999;
							for(long jTP=0;jTP<nSRV;jTP++)
							{
								lat_TP =  atof(GetFld(lat_tpSTR , jTP+1));		lon_TP =  atof(GetFld(lon_tpSTR , jTP+1));
								UFS_TP =  atof(GetFld(UFS_tpSTR , jTP+1));		EmW_TP =  atof(GetFld(Em_tpSTR , jTP+1));

								if((FXMlocation==0)&&(STflag == 1))
								{
									if(AreaOfTrans_I.GetLength()>0)
										Zone2NearPoint(AreaOfTrans_I ,lat_TP, lon_TP ,&lat_I, &lon_I);
									else
									{
										double radius_I = atof(GetFld(Sel_I,22));
										double az_1 = Azimuth_Deg(GeoLat_I,GeoLon_I,lat_TP, lon_TP) ;
										reckon(GeoLat_I,GeoLon_I, radius_I, az_1, &lat_I, &lon_I) ;
									}
								}

								double CNFS = CNFS_Function_IntA(GeoLat_W, GeoLon_W, Freq_W, Pol_W, Fragment_W,
																 NoticeType_W, RxMode_W, _T(""),
																 lat_I, lon_I, Freq_I, Pol_I, Hagl_I,
																 AntDir_I, AntCatID_I, ERP_h_dbw_I, ERP_v_dbw_I,
																 lat_TP, lon_TP, CF, PRC, PRT,
																 AntDisc, ENV, Ti, kfactor, 3); 

								PM = 10.0*log10(pow(10.0, UFS_TP/10.0) + pow(10.0, CNFS/10.0)) - UFS_TP;
								PMmax = max(PMmax , PM);
								if(PMmax==PM)
								{
									LatMin = lat_TP;	LonMin = lon_TP;  CNFSmax = CNFS;
									EmWmax = EmW_TP;	UFSmax = UFS_TP;
								}
							}//for

						}//if nSRV

						if(falg1)
						{
							float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
							CString RLONbs,RLATbs , str_I1;
							Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);
							str_I1.Format(_T("%s,%s,%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%0.1lf,%0.3lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf") ,IDst_I,adm_I,ctry_I,SiteName_I,AdmRefID_I,NoticeType_I,sttp_I,Freq_I,RLONbs,RLATbs, Pol_I,L,EmWmax,UFSmax,CNFSmax,PMmax,LPM);
							
							str_I = str_I + _T(",") + str_I1;
							Nstr_I++;
						}

					}//if((PRC>-999)&&(PRT>-999))

					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_I<Nrowy
				if(Nstr_I>0)
				{
					str_I.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_W;
					dlgList.m_dataY = str_I;
					dlgList.m_rowsX = nstr_W+1;
					dlgList.m_rowsY = 1+Nstr_I;
					dlgList.m_mode = 12;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference Analogue BT from FXM");
					dlgList.m_title3 = _Z("Interferer Stations :");
					dlgList.m_title2 = _Z("Victim Analogue Assignments :");
					dlgList.DoModal();
				}//if(Nstr_W>0)

			}//if(Nrowy>0)

		}//if intDLG

	}//if Sel_W
	Set_STtable_Default();
	EndWaitCursor();
}

void CSMS4DCView::OnCoordinationGe06IntfromBcbt2fxm() 
{
	CString Sel_W = QGE06_IntFromBCBT2FXM_Qx();
	if(Sel_W.GetLength()>0)
	{
		CGE06intDLG1 intDLG;
		intDLG.m_LPM = 6;
		intDLG.m_Ti = 10;
		if(intDLG.DoModal() == IDOK)
		{
			double SR = intDLG.m_SR;
			double FR = intDLG.m_FR;
			double Ti = intDLG.m_Ti;
			double LPM = intDLG.m_LPM;
			int ENV = intDLG.m_env , AntDisc = intDLG.m_AntDisc;
			double kfactor=4.0/3.0;

			CString IDst_W = GetFld(Sel_W,1),			sttp_W = GetFld(Sel_W,18),
					StType_W = GetFld(Sel_W,29),		SysType1_W = GetFld(Sel_W,26),
					SysType2_W = GetFld(Sel_W,27),		Emission_W = GetFld(Sel_W,19),
					Fragment_W = GetFld(Sel_W,28),		NoticeType_W = GetFld(Sel_W,35),
					Pol_W = GetFld(Sel_W,13),			ctry_W = GetFld(Sel_W,25),
					SiteName_W = GetFld(Sel_W,2),		AdmRefID_W = GetFld(Sel_W,33),
					AntDir_W = GetFld(Sel_W,31),		AntCatID_W = GetFld(Sel_W,30);
			double  GeoLat_W = atof(GetFld(Sel_W,3)),	GeoLon_W = atof(GetFld(Sel_W,4));

			int ant = atol(GetFld(Sel_W,65));
			CString GeoType_W = GetFld(Sel_W,66),		sttp1_W = GetFld(Sel_W,67);
			double Freq_W = atof(GetFld(Sel_W,68));

	//		if		(ctry_W.GetLength()==1)		ctry_W = ctry_W + _T("  ");
	//		else if (ctry_W.GetLength()==2)		ctry_W = ctry_W + _T(" ");
	//		CString adm_W;	GEOCTYA((BYTE *)ctry_W.GetBufferSetLength(3), (BYTE *)adm_W.GetBufferSetLength(3));
			CString adm_W = Cty2AdmGE06(&ctry_W);

			SysType1_W.TrimLeft();		SysType1_W.TrimRight();
			SysType2_W.TrimLeft();		SysType2_W.TrimRight();

			CString inputfxmrec_W, FXM, zone = _T("");
			int nSRV = 0, flag_W = 0;
			double latci,lonci,Rci;
			if(GeoType_W==_T("POINT"))
			{
				inputfxmrec_W = GeoType_W;	FXM = sttp1_W;
				nSRV = 1;					flag_W = 1;
			}
			else if(GeoType_W==_T("MULTIPOINT"))
			{
				inputfxmrec_W = _T("AREA");	FXM = sttp1_W;
				nSRV = 6;					flag_W = 2;
			}
			else if(GeoType_W==_T("ZONE"))
			{
				inputfxmrec_W = _T("AREA");	FXM = _T("ML");
				zone = GetFld(Sel_W,69);
				nSRV = Ctry2Point(zone);	flag_W = 3;
			}
			else if(GeoType_W==_T("CIRCLE"))
			{
				inputfxmrec_W = _T("AREA");	FXM = _T("ML");
				latci = atof(GetFld(Sel_W,70));		lonci = atof(GetFld(Sel_W,71));
				Rci = atof(GetFld(Sel_W,72));
				nSRV = 36;					flag_W = 4;
			}
			if(sttp_W==_T("ML"))	inputfxmrec_W = _T("NA");

			double GRlat_W , GRlon_W;
			CP154606_Functions CP154606;

			double *lat_TP;		lat_TP = new double[nSRV];
			double *lon_TP;		lon_TP = new double[nSRV];
			if(flag_W==1)
			{
				lat_TP[0] = GeoLat_W;	lon_TP[0] = GeoLon_W;
				GRlat_W = GeoLat_W;		GRlon_W = GeoLon_W;
			}
			else if(flag_W==2)
			{
				nSRV = QGE06_IntToBCBT2FXM_Q1(atol(IDst_W) ,lat_TP, lon_TP); 
				CP154606.GrPointT(lat_TP, lon_TP , nSRV , &GRlat_W,&GRlon_W);
			}
			else if(flag_W==3)
			{
				QGE06_IntToBCBT2FXM_Q3(zone,lat_TP,lon_TP,nSRV); 
				Zone2GRpoint(zone ,&GRlat_W,&GRlon_W); 
			}
			else if(flag_W==4)
			{
				for(long i=0;i<36;i++)	reckon(latci,lonci, Rci , i*10 , &lat_TP[i] , &lon_TP[i]) ;
				CP154606.GrPointT(lat_TP, lon_TP , nSRV , &GRlat_W,&GRlon_W);
			}
			double L = 50 , CF = 0;
//			double pi = 4.0*atan(1.0);
			double BW_W = CP154606.Emission2NBW(Emission_W)/1000.0;

			float RLON   = (float)((pi/180.0)*GRlon_W), RLAT   = (float)((pi/180.0)*GRlat_W);
		//	float RLON   = (float)((pi/180.0)*GeoLon_W), RLAT   = (float)((pi/180.0)*GeoLat_W);
			CString RLONbs,RLATbs;
			Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

			int nstr_W = 1;
			CString str_W;	str_W.Format(_T("%s,%s,%s,%s,%s,%s,%0.4lf,%s  %s,%s,%s,%s") ,IDst_W,adm_W,ctry_W,SiteName_W,AdmRefID_W,NoticeType_W,Freq_W,RLONbs,RLATbs,Pol_W,SysType1_W,SysType2_W);
			
			//Interferer Records
			CString str_I = _T("");
			int Nstr_I = 0;
		//	int Nrowy = QGE06_IntFromBCBT2DBCBT_Qy(_T(""), 0, _T(""), 0, GeoLat_W, GeoLon_W, SR, Freq_W, FR); 
			int Nrowy = QGE06_IntFromBCBT2DBCBT_Qy(_T(""), 0, _T(""), 0, GRlat_W, GRlon_W, SR, Freq_W, FR); 
			if(Nrowy>0)
			{
				CString strAS_I = _T("") , strAL_I = _T("");
				int NstrAS_I = 0, NstrAL_I = 0;

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%"+_Z(" complete")+" %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

			//	LoadMap_IDWMpr(4,GeoLat_W, GeoLon_W , 1500.0);
				LoadMap_IDWMpr(4,GRlat_W, GRlon_W , 1500.0);
				for(int i_I=0;i_I<Nrowy;i_I++)
				{
					CString Sel_I = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i_I];
					CString IDst_I = GetFld(Sel_I,1),		Fragment_I = GetFld(Sel_I,28),	NoticeType_I = GetFld(Sel_I,35),
							TV_SYS_I = GetFld(Sel_I,36),	RPC_I = GetFld(Sel_I,37),		GeoArea_I = GetFld(Sel_I,53),
							SYS_VAR_I = GetFld(Sel_I,38),	RxMode_I = GetFld(Sel_I,54),	allotkey_I = GetFld(Sel_I,64),	
							Pol_I = GetFld(Sel_I,13),		AdmRefID_I = GetFld(Sel_I,33),	AssocAllotID_I = GetFld(Sel_I,59),
							TV_COLOR_I = GetFld(Sel_I,40),	PlanEntry_I = GetFld(Sel_I,50),	SfnID_I = GetFld(Sel_I,52),
							SiteName_I = GetFld(Sel_I,2),	ctry_I = GetFld(Sel_I,25),		AssignCode_I = GetFld(Sel_I,51),
							Hagl_I = GetFld(Sel_I,5),		AntDir_I = GetFld(Sel_I,31),	AntCatID_I = GetFld(Sel_I,30),
							RN_I = GetFld(Sel_I,61),		ERP_h_dbw_I = GetFld(Sel_I,62),	ERP_v_dbw_I = GetFld(Sel_I,63),
							SpecMask_I = GetFld(Sel_I,47);

					int IDflag = 1;
					if(IDst_I==_T("---"))	IDflag =  IDstCompare(allotkey_I, strAL_I,NstrAL_I);
					else					IDflag =  IDstCompare(IDst_I, strAS_I,NstrAS_I);
					if(IDflag == 0)
					{
				//		if		(ctry_I.GetLength()==1)		ctry_I = ctry_I + _T("  ");
				//		else if (ctry_I.GetLength()==2)		ctry_I = ctry_I + _T(" ");
				//		CString adm_I;	GEOCTYA((BYTE *)ctry_I.GetBufferSetLength(3), (BYTE *)adm_I.GetBufferSetLength(3));
						CString adm_I = Cty2AdmGE06(&ctry_I);

						double  Freq_I = atof(GetFld(Sel_I,6)),			GeoLat_I = atof(GetFld(Sel_I,3)),		GeoLon_I = atof(GetFld(Sel_I,4)),
								freq_vcarr_I = atof(GetFld(Sel_I,39)),	freq_scarr_I = atof(GetFld(Sel_I,41));

						CString STN_I = CP154606.GE06_STN(Fragment_I, NoticeType_I);
						int PEC_I = GE06_PEC(AdmRefID_I , AssocAllotID_I , PlanEntry_I , SfnID_I , STN_I) ;
						CString NET_I;	NET_I.Format("%s%d",STN_I,PEC_I);
						double BW_I = CP154606.AP3_BandW_BS(STN_I, TV_SYS_I, RPC_I,SYS_VAR_I, Freq_I); 

						int GENERIC;
						double hR, CNFS , EminW, PR = -999;

						if( ((NoticeType_I==_T("DT1"))||(NoticeType_I==_T("GT1"))||(NoticeType_I==_T("DT2"))||(NoticeType_I==_T("GT2")) ||(Fragment_I==_T("GE06A")) )&&
							(((SysType1_W.GetLength()==0)&&(SysType2_W.GetLength()==0)) || 
							(SysType1_W==_T("FK"))||(SysType1_W==_T("NV"))||(SysType1_W==_T("NB"))||(SysType2_W==_T("FK"))||(SysType2_W==_T("NV"))||(SysType2_W==_T("NB")))  )
						{
							GENERIC = 1;	PR = 0;		hR = 10;
							EminW = CP154606.Table_AP4_2_45(FXM, Freq_I, Freq_W, BW_I,BW_W, SpecMask_I,
													Fragment_I,NoticeType_I,TV_COLOR_I,TV_SYS_I,freq_vcarr_I,freq_scarr_I); 
						}
						else
						{
							GENERIC = 0;
							PR = CP154606.GE06_PR_BCBT2FXM(Freq_W, sttp_W, Emission_W, SysType1_W, SysType2_W,
														 Fragment_I, NoticeType_I, Freq_I, TV_SYS_I, RPC_I,
														 SYS_VAR_I, freq_vcarr_I, TV_COLOR_I, freq_scarr_I,	 SpecMask_I);
							
							if     (SysType1_W.GetLength()==0)	EminW = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType2_W,Freq_W,&hR); 
							else if(SysType2_W.GetLength()==0)	EminW = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType1_W,Freq_W,&hR); 
							else
							{
								double hR1,hR2,Emin1,Emin2;
								Emin1 = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType1_W,Freq_W,&hR1); 
								Emin2 = CP154606.Table2_GE06L(Fragment_I,NoticeType_I,SysType2_W,Freq_W,&hR2); 
								EminW = min(Emin1,Emin2);
								if(EminW==Emin1)	hR = hR1;
								else				hR = hR2;
							}
						}
						if(PR>-999)
						{
							double PMmin = 999999;
							double LatMin, LonMin, CNFSmax;
							for(long jTP=0;jTP<nSRV;jTP++)
							{
								CNFS = GE06UFS_FXM( GeoLat_W, GeoLon_W, Freq_W,Pol_W,Fragment_W,
													 GeoLat_I, GeoLon_I, Freq_I,Pol_I,Hagl_I,
													 AntDir_I,AntCatID_I,ERP_h_dbw_I, ERP_v_dbw_I,
													 lat_TP[jTP],lon_TP[jTP], CF,PR,
													 AntDisc,ENV, Ti, kfactor, ant, hR,
													 NET_I, PEC_I, SfnID_I, GeoArea_I,  allotkey_I,
													 RN_I,RPC_I,AdmRefID_I,AntDir_W, AntCatID_W,
											 		 sttp_W,Emission_W,SysType1_W,SysType2_W,Fragment_I,GENERIC);

								double PM = EminW - CNFS;
								PMmin = min(PMmin,PM);
								if(PMmin==PM)
								{
									LatMin = lat_TP[jTP];	LonMin = lon_TP[jTP];	CNFSmax = CNFS;
								}

							}//for jTP
							if(flag_W>0)
							{
								float RLON   = (float)((pi/180.0)*LonMin), RLAT   = (float)((pi/180.0)*LatMin);
								CString RLONbs,RLATbs , str_I1;
								Rad2Str(RLON,RLAT, &RLONbs,&RLATbs);

								CString P_out, IDst_out, allotkey_out;
								if(GENERIC==1)	P_out.Format(_T("%0.1lf,%0.3lf,%0.3lf,%0.6lf,%d"), L,EminW,CNFSmax,PMmin,0);
								else			P_out.Format(_T("%0.1lf,%0.3lf,%0.3lf,%0.6lf,%0.6lf"), L,EminW,CNFSmax,PMmin,LPM);

								int Nas, Nal;
								str_I1 = QGE06_IntFrom_Q1(IDst_I,SfnID_I,NET_I, PEC_I,allotkey_I, AssocAllotID_I,
									AdmRefID_I, adm_I,ctry_I,SiteName_I, NoticeType_I,AssignCode_I,Freq_I,Pol_I,
									RLONbs, RLATbs, P_out,
									&IDst_out, &Nas,&allotkey_out, &Nal); 

								str_I = str_I + _T(",") + str_I1;
								Nstr_I = Nstr_I + (Nas+Nal);

								strAS_I = strAS_I + _T(",") + IDst_out ;
								strAL_I = strAL_I + _T(",") + allotkey_out ;

								NstrAS_I = NstrAS_I + Nas;
								NstrAL_I = NstrAL_I + Nal;
							}
						}//if(PR>-999)

					}//if(IDflag == 0)
					progress_char = str_rep("I",(int)((++progress_num)*50.0/(Nrowy)) );
					progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*progress_num/(Nrowy)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				}//for i_I<Nrowy
				if(Nstr_I>0)
				{
					str_I.Delete(0);
					CGE06repDLG1 dlgList;
					dlgList.m_dataX = str_W;
					dlgList.m_dataY = str_I;
					dlgList.m_rowsX = nstr_W+1;
					dlgList.m_rowsY = 1+Nstr_I;
					dlgList.m_mode = 13;
					dlgList.m_Bdisplay = 0;
					dlgList.m_title1 = _Z("GE06 Interference FXM from BC-BT");
					dlgList.m_title3 = _Z("Interferer Assignments/Allotments :");
					dlgList.m_title2 = _Z("Victim FXM Stations :");
					dlgList.DoModal();
				}//if(Nstr_W>0)
			}//if(Nrowy>0)

			delete [] lat_TP;
			delete [] lon_TP;
		}//if intDLG

	}//if Sel_W
	Set_STtable_Default();
	EndWaitCursor();
}

BOOL CSMS4DCView::CrossPoint(double lat1,double lon1,double lat2,double lon2 , double *latN,double *lonN,long N
							 , double *latC,double *lonC) 
{
//	double pi = 4.0*atan(1.0);
	float RLON1 = (float)(lon1*pi/180.0),	  RLAT1 = (float)(lat1*pi/180.0),
		  RLON2 = (float)(lon2*pi/180.0),	  RLAT2 = (float)(lat2*pi/180.0);

	long n1=2;
	float  CRDLN1[2][2] = {RLON1, RLAT1, RLON2, RLAT2};
	float (*CRDLN2)[2];	CRDLN2 = new float[N][2];
	for(long i=0;i<N;i++)
	{
		CRDLN2[i][0] = (float)((pi/180.0)*lonN[i]);
		CRDLN2[i][1] = (float)((pi/180.0)*latN[i]);
	}

	float CROSVEK[1][2];
	long C180=0, IEND=2, MAXCROS=1, CROSS, IREST;
	GEOC2L( (float *)CRDLN1, &n1, (float *)CRDLN2, &N,	&C180, &IEND, (float *)CROSVEK,  &MAXCROS, &CROSS, &IREST);
	if(CROSS>0)
	{
		*lonC = (180.0/pi)*CROSVEK[0][0];
		*latC = (180.0/pi)*CROSVEK[0][1];
		return TRUE;
	}

	delete [] CRDLN2;
	return FALSE;
}

void CSMS4DCView::Vec2NearPoint(double lat[], double lon[] ,long N, double lat0, double lon0 ,
								double *Nlat, double *Nlon) 
{
	double DistLimit = 999999999999 , Dist1;
	for(long jTP=0;jTP<N;jTP++)
	{
		Dist1 = Distance_km(lat0,lon0,lat[jTP],lon[jTP]);
		DistLimit = min(DistLimit , Dist1);
		if(DistLimit == Dist1)
		{
			*Nlat = lat[jTP];		*Nlon = lon[jTP];
		}
	}
}

int CSMS4DCView::GE06Zones(double lat01, double lon01 , double lat02, double lon02,double *zDist) 
{
	double pi=4.*atan(1.);
	float RLON1 = (float)(lon01*pi/180.0),	  RLAT1 = (float)(lat01*pi/180.0),
		  RLON2 = (float)(lon02*pi/180.0),	  RLAT2 = (float)(lat02*pi/180.0);

	unsigned char PRCODVEK[2*10];
	float RDIST , PRDVEK[10], RATIOVEK[10];
	long IZONES , IER;

	GEOPRCP( &RLON1, &RLAT1, &RLON2, &RLAT2, &RDIST, &IZONES, (unsigned char *)PRCODVEK, (float *)PRDVEK, (float *)RATIOVEK, &IER);

	for(int i=0;i<IZONES;i++)
	{
		zDist[i] = ((IER==0) ? PRDVEK[i] : 0.0);
	}
	return IER;
}

void CSMS4DCView::LoadMap_IDWM2p(int plan,double lat01, double lon01 , double lat02, double lon02) 
{
	double pi=4.*atan(1.);
	float RLON1 = (float)(lon01*pi/180.0),	  RLAT1 = (float)(lat01*pi/180.0),
		  RLON2 = (float)(lon02*pi/180.0),	  RLAT2 = (float)(lat02*pi/180.0);

	long N = plan,IER;
	GEOPRMS(&N, &IER);
	long IVAL = 2 , IRANGE = 1500,  NRPNT = 2;
	float  ARRAY[2][2] = {RLON1, RLAT1, RLON2, RLAT2},  WND[2][2];
	GEOWND( (float *)ARRAY, &NRPNT, (float *)WND);
	GEOPRM( &IVAL, (float *)WND, &IRANGE);
}

void CSMS4DCView::LoadMap_IDWMpr(int plan,double lat01, double lon01 , double range) 
{
	double pi=4.*atan(1.);
	float RLON1 = (float)(lon01*pi/180.0),		RLAT1 = (float)(lat01*pi/180.0);

	long N = plan,IER;
	GEOPRMS(&N, &IER);
	long IVAL = 1 , IRANGE = (long)range;
	float  ARRAY[2][2] = {RLON1, RLAT1, RLON1, RLAT1};
	GEOPRM( &IVAL, (float *)ARRAY, &IRANGE);
}

double CSMS4DCView::E_P1546_06(double latST,double lonST,double lat0,double lon0,double h1,
						  double HasglST, double f_MHz, double kfactor,
						  double Ptime,double RxH,int ENV,int syst,double Plocation,
						  int P1546Clangle)
{
	double zDist[9] , Ei[9] , Eb = -999.0;

//	CString Zones[9] = {"1","2","3","4","5","A","B","C","D",};
	char Zones[10] = {"12345ABCD"};
	
	int IER = 1;
	IER = GE06Zones(latST,lonST,lat0,lon0,zDist) ;
	if(IER==0)
	{
		CSMS4DCDoc* pDoc=(CSMS4DCDoc*)GetDocument();

		double dist , az , lat15km , lon15km , StepRes , Ebfs;
		double /*pi = 4.0*atan(1.0)  ,*/  rearth = 6371.0  , tetamax15 = 0 , m_ZoomFactor = 1,corr_ca = 0;
		double tetai , mds , ds , hi, azI , mdz , dz , tetamax16 , hii,hir,ttca;	

		CP154606_Functions CP154606;
		dist = Distance_km(latST,lonST,lat0,lon0);
		dist = max(dist,0.00001);
		az = Azimuth_Deg(latST,lonST,lat0,lon0);
//		OnDatabaseStationsindesktop2(latST,lonST);
		///////////////////////////////// tetamax15 /////////////////////////////////////////////
		if (h1<0.0)
		{
			OnDatabaseStationsindesktop2(latST,lonST);

			StepRes = 1.0/m_ZoomFactor;
			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
				StepRes = (pDoc->m_Resolution_x/1000.0)/m_ZoomFactor;

			tetai=-pi/2.0;
			mds=m_ZoomFactor*min(dist,15.0);
			ds=0.0;
			while( ds< mds )  //ds=0->15
			{
				ds = ds+StepRes;
				reckon( latST,lonST, ds , az , &lat15km , &lon15km) ;
				hi = LatLon2Hg(lat15km , lon15km) ;
				tetai=max(tetai   ,(((hi-HasglST)/(ds*1000.0))-(ds/(2.0*kfactor*rearth))));
			}
			tetamax15 = (180.0/pi)*tetai;
		}
		/////////////////////////////////Rx ttca /////////////////////////////////////////////
		if (P1546Clangle==1)
		{
			StepRes = 1.0/m_ZoomFactor;
			CString globeTileInfo = m_AppPath + _T("Texts\\globe.txt");
			if (pDoc->TileInfo != globeTileInfo)
				StepRes = (pDoc->m_Resolution_x/1000.0)/m_ZoomFactor;

			OnDatabaseStationsindesktop2(lat0,lon0);

			hir = LatLon2Hg(lat0,lon0) ;
			azI=Azimuth_Deg(lat0,lon0,latST,lonST);
			mdz=m_ZoomFactor*min(dist,16.0);
			tetamax16=-pi/2.0;
			dz=0.0;
			while( dz< mdz )  //dz=0->16
			{
				dz=dz+StepRes;
				reckon(lat0,lon0, dz , azI , &lat15km , &lon15km) ;
				hii = LatLon2Hg(lat15km , lon15km) ;
				tetamax16=max(tetamax16   ,(((hii-10.0-hir)/(dz*1000))-(dz/(2.0*kfactor*rearth))));
			}
			ttca = tetamax16*(180.0/pi);
			corr_ca = TCAcorr1546(ttca,f_MHz);
		}

		double dlT  , dsT , EDli  , EDsi;
		for(int i=0;i<9;i++)
		{
			if(zDist[i]>0)
			{
				Ei[i] = CP154606.P1546_6(f_MHz,Ptime,Zones[i],h1,dist,RxH,ENV,tetamax15,syst,Plocation,&Ebfs);
				Ei[i] = Ei[i] + corr_ca;
				Ei[i] = min(Ei[i],Ebfs);
			}
			else
				Ei[i] = 0;
		}
		dlT = zDist[0] + zDist[1] + zDist[2] + zDist[8];
		EDli = zDist[0]*Ei[0] + zDist[1]*Ei[1] + zDist[2]*Ei[2] + zDist[8]*Ei[8];

		dsT = zDist[3] + zDist[4] + zDist[5] + zDist[6] + zDist[7];
		EDsi = zDist[3]*Ei[3] + zDist[4]*Ei[4] + zDist[5]*Ei[5] + zDist[6]*Ei[6] + zDist[7]*Ei[7];

		if	   (dsT==0)	Eb = EDli/dlT;
		else if(dlT==0)	Eb = EDsi/dsT;
		else
		{
			double Fs = dsT/dist;

		//	double A0 = CP154606.F_A_2_1_2(Fs,Ptime);
		//	double A0 = CP154606.F_A_2_1_2n(Fs);
			double A0 = 1.0 - pow((1.0 - Fs) , 2.0/3.0);

			double delta = (EDsi/dsT) - (EDli/dlT);
			double V = max(1.0 , 1.0 + delta/40.0);
			double A = pow(A0 , V);
			Eb = ((1.0-A)*EDli/dlT) + (A*EDsi/dsT);
		}
	}
	return Eb;	//dBuV/m
}

double CSMS4DCView::CNFS_Function_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
								double GeoLat_I,double GeoLon_I,double Freq_I, CString Pol_I, CString Hagl_I,
								CString AntDir_I, CString AntCatID_I, CString ERP_h_dbw_I,CString ERP_v_dbw_I,
								double latCal,double lonCal,double CF,double  PRC,double  PRT,double  PR,
								int AntDisc, int ENV,double Ti,double kfactor,double A2D) 
{
	double  CNFS,PR0;
	CP154606_Functions CP154606;
	double az_I2Cal = Azimuth_Deg(GeoLat_I,GeoLon_I,latCal,lonCal) ;
/*
	int az0[37];
	for(int i=0;i<=36;i++)		az0[i] = 10*i;
	double attH0_I[37], attV0_I[37];
	if(AntDir_I==_T("D"))
		GE84pattern(atol(AntCatID_I),attH0_I,attV0_I,Pol_I);
	else
		for(int i=0;i<36;i++)
		{
			attH0_I[i] = 0;		attV0_I[i] = 0;
		}
	attH0_I[36] = attH0_I[0];	attV0_I[36] = attV0_I[0];
	double attnH_I2Cal = Interp2(az0,attH0_I,az_I2Cal,37) ;
	double attnV_I2Cal = Interp2(az0,attV0_I,az_I2Cal,37) ;
*/
	double attH0_I[361], attV0_I[361];
	GE06patternT(atol(AntCatID_I), AntDir_I, Pol_I,attH0_I,attV0_I); 
	double attnH_I2Cal = attH0_I[(int)az_I2Cal],	attnV_I2Cal = attV0_I[(int)az_I2Cal];

	double ERPH,ERPV;
	if     (Pol_I==_T("H"))						ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal;
	else if(Pol_I==_T("V"))						ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal-A2D;	ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal-A2D;}
	/////////////////////////// h1_I //////////////////////
	double h1_I, lat3km, lon3km, lat15km, lon15km;
	double dist_I2Cal = Distance_km(GeoLat_I,GeoLon_I,latCal,lonCal) ;

	OnDatabaseStationsindesktop2(GeoLat_I,GeoLon_I);
	double Hasl_I = LatLon2Hg(GeoLat_I,GeoLon_I);
	double Hasgl_I = Hasl_I + atof(Hagl_I);
	
	if (dist_I2Cal>=15.0)
	{
		reckon(GeoLat_I,GeoLon_I,  3.0 , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I, 15.0 , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km , 120);
	}
	else
	{
		reckon(GeoLat_I,GeoLon_I, 0.2*dist_I2Cal , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I,     dist_I2Cal , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km , 120);
	}
	double ATTNantrec = 0, PolAntDisc = 0;
	if(AntDisc==1)
	{
		double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
		double az_Cal2I = Azimuth_Deg(latCal,lonCal,GeoLat_I,GeoLon_I) ;
		double AZMantrec = fabs(az_Cal2W-az_Cal2I);
		if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
		ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
		PolAntDisc = 16;
	}
	double Em = -999, EmH = -999, EmV = -999, EmI = -999;
	Em = E_P1546_06(GeoLat_I,GeoLon_I,latCal,lonCal, h1_I, Hasgl_I, Freq_I, kfactor, Ti, 10, ENV,0,50, 0);

	if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
	else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}

	if     (Pol_W==_T("H"))						EmI = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
	else if(Pol_W==_T("V"))						EmI = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
	else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	EmI = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));

	double EmIT = EmI;
	if(Fragment_W==_T("GE06A"))
	{
		double Em = -999, EmH = -999, EmV = -999, EmI = -999;
		Em = E_P1546_06(GeoLat_I,GeoLon_I,latCal,lonCal, h1_I, Hasgl_I, Freq_I, kfactor, 50, 10, ENV,0,50, 0);

		if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
		else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
		else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;	}

		if     (Pol_W==_T("H"))						EmI = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
		else if(Pol_W==_T("V"))						EmI = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
		else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	EmI = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));

		double EmIC = EmI;
		if((EmIC+PRC)>(EmIT+PRT))	PR0 = PRC;
		else						PR0 = PRT;
	}
	else PR0 = PR;
	CNFS = EmIT + PR0 + CF;
	return CNFS;
}

double CSMS4DCView::CNFS_FunctionAL_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
									double latCal,double lonCal,double Freq_I, CString Pol_I, CString RPC_I,CString RN,
									double lat_TP[],double lon_TP[],long NcontourT,double CF,double PRC,double PRT,double PR,
									int AntDisc, int ENV,double Ti) 
{
	double  CNFS,PR0;
	CP154606_Functions CP154606;
	double latTx[7], lonTx[7] , ERPall[7];
	CString Band_I  = CP154606.GE06_Band(Freq_I);

	double EmITmax = -9999999, EmICmax = -9999999;
	for(long jTP=0;jTP<NcontourT;jTP++)
	{
		int N_Tx = CP154606.Table_RNs(latCal,lonCal, lat_TP[jTP],lon_TP[jTP],Freq_I,Band_I,RPC_I,RN, ERPall,latTx,lonTx) ;

		double ERPH,ERPV, EmIT = 0;
		for(int ASi=0;ASi<N_Tx;ASi++)
		{
			if     (Pol_I==_T("H"))						ERPH = ERPall[ASi];
			else if(Pol_I==_T("V"))						ERPV = ERPall[ASi];
			else if((Pol_I==_T("M"))||(Pol_I==_T("U"))){ERPH = ERPall[ASi]-3.0;	ERPV = ERPall[ASi]-3.0;}
			double ATTNantrec = 0, PolAntDisc = 0;
			if(AntDisc==1)
			{
				double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
				double az_Cal2I = Azimuth_Deg(latCal,lonCal,latTx[ASi],lonTx[ASi]) ;
				double AZMantrec = fabs(az_Cal2W-az_Cal2I);
				if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
				ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
				PolAntDisc = 16;
			}
			double Em = -999, EmH = -999, EmV = -999, Em1 = -999;
			Em = E_P1546_06(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, 0, Freq_I, 4.0/3.0, Ti, 10, ENV,0,50, 0);

			if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
			else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
			else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}
			if     (Pol_W==_T("H"))						Em1 = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
			else if(Pol_W==_T("V"))						Em1 = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
			else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	Em1 = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));
			EmIT = EmIT + pow(10.0 , Em1/10.0);
		}
		EmIT = 10.0*log10(EmIT);
		EmITmax = max(EmITmax,EmIT);

		if(Fragment_W==_T("GE06A"))
		{
			double EmIC = 0;
			for(int ASi=0;ASi<N_Tx;ASi++)
			{
				if     (Pol_I==_T("H"))						ERPH = ERPall[ASi];
				else if(Pol_I==_T("V"))						ERPV = ERPall[ASi];
				else if((Pol_I==_T("M"))||(Pol_I==_T("U"))){ERPH = ERPall[ASi]-3.0;	ERPV = ERPall[ASi]-3.0;}
				double ATTNantrec = 0, PolAntDisc = 0;
				if(AntDisc==1)
				{
					double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
					double az_Cal2I = Azimuth_Deg(latCal,lonCal,latTx[ASi],lonTx[ASi]) ;
					double AZMantrec = fabs(az_Cal2W-az_Cal2I);
					if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
					ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
					PolAntDisc = 16;
				}
				double Em = -999, EmH = -999, EmV = -999, Em1 = -999;
				Em = E_P1546_06(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, 0, Freq_I, 4.0/3.0, 50, 10, ENV,0,50, 0);

				if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
				else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
				else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}
				if     (Pol_W==_T("H"))						Em1 = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
				else if(Pol_W==_T("V"))						Em1 = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
				else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	Em1 = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));
				EmIC = EmIC + pow(10.0 , Em1/10.0);
			}
			EmIC = 10.0*log10(EmIC);
			EmICmax = max(EmICmax,EmIC);
		}
	}
	if(Fragment_W==_T("GE06A"))
	{
		if((EmICmax+PRC)>(EmITmax+PRT))	PR0 = PRC;
		else							PR0 = PRT;
	}
	else PR0 = PR;

	CNFS = EmITmax + PR0 + CF;
	return CNFS;
}

double CSMS4DCView::InterpT(int *D0, double *E0, double d, long num, int LinLog)
{
	double Eb;
	long N ,n1 , n2 , Nm;
	n1 = 0;
	n2 = num - 1;
	N = n2 - n1 + 1;

	if(D0[0] < D0[1])
	{
		if	   (d > D0[num-1])	{n1 = num-2;	n2 = num-1;	}
		else if(d < D0[0])		{n1 = 1;		n2 = 0;		}
		else
		{
			while(N > 2)
			{
				Nm = (n2 - n1)/2 + n1;
				if	   (d > D0[Nm])		n1 = Nm;
				else if(d < D0[Nm])		n2 = Nm;
				else					return E0[Nm];
				N = n2 - n1 + 1;
			}
		}
	}
	else
	{
		if	   (d < D0[num-1])	{n1 = num-2;	n2 = num-1;	}
		else if(d > D0[0])		{n1 = 1;		n2 = 0;		}
		else
		{
			while(N > 2)
			{
				Nm = (n2 - n1)/2 + n1;
				if	   (d < D0[Nm])		n1 = Nm;
				else if(d > D0[Nm])		n2 = Nm;
				else					return E0[Nm];
				N = n2 - n1 + 1;
			}
		}
	}

	if(LinLog==0)	Eb = E0[n1] + (E0[n2] - E0[n1])*(d - D0[n1])/(D0[n2] - D0[n1]);
	else			Eb = E0[n1] + (E0[n2] - E0[n1])*log10(d/D0[n1])/log10(D0[n2]/D0[n1]);
	return Eb;
}


double CSMS4DCView::CNFS_Function_Int_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
								CString NoticeType_W,CString RXMode_W,CString RPC_W,
								double GeoLat_I,double GeoLon_I,double Freq_I, CString Pol_I, CString Hagl_I,
								CString AntDir_I, CString AntCatID_I, CString ERP_h_dbw_I,CString ERP_v_dbw_I,
								double latCal,double lonCal,double CF,double  PR,
								int AntDisc, int ENV,double Ti,double kfactor,double A2D) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	double az_I2Cal = Azimuth_Deg(GeoLat_I,GeoLon_I,latCal,lonCal) ;
/*
	int az0[37];
	for(int i=0;i<=36;i++)		az0[i] = 10*i;
	double attH0_I[37], attV0_I[37];
	if(AntDir_I==_T("D"))
		GE84pattern(atol(AntCatID_I),attH0_I,attV0_I,Pol_I);
	else
		for(int i=0;i<36;i++)
		{
			attH0_I[i] = 0;		attV0_I[i] = 0;
		}
	attH0_I[36] = attH0_I[0];	attV0_I[36] = attV0_I[0];
	double attnH_I2Cal = Interp2(az0,attH0_I,az_I2Cal,37) ;
	double attnV_I2Cal = Interp2(az0,attV0_I,az_I2Cal,37) ;
*/
	double attH0_I[361], attV0_I[361];
	GE06patternT(atol(AntCatID_I), AntDir_I, Pol_I,attH0_I,attV0_I); 
	double attnH_I2Cal = attH0_I[(int)az_I2Cal];
	double attnV_I2Cal = attV0_I[(int)az_I2Cal];

	double ERPH,ERPV;
	if     (Pol_I==_T("H"))						ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal;
	else if(Pol_I==_T("V"))						ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal-A2D;	ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal-A2D;}
	/////////////////////////// h1_I //////////////////////
	double h1_I, lat3km, lon3km, lat15km, lon15km;
	double dist_I2Cal = Distance_km(GeoLat_I,GeoLon_I,latCal,lonCal) ;

	OnDatabaseStationsindesktop2(GeoLat_I,GeoLon_I);
	double Hasl_I = LatLon2Hg(GeoLat_I,GeoLon_I);
	double Hasgl_I = Hasl_I + atof(Hagl_I);

	if (dist_I2Cal>=15.0)
	{
		reckon(GeoLat_I,GeoLon_I,  3.0 , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I, 15.0 , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km,120);
	}
	else
	{
		reckon(GeoLat_I,GeoLon_I, 0.2*dist_I2Cal , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I,     dist_I2Cal , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km,120);
	}
	double ATTNantrec = 0, PolAntDisc = 0;
	if((AntDisc==1)&&((NoticeType_W==_T("DT1"))||(NoticeType_W==_T("GT1")))&&((RXMode_W==_T("FX"))||(RPC_W==_T("RPC1"))))
	{
		double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
		double az_Cal2I = Azimuth_Deg(latCal,lonCal,GeoLat_I,GeoLon_I) ;
		double AZMantrec = fabs(az_Cal2W-az_Cal2I);
		if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
		ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
		PolAntDisc = 16;
	}
	double Em = -999, EmH = -999, EmV = -999, EmI = -999;
	Em = E_P1546_06(GeoLat_I,GeoLon_I,latCal,lonCal, h1_I, Hasgl_I, Freq_I, kfactor, Ti, 10, ENV,0,50, 0);

	if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
	else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}

	if     (Pol_W==_T("H"))						EmI = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
	else if(Pol_W==_T("V"))						EmI = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
	else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	EmI = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));

	double EmIT = EmI;

	CNFS = EmIT + PR + CF;
	return CNFS;
}

double CSMS4DCView::CNFS_FunctionAL_Int_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
									CString NoticeType_W,CString RXMode_W,CString RPC_W,
									double latCal,double lonCal,double Freq_I, CString Pol_I, CString RPC_I,CString RN,
									double lat_TP[],double lon_TP[],long NcontourT,double CF,double PR,
									int AntDisc, int ENV,double Ti) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	double latTx[7], lonTx[7] , ERPall[7];
	CString Band_I  = CP154606.GE06_Band(Freq_I);

	double EmITmax = -9999999;
	for(long jTP=0;jTP<NcontourT;jTP++)
	{
		int N_Tx = CP154606.Table_RNs(latCal,lonCal, lat_TP[jTP],lon_TP[jTP],Freq_I,Band_I,RPC_I,RN, ERPall,latTx,lonTx) ;

		double ERPH,ERPV, EmIT = 0;
		for(int ASi=0;ASi<N_Tx;ASi++)
		{
			if     (Pol_I==_T("H"))						ERPH = ERPall[ASi];
			else if(Pol_I==_T("V"))						ERPV = ERPall[ASi];
			else if((Pol_I==_T("M"))||(Pol_I==_T("U"))){ERPH = ERPall[ASi]-3.0;	ERPV = ERPall[ASi]-3.0;}
			double ATTNantrec = 0, PolAntDisc = 0;
			if((AntDisc==1)&&((NoticeType_W==_T("DT1"))||(NoticeType_W==_T("GT1")))&&((RXMode_W==_T("FX"))||(RPC_W==_T("RPC1"))))
			{
				double az_Cal2W = Azimuth_Deg(latCal,lonCal,GeoLat_W,GeoLon_W) ;
				double az_Cal2I = Azimuth_Deg(latCal,lonCal,latTx[ASi],lonTx[ASi]) ;
				double AZMantrec = fabs(az_Cal2W-az_Cal2I);
				if(AZMantrec>180)	AZMantrec = 360.0 - AZMantrec;
				ATTNantrec = CP154606.F_3_1_BT419(AZMantrec,Freq_W) ;	//Fig.3-1 REC BT.419
				PolAntDisc = 16;
			}
			double Em = -999, EmH = -999, EmV = -999, Em1 = -999;
			Em = E_P1546_06(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, 0, Freq_I, 4.0/3.0, Ti, 10, ENV,0,50, 0);

			if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
			else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
			else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}
			if     (Pol_W==_T("H"))						Em1 = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
			else if(Pol_W==_T("V"))						Em1 = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
			else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	Em1 = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));
			EmIT = EmIT + pow(10.0 , Em1/10.0);
		}
		EmIT = 10.0*log10(EmIT);
		EmITmax = max(EmITmax , EmIT);
	}
	CNFS = EmITmax + PR + CF;
	return CNFS;
}


double CSMS4DCView::CNFS_Function_FXM_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
								double GeoLat_I,double GeoLon_I,double Freq_I, CString Pol_I, CString Hagl_I,
								CString AntDir_I, CString AntCatID_I, CString ERP_h_dbw_I,CString ERP_v_dbw_I,
								double latCal,double lonCal,double CF,double  PR,
								int AntDisc, int ENV,double Ti,double kfactor,int ant,double hR,
								CString AntDir_W,CString AntCatID_W) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	double az_I2Cal = Azimuth_Deg(GeoLat_I,GeoLon_I,latCal,lonCal) ;
/*
	int az0[37];
	for(int i=0;i<=36;i++)		az0[i] = 10*i;
	double attH0_I[37], attV0_I[37];
	if(AntDir_I==_T("D"))
		GE84pattern(atol(AntCatID_I),attH0_I,attV0_I,Pol_I);
	else
		for(int i=0;i<36;i++)
		{
			attH0_I[i] = 0;		attV0_I[i] = 0;
		}
	attH0_I[36] = attH0_I[0];	attV0_I[36] = attV0_I[0];

	double attnH_I2Cal = Interp2(az0,attH0_I,az_I2Cal,37) ;
	double attnV_I2Cal = Interp2(az0,attV0_I,az_I2Cal,37) ;
*/
	double attH0_I[361], attV0_I[361];
	GE06patternT(atol(AntCatID_I), AntDir_I, Pol_I,attH0_I,attV0_I); 

	double attnH_I2Cal = attH0_I[(int)az_I2Cal];
	double attnV_I2Cal = attV0_I[(int)az_I2Cal];

	double ERPH,ERPV;
	if     (Pol_I==_T("H"))						ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal;
	else if(Pol_I==_T("V"))						ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{ERPH = atof(ERP_h_dbw_I)-attnH_I2Cal;	ERPV = atof(ERP_v_dbw_I)-attnV_I2Cal;}
	/////////////////////////// h1_I //////////////////////
	double h1_I, lat3km, lon3km, lat15km, lon15km;
	double dist_I2Cal = Distance_km(GeoLat_I,GeoLon_I,latCal,lonCal) ;

	OnDatabaseStationsindesktop2(GeoLat_I,GeoLon_I);
	double Hasl_I = LatLon2Hg(GeoLat_I,GeoLon_I);
	double Hasgl_I = Hasl_I + atof(Hagl_I);
	
	if (dist_I2Cal>=15.0)
	{
		reckon(GeoLat_I,GeoLon_I,  3.0 , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I, 15.0 , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km , 120);
	}
	else
	{
		reckon(GeoLat_I,GeoLon_I, 0.2*dist_I2Cal , az_I2Cal , &lat3km  , &lon3km) ;
		reckon(GeoLat_I,GeoLon_I,     dist_I2Cal , az_I2Cal , &lat15km , &lon15km) ;
		h1_I = Hasgl_I - Points2HgAvr1(lat3km, lon3km, lat15km, lon15km , 120);
	}
	double ATTNantrec = 0, PolAntDisc = 0;
	if((AntDisc==1)&&(ant==1))
	{
		double az_Cal2I = Azimuth_Deg(latCal,lonCal,GeoLat_I,GeoLon_I) ;
/*
		double attH0_W[37], attV0_W[37];
		if(AntDir_W==_T("D"))
			GE84pattern(atol(AntCatID_W),attH0_W,attV0_W,Pol_W);
		else
			for(int i=0;i<36;i++)
			{
				attH0_W[i] = 0;		attV0_W[i] = 0;
			}
		attH0_W[36] = attH0_W[0];	attV0_W[36] = attV0_W[0];

		if     (Pol_W==_T("H"))		ATTNantrec = Interp2(az0,attH0_W,az_Cal2I,37);
		else if(Pol_W==_T("V"))		ATTNantrec = Interp2(az0,attV0_W,az_Cal2I,37);
*/
		double attH0_W[361], attV0_W[361];
		GE06patternT(atol(AntCatID_W), AntDir_W, Pol_W,attH0_W,attV0_W); 
		if     (Pol_W==_T("H"))		ATTNantrec = attH0_W[(int)az_Cal2I];
		else if(Pol_W==_T("V"))		ATTNantrec = attV0_W[(int)az_Cal2I];

		PolAntDisc = QGE06_XPD(atol(AntCatID_W)); 
	}
	double Em = -999, EmH = -999, EmV = -999, EmI = -999;
	Em = E_P1546_06(GeoLat_I,GeoLon_I,latCal,lonCal, h1_I, Hasgl_I, Freq_I, kfactor, Ti, hR, ENV,0,50, 0);

	if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
	else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
	else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}

	if     (Pol_W==_T("H"))						EmI = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
	else if(Pol_W==_T("V"))						EmI = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
	else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	EmI = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));

	double EmIT = EmI;

	CNFS = EmIT + PR + CF;
	return CNFS;
}

double CSMS4DCView::CNFS_FunctionAL_FXM_0(double GeoLat_W,double GeoLon_W,double Freq_W, CString Pol_W, CString Fragment_W,
									double latCal,double lonCal,double Freq_I, CString Pol_I, CString RPC_I,CString RN,
									double lat_TP[],double lon_TP[],long NcontourT,double CF,double PR,
									int AntDisc, int ENV,double Ti,int ant,double hR,
									CString AntDir_W,CString AntCatID_W) 
{
	double  CNFS;
	CP154606_Functions CP154606;
	double latTx[7], lonTx[7] , ERPall[7];
	CString Band_I  = CP154606.GE06_Band(Freq_I);

	double attH0_W[361], attV0_W[361];
//	int az0[37];
//	for(int i=0;i<=36;i++)		az0[i] = 10*i;

	double EmITmax = -9999999;
	for(long jTP=0;jTP<NcontourT;jTP++)
	{
		int N_Tx = CP154606.Table_RNs(latCal,lonCal, lat_TP[jTP],lon_TP[jTP],Freq_I,Band_I,RPC_I,RN, ERPall,latTx,lonTx) ;

		double ERPH,ERPV, EmIT = 0;
		for(int ASi=0;ASi<N_Tx;ASi++)
		{
			if     (Pol_I==_T("H"))						ERPH = ERPall[ASi];
			else if(Pol_I==_T("V"))						ERPV = ERPall[ASi];
			else if((Pol_I==_T("M"))||(Pol_I==_T("U"))){ERPH = ERPall[ASi]-3.0;	ERPV = ERPall[ASi]-3.0;}
			double ATTNantrec = 0, PolAntDisc = 0;
			if((AntDisc==1)&&(ant==1))
			{
				double az_Cal2I = Azimuth_Deg(latCal,lonCal,latTx[ASi],lonTx[ASi]);
/*
				if(AntDir_W==_T("D"))
					GE84pattern(atol(AntCatID_W),attH0_W,attV0_W,Pol_W);
				else
					for(int i=0;i<36;i++)
					{
						attH0_W[i] = 0;		attV0_W[i] = 0;
					}
				attH0_W[36] = attH0_W[0];	attV0_W[36] = attV0_W[0];

				if     (Pol_W==_T("H"))		ATTNantrec = Interp2(az0,attH0_W,az_Cal2I,37);
				else if(Pol_W==_T("V"))		ATTNantrec = Interp2(az0,attV0_W,az_Cal2I,37);
*/
				GE06patternT(atol(AntCatID_W), AntDir_W, Pol_W,attH0_W,attV0_W); 
				if     (Pol_W==_T("H"))		ATTNantrec = attH0_W[(int)az_Cal2I];
				else if(Pol_W==_T("V"))		ATTNantrec = attV0_W[(int)az_Cal2I];

				PolAntDisc = QGE06_XPD(atol(AntCatID_W)); 
			}
			double Em = -999, EmH = -999, EmV = -999, Em1 = -999;
			Em = E_P1546_06(latTx[ASi],lonTx[ASi],latCal,lonCal, 150, 0, Freq_I, 4.0/3.0, Ti, hR, ENV,0,50, 0);

			if     (Pol_I==_T("H"))						EmH = Em - 30.0 + ERPH;
			else if(Pol_I==_T("V"))						EmV = Em - 30.0 + ERPV;
			else if((Pol_I==_T("M"))||(Pol_I==_T("U")))	{EmH = Em - 30.0 + ERPH;	EmV = Em - 30.0 + ERPV;}
			if     (Pol_W==_T("H"))						Em1 = 10.0*log10(pow(10.0 , (EmH-ATTNantrec)/10.0) + pow(10.0 , (EmV-PolAntDisc)/10.0));
			else if(Pol_W==_T("V"))						Em1 = 10.0*log10(pow(10.0 , (EmH-PolAntDisc)/10.0) + pow(10.0 , (EmV-ATTNantrec)/10.0));
			else if((Pol_W==_T("M"))||(Pol_W==_T("U")))	Em1 = 10.0*log10(pow(10.0 , EmH/10.0) + pow(10.0 , EmV/10.0));
			EmIT = EmIT + pow(10.0 , Em1/10.0);
		}
		EmIT = 10.0*log10(EmIT);
		EmITmax = max(EmITmax , EmIT);
	}
	CNFS = EmITmax + PR + CF;
	return CNFS;
}

void CSMS4DCView::GE06pattern(long AntID,double * attnH,double * attnV,CString pol) 
{
	CString  m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CDatabase m_mydb;
	if (m_mydb.Open(_T(m_DB),FALSE,FALSE, "ODBC;", FALSE))
	{
		int kH, kV, i , azmH[361], azmV[361]; 
		CString ss;
		double attnH0[361] , attnV0[361];

		if((pol==_T("H"))||(pol==_T("M"))||(pol==_T("U")))
		{
			CRecordset m_rs;
			CString	m_Tbl ;
			m_Tbl.Format(_T("select * from antdiag WHERE (AntID=%ld AND Polar=\'%s\') order by Azm;"),AntID,_T("H"));
			m_rs.m_pDatabase = &m_mydb;
			m_rs.Open( CRecordset::snapshot, m_Tbl);
			kH = 0;
			if(m_rs.GetRecordCount()==1)
			{
				while(!m_rs.IsEOF())
				{
					m_rs.MoveNext();	kH++;
				}
				m_rs.MoveFirst();
				for (i=0; i<kH; i++)
				{
					m_rs.GetFieldValue(_T("Azm"),ss);	azmH[i] = atof(ss);
					m_rs.GetFieldValue(_T("Attn"),ss);	attnH0[i] = atof(ss);
					if(pol==_T("H"))
					{
						attnV0[i] = 0.0;	azmV[i] = azmH[i];
					}
					m_rs.MoveNext();
				}
				m_rs.Close();
			}
			else
			{
				CString str1;
				str1.Format(_Z("\nThe Antenna Pattern is not found!!!      \n Antenna ID : ''  %ld  '' \n Polarization : ''  %s  ''\n Please assign a valid antenna.\n"),AntID,pol);
				MessageBox(str1,_Z("Error!!!"), MB_ICONERROR);
				exit(1);
			}
		}
		if((pol==_T("V"))||(pol==_T("M"))||(pol==_T("U")))
		{
			CRecordset m_rs1;
			CString	m_Tbl1 ;
			m_Tbl1.Format(_T("select * from antdiag WHERE (AntID=%ld AND Polar=\'%s\') order by Azm;"),AntID,_T("V"));
			m_rs1.m_pDatabase = &m_mydb;
			m_rs1.Open( CRecordset::snapshot, m_Tbl1);
			kV = 0;
			if(m_rs1.GetRecordCount()==1)
			{
				while(!m_rs1.IsEOF())
				{
					m_rs1.MoveNext();	kV++;
				}
				m_rs1.MoveFirst();
				for (i=0; i<kV; i++)
				{
					m_rs1.GetFieldValue(_T("Azm"),ss);	azmV[i] = atof(ss);
					m_rs1.GetFieldValue(_T("Attn"),ss);	attnV0[i] = atof(ss);

					if(pol==_T("V"))
					{
						attnH0[i] = 0.0;		azmH[i] = azmV[i];
					}
					m_rs1.MoveNext();
				}
				m_rs1.Close();
			}
			else
			{
				CString str1;
				str1.Format(_Z("\nThe Antenna Pattern is not found!!!      \n Antenna ID : ''  %ld  '' \n Polarization : ''  %s  ''\n Please assign a valid antenna.\n"),AntID,pol);
				MessageBox(str1,_Z("Error!!!"), MB_ICONERROR);
				exit(1);
			}
		}
		m_mydb.Close();

		if(pol==_T("H"))	kV = kH;
		if(pol==_T("V"))	kH = kV;
		azmH[kH] = 360;				azmV[kV] = 360;
		attnH0[kH] = attnH0[0];		attnV0[kV] = attnV0[0];

		for (i=0;i<360;i++)
		{
			attnH[i] = Interp2(azmH,attnH0,i,kH+1) ;
			attnV[i] = Interp2(azmV,attnV0,i,kV+1) ;
		}
	}	
}

void CSMS4DCView::GE84patternT(long AntCatID, CString AntDir, CString Pol,int * az0,double * attH0,double * attV0) 
{
	for(int i=0;i<=36;i++)		az0[i] = 10*i;

	if(AntDir==_T("D"))
		GE84pattern(AntCatID,attH0,attV0,Pol);
	else
	{
		for(int i=0;i<36;i++)
		{
			attH0[i] = 0;		attV0[i] = 0;
		}
	}
	attH0[36] = attH0[0];		attV0[36] = attV0[0];
}

void CSMS4DCView::GE06patternT(long AntCatID, CString AntDir, CString Pol,double * attH0,double * attV0) 
{
	if(AntDir==_T("D"))
		GE06pattern(AntCatID,attH0,attV0,Pol);
	else
	{
		for(int i=0;i<360;i++)
		{
			attH0[i] = 0;		attV0[i] = 0;
		}
	}
	attH0[360] = attH0[0];		attV0[360] = attV0[0];
}

///////////////////////////////////////////////////////////////////////////////
/////////////////////////////Google Earth//////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
void CSMS4DCView::OnToolsGoogleSelectedstations() 
{
	CDataBaseLDLG dbdlg;
	if ((dbdlg.DoModal()) == IDOK)
	{
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\Stations.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));

				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:Station(s):%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				double lat1,lon1;			CString name1 , m_Sel;			long ID;
				for (int i=0;i<Nrow;i++)
				{
					m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					if (m_Sel.GetLength()>0)
					{
						ID = atol(GetFld(m_Sel,1)); name1 = GetFld(m_Sel,2); lat1 = atof(GetFld(m_Sel,3)); lon1 = atof(GetFld(m_Sel,4));
						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name1,gifFile ,lon1,lat1);
						fprintf(fp2,_T("%s \n"),str2);

					}//if
				}//for
				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave
		}//if (Nrow>0)
	}//if dbdlg
}

void CSMS4DCView::OnToolsGoogleLinks() 
{
//	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from Q_Links;");
	CString CDataBaseSTR;	 CDataBaseSTR.Format( _T("select * from %s;") , m_qQ_Links );
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;

	CDataBaseLDLG dbdlg;
	dbdlg.m_Title = _T("Link Table");
	if ((dbdlg.DoModal()) == IDOK)
	{
		CString Sel;
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\Links.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));

				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:Link(s):%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				long TxID , RxID, HID;
				double TxLat, TxLon, RxLat, RxLon, TxAlt, RxAlt;
				CString TxName, RxName;
				for (int i=0;i<Nrow;i++)
				{
					Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					if (Sel!=_T(""))
					{
						HID = atol(GetFld(Sel,1));

						TxID = atol(GetFld(Sel,2));		TxName = GetFld(Sel,3);
						TxLat  = atof(GetFld(Sel,4));	TxLon  = atof(GetFld(Sel,5));	TxAlt  = atof(GetFld(Sel,8));

						RxID = atol(GetFld(Sel,15));	RxName = GetFld(Sel,16);
						RxLat  = atof(GetFld(Sel,17));	RxLon  = atof(GetFld(Sel,18));	RxAlt  = atof(GetFld(Sel,21));

						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),TxName,gifFile ,TxLon,TxLat);
						fprintf(fp2,_T("%s \n"),str2);
						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),RxName,gifFile ,RxLon,RxLat);
						fprintf(fp2,_T("%s \n"),str2);
						str2.Format(_T("<Placemark><name>%s_%s</name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>%lf,%lf,%lf %lf,%lf,%lf</coordinates></LineString></Placemark>"),TxName,RxName,TxLon,TxLat,TxAlt ,RxLon,RxLat,RxAlt);
						fprintf(fp2,_T("%s \n"),str2);

					}//if
				}//for
				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave
		}//if (Nrow>0)
	}//if dbdlg
	Set_STtable_Default();	
}

void CSMS4DCView::OnToolsGoogleSelectedearthstations() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");
	CDataBaseLDLG dbdlg;
	int xxDLG = dbdlg.DoModal();
	if (xxDLG == IDOK)
	{
		CString m_Sel;
		int Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow>0)
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\EarthStations.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\est.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));

				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:Earth Station(s):%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				double lat1,lon1;		CString name1;			long ID;
				for (int i=0;i<Nrow;i++)
				{
					m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
					if (m_Sel!="")
					{
						ID = atol(GetFld(m_Sel,1));				name1 = GetFld(m_Sel,2);
						lat1  = atof(GetFld(m_Sel,22));			lon1  = atof(GetFld(m_Sel,21));

						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name1,gifFile ,lon1,lat1);
						fprintf(fp2,_T("%s \n"),str2);

					}//if
				}//for
				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave
		}//if (Nrow>0)
	}//if xxDLG
	Set_STtable_Default();	
}


CString CSMS4DCView::Vector2Placemark(CString Vector_filepath) 
{
	CString strStart,strStop,strBetween, FF0 = _T(""), strOut = _T("");
	strStart.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>\n"));
	strStop.Format(_T("</coordinates></LineString></Placemark>\n"));
	strBetween = strStop + strStart;
	if (!Vector_filepath.IsEmpty())
	{
		FILE *fp;
		if ( (fp = fopen(Vector_filepath,"rt")) != NULL )
		{
			CString dataLon,dataLat;
			char bfLon[200], bfLat[200];
			while( !feof( fp ) )
			{
				fscanf( fp, "%s %s", bfLon,bfLat);
				dataLon = bfLon;  dataLat = bfLat;
				if (dataLon==_T("NaN"))		FF0 = _T("  NaN  ");
				else						FF0.Format("%s,%s,%lf ",dataLon, dataLat,0.0);
				strOut = strOut + FF0;
			}
			fclose(fp);
		}//if fp
	}
	strOut.Replace(_T("  NaN  "),strBetween);
	strOut = strStart + strOut + strStop;
	return strOut;
}
void CSMS4DCView::OnToolsGoogleReceivingarea() 
{
	CString CDataBaseSTR;
//	CDataBaseSTR.Format(_T("SELECT STtableGE06.IDst, STtableGE06.STname, STtableGE06.STlat_deg, STtableGE06.STlon_deg, Link.GeoType, Link.RecLat, Link.RecLon, Link.Radius, Link.zone, Link.lat1, Link.lon1, Link.lat2, Link.lon2, Link.lat3, Link.lon3, Link.lat4, Link.lon4, Link.lat5, Link.lon5, Link.lat6, Link.lon6 FROM Link, STtableGE06 WHERE (((STtableGE06.IDst)=[Link].[TXID]) AND ((Link.GeoType)='ZONE' Or (Link.GeoType)='MULTIPOINT' Or (Link.GeoType)='CIRCLE')) ORDER BY STtableGE06.IDst;"));
	CDataBaseSTR.Format(_T("SELECT STtableGE06.IDst, STtableGE06.STname, STtableGE06.STlat_deg, STtableGE06.STlon_deg, Link.GeoType, Link.RecLat, Link.RecLon, Link.Radius, Link.zone, Link.lat1, Link.lon1, Link.lat2, Link.lon2, Link.lat3, Link.lon3, Link.lat4, Link.lon4, Link.lat5, Link.lon5, Link.lat6, Link.lon6 FROM Link, %s WHERE (((STtableGE06.IDst)=[Link].[TXID]) AND ((Link.GeoType)='ZONE' Or (Link.GeoType)='MULTIPOINT' Or (Link.GeoType)='CIRCLE')) ORDER BY STtableGE06.IDst;") , m_qSTtableGE06);

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG dbdlg;
	if (dbdlg.DoModal() == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow!=1)
		{
			MessageBox(_Z("Please Select One Record."),_Z("ERROR!!!"),MB_ICONERROR);
			Set_STtable_Default();
			EndWaitCursor();
			return;
		}
		CString Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
		if (Sel!=_T(""))
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\RxArea.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));
				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:ReceivingArea:%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				double lat1,lon1;		CString name1;
				long ID1  = atol(GetFld(Sel,1));	name1 = GetFld(Sel,2);
				lat1  = atof(GetFld(Sel,3));		lon1  = atof(GetFld(Sel,4));

				str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name1,gifFile ,lon1,lat1);
				fprintf(fp2,_T("%s \n"),str2);

				CString GeoType = GetFld(Sel,5);
				if(GeoType==_T("CIRCLE"))
				{
					double lat2,lon2 ,latC,lonC,R;
					lat2  = atof(GetFld(Sel,6));	lon2  = atof(GetFld(Sel,7));	R  = atof(GetFld(Sel,8));

					str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
					fprintf(fp2,_T("%s \n"),str2);
					for (int i=0;i<73;i++)
					{
						reckon(lat2,lon2, R , i*5 , &latC , &lonC) ;
						str2.Format(_T("%lf,%lf,%lf "),lonC,latC,0.0);
						fprintf(fp2,_T("%s \n"),str2);
					}
					str2.Format(_T("</coordinates></LineString></Placemark>"));
					fprintf(fp2,_T("%s \n"),str2);
				}
				else if(GeoType==_T("MULTIPOINT"))
				{
					CString latp1  = GetFld(Sel,10) , lonp1  = GetFld(Sel,11);
					CString latp2  = GetFld(Sel,12) , lonp2  = GetFld(Sel,13);
					CString latp3  = GetFld(Sel,14) , lonp3  = GetFld(Sel,15);
					CString latp4  = GetFld(Sel,16) , lonp4  = GetFld(Sel,17);
					CString latp5  = GetFld(Sel,18) , lonp5  = GetFld(Sel,19);
					CString latp6  = GetFld(Sel,20) , lonp6  = GetFld(Sel,21);

					str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
					fprintf(fp2,_T("%s \n"),str2);
					if((latp1.GetLength()>0)&&(lonp1.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp1, latp1,0.0);
					if((latp2.GetLength()>0)&&(lonp2.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp2, latp2,0.0);
					if((latp3.GetLength()>0)&&(lonp3.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp3, latp3,0.0);
					if((latp4.GetLength()>0)&&(lonp4.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp4, latp4,0.0);
					if((latp5.GetLength()>0)&&(lonp5.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp5, latp5,0.0);
					if((latp6.GetLength()>0)&&(lonp6.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp6, latp6,0.0);
					if((latp1.GetLength()>0)&&(lonp1.GetLength()>0))		fprintf(fp2,"%s,%s,%lf \n",lonp1, latp1,0.0);
					str2.Format(_T("</coordinates></LineString></Placemark>"));
					fprintf(fp2,_T("%s \n"),str2);
				}
				else if(GeoType==_T("ZONE"))
				{
					CString zone = GetFld(Sel,9);	CString sFile = VectorCountry(zone) ;
					CString strOut = Vector2Placemark(sFile); 
					fprintf(fp2,_T("%s \n"),strOut);
				}
				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave
		}//if (Sel!=_T(""))
	}//if dbdlg
	Set_STtable_Default();
}


void CSMS4DCView::OnToolsGoogleServiceareafxm() 
{
	CString CDataBaseSTR, Selx = _T("");
//	CDataBaseSTR = _T("SELECT * FROM STtableGE06 WHERE (((AreaOfTrans)<>'')) OR (((radius) Is Not Null And (radius)<>0)) ORDER BY IDst;");
	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE (((AreaOfTrans)<>'')) OR (((radius) Is Not Null And (radius)<>0)) ORDER BY IDst;") , m_qSTtableGE06  );
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Heff1 = FALSE;
	datadlg.m_Title = _T("Select One Station");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow!=1)
		{
			MessageBox(_Z("Please Select One Record."),_Z("ERROR!!!"),MB_ICONERROR);
			Set_STtable_Default();
			EndWaitCursor();
			return;
		}
		else		//if (Nrow==1)
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\SrvArea.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));
				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:ServiceAreaFXM:%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				Selx = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
				CString	zone0 = GetFld(Selx,34);
				double	IDst = atol(GetFld(Selx,1));
				CString	name = GetFld(Selx,2);
				if(zone0.GetLength()>0)
				{
					if(zone0.GetLength()==1)			zone0 = zone0 + _T("  ");
					else if(zone0.GetLength()==2)		zone0 = zone0 + _T(" ");
					CString pathfile = VectorCountry(zone0) ;
					double GRlat, GRlon;
					Zone2GRpoint(zone0 ,&GRlat, &GRlon) ;
				
					str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name,gifFile ,GRlon,GRlat);
					fprintf(fp2,_T("%s \n"),str2);

					CString strOut = Vector2Placemark(pathfile); 
					fprintf(fp2,_T("%s \n"),strOut);
				}
				else
				{
					double	lat = atof(GetFld(Selx,3)), lon = atof(GetFld(Selx,4));
					CString	r = GetFld(Selx,22);
					if(r.GetLength()>0)
					{
						double latC,lonC;
						str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name,gifFile ,lon,lat);
						fprintf(fp2,_T("%s \n"),str2);

						str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
						fprintf(fp2,_T("%s \n"),str2);
						for (int i=0;i<73;i++)
						{
							reckon(lat,lon, atof(r) , i*5 , &latC , &lonC) ;

							str2.Format(_T("%lf,%lf,%lf "),lonC,latC,0.0);
							fprintf(fp2,_T("%s \n"),str2);
						}
						str2.Format(_T("</coordinates></LineString></Placemark>"));
						fprintf(fp2,_T("%s \n"),str2);
					}
				}//if zone0
				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);

			}//if KmlSave
		}// if  Nrow
	}//if  datadlg
	Set_STtable_Default();
}

void CSMS4DCView::OnToolsGoogleServiceareage06bcbt() 
{
	CString str = QGE06_Showsrvbcbt();
	if(str.GetLength()>0)
	{
		long IDst = atol(GetFld(str,1));
		double lats = atof(GetFld(str,2)),	lons = atof(GetFld(str,3));
		CString name = GetFld(str,4);

		CString  tbl , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
		CDatabase DB1;	CRecordset rs;
		DB1.Open(m_DB,false,false,_T("ODBC;"),false);
		rs.m_pDatabase = &DB1;
		tbl.Format(_T("SELECT IDst, SiteName, GeoLat, GeoLon FROM CSArea WHERE (((IDst)=%ld));"), IDst);

		double lat,lon;
		rs.Open(CRecordset::snapshot, tbl);
		if(rs.GetRecordCount() == 1)
		{
			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\SrvArea.kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));
				CString str1,str2;
				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:ServiceAreaBCBT:%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),name,gifFile ,lons,lats);
				fprintf(fp2,_T("%s \n"),str2);

				rs.MoveFirst();
				
				str2.Format(_T("<Placemark><name></name><Style><LineStyle><color>FF00FFFF</color><width>1</width></LineStyle></Style><LineString><altitudeMode>relativeToGround</altitudeMode><coordinates>"));
				fprintf(fp2,_T("%s \n"),str2);

				int n = 0;
				CString str0;
				while(!rs.IsEOF())
				{
					rs.GetFieldValue(_T("GeoLat"),str);		lat = atof(str);
					rs.GetFieldValue(_T("GeoLon"),str);		lon = atof(str);
					rs.MoveNext();

					str2.Format(_T("%lf,%lf,%lf "),lon,lat,0.0);
					fprintf(fp2,_T("%s \n"),str2);
					if(n==0)	str0 = str2;

					n++;
				}// while
				fprintf(fp2,_T("%s \n"),str0);

				str2.Format(_T("</coordinates></LineString></Placemark>"));
				fprintf(fp2,_T("%s \n"),str2);

				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave
		}//if rs
		rs.Close();	DB1.Close();
	}
	Set_STtable_Default();	
}

void CSMS4DCView::OnToolsGoogleAllotmentarea() 
{
//	CString CDataBaseSTR = _T("SELECT * FROM CommonFields WHERE (((IDst)='---')) order by allotkey;");
	CString CDataBaseSTR;
	CDataBaseSTR.Format( _T("SELECT * FROM %s WHERE (((IDst)='---')) order by allotkey;") , m_qCommonFields );

	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Title = _T("Select One Allotment");
	if (datadlg.DoModal()==IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if (Nrow==1)
		{
			CString Selx = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			CString Name = GetFld(Selx,4);

			CString sFile, sPath;
			CString fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\") + Name + _T(".kml");
			BOOL flagShow = FALSE;
			if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
			{
				sFile.Delete(sFile.GetLength()-4,4);
				fileOUTkml = sPath;

				CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
				FILE *fp2 = fopen(fileOUTkml,_T("wt"));
				CString str1,str2;

				str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:AllotmentArea:%s</name>\n<open>1</open>"),sFile);
				fprintf(fp2,_T("%s\n"),str1);

				CString GeoArea = GetFld(Selx,14),	allotkey = GetFld(Selx,37);
				CString pFile = GE06ShowAllotGoogle(allotkey, GeoArea);

				CString strOut = Vector2Placemark(pFile); 
				fprintf(fp2,_T("%s \n"),strOut);

				fprintf(fp2,_T("</Folder>\n</kml>"));
				fclose(fp2);
				if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
			}//if KmlSave

		}//if  Nrow
		else
		{
			MessageBox(_Z("Please Select One Record."),_Z("ERROR!!!"),MB_ICONERROR);
		}
	}//if  datadlg
	Set_STtable_Default();	
}

CString CSMS4DCView::GE06ShowAllotGoogle(CString allotkey , CString GeoArea) 
{
	CString sFile;	sFile.Format(_T("%s%s%d.tmp") , ((CSMS4DCApp *)AfxGetApp())->m_AppPath , _T("Temp\\tempM") , m_POLYnum);
	FILE *fptemp = fopen(sFile,"wt");
	if(GeoArea.IsEmpty())
	{
		CString contourkeyN , nb_test_ptsN;
		long contourkeyNum = QGE06_BCBT_A3_2(atol(allotkey), &contourkeyN, &nb_test_ptsN);
		for(long i=0;i<contourkeyNum;i++)
		{
			if(i>0)		fprintf(fptemp,"%s\n","NaN  NaN");
			double GRlat , GRlon;	CString lat_tpStr, lon_tpStr;	long contourkey , nb_test_pts , n_tp;
			contourkey  = atol(GetFld(contourkeyN,i+1));
			nb_test_pts = atol(GetFld(nb_test_ptsN,i+1));
			n_tp = QGE06_BCBT_A3_1(contourkey,nb_test_pts,&lat_tpStr,&lon_tpStr,&GRlat, &GRlon);
			if(n_tp>2)
			{
				for(long j=0;j<n_tp;j++)
					fprintf(fptemp,"%0.14lf  %0.14lf\n",atof(GetFld(lon_tpStr,j+1)), atof(GetFld(lat_tpStr,j+1)));
					fprintf(fptemp,"%0.14lf  %0.14lf\n",atof(GetFld(lon_tpStr,1)), atof(GetFld(lat_tpStr,1)));
			}
			else
			{
				CString str;	str.Format("No. of test points is less than 3.\nThe allotment contour can not be shown.");
				MessageBox(str,_Z("Warning!!!"),MB_ICONWARNING);
			}
		}//for  i
	}//if GeoArea.IsEmpty()
	else
	{
		double GRlat , GRlon;		CString lat_tpStr, lon_tpStr;
		long NcontourT = QGE06_BCBT_Aux_Border(GeoArea, &lat_tpStr, &lon_tpStr,&GRlat , &GRlon) ;
		for(long j=0;j<NcontourT;j++)
			fprintf(fptemp,"%0.14lf  %0.14lf\n",atof(GetFld(lon_tpStr,j+1)), atof(GetFld(lat_tpStr,j+1)));
			fprintf(fptemp,"%0.14lf  %0.14lf\n",atof(GetFld(lon_tpStr,1)), atof(GetFld(lat_tpStr,1)));
	}// ! GeoArea.IsEmpty()
	fclose(fptemp);	
				
	return sFile; 
}

void CSMS4DCView::OnToolsGoogleGe06planentry() 
{
	GE06linked_ConvertedGoogle(0);
}

void CSMS4DCView::QGE06_Digital_QyGoogle(CString IDst, int PEC, CString NoticeType, CString SfnID, CString allotkey,CString AdmRefID,CString AssocAllotID,CString STN,int flagC) 
{
	CString CDataBaseSTR, Title;
	if(flagC==1)
	{
		if(IDst==_T("---"))		Title.Format(_Z("Source Allotment : IDst = %s ,  Notice Type = %s , PEC = %ld , SfnID = %s , allotkey = %s"),IDst,NoticeType,PEC,SfnID,allotkey);
		else					Title.Format(_Z("Converted Assignment : IDst = %s ,  Notice Type = %s , PEC = %ld , SfnID = %s , allotkey = %s"),IDst,NoticeType,PEC,SfnID,allotkey);
//		CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((Fragment)='RC06' Or (Fragment)='GE06D') AND ((NoticeType)='DS2' Or (NoticeType)='GS2' Or (NoticeType)='DT2' Or (NoticeType)='GT2') AND ((SfnID)=\'%s\')) OR (((Fragment)='RC06' Or (Fragment)='GE06D') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='C') AND ((SfnID)=\'%s\'));"), SfnID, SfnID); 
		CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((Fragment)='RC06' Or (Fragment)='GE06D') AND ((NoticeType)='DS2' Or (NoticeType)='GS2' Or (NoticeType)='DT2' Or (NoticeType)='GT2') AND ((SfnID)=\'%s\')) OR (((Fragment)='RC06' Or (Fragment)='GE06D') AND ((NoticeType)='DS1' Or (NoticeType)='GS1' Or (NoticeType)='DT1' Or (NoticeType)='GT1') AND ((AssignCode)='C') AND ((SfnID)=\'%s\'));"), m_qCommonFields,SfnID, SfnID); 
	}
	else
	{
		if(PEC==1)
		{
			Title.Format(_Z("Linked Assignment / Allotment with : IDst = %s , Notice Type = %s , PEC = %ld"),IDst,NoticeType,PEC);
//			CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)=\'%s\'));"), IDst); 
			CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((IDst)=\'%s\'));"), m_qCommonFields,IDst); 
		}
		else if(PEC==2)
		{
			Title.Format(_Z("Linked Assignment / Allotment with : IDst = %s , Notice Type = %s , PEC = %ld , SfnID = %s"),IDst,NoticeType,PEC,SfnID);
//			CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)<>'---') AND ((SfnID)=\'%s\'));"), SfnID); 
			CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((IDst)<>'---') AND ((SfnID)=\'%s\'));"), m_qCommonFields, SfnID); 
		}
		else if(PEC==3)
		{
			Title.Format(_Z("Linked Assignment / Allotment with : IDst = %s , Notice Type = %s , PEC = %ld , allotkey = %s"),IDst,NoticeType,PEC,allotkey);
//			CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((IDst)=\'%s\') AND ((allotkey)=\'%s\'));"), IDst,allotkey); 
			CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((IDst)=\'%s\') AND ((allotkey)=\'%s\'));"), m_qCommonFields,IDst,allotkey); 
		}
		else if(PEC==4)
		{
			Title.Format(_Z("Linked Assignment / Allotment with : IDst = %s , Notice Type = %s , PEC = %ld , SfnID = %s , allotkey = %s"),IDst,NoticeType,PEC,SfnID,allotkey);
//			CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((SfnID)=\'%s\') AND ((AssignCode)='L' Or (AssignCode)='S' Or (AssignCode) Is Null Or (AssignCode)='' Or (AssignCode)='---'));"), SfnID); 
			CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((SfnID)=\'%s\') AND ((AssignCode)='L' Or (AssignCode)='S' Or (AssignCode) Is Null Or (AssignCode)='' Or (AssignCode)='---'));"), m_qCommonFields,SfnID); 
		}
		else if(PEC==5)
		{
			CString NET;	NET.Format("%s%d",STN,PEC);
			Title.Format(_Z("Linked Assignment / Allotment with : IDst = %s , Notice Type = %s , PEC = %ld , allotkey = %s"),IDst,NoticeType,PEC,allotkey);
//			if	   ((NET==_T("ASS5"))||(NET==_T("AST5")))	CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((AssocAllotID)=\'%s\')) OR (((AdmRefID)=\'%s\'));"), AssocAllotID,AssocAllotID);
//			else if((NET==_T("ALS5"))||(NET==_T("ALT5")))	CDataBaseSTR.Format(_T("SELECT * FROM CommonFields WHERE (((AssocAllotID)=\'%s\')) OR (((AdmRefID)=\'%s\'));"), AdmRefID,AdmRefID);
			if	   ((NET==_T("ASS5"))||(NET==_T("AST5")))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((AssocAllotID)=\'%s\')) OR (((AdmRefID)=\'%s\'));"), m_qCommonFields,AssocAllotID,AssocAllotID);
			else if((NET==_T("ALS5"))||(NET==_T("ALT5")))	CDataBaseSTR.Format(_T("SELECT * FROM %s WHERE (((AssocAllotID)=\'%s\')) OR (((AdmRefID)=\'%s\'));"), m_qCommonFields,AdmRefID,AdmRefID);
		}
	}
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = CDataBaseSTR;
	CDataBaseLDLG datadlg;
	datadlg.m_Title = Title;
	if (datadlg.DoModal()==IDOK)
	{
		CString sFile, sPath, fileOUTkml;
		if		(flagC==0)	fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\GE06PE.kml");
		else if (flagC==1)	fileOUTkml = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\GE06CA.kml");
		BOOL flagShow = FALSE;
		if(((CSMS4DCApp *)AfxGetApp())->KmlSave( &sFile, &sPath , &flagShow , fileOUTkml))
		{
			sFile.Delete(sFile.GetLength()-4,4);
			fileOUTkml = sPath;

			CString gifFile = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Image_map\\st.gif");
			FILE *fp2 = fopen(fileOUTkml,_T("wt"));
			CString str1,str2;
			if		(flagC==0)	str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:GE06PlanEntry:%s</name>\n<open>1</open>"),sFile);
			else if (flagC==1)	str1.Format(_T("<kml>\n<Folder>\n<name>SMS4DC:ConvertedAssignment(s):%s</name>\n<open>1</open>"),sFile);
			fprintf(fp2,_T("%s\n"),str1);

			int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
			for (int i=0;i<Nrow;i++)
			{
				CString Selx, IDst0, SiteName;		double GeoLat, GeoLon;
				Selx = ((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
				IDst0 = GetFld(Selx,1);
				if(IDst0==_T("---"))
				{
					CString allotkey0 = GetFld(Selx,37),  GeoArea = GetFld(Selx,14);
					CString pFile = GE06ShowAllotGoogle(allotkey0, GeoArea);
					CString strOut = Vector2Placemark(pFile); 
					fprintf(fp2,_T("%s \n"),strOut);
				}
				else
				{
					SiteName = GetFld(Selx,4);	GeoLat = atof(GetFld(Selx,5));	GeoLon = atof(GetFld(Selx,6));
					str2.Format(_T("<Placemark><name>%s</name><StyleMap id=\'msn_A\'><Pair><key>normal</key><styleUrl>#sn_A</styleUrl></Pair></StyleMap><Style id=\'sn_A\'><IconStyle><scale>0.9</scale><Icon><href>%s</href></Icon></IconStyle><LabelStyle><scale>0.7</scale></LabelStyle></Style><styleUrl>#msn_A</styleUrl><Point><coordinates>%lf,%lf,0</coordinates></Point></Placemark>"),SiteName,gifFile ,GeoLon,GeoLat);
					fprintf(fp2,_T("%s \n"),str2);

				}//if IDst0
			}//for  i<Nrow 
			fprintf(fp2,_T("</Folder>\n</kml>"));
			fclose(fp2);
			if(flagShow)	ShellExecute(m_hWnd, "open", fileOUTkml, NULL, NULL, SW_SHOWNORMAL);
		}//if KmlSave

	}//if datadlg
}

void CSMS4DCView::GE06linked_ConvertedGoogle(int flagC) 
{
	CString Selx = QGE06_Digital_Qx(flagC);
	if(Selx.GetLength()>0)
	{
		CString allotkey,AdmRefID, AssocAllotID,SfnID,PlanEntry, NoticeType,Fragment , IDst;
		IDst = GetFld(Selx,1);		AdmRefID = GetFld(Selx,3);		Fragment = GetFld(Selx,8);		PlanEntry = GetFld(Selx,10);
		SfnID = GetFld(Selx,12);	NoticeType = GetFld(Selx,13);	AssocAllotID = GetFld(Selx,28);	allotkey = GetFld(Selx,37);
		CP154606_Functions CP154606;
		CString STN = CP154606.GE06_STN(Fragment,NoticeType);
		int PEC = GE06_PEC(AdmRefID , AssocAllotID , PlanEntry , SfnID , STN) ;
		QGE06_Digital_QyGoogle(IDst, PEC, NoticeType, SfnID, allotkey, AdmRefID, AssocAllotID, STN, flagC) ;
	}
	Set_STtable_Default();
}

void CSMS4DCView::OnToolsGoogleConvertedassignments() 
{
	GE06linked_ConvertedGoogle(1);
}

extern "C" int WINAPI GoogleFile(CString mLang, CString InputPath = _T(""));	//GoogleFileDLL.lib
void CSMS4DCView::OnToolsGoogleVectors() 
{
	GoogleFile(((CSMS4DCApp *)AfxGetApp())->m_Lang);	
}
   
void CSMS4DCView::OnFileSave() 
{
	CSMS4DCDoc* pDoc = (CSMS4DCDoc*)GetDocument();
	CString str = pDoc->GetTitle();

	CDC *pDC = GetDC();
	((CSMS4DCApp *)AfxGetApp())->SaveDesktop(pDC, str);
	ReleaseDC(pDC);
}

BOOL CSMS4DCView::strCompare(CString sPath) 
{
	int N = m_POLYnum;
	for(int i = 0 ; i<N ; i++)
	{
		if((sPath.CompareNoCase(m_POLY[i].PathNameVec))==0)
			return TRUE;
	}
	return FALSE;
}

void CSMS4DCView::OnVectorsVectorhandling() 
{
	if(m_pDocVectors)
	{
		m_pDocVectors->OnCmdMsg(ID_FILE_CLOSE, 0, 0, 0);
		m_pDocVectors = NULL;
	}
	else
	{
		((CSMS4DCApp *)AfxGetApp())->m_pView = this;
		((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Vector Handling");
		m_pDocVectors =  DocUtil::GetLastDocument("Vector Handling");
		m_pDocVectors->SetTitle(_Z("Vector Handling"));
	}	
}
void CSMS4DCView::OnUpdateVectorsVectorhandling(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_pDocVectors != NULL);
}

void CSMS4DCView::VectorDesktop(CString sPath) 
{
	double lat, lon;
	Vector2OnePoint(sPath ,&lat, &lon); 
	OnDatabaseStationsindesktop2(lat,lon);
	InvalidateRect(NULL,FALSE);
}

void CSMS4DCView::InvalidateVectorHandling() 
{
	if(m_pDocVectors)
	{
		OnVectorsVectorhandling();
		OnVectorsVectorhandling();
	}
}

void CSMS4DCView::DrawSymboleCopl(CDC* pDC,double lats,double lons,COLORREF color1,int len1) 
{
	CPen penStation(PS_SOLID,1,color1);	CPen *Oldpen=pDC->SelectObject(&penStation);

	CPoint points;
	LatLon2Point(lats,lons,&points);
	pDC->MoveTo(points.x-2*len1,points.y);	pDC->LineTo(points.x+2*len1,points.y);
	pDC->MoveTo(points.x,points.y-2*len1);	pDC->LineTo(points.x,points.y+2*len1);

	pDC->MoveTo(points.x-len1,points.y-len1);
	pDC->LineTo(points.x+len1,points.y-len1);	pDC->LineTo(points.x+len1,points.y+len1);
	pDC->LineTo(points.x-len1,points.y+len1);	pDC->LineTo(points.x-len1,points.y-len1);

	if(!pDC->IsPrinting())
		pDC->SelectObject(&Oldpen);
}

void CSMS4DCView::OnDrawVectorCircle(CString sPath,int mode) 
{
	CString sFile = sPath;
	int b = sFile.ReverseFind('\\');
	sFile.Delete(0,b+1);

	CString str,sFileDef = ((CSMS4DCApp *)AfxGetApp())->m_AppPath + _T("Reports\\") + _T("Circle.txt");
	int tF = m_POLYnum;
	for(int i=0;i<m_POLYnum;i++)
	{
		str = m_POLY[i].PathNameVec;
		if(str == sFileDef)		{tF = i;	break;}
	}

	CVectorDLG Vdlg;
	Vdlg.m_TitleName = sFile;
	if (Vdlg.DoModal()== IDOK)
	{
	//	if(!strCompare(sPath))
		{
			COLORREF crColor = RGB(Vdlg.m_LineColorRed,Vdlg.m_LineColorGreen,Vdlg.m_LineColorBlue);
			COLORREF flColor = RGB(Vdlg.m_FillColorRed,Vdlg.m_FillColorGreen,Vdlg.m_FillColorBlue);
			m_POLY[tF].PathNameVec = sPath;
			m_POLY[tF].FileNameVec = sFile;
			m_POLY[tF].nWidthVec = Vdlg.m_LineWidth;
			m_POLY[tF].crColorVec = crColor;
			m_POLY[tF].nStyleVec = Vdlg.m_LineStyle0;
			m_POLY[tF].nModeVec = Vdlg.m_FillMode;
			if(mode==2)
				m_POLY[tF].nModeVec = 2;
			m_POLY[tF].flColorVec = flColor;
			m_POLY[tF].alphaVec = Vdlg.m_FillTransparancy;
			if(tF == m_POLYnum)	m_POLYnum++;

			InvalidateRect(NULL,FALSE);
			InvalidateVectorHandling();
		}
	}
}

CString CSMS4DCView::BorderM2noPF(double LatX,double LonX,CString ctyA,double Dsearch) 
{
	BeginWaitCursor();
//	double pi = 4.0*atan(1.0);

	//////////////////////////Border///////////////////////////////
	double *Blat;	Blat = NULL;
	double *Blon;	Blon = NULL;
	long numBorder;

	BorderCom2CtyD(LatX,LonX,ctyA, Dsearch ,  &Blat, &Blon, &numBorder) ;
//	BorderCom2Cty(LatX,LonX,ctyA,  &Blat, &Blon, &numBorder) ;

	CString strY = _T("");
	{
		double DistB = 999999999, dist;
		CString RLONb, RLATb;
		double Blat_rad,Blon_rad , Blat_deg,Blon_deg;

		int progress_num=0;
		CString progress_str, progress_char = "I";
		for(int i=0;i<numBorder;i++)
		{
			progress_str.Format("  %02d%%"+_Z(" complete")+" %s",(int)(100.0*(++progress_num)/(double)(numBorder)),progress_char);
			progress_char = str_rep("I",(int)(progress_num*50.0/((double)(numBorder))) );
			((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
			PeekAndPump();

			dist = Distance_km(LatX,LonX , Blat[i],Blon[i]) ;
			if(dist<=Dsearch)
			{
				Blat_deg = Blat[i];
				Blon_deg = Blon[i];
				DistB = min(DistB,dist);
			}
		}//numBorder

		Blat_rad = Blat_deg*pi/180.0;	Blon_rad = Blon_deg*pi/180.0;
		Rad2Str(Blon_rad,Blat_rad, &RLONb,&RLATb);
	//	strY.Format("Distance to border ''%s'' (%s  %s) is %0.0f km.\t\n",ctyA,RLONb,RLATb,DistB);
		strY.Format(_Z("Distance to the nearest point of ''%s'' border (%s  %s) is %0.0f km.\t\n"),ctyA,RLONb,RLATb,DistB);
	}
	if(numBorder>0)	{Blat = NULL; delete [] Blat;	Blon = NULL; delete [] Blon;		}
	
	((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, "");
	return strY;
}

void CSMS4DCView::OnCalculationEarthstationhorizonelevation() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");
	CDataBaseLDLG dbdlg;
	if (dbdlg.DoModal() == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(Nrow==1)
		{
			CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			long IDst  = atol(GetFld(m_Sel,1));
			CString name1 = GetFld(m_Sel,2);
			double lat_ES  = atof(GetFld(m_Sel,22));
			double lon_ES  = atof(GetFld(m_Sel,21));
			AddEarthStation_disp(IDst,lat_ES,lon_ES,name1);

			CHorizonElevationDLG parametersDLG;

//			parametersDLG.m_ES_Altitude = atof(GetFld(m_Sel,19));
			OnDatabaseStationsindesktop2(lat_ES,lon_ES);
			double h1 = LatLon2Hg(lat_ES,lon_ES);
			h1 = ((double)Round(h1*10.0))/10.0;
			parametersDLG.m_ES_Altitude = h1;

			parametersDLG.m_Earth_radius_km = 6371;
			parametersDLG.m_k = "4/3";
			parametersDLG.m_D_max = 15;
			parametersDLG.m_Azimuth_Step_Deg = 5;
			if (parametersDLG.DoModal() == IDOK)
			{
				double ES_Altitude  = parametersDLG.m_ES_Altitude;
				double Earth_radius_m  = (parametersDLG.m_Earth_radius_km)*1000.0;
				double k = atof_kfactor(parametersDLG.m_k);
				double D_max  = parametersDLG.m_D_max;
				int Azimuth_Step_Deg  = parametersDLG.m_Azimuth_Step_Deg;

				double resolution_km = 0.01;

				h1 = ES_Altitude;
				double latC_deg,lonC_deg , h2 , dist , D , elevp , elevpMax, D_elevpMax, re = k*Earth_radius_m;

				int progress_num=0;
				CString progress_str, progress_char = _T("I");
				progress_str.Format("  %02d%%" + _Z(" complete") + " %s",0,_T("............."));
				PeekAndPump();
				((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);

				CHorizonElevationDataDLG HEdataDlg;
				HEdataDlg.m_Rows = 1+360/Azimuth_Step_Deg;

				int n = 0; 
				for(int az_deg=0; az_deg<360; az_deg = az_deg + Azimuth_Step_Deg)
				{
					elevpMax = -999999;		D = resolution_km;		D_elevpMax = 0;
					while(D<=D_max)
					{
						reckon(lat_ES,lon_ES, D ,az_deg,&latC_deg,&lonC_deg);
						OnDatabaseStationsindesktop2(latC_deg,lonC_deg);

						h2 = LatLon2Hg(latC_deg,lonC_deg); 
					//	dist = 1000.0*Distance_km(lat_ES,lon_ES,latC_deg,lonC_deg);
						dist = 1000.0*D;
						elevp = (180.0/pi)*atan(((re+h2)*cos(dist/re)-(re+h1))/((re+h2)*sin(dist/re)));
					//	elevp = (180.0/pi)*(((h2-h1)/dist) - (dist/(2.0*re)));

						elevpMax = max(elevpMax,elevp);
						if(elevpMax==elevp)	D_elevpMax = D;
						D = D + resolution_km;
					}//while
					HEdataDlg.m_Azimuth[n] = az_deg;
					HEdataDlg.m_Elevation[n] = elevpMax;
					HEdataDlg.m_Distance[n] = D_elevpMax;
					n++;

					progress_char = str_rep("I",(int)((++progress_num)*50.0/(360.0/Azimuth_Step_Deg)) );
					progress_str.Format("  %02d%%" + _Z(" complete") + " %s",(int)(100.0*progress_num/(360.0/Azimuth_Step_Deg)),progress_char);
					PeekAndPump();
					((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndStatusBar.SetPaneText(0, progress_str);
				}//for

				if(HEdataDlg.DoModal()==IDOK)
				{
					CString  SQL1 , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
					CDatabase DB1;
					DB1.Open(m_DB,false,false,_T("ODBC;"),false);
					SQL1.Format(_T("DELETE * FROM hor_elev WHERE (((ntc_id)=%ld));") , IDst);	DB1.ExecuteSQL(SQL1);
					for(int i=0; i<n; i++)
					{
						SQL1.Format(_T("SELECT %ld,%d,%lf,%lf "), IDst, HEdataDlg.m_Azimuth[i] ,HEdataDlg.m_Elevation[i] , HEdataDlg.m_Distance[i]);
						SQL1 = _T("INSERT INTO hor_elev (ntc_id, azm, elev_ang, hor_dist) ") + SQL1;
						DB1.ExecuteSQL(SQL1);
					}//for
					DB1.Close();
				}//if HEdataDlg

			}//parametersDLG
		}//Nrow
		else	MessageBox(_Z("Please Select One Earth Station."),_Z("ERROR!!!"),MB_ICONERROR);
	}//if (dbdlg
	Set_STtable_Default();
}

void CSMS4DCView::OnCalculationEarthstationAzimuthtogsosatellites() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");
	CDataBaseLDLG dbdlg;
	if (dbdlg.DoModal() == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(Nrow==1)
		{
			CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			long IDst  = atol(GetFld(m_Sel,1));
			CString name1 = GetFld(m_Sel,2);
			double lat_ES  = atof(GetFld(m_Sel,22));
			double lon_ES  = atof(GetFld(m_Sel,21));
			AddEarthStation_disp(IDst,lat_ES,lon_ES,name1);
			
//			double pi = 4.0*atan(1.0);
			lat_ES = (pi/180.0)*lat_ES;			lon_ES = (pi/180.0)*lon_ES;

			CString Str_lonNom_ES  = GetFld(m_Sel,13);
			if(Str_lonNom_ES.GetLength()>0)
			{
				double lonNom_ES  = (pi/180.0)*atof(Str_lonNom_ES);
				double DEL = lonNom_ES - lon_ES;
				double FI = acos(cos(lat_ES)*cos(DEL));

				double C = -cos(FI)*sin(lat_ES);
				double D =  sin(FI)*cos(lat_ES);
				double AZM = (180.0/pi)*acos(C/D);
				if(DEL<0)	AZM = 360.0 - AZM;

				CString str;
				str.Format(_Z("Azimuth Angle to GSO Satellites = %0.1f \t\n\nDo you want to save this value into Database?\t"),AZM);
				int SaveYes = MessageBox(str,_Z("Save Azimuth Angle"),MB_YESNO | MB_ICONQUESTION);
				if(SaveYes==IDYES)
				{
					CString  SQL1 , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
					CDatabase DB1;
					DB1.Open(m_DB,false,false,_T("ODBC;"),false);
					SQL1.Format(_T("UPDATE e_stn SET azm_fr = %lf, azm_to = %lf WHERE (((ntc_id)=%ld));"), AZM,AZM,IDst);
					DB1.ExecuteSQL(SQL1);
					DB1.Close();
				}//if Save

			}//if
			else	MessageBox(_Z("Nominal Longitude of Space Station is not filled!"),_Z("ERROR!!!"),MB_ICONERROR);

		}//Nrow
		else	MessageBox(_Z("Please Select One Earth Station."),_Z("ERROR!!!"),MB_ICONERROR);
	}//if (dbdlg
	Set_STtable_Default();
}

void CSMS4DCView::OnCalculationEarthstationElevationtogsosatellites() 
{
	((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR = _T("select * from e_stn");
	CDataBaseLDLG dbdlg;
	if (dbdlg.DoModal() == IDOK)
	{
		int Nrow = ((CSMS4DCApp *)AfxGetApp())->Nrow;
		if(Nrow==1)
		{
			CString m_Sel = ((CSMS4DCApp *)AfxGetApp())->m_Sel[0];
			long IDst  = atol(GetFld(m_Sel,1));
			CString name1 = GetFld(m_Sel,2);
			double lat_ES  = atof(GetFld(m_Sel,22));
			double lon_ES  = atof(GetFld(m_Sel,21));
			AddEarthStation_disp(IDst,lat_ES,lon_ES,name1);
			
//			double pi = 4.0*atan(1.0);
			lat_ES = (pi/180.0)*lat_ES;			lon_ES = (pi/180.0)*lon_ES;

			CString Str_lonNom_ES  = GetFld(m_Sel,13);
			if(Str_lonNom_ES.GetLength()>0)
			{
				double lonNom_ES  = (pi/180.0)*atof(Str_lonNom_ES);
				double DEL = lonNom_ES - lon_ES;
				double FI = acos(cos(lat_ES)*cos(DEL));

				double K = 6.62;
				double A = K*cos(FI) - 1.0;
				double B =  sqrt(1.0 + K*K - 2.0*K*cos(FI) );
				double ELV = (180.0/pi)*asin(A/B);

				CString str;
				str.Format(_Z("Elevation Angle to GSO Satellites = %0.1f \t\n\nDo you want to save this value into Database?\t"),ELV);
				int SaveYes = MessageBox(str,_Z("Save Elevation Angle"),MB_YESNO | MB_ICONQUESTION);
				if(SaveYes==IDYES)
				{
					CString  SQL1 , m_DB = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
					CDatabase DB1;
					DB1.Open(m_DB,false,false,_T("ODBC;"),false);
					SQL1.Format(_T("UPDATE e_stn SET elev_min = %lf WHERE (((ntc_id)=%ld));"), ELV,IDst);
					DB1.ExecuteSQL(SQL1);
					DB1.Close();
				}//if Save

			}//if
			else	MessageBox(_Z("Nominal Longitude of Space Station is not filled!"),_Z("ERROR!!!"),MB_ICONERROR);

		}//Nrow
		else	MessageBox(_Z("Please Select One Earth Station."),_Z("ERROR!!!"),MB_ICONERROR);
	}//if (dbdlg
	Set_STtable_Default();
}

/////////////////////////////////////
/////////////Argus///////SMDI////////////////
///////////////////////////////////
void CSMS4DCView::OnMonitoringArgusRespondtoorder() 
{
	m_ArgusOrder = !m_ArgusOrder;
	if(m_ArgusOrder)	// Start up the timer...
	{
		FindArgusIniFile(&m_PathINBOX, &m_PathOUTBOX);

		ASSERT(GetSafeHwnd());     
		m_nTimerID = SetTimer(ID_ArgusTIMER,10000,NULL);
		m_thisList.SetAt(m_nTimerID, (LPVOID) this);
	}
	else				// Stop the timer
	{
		::KillTimer( this->m_hWnd, m_nTimerID);
		m_thisList.RemoveKey(m_nTimerID);   
		m_nTimerID = 0;
	}	
}
void CSMS4DCView::OnUpdateMonitoringArgusRespondtoorder(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_ArgusOrder);
}

void CSMS4DCView::FindArgusIniFile(CString *PathINBOX, CString *PathOUTBOX)
{
	CString PathOUTBOX0,PathINBOX0 , ArgusIniFile = m_AppPath + _T("\\Texts\\Argus.txt");

	CFileFind x1;
	BOOL cx1 = x1.FindFile(ArgusIniFile);
	if(!cx1)
	{
		PathINBOX0   = _T("C:\\ARGUS\\INBOX");
		PathOUTBOX0  = _T("C:\\ARGUS\\OUTBOX");

		FILE *fid;
		fid = fopen(ArgusIniFile,_T("wt"));
		fprintf( fid, _T("%s\n"), PathINBOX0);
		fprintf( fid, _T("%s\n"), PathOUTBOX0);
		fclose(fid);
		
	}//if !cx1
	else
	{
		char buftemp[400];
		FILE *fid = fopen(ArgusIniFile,_T("rt"));

		fgets(buftemp,400,fid);
		PathINBOX0 = buftemp;
		PathINBOX0.TrimLeft();		PathINBOX0.TrimRight();

		fgets(buftemp,400,fid);
		PathOUTBOX0 = buftemp;
		PathOUTBOX0.TrimLeft();		PathOUTBOX0.TrimRight();

		fclose(fid);
	}
	x1.Close();
	*PathINBOX  = PathINBOX0;
	*PathOUTBOX = PathOUTBOX0;
}

void CSMS4DCView::OnTimer(UINT nIDEvent) 
{
	if(m_ArgusOrder) On_argusO_smsR(this->m_hWnd);
	if(m_GSPflag) Find_GSPorder();

	if(m_ThalesOrder) On_ThalesAuto();

	if(m_OthersOrder) On_othersO_smsR(this->m_hWnd);

	CScrollView::OnTimer(nIDEvent);
}

extern "C" int WINAPI argusO_smsR(HWND hWndParent,CString DBSTR,CString PathIN,CString PathOUT,CString Lang);
void CSMS4DCView::On_argusO_smsR(HWND hwnd) 
{
	bool Is_In = false;
	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	CString PathFileOUTBOX, DBSTR = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
    struct _finddata_t xml_file;
    long hFile;

	if(!Is_In)		
	if( (hFile = _findfirst( m_PathOUTBOX + _T("\\I*.xml") , &xml_file )) != -1L )	/* Find first .xml file in current directory */
	{
		Is_In = true;
		PathFileOUTBOX = m_PathOUTBOX + _T("\\") + xml_file.name;
		argusO_smsR(hwnd,DBSTR,PathFileOUTBOX,m_PathINBOX,mLang);
//		CFile::Remove(PathFileOUTBOX);
		while( _findnext( hFile, &xml_file ) == 0 )		/* Find the rest of the .xml files */
		{
			PathFileOUTBOX = m_PathOUTBOX + _T("\\")  + xml_file.name;
			argusO_smsR(hwnd,DBSTR,PathFileOUTBOX,m_PathINBOX,mLang);
//			CFile::Remove(PathFileOUTBOX);
		}
	   _findclose( hFile );
		Is_In=false;
	}
}

////////////////////////////////////////////////
////////////////////Argus/////GSP///////////////////
////////////////////////////////////////////////
/*
extern "C" int WINAPI GSPorder(HWND hWndParent,CString PathINBOX ,CString Lang);
void CSMS4DCView::OnMonitoringArgusGsporder() 
{
	CString PathINBOX , PathOUTBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &PathOUTBOX);
	GSPorder(this->m_hWnd, PathINBOX , mLang);	
}
*/
extern "C" int WINAPI GSPorder(HWND hWndParent,CString PathINBOX ,CString Lang ,CString *GSPFileName,unsigned int *nTime);
void CSMS4DCView::OnMonitoringArgusGsporder() 
{
	CString PathINBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &m_PathOUTBOX);
	unsigned int nTime;
	GSPorder(this->m_hWnd, PathINBOX , mLang , &m_GSPFileName, &nTime);

	m_GSPflag = TRUE;

	ASSERT(GetSafeHwnd());     
	m_nTimerID2 = SetTimer(ID_ArgusTIMER2, nTime ,NULL);
	m_thisList2.SetAt(m_nTimerID2, (LPVOID) this);
}
void CSMS4DCView::Find_GSPorder() 
{
	m_GSPflag = FALSE;	
    struct _finddata_t xml_file;
    long hFile;
	CString str;
	CString mGSPFileName = m_GSPFileName;
	mGSPFileName.Replace(_T("-O.xml"),_T("-R.xml"));
	if( (hFile = _findfirst( m_PathOUTBOX + _T("\\") + mGSPFileName , &xml_file )) != -1L )	/* Find first .xml file in current directory */
	{
//		str.Format(_T("The respond to order ' %s ' is Created.  ") , xml_file.name);
		str.Format(_Z("ARGUS system successfully responded to ' %s ' .  ") , m_GSPFileName);
		::KillTimer( this->m_hWnd, m_nTimerID2);
		m_thisList2.RemoveKey(m_nTimerID2);   
		m_nTimerID2 = 0;
		MessageBox(str,_Z("Information!!!"),MB_ICONINFORMATION);
	}
	else
	{
//		str.Format(_T("The respond to order ' %s ' is not Created.  ") , m_GSPFileName);
		str.Format(_Z("ARGUS system did not respond to ' %s ' . \nMaybe the ARGUS system is not working or the connection is lost. ") , m_GSPFileName);
		::KillTimer( this->m_hWnd, m_nTimerID2);
		m_thisList2.RemoveKey(m_nTimerID2);   
		m_nTimerID2 = 0;
		MessageBox(str,_Z("Error!!!"),MB_ICONERROR);
	}
}

////////////////////////////////////////////////
////////////////////Argus/////ORM///////////////////
////////////////////////////////////////////////
/*
extern "C" int WINAPI OR_O_Tab(HWND hWndParent,CString PathINBOX,CString PathOUTBOX ,CString AppPath , CString Lang);
void CSMS4DCView::OnMonitoringArgusOrmorder() 
{
	CString PathINBOX , PathOUTBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &PathOUTBOX);

	OR_O_Tab(this->m_hWnd, PathINBOX,PathOUTBOX ,m_AppPath, mLang);	
}
*/
extern "C" int WINAPI OR_O_Tab(HWND hWndParent,CString PathINBOX,CString PathOUTBOX ,CString AppPath , CString Lang, CString mDB, CString mTbl);
void CSMS4DCView::OnMonitoringArgusOrmorder() 
{
	CString PathINBOX , PathOUTBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &PathOUTBOX);

	OR_O_Tab(this->m_hWnd, PathINBOX,PathOUTBOX ,m_AppPath, mLang 
		, ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR  , ((CSMS4DCApp *)AfxGetApp())->m_CDataBaseSTR);	
}
////////////////////////////////////////////////
////////////////////Argus/////StopOrder///////////////////
////////////////////////////////////////////////
extern "C" int WINAPI STorder(HWND hWndParent,CString PathINBOX ,CString Lang ,int ArgusFlag);
void CSMS4DCView::OnMonitoringArgusStoporder() 
{
	CString PathINBOX , PathOUTBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &PathOUTBOX);
	STorder(this->m_hWnd, PathINBOX , mLang, 1);	
}

void CSMS4DCView::OnMonitoringArgusDrawoutput() 
{
//	GetParentFrame()->ShowControlBar(&((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndToolBar,
//	(((CMainFrame*)(AfxGetApp()->m_pMainWnd))->m_wndToolBar.GetStyle()&~WS_VISIBLE)==0,false);

	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Monitoring ARGUS");
}

////////////////////////////////////////////////
////////////////////Argus/////StatusOrder///////////////////
////////////////////////////////////////////////
extern "C" int WINAPI SUorder(HWND hWndParent,CString PathINBOX ,CString Lang);
void CSMS4DCView::OnMonitoringArgusOrderstatus() 
{
	CString PathINBOX , PathOUTBOX , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	FindArgusIniFile(&PathINBOX, &PathOUTBOX);
	SUorder(this->m_hWnd, PathINBOX , mLang);	
}

//////////////////////////////THALES Link///////////////////////////////////////////////////////////
////////////////////Thales/////View Check-list///////////////////
extern "C" int WINAPI ThalesChk(HWND hWndParent,CString PathINBOX ,CString Lang);	//ThalesChkDLL.dll
void CSMS4DCView::OnMonitoringThalesViewChecklist() 
{
	CString PathINBOX = _T("") , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	ThalesChk(this->m_hWnd, PathINBOX , mLang);	
}

////////////////////Thales/////View Occupancy rate///////////////////
extern "C" int WINAPI ThalesOcc(HWND hWndParent,CString PathINBOX ,CString Lang);	//ThalesOccDLL.dll
void CSMS4DCView::OnMonitoringThalesViewOccupancyrate() 
{
	CString PathINBOX = _T("") , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	ThalesOcc(this->m_hWnd, PathINBOX , mLang);	
}

////////////////////Thales/////View Requests///////////////////
//extern "C" int WINAPI ThalesReq(HWND hWndParent,CString PathREQUEST ,CString PathINBOX ,CString PathOUTBOX ,CString DBSTR,CString QuerySTR,CString Lang,BOOL CHKflag);	//ThalesReqDLL.dll
extern "C" int WINAPI ThalesReq(HWND hWndParent,CString PathREQUEST ,CString PathINBOX ,CString PathOUTBOX ,CString DBSTR,CString QuerySTR,CString Lang,BOOL CHKflag,CString *Req_filepath);	//ThalesReqDLL.dll
void CSMS4DCView::OnMonitoringThalesViewRequests() 
{
	FindThalesIniFile(&m_PathINBOXth, &m_PathOUTBOXth, &m_PathREQUESTth);

	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
//	ThalesReq(this->m_hWnd, m_PathREQUESTth, _T(""), _T("") ,_T(""),_T(""), mLang,FALSE);
	
	CString Req_filepath;
	ThalesReq(this->m_hWnd, m_PathREQUESTth, _T(""), _T("") ,_T(""),_T(""), mLang,FALSE,&Req_filepath);	
}

////////////////////Thales/////View Results///////////////////
extern "C" int WINAPI ThalesRes(HWND hWndParent,CString PathINBOX ,CString Lang);	//ThalesResDLL.dll
void CSMS4DCView::OnMonitoringThalesViewResults() 
{
	CString PathINBOX = _T("") , mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	ThalesRes(this->m_hWnd, PathINBOX , mLang);	
}

////////////////////Thales/////Check-list generation Mission creation///////////////////
extern "C" int WINAPI ThalesGenChk(HWND hWndParent,CString PathINBOX,CString PathOUTBOX, CString DBSTR,CString QuerySTR,CString Lang,CString Mstation ,CString Mfunction,CString STarray,int Nrow);	//ThalesGenChkDLL.dll
extern "C" int WINAPI MonitoringStation(HWND hWndParent,CString PathApp ,CString mLang ,CString *Mstation ,CString *Mfunction);	//ThalesMstationDLL.dll
void CSMS4DCView::OnMonitoringThalesChecklistgenerationMissioncreation() 
{
//	CString PathINBOX = _T("");
	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	CString mCDBSTR   = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CString mQuerySTR = ((CSMS4DCApp *)AfxGetApp())->Query_STtable();

//	ThalesGenChk(this->m_hWnd, PathINBOX, mCDBSTR, mQuerySTR, mLang);
///////////////////////////////////////////////////////////////////////////////	
	CString Mstation, Mfunction, s, STarray = "";
	int Nrow = 0;
	MonitoringStation(this->m_hWnd,m_AppPath ,mLang ,&Mstation ,&Mfunction);
	if(Mfunction.GetLength()==0)	return;
	
	CString X1 = GetFld(Mstation,3) ,  Y1 = GetFld(Mstation,4);
	if(!((X1.GetLength()>0)&&(Y1.GetLength()>0)))	return;
	double X = atof(X1.Left(3)) + (atof(X1.Mid(4,2)))/60.0 + (atof(X1.Mid(6,6)))/3600.0;
	double Y = atof(Y1.Left(2)) + (atof(Y1.Mid(3,2)))/60.0 + (atof(Y1.Mid(5,6)))/3600.0;
	double MOlon_deg = ((X1.Mid(3,1))==_T("E")) ? X : -X;		//deg
	double MOlat_deg = ((Y1.Mid(2,1))==_T("N")) ? Y : -Y;		//deg
	OnDatabaseStationsindesktop(-999999,GetFld(Mstation,2),MOlat_deg,MOlon_deg);
	
	s = Mfunction;
	if( (s==_T("FSM"))||(s==_T("FSF"))||(s==_T("IAM"))||(s==_T("SCT"))||
		(s==_T("SFS"))||(s==_T("TOR"))||(s==_T("USS"))||(s==_T("UBS"))||
		(s==_T("ATR"))||(s==_T("CAM"))||(s==_T("TVM")) )
	{
		CString title; 
		if(s==_T("CAM"))	title = _T("Select One Station");
		else				title = _T("Select Station(s)");

		CDataBaseLDLG dbdlg;
		dbdlg.m_Title = title;
		if ((dbdlg.DoModal()) == IDOK)
		{
			Nrow =	((CSMS4DCApp *)AfxGetApp())->Nrow;
			if((s==_T("CAM"))&&(Nrow>1))	Nrow = 1;
			if (Nrow>0)
			{
				double fMHz_ST, lat_ST,lon_ST,Hagl_ST,Hg,BWh;			
				CString str,ID,name1,Emission,Pol , m_Sel;			
				double az,BW,E,PtGt_ST,kfactor, HasglST, Ptime,Plocation, RxH;
				int ENV, syst, P1546Clangle, P1546landsea ,p=1;

				CP1546DLG p1546dlg;
				if (p1546dlg.DoModal()==IDOK)
				{
					Ptime = p1546dlg.m_time;
					Plocation = p1546dlg.m_location;
					kfactor = p1546dlg.m_k;
					RxH = p1546dlg.m_RxH;
					syst = p1546dlg.m_syst;
					ENV = p1546dlg.m_env;
					P1546Clangle = p1546dlg.m_Clangle;
					P1546landsea = p1546dlg.m_landsea;
					for (int i=0;i<Nrow;i++)
					{
						m_Sel	=	((CSMS4DCApp *)AfxGetApp())->m_Sel[i];
						if (m_Sel.GetLength()>0)
						{
							ID       = GetFld(m_Sel,1); 
							name1    = GetFld(m_Sel,2); 
							lat_ST   = atof(GetFld(m_Sel,3)); 
							lon_ST   = atof(GetFld(m_Sel,4));
							Hagl_ST  = atof(GetFld(m_Sel,5));
							fMHz_ST  = atof(GetFld(m_Sel,6));
							PtGt_ST  = atof(GetFld(m_Sel,7));
							BWh      = atof(GetFld(m_Sel,11));
							Pol      = GetFld(m_Sel,13);
							Emission = GetFld(m_Sel,19);

							OnDatabaseStationsindesktop2(lat_ST,lon_ST);
							Hg = LatLon2Hg(lat_ST,lon_ST);
							HasglST = Hg + Hagl_ST;

double Drange = Distance_km(lat_ST,lon_ST, MOlat_deg, MOlon_deg); 
LoadIDWMmap_r(lat_ST,lon_ST, Drange);

//  E = E_P1546(lat_ST,lon_ST, MOlat_deg, MOlon_deg, HasglST, fMHz_ST, PtGt_ST, kfactor, Ptime, RxH, ENV, syst, Plocation, P1546Clangle , P1546landsea, p);
E = E_P1546_V05(lat_ST,lon_ST, MOlat_deg, MOlon_deg, Hagl_ST, fMHz_ST, PtGt_ST, kfactor, Ptime, RxH, ENV, syst, Plocation, P1546Clangle , P1546landsea, p);

							az = Azimuth_Deg(MOlat_deg, MOlon_deg, lat_ST,lon_ST);
							BW = Emission2NBW( Emission);

							STarray = STarray + "," + ID;
							STarray = STarray + "," + name1;
							STarray = STarray + "," + DEG2DMSth(_T("LON"), lon_ST);
							STarray = STarray + "," + DEG2DMSth(_T("LAT"), lat_ST);
														str.Format("%0.0lf" , fMHz_ST*1000000.0);
							STarray = STarray + "," + str;
							STarray = STarray + "," + Emission;
														str.Format(_T("%0.1lf"), az );
							STarray = STarray + "," + str;
														str.Format(_T("%0.1lf"), E );
							STarray = STarray + "," + str;
														str.Format(_T("%0.0lf"), 1000.0*BW );
							STarray = STarray + "," + str;
														if((BWh==0)||(BWh>359))	str = _T("N");
														else					str = _T("D");
							STarray = STarray + "," + str;
														if(Pol==_T("M"))	Pol = _T("MX");
							STarray = STarray + "," + Pol;
						}//if m_Sel
					}//for i
					STarray.Delete(0);
				}//p1546dlg
			}//if Nrow
		}//if dbdlg
	}// if s

	FindThalesIniFile(&m_PathINBOXth, &m_PathOUTBOXth, &m_PathREQUESTth);
	ThalesGenChk(this->m_hWnd, m_PathINBOXth,m_PathOUTBOXth, mCDBSTR, mQuerySTR, mLang, Mstation, Mfunction, STarray, Nrow);
/////////////////////////////////////////////////////////////////////////////////////
}
CString CSMS4DCView::DEG2DMSth(CString type,double x) 
{
	int xD,xM;	double xS;	char xU;
	if (x < 0)
	{
		x = -x;
		if (type==_T("LON"))	xU = 'W';
		else					xU = 'S';
	}
	else
	{
		if (type==_T("LON"))	xU = 'E';
		else					xU = 'N';
	}
	xD = (int)x;
	double xM0 = 60*(x-xD);
	xM = (int)xM0;
	xS = 60*(xM0-xM);
	if (xS>=59.999)
	{
		xM = xM+1;	xS = 0.0;
		if (xM>=60)	{xD = xD+1;	xM = 0;}
	}
	CString str;
	int xS1 = int(xS);
	if (type==_T("LON"))	str.Format("%03d%c%02d%02d",xD,xU,xM,xS1 );
	else					str.Format("%02d%c%02d%02d",xD,xU,xM,xS1 );
	return str;
}

////////////////////Thales/////Check-list generation Requests///////////////////
void CSMS4DCView::OnMonitoringThalesChecklistgenerationRequests() 
{
	FindThalesIniFile(&m_PathINBOXth, &m_PathOUTBOXth, &m_PathREQUESTth);
	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	CString mCDBSTR   = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
	CString mQuerySTR = ((CSMS4DCApp *)AfxGetApp())->Query_STtable();
//	ThalesReq(this->m_hWnd, m_PathREQUESTth, m_PathINBOXth, m_PathOUTBOXth ,mCDBSTR,mQuerySTR, mLang,TRUE);
	
	CString Req_filepath;
	ThalesReq(this->m_hWnd, m_PathREQUESTth, m_PathINBOXth, m_PathOUTBOXth ,mCDBSTR,mQuerySTR, mLang,TRUE,&Req_filepath);

//	OnBUTTONCreateCHK_thalesReq( Req_filepath );

	double kfactor = 4.0/3.0, Ptime = 50.0, Plocation = 50.0, RxH = 3.0;
	int ENV = 3, syst = 2, P1546Clangle = 0, P1546landsea = 0;
	BOOL flagModel = Thales_MissionType(Req_filepath);
	if(flagModel)
	{
		CP1546DLG p1546dlg;
		if (p1546dlg.DoModal()==IDOK)
		{
			Ptime = p1546dlg.m_time;
			Plocation = p1546dlg.m_location;
			kfactor = p1546dlg.m_k;
			RxH = p1546dlg.m_RxH;
			syst = p1546dlg.m_syst;
			ENV = p1546dlg.m_env;
			P1546Clangle = p1546dlg.m_Clangle;
			P1546landsea = p1546dlg.m_landsea;
		}
		else	return;
	}
	OnBUTTONCreateCHK_thalesReq(Req_filepath,
									  Ptime, Plocation, kfactor, RxH, 
									  syst, ENV, P1546Clangle, P1546landsea );
}

////////////////////Thales/////Draw Output///////////////////
void CSMS4DCView::OnMonitoringThalesDrawoutput() 
{
	((CSMS4DCApp *)AfxGetApp())->OpenNewDocument("Monitoring THALES");
}

////////////////////Thales/////ATR ///////////////////
extern "C" int WINAPI ThalesAtr(HWND hWndParent,CString PathIN ,CString Lang,CString *PathOUT,int *mShow);	//ThalesAtrDLL.dll
void CSMS4DCView::OnMonitoringThalesAtr() 
{
	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
	CString OutputPathFile;
	int mShow;
	ThalesAtr(this->m_hWnd, m_AppPath , mLang , &OutputPathFile , &mShow);

	int L = OutputPathFile.GetLength();
	if((L>0)&&(mShow))
	{
		CString str = OutputPathFile.Right(3);	str.MakeUpper();
		if(str ==_T("KML"))			ShellExecute(m_hWnd, _T("open"), OutputPathFile, NULL, NULL, SW_SHOWNORMAL);
		else if(str ==_T("TXT"))	OnDrawVector(OutputPathFile,0);
	}
}

////////////////////Thales/////Check-list generation Requests (Automatic)///////////////////
void CSMS4DCView::OnMonitoringThalesChecklistgenerationRequestsautomatic() 
{
	m_ThalesOrder = !m_ThalesOrder;
	if(m_ThalesOrder)	// Start up the timer...
	{
		FindThalesIniFile(&m_PathINBOXth, &m_PathOUTBOXth, &m_PathREQUESTth);

		ASSERT(GetSafeHwnd());     
		m_nTimerID3 = SetTimer(ID_ThalesTIMER,10000,NULL);
		m_thisList3.SetAt(m_nTimerID3, (LPVOID) this);
	}
	else				// Stop the timer
	{
		::KillTimer( this->m_hWnd, m_nTimerID3);
		m_thisList3.RemoveKey(m_nTimerID3);   
		m_nTimerID3 = 0;
	}	
}
void CSMS4DCView::OnUpdateMonitoringThalesChecklistgenerationRequestsautomatic(CCmdUI* pCmdUI) 
{
	pCmdUI->SetCheck(m_ThalesOrder);
}

void CSMS4DCView::FindThalesIniFile(CString *PathINBOX, CString *PathOUTBOX, CString *PathREQUEST)
{
	CString PathREQUEST0, PathOUTBOX0,PathINBOX0 , ThalesIniFile = m_AppPath + _T("\\Texts\\Thales.txt");

	CFileFind x1;
	BOOL cx1 = x1.FindFile(ThalesIniFile);
	if(!cx1)
	{
		PathINBOX0   = _T("C:\\THALES\\INBOX");
		PathOUTBOX0  = _T("C:\\THALES\\OUTBOX");
		PathREQUEST0  = _T("C:\\THALES\\REQUEST");

		FILE *fid;
		fid = fopen(ThalesIniFile, _T("wt"));
		fprintf( fid, _T("%s\n"), PathINBOX0);
		fprintf( fid, _T("%s\n"), PathOUTBOX0);
		fprintf( fid, _T("%s\n"), PathREQUEST0);
		fclose(fid);
		
	}//if !cx1
	else
	{
		char buftemp[400];
		FILE *fid = fopen(ThalesIniFile, _T("rt"));

		fgets(buftemp,400,fid);
		PathINBOX0 = buftemp;
		PathINBOX0.TrimLeft();		PathINBOX0.TrimRight();

		fgets(buftemp,400,fid);
		PathOUTBOX0 = buftemp;
		PathOUTBOX0.TrimLeft();		PathOUTBOX0.TrimRight();

		fgets(buftemp,400,fid);
		PathREQUEST0 = buftemp;
		PathREQUEST0.TrimLeft();		PathREQUEST0.TrimRight();

		fclose(fid);
	}
	x1.Close();
	*PathINBOX  = PathINBOX0;
	*PathOUTBOX = PathOUTBOX0;
	*PathREQUEST = PathREQUEST0;
}

//extern "C" int WINAPI ThalesReqAuto(CString PathINBOX ,CString PathFileReq ,CString DBSTR,CString QuerySTR,CString Lang);	//ThalesReqAutoDLL.lib
void CSMS4DCView::On_ThalesAuto() 
{
	bool Is_In = false;
//	CString mLang = ((CSMS4DCApp *)AfxGetApp())->m_Lang;
//	CString DBSTR = ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR;
//	CString mQuerySTR = ((CSMS4DCApp *)AfxGetApp())->Query_STtable();

	double kfactor = 4.0/3.0, Ptime = 50.0, Plocation = 50.0, RxH = 3.0;
	int ENV = 3, syst = 2, P1546Clangle = 0, P1546landsea = 0;
	BOOL flagModel = ThalesAutoMissions(); 
	if(flagModel)
	{
		CP1546DLG p1546dlg;
		if (p1546dlg.DoModal()==IDOK)
		{
			Ptime = p1546dlg.m_time;
			Plocation = p1546dlg.m_location;
			kfactor = p1546dlg.m_k;
			RxH = p1546dlg.m_RxH;
			syst = p1546dlg.m_syst;
			ENV = p1546dlg.m_env;
			P1546Clangle = p1546dlg.m_Clangle;
			P1546landsea = p1546dlg.m_landsea;
		}
		else	return;
	}

	CString PathFileReq;
    struct _finddata_t req_file;
    long hFile;

	if(!Is_In)		
	if( (hFile = _findfirst( m_PathREQUESTth + _T("\\*.req") , &req_file )) != -1L )	/* Find first .req file in current directory */
	{
		Is_In = true;
		PathFileReq = m_PathREQUESTth + _T("\\") + req_file.name;

//		ThalesReqAuto(m_PathINBOXth, PathFileReq ,DBSTR,mQuerySTR,mLang);
//		CString str = m_PathOUTBOXth + _T("\\") + req_file.name;
//		MoveFile(PathFileReq,  str);

//		OnBUTTONCreateCHK_thalesReq( PathFileReq);
		OnBUTTONCreateCHK_thalesReq(PathFileReq,
									Ptime, Plocation, kfactor, RxH,syst, ENV, P1546Clangle, P1546landsea );

		while( _findnext( hFile, &req_file ) == 0 )		/* Find the rest of the .req files */
		{
			PathFileReq = m_PathREQUESTth + _T("\\")  + req_file.name;

//			ThalesReqAuto(m_PathINBOXth, PathFileReq ,DBSTR,mQuerySTR,mLang);
//			CString str = m_PathOUTBOXth + _T("\\") + req_file.name;
//			MoveFile(PathFileReq,  str);
		
//			OnBUTTONCreateCHK_thalesReq( PathFileReq);
			OnBUTTONCreateCHK_thalesReq(PathFileReq,
									Ptime, Plocation, kfactor, RxH,syst, ENV, P1546Clangle, P1546landsea );
		}
	   _findclose( hFile );
		Is_In=false;
	}
}

BOOL CSMS4DCView::Thales_MissionType(CString PathFileReq) 
{
	if(PathFileReq.GetLength()>0)
	{
		FILE *fp = fopen(PathFileReq,"rt");
		if(fp)
		{
			CString sdum1;
			char dum1[1000];	dum1[0] = '\0';
			fscanf(fp,"%s",dum1);	sdum1 = dum1;
			fclose(fp);
			if(	(sdum1 == _T("ATR")) || (sdum1 == _T("USS")) ||
				(sdum1 == _T("SCT")) || (sdum1 == _T("TOR")) || (sdum1 == _T("UBS")) ||
				(sdum1 == _T("CAM")) || (sdum1 == _T("TVM")) )
				return TRUE;
		}//fp
	}
	return FALSE;
}
BOOL CSMS4DCView::ThalesAutoMissions() 
{
	FindThalesIniFile(&m_PathINBOXth, &m_PathOUTBOXth, &m_PathREQUESTth);
	bool Is_In = false;

	CString PathFileReq;
    struct _finddata_t req_file;
    long hFile;

	if(!Is_In)		
	if( (hFile = _findfirst( m_PathREQUESTth + _T("\\*.req") , &req_file )) != -1L )	/* Find first .req file in current directory */
	{
		Is_In = true;
		PathFileReq = m_PathREQUESTth + _T("\\") + req_file.name;
		if( Thales_MissionType( PathFileReq) )
		{
			_findclose( hFile );
			return TRUE;
		}

		while( _findnext( hFile, &req_file ) == 0 )		/* Find the rest of the .req files */
		{
			PathFileReq = m_PathREQUESTth + _T("\\")  + req_file.name;
			if( Thales_MissionType( PathFileReq) )
			{
				_findclose( hFile );
				return TRUE;
			}
		}
	   _findclose( hFile );
		Is_In = false;
	}
	return FALSE;
}

extern "C" int WINAPI ConvertAnt(HWND hWndParent,CString Path_antfile ,CString Lang);	//ConvertAntDLL.lib
void CSMS4DCView::OnToolsConvertantennafile() 
{
	HINSTANCE hClientRes = AfxGetResourceHandle();					//Store the current resource handle
	AfxSetResourceHandle(::GetModuleHandle("ConvertAntDLL.dll"));	//Tell the client to use the .DLL's resources

	ConvertAnt(this->m_hWnd, m_AppPath + _T("Antenna") , ((CSMS4DCApp *)AfxGetApp())->m_Lang);	
	
	AfxSetResourceHandle(hClientRes);								//Restore the client application resource handle
}

extern "C" int WINAPI HCMagreementDLG(HWND hWndParent,CString DBSTR,CString PathFile,CString mLang);   //HCM_SMS4DCDLL.lib
void CSMS4DCView::OnCoordinationHcm() 
{
	HINSTANCE hClientRes = AfxGetResourceHandle();			//Store the current resource handle
	AfxSetResourceHandle(::GetModuleHandle("HCM_SMS4DCDLL.dll"));	//Tell the client to use the .DLL's resources

	HCMagreementDLG(this->m_hWnd, ((CSMS4DCApp *)AfxGetApp())->m_CDBSTR, m_AppPath, ((CSMS4DCApp *)AfxGetApp())->m_Lang);	

	AfxSetResourceHandle(hClientRes);					//Restore the client application resource handle
}

